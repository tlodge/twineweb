(this.webpackJsonpTwine=this.webpackJsonpTwine||[]).push([[0],[,,,,,function(e,t,n){"use strict";var r=n(218);n.d(t,"addPassageTag",(function(){return r.a})),n.d(t,"createUntitledPassage",(function(){return r.b})),n.d(t,"createUntitledStory",(function(){return r.c})),n.d(t,"deletePassages",(function(){return r.d})),n.d(t,"deleteStory",(function(){return r.e})),n.d(t,"deselectAllStories",(function(){return r.f})),n.d(t,"deselectPassage",(function(){return r.g})),n.d(t,"deselectStory",(function(){return r.h})),n.d(t,"duplicateStory",(function(){return r.i})),n.d(t,"highlightPassagesMatchingSearch",(function(){return r.j})),n.d(t,"importStories",(function(){return r.k})),n.d(t,"movePassages",(function(){return r.l})),n.d(t,"removePassageTag",(function(){return r.m})),n.d(t,"renamePassageTag",(function(){return r.n})),n.d(t,"renameStoryTag",(function(){return r.o})),n.d(t,"replaceInStory",(function(){return r.p})),n.d(t,"selectAllPassages",(function(){return r.q})),n.d(t,"selectPassage",(function(){return r.r})),n.d(t,"selectPassagesInRect",(function(){return r.s})),n.d(t,"selectStory",(function(){return r.t})),n.d(t,"setTagColor",(function(){return r.u})),n.d(t,"updatePassage",(function(){return r.v})),n.d(t,"updateStory",(function(){return r.w}));var a=n(29);n.d(t,"passageDefaults",(function(){return a.a})),n.d(t,"storyDefaults",(function(){return a.b}));var o=n(116);n.d(t,"passageConnections",(function(){return o.a})),n.d(t,"passageWithId",(function(){return o.b})),n.d(t,"passageWithName",(function(){return o.c})),n.d(t,"passagesMatchingSearch",(function(){return o.d})),n.d(t,"storyPassageTags",(function(){return o.e})),n.d(t,"storyStats",(function(){return o.f})),n.d(t,"storyTags",(function(){return o.g})),n.d(t,"storyWithId",(function(){return o.h})),n.d(t,"storyWithName",(function(){return o.i}));var c=n(219);n.d(t,"StoriesContextProvider",(function(){return c.a})),n.d(t,"useStoriesContext",(function(){return c.b}));var s=n(194);n.o(s,"maxZoom")&&n.d(t,"maxZoom",(function(){return s.maxZoom})),n.o(s,"minZoom")&&n.d(t,"minZoom",(function(){return s.minZoom}));var i=n(195);n.d(t,"maxZoom",(function(){return i.a})),n.d(t,"minZoom",(function(){return i.b}))},,function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(0),a=n(21),o=n.n(a),c=(n(198),n(1)),s=r.forwardRef((function(e,t){var n=e.disabled,r=e.icon,a=e.iconOnly,s=e.iconPosition,i=void 0===s?"start":s,u=e.onClick,l=e.preventDefault,d=e.variant,f=void 0===d?"secondary":d,j=e.style,b=void 0===j?{}:j,p=o()("icon-button","icon-position-".concat(i),"variant-".concat(f),{"icon-only":a});return Object(c.jsxs)("button",{"aria-label":a?e.label:void 0,disabled:n,className:p,onClick:function(e){u&&u(e),l&&e.preventDefault()},ref:t,style:b,children:[Object(c.jsx)("span",{className:"icon",children:r}),!a&&e.label]})}))},,function(e,t,n){"use strict";var r=n(170);n.d(t,"setPref",(function(){return r.a}));n(54);var a=n(171);n.d(t,"formatEditorExtensionsDisabled",(function(){return a.a}));var o=n(225);n.d(t,"PrefsContextProvider",(function(){return o.a})),n.d(t,"usePrefsContext",(function(){return o.b}));n(196)},,function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return s}));n(0);var r=n(21),a=n.n(r),o=(n(366),n(1)),c=function(e){var t;return Object(o.jsx)("div",{className:a()("button-bar","orientation-".concat(null!==(t=e.orientation)&&void 0!==t?t:"horizontal")),children:e.children})},s=(n(367),function(){return Object(o.jsx)("div",{className:"button-bar-separator"})})},function(e,t,n){"use strict";var r=n(191);n.d(t,"createFromProperties",(function(){return r.a})),n.d(t,"deleteFormat",(function(){return r.b})),n.d(t,"deselectAllFormats",(function(){return r.c})),n.d(t,"deselectFormat",(function(){return r.d})),n.d(t,"loadAllFormatProperties",(function(){return r.e})),n.d(t,"loadFormatProperties",(function(){return r.f})),n.d(t,"selectFormat",(function(){return r.g}));n(70);var a=n(192);n.d(t,"filteredFormats",(function(){return a.a})),n.d(t,"formatImageUrl",(function(){return a.b})),n.d(t,"formatWithId",(function(){return a.c})),n.d(t,"formatWithNameAndVersion",(function(){return a.d})),n.d(t,"sortFormats",(function(){return a.e}));var o=n(226);n.d(t,"StoryFormatsContextProvider",(function(){return o.a})),n.d(t,"useStoryFormatsContext",(function(){return o.b}));n(193)},,function(e,t,n){"use strict";n.d(t,"a",(function(){return r.a})),n.d(t,"b",(function(){return c}));var r=n(117),a=n(2),o=(n(0),n(363),n(1)),c=function(e){var t=e.style,n=void 0===t?{}:t,r=e.children;return Object(o.jsx)("div",{className:"card-content",style:Object(a.a)({},n),children:r})};n(364)},,function(e,t,n){"use strict";var r=n(227);n.d(t,"AboutTwineDialog",(function(){return r.a}));var a=n(199);n.d(t,"AppDonationDialog",(function(){return a.a}));var o=n(224);n.d(t,"AppPrefsDialog",(function(){return o.a}));var c=n(121);n.d(t,"DialogsContextProvider",(function(){return c.a})),n.d(t,"useDialogsContext",(function(){return c.b}));n(118);var s=n(204);n.o(s,"PassageEditDialog")&&n.d(t,"PassageEditDialog",(function(){return s.PassageEditDialog})),n.o(s,"PassageTagsDialog")&&n.d(t,"PassageTagsDialog",(function(){return s.PassageTagsDialog})),n.o(s,"StoryDetailsDialog")&&n.d(t,"StoryDetailsDialog",(function(){return s.StoryDetailsDialog})),n.o(s,"StoryImportDialog")&&n.d(t,"StoryImportDialog",(function(){return s.StoryImportDialog})),n.o(s,"StoryJavaScriptDialog")&&n.d(t,"StoryJavaScriptDialog",(function(){return s.StoryJavaScriptDialog})),n.o(s,"StorySearchDialog")&&n.d(t,"StorySearchDialog",(function(){return s.StorySearchDialog})),n.o(s,"StoryStylesheetDialog")&&n.d(t,"StoryStylesheetDialog",(function(){return s.StoryStylesheetDialog})),n.o(s,"StoryTagsDialog")&&n.d(t,"StoryTagsDialog",(function(){return s.StoryTagsDialog}));var i=n(220);n.d(t,"PassageEditDialog",(function(){return i.a}));var u=n(207);n.d(t,"PassageTagsDialog",(function(){return u.a}));var l=n(221);n.d(t,"StoryImportDialog",(function(){return l.a}));var d=n(208);n.d(t,"StoryJavaScriptDialog",(function(){return d.a}));var f=n(223);n.d(t,"StoryDetailsDialog",(function(){return f.a}));var j=n(209);n.d(t,"StorySearchDialog",(function(){return j.a}));var b=n(210);n.d(t,"StoryStylesheetDialog",(function(){return b.a}));var p=n(211);n.d(t,"StoryTagsDialog",(function(){return p.a}))},,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r;n(6),n(0),n(43),n(22),n(156),n(1);!function(e){e.POST="POST",e.GET="GET",e.NONE=""}(r||(r={}))},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var r=n(21),a=n.n(r),o=(n(0),n(371),n(1)),c=function(e){var t,n=a()("text-input","orientation-".concat(e.orientation),"type-".concat(e.type));return Object(o.jsxs)(o.Fragment,{children:[Object(o.jsx)("span",{className:n,children:Object(o.jsxs)("label",{children:[e.children&&Object(o.jsx)("span",{className:"text-input-label",children:e.children}),Object(o.jsx)("input",{onChange:e.onChange,onInput:e.onInput,placeholder:e.placeholder,type:null!==(t=e.type)&&void 0!==t?t:"text",value:e.value,style:e.style||{}})]})}),e.helptext&&Object(o.jsx)("div",{style:{fontSize:"0.8em",margin:"5px 0px 0px 100px"},children:e.helptext||""})]})}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return d}));n(0);var r=n(21),a=n.n(r),o=n(43),c=n(3),s=n(14),i=n(7),u=(n(368),n(1)),l=function(e){var t=e.children,n=e.className,r=e.collapsed,l=e.fixedSize,d=e.headerLabel,f=e.onChangeCollapsed,j=e.onClose,b=Object(o.a)().t,p=a()("dialog-card",n,{collapsed:r,"fixed-size":l});return Object(u.jsx)("div",{"aria-label":d,role:"dialog",className:p,children:Object(u.jsxs)(s.a,{floating:!0,children:[Object(u.jsxs)("h2",{children:[Object(u.jsx)("div",{className:"dialog-card-header",children:Object(u.jsx)(i.a,{icon:r?Object(u.jsx)(c.p,{}):Object(u.jsx)(c.o,{}),label:d,onClick:function(){return f(!r)}})}),Object(u.jsx)("div",{className:"dialog-card-header-controls",children:Object(u.jsx)(i.a,{icon:Object(u.jsx)(c.Y,{}),iconOnly:!0,label:b("common.close"),onClick:j})})]}),!r&&t]})})},d=(n(369),function(e){return Object(u.jsx)("div",{className:"dialog-editor",children:e.children})})},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));n(0);var r=n(21),a=n.n(r),o=(n(372),n(1)),c=function(e){var t=e.children,n=e.onChange,r=e.options,c=e.orientation,s=e.value,i=a()("text-select","orientation-".concat(null!==c&&void 0!==c?c:"horizontal"));return Object(o.jsx)("span",{className:i,children:Object(o.jsxs)("label",{children:[Object(o.jsx)("span",{className:"text-select-label",children:t}),Object(o.jsx)("span",{className:"text-select-control",children:Object(o.jsx)("select",{onChange:n,value:s,children:r.map((function(e){return Object(o.jsx)("option",{disabled:e.disabled,value:e.value,children:e.label},e.value)}))})})]})})}},function(e,t,n){"use strict";var r=n(222);n.d(t,"UndoableStoriesContextProvider",(function(){return r.a})),n.d(t,"useUndoableStoriesContext",(function(){return r.b}));n(206)},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return c}));var r=n(91),a=n(55),o=function(){return{height:100,highlighted:!1,left:0,name:a.a.t("store.passageDefaults.name"),selected:!1,tags:[],text:a.a.t("touchOnly"===r.a?"store.passageDefaults.textClick":"store.passageDefaults.textTouch"),top:0,width:100}},c=function(){return{ifid:"",lastUpdate:new Date,passages:[],name:a.a.t("store.storyDefaults.name"),script:"",selected:!1,snapToGrid:!0,startPassage:"",storyFormat:"",storyFormatVersion:"",stylesheet:"",tags:[],tagColors:{},zoom:1}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(2),a=n(20),o=(n(0),n(3)),c=n(7),s=n(1),i=function(e){var t=e.checkedIcon,n=e.icon,i=e.onChange,u=e.uncheckedIcon,l=e.value,d=Object(a.a)(e,["checkedIcon","icon","onChange","uncheckedIcon","value"]),f=l?null!==t&&void 0!==t?t:Object(s.jsx)(o.P,{}):null!==u&&void 0!==u?u:Object(s.jsx)(o.O,{});return Object(s.jsx)("span",{"aria-disabled":d.disabled,className:"checkbox-button",role:"checkbox","aria-checked":l,children:Object(s.jsx)(c.a,Object(r.a)({icon:null!==n&&void 0!==n?n:f,onClick:function(){return i(!l)}},d))})}},,function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return c})),n.d(t,"d",(function(){return s})),n.d(t,"e",(function(){return i})),n.d(t,"g",(function(){return u})),n.d(t,"f",(function(){return l})),n.d(t,"a",(function(){return d}));var r=n(2),a=n(94);function o(e,t){return 180*Math.atan2(t.top-e.top,t.left-e.left)/Math.PI}function c(e,t){return Math.hypot(e.left-t.left,e.top-t.top)}function s(e){return{left:e.left+e.width/2,top:e.top+e.height/2}}function i(e,t){var n={height:0,left:0,top:0,width:0};return e.left<t.left?(n.left=e.left,n.width=t.left-e.left):(n.left=t.left,n.width=e.left-t.left),e.top<t.top?(n.top=e.top,n.height=t.top-e.top):(n.top=t.top,n.height=e.top-t.top),n}function u(e,t){return!(t.left>e.left+e.width||t.left+t.width<e.left||t.top>e.top+e.height||t.top+t.height<e.top)}function l(e,t,n){var r=[NaN,NaN];return Object(a.a)(r,[e.left,e.top],[e.left,e.top+e.height],[t.left,t.top],[n.left,n.top])||Object(a.a)(r,[e.left+e.width,e.top],[e.left+e.width,e.top+e.height],[t.left,t.top],[n.left,n.top])||Object(a.a)(r,[e.left,e.top],[e.left+e.width,e.top],[t.left,t.top],[n.left,n.top])||Object(a.a)(r,[e.left,e.top+e.height],[e.left+e.width,e.top+e.height],[t.left,t.top],[n.left,n.top])?{left:r[0],top:r[1]}:null}function d(e){if(0===e.length)throw new Error("Can't calculate bounding rect for 0 rects");for(var t=Object(r.a)({},e[0]),n=1;n<e.length;n++){var a=e[n].left+e[n].width,o=e[n].top+e[n].height;e[n].left<t.left&&(t.left=e[n].left),e[n].top<t.top&&(t.top=e[n].top),t.left+t.width<a&&(t.width=a-t.left),t.top+t.height<o&&(t.height=o-t.top)}return t}},function(e,t,n){"use strict";var r=n(186);n.o(r,"storyFileName")&&n.d(t,"storyFileName",(function(){return r.storyFileName}));var a=n(187);n.d(t,"storyFileName",(function(){return a.a}))},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return i}));var r=["highlighted","selected"],a=["lastUpdate","selected"],o=["loadError","loadState","properties","selected"];function c(e){return Object.keys(e).some((function(e){return!r.includes(e)}))}function s(e){return Object.keys(e).some((function(e){return!a.includes(e)}))}function i(e){return Object.keys(e).some((function(e){return!o.includes(e)}))}},function(e,t,n){"use strict";n.d(t,"d",(function(){return w})),n.d(t,"c",(function(){return S})),n.d(t,"b",(function(){return C})),n.d(t,"a",(function(){return F}));var r=n(13),a=n(2),o=n(6),c=n(4),s=n(18),i=function(e){for(var t=e.split("\n"),n=0;n<t.length;n++)if(-1!=t[n].indexOf("[type")){var r=t[n].split(":");return r.length>1?r[1].replace("]","").trim():"button"}return"button"},u=function(e){return-1!==e.indexOf("[onstart]")?e.substring(e.indexOf("[onstart]")).split("[rules]")[0].replace("[onstart]","").trim():""},l=function(e){return-1!==e.indexOf("[rules]")?e.substring(e.indexOf("[rules]")).replace("[rules]","").trim():""},d=function(e){var t=e.replace(/"[^"]+"/g,(function(e){return e.replace(/,/g,"#")})).replace("[speech]","").replace(/[()]/g,"").replace(/["]/g,"").trim().split(",").map((function(e){return e.replaceAll("#",",")}));return{words:t.length>0?t[0].trim():"",voice:t.length>1?t[1].trim():"".concat("Daniel"),rate:t.length>2?t[2].trim():"".concat(180),delay:t.length>3?t[3].trim():"".concat(0)}},f=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"()",t=e.replace(/[(]/g,"{").replace(/[)]/g,"}");try{return JSON.parse(t)}catch(n){console.log("error parsing",n)}return{}},j=function(e){if(e.startsWith("http"))try{return new URL(e)}catch(t){}return e},b=function(e){var t=function(e){var t=e.trim().substring(1,e.trim().length-1),n=t.indexOf("{"),r=t.lastIndexOf("}");return n>-1&&r>-1?t.substring(n,r+1):""}(e),n=e.replace(t,"").replace(/[()]/g,"").replace(/["]/g,"").trim().split(",");if(n.length>0){var r={},a=(t||"{}").replace(/[(]/g,"{").replace(/[)]/g,"}");try{r=JSON.parse(a)}catch(o){r={parseErr:a}}return{action:j(n[0]),delay:n.length>1?Number(n[1].trim()):0,params:n.length>2?JSON.stringify(r):"{}",method:n.length>3?"POST"===n[2]?s.a.POST:s.a.GET:s.a.NONE}}return{action:""}},p=function(e){for(var t,n=e.split("\n"),r=0,a=[];r<n.length;){if(n[r].trim().startsWith("[speech]"))for(;++r<n.length&&""!==(t=n[r]).trim()&&-1===t.indexOf("[");)a=[].concat(Object(c.a)(a),[d(n[r])]);r+=1}return a},m=function(e){for(var t,n=e.split("\n"),r=0,a=[];r<n.length;)if(n[r].trim().startsWith("[action]")){for(var o=[];++r<n.length&&""!==(t=n[r]).trim()&&!t.trim().startsWith("[");)o=[].concat(Object(c.a)(o),[b(n[r])]);a=[].concat(Object(c.a)(a),[o])}else r+=1;return a},h=function(e,t){var n=e.split("[actions]"),r=Object(o.a)(n,2),a=r[0],c=r[1],s=a.replace("[[","").replace("]]","").split("|"),i=s[0].trim().split(" "),u=Object(o.a)(i,1)[0],l=void 0===u?"":u,d=s.length>1?s[1]:l;return{rule:{operator:"speech"===t?"contains":"equals",operand:"speech"===t?l.replace(/\s+/g,"").split(",").filter((function(e){return""!==e.trim()})):l.replace(/\s+/g,"")},next:d.trim(),actions:m((c||"").trim())}},O=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"button",n=e.trim().replace("[rules]","").split("\n"),r=0,a=[],s=function(e){return-1!==e.indexOf("[rule")};r<n.length;)if(n[r].trim().startsWith("[rule")){var i="",u=n[r].replace("[","").replace("]","").split(":"),l=Object(o.a)(u,2);for(l[0],l[1];++r<n.length&&!s(n[r]);)i+="\n".concat(n[r]);a=[].concat(Object(c.a)(a),[h(i.trim(),t)])}else r+=1;return a},g=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"\t\t\t";return(e||[]).reduce((function(e,n){return"".concat(e).concat(t,'("').concat(n.action,'","').concat(n.delay||0,'","').concat(n.params,'","').concat(n.method,'")\n')}),"")},v=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"\t\t";return(e||[]).reduce((function(e,n){return"".concat(e,"\n").concat(t,"[action]\n").concat(g(n,"".concat(t,"\t")))}),"")},y=function(e){return e.reduce((function(e,t){return"say"===t.action?[].concat(Object(c.a)(e),Object(c.a)(function(){var e=f(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"()").body,t=(void 0===e?{}:e).speech;return(void 0===t?[]:t).map((function(e){return e.words}))}(t.params))):e}),[])},x=function(e){return(e||[]).reduce((function(e,t){return[].concat(Object(c.a)(e),Object(c.a)(y(t)))}),[])};function w(e){var t=e.map((function(e){return C(e)}));return t.reduce((function(e,t){return[].concat(Object(c.a)(e),Object(c.a)(function(e,t){var n=Object(c.a)((e.onstart.speech||[]).map((function(e){return e.words}))),r=Object(c.a)(x(e.onstart.actions||[])),a=(e.rules||[]).reduce((function(e,t){return[].concat(Object(c.a)(e),Object(c.a)(x(t.actions)))}),[]);return[].concat(Object(c.a)(n),Object(c.a)(r),Object(c.a)(a))}(t)))}),[])}function S(e){return"[type:".concat(e.type,"]\n\n[onstart]\n\n").concat(function(e){return"\t[speech]\n".concat(function(e){return(e.onstart.speech||[]).reduce((function(e,t){return"".concat(e,'\t("').concat(t.words,'","').concat(t.voice,'","').concat(t.rate,'","').concat(t.delay,'")\n')}),"")}(e),"\n\n\t[actions]").concat(v(e.onstart.actions||[]))}(e),"\n[rules]\n").concat(function(e){return e.rules.reduce((function(e,t){var n=t.actions&&t.actions.length>0?"\n\t\t[actions]".concat(v(t.actions,"\t\t\t")):"";return"".concat(e,"\n\t[rule]\n\t\t[[").concat(t.rule.operand,"|").concat(t.next.trim(),"]]").concat(n)}),"")}(e))}function C(e){var t=i(e),n=u(e);return{type:t,onstart:{speech:p(n),actions:m(n)},rules:O(l(e),t)}}var k=function(e,t){var n=e,r=i(t),o=u(t),c=p(o),s=m(o),d=O(l(t),r),f={type:r,name:n,id:n,subscription:"speech"===r?"/speech":"button"===r?"/press":"/webhook",onstart:{speech:c,actions:s},rules:d};return"speech"===r?f:Object(a.a)(Object(a.a)({},f),{},{data:d.map((function(e){return e.rule.operand}))})},I=function(e){return e.map((function(e){return function(e){var t={action:e.action,params:{},method:"",delay:0};return e.params&&Object.keys(e.params).length>0&&(t=Object(a.a)(Object(a.a)({},t),{},{params:JSON.parse(e.params),method:e.method})),void 0!==e.delay&&e.delay>0&&(t=Object(a.a)(Object(a.a)({},t),{},{delay:e.delay})),t}(e)}))},N=function(e){return e.map((function(e){return Object.keys(e).reduce((function(t,n){return"onstart"===n?Object(a.a)(Object(a.a)({},t),{},{onstart:(o=e.onstart,Object.keys(o).reduce((function(e,t){return"speech"===t&&o[t]&&o[t].length>0?Object(a.a)(Object(a.a)({},e),{},Object(r.a)({},t,o[t])):"actions"===t&&o[t].length>0&&o[t][0].length>0?Object(a.a)(Object(a.a)({},e),{},Object(r.a)({},t,o[t].map((function(e){return I(e)})))):e}),{}))}):"rules"===n?Object(a.a)(Object(a.a)({},t),{},{rules:(s=e.rules,s.reduce((function(e,t){return[].concat(Object(c.a)(e),[Object(a.a)(Object(a.a)({},t),{},{actions:t.actions.map((function(e){return I(e)}))})])}),[]))}):Object(a.a)(Object(a.a)({},t),{},Object(r.a)({},n,e[n]));var o,s}),{})}))};function F(e){var t=e||{},n=t.passages,r=t.startPassage,a=t.name,o="",s=(n||[]).reduce((function(e,t){return t.id===r&&(o=t.name),t.text&&""!==t.text.replace(/\s/g,"")&&(-1!==(n=t.text).indexOf("[onstart]")||-1!==n.indexOf("[actions]")||-1!==n.indexOf("[rules]"))?[].concat(Object(c.a)(e),[k(t.name,t.text)]):e;var n}),[]);return[{id:a,start:{actions:[[]],event:o},events:N(s)}]}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return r}));var r=function(){return-1!==window.navigator.userAgent.indexOf("Electron")}}).call(this,n(106))},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return o.a})),n.d(t,"c",(function(){return c}));var r=n(127);function a(e,t){var n;if("loaded"===e.loadState&&(null===(n=e.properties.editorExtensions)||void 0===n?void 0:n.twine)){var a=Object.keys(e.properties.editorExtensions.twine).filter((function(e){return Object(r.satisfies)(t,e)}));if(0!==a.length)return a.length>1&&console.warn("More than one set of editor extensions for ".concat(e.name," ").concat(e.version," is satisfied by ").concat(t,". Using the first.")),e.properties.editorExtensions.twine[a[0]];console.info("".concat(e.name," ").concat(e.version," has editor extensions, but none that ").concat(t," satisfies"))}}var o=n(69);function c(e){return e.name.toLowerCase().replace(/\s/g,"-")+"-"+e.version}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return s})),n.d(t,"d",(function(){return i}));n(0);var r=n(1),a=function(){return Object(r.jsx)("svg",{viewBox:"0 0 24 24",width:"24",height:"24",stroke:"currentColor",strokeWidth:"2",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})},o=n(3),c=(n(260),function(){return Object(r.jsx)("span",{className:"icon-loading",children:Object(r.jsx)(o.q,{})})}),s=function(){return Object(r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",viewBox:"0 0 1200 1200",width:"1200",height:"1200",children:[Object(r.jsxs)("defs",{children:[Object(r.jsxs)("linearGradient",{id:"b",children:[Object(r.jsx)("stop",{offset:"0",stopColor:"#127aee"}),Object(r.jsx)("stop",{offset:"1",stopColor:"#117aef",stopOpacity:".251"})]}),Object(r.jsxs)("linearGradient",{id:"a",children:[Object(r.jsx)("stop",{offset:"0",stopColor:"#10f05e",stopOpacity:".251"}),Object(r.jsx)("stop",{offset:"1",stopColor:"#10f05e"})]}),Object(r.jsx)("linearGradient",{xlinkHref:"#a",id:"d",x1:"52",y1:"604.362",x2:"972",y2:"604.362",gradientUnits:"userSpaceOnUse"}),Object(r.jsx)("linearGradient",{xlinkHref:"#b",id:"c",x1:"256",y1:"0",x2:"231.987",y2:"725.548",gradientUnits:"userSpaceOnUse",gradientTransform:"translate(0 28.362)"})]}),Object(r.jsx)("path",{fill:"url(#c)",d:"M64 28.362h384v1024H64z",transform:"translate(88 59.638)"}),Object(r.jsx)("path",{d:"M64 860.362c0-704 896-704 896-704v384s-512 0-512 320v192H64z",fill:"url(#d)",transform:"translate(88 59.638)"})]})},i=function(){return Object(r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"icon icon-tabler icon-tabler-zoom-out",width:"24",height:"24",viewBox:"0 0 24 24",strokeWidth:"2",stroke:"currentColor",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",children:[Object(r.jsx)("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),Object(r.jsx)("circle",{cx:"10",cy:"10",r:"7"}),Object(r.jsx)("line",{x1:"7",y1:"10",x2:"13",y2:"10"}),Object(r.jsx)("line",{x1:"21",y1:"21",x2:"15",y2:"15"})]})}},,function(e,t,n){"use strict";function r(){return{name:"Twine",version:"2.4.0-beta2"}}n.d(t,"a",(function(){return r}))},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var r=n(2),a=n(6),o=n(20),c=n(0),s=n(250),i=n(169),u=n(14),l=n(7),d=(n(402),n(1)),f=function(e){var t=e.children,n=e.onChangeOpen,f=e.open,j=Object(o.a)(e,["children","onChangeOpen","open"]),b=c.useState(null),p=Object(a.a)(b,2),m=p[0],h=p[1],O=c.useState(null),g=Object(a.a)(O,2),v=g[0],y=g[1],x=Object(s.a)(m,v,{strategy:"fixed"}),w=x.styles,S=x.attributes;return c.useEffect((function(){var e=function(e){for(var t=e.target;t&&t!==v;)t=t.parentNode;t!==v&&n(!1)};if(f)return document.addEventListener("click",e),function(){return document.removeEventListener("click",e)}}),[v,n,f,e]),Object(d.jsxs)("span",{className:"card-button",children:[Object(d.jsx)(l.a,Object(r.a)(Object(r.a)({},j),{},{onClick:function(){return n(!f)},ref:h})),Object(d.jsx)(i.a,{classNames:"fade-out",in:f,mountOnEnter:!0,timeout:200,unmountOnExit:!0,children:Object(d.jsx)("div",Object(r.a)(Object(r.a)({className:"card-button-card",ref:y,style:w.popper},S.popper),{},{children:Object(d.jsx)(u.a,{floating:!0,children:t})}))})]})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return u})),n.d(t,"d",(function(){return l}));var r=n(27),a=n.n(r),o=n(55);function c(){var e=(new Date).toLocaleString().replace(/[/:\\]/g,".");return o.a.t("store.archiveFilename",{timestamp:e})}function s(e,t){return e.reduce((function(e,n){return e+u(n,t,{startOptional:!0})+"\n\n"}),"")}function i(e,t){return'<tw-passagedata pid="'.concat(a()(t.toString()),'" ')+'name="'.concat(a()(e.name),'" ')+'tags="'.concat(a()(e.tags.join(" ")),'" ')+'position="'.concat(e.left,",").concat(e.top,'" ')+'size="'.concat(e.width,",").concat(e.height,'">')+"".concat(a()(e.text),"</tw-passagedata>")}function u(e,t){var n,r,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},c=o.formatOptions,s=o.startId,u=o.startOptional;if(s=null!==(n=s)&&void 0!==n?n:e.startPassage,!u){if(!s)throw new Error("There is no starting point set for this story and none was set manually.");if(!e.passages.find((function(e){return e.id===s})))throw new Error("The passage set as starting point for this story does not exist.")}var l="";e.passages.forEach((function(e,t){l+=i(e,t+1),e.id===s&&(r=t+1)}));var d=Object.keys(e.tagColors).reduce((function(t,n){return t+'<tw-tag name="'.concat(a()(n),'" color="').concat(a()(e.tagColors[n]),'"></tw-tag>')}),"");return'<tw-storydata name="'.concat(a()(e.name),'" ')+'startnode="'.concat(r||"",'" ')+'creator="'.concat(a()(t.name),'" ')+'creator-version="'.concat(a()(t.version),'" ')+'format="'.concat(a()(e.storyFormat),'" ')+'format-version="'.concat(a()(e.storyFormatVersion),'" ')+'ifid="'.concat(a()(e.ifid),'" ')+'options="'.concat(a()(c),'"')+'tags="'.concat(a()(e.tags.join(" ")),'" ')+'zoom="'.concat(a()(e.zoom.toString()),'" hidden>')+'<style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">'+e.stylesheet+'</style><script role="script" id="twine-user-script" type="text/twine-javascript">'+e.script+"<\/script>"+d+l+"</tw-storydata>"}function l(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=r.formatOptions,c=r.startId;if(!t)throw new Error("Story format source cannot be empty.");var s=t;return s=(s=s.replace(/{{STORY_NAME}}/g,(function(){return a()(e.name)}))).replace(/{{STORY_DATA}}/g,(function(){return u(e,n,{formatOptions:o,startId:c})}))}},,,function(e,t,n){"use strict";function r(e){return e.length>0&&!/\s/.test(e)}n.d(t,"a",(function(){return r}))},,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=function(){return{appTheme:"light",codeEditorFontFamily:"var(--font-monospaced)",codeEditorFontScale:1,disabledStoryFormatEditorExtensions:[],donateShown:!1,editorCursorBlinks:!0,firstRunTime:(new Date).getTime(),lastUpdateSeen:"",lastUpdateCheckTime:(new Date).getTime(),locale:window.navigator.userLanguage||window.navigator.language||window.navigator.browserLanguage||window.navigator.systemLanguage||"en-us",passageEditorFontFamily:"var(--font-system)",passageEditorFontScale:1,proofingFormat:{name:"Paperthin",version:"1.0.0"},storyFormat:{name:"Harlowe",version:"3.2.3"},storyFormatListFilter:"current",storyListSort:"name",storyListTagFilter:[],storyTagColors:{},welcomeSeen:!1}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var r=n(247),a=n(231),o=n(83),c=r.a.createInstance();c.use(a.a).use(o.e).init({debug:!1,backend:{loadPath:"".concat(".","/locales/{{lng}}.json")},fallbackLng:"en-us",interpolation:{escapeValue:!1},load:"currentOnly"})},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var r=n(2),a=n(20),o=(n(0),n(241)),c=(n(427),n(428),n(429),n(430),n(431),n(21)),s=n.n(c),i=n(1),u=function(e){var t=e.fontFamily,n=e.fontScale,c=e.label,u=Object(a.a)(e,["fontFamily","fontScale","label"]),l={};return t&&(l.fontFamily=t.includes(" ")?'"'.concat(t,'"'):t),n&&(l.fontSize="".concat(100*n,"%")),Object(i.jsx)("div",{className:"code-area",style:l,children:Object(i.jsxs)("label",{children:[Object(i.jsx)("span",{className:s()("label",{"screen-reader-only":e.labelHidden}),children:c}),Object(i.jsx)(o.Controlled,Object(r.a)({},u))]})})}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var r=n(2),a=n(6),o=n(20),c=n(0),s=n(250),i=n(169),u=n(11),l=n(130),d=n(40),f=n(7),j=(n(405),n(30)),b=n(3),p=n(1),m=function(e){var t=e.items,n=Object(o.a)(e,["items"]),m=c.useState(null),h=Object(a.a)(m,2),O=h[0],g=h[1],v=c.useState(null),y=Object(a.a)(v,2),x=y[0],w=y[1],S=c.useState(!1),C=Object(a.a)(S,2),k=C[0],I=C[1],N=Object(s.a)(O,x,{strategy:"fixed"}),F=N.styles,E=N.attributes;return c.useEffect((function(){var e=function(){return I(!1)};return k&&document.addEventListener("click",e),function(){return document.removeEventListener("click",e)}}),[x,k,I]),Object(p.jsxs)("span",{className:"menu-button",children:[Object(p.jsx)(f.a,Object(r.a)(Object(r.a)({},n),{},{onClick:function(){return I((function(e){return!e}))},ref:g})),Object(p.jsx)(i.a,{classNames:"fade-out",in:k,mountOnEnter:!0,timeout:200,unmountOnExit:!0,children:Object(p.jsx)("div",Object(r.a)(Object(r.a)({className:"menu-button-menu",ref:w,style:F.popper},E.popper),{},{children:Object(p.jsx)(l.a,{floating:!0,children:Object(p.jsx)(u.a,{orientation:"vertical",children:t.map((function(e,t){return e.separator?Object(p.jsx)(u.b,{},t):"checkable"in e?Object(p.jsx)(j.a,{checkedIcon:Object(p.jsx)(b.n,{}),disabled:e.disabled,label:e.label,onChange:e.onClick,uncheckedIcon:Object(p.jsx)(d.a,{}),value:e.checked},t):Object(p.jsx)(f.a,{disabled:e.disabled,icon:Object(p.jsx)(d.a,{}),label:e.label,onClick:e.onClick,variant:e.variant},t)}))})})}))})]})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return O}));var r=n(2),a=n(10),o=n.n(a),c=n(17),s=n(6),i=n(20),u=n(0),l=n(43),d=n(3),f=n(11),j=n(14),b=n(45),p=n(7),m=n(22),h=n(1),O=function(e){var t=e.cancelIcon,n=e.cancelLabel,a=e.onChange,O=e.onSubmit,g=e.prompt,v=e.submitIcon,y=e.submitLabel,x=e.submitVariant,w=e.validate,S=e.value,C=Object(i.a)(e,["cancelIcon","cancelLabel","onChange","onSubmit","prompt","submitIcon","submitLabel","submitVariant","validate","value"]),k=u.useState(!1),I=Object(s.a)(k,2),N=I[0],F=I[1],E=u.useState(),P=Object(s.a)(E,2),T=P[0],D=P[1],A=Object(l.a)().t;return u.useEffect((function(){function e(){return(e=Object(c.a)(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!w){e.next=8;break}return e.t0=D,e.next=4,w(S);case 4:e.t1=e.sent,(0,e.t0)(e.t1),e.next=9;break;case 8:D({valid:!0});case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}!function(){e.apply(this,arguments)}()}),[w,S]),Object(h.jsx)("span",{className:"prompt-button",children:Object(h.jsxs)(b.a,Object(r.a)(Object(r.a)({onChangeOpen:F,open:N},C),{},{children:[Object(h.jsxs)(j.b,{children:[Object(h.jsx)(m.a,{onChange:a,orientation:"vertical",value:S,children:g}),(null===T||void 0===T?void 0:T.message)&&Object(h.jsx)("p",{children:T.message})]}),Object(h.jsxs)(f.a,{children:[Object(h.jsx)(p.a,{disabled:!(null===T||void 0===T?void 0:T.valid),icon:null!==v&&void 0!==v?v:Object(h.jsx)(d.n,{}),label:null!==y&&void 0!==y?y:A("common.ok"),onClick:function(){O(S),F(!1)},variant:null!==x&&void 0!==x?x:"primary"}),Object(h.jsx)(p.a,{icon:null!==t&&void 0!==t?t:Object(h.jsx)(d.Y,{}),label:null!==n&&void 0!==n?n:A("common.cancel"),onClick:function(){return F(!1)}})]})]}))})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return G}));var r=n(0),a=n(54);function o(){var e,t=window.twineElectron,n={},r=Object.keys(Object(a.a)());if((null===t||void 0===t||null===(e=t.hydrate)||void 0===e?void 0:e.prefs)&&"object"===typeof t.hydrate.prefs)for(var o in t.hydrate.prefs)r.includes(o)&&(n[o]=t.hydrate.prefs[o]);return n}function c(e,t){var n=window.twineElectron;if(!n)throw new Error("Electron bridge is not present on window.");n.ipcRenderer.send("save-json",e,t)}function s(e,t){"repair"!==t.type&&"update"!==t.type||c("prefs.json",e)}var i=n(4),u=n(122);function l(){var e,t=window.twineElectron;if(!t)throw new Error("Electron bridge is not present on window.");return(null===t||void 0===t||null===(e=t.hydrate)||void 0===e?void 0:e.stories)&&Array.isArray(t.hydrate.stories)?null===t||void 0===t?void 0:t.hydrate.stories.reduce((function(e,t){var n=Object(u.a)(t.htmlSource,t.mtime);return n[0]?[].concat(Object(i.a)(e),[n[0]]):(console.warn("Could not hydrate story: ",t.htmlSource),e)}),[]):(console.warn("No stories to hydrate in Electron bridge"),[])}var d,f=n(5),j=n(36),b=n(10),p=n.n(b),m=n(17),h=n(46),O=n(12),g=n(42),v=n(69);function y(e,t){return x.apply(this,arguments)}function x(){return(x=Object(m.a)(p.a.mark((function e(t,n){var r,a,o,c,s;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=window,a=r.twineElectron){e.next=3;break}throw new Error("Electron bridge is not present on window.");case 3:if(e.prev=3,"loaded"!==(o=Object(O.formatWithNameAndVersion)(n,t.storyFormat,t.storyFormatVersion)).loadState){e.next=9;break}a.ipcRenderer.send("save-story-html",t,Object(h.d)(t,o.properties.source,Object(g.a)(),{startOptional:!0})),e.next=14;break;case 9:return e.next=11,Object(v.a)(o.url);case 11:c=e.sent,s=c.source,a.ipcRenderer.send("save-story-html",t,Object(h.d)(t,s,Object(g.a)(),{startOptional:!0}));case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(3),console.warn("Could not save full story (".concat(e.t0.message,"). Trying to save story data only.")),a.ipcRenderer.send("save-story-html",t,Object(h.c)(t,Object(g.a)(),{startOptional:!0}));case 20:case"end":return e.stop()}}),e,null,[[3,16]])})))).apply(this,arguments)}function w(e,t,n){var r=window.twineElectron;if(!r)throw new Error("Electron bridge is not present on window.");switch(t.type){case"init":case"repair":break;case"createStory":if(!t.props.name)throw new Error("Passage was created but with no name specified");y(Object(f.storyWithName)(e,t.props.name),n);break;case"deleteStory":r.ipcRenderer.send("delete-story",Object(f.storyWithId)(d,t.storyId));break;case"updateStory":if(Object(j.b)(t.props))if(t.props.name){var a=Object(f.storyWithId)(d,t.storyId),o=Object(f.storyWithId)(e,t.storyId);r.ipcRenderer.once("story-renamed",(function(){return y(o,n)})),r.ipcRenderer.send("rename-story",a,o)}else y(Object(f.storyWithId)(e,t.storyId),n);break;case"createPassage":case"createPassages":case"deletePassage":case"deletePassages":y(Object(f.storyWithId)(e,t.storyId),n);break;case"updatePassage":Object(j.a)(t.props)&&y(Object(f.storyWithId)(e,t.storyId),n);break;case"updatePassages":Object.keys(t.passageUpdates).some((function(e){return Object(j.a)(t.passageUpdates[e])}))&&y(Object(f.storyWithId)(e,t.storyId),n);break;default:console.warn("Story action ".concat(t.type," has no Electron persistence handler"))}d=Object(i.a)(e)}var S=n(19),C=n.n(S);function k(){var e,t=window.twineElectron;return(null===t||void 0===t||null===(e=t.hydrate)||void 0===e?void 0:e.storyFormats)&&Array.isArray(t.hydrate.storyFormats)?t.hydrate.storyFormats.map((function(e){return{id:C()(),loadState:"unloaded",name:e.name,selected:!1,version:e.version,url:e.url,userAdded:e.userAdded}})):[]}function I(e,t){("create"===t.type||"delete"===t.type||"repair"===t.type||"update"===t.type&&Object(j.c)(t.props))&&c("story-formats.json",e.map((function(e){return{id:e.id,name:e.name,selected:void 0,version:e.version,url:e.url,userAdded:e.userAdded}})))}function N(){var e=window.localStorage.getItem("twine-prefs"),t={};return e?(e.split(",").forEach((function(e){try{var n=window.localStorage.getItem("twine-prefs-".concat(e));if(!n)return void console.warn("No preference stored at twine-prefs-".concat(e));var r=JSON.parse(n);t[r.name]=r.value}catch(a){console.warn("Preference ".concat(e," had corrupt serialized value, skipping"),window.localStorage.getItem("twine-prefs-".concat(e)),a)}})),t):{}}function F(e,t){"repair"!==t.type&&"update"!==t.type||function(e){var t=window.localStorage.getItem("twine-prefs");t&&t.split(",").forEach((function(e){window.localStorage.removeItem("twine-prefs-".concat(e))}));var n=[];for(var r in e){var a=C()();n.push(a),window.localStorage.setItem("twine-prefs-".concat(a),JSON.stringify({id:a,name:r,value:e[r]}))}window.localStorage.setItem("twine-prefs",n.join(","))}(e)}var E,P=n(2),T=n(29);function D(){var e={},t=window.localStorage.getItem("twine-stories");if(!t)return[];t.split(",").forEach((function(t){var n=window.localStorage.getItem("twine-stories-".concat(t));if(n)try{var r=JSON.parse(n);if(!r.id)return void console.warn("Story in local storage had no ID, skipping",r);e[r.id]=Object(P.a)(Object(P.a)(Object(P.a)({},Object(T.b)()),r),{},{lastUpdate:r.lastUpdate?new Date(Date.parse(r.lastUpdate)):new Date,passages:[]})}catch(a){console.warn("Could not parse story as JSON, skipping: ".concat(n))}else console.warn("Story list contained ID ".concat(t,", but twine-stories-").concat(t," does not exist, skipping"))}));var n=window.localStorage.getItem("twine-passages");return n&&n.split(",").forEach((function(t){var n=window.localStorage.getItem("twine-passages-".concat(t));if(n)try{var r=JSON.parse(n);if(!r||!r.story)return void console.warn("Passage ".concat(t," did not have parent story ID, skipping"),r);if(!e[r.story])return void console.warn("Passage ".concat(t," is orphaned (looking for story ID ").concat(r.story,"), skipping"));e[r.story].passages.push(Object(P.a)(Object(P.a)(Object(P.a)({},T.a),r),{},{tags:r.tags?r.tags.filter((function(e){return""!==e.trim()})):[]}))}catch(a){console.warn("Could not parse passage as JSON, skipping: ".concat(n))}else console.warn("Passage list contained ID ".concat(t,", but twine-passages-").concat(t," does not exist, skipping"))})),Object.values(e)}function A(e,t){return""===e?t:function(e,t){return new RegExp("\\b"+t+"\\b").test(e)}(e,t)?e:e+","+t}function L(e,t){return","===(e=e.replace(new RegExp(",?"+t),""))[0]?e.substring(1):e}function M(e){var t,n,r={passageIds:null!==(t=window.localStorage.getItem("twine-passages"))&&void 0!==t?t:"",storyIds:null!==(n=window.localStorage.getItem("twine-stories"))&&void 0!==n?n:""};e(r),window.localStorage.setItem("twine-stories",r.storyIds),window.localStorage.setItem("twine-passages",r.passageIds)}function R(e,t){if(!t.id)throw new Error("Story has no ID");e.storyIds=A(e.storyIds,t.id),window.localStorage.setItem("twine-stories-".concat(t.id),JSON.stringify(Object(P.a)(Object(P.a)({},t),{},{passages:void 0})))}function W(e,t){if(!t.id)throw new Error("Passage has no ID");e.passageIds=A(e.passageIds,t.id),window.localStorage.setItem("twine-passages-".concat(t.id),JSON.stringify(t))}function U(e,t){e.passageIds=L(e.passageIds,t),window.localStorage.removeItem("twine-passages-".concat(t))}function z(e,t){switch(t.type){case"init":case"repair":break;case"createPassage":if(!t.props.name)throw new Error("Passage was created but with no name specified");var n=Object(f.storyWithId)(e,t.storyId),r=Object(f.passageWithName)(e,n.id,t.props.name);M((function(e){R(e,n),W(e,r)}));break;case"createPassages":var a=Object(f.storyWithId)(e,t.storyId);M((function(n){R(n,a),t.props.forEach((function(t){if(!t.name)throw new Error("Passage was created but with no name specified");W(n,Object(f.passageWithName)(e,a.id,t.name))}))}));break;case"createStory":if(!t.props.name)throw new Error("Story was created but with no name specified");var o=Object(f.storyWithName)(e,t.props.name);M((function(e){R(e,o),o.passages.forEach((function(t){return W(e,t)}))}));break;case"deletePassage":var c=Object(f.storyWithId)(e,t.storyId);M((function(e){R(e,c),U(e,t.passageId)}));break;case"deletePassages":var s=Object(f.storyWithId)(e,t.storyId);M((function(e){R(e,s),t.passageIds.forEach((function(t){return U(e,t)}))}));break;case"deleteStory":var i=Object(f.storyWithId)(E,t.storyId);M((function(e){i.passages.forEach((function(t){return U(e,t.id)})),function(e,t){if(!t.id)throw new Error("Story has no ID");e.storyIds=L(e.storyIds,t.id),window.localStorage.removeItem("twine-stories-".concat(t.id))}(e,i)}));break;case"updatePassage":if(Object(j.a)(t.props)){var u=Object(f.storyWithId)(e,t.storyId),l=Object(f.passageWithId)(e,t.storyId,t.passageId);M((function(e){R(e,u),W(e,l)}));break}break;case"updatePassages":var d=Object(f.storyWithId)(e,t.storyId);M((function(n){R(n,d),Object.keys(t.passageUpdates).filter((function(e){return Object(j.a)(t.passageUpdates[e])})).forEach((function(r){return W(n,Object(f.passageWithId)(e,t.storyId,r))}))}));break;case"updateStory":var b=Object(f.storyWithId)(e,t.storyId);M((function(e){R(e,b),b.passages.forEach((function(t){return W(e,t)}))}));break;default:console.warn("Story action ".concat(t.type," has no local storage persistence handler"))}E=e}function B(){var e=[],t=window.localStorage.getItem("twine-storyformats");return t?(t.split(",").forEach((function(t){try{var n=window.localStorage.getItem("twine-storyformats-".concat(t));if(!n)return void console.warn("No story format stored at twine-storyformats-".concat(t,", skipping"));e.push(Object(P.a)(Object(P.a)({},JSON.parse(n)),{},{loadState:"unloaded"}))}catch(r){console.warn("Story format ".concat(t," had corrupt serialized value, skipping"),window.localStorage.getItem("twine-storyformats-".concat(t)))}})),e):[]}function J(e){var t=window.localStorage.getItem("twine-storyformats");t&&t.split(",").forEach((function(e){window.localStorage.removeItem("twine-storyformats-".concat(e))}));var n=[];e.forEach((function(e){var t=C()();n.push(t),window.localStorage.setItem("twine-storyformats-".concat(t),JSON.stringify(Object(P.a)(Object(P.a)({},e),{},{loadError:void 0,loadState:void 0,properties:void 0,selected:void 0})))})),window.localStorage.setItem("twine-storyformats",n.join(","))}function V(e,t){switch(t.type){case"create":case"delete":case"repair":J(e);break;case"update":Object(j.c)(t.props)&&J(e)}}var q=n(38);function G(){var e=r.useMemo((function(){return{prefs:{load:o,saveMiddleware:s},stories:{load:l,saveMiddleware:w},storyFormats:{load:k,saveMiddleware:I}}}),[]),t=r.useMemo((function(){return{prefs:{load:N,saveMiddleware:F},stories:{load:D,saveMiddleware:z},storyFormats:{load:B,saveMiddleware:V}}}),[]);return r.useMemo((function(){return Object(q.a)()?e:t}),[e,t])}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));n(0);var r=n(21),a=n.n(r),o=(n(198),n(1)),c=function(e){var t=e.href,n=e.icon,r=e.label,c=e.target,s=e.variant,i=a()("icon-link","variant-".concat(s));return Object(o.jsxs)("a",{href:t,className:i,target:null!==c&&void 0!==c?c:"_blank",children:[Object(o.jsx)("span",{className:"icon",children:n}),r]})}},,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var r=n(10),a=n.n(r),o=n(17),c=n(235),s=n.n(c),i=n(38),u=Promise.resolve();function l(e){return d.apply(this,arguments)}function d(){return(d=Object(o.a)(a.a.mark((function e(t){var n,r,o,c,l=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=l.length>1&&void 0!==l[1]?l[1]:2e3,r=window,o=r.twineElectron,c=Object(i.a)()&&(null===o||void 0===o?void 0:o.jsonp)?o.jsonp:s.a,e.abrupt("return",new Promise((function(e,r){return u=u.then((function(){return new Promise((function(a){c(t,{timeout:n,name:"storyFormat"},(function(t,n){t?r(t):e(n),a()}))}))}))})));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=function(){return[{name:"Mundane",url:"story-formats/mundane/format.js",version:"0.0.1"},{name:"Chapbook",url:"story-formats/chapbook-1.2.1/format.js",version:"1.2.1"},{name:"Harlowe",url:"story-formats/harlowe-1.2.4/format.js",version:"1.2.4"},{name:"Harlowe",url:"story-formats/harlowe-2.1.0/format.js",version:"2.1.0"},{name:"Harlowe",url:"story-formats/harlowe-3.2.3/format.js",version:"3.2.3"},{name:"Paperthin",url:"story-formats/paperthin-1.0.0/format.js",version:"1.0.0"},{name:"Snowman",url:"story-formats/snowman-1.4.0/format.js",version:"1.4.0"},{name:"Snowman",url:"story-formats/snowman-2.0.2/format.js",version:"2.0.2",userAdded:!1},{name:"SugarCube",url:"story-formats/sugarcube-1.0.35/format.js",version:"1.0.35"},{name:"SugarCube",url:"story-formats/sugarcube-2.36.1/format.js",version:"2.36.1"}]}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(43),a=n(38);function o(){var e=Object(r.a)("",{useSuspense:!1}),t=e.t,n=e.ready;return{reportError:function(e,r){console.error("Twine store error",e),n?window.alert(t(r,{error:e.message})+" "+t("store.errors.".concat(Object(a.a)()?"electron":"web","Remediation"))):window.alert("An error occurred while saving (".concat(e.message,"). Reloading or restarting the application may help."))}}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=["none","red","orange","yellow","green","blue","purple"]},function(e){e.exports=JSON.parse('{"a":"2.4.0-beta2"}')},function(e,t,n){"use strict";function r(e){var t={extraKeys:{Insert:function(){}}};return e.editorCursorBlinks||(t.cursorBlinkRate=0),t}n.d(t,"a",(function(){return r}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return y}));var r=n(4),a=n(6),o=n(0),c=n(43),s=n(75),i=n(3),u=n(11),l=n(14),d=n(45),f=n(7),j=n(22),b=n(25),p=n(49),m=(n(403),n(1)),h=function(e){var t=e.assignedTags,n=e.disabled,h=e.existingTags,O=e.icon,g=e.label,v=e.onAdd,y=o.useState(!0),x=Object(a.a)(y,2),w=x[0],S=x[1],C=o.useState("none"),k=Object(a.a)(C,2),I=k[0],N=k[1],F=o.useState(""),E=Object(a.a)(F,2),P=E[0],T=E[1],D=o.useState(!1),A=Object(a.a)(D,2),L=A[0],M=A[1],R=Object(c.a)().t,W=void 0,U=Object(p.a)(P);return U||""===P||(W=R("components.addTagButton.invalidName")),U&&w&&((U=!h.includes(P))||(W=R("components.addTagButton.alreadyAdded"))),Object(m.jsx)("span",{className:"add-tag-button",children:Object(m.jsxs)(d.a,{disabled:n,icon:null!==O&&void 0!==O?O:Object(m.jsx)(i.I,{}),label:null!==g&&void 0!==g?g:R("common.tag"),onChangeOpen:M,open:L,children:[Object(m.jsxs)(l.b,{children:[Object(m.jsx)(b.a,{onChange:function(e){var t=e.target.value;T(t),S(""===t)},options:[{label:R("components.addTagButton.newTag"),value:""}].concat(Object(r.a)(h.map((function(e){return{disabled:t.includes(e),label:e,value:e}})))),value:w?"":P,children:R("components.addTagButton.addLabel")}),w&&Object(m.jsxs)(m.Fragment,{children:[Object(m.jsx)(j.a,{onChange:function(e){return T(e.target.value.replace(/\s/g,"-"))},value:P,children:R("components.addTagButton.tagNameLabel")}),Object(m.jsx)(b.a,{onChange:function(e){return N(e.target.value)},options:s.a.map((function(e){return{label:R("colors.".concat(e)),value:e}})),value:I,children:R("components.addTagButton.tagColorLabel")})]}),w&&!!W&&Object(m.jsx)("p",{children:W})]}),Object(m.jsxs)(u.a,{children:[Object(m.jsx)(f.a,{disabled:!U,icon:Object(m.jsx)(i.I,{}),label:R("common.add"),onClick:function(){w?v(P,I):v(P),M(!1)},variant:"create"}),Object(m.jsx)(f.a,{icon:Object(m.jsx)(i.Y,{}),label:R("common.cancel"),onClick:function(){return M(!1)}})]})]})})},O=n(21),g=n.n(O),v=n(59),y=(n(406),function(e){var t=Object(c.a)().t;return Object(m.jsx)("span",{className:g()("tag-button","color-".concat(e.color)),children:Object(m.jsx)(v.a,{icon:Object(m.jsx)(i.o,{}),iconPosition:"end",items:[].concat(Object(r.a)(s.a.map((function(n){return{checkable:!0,checked:"none"===n?!e.color:n===e.color,label:t("colors.".concat(n)),onClick:function(){return e.onChangeColor(n)}}}))),[{separator:!0},{label:t("common.remove"),onClick:e.onRemove}]),label:e.name})})});n(120)},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var r=n(125),a=n.n(r),o=function(e){return!/^\w+:\/\/\/?\w/i.test(e)},c=function(e){return""!==e},s=function(e){var t=u(e,"][",0);return null!==t&&void 0!==t?t:e},i=function(e){return e.substr(2,e.length-4)},u=function(e,t,n){var r=e.split(t);if(1!==r.length)return n<0?r[r.length+n]:r[n]},l=function(e){return u(e,"->",-1)||u(e,"<-",0)||u(e,"|",-1)||e};function d(e,t){var n=a()(function(e){return e.match(/\[\[.*?\]\]/g)||[]}(e).map(i).map(s).map(l).filter(c));return t&&(n=n.filter(o)),n}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return c}));var r=n(126),a=n.n(r);function o(e,t){return new RegExp(t.useRegexes?e:a()(e),t.matchCase?"g":"gi")}function c(e){return e.replace(/\$/g,"$$$$")}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return i.a}));n(0);var r=n(43),a=n(3),o=n(7),c=n(1),s=function(e){var t=e.editor,n=Object(r.a)().t;function s(e){null===t||void 0===t||t.execCommand(e),null===t||void 0===t||t.focus()}return Object(c.jsxs)(c.Fragment,{children:[Object(c.jsx)(o.a,{disabled:!t,icon:Object(c.jsx)(a.D,{}),label:n("components.indentButtons.indent"),onClick:function(){return s("indentMore")}}),Object(c.jsx)(o.a,{disabled:!t,icon:Object(c.jsx)(a.C,{}),label:n("components.indentButtons.unindent"),onClick:function(){return s("indentLess")}})]})},i=n(119)},,,,,,,function(e,t,n){},,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return u})),n.d(t,"a",(function(){return l})),n.d(t,"d",(function(){return d})),n.d(t,"e",(function(){return f})),n.d(t,"f",(function(){return j})),n.d(t,"g",(function(){return b})),n.d(t,"h",(function(){return p})),n.d(t,"i",(function(){return m}));var r=n(4),a=(n(27),n(125)),o=n.n(a),c=n(80),s=n(79);function i(e,t,n){var r=p(e,t).passages.find((function(e){return e.id===n}));if(r)return r;throw new Error('There is no passage with ID "'.concat(n,'" in a story with ID "').concat(t,'".'))}function u(e,t,n){var r=p(e,t).passages.find((function(e){return e.name===n}));if(r)return r;throw new Error('There is no passage with name "'.concat(n,'" in a story with ID "').concat(t,'".'))}function l(e,t){var n=null!==t&&void 0!==t?t:function(e){return Object(s.a)(e,!0)},r=new Map(e.map((function(e){return[e.name,e]}))),a={draggable:{broken:new Set,connections:new Map,self:new Set},fixed:{broken:new Set,connections:new Map,self:new Set}};return e.forEach((function(e){return n(e.text).forEach((function(t){if(t===e.name)(e.selected?a.draggable:a.fixed).self.add(e);else{var n=r.get(t);if(n){var o=e.selected||n.selected?a.draggable:a.fixed;o.connections.has(e)?o.connections.get(e).add(n):o.connections.set(e,new Set([n]))}else(e.selected?a.draggable:a.fixed).broken.add(e)}}))})),a}function d(e,t,n){if(""===t)return[];var a=n.includePassageNames,o=n.matchCase,s=n.useRegexes,i=Object(c.a)(t,{matchCase:o,useRegexes:s});return e.reduce((function(e,t){return i.test(t.text)||a&&i.test(t.name)?[].concat(Object(r.a)(e),[t]):e}),[])}function f(e){return Array.from(e.passages.reduce((function(e,t){return t.tags&&t.tags.forEach((function(t){return e.add(t)})),e}),new Set)).sort()}function j(e){var t=e.passages.reduce((function(e,t){return[].concat(Object(r.a)(e),Object(r.a)(Object(s.a)(t.text).filter((function(t){return-1===e.indexOf(t)}))))}),[]);return{brokenLinks:o()(t).filter((function(t){return!e.passages.some((function(e){return e.name===t}))})),links:t,characters:e.passages.reduce((function(e,t){return e+t.text.length}),0),passages:e.passages.length,words:e.passages.reduce((function(e,t){return e+t.text.split(/\s+/).length}),0)}}function b(e){return Array.from(e.reduce((function(e,t){return t.tags&&t.tags.forEach((function(t){return e.add(t)})),e}),new Set)).sort()}function p(e,t){var n=e.find((function(e){return e.id===t}));if(n)return n;throw new Error('There is no story with ID "'.concat(t,'".'))}function m(e,t){var n=e.find((function(e){return e.name===t}));if(n)return n;throw new Error('There is no story with name "'.concat(t,'".'))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));n(0);var r=n(21),a=n.n(r),o=(n(362),n(1)),c=function(e){var t=e.children,n=e.floating,r=e.highlighted,c=e.selected,s=a()("card",{floating:n,highlighted:r,selected:c});return Object(o.jsx)("div",{className:s,children:t})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var r=n(2),a=(n(0),n(129)),o=n(169),c=n(499),s=n(121),i=(n(401),n(1)),u=function(e){return Object(i.jsx)(o.a,Object(r.a)(Object(r.a)({classNames:"pop",timeout:200},e),{},{children:e.children}))},l=function(){var e=Object(a.useScrollbarSize)(),t=e.height,n=e.width,o=Object(s.b)(),l=o.dispatch,d=o.dialogs,f={marginBottom:t,marginRight:n};return Object(i.jsx)("div",{className:"dialogs",style:f,children:Object(i.jsx)(c.a,{component:null,children:d.map((function(e,t){var n={collapsed:e.collapsed,onChangeCollapsed:function(e){return l({type:"setDialogCollapsed",collapsed:e,index:t})},onClose:function(){return l({type:"removeDialog",index:t})}};return Object(i.jsx)(u,{children:Object(i.jsx)(e.component,Object(r.a)(Object(r.a)({},e.props),n))},t)}))})})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var r=n(6),a=n(0),o=n(43),c=n(3),s=n(7),i=n(1),u=function(e){var t=e.editor,n=e.watch,u=Object(o.a)().t,l=a.useState(!1),d=Object(r.a)(l,2),f=d[0],j=d[1],b=a.useState(!1),p=Object(r.a)(b,2),m=p[0],h=p[1];function O(e){null===t||void 0===t||t.execCommand(e),null===t||void 0===t||t.focus()}return a.useEffect((function(){if(t){var e=t.historySize();j(e.redo>0),h(e.undo>0)}else j(!1),h(!1)}),[t,n]),Object(i.jsxs)(i.Fragment,{children:[Object(i.jsx)(s.a,{disabled:!m,icon:Object(i.jsx)(c.c,{}),label:u("common.undo"),onClick:function(){return O("undo")}}),Object(i.jsx)(s.a,{disabled:!f,icon:Object(i.jsx)(c.f,{}),label:u("common.redo"),onClick:function(){return O("redo")}})]})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(0),a=(n(407),n(1)),o=r.memo((function(e){return Object(a.jsx)("div",{className:"tag-stripe",children:e.tags.map((function(t){return Object(a.jsx)("span",{className:"color-".concat(e.tagColors[t]),title:t},t)}))})}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return p})),n.d(t,"a",(function(){return m}));var r=n(6),a=n(0),o=n(72),c=n.n(o),s=n(4),i=n(2),u=n(239),l=n.n(u),d=function(e,t){switch(t.type){case"addDialog":var n=!1,r=e.map((function(e){return l()(e,{collapsed:e.collapsed,component:t.component,props:t.props})?(n=!0,Object(i.a)(Object(i.a)({},e),{},{collapsed:!1})):e}));return n?r:[].concat(Object(s.a)(e),[{component:t.component,collapsed:!1,props:t.props}]);case"removeDialog":return e.filter((function(e,n){return n!==t.index}));case"setDialogCollapsed":return e.map((function(e,n){return n===t.index?Object(i.a)(Object(i.a)({},e),{},{collapsed:t.collapsed}):e}))}},f=n(118),j=n(1),b=a.createContext({dispatch:function(){},dialogs:[]});b.displayName="Dialogs";var p=function(){return a.useContext(b)},m=function(e){var t=c()(d,[]),n=Object(r.a)(t,2),a=n[0],o=n[1];return Object(j.jsxs)(b.Provider,{value:{dispatch:o,dialogs:a},children:[e.children,Object(j.jsx)(f.a,{})]})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return O}));var r=n(13),a=n(2),o=n(164),c=n.n(o),s=n(19),i=n.n(s),u=n(5),l="[role=script]",d="[role=stylesheet]",f="tw-storydata",j="tw-tag",b="tw-passagedata";function p(e){return parseFloat(e)}function m(e,t){return Array.from(e.querySelectorAll(t))}function h(e){if("string"===typeof e){var t=e.split(",");return 2===t.length?[t[0],t[1]]:void 0}}function O(e,t){var n=document.createElement("div");return n.innerHTML=e,m(n,f).map((function(e){var n=function(e){var t,n,o,c,s,u=e.getAttribute("startnode"),f=void 0,O={ifid:null!==(t=e.getAttribute("ifid"))&&void 0!==t?t:i()(),id:i()(),lastUpdate:void 0,name:null!==(n=e.getAttribute("name"))&&void 0!==n?n:void 0,storyFormat:null!==(o=e.getAttribute("format"))&&void 0!==o?o:void 0,storyFormatVersion:null!==(c=e.getAttribute("format-version"))&&void 0!==c?c:void 0,script:m(e,l).map((function(e){return e.textContent})).join("\n"),stylesheet:m(e,d).map((function(e){return e.textContent})).join("\n"),tags:e.getAttribute("tags")?e.getAttribute("tags").split(/\s+/):[],zoom:parseFloat(null!==(s=e.getAttribute("zoom"))&&void 0!==s?s:"1"),tagColors:m(e,j).reduce((function(e,t){var n=t.getAttribute("name");return"string"!==typeof n?e:Object(a.a)(Object(a.a)({},e),{},Object(r.a)({},n,t.getAttribute("color")))}),{}),passages:m(e,b).map((function(e){var t,n,r=i()(),a=h(e.getAttribute("position")),o=h(e.getAttribute("size"));return e.getAttribute("pid")===u&&(f=r),{id:r,left:a?p(a[0]):void 0,top:a?p(a[1]):void 0,width:o?p(o[0]):void 0,height:o?p(o[1]):void 0,tags:e.getAttribute("tags")?e.getAttribute("tags").split(/\s+/):[],name:null!==(t=e.getAttribute("name"))&&void 0!==t?t:void 0,text:null!==(n=e.textContent)&&void 0!==n?n:void 0}}))};return O.startPassage=f,O}(e),o=c()(n,{id:i()()},Object(u.storyDefaults)());return t&&(o.lastUpdate=t),o.passages=o.passages.map((function(e){return c()(e,Object(u.passageDefaults)(),{story:o.id})})),o}))}},,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var r=n(2),a=(n(0),n(117)),o=(n(404),n(1)),c=function(e){return Object(o.jsx)("div",{className:"button-card",children:Object(o.jsx)(a.a,Object(r.a)({},e))})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var r=n(6),a=n(0),o=n(9);function c(){var e=Object(o.usePrefsContext)().prefs,t=a.useState(window.matchMedia("(prefers-color-scheme: dark)")),n=Object(r.a)(t,1)[0],c=a.useState(n.matches?"dark":"light"),s=Object(r.a)(c,2),i=s[0],u=s[1];return a.useEffect((function(){var e=function(e){return u(e.matches?"dark":"light")};return n.addEventListener("change",e),function(){return n.removeEventListener("change",e)}}),[n]),"system"===e.appTheme?i:e.appTheme}},function(e,t,n){"use strict";n.d(t,"a",(function(){return j}));var r=n(2),a=n(6),o=n(0),c=n(43),s=n(3),i=n(60),u=n(7),l=n(1),d=function(){var e=Object(c.a)().t;return Object(l.jsx)(u.a,{disabled:!0,icon:Object(l.jsx)(s.X,{}),label:e("common.rename")})},f=function(e){var t=e.onRename,n=e.passage,r=e.story,u=o.useState(n.name),d=Object(a.a)(u,2),f=d[0],j=d[1],b=Object(c.a)().t;return Object(l.jsx)(i.a,{icon:Object(l.jsx)(s.X,{}),label:b("common.rename"),onChange:function(e){return j(e.target.value)},onSubmit:t,prompt:b("common.renamePrompt",{name:n.name}),validate:function(e){return""===e.trim()?{message:b("components.renamePassageButton.emptyName"),valid:!1}:r.passages.some((function(t){return t.id!==n.id&&t.name===e}))?{message:b("components.renamePassageButton.nameAlreadyUsed"),valid:!1}:{valid:!0}},value:f})},j=function(e){return e.passage?Object(l.jsx)(f,Object(r.a)({},e)):Object(l.jsx)(d,{})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return j}));var r=n(6),a=n(0),o=n(43),c=n(21),s=n.n(c),i=n(3),u=n(75),l=n(60),d=n(25),f=(n(434),n(1)),j=function(e){var t=e.allTags,n=e.color,c=e.name,j=e.onChangeColor,b=e.onChangeName,p=a.useState(c),m=Object(r.a)(p,2),h=m[0],O=m[1],g=Object(o.a)().t;return Object(f.jsxs)("div",{className:"tag-editor",children:[Object(f.jsx)("span",{className:s()("tag-name","color-".concat(e.color)),children:e.name}),Object(f.jsx)(l.a,{icon:Object(f.jsx)(i.X,{}),label:g("common.rename"),onChange:function(e){return O(e.target.value.replace(/\s/g,"-"))},onSubmit:function(){return b(h)},prompt:g("common.renamePrompt",{name:c}),value:h,validate:function(e){return e!==c&&t.includes(e)?{message:g("components.tagEditor.alreadyExists"),valid:!1}:{valid:!0}}}),Object(f.jsx)(d.a,{onChange:function(e){return j(e.target.value)},options:u.a.map((function(e){return{label:g("colors.".concat(e)),value:e}})),value:null!==n&&void 0!==n?n:"",children:g("common.color")})]})}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var r=n(4),a=n(6),o=n(0),c=(n(439),n(1)),s=function(e){var t=e.children,n=e.domId,r=e.percent;return Object(c.jsxs)("div",{className:"meter",id:n,role:"meter","aria-labelledby":"".concat(n,"-label"),"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":100*r,children:[Object(c.jsx)("div",{className:"meter-bar",children:Object(c.jsx)("span",{className:"filled",style:{width:100*r+"%"}})}),Object(c.jsx)("div",{className:"meter-label",id:"".concat(n,"-label"),children:t})]})},i=n(12),u=function(e){var t=e.block,n=e.children,u=o.useState([]),l=Object(a.a)(u,2),d=l[0],f=l[1],j=Object(i.useStoryFormatsContext)(),b=j.dispatch,p=j.formats;o.useEffect((function(){var e=p.filter((function(e){return!d.find((function(t){return t.name===e.name&&t.version===e.version}))}));e.length>0&&(b(Object(i.loadAllFormatProperties)(e)),f([].concat(Object(r.a)(d),Object(r.a)(e))))}),[b,p,d]);var m=p.find((function(e){return"loading"===e.loadState})),h=p.filter((function(e){return"loaded"===e.loadState})).length/p.length;return t&&h<1?Object(c.jsx)(s,{domId:"story-format-loader",percent:h,children:m&&Object(c.jsxs)(c.Fragment,{children:["Loading ",m.name," ",m.version]})}):Object(c.jsx)(c.Fragment,{children:n})}},,,,,,,,,,,,,,,,,,,,function(e,t,n){},,,,,,,,,function(e){e.exports=JSON.parse('{"code":["Chris Klimas","Leon Arnott","Ingrid Cheung","Daithi O Crualaoich","Thomas Michael Edwards","Micah Fitch","Juhana Leinonen","Michael Savich","Ross Smith"],"localizations":["David Marchand (Castellano)","Jordi Mallach (catal\xe0)","Svatopluk V\xedt (\u010ce\u0161tina)","Kristian Torgard (Dansk)","Moritz Rebbert (Deutsch)","Valentin Rocher (Fran\xe7ais)","Marco Secchi (Italiano)","Stefan Peeters (Nederlands)","Jos\xe9 Carlos Dias (Portugu\xeas)","Alliah (Portugu\xeas Brasileiro)","Anton Zhuchkov (\u0420\u0443\u0441\u0441\u043a\u0438\u0439)","Mika Letonsaari (Suomi)","D\xe9sir\xe9e Nordlund (Svenska)","H. Utku Maden (T\xfcrk\xe7e)","Shitake & SEN1 (Chinese)"]}')},,,,,function(e,t,n){"use strict";function r(e,t){return{type:"update",name:e,value:t}}n.d(t,"a",(function(){return r}))},function(e,t,n){"use strict";function r(e,t,n){return e.disabledStoryFormatEditorExtensions.some((function(e){return e.name===t&&e.version===n}))}n.d(t,"a",(function(){return r}))},,,,,,,,,,,,,,,function(e,t){},function(e,t,n){"use strict";function r(e){return e.name.replace(/[^\w. -]/g,"_")+".html"}n.d(t,"a",(function(){return r}))},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return l})),n.d(t,"c",(function(){return d})),n.d(t,"d",(function(){return f})),n.d(t,"e",(function(){return p})),n.d(t,"f",(function(){return m})),n.d(t,"g",(function(){return h}));var r=n(2),a=n(10),o=n.n(a),c=n(17),s=n(52),i=n(69);function u(e,t){if(!t.name||!t.version)throw new Error("Missing required properties for a new story format");return{type:"create",props:{url:e,name:t.name,selected:!1,userAdded:!0,version:t.version}}}function l(e){return{type:"delete",id:e.id}}function d(){return function(e,t){var n,r=Object(s.a)(t());try{for(r.s();!(n=r.n()).done;){var a=n.value;a.selected&&e({type:"update",id:a.id,props:{selected:!1}})}}catch(o){r.e(o)}finally{r.f()}}}function f(e){return{type:"update",id:e.id,props:{selected:!1}}}function j(e,t){return b.apply(this,arguments)}function b(){return(b=Object(c.a)(o.a.mark((function e(t,n){var a,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n({type:"update",id:t.id,props:{loadState:"loading"}}),e.prev=1,e.next=4,Object(i.a)(t.url);case 4:if((a=e.sent).hydrate)try{c={},new Function(a.hydrate).call(c),a=Object(r.a)(Object(r.a)({},c),a)}catch(o){console.error("Format ".concat(t.id," has a hydrate property but it threw an error when called"),o)}return n({type:"update",id:t.id,props:{properties:a,loadState:"loaded"}}),e.abrupt("return",a);case 10:e.prev=10,e.t0=e.catch(1),n({type:"update",id:t.id,props:{loadError:e.t0,loadState:"error"}});case 13:case"end":return e.stop()}}),e,null,[[1,10]])})))).apply(this,arguments)}function p(e){var t=e.filter((function(e){return"loaded"!==e.loadState&&"loading"!==e.loadState}));return t?function(){var e=Object(c.a)(o.a.mark((function e(n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.allSettled(t.map((function(e){return j(e,n)})));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}():function(){}}function m(e){return"loaded"===e.loadState?function(){return e.properties}:function(){var t=Object(c.a)(o.a.mark((function t(n){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,j(e,n);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}function h(e,t){return function(n,r){if(e.selected||n({type:"update",id:e.id,props:{selected:!0}}),t){var a,o=Object(s.a)(r());try{for(o.s();!(a=o.n()).done;){var c=a.value;c.id!==e.id&&c.selected&&n({type:"update",id:c.id,props:{selected:!1}})}}catch(i){o.e(i)}finally{o.f()}}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return l})),n.d(t,"c",(function(){return d})),n.d(t,"d",(function(){return f})),n.d(t,"e",(function(){return j}));var r=n(13),a=n(2),o=n(236),c=n.n(o),s=n(68),i=n.n(s);function u(e,t){switch(t){case"all":return e;case"current":return Object.values(e.reduce((function(e,t){return!e[t.name]||i()(e[t.name].version,t.version)?Object(a.a)(Object(a.a)({},e),{},Object(r.a)({},t.name,t)):e}),{}));case"user":return e.filter((function(e){return e.userAdded}))}}function l(e){if("loaded"!==e.loadState||!e.properties.image)throw new Error("Format has no image property");return c()(e.properties.image)?e.properties.image:e.url.replace(/\/[^/]*?$/,"/")+e.properties.image}function d(e,t){var n=e.find((function(e){return e.id===t}));if(n)return n;throw new Error('There is no story format with ID "'.concat(t,'".'))}function f(e,t,n){var r=e.find((function(e){return e.name===t&&e.version===n}));if(r)return r;throw new Error('There is no story format with name "'.concat(t,'" and version "').concat(n,'".'))}function j(e){return e.sort((function(e,t){return e.name<t.name?-1:e.name>t.name?1:e.version===t.version?0:i()(t.version,e.version)?-1:1}))}},function(e,t){},function(e,t){},function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var r=.2,a=2},function(e,t){},,function(e,t,n){},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var r=n(2),a=n(3),o=n(0),c=n(43),s=n(11),i=n(14),u=n(24),l=n(7),d=n(62),f=n(9),j=n(1),b=function(e){var t=Object(f.usePrefsContext)().dispatch,n=Object(c.a)().t;return o.useEffect((function(){return t(Object(f.setPref)("donateShown",!0))}),[t]),Object(j.jsxs)(u.a,Object(r.a)(Object(r.a)({},e),{},{className:"app-donation-dialog",fixedSize:!0,headerLabel:n("dialogs.appDonation.title"),children:[Object(j.jsx)(i.b,{children:Object(j.jsxs)("div",{className:"text",children:[Object(j.jsx)("p",{children:n("dialogs.appDonation.supportMessage")}),Object(j.jsx)("p",{children:n("dialogs.appDonation.onlyOnce")})]})}),Object(j.jsxs)(s.a,{children:[Object(j.jsx)(d.a,{href:"https://twinery.org/donate",icon:Object(j.jsx)(a.A,{}),label:n("dialogs.appDonation.donate"),variant:"primary"}),Object(j.jsx)(l.a,{icon:Object(j.jsx)(a.Y,{}),label:n("dialogs.appDonation.noThanks"),onClick:e.onClose})]})]}))}},,,,,function(e,t){},,function(e,t){},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var r=n(2),a=n(20),o=(n(0),n(43)),c=n(24),s=n(14),i=n(5),u=n(26),l=n(133),d=n(1),f=function(e){var t=e.storyId,n=Object(a.a)(e,["storyId"]),f=Object(u.useUndoableStoriesContext)(),j=f.dispatch,b=f.stories,p=Object(o.a)().t,m=Object(i.storyWithId)(b,t),h=Object(i.storyPassageTags)(m);return Object(d.jsx)(c.a,Object(r.a)(Object(r.a)({className:"passage-tags-dialog",fixedSize:!0,headerLabel:p("dialogs.passageTags.title")},n),{},{children:Object(d.jsx)(s.b,{children:h.length>0?h.map((function(e){return Object(d.jsx)(l.a,{allTags:h,color:m.tagColors[e],name:e,onChangeColor:function(t){return function(e,t){j(Object(i.setTagColor)(m,e,t),p("undoChange.changeTagColor"))}(e,t)},onChangeName:function(t){return function(e,t){j(Object(i.renamePassageTag)(m,e,t),p("undoChange.renameTag"))}(e,t)}},e)})):Object(d.jsx)("p",{children:p("dialogs.passageTags.noTags")})})}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var r=n(2),a=n(6),o=n(20),c=n(0),s=n(43),i=n(82),u=n(11),l=n(24),d=n(56),f=n(9),j=n(5),b=n(77),p=(n(438),n(1)),m=function(e){var t=e.storyId,n=Object(o.a)(e,["storyId"]),m=c.useState(),h=Object(a.a)(m,2),O=h[0],g=h[1],v=Object(j.useStoriesContext)(),y=v.dispatch,x=v.stories,w=Object(f.usePrefsContext)().prefs,S=Object(j.storyWithId)(x,t),C=Object(s.a)().t;return Object(p.jsxs)(l.a,Object(r.a)(Object(r.a)({},n),{},{className:"story-javascript-dialog",headerLabel:C("dialogs.storyJavaScript.title"),children:[Object(p.jsx)("p",{children:C("dialogs.storyJavaScript.explanation")}),Object(p.jsxs)(u.a,{children:[Object(p.jsx)(i.b,{editor:O,watch:S.script}),Object(p.jsx)(i.a,{editor:O})]}),Object(p.jsx)(l.b,{children:Object(p.jsx)(d.a,{editorDidMount:g,fontFamily:w.codeEditorFontFamily,fontScale:w.codeEditorFontScale,label:C("dialogs.storyJavaScript.editorLabel"),labelHidden:!0,onBeforeChange:function(e,t,n){g(e),y(Object(j.updateStory)(x,S,{script:n}))},options:Object(r.a)(Object(r.a)({},Object(b.a)(w)),{},{autofocus:!0,mode:"javascript"}),value:S.script})})]}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return O}));var r=n(13),a=n(2),o=n(6),c=n(20),s=n(0),i=n(43),u=n(3),l=n(24),d=n(30),f=n(56),j=n(7),b=n(5),p=n(26),m=(n(441),n(1)),h={Tab:!1,"Shift-Tab":!1},O=function(e){var t,n,O,g=e.storyId,v=Object(c.a)(e,["storyId"]),y=s.useState({includePassageNames:!0,matchCase:!1,useRegexes:!1}),x=Object(o.a)(y,2),w=x[0],S=x[1],C=s.useState(""),k=Object(o.a)(C,2),I=k[0],N=k[1],F=s.useState(""),E=Object(o.a)(F,2),P=E[0],T=E[1],D=Object(p.useUndoableStoriesContext)(),A=D.dispatch,L=D.stories,M=Object(i.a)().t,R=Object(b.storyWithId)(L,g),W=Object(b.passagesMatchingSearch)(R.passages,P,w);function U(e){S((function(t){return Object(a.a)(Object(a.a)({},t),{},Object(r.a)({},e,!t[e]))}))}return s.useEffect((function(){return A(Object(b.highlightPassagesMatchingSearch)(R,P,w)),function(){return A(Object(b.highlightPassagesMatchingSearch)(R,"",{}))}}),[A,P,w,R]),Object(m.jsxs)(l.a,Object(a.a)(Object(a.a)({},v),{},{className:"story-search-dialog",fixedSize:!0,headerLabel:M("dialogs.storySearch.title"),children:[Object(m.jsxs)("div",{className:"search-fields",children:[Object(m.jsx)(f.a,{label:M("dialogs.storySearch.find"),onBeforeChange:function(e,t,n){T(n)},options:{extraKeys:h,mode:"text"},value:P}),Object(m.jsx)(f.a,{label:M("dialogs.storySearch.replaceWith"),onBeforeChange:function(e,t,n){N(n)},options:{extraKeys:h,mode:"text"},value:I})]}),Object(m.jsxs)("div",{className:"search-flags",children:[Object(m.jsx)(d.a,{label:M("dialogs.storySearch.includePassageNames"),onChange:function(){return U("includePassageNames")},value:null!==(t=w.includePassageNames)&&void 0!==t&&t}),Object(m.jsx)(d.a,{label:M("dialogs.storySearch.matchCase"),onChange:function(){return U("matchCase")},value:null!==(n=w.matchCase)&&void 0!==n&&n}),Object(m.jsx)(d.a,{label:M("dialogs.storySearch.useRegexes"),onChange:function(){return U("useRegexes")},value:null!==(O=w.useRegexes)&&void 0!==O&&O})]}),Object(m.jsxs)("div",{className:"search-results",children:[Object(m.jsx)(j.a,{disabled:0===W.length,icon:Object(m.jsx)(u.K,{}),label:M("dialogs.storySearch.replaceAll"),onClick:function(){A(Object(b.replaceInStory)(R,P,I,w),"undoChange.replaceAllText")},variant:"danger"}),Object(m.jsx)("span",{children:P&&(W.length>0?M("dialogs.storySearch.matchCount",{count:W.length}):M("dialogs.storySearch.noMatches"))})]})]}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var r=n(2),a=n(6),o=n(20),c=n(0),s=n(43),i=n(82),u=n(11),l=n(24),d=n(56),f=n(9),j=n(5),b=n(77),p=(n(442),n(1)),m=function(e){var t=e.storyId,n=Object(o.a)(e,["storyId"]),m=c.useState(),h=Object(a.a)(m,2),O=h[0],g=h[1],v=Object(j.useStoriesContext)(),y=v.dispatch,x=v.stories,w=Object(f.usePrefsContext)().prefs,S=Object(j.storyWithId)(x,t),C=Object(s.a)().t;return Object(p.jsxs)(l.a,Object(r.a)(Object(r.a)({},n),{},{className:"story-stylesheet-dialog",headerLabel:C("dialogs.storyStylesheet.title"),children:[Object(p.jsx)("p",{children:C("dialogs.storyStylesheet.explanation")}),Object(p.jsxs)(u.a,{children:[Object(p.jsx)(i.b,{editor:O,watch:S.script}),Object(p.jsx)(i.a,{editor:O})]}),Object(p.jsx)(l.b,{children:Object(p.jsx)(d.a,{editorDidMount:g,fontFamily:w.codeEditorFontFamily,fontScale:w.codeEditorFontScale,label:C("dialogs.storyStylesheet.editorLabel"),labelHidden:!0,onBeforeChange:function(e,t,n){g(e),y(Object(j.updateStory)(x,S,{stylesheet:n}))},options:Object(r.a)(Object(r.a)({},Object(b.a)(w)),{},{autofocus:!0,mode:"css"}),value:S.stylesheet})})]}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return j}));var r=n(13),a=n(2),o=(n(0),n(43)),c=n(24),s=n(14),i=n(5),u=n(9),l=n(26),d=n(133),f=n(1),j=function(e){var t=Object(l.useUndoableStoriesContext)(),n=t.dispatch,j=t.stories,b=Object(u.usePrefsContext)(),p=b.dispatch,m=b.prefs,h=Object(o.a)().t,O=Object(i.storyTags)(j);return Object(f.jsx)(c.a,Object(a.a)(Object(a.a)({className:"story-tags-dialog",fixedSize:!0,headerLabel:h("dialogs.storyTags.title")},e),{},{children:Object(f.jsx)(s.b,{children:O.length>0?O.map((function(e){return Object(f.jsx)(d.a,{allTags:O,color:m.storyTagColors[e],name:e,onChangeColor:function(t){return function(e,t){p(Object(u.setPref)("storyTagColors",Object(a.a)(Object(a.a)({},m.storyTagColors),{},Object(r.a)({},e,t))))}(e,t)},onChangeName:function(t){return function(e,t){n(Object(i.renameStoryTag)(j,e,t))}(e,t)}},e)})):Object(f.jsx)("p",{children:h("dialogs.storyTags.noTags")})})}))}},,,,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return u})),n.d(t,"c",(function(){return f})),n.d(t,"d",(function(){return j})),n.d(t,"e",(function(){return b})),n.d(t,"i",(function(){return p})),n.d(t,"p",(function(){return v})),n.d(t,"j",(function(){return w})),n.d(t,"k",(function(){return C})),n.d(t,"l",(function(){return k})),n.d(t,"n",(function(){return N})),n.d(t,"o",(function(){return F})),n.d(t,"g",(function(){return E})),n.d(t,"q",(function(){return P})),n.d(t,"r",(function(){return T})),n.d(t,"s",(function(){return D})),n.d(t,"h",(function(){return L})),n.d(t,"f",(function(){return M})),n.d(t,"t",(function(){return R})),n.d(t,"u",(function(){return W})),n.d(t,"a",(function(){return z})),n.d(t,"m",(function(){return B})),n.d(t,"v",(function(){return g})),n.d(t,"w",(function(){return J}));var r=n(29),a=n(32),o=n(79);function c(e,t,n,c){if(!e.passages.some((function(e){return e.id===t.id})))throw new Error("This passage does not belong to this story.");return function(s){var i=Object(o.a)(c),u=Object(o.a)(n).filter((function(t){return!i.includes(t)&&!e.passages.some((function(e){return e.name===t}))}));if(0!==u.length){for(var l=Object(r.a)(),d=25,f=t.top+t.height+d,j=u.length*l.width+(u.length-1)*d,b=t.left+(t.width-j)/2,p=function(){return e.passages.some((function(e){return Object(a.g)(e,{left:b,top:f,height:l.height,width:j})}))};p()&&(b+=l.width+d,p())&&(b-=2*(l.width+d),p());)b+=l.width+d,f+=l.height+d;s({type:"createPassages",storyId:e.id,props:u.map((function(e){var t={left:b,name:e,top:f};return b+=l.width+d,t}))})}}}var s=n(2);function i(e,t){if(t.includes(e)){for(var n=1;t.includes("".concat(e," ").concat(n));)n++;return"".concat(e," ").concat(n)}return e}function u(e,t,n){if(!Number.isFinite(t)||!Number.isFinite(n))throw new Error("Center must be a finite coordinate pair");var o=Object(r.a)(),c=i(o.name,e.passages.map((function(e){return e.name}))),u=25,l={height:o.height,left:Math.max(t-o.width/2,0),top:Math.max(n-o.height/2,0),width:o.width};e.snapToGrid&&(l.left=Math.round(l.left/u)*u,l.top=Math.round(l.top/u)*u);for(var d=function(){return e.passages.some((function(e){return Object(a.g)(e,l)}))};d()&&(l.left+=l.width+u,d())&&(l.left-=l.width+u,l.top+=l.height+u,d());){if(l.left>=l.width+u){if(l.left-=l.width+u,!d())break;l.left+=l.width+u}l.top+=l.height+u}return{type:"createPassage",storyId:e.id,props:Object(s.a)(Object(s.a)({},l),{},{story:e.id,name:c})}}var l=n(19),d=n.n(l);function f(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=d()(),o=i(Object(r.b)().name,e.map((function(e){return e.name})));return function(e){return e({type:"createStory",props:Object(s.a)({id:a,name:o,storyFormat:t.storyFormat.name,storyFormatVersion:t.storyFormat.version},n)}),a}}function j(e,t){return{type:"deletePassages",storyId:e.id,passageIds:t.map((function(e){return e.id}))}}function b(e){return{type:"deleteStory",storyId:e.id}}function p(e,t){return{type:"createStory",props:Object(s.a)(Object(s.a)({},e),{},{id:d()(),ifid:d()(),name:i(e.name,t.map((function(e){return e.name})))})}}var m=n(80),h=n(126),O=n.n(h);function g(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(!e.passages.some((function(e){return e.id===t.id})))throw new Error("This passage does not belong to this story.");if("name"in n&&e.passages.filter((function(e){return e.name===n.name})).some((function(e){return e.id!==t.id})))throw new Error('There is already a passage named "'.concat(n.name,'".'));return function(a,o){var s=t.name,i=t.text;if(a({props:n,type:"updatePassage",passageId:t.id,storyId:e.id}),!r.dontCreateNewlyLinkedPassages&&n.text&&a(c(e,t,n.text,i)),n.name){var u=O()(s),l=n.name.replace(/\$/g,"$$$$"),d=new RegExp("\\[\\["+u+"(\\]\\[.*?)?\\]\\]","g"),f=new RegExp("\\[\\[(.*?)(\\||->)"+u+"(\\]\\[.*?)?\\]\\]","g"),j=new RegExp("\\[\\["+u+"(<-.*?)(\\]\\[.*?)?\\]\\]","g");e.passages.forEach((function(t){if(d.test(t.text)||f.test(t.text)||j.test(t.text)){var n=t.text;n=(n=(n=n.replace(d,"[["+l+"$1]]")).replace(f,"[[$1$2"+l+"$3]]")).replace(j,"[["+l+"$1$2]]"),g(e,t,{text:n},r)(a,o)}}))}}}function v(e,t,n,r){return function(a,o){return e.passages.forEach((function(c){!function(e,t,n,r,a){return function(o,c){if(""===n)throw new Error("Can't replace an empty string");if(t.story!==e.id)throw new Error("Passage does not belong to story");var s=a.includePassageNames,i=a.matchCase,u=a.useRegexes,l=Object(m.a)(n,{matchCase:i,useRegexes:u}),d={},f=u?r:Object(m.b)(r),j=t.text.replace(l,f);if(j!==t.text&&(d.text=j),s){var b=t.name.replace(l,f);b!==t.name&&(d.name=b)}Object.keys(d).length>0&&g(e,t,d)(o,c)}}(e,c,t,n,r)(a,o)}))}}var y=n(13),x=n(116);function w(e,t,n){return function(r){var a={};if(""===t)a=e.passages.reduce((function(e,t){return t.highlighted?Object(s.a)(Object(s.a)({},e),{},Object(y.a)({},t.id,{highlighted:!1})):e}),{});else{var o=Object(x.d)(e.passages,t,n).map((function(e){return e.id}));e.passages.forEach((function(e){var t=e.highlighted,n=o.includes(e.id);n!==t&&(a[e.id]={highlighted:n})}))}Object.keys(a).length>0&&r({passageUpdates:a,type:"updatePassages",storyId:e.id})}}var S=n(33);function C(e,t){return e.forEach((function(t){if(e.some((function(e){return e!==t&&Object(S.storyFileName)(e)===Object(S.storyFileName)(t)})))throw new Error('Stories to import cannot have the same name: "'.concat(t.name,'"'))})),function(n){e.forEach((function(e){var r=Object(s.a)({},e);delete r.id;var a=t.find((function(t){return Object(S.storyFileName)(t)===Object(S.storyFileName)(e)}));n(a?{props:r,type:"updateStory",storyId:a.id}:{props:r,type:"createStory"})}))}}function k(e,t,n,r){var a={};if(!Number.isFinite(n)||!Number.isFinite(r))throw new Error("Offset must be a finite number.");return t.forEach((function(t){var o=e.passages.find((function(e){return e.id===t}));if(!o)throw new Error('There is no passage in this story with ID "'.concat(t,'".'));var c=Math.max(o.left+n,0),s=Math.max(o.top+r,0);e.snapToGrid&&(c=25*Math.round(c/25),s=25*Math.round(s/25)),a[o.id]={left:c,top:s}})),{type:"updatePassages",passageUpdates:a,storyId:e.id}}var I=n(49);function N(e,t,n){if(!Object(I.a)(n))throw new Error('"'.concat(n,'" is not a valid tag name.'));return function(r){var a={};if(e.passages.forEach((function(e){e.tags.includes(t)&&(a[e.id]={tags:e.tags.map((function(e){return e===t?n:e}))})})),Object.keys(a).length>0){r({type:"updatePassages",passageUpdates:a,storyId:e.id});var o=Object(s.a)({},e.tagColors);delete o[t],o[n]=e.tagColors[t],r({type:"updateStory",props:{tagColors:o},storyId:e.id})}}}function F(e,t,n){if(!Object(I.a)(n))throw new Error('"'.concat(n,'" is not a valid tag name.'));return function(r){e.forEach((function(e){e.tags.includes(t)&&r({type:"updateStory",storyId:e.id,props:{tags:e.tags.map((function(e){return e===t?n:e}))}})}))}}function E(e,t){if(t.story!==e.id)throw new Error("This passage does not belong to this story");return function(n){t.selected&&n({type:"updatePassage",passageId:t.id,props:{selected:!1},storyId:e.id})}}function P(e){return function(t){var n={};e.passages.forEach((function(e){e.selected||(n[e.id]={selected:!0})})),Object.keys(n).length>0&&t({passageUpdates:n,type:"updatePassages",storyId:e.id})}}function T(e,t,n){if(t.story!==e.id)throw new Error("This passage does not belong to this story");return function(r){var a={};t.selected||(a[t.id]={selected:!0}),n&&e.passages.forEach((function(e){e.id!==t.id&&e.selected&&(a[e.id]={selected:!1})})),Object.keys(a).length>0&&r({type:"updatePassages",passageUpdates:a,storyId:e.id})}}function D(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return function(r){var o={};e.passages.forEach((function(e){if(!n.find((function(t){return t===e.id}))){var r=Object(a.g)(t,e);e.selected!==r&&(o[e.id]={selected:r})}})),Object.keys(o).length>0&&r({type:"updatePassages",passageUpdates:o,storyId:e.id})}}var A=n(52);function L(e){return function(t,n){e.selected||t({type:"updateStory",storyId:e.id,props:{selected:!1}})}}function M(){return function(e,t){var n,r=Object(A.a)(t());try{for(r.s();!(n=r.n()).done;){var a=n.value;a.selected&&e({type:"updateStory",storyId:a.id,props:{selected:!1}})}}catch(o){r.e(o)}finally{r.f()}}}function R(e,t){return function(n,r){if(e.selected||n({type:"updateStory",storyId:e.id,props:{selected:!0}}),t){var a,o=Object(A.a)(r());try{for(o.s();!(a=o.n()).done;){var c=a.value;c.id!==e.id&&c.selected&&n({type:"updateStory",storyId:c.id,props:{selected:!1}})}}catch(s){o.e(s)}finally{o.f()}}}}function W(e,t,n){if(!Object(I.a)(t))throw new Error('"'.concat(t,'" is not a valid tag name.'));return function(r){if("none"===n){if(t in e.tagColors){var a=Object(s.a)({},e.tagColors);delete a[t],r({type:"updateStory",props:{tagColors:a},storyId:e.id})}}else r({type:"updateStory",props:{tagColors:Object(s.a)(Object(s.a)({},e.tagColors),{},Object(y.a)({},t,n))},storyId:e.id})}}var U=n(4);function z(e,t,n){if(t.story!==e.id)throw new Error("This passage does not belong to this story.");if(!Object(I.a)(n))throw new Error('"'.concat(n,'" is not a valid tag name.'));if(t.tags.includes(n))throw new Error('This passage already has the tag "'.concat(n,'".'));return{type:"updatePassage",passageId:t.id,storyId:e.id,props:{tags:[].concat(Object(U.a)(t.tags),[n])}}}function B(e,t,n){if(t.story!==e.id)throw new Error("This passage does not belong to this story.");if(!Object(I.a)(n))throw new Error('"'.concat(n,'" is not a valid tag name.'));if(!t.tags.includes(n))throw new Error('This passage does not have the tag "'.concat(n,'".'));return{type:"updatePassage",passageId:t.id,storyId:e.id,props:{tags:t.tags.filter((function(e){return e!==n}))}}}function J(e,t,n){if(n.name&&e.filter((function(e){return Object(S.storyFileName)(e)===Object(S.storyFileName)(Object(s.a)(Object(s.a)({},e),n))})).some((function(e){return e.id!==t.id})))throw new Error('There is already a story named "'.concat(n.name,'".'));return{props:n,storyId:t.id,type:"updateStory"}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return k})),n.d(t,"a",(function(){return I}));var r=n(6),a=n(0),o=n(72),c=n.n(o),s=n(61),i=n(4),u=n(2),l=n(19),d=n.n(l),f=n(29);function j(e,t,n){var r=!1,a=!1,o=e.map((function(e){if(e.id!==t)return e;if(r=!0,e.passages.some((function(e){return e.id===n.id})))return console.warn('There is already a passage in this story with ID "'.concat(n.id,'", taking no action')),e;if("name"in n&&e.passages.some((function(e){return e.name===n.name})))return console.warn('There is already a passage in this story with name "'.concat(n.name,'", taking no action')),e;var o=Object(u.a)(Object(u.a)(Object(u.a)({},Object(f.a)()),{},{id:d()()},n),{},{story:e.id}),c=Object(u.a)(Object(u.a)({},e),{},{lastUpdate:new Date,passages:[].concat(Object(i.a)(e.passages),[o])});return 1===c.passages.length&&(c.startPassage=o.id),a=!0,c}));return r?a?o:e:(console.warn('No story in state with ID "'.concat(t,'", taking no action')),e)}function b(e,t,n){var r=!1,a=!1,o=e.map((function(e){if(e.id!==t)return e;r=!0;var o=Object(u.a)(Object(u.a)({},e),{},{passages:e.passages.filter((function(e){return e.id!==n||(a=!0,!1)}))});return a?(o.lastUpdate=new Date,o):e}));return r?a?o:(console.warn('Asked to delete a passage with ID "'.concat(n,'", but it does not exist in story ID ').concat(t,", taking no action")),e):(console.warn('No story in state with ID "'.concat(t,'", taking no action')),e)}var p=n(127);function m(e,t,n,r){var a='Repairing passage (name: "'.concat(e.name,'", id: ').concat(e.id,"): ")+"setting ".concat(t," to ").concat(n,", was ").concat(e[t]);r&&(a+=" (".concat(r,")")),console.info(a)}function h(e,t,n,r){var a='Repairing story (name: "'.concat(e.name,'", id: ').concat(e.id,") by ")+"setting ".concat(t," to ").concat(n,", was ").concat(e[t]);r&&(a+=" (".concat(r,")")),console.info(a)}function O(e,t,n,a){var o=Object(f.b)(),c={};if("string"!==typeof e.id||""===e.id){var s=d()();h(e,"id",s,"was bad type or empty string"),c.id=s}if("string"!==typeof e.ifid||""===e.id){var i=d()();h(e,"ifid",i,"was bad type or empty string"),c.ifid=i}if(Object.entries(o).forEach((function(t){var n=Object(r.a)(t,2),a=n[0],s=n[1],i=a;("number"===typeof s&&!Number.isFinite(e[i])||typeof s!==typeof e[i])&&(h(e,i,o[i]),c[i]=o[i])})),"string"!==typeof e.storyFormat||""===e.storyFormat||"string"!==typeof e.storyFormatVersion||""===e.storyFormatVersion)h(e,"storyFormat",a.name,"was bad type or unset"),h(e,"storyFormatVersion",a.version,"was bad type or unset"),c.storyFormat=a.name,c.storyFormatVersion=a.version;else if(!n.some((function(t){return t.name===e.storyFormat&&t.version===e.storyFormatVersion}))){var l=n.find((function(t){return t.name===e.storyFormat&&Object(p.satisfies)(t.version,"^"+e.storyFormatVersion)}));l?(h(e,"storyFormat",l.name,"no match in existing formats but found one that satisfies semver"),h(e,"storyFormatVersion",l.version,"no match in existing formats but found one that satisfies semver"),c.storyFormat=l.name,c.storyFormatVersion=l.version):(h(e,"storyFormat",a.name,"no match in existing formats and could not find one that satisfies semver"),h(e,"storyFormatVersion",a.version,"no match in existing formats and could not find one that satisfies semver"),c.storyFormat=a.name,c.storyFormatVersion=a.version)}if(t.some((function(t){return t!==e&&t.id===e.id}))){var j=d()();h(e,"id",j,"conflicted with another story's ID"),c.id=j}var b=!1,O=e.passages.map((function(t){var n=function(e,t){var n=Object(f.a)(),a={};if("string"!==typeof e.id||""===e.id){var o=d()();m(e,"id",o,"was undefined or empty string"),a.id=d()()}if(Object.entries(n).forEach((function(t){var o=Object(r.a)(t,2),c=o[0],s=o[1],i=c;("number"===typeof s&&!Number.isFinite(e[i])||typeof s!==typeof e[i])&&(m(e,i,n[i]),a[i]=n[i])})),["left","top"].forEach((function(t){var n=t;e[n]<0&&(m(e,n,0,"was negative"),a[n]=0)})),["height","width"].forEach((function(t){var n=t;e[n]<5&&(m(e,n,0,"was less than 5"),a[n]=5)})),e.story!==t.id&&(m(e,"story",t.id,"didn't match parent story"),a.story=t.id),t.passages.some((function(t){return t!==e&&t.id===e.id}))){var c=d()();m(e,"id",c,"conflicted with another passage in the story"),a.id=c}return Object.keys(a).length>0?Object(u.a)(Object(u.a)({},e),a):e}(t,Object(u.a)(Object(u.a)({},e),c));return n!==t?(b=!0,n):t}));return b&&(c.passages=O),Object.keys(c).length>0?Object(u.a)(Object(u.a)({},e),c):e}var g=n(36);function v(e,t,n,r){var a=!1,o=!1,c=e.map((function(e){if(e.id!==t)return e;if(a=!0,"name"in r&&e.passages.some((function(e){return e.name===r.name&&e.id!==n})))return console.warn('There is already a passage in this story with name "'.concat(r.name,'", taking no action')),e;var c=Object(u.a)(Object(u.a)({},e),{},{passages:e.passages.map((function(e){return e.id!==n?e:(o=!0,Object(u.a)(Object(u.a)({},e),r))}))});return o?(Object(g.a)(r)&&(c.lastUpdate=new Date),c):(console.warn('Asked to update a passage with ID "'.concat(n,'", but it does not exist in story ID ').concat(t,", taking no action")),e)}));return a?o?c:e:(console.warn('No story in state with ID "'.concat(t,'", taking no action')),e)}var y=function(e,t){switch(t.type){case"createPassage":return j(e,t.storyId,t.props);case"createPassages":return function(e,t,n){return n.reduce((function(e,n){return j(e,t,n)}),e)}(e,t.storyId,t.props);case"createStory":return function(e,t){if("id"in t&&e.some((function(e){return e.id===t.id})))return console.warn('There is already a story in state with ID "'.concat(t.id,'", taking no action')),e;if("name"in t&&e.some((function(e){return e.name===t.name})))return console.warn('There is already a story in state with name "'.concat(t.name,'", taking no action')),e;var n=Object(u.a)(Object(u.a)({id:d()()},Object(f.b)()),{},{ifid:d()().toUpperCase(),lastUpdate:new Date,passages:[],tags:[],tagColors:{}},t);return n.passages=n.passages.map((function(e){return Object(u.a)(Object(u.a)(Object(u.a)({},f.a),e),{},{story:n.id})})),[].concat(Object(i.a)(e),[n])}(e,t.props);case"deletePassage":return b(e,t.storyId,t.passageId);case"deletePassages":return function(e,t,n){return n.reduce((function(e,n){return b(e,t,n)}),e)}(e,t.storyId,t.passageIds);case"deleteStory":return function(e,t){var n=!1,r=e.filter((function(e){return e.id!==t||(n=!0,!1)}));return n?r:(console.warn('Asked to delete a story with ID "'.concat(t,'", but it does not exist in state')),e)}(e,t.storyId);case"init":return n=t.state,Object(i.a)(n);case"repair":return function(e,t,n){return e.map((function(r){return O(r,e,t,n)}))}(e,t.allFormats,t.defaultFormat);case"updatePassage":return v(e,t.storyId,t.passageId,t.props);case"updatePassages":return function(e,t,n){return Object.keys(n).reduce((function(e,r){return v(e,t,r,n[r])}),e)}(e,t.storyId,t.passageUpdates);case"updateStory":return function(e,t,n){if("name"in n&&e.some((function(e){return e.name===n.name&&e.id!==t})))return console.warn('There is another story in state with name "'.concat(n.name,'", taking no action')),e;var r=!1,a=e.map((function(e){if(e.id!==t)return e;r=!0;var a=Object(u.a)(Object(u.a)({},e),n);return Object(g.b)(n)&&(a.lastUpdate=new Date),a}));return r?a:(console.warn('Asked to update a story with ID "'.concat(t,'", but it does not exist in state')),e)}(e,t.storyId,t.props);default:console.warn("".concat(t.type," not implemented yet"))}var n;return e},x=n(12),w=n(73),S=n(1),C=a.createContext({dispatch:function(){},stories:[]});C.displayName="Stories";var k=function(){return a.useContext(C)},I=function(e){var t=Object(s.a)().stories,n=Object(x.useStoryFormatsContext)().formats,o=Object(w.a)().reportError,i=a.useMemo((function(){return function(e,r){var a=y(e,r);try{t.saveMiddleware(a,r,n)}catch(c){o(c,"store.errors.cantPersistStories")}return a}}),[n,o,t]),u=c()(i,[]),l=Object(r.a)(u,2),d=l[0],f=l[1];return Object(S.jsx)(C.Provider,{value:{dispatch:f,stories:d},children:e.children})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return re}));var r=n(13),a=n(2),o=n(6),c=n(20),s=n(0),i=n.n(s),u=n(43),l=n(119),d=n(11),f=n(24),j=n(30),b=n(78),p=n(3),m=n(14),h=n(45),O=n(4),g=n(7),v=n(22),y=n(18),x=n(25),w=n(21),S=n.n(w),C=(n(408),n(1)),k=function(e){var t=S()("text-area","orientation-".concat(e.orientation));return Object(C.jsx)("span",{className:t,children:Object(C.jsxs)("label",{children:[Object(C.jsx)("span",{className:"text-input-label",children:e.children}),Object(C.jsx)("textarea",{rows:3,onChange:e.onChange,onInput:e.onInput,placeholder:e.placeholder,value:e.value,style:e.style||{}})]})})},I=(n(156),[{name:"Daniel"},{name:"Fred"},{name:"Richard"},{name:"Dave"},{name:"Robin"},{name:"Charlie"},{name:"Kate"},{name:"Ed"},{name:"Geeta"},{name:"Paul"},{name:"Eleanor"},{name:"Molly"},{name:"Izzy"},{name:"Holly"},{name:"Nadia"},{name:"Chloe"}]),N=function(e){var t=e.onAdd,n=e.lines,r=n.length>0?n[n.length-1]:{},a=s.useState(r.words||""),c=Object(o.a)(a,2),i=c[0],l=c[1],d=s.useState(r.voice||""),f=Object(o.a)(d,2),j=f[0],b=f[1],m=s.useState(r.rate||""),h=Object(o.a)(m,2),y=h[0],w=h[1],S=s.useState(r.delay||""),N=Object(o.a)(S,2),F=N[0],E=N[1],P=s.useState(Math.max(n.length-1,0)),T=Object(o.a)(P,2),D=T[0],A=T[1];s.useEffect((function(){var e=n[D]||{};l((null===e||void 0===e?void 0:e.words)||""),b((null===e||void 0===e?void 0:e.voice)||"Daniel"),w((null===e||void 0===e?void 0:e.rate)||"180"),E((null===e||void 0===e?void 0:e.delay)||"0")}),[D]),s.useEffect((function(){var e=(n||[]).map((function(e,t){return t===D?{words:i,voice:j,rate:y,delay:F}:e}));t(e)}),[i,j,y,F]);Object(u.a)().t;return Object(C.jsxs)("div",{className:"speechcontainer",children:[Object(C.jsxs)("div",{style:{borderBottom:"1px solid black",marginBottom:15},children:[Object(C.jsx)("div",{className:"speechformitem",children:Object(C.jsx)(k,{style:{width:268},placeholder:"something to say",onChange:function(e){return l(e.target.value.replace(/[,]/g," "))},value:i,children:"words"})}),Object(C.jsxs)("div",{className:"paramline",style:{marginTop:15},children:[Object(C.jsx)(x.a,{onChange:function(e){var t=new Audio;t.src="/speechsamples/".concat(e.target.value,".wav"),t.play(),b(e.target.value)},options:I.map((function(e){return{label:e.name,value:e.name}})),value:j,children:"voice"}),Object(C.jsx)(v.a,{style:{width:90},placeholder:"delay(ms)",onChange:function(e){return E(e.target.value)},value:F})]}),Object(C.jsx)("div",{style:{marginTop:10,marginBottom:15,textAlign:"center"},children:Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.I,{}),label:"add more speech",onClick:function(){var e=[].concat(Object(O.a)((n||[]).map((function(e,t){return t===D?{words:i,voice:j,rate:y,delay:F}:e}))),[{}]);t(e),A(n.length),l("some words"),b("Daniel"),w(""),E("")},variant:"create"})})]}),function(){var e=n.map((function(e,r){return Object(C.jsxs)("tr",{onClick:function(){A(r)},children:[Object(C.jsx)("td",{style:{fontSize:"0.9em",paddingTop:7,width:220,maxWidth:220,overflow:"hidden"},children:e.words}),Object(C.jsx)("td",{style:{fontSize:"0.9em",paddingTop:7},children:e.voice}),Object(C.jsx)("td",{style:{fontSize:"0.9em",paddingTop:7},children:e.delay}),Object(C.jsx)("td",{style:{fontSize:"0.9em",paddingTop:7},children:Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.V,{}),iconOnly:!0,label:"",onClick:function(){var e;e=r,t([].concat(Object(O.a)(n.slice(0,e)),Object(O.a)(n.slice(e+1))))},variant:"primary"})})]},r)}));return Object(C.jsx)("div",{style:{maxHeight:500,overflowY:"scroll"},children:Object(C.jsxs)("table",{children:[Object(C.jsx)("thead",{children:Object(C.jsxs)("tr",{children:[Object(C.jsx)("th",{style:{textAlign:"start",fontSize:"0.9em"},children:"words"}),Object(C.jsx)("th",{style:{textAlign:"start",fontSize:"0.9em"},children:"voice"}),Object(C.jsx)("th",{style:{textAlign:"start",fontSize:"0.9em"},children:"pause(ms)"}),Object(C.jsx)("th",{style:{textAlign:"start"}})]})}),Object(C.jsx)("tbody",{children:e})]})})}()]})},F=n(92),E=n.n(F),P=(n(89),[{name:"raw",id:"raw",url:"",params:"{}",method:y.a.GET,description:"Call this custom url"},{name:"arm expand",id:"arm-expand",url:"http://[lenovo]:9107/api/arm/expand",params:"{}",method:y.a.GET,description:"This will move the camera arm into the extended state"},{name:"arm collapse",id:"arm-collapse",url:"http://[lenovo]:9107/api/collapse",params:"{}",method:y.a.GET,description:"This will move the camera arm into the rest state"},{name:"fan",id:"fan",url:"http://[lenovo]:9097/ui/api/fan",params:'{"query":{"rotate": true,"power":10,"cool":true,"from":0,"to":90}}',method:y.a.GET,description:"This will control the dyson fan (temperature, air speed, rotation)"},{name:"smell right on",id:"smell-right-on",url:"http://[smell-right]/on3",method:y.a.GET,params:"{}",description:"This will start the right hand side smell actuator"},{name:"smell right off",id:"smell-right-off",url:"http://[smell-right]/off",method:y.a.GET,params:"{}",description:"This will turn off the right hand side smell actuator"},{name:"smell left on",id:"smell-left-on",url:"http://[smell-left]/on3",method:y.a.GET,params:"{}",description:"This will start the left hand side smell actuator"},{name:"smell left off",id:"smell-left-off",url:"http://[smell-left]/off",method:y.a.GET,params:"{}",description:"This will turn off the left hand side smell actuator"},{name:"nanoleaf",id:"nanoleaf",url:"http://[lenovo]:9104/ui/api/hex",method:y.a.GET,params:'{"query":{"hue":203,"sat":91,"brightness":99}}',description:"This will set the colours of the nanoleaf lights (under the caravan seat)"},{name:"hue",id:"huecolour",method:y.a.GET,url:"http://[lenovo]:9092/ui/api/hex",params:'{"query":{"hex":"ff0000"}}',description:"This will change the hue lights colour"},{name:"togglewindows",id:"togglewindows",method:y.a.GET,url:"http://[windows]:9222/H",params:"{}",description:"This will toggle the opacity of the caravan windows"},{name:"printline",id:"printline",method:y.a.POST,url:"http://[receipt]:8080/print",params:'{"body":{"text":"a line of text"}}',description:"This will print a line of text on the label printer"},{name:"speech",id:"speech",method:y.a.POST,url:"http://[speech]:9105/api/speech",params:'{"body":{"speech":[{"words":"a line of speech"}]}}',description:"This will send text to the speech synthesizer, or if you render, it will play speech generated Mozilla's speech synthesizer"},{name:"screen - home",id:"screen-home",method:y.a.GET,url:"http://[lenovo]:9102/api/home",params:"{}",description:"This set the caravan screen to the 'future mundane' title"},{name:"screen - dyson",id:"screen-dyson",method:y.a.GET,url:"http://[lenovo]:9102/api/air",params:"{}",description:"This will show the air quality readings from the dyson fan"},{name:"screen - media",id:"screen-media",method:y.a.GET,url:"http://[lenovo]:9102/api/media",params:"{}",description:"This will make the caravan screen go black, ready to play a media file.  Follow this action with a 'screen - play' action"},{name:"screen - play",id:"screen-media-play",method:y.a.GET,url:"http://[lenovo]:9102/api/media/play",params:'{"query":{"media":"","delay":0}}',description:"This will play a media (mp4) file, which must be in the media directory on the lenovo.  Make sure you have called 'screen - media' first "},{name:"screen - camera",id:"screen-camera",method:y.a.GET,url:"http://[lenovo]:9102/api/camera",params:"{}",description:"This will show live video from the camera on the caravan screen"},{name:"screen - message",id:"message",method:y.a.GET,url:"http://[lenovo]:9102/api/message",params:'{"query":{"message":"a message"}}',description:"This will flash up a message on the screen, it will overlay it on whatever is currently on there"},{name:"screen - qrcode",id:"qrcode",method:y.a.GET,url:"http://[lenovo]:9102/api/qrcode",params:'{"query":{"qrcode":"http://[lenovo]:3001/wa/"}}',description:"This will put a qrcode up on the screen to, for example, get a user to use a webapp served by the caravan.  Webapps could call bespoke webhook event to make something happen in the caravan"}]),T=function(e){var t=e.onAdd,n=e.onClose,r=e.action,c=s.useState(r),i=Object(o.a)(c,2),l=i[0],d=i[1],f=s.useState(),j=Object(o.a)(f,2),b=j[0],m=j[1],h=s.useState([]),w=Object(o.a)(h,2),S=w[0],k=w[1],I=s.useState(function(e){var t=(e.action||"").toString(),n=P.map((function(e){return e.url})).indexOf(t);return-1===n?"raw":P[n].id}(r)),F=Object(o.a)(I,2),T=F[0],D=F[1],A=Object(u.a)().t;s.useEffect((function(){E.a.get("/media/list").end((function(e,t){if(!e){var n=t.body.files;k(void 0===n?[]:n)}}))}),[b]);var L=function(e){var t=e.target.value;R("POST"===t?y.a.POST:y.a.GET)},M=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";d(Object(a.a)(Object(a.a)({},l),{},{params:e}))},R=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:y.a.GET;d(Object(a.a)(Object(a.a)({},l),{},{method:e}))},W=function(e){var t=e.target.files,n=void 0===t?[]:t;n&&n.length>0&&m(n[0])},U=function(){if(b){var e=new FormData;e.append("mediaFile",b,b.name),E.a.post("/media/upload").send(e).end((function(e,t){console.log(e,t),e||(m(void 0),M(JSON.stringify({query:{media:b.name}})))}))}};return Object(C.jsxs)("div",{className:"add-dialogue",children:[Object(C.jsx)("div",{className:"heading",children:"add action"}),Object(C.jsx)("div",{className:"formItem",children:Object(C.jsx)(x.a,{onChange:function(e){D(e.target.value),d(Object(a.a)(Object(a.a)({},l),P.reduce((function(t,n){return n.id===e.target.value?{action:n.url,params:n.params,method:n.method,delay:0}:t}),{})))},options:P.map((function(e){return{label:e.name,value:e.id}})),value:T,children:"action profiles"})}),Object(C.jsx)("div",{className:"description",children:P.reduce((function(e,t){return t.id===T?t.description:e}),"")}),Object(C.jsx)("div",{className:"formItem",children:function(){if("raw"===T)return Object(C.jsx)(v.a,{onChange:function(e){return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";d(Object(a.a)(Object(a.a)({},l),{},{action:e}))}(e.target.value)},value:l.action.toString(),helptext:"a url or a tag!",children:"url"})}()}),Object(C.jsx)("div",{className:"formItem",children:function(){if("raw"==T)return Object(C.jsx)(x.a,{onChange:L,options:[{disabled:!1,label:"GET",value:y.a.GET},{disabled:!1,label:"POST",value:y.a.POST}],value:l.method===y.a.POST?y.a.POST:y.a.GET,children:"method"})}()}),Object(C.jsx)("div",{className:"formItem",children:function(){switch(T){case"screen-media-play":return function(){var e=JSON.parse(l.params||"{}").query,t=(void 0===e?{}:e).media,n=void 0===t?"":t;return Object(C.jsxs)("div",{style:{paddingBottom:7},children:[Object(C.jsxs)("div",{style:{paddingTop:7,paddingBottom:15,borderBottom:"1px solid"},children:[Object(C.jsx)("div",{style:{marginTop:7,marginBottom:15,fontWeight:700},children:"Select from media on caravan server"}),Object(C.jsx)(x.a,{onChange:function(e){console.log("setting media",e.target.value),M(JSON.stringify({query:{media:e.target.value}}))},options:[{label:"",value:""}].concat(Object(O.a)(S.map((function(e){return{label:e,value:e}})))),value:n,children:"media in caravan"})]}),Object(C.jsxs)("div",{style:{paddingTop:15,paddingBottom:7},children:[Object(C.jsx)("div",{style:{marginTop:7,marginBottom:15,fontWeight:700},children:"Or upload new media"}),Object(C.jsx)("div",{children:Object(C.jsx)("input",{type:"file",onChange:W})}),Object(C.jsx)("div",{style:{marginTop:10},children:b&&Object(C.jsx)(g.a,{disabled:!1,icon:Object(C.jsx)(p.W,{}),label:A("Upload this file"),onClick:U,variant:"primary"})})]}),""!=n.trim()&&Object(C.jsxs)("div",{style:{textAlign:"center",borderRadius:5,padding:10,marginTop:15,fontSize:"1em"},children:[Object(C.jsx)("strong",{children:"play file: "}),"".concat(n)]})]})}();case"nanoleaf":return function(){var e=JSON.parse(l.params||"{}").query,t=(void 0===e?{}:e).hex,n=void 0===t?"ff0000":t;return Object(C.jsxs)(C.Fragment,{children:[Object(C.jsx)("input",{type:"color",id:"favcolor",name:"favcolor",value:"#".concat(n),onChange:function(e){M(JSON.stringify({query:{hex:e.target.value.replace("#","")}}))}}),Object(C.jsx)("p",{className:"description",children:"select a colour for the lights"})]})}();case"huecolour":return function(){var e=JSON.parse(l.params||"{}").query,t=(void 0===e?{}:e).hex,n=void 0===t?"ff0000":t;return Object(C.jsxs)(C.Fragment,{children:[Object(C.jsx)("input",{type:"color",id:"favcolor",name:"favcolor",value:"#".concat(n),onChange:function(e){M(JSON.stringify({query:{hex:e.target.value.replace("#","")}}))}}),Object(C.jsx)("p",{className:"description",children:"select a colour for the lights"})]})}();case"raw":return Object(C.jsx)(v.a,{onChange:function(e){return M(e.target.value)},helptext:"as a json object e.g {'greeting':{'hello':'world'}}",value:l.params||"",children:"params"});case"message":return function(){var e=JSON.parse(l.params||"{}").query,t=(void 0===e?{}:e).message,n=void 0===t?"a message":t;return Object(C.jsx)(v.a,{onChange:function(e){return M(JSON.stringify({query:{message:e.target.value}}))},helptext:"the message you want to display",value:n,children:"message"})}();case"printline":return function(){var e=JSON.parse(l.params||"{}").body,t=(void 0===e?{}:e).text,n=void 0===t?"a line to print":t;return Object(C.jsx)(v.a,{onChange:function(e){return M(JSON.stringify({body:{text:e.target.value}}))},helptext:"the message you want to display",value:n,children:"line to print"})}();case"fan":return function(){var e=JSON.parse(l.params||"{}").query,t=void 0===e?{}:e,n=t.rotate,r=void 0===n||n,a=t.power,o=void 0===a?10:a,c=t.cool,s=void 0===c||c,i=t.from,u=void 0===i?0:i,d=t.to,f=void 0===d?90:d,j=[0,1,2,3,4,5,6,7,8,9,10].map((function(e){return{label:"".concat(e),value:"".concat(e)}}));return Object(C.jsxs)("div",{style:{display:"flex",flexDirection:"column"},children:[Object(C.jsx)("div",{className:"formItem",children:Object(C.jsx)(x.a,{onChange:function(e){M(JSON.stringify({query:{rotate:"true"===e.target.value,power:o,cool:s,from:u,to:f}}))},options:[{label:"true",value:"true"},{label:"false",value:"false"}],value:r?"true":"false",children:"rotate"})}),Object(C.jsx)("div",{className:"formItem",children:Object(C.jsx)(x.a,{onChange:function(e){M(JSON.stringify({query:{rotate:r,power:Number(e.target.value),cool:s,from:u,to:f}}))},options:j,value:o,children:"power"})}),Object(C.jsx)("div",{className:"formItem",children:Object(C.jsx)(x.a,{onChange:function(e){M(JSON.stringify({query:{rotate:r,cool:"true"===e.target.value,power:o,from:u,to:f}}))},options:[{label:"true",value:"true"},{label:"false",value:"false"}],value:s?"true":"false",children:"cool"})}),Object(C.jsx)("div",{className:"formItem",children:Object(C.jsx)(v.a,{onChange:function(e){isNaN(Number(e.target.value))||M(JSON.stringify({query:{rotate:r,cool:s,power:o,from:Number(e.target.value),to:f}}))},helptext:"rotation from (deg)",value:u,children:"rotation from"})}),Object(C.jsx)("div",{className:"formItem",children:Object(C.jsx)(v.a,{onChange:function(e){isNaN(Number(e.target.value))||M(JSON.stringify({query:{rotate:r,cool:s,power:o,to:Number(e.target.value),from:u}}))},helptext:"rotation to (deg)",value:f,children:"rotation to"})})]})}();case"speech":return function(){var e=JSON.parse(l.params||"{}").body,t=(void 0===e?{}:e).speech,n=void 0===t?[]:t;return Object(C.jsx)(N,{lines:n,onAdd:function(e){M(JSON.stringify({body:{speech:e}}))}})}();case"qrcode":return function(){var e=JSON.parse(l.params||"{}").query,t=(void 0===e?{}:e).qrcode,n=void 0===t?"http://[lenovo]:3001/wa/":t;return Object(C.jsx)(v.a,{onChange:function(e){return M(JSON.stringify({query:{qrcode:e.target.value}}))},helptext:"the url to embed with the qrcode",value:n,children:"url"})}();default:return}}()}),Object(C.jsx)("div",{className:"formItem",children:Object(C.jsx)(v.a,{style:{width:60},onChange:function(e){return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"0";d(Object(a.a)(Object(a.a)({},l),{},{delay:isNaN(Number(e))?0:Number(e)}))}(e.target.value)},helptext:"pause in ms BEFORE action fires",value:"".concat(l.delay||0),children:"delay"})}),Object(C.jsxs)("div",{style:{textAlign:"center"},children:[Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.n,{}),iconOnly:!0,label:"",onClick:function(){return t(function(e){return Object(a.a)(Object(a.a)({},e),{},{delay:isNaN(Number(e.delay))?0:Number(e.delay),method:e.method?e.method:y.a.GET,params:e.params||""})}(l))},variant:"primary"}),Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.V,{}),iconOnly:!0,label:"",onClick:n,variant:"primary"})]})]})},D=function(e){var t=e.actions,n=i.a.useState(""),r=Object(o.a)(n,2),a=r[0],c=r[1],s=i.a.useState(0),u=Object(o.a)(s,2),l=u[0],d=u[1],f=i.a.useState(0),j=Object(o.a)(f,2),b=j[0],m=j[1],h=function(){console.log("settin gmode to emot!!"),c("")},O=function(t,n){console.log("Adding action",n),h(),e.addAction(t,n)};if(t.length<=0)return Object(C.jsx)("div",{style:{marginTop:10},children:Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.I,{}),style:{fontSize:"0.8em"},label:"add a new action",onClick:function(){O(0,{action:"",params:"{}",method:y.a.GET}),c("edit")},variant:"primary"})});var v=t.map((function(t,n){var r=t.map((function(t,r){return Object(C.jsx)("div",{style:{padding:7},children:Object(C.jsxs)("div",{style:{display:"flex",flexDirection:"row",alignItems:"center"},children:[Object(C.jsxs)("div",{style:{display:"flex",flex:"1 1 auto",flexDirection:"column"},children:[Object(C.jsx)("div",{style:{padding:4,display:"flex",flexDirection:"row"},children:Object(C.jsxs)("div",{style:{flex:"1 1 auto",fontSize:"0.9em"},children:["after waiting ",t.delay," ms, call"]})}),Object(C.jsx)("div",{style:{padding:4,display:"flex",flexDirection:"column"},children:Object(C.jsx)("div",{style:{flex:"1 1 auto",fontSize:"0.9em",fontWeight:700},children:t.action.toString()})})]}),Object(C.jsxs)("div",{style:{display:"flex",flexDirection:"row"},children:[Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.u,{}),iconOnly:!0,label:"",onClick:function(){return function(e,t){c("edit"),d(e),m(t)}(n,r)},variant:"primary"}),Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.V,{}),iconOnly:!0,label:"",onClick:function(){return function(t,n){e.deleteAction(t,n)}(n,r)},variant:"primary"}),Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.I,{}),iconOnly:!0,label:"",onClick:function(){!function(e){c("add"),d(e)}(n)},variant:"primary"})]})]})},"".concat(n,"-").concat(r))}));return Object(C.jsx)("div",{style:{borderLeft:"2px solid black",marginBottom:10},children:r},n)}));return Object(C.jsxs)(C.Fragment,{children:[Object(C.jsxs)("div",{style:{marginLeft:10},children:["add"===a&&Object(C.jsx)(T,{onClose:h,action:{action:""},onAdd:function(e){h(),O(l,e)}}),"edit"===a&&Object(C.jsx)(T,{onClose:h,action:t[l][b],onAdd:function(t){h(),e.editAction(l,b,t)}}),v]}),Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.d,{}),style:{fontSize:"0.8em"},label:"add parallel action(s)",onClick:function(){c("edit"),d(t.length),e.addParallelAction()},variant:"primary"})]})},A=function(e){var t=e.onAdd,n=e.onCancel,r=Object(u.a)().t,c=s.useState(e.rules||[{rule:{operator:"equals",operand:""},actions:[],next:""}]),i=Object(o.a)(c,2),l=i[0],f=i[1],j=function(e,t,n){return e.length<=t?e:(e||[]).reduce((function(e,r,a){if(a!==t)return[].concat(Object(O.a)(e),[r]);var o=r.filter((function(e,t){return t!==n}));return o.length<=0?e:[].concat(Object(O.a)(e),[o])}),[])},b=function(e,t,n,r){return e.length<=t?[].concat(Object(O.a)(e),[[r]]):(e||[]).reduce((function(e,a,o){return[].concat(Object(O.a)(e),o!==t?[a]:[a.map((function(e,t){return t===n?r:e}))])}),[])},m=function(e,t,n){return e.length<=t?[].concat(Object(O.a)(e),[[n]]):(e||[]).reduce((function(e,r,a){return[].concat(Object(O.a)(e),a!==t?[r]:[[].concat(Object(O.a)(r),[n])])}),[])},h=function(e,t,n){var r=l.reduce((function(r,o,c){return[].concat(Object(O.a)(r),c!==e?[o]:[Object(a.a)(Object(a.a)({},o),{},{actions:m(o.actions,t,n)})])}),[]);f(r)},y=function(e,t){return Object(C.jsxs)("div",{className:"rulerow",children:[Object(C.jsx)("div",{children:"then go to"}),Object(C.jsx)(v.a,{placeholder:"next part",style:{padding:2},onChange:function(t){return function(e,t){f(l.reduce((function(n,r,o){return[].concat(Object(O.a)(n),o!==e?[r]:[Object(a.a)(Object(a.a)({},r),{},{next:t.trim()})])}),[]))}(e,t.target.value)},value:t})]})},x=function(e,t){return Object(C.jsxs)("div",{children:[Object(C.jsxs)("div",{className:"rulerow",children:[Object(C.jsx)("div",{children:"when"}),Object(C.jsx)("div",{style:{marginTop:2},children:Object(C.jsx)(v.a,{placeholder:"name",style:{padding:2,width:Math.max(20,9*t.rule.operand.length)},onChange:function(t){return function(e,t){f(l.reduce((function(n,r,o){return[].concat(Object(O.a)(n),o!==e?[r]:[Object(a.a)(Object(a.a)({},r),{},{rule:Object(a.a)(Object(a.a)({},r.rule),{},{operand:t})})])}),[]))}(e,t.target.value)},value:(n=t.rule.operand,Array.isArray(n)?n.join(","):n)})}),Object(C.jsxs)("div",{onClick:function(){h(0,0,{action:""})},children:["is pressed, call ",t.actions.length<=0?"nothing":""," "]})]}),t.actions.length>0&&Object(C.jsx)(D,{actions:t.actions,deleteAction:function(t,n){return function(e,t,n){var r=l.reduce((function(r,o,c){return[].concat(Object(O.a)(r),c!==e?[o]:[Object(a.a)(Object(a.a)({},o),{},{actions:j(o.actions,t,n)})])}),[]);f(r)}(e,t,n)},addAction:function(t,n){h(e,t,n)},editAction:function(t,n,r){return function(e,t,n,r){var o=l.reduce((function(o,c,s){return[].concat(Object(O.a)(o),s!==e?[c]:[Object(a.a)(Object(a.a)({},c),{},{actions:b(c.actions,t,n,r)})])}),[]);f(o)}(e,t,n,r)},addParallelAction:function(){return function(e){var t=l.reduce((function(t,n,r){return[].concat(Object(O.a)(t),r!==e?[n]:[Object(a.a)(Object(a.a)({},n),{},{actions:[].concat(Object(O.a)(n.actions),[[{action:""}]])})])}),[]);f(t)}(e)}}),y(e,(t.next||"").trim())]},e);var n};return Object(C.jsxs)(C.Fragment,{children:[Object(C.jsxs)("div",{id:"rules",style:{marginBottom:40},children:[l.map((function(e,t){return x(t,e)})),Object(C.jsx)("div",{style:{textAlign:"center"},children:Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.I,{}),iconOnly:!1,label:"add another rule",onClick:function(){f([].concat(Object(O.a)(l),[{rule:{operator:"equals",operand:""},actions:[],next:""}]))},variant:"primary"})})]}),Object(C.jsx)("div",{style:{display:"flex",justifyContent:"center"},children:Object(C.jsxs)(d.a,{children:[Object(C.jsx)(g.a,{disabled:!1,icon:Object(C.jsx)(p.I,{}),label:r("Update"),onClick:function(){return t(l)},variant:"create"}),Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.Y,{}),label:r("common.cancel"),onClick:function(){return n()}})]})})]})},L=function(e){var t=e.onAdd,n=e.onCancel,r=Object(u.a)().t,c=s.useState(e.rules||[{rule:{operator:"equals",operand:""},actions:[],next:""}]),i=Object(o.a)(c,2),l=i[0],f=i[1],j=function(e,t,n){return e.length<=t?e:(e||[]).reduce((function(e,r,a){if(a!==t)return[].concat(Object(O.a)(e),[r]);var o=r.filter((function(e,t){return t!==n}));return o.length<=0?e:[].concat(Object(O.a)(e),[o])}),[])},b=function(e,t,n,r){return e.length<=t?[].concat(Object(O.a)(e),[[r]]):(e||[]).reduce((function(e,a,o){return[].concat(Object(O.a)(e),o!==t?[a]:[a.map((function(e,t){return t===n?r:e}))])}),[])},m=function(e,t,n){return e.length<=t?[].concat(Object(O.a)(e),[[n]]):(e||[]).reduce((function(e,r,a){return[].concat(Object(O.a)(e),a!==t?[r]:[[].concat(Object(O.a)(r),[n])])}),[])},h=function(e,t,n){var r=l.reduce((function(r,o,c){return[].concat(Object(O.a)(r),c!==e?[o]:[Object(a.a)(Object(a.a)({},o),{},{actions:m(o.actions,t,n)})])}),[]);f(r)},y=function(e,t){return Object(C.jsxs)("div",{className:"rulerow",children:[Object(C.jsx)("div",{children:"then go to"}),Object(C.jsx)(v.a,{placeholder:"next part",style:{padding:2},onChange:function(t){return function(e,t){f(l.reduce((function(n,r,o){return[].concat(Object(O.a)(n),o!==e?[r]:[Object(a.a)(Object(a.a)({},r),{},{next:t})])}),[]))}(e,t.target.value)},value:t})]})},x=function(e,t){return Object(C.jsxs)(C.Fragment,{children:[Object(C.jsxs)("div",{className:"rulecol",children:[Object(C.jsx)("div",{children:"If any of the following words are spoken"}),Object(C.jsx)("div",{style:{marginTop:15,marginBottom:7},children:Object(C.jsx)(v.a,{placeholder:"name",style:{padding:2,width:300},onChange:function(t){return function(e,t){f(l.reduce((function(n,r,o){return[].concat(Object(O.a)(n),o!==e?[r]:[Object(a.a)(Object(a.a)({},r),{},{rule:Object(a.a)(Object(a.a)({},r.rule),{},{operand:t})})])}),[]))}(e,t.target.value)},value:(n=t.rule.operand,Array.isArray(n)?n.join(","):n)})}),Object(C.jsxs)("div",{style:{marginBottom:15,marginTop:7},children:["call  ",Object(C.jsx)("span",{className:"link",onClick:function(){h(0,0,{action:""})},children:t.actions.length<=0?"nothing":""})," "]})]}),t.actions.length>0&&Object(C.jsx)(D,{actions:t.actions,deleteAction:function(t,n){return function(e,t,n){var r=l.reduce((function(r,o,c){return[].concat(Object(O.a)(r),c!==e?[o]:[Object(a.a)(Object(a.a)({},o),{},{actions:j(o.actions,t,n)})])}),[]);f(r)}(e,t,n)},addAction:function(t,n){h(e,t,n)},editAction:function(t,n,r){return function(e,t,n,r){var o=l.reduce((function(o,c,s){return[].concat(Object(O.a)(o),s!==e?[c]:[Object(a.a)(Object(a.a)({},c),{},{actions:b(c.actions,t,n,r)})])}),[]);f(o)}(e,t,n,r)},addParallelAction:function(){return function(e){var t=l.reduce((function(t,n,r){return[].concat(Object(O.a)(t),r!==e?[n]:[Object(a.a)(Object(a.a)({},n),{},{actions:[].concat(Object(O.a)(n.actions),[[{action:""}]])})])}),[]);f(t)}(e)}}),y(e,t.next||"")]});var n};return Object(C.jsxs)(C.Fragment,{children:[Object(C.jsxs)("div",{id:"speechrules",style:{marginBottom:10},children:[l.map((function(e,t){return x(t,e)})),Object(C.jsx)("div",{style:{textAlign:"center"},children:Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.I,{}),iconOnly:!1,label:"add another rule",onClick:function(){f([].concat(Object(O.a)(l),[{rule:{operator:"contains",operand:""},actions:[],next:""}]))},variant:"primary"})})]}),Object(C.jsx)("div",{style:{display:"flex",justifyContent:"center"},children:Object(C.jsxs)(d.a,{children:[Object(C.jsx)(g.a,{disabled:!1,icon:Object(C.jsx)(p.I,{}),label:r("Update"),onClick:function(){return t(l)},variant:"create"}),Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.Y,{}),label:r("common.cancel"),onClick:function(){return n()}})]})})]})},M=function(e){var t=e.onAdd,n=e.onCancel,r=Object(u.a)().t,c=s.useState(e.rules||[{rule:{operator:"equals",operand:""},actions:[],next:""}]),i=Object(o.a)(c,2),l=i[0],f=i[1],j=function(e,t,n){return e.length<=t?e:(e||[]).reduce((function(e,r,a){if(a!==t)return[].concat(Object(O.a)(e),[r]);var o=r.filter((function(e,t){return t!==n}));return o.length<=0?e:[].concat(Object(O.a)(e),[o])}),[])},b=function(e,t,n,r){return e.length<=t?[].concat(Object(O.a)(e),[[r]]):(e||[]).reduce((function(e,a,o){return[].concat(Object(O.a)(e),o!==t?[a]:[a.map((function(e,t){return t===n?r:e}))])}),[])},m=function(e,t,n){return e.length<=t?[].concat(Object(O.a)(e),[[n]]):(e||[]).reduce((function(e,r,a){return[].concat(Object(O.a)(e),a!==t?[r]:[[].concat(Object(O.a)(r),[n])])}),[])},h=function(e,t,n){var r=l.reduce((function(r,o,c){return[].concat(Object(O.a)(r),c!==e?[o]:[Object(a.a)(Object(a.a)({},o),{},{actions:m(o.actions,t,n)})])}),[]);f(r)},y=function(e,t){return Object(C.jsxs)("div",{className:"rulerow",children:[Object(C.jsx)("div",{children:"then go to"}),Object(C.jsx)(v.a,{placeholder:"next part",style:{padding:2},onChange:function(t){return function(e,t){f(l.reduce((function(n,r,o){return[].concat(Object(O.a)(n),o!==e?[r]:[Object(a.a)(Object(a.a)({},r),{},{next:t.trim()})])}),[]))}(e,t.target.value)},value:t})]})},x=function(e,t){return Object(C.jsxs)("div",{children:[Object(C.jsxs)("div",{className:"rulerow",children:[Object(C.jsx)("div",{children:"when"}),Object(C.jsx)("div",{style:{marginTop:2},children:Object(C.jsx)(v.a,{placeholder:"name",style:{padding:2,width:Math.max(20,9*t.rule.operand.length)},onChange:function(t){return function(e,t){f(l.reduce((function(n,r,o){return[].concat(Object(O.a)(n),o!==e?[r]:[Object(a.a)(Object(a.a)({},r),{},{rule:Object(a.a)(Object(a.a)({},r.rule),{},{operand:t})})])}),[]))}(e,t.target.value)},value:(n=t.rule.operand,Array.isArray(n)?n.join(","):n)})}),Object(C.jsxs)("div",{onClick:function(){h(0,0,{action:""})},children:["is called, call ",t.actions.length<=0?"nothing":""," "]})]}),t.actions.length>0&&Object(C.jsx)(D,{actions:t.actions,deleteAction:function(t,n){return function(e,t,n){var r=l.reduce((function(r,o,c){return[].concat(Object(O.a)(r),c!==e?[o]:[Object(a.a)(Object(a.a)({},o),{},{actions:j(o.actions,t,n)})])}),[]);f(r)}(e,t,n)},addAction:function(t,n){h(e,t,n)},editAction:function(t,n,r){return function(e,t,n,r){var o=l.reduce((function(o,c,s){return[].concat(Object(O.a)(o),s!==e?[c]:[Object(a.a)(Object(a.a)({},c),{},{actions:b(c.actions,t,n,r)})])}),[]);f(o)}(e,t,n,r)},addParallelAction:function(){return function(e){var t=l.reduce((function(t,n,r){return[].concat(Object(O.a)(t),r!==e?[n]:[Object(a.a)(Object(a.a)({},n),{},{actions:[].concat(Object(O.a)(n.actions),[[{action:""}]])})])}),[]);f(t)}(e)}}),y(e,(t.next||"").trim())]},e);var n};return Object(C.jsxs)(C.Fragment,{children:[Object(C.jsxs)("div",{id:"rules",style:{marginBottom:40},children:[l.map((function(e,t){return x(t,e)})),Object(C.jsx)("div",{style:{textAlign:"center"},children:Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.I,{}),iconOnly:!1,label:"add another rule",onClick:function(){f([].concat(Object(O.a)(l),[{rule:{operator:"equals",operand:""},actions:[],next:""}]))},variant:"primary"})})]}),Object(C.jsx)("div",{style:{display:"flex",justifyContent:"center"},children:Object(C.jsxs)(d.a,{children:[Object(C.jsx)(g.a,{disabled:!1,icon:Object(C.jsx)(p.I,{}),label:r("Update"),onClick:function(){return t(l)},variant:"create"}),Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.Y,{}),label:r("common.cancel"),onClick:function(){return n()}})]})})]})},R=function(e){var t=e.icon,n=e.label,r=e.type,a=e.onAdd,c=s.useState(!0),i=Object(o.a)(c,2),l=i[0],d=(i[1],s.useState(!1)),f=Object(o.a)(d,2),j=f[0],b=f[1],O=Object(u.a)().t;return Object(C.jsx)("span",{className:"add-tag-button",children:Object(C.jsx)(h.a,{disabled:!1,icon:null!==t&&void 0!==t?t:Object(C.jsx)(p.I,{}),label:null!==n&&void 0!==n?n:O("common.rules"),onChangeOpen:function(){b(!0)},open:j,children:Object(C.jsx)(m.b,{style:{width:460,overflowY:"auto"},children:Object(C.jsxs)("div",{className:"container",children:[Object(C.jsx)("div",{className:"help",children:"Rules determine what needs to happen to move from this node to another node.  So far we support buttons being pressed (by the experience controller) or keywords being said by the particpants (experimental)"}),Object(C.jsxs)("div",{style:{padding:15,background:"#cfe4fc",borderRadius:5,marginTop:15},children:[Object(C.jsx)("div",{style:{marginBottom:15,paddingBottom:15,borderBottom:"1px solid black"},children:Object(C.jsx)(x.a,{onChange:function(t){console.log("seen a type change!!",t.target.value),e.onSelect(t.target.value)},options:[{label:"button",value:"button"},{label:"webhook",value:"webhook"},{label:"speech",value:"speech"}],value:r,children:"rule type"})}),"button"===r&&Object(C.jsx)(A,{onCancel:function(){b(!1)},type:r,rules:e.rules,onAdd:function(e){console.log("add buttn rules, add rukes",e),b(!1),a(e)}}),"webhook"===r&&Object(C.jsx)(M,{onCancel:function(){b(!1)},type:r,rules:e.rules,onAdd:function(e){console.log("add webhook rules, add rukes",e),b(!1),a(e)}}),"speech"===r&&Object(C.jsx)(L,{onCancel:function(){b(!1)},type:r,rules:e.rules,onAdd:function(e){console.log("add speech rules, add rukes",e),b(!1),a(e)}})]}),l&&!1]})})})})},W=n(12),U=n(5),z=n(26),B=n(240),J=n(56),V=n(9),q=n(76),G=n(57),Y=n.n(G),H=n(39);var _=n(77),X=n(131);var $=n(59),Z=(n(432),function(e){var t=e.editor,n=e.storyFormat,c=Object(X.a)(),i=Object(V.usePrefsContext)().prefs,u=function(e,t){var n=Object(W.useStoryFormatsContext)(),c=n.dispatch,i=n.formats,u=s.useState({}),l=Object(o.a)(u,2),d=l[0],f=l[1],j=s.useState(),b=Object(o.a)(j,2),p=b[0],m=b[1],h=Object(W.formatWithNameAndVersion)(i,e,t),g=Object(V.usePrefsContext)().prefs,v=Object(V.formatEditorExtensionsDisabled)(g,e,t);return s.useEffect((function(){if(!v)if("unloaded"===h.loadState)c(Object(W.loadFormatProperties)(h));else if("loaded"===h.loadState&&!d[Object(H.c)(h)]){var e,t,n=Object(H.c)(h),o=Object(H.b)(h,q.a);if(null===o||void 0===o||null===(e=o.codeMirror)||void 0===e?void 0:e.commands)for(var s in o.codeMirror.commands){var i=n+s;i in Y.a.commands?console.warn('CodeMirror already has a "'.concat(i,'" command defined, skipping')):Y.a.commands[i]=o.codeMirror.commands[s]}(null===o||void 0===o||null===(t=o.codeMirror)||void 0===t?void 0:t.toolbar)&&m((function(){return function(e,t){var r;if(!(null===o||void 0===o||null===(r=o.codeMirror)||void 0===r?void 0:r.toolbar))return[];var c=o.codeMirror.toolbar(e,t);return Array.isArray(c)?c.reduce((function(e,t){switch(t.type){case"button":return[].concat(Object(O.a)(e),[Object(a.a)(Object(a.a)({},t),{},{command:n+t.command})]);case"menu":if(Array.isArray(t.items))return[].concat(Object(O.a)(e),[Object(a.a)(Object(a.a)({},t),{},{items:t.items.filter((function(e){return["button","separator"].includes(e.type)})).map((function(e){return"separator"===e.type?e:Object(a.a)(Object(a.a)({},e),{},{command:n+e.command})}))})])}return e}),[]):[]}})),f((function(e){return Object(a.a)(Object(a.a)({},e),{},Object(r.a)({},Object(H.c)(h),!0))}))}}),[c,v,h,d]),p}(n.name,n.version),l=s.useState([]),f=Object(o.a)(l,2),j=f[0],b=f[1];return s.useEffect((function(){if(u&&t)try{b(u(t,{appTheme:c,locale:i.locale}))}catch(e){console.error("Toolbar function for ".concat(n.name," ").concat(n.version," threw an error, skipping update"),e)}else b([])}),[c,t,i.locale,n.name,n.version,u]),Object(C.jsx)("div",{className:"story-format-toolbar",children:Object(C.jsx)(d.a,{children:j.map((function(e,n){switch(e.type){case"button":return Object(C.jsx)(g.a,{disabled:e.disabled,icon:Object(C.jsx)("img",{src:e.icon,alt:""}),label:e.label,onClick:function(){return null===t||void 0===t?void 0:t.execCommand(e.command)}},n);case"menu":return Object(C.jsx)($.a,{disabled:e.disabled,icon:Object(C.jsx)("img",{src:e.icon,alt:""}),items:e.items.filter((function(e){return["button","separator"].includes(e.type)})).map((function(e){return"button"===e.type?{type:"button",disabled:e.disabled,label:e.label,onClick:function(){return null===t||void 0===t?void 0:t.execCommand(e.command)}}:{separator:!0}})),label:e.label},n)}return null}))})})}),K=function(e){var t,n=e.onChange,r=e.onEditorChange,c=e.passage,i=e.storyFormat,l=s.useState(!1),d=Object(o.a)(l,2),j=d[0],b=d[1],p=s.useState(c.text),m=Object(o.a)(p,2),h=m[0],O=m[1],g=s.useState(),v=Object(o.a)(g,2),y=v[0],x=v[1],w=Object(V.usePrefsContext)().prefs,S=null!==(t=function(e,t){var n=Object(W.useStoryFormatsContext)(),r=n.dispatch,a=n.formats,c=Object(W.formatWithNameAndVersion)(a,e,t),i=Object(V.usePrefsContext)().prefs,u=s.useState(),l=Object(o.a)(u,2),d=l[0],f=l[1],j=Object(V.formatEditorExtensionsDisabled)(i,e,t);return s.useEffect((function(){if(!j)if("unloaded"===c.loadState)r(Object(W.loadFormatProperties)(c));else if("loaded"===c.loadState){var e,t=Object(H.b)(c,q.a);(null===t||void 0===t||null===(e=t.codeMirror)||void 0===e?void 0:e.mode)&&(Y.a.defineMode(Object(H.c)(c),t.codeMirror.mode),f(Object(H.c)(c)))}}),[r,j,c]),d}(i.name,i.version))&&void 0!==t?t:"text",k=Object(u.a)().t;s.useEffect((function(){j||h===c.text||O(c.text)}),[j,h,c.text]);var I=s.useMemo((function(){return Object(B.debounce)((function(e){n(e),b(!1)}),1e3)}),[n]);return Object(C.jsxs)(C.Fragment,{children:[Object(C.jsx)(Z,{editor:y,storyFormat:i}),Object(C.jsx)(f.b,{children:Object(C.jsx)(J.a,{editorDidMount:function(e){x(e),r(e),window.setTimeout((function(){e.focus(),e.refresh()}),400)},fontFamily:w.passageEditorFontFamily,fontScale:w.passageEditorFontScale,label:k("dialogs.passageEdit.passageTextEditorLabel"),labelHidden:!0,onBeforeChange:function(e,t,n){r(e),b(!0),I(n),O(n)},onChange:r,options:Object(a.a)(Object(a.a)({},Object(_.a)(w)),{},{mode:S,lineWrapping:!0}),value:h})})]})},Q=n(132),ee=(n(433),function(e){var t=e.icon,n=e.label,r=e.onAdd,a=e.onClose,c=s.useState(!0),i=Object(o.a)(c,2),l=i[0],f=i[1],j=s.useState("speech"),b=Object(o.a)(j,2),v=b[0],y=b[1],w=s.useState(e.lines),S=Object(o.a)(w,2),k=S[0],I=S[1],F=s.useState(e.actions),E=Object(o.a)(F,2),P=E[0],T=E[1],A=s.useState(!1),L=Object(o.a)(A,2),M=L[0],R=L[1],W=Object(u.a)().t;k.length;return Object(C.jsx)("span",{className:"add-tag-button",children:Object(C.jsxs)(h.a,{disabled:!1,icon:null!==t&&void 0!==t?t:Object(C.jsx)(p.I,{}),label:null!==n&&void 0!==n?n:W("common.onstart"),onChangeOpen:function(e){R(!0)},open:M,children:[Object(C.jsxs)(m.b,{style:{width:440,padding:15},children:[Object(C.jsx)("div",{className:"help",children:"Make something happen immediately when this node is triggered. You could either have a voice in the caravan say something (choose type: speech), and/or you could control the caravan' sensors (choose type:action)"}),Object(C.jsxs)("div",{style:{padding:15,background:"#cfe4fc",borderRadius:5,marginTop:15},children:[Object(C.jsx)(x.a,{onChange:function(e){var t=e.target.value;y(t),f(!0)},options:[{disabled:!1,label:"action",value:"action"},{disabled:!1,label:"speech",value:"speech"}],value:v,children:W("components.onStartButton.selectType")}),"action"===v&&Object(C.jsx)(D,{actions:P,deleteAction:function(e,t){return function(e,t){var n=P.reduce((function(n,r,a){return e===a?0===t&&1===r.length?n:[].concat(Object(O.a)(n),[r.reduce((function(e,n,r){return r===t?e:[].concat(Object(O.a)(e),[n])}),[])]):[].concat(Object(O.a)(n),[r])}),[]);T(n)}(e,t)},addAction:function(e,t){!function(e,t){if(0===P.length)T([[t]]);else{var n=P.map((function(n,r){return r===e?[].concat(Object(O.a)(n),[t]):n}));T(n)}}(e,t)},editAction:function(e,t,n){return function(e,t,n){var r=P.reduce((function(r,a,o){return[].concat(Object(O.a)(r),e===o?[a.reduce((function(e,r,a){return[].concat(Object(O.a)(e),a===t?[n]:[r])}),[])]:[a])}),[]);T(r)}(e,t,n)},addParallelAction:function(){T([].concat(Object(O.a)(P),[[{action:""}]]))}}),"speech"===v&&Object(C.jsx)(N,{lines:k,onAdd:function(e){I(e)}})]}),l&&!1]}),Object(C.jsx)("div",{style:{display:"flex",justifyContent:"center"},children:Object(C.jsxs)(d.a,{children:[Object(C.jsx)(g.a,{disabled:!1,icon:Object(C.jsx)(p.I,{}),label:W("common.add"),onClick:function(){r(k,P),R(!1)},variant:"create"}),Object(C.jsx)(g.a,{icon:Object(C.jsx)(p.Y,{}),label:W("common.cancel"),onClick:function(){R(!1),a()}})]})})]})})}),te=n(37),ne=function(e){var t=e.passageId,n=e.storyId,i=Object(c.a)(e,["passageId","storyId"]),p=s.useState(),m=Object(o.a)(p,2),h=m[0],O=m[1],g=Object(z.useUndoableStoriesContext)(),v=g.dispatch,y=g.stories,x=Object(W.useStoryFormatsContext)().formats,w=Object(U.passageWithId)(y,n,t),S=Object(U.storyWithId)(y,n),k=Object(W.formatWithNameAndVersion)(x,S.storyFormat,S.storyFormatVersion),I=Object(u.a)().t,N=s.useCallback((function(e){v(Object(U.updatePassage)(S,w,{text:e}))}),[v,w,S]),F=s.useCallback((function(e,t){var n=Object(te.b)(w.text),r=Object(te.c)(Object(a.a)(Object(a.a)({},n),{},{onstart:Object(a.a)(Object(a.a)({},n.onstart),{},{speech:e,actions:t})}));v(Object(U.updatePassage)(S,w,{text:r}))}),[v,w,S]);var E=S.startPassage===w.id,P=Object(te.b)(w.text);return Object(C.jsxs)(f.a,Object(a.a)(Object(a.a)({},i),{},{className:"passage-edit-dialog",headerLabel:w.name,children:[Object(C.jsxs)(d.a,{children:[Object(C.jsx)(l.a,{editor:h,watch:w.text}),Object(C.jsx)(ee,{lines:(Object(te.b)(w.text||"").onstart||{}).speech||[],actions:(Object(te.b)(w.text||"").onstart||{}).actions||[],onAdd:F,onClose:function(){console.log("closed!")},label:"on start"}),Object(C.jsx)(R,{rules:Object(te.b)(w.text).rules,type:P.type,label:"rules",onAdd:function(e){var t=Object(a.a)({},Object(te.b)(w.text)),n=Object(a.a)(Object(a.a)({},t),{},{rules:e}),r=Object(te.c)(n);v(Object(U.updatePassage)(S,w,{text:r}))},onSelect:function(e){var t=Object(a.a)(Object(a.a)({},P),{},{type:e}),n=Object(te.c)(t);console.log(n),v(Object(U.updatePassage)(S,w,{text:n}))}}),Object(C.jsx)(Q.a,{onRename:function(e){v(Object(U.updatePassage)(S,w,{name:e},{dontCreateNewlyLinkedPassages:!0}))},passage:w,story:S}),Object(C.jsx)(j.a,{disabled:E,label:I("dialogs.passageEdit.setAsStart"),onChange:function(){v(Object(U.updateStory)(y,S,{startPassage:t}))},value:E})]}),w.tags.length>0&&Object(C.jsx)("div",{className:"tags",children:Object(C.jsx)(d.a,{children:w.tags.map((function(e){return Object(C.jsx)(b.b,{color:S.tagColors[e],name:e,onChangeColor:function(t){return function(e,t){v(Object(U.updateStory)(y,S,{tagColors:Object(a.a)(Object(a.a)({},S.tagColors),{},Object(r.a)({},e,t))}))}(e,t)},onRemove:function(){return t=e,void v(Object(U.removePassageTag)(S,w,t),I("undoChange.removeTag"));var t}},e)}))})}),Object(C.jsx)(K,{onChange:N,onEditorChange:O,passage:w,storyFormat:k})]}))},re=function(e){var t=Object(z.useUndoableStoriesContext)().stories;try{Object(U.passageWithId)(t,e.storyId,e.passageId)}catch(n){return console.log("ERROR",n),e.onClose(),null}return Object(C.jsx)(ne,Object(a.a)({},e))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return w}));var r=n(2),a=n(6),o=n(0),c=n(43),s=n(14),i=n(24),u=n(5),l=n(20),d=n(21),f=n.n(d),j=(n(435),n(1)),b=function(e){var t=e.children,n=e.onChange,a=e.onError,o=e.orientation,c=Object(l.a)(e,["children","onChange","onError","orientation"]),s=f()("file-input","orientation-".concat(null!==o&&void 0!==o?o:"horizontal"));return Object(j.jsx)("span",{className:s,children:Object(j.jsxs)("label",{children:[Object(j.jsx)("span",{className:"file-input-label",children:t}),Object(j.jsx)("span",{className:"file-input-control",children:Object(j.jsx)("input",Object(r.a)(Object(r.a)({},c),{},{onChange:function(e){if(!e.target.files)throw new Error("Change event occurred but no files present");var t=e.target.files[0],r=new FileReader;r.addEventListener("loadend",(function(e){r.error?(console.warn(r.error),a&&a(r.error)):n(t,r.result)})),r.readAsText(t)},type:"file"}))})]})})},p=n(122),m=function(e){var t=e.onChange,n=Object(c.a)().t;return Object(j.jsx)("div",{className:"file-chooser",children:Object(j.jsx)("p",{children:Object(j.jsx)(b,{accept:".html",onChange:function(e,n){t(e,Object(p.a)(n))},orientation:"vertical",children:n("dialogs.storyImport.filePrompt")})})})},h=n(4),O=n(3),g=n(30),v=n(7),y=n(33),x=(n(436),function(e){var t=e.existingStories,n=e.onImport,r=e.stories,s=o.useState([]),i=Object(a.a)(s,2),u=i[0],l=i[1],d=Object(c.a)().t;function f(e){return t.some((function(t){return Object(y.storyFileName)(t)===Object(y.storyFileName)(e)}))}return Object(j.jsxs)("div",{className:"story-chooser",children:[Object(j.jsx)("p",{children:d("dialogs.storyImport.storiesPrompt")}),Object(j.jsx)("ul",{children:r.map((function(e){return Object(j.jsxs)("li",{children:[Object(j.jsx)(g.a,{label:e.name,onChange:function(t){return function(e,t){l(t?function(t){return[].concat(Object(h.a)(t),[e])}:function(t){return t.filter((function(t){return t.id!==e.id}))})}(e,t)},value:u.includes(e)},e.id),u.includes(e)&&f(e)&&Object(j.jsx)("span",{className:"replace-warning",children:d("dialogs.storyImport.willReplaceExisting")})]})}))}),Object(j.jsx)(v.a,{disabled:0===u.length,icon:Object(j.jsx)(O.x,{}),label:d("dialogs.storyImport.importSelected"),onClick:function(){return n(u)}})]})}),w=(n(437),function(e){var t=e.onClose,n=Object(c.a)().t,l=Object(u.useStoriesContext)(),d=l.dispatch,f=l.stories,b=o.useState(),p=Object(a.a)(b,2),h=p[0],O=p[1],g=o.useState([]),v=Object(a.a)(g,2),y=v[0],w=v[1];return Object(j.jsx)(i.a,Object(r.a)(Object(r.a)({},e),{},{className:"story-import-dialog",fixedSize:!0,headerLabel:n("dialogs.storyImport.title"),children:Object(j.jsxs)(s.b,{children:[Object(j.jsx)(m,{onChange:function(e,t){O(e),w(t)}}),h&&y.length>0&&Object(j.jsx)(x,{existingStories:f,onImport:function(e){d(Object(u.importStories)(e,f)),t()},stories:y}),h&&0===y.length&&Object(j.jsx)("p",{children:n("dialogs.storyImport.noStoriesInFile")})]})}))})},function(e,t,n){"use strict";n.d(t,"b",(function(){return p})),n.d(t,"a",(function(){return m}));var r=n(6),a=n(0),o=n(43),c=n(2),s=n(4),i=n(13),u=n(5);function l(e,t){switch(e.type){case"createPassage":if(e.props.id)return{type:"deletePassage",passageId:e.props.id,storyId:e.storyId};if(e.props.name){return function(t,n){t({type:"deletePassage",passageId:Object(u.passageWithName)(n(),e.storyId,e.props.name).id,storyId:e.storyId})}}throw new Error("Can't reverse a createPassage action without either name or ID");case"createPassages":if(e.props.some((function(e){return!e.id&&!e.name})))throw new Error("Can't reverse a createPassages action where a prop set doesn't have either name or ID");return function(t,n){e.props.forEach((function(r){r.id?t({type:"deletePassage",passageId:r.id,storyId:e.storyId}):r.name&&t({type:"deletePassage",passageId:Object(u.passageWithName)(n(),e.storyId,r.name).id,storyId:e.storyId})}))};case"deletePassage":return{type:"createPassage",props:Object(u.passageWithId)(t,e.storyId,e.passageId),storyId:e.storyId};case"deletePassages":return{type:"createPassages",props:e.passageIds.map((function(n){return Object(u.passageWithId)(t,e.storyId,n)})),storyId:e.storyId};case"updatePassage":var n=Object(u.passageWithId)(t,e.storyId,e.passageId);return{type:"updatePassage",props:Object.keys(e.props).reduce((function(e,t){return Object(c.a)(Object(c.a)({},e),{},Object(i.a)({},t,n[t]))}),{}),passageId:e.passageId,storyId:e.storyId};case"updatePassages":return{type:"updatePassages",passageUpdates:Object.keys(e.passageUpdates).reduce((function(n,r){var a=Object(u.passageWithId)(t,e.storyId,r);return Object(c.a)(Object(c.a)({},n),{},Object(i.a)({},r,Object.keys(e.passageUpdates[r]).reduce((function(e,t){return Object(c.a)(Object(c.a)({},e),{},Object(i.a)({},t,a[t]))}),{})))}),{}),storyId:e.storyId};case"updateStory":var r=Object(u.storyWithId)(t,e.storyId);return{type:"updateStory",props:Object.keys(e.props).reduce((function(e,t){return Object(c.a)(Object(c.a)({},e),{},Object(i.a)({},t,r[t]))}),{}),storyId:e.storyId}}throw new Error("Don't know how to reverse action type \"".concat(e.type,'"'))}function d(e,t){var n=[];return e((function(e){"function"===typeof e?n.push(d(e,t)):n.push(l(e,t))}),(function(){return t})),function(e){return n.forEach(e)}}var f=function(e,t){switch(t.type){case"addChange":var n={description:t.description,redo:t.action,undo:"function"===typeof t.action?d(t.action,t.storiesState):l(t.action,t.storiesState)},r=[].concat(Object(s.a)(e.changes.slice(0,e.currentChange+1)),[n]);return{changes:r,currentChange:r.length-1};case"updateCurrent":return Object(c.a)(Object(c.a)({},e),{},{currentChange:Math.min(Math.max(e.currentChange+t.change,-1),e.changes.length-1)})}},j=n(1),b=a.createContext({dispatch:function(){},stories:[]});b.displayName="UndoableStories";var p=function(){return a.useContext(b)},m=function(e){var t=Object(u.useStoriesContext)(),n=t.dispatch,c=t.stories,s=a.useReducer(f,{changes:[],currentChange:-1}),i=Object(r.a)(s,2),l=i[0],d=i[1],p=a.useCallback((function(e,t){return t&&d({type:"addChange",action:e,description:t,storiesState:c}),n(e)}),[c,n]),m=Object(o.a)().t,h=void 0,O=void 0,g=void 0,v=void 0;return l.changes.length>0&&(l.currentChange>=0&&(g=function(){n(l.changes[l.currentChange].undo),d({type:"updateCurrent",change:-1})},v=m("common.undoChange",{change:m(l.changes[l.currentChange].description)})),l.currentChange<l.changes.length-1&&(h=function(){n(l.changes[l.currentChange+1].redo),d({type:"updateCurrent",change:1})},O=m("common.redoChange",{change:m(l.changes[l.currentChange+1].description)}))),Object(j.jsx)(b.Provider,{value:{dispatch:p,redo:h,redoLabel:O,stories:c,undo:g,undoLabel:v},children:e.children})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return O}));var r=n(2),a=n(20),o=(n(0),n(43)),c=n(30),s=n(11),i=n(14),u=n(24),l=n(12),d=n(25),f=n(1),j=function(e){var t=e.formats,n=e.selectedFormat,c=Object(a.a)(e,["formats","selectedFormat"]),s=Object(o.a)().t,i=t.filter((function(e){return"loading"===e.loadState})),u=Object(l.sortFormats)(t.filter((function(e){return"loaded"===e.loadState||e.id===n.id}))).map((function(e){return{disabled:!1,label:"".concat(e.name," ").concat(e.version),value:e.id}}));return 0!==i.length&&u.push({disabled:!0,label:s("components.storyFormatSelect.loadingCount",{loadingCount:i.length}),value:""}),Object(f.jsx)(d.a,Object(r.a)(Object(r.a)({},c),{},{options:u,value:n.id}))},b=n(5),p=n(136),m=(n(440),new Intl.DateTimeFormat([],{dateStyle:"full",timeStyle:"long"})),h=function(e){var t=e.story,n=Object(b.storyStats)(t),r=Object(o.a)().t;return Object(f.jsxs)("div",{className:"story-stats",children:[Object(f.jsx)("table",{className:"counts",children:Object(f.jsxs)("tbody",{children:[Object(f.jsxs)("tr",{children:[Object(f.jsx)("td",{children:n.characters}),Object(f.jsx)("td",{children:r("dialogs.storyDetails.stats.characters")})]}),Object(f.jsxs)("tr",{children:[Object(f.jsx)("td",{children:n.words}),Object(f.jsx)("td",{children:r("dialogs.storyDetails.stats.words")})]}),Object(f.jsxs)("tr",{children:[Object(f.jsx)("td",{children:n.passages}),Object(f.jsx)("td",{children:r("dialogs.storyDetails.stats.passages")})]}),Object(f.jsxs)("tr",{children:[Object(f.jsx)("td",{children:n.links.length}),Object(f.jsx)("td",{children:r("dialogs.storyDetails.stats.links")})]}),Object(f.jsxs)("tr",{children:[Object(f.jsx)("td",{children:n.brokenLinks.length}),Object(f.jsx)("td",{children:r("dialogs.storyDetails.stats.brokenLinks")})]})]})}),Object(f.jsxs)("div",{className:"update-and-ifid",children:[Object(f.jsx)("p",{children:r("dialogs.storyDetails.stats.lastUpdate",{date:m.format(t.lastUpdate)})}),Object(f.jsxs)("p",{children:[r("dialogs.storyDetails.stats.ifid",{ifid:t.ifid}),"\xa0",Object(f.jsx)("a",{href:"https://ifdb.org/help-ifid",target:"_blank",rel:"noreferrer",children:r("dialogs.storyDetails.stats.ifidExplanation")})]})]})]})},O=function(e){var t=e.storyId,n=Object(a.a)(e,["storyId"]),d=Object(b.useStoriesContext)(),m=d.dispatch,O=d.stories,g=Object(l.useStoryFormatsContext)().formats,v=Object(b.storyWithId)(O,t),y=Object(o.a)().t;return Object(f.jsxs)(u.a,Object(r.a)(Object(r.a)({},n),{},{className:"story-details-dialog",fixedSize:!0,headerLabel:v.name,children:[Object(f.jsxs)("div",{className:"story-format",children:[Object(f.jsx)(p.a,{block:!1}),Object(f.jsx)(j,{formats:g,onChange:function(e){var t=Object(l.formatWithId)(g,e.target.value);m(Object(b.updateStory)(O,v,{storyFormat:t.name,storyFormatVersion:t.version}))},selectedFormat:Object(l.formatWithNameAndVersion)(g,v.storyFormat,v.storyFormatVersion),children:y("common.storyFormat")}),Object(f.jsx)("a",{href:"https://twinery.org/2storyformats",target:"_blank",rel:"noreferrer",children:y("dialogs.storyDetails.storyFormatExplanation")})]}),Object(f.jsx)(s.a,{children:Object(f.jsx)(c.a,{label:y("dialogs.storyDetails.snapToGrid"),onChange:function(e){return m(Object(b.updateStory)(O,v,{snapToGrid:e}))},value:v.snapToGrid})}),Object(f.jsx)(i.b,{children:!n.collapsed&&Object(f.jsx)(h,{story:v})})]}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var r=n(2),a=n(0),o=n(43),c=n(14),s=n(24),i=n(30),u=n(4),l=n(6),d=n(22),f=n(25),j=(n(373),n(1)),b=["var(--font-monospaced)","var(--font-system)"],p=[.8,.9,1,1.25,1.5,2],m=function(e){var t=e.familyLabel,n=e.fontFamily,r=e.fontScale,c=e.onChangeFamily,s=e.onChangeScale,i=e.scaleLabel,m=a.useState(!p.includes(r)),h=Object(l.a)(m,2),O=h[0],g=h[1],v=a.useState(!b.includes(n)),y=Object(l.a)(v,2),x=y[0],w=y[1],S=a.useState(n),C=Object(l.a)(S,2),k=C[0],I=C[1],N=a.useState((100*r).toString()),F=Object(l.a)(N,2),E=F[0],P=F[1],T=Object(o.a)().t;return Object(j.jsxs)("div",{className:"font-select",children:[Object(j.jsx)(f.a,{onChange:function(e){"custom"===e.target.value?w(!0):(w(!1),c(e.target.value))},options:[{label:T("components.fontSelect.fonts.system"),value:"var(--font-system)"},{label:T("components.fontSelect.fonts.monospaced"),value:"var(--font-monospaced)"},{label:T("common.custom"),value:"custom"}],value:x?"custom":n,children:t}),x&&Object(j.jsx)(d.a,{onChange:function(e){I(e.target.value),""!==e.target.value.trim()&&c(e.target.value)},orientation:"vertical",value:k,children:T("components.fontSelect.customFamilyDetail")}),Object(j.jsx)(f.a,{onChange:function(e){"custom"===e.target.value?g(!0):(g(!1),s(parseFloat(e.target.value)))},options:[].concat(Object(u.a)(p.map((function(e){return{label:T("components.fontSelect.percentage",{percent:100*e}),value:e.toString()}}))),[{label:T("common.custom"),value:"custom"}]),value:O?"custom":r.toString(),children:i}),O&&Object(j.jsx)(d.a,{onChange:function(e){P(e.target.value);var t=parseInt(e.target.value);Number.isFinite(t)&&s(t/100)},orientation:"vertical",value:E,children:T("components.fontSelect.customScaleDetail")})]})},h=n(9),O=[{code:"ca",name:"Catal\xe0"},{code:"cs",name:"\u010ce\u0161tina"},{code:"da",name:"Dansk"},{code:"de",name:"Deutsch"},{code:"en",name:"English"},{code:"es",name:"Castellano"},{code:"fi",name:"Suomi"},{code:"fr",name:"Fran\xe7ais"},{code:"it",name:"Italiano"},{code:"ms",name:"Bahasa Melayu"},{code:"nb",name:"Norsk bokm\xe5l"},{code:"nl",name:"Nederlands"},{code:"pt-br",name:"Portugu\xeas Brasileiro"},{code:"pt-pt",name:"Portugu\xeas"},{code:"ru",name:"\u0440\u0443\u0441\u0441\u043a\u0438\u0439"},{code:"sv",name:"Svenska"},{code:"tr",name:"T\xfcrk\xe7e"},{code:"zh-cn",name:"\u4e2d\u6587(\u7b80\u4f53)"}],g=(n(374),function(e){var t=Object(h.usePrefsContext)(),n=t.dispatch,a=t.prefs,u=Object(o.a)().t;return Object(j.jsx)(s.a,Object(r.a)(Object(r.a)({},e),{},{className:"app-prefs-dialog",fixedSize:!0,headerLabel:u("dialogs.appPrefs.title"),children:Object(j.jsxs)(c.b,{children:[Object(j.jsx)(f.a,{onChange:function(e){return n(Object(h.setPref)("locale",e.target.value))},options:O.map((function(e){return{label:e.name,value:e.code}})),value:a.locale,children:u("dialogs.appPrefs.language")}),Object(j.jsx)(f.a,{onChange:function(e){return n(Object(h.setPref)("appTheme",e.target.value))},options:[{label:u("dialogs.appPrefs.themeSystem"),value:"system"},{label:u("dialogs.appPrefs.themeLight"),value:"light"},{label:u("dialogs.appPrefs.themeDark"),value:"dark"}],value:a.appTheme,children:u("dialogs.appPrefs.theme")}),Object(j.jsx)(i.a,{label:u("dialogs.appPrefs.editorCursorBlinks"),onChange:function(e){return n(Object(h.setPref)("editorCursorBlinks",e))},value:a.editorCursorBlinks}),Object(j.jsx)("p",{className:"font-explanation",children:u("dialogs.appPrefs.fontExplanation")}),Object(j.jsx)(m,{familyLabel:u("dialogs.appPrefs.passageEditorFont"),fontFamily:a.passageEditorFontFamily,fontScale:a.passageEditorFontScale,onChangeFamily:function(e){return n(Object(h.setPref)("passageEditorFontFamily",e))},onChangeScale:function(e){return n(Object(h.setPref)("passageEditorFontScale",e))},scaleLabel:u("dialogs.appPrefs.passageEditorFontScale")}),Object(j.jsx)(m,{familyLabel:u("dialogs.appPrefs.codeEditorFont"),fontFamily:a.codeEditorFontFamily,fontScale:a.codeEditorFontScale,onChangeFamily:function(e){return n(Object(h.setPref)("codeEditorFontFamily",e))},onChangeScale:function(e){return n(Object(h.setPref)("codeEditorFontScale",e))},scaleLabel:u("dialogs.appPrefs.codeEditorFontScale")})]})}))})},function(e,t,n){"use strict";n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return j}));var r=n(6),a=n(0),o=n(61),c=n(73),s=n(54),i=n(13),u=n(2),l=n(1),d=a.createContext({dispatch:function(){},prefs:Object(s.a)()});d.displayName="Prefs";var f=function(){return a.useContext(d)},j=function(e){var t=Object(o.a)().prefs,n=Object(c.a)().reportError,f=a.useCallback((function(e,a){var o=function(e,t){switch(t.type){case"init":return Object(u.a)(Object(u.a)({},e),t.state);case"repair":var n=Object.entries(Object(s.a)()).reduce((function(t,n){var a=Object(r.a)(n,2),o=a[0],c=a[1],s=o;return"number"===typeof c&&!Number.isFinite(e[s])||typeof c!==typeof e[s]?(console.info('Repairing preference "'.concat(o,'" by setting it to ').concat(c,", ")+"was ".concat(e[s]," (bad type)")),Object(u.a)(Object(u.a)({},t),{},Object(i.a)({},s,c))):t}),{});return Object(u.a)(Object(u.a)({},e),n);case"update":return Object(u.a)(Object(u.a)({},e),{},Object(i.a)({},t.name,t.value))}}(e,a);try{t.saveMiddleware(o,a)}catch(c){n(c,"store.errors.cantPersistPrefs")}return o}),[t,n]),j=a.useReducer(f,Object(s.a)()),b=Object(r.a)(j,2),p=b[0],m=b[1];return Object(l.jsx)(d.Provider,{value:{dispatch:m,prefs:p},children:e.children})}},function(e,t,n){"use strict";n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return O}));var r=n(6),a=n(2),o=n(19),c=n.n(o),s=n(0),i=n(72),u=n.n(i),l=n(61),d=n(70),f=n(73),j=n(4),b=n(1),p=Object(d.a)().map((function(e){return Object(a.a)(Object(a.a)({},e),{},{id:c()(),loadState:"unloaded",selected:!1,userAdded:!1})})),m=s.createContext({dispatch:function(){},formats:[]});m.displayName="StoryFormats";var h=function(){return s.useContext(m)},O=function(e){var t=Object(l.a)().storyFormats,n=Object(f.a)().reportError,o=s.useCallback((function(e,r){var o=function(e,t){switch(t.type){case"init":return Object(j.a)(t.state);case"repair":var n=Object(d.a)(),r=e.filter((function(e){var t=e.userAdded||n.some((function(t){return t.name===e.name&&t.version===e.version}));return t||console.info("Repairing story formats by removing ".concat(e.name," ").concat(e.version," ")+"(outdated version of built-in format)"),t}));return n.forEach((function(e){r.some((function(t){return t.name===e.name&&t.version===e.version}))||(console.info("Repairing story formats by adding built-in ".concat(e.name," ").concat(e.version)),r.push(Object(a.a)(Object(a.a)({},e),{},{id:c()(),loadState:"unloaded",selected:!1,userAdded:!1})))})),r;case"create":return e.some((function(e){return e.name===t.props.name&&e.version===t.props.version}))?e:[].concat(Object(j.a)(e),[Object(a.a)(Object(a.a)({},t.props),{},{id:c()(),loadState:"unloaded"})]);case"delete":return e.filter((function(e){return e.id!==t.id}));case"update":return e.some((function(e){return e.id!==t.id&&e.name===t.props.name&&e.version===t.props.version}))?e:e.map((function(e){return e.id!==t.id?e:Object(a.a)(Object(a.a)({},e),t.props)}))}return e}(e,r);try{t.saveMiddleware(o,r)}catch(s){n(s,"store.errors.cantPersistStoryFormats")}return o}),[n,t]),i=u()(o,p),h=Object(r.a)(i,2),O=h[0],g=h[1];return Object(b.jsx)(m.Provider,{value:{dispatch:g,formats:O},children:e.children})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var r=n(2),a=(n(0),n(43)),o=n(3),c=n(11),s=n(24),i=n(62),u=n(42),l=n(165),d=(n(370),n(1)),f=function(e){var t=Object(a.a)().t,n=Object(u.a)();return Object(d.jsx)(s.a,Object(r.a)(Object(r.a)({},e),{},{className:"about-twine-dialog",fixedSize:!0,headerLabel:t("dialogs.aboutTwine.title",{version:n.version}),children:Object(d.jsxs)("div",{className:"content",children:[Object(d.jsx)("p",{children:t("dialogs.aboutTwine.twineDescription")}),Object(d.jsx)("p",{dangerouslySetInnerHTML:{__html:t("dialogs.aboutTwine.license")}}),Object(d.jsxs)("div",{className:"credits",children:[Object(d.jsxs)("div",{className:"code",children:[Object(d.jsx)("h3",{children:t("dialogs.aboutTwine.codeHeader")}),Object(d.jsx)("ul",{children:l.code.map((function(e){return Object(d.jsx)("li",{children:e},e)}))})]}),Object(d.jsxs)("div",{className:"localizations",children:[Object(d.jsx)("h3",{children:t("dialogs.aboutTwine.localizationHeader")}),Object(d.jsx)("ul",{children:l.localizations.map((function(e){return Object(d.jsx)("li",{children:e},e)}))})]})]}),Object(d.jsxs)(c.a,{children:[Object(d.jsx)(i.a,{href:"https://twinery.org/donate",icon:Object(d.jsx)(o.A,{}),label:t("dialogs.aboutTwine.donateToTwine"),variant:"primary"}),Object(d.jsx)(i.a,{href:"https://github.com/klembot/twinejs",icon:Object(d.jsx)(o.r,{}),label:t("dialogs.aboutTwine.codeRepo")})]})]})}))}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){},function(e,t,n){},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){},,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,,,,,,,,,,,,function(e,t){},,,function(e,t){},,,,,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,function(e,t,n){},function(e,t,n){},function(e,t,n){"use strict";n.r(t);var r=n(0),a=n(58),o=n(228),c=n(229),s=n(249),i=n(248),u=n(1),l=function(e){Object(s.a)(n,e);var t=Object(i.a)(n);function n(e){var r;return Object(o.a)(this,n),(r=t.call(this,e)).state={error:null},r}return Object(c.a)(n,[{key:"render",value:function(){return this.state.error?Object(u.jsxs)("p",{children:["An error occurred: ",this.state.error.message]}):this.props.children}}],[{key:"getDerivedStateFromError",value:function(e){return console.error(e),{error:e}}}]),n}(r.Component),d=n(40),f=(n(261),function(){return Object(u.jsx)("div",{className:"loading-curtain",children:Object(u.jsx)(d.b,{})})}),j=n(9),b=n(55),p=function(){var e=Object(j.usePrefsContext)().prefs;return r.useEffect((function(){b.a.changeLanguage(e.locale)}),[e.locale]),null},m=n(44),h=n(28),O=n(52),g=n(43),v=(n(197),function(e){var t=e.children,n=e.ignoreSelector,r=e.onClickAway;return Object(u.jsx)("div",{onClick:function(e){var t;n?(null===(t=e.target)||void 0===t?void 0:t.closest(n))||r():r()},children:t})}),y=(n(357),function(e){var t,n={gridTemplateColumns:"columnWidth"in e?"repeat(auto-fit, ".concat("number"===typeof e.columnWidth?e.columnWidth+"px":e.columnWidth,")"):"repeat(".concat(e.columns,", 1fr)"),maxWidth:null!==(t=e.maxWidth)&&void 0!==t?t:"auto"};return Object(u.jsx)("div",{className:"card-group",style:n,children:e.children})}),x=n(21),w=n.n(x),S=n(74),C=(n(360),r.forwardRef((function(e,t){var n,r=e.children,a=e.title,o=w()("main-content",{padded:null===(n=e.padded)||void 0===n||n});return Object(u.jsxs)("div",{className:o,ref:t,children:[a&&Object(u.jsxs)(u.Fragment,{children:[Object(u.jsx)(S.a,{children:Object(u.jsx)("title",{children:a})}),Object(u.jsx)("h1",{children:a})]}),r]})}))),k=n(3),I=n(12),N=(n(361),function(e){var t=e.label;return Object(u.jsx)("span",{className:"badge",children:t})}),F=n(14),E=function(e){var t=e.format,n=Object(g.a)().t;return"unloaded"===t.loadState||"loading"===t.loadState?Object(u.jsx)("div",{className:"story-format-card-details",children:Object(u.jsx)("p",{children:n("components.storyFormatCard.loadingFormat")})}):"error"===t.loadState?Object(u.jsx)("div",{className:"story-format-card-details",children:Object(u.jsx)("p",{children:n("components.storyFormatCard.loadError",{errorMessage:t.loadError.message})})}):Object(u.jsxs)("div",{className:"story-format-card-details",children:[t.properties.author&&Object(u.jsx)("p",{className:"story-format-card-author",dangerouslySetInnerHTML:{__html:n("components.storyFormatCard.author",{author:t.properties.author})}}),t.properties.description&&Object(u.jsx)("div",{className:"story-format-card-description",dangerouslySetInnerHTML:{__html:t.properties.description}}),t.properties.license&&Object(u.jsx)("p",{className:"story-format-card-license",children:n("components.storyFormatCard.license",{license:t.properties.license})})]})},P=(n(365),function(e){var t=e.defaultFormat,n=e.editorExtensionsDisabled,r=e.format,a=e.onSelect,o=Object(g.a)().t,c=Object(u.jsx)(u.Fragment,{});return"error"===r.loadState?c=Object(u.jsx)(k.b,{}):"unloaded"===r.loadState||"loading"===r.loadState?c=Object(u.jsx)(d.b,{}):"loaded"===r.loadState&&r.properties.image&&(c=Object(u.jsx)("img",{src:Object(I.formatImageUrl)(r),alt:""})),Object(u.jsx)("div",{className:"story-format-card",onClick:a,children:Object(u.jsx)(F.a,{selected:r.selected,children:Object(u.jsxs)(F.b,{children:[Object(u.jsx)("div",{className:"story-format-image",children:c}),Object(u.jsxs)("div",{className:"story-format-description",children:[Object(u.jsx)("h2",{children:o("components.storyFormatCard.name",{name:r.name,version:r.version})}),Object(u.jsx)(E,{format:r})]}),Object(u.jsxs)("div",{className:"story-format-badges",children:[!r.userAdded&&Object(u.jsx)(N,{label:o("components.storyFormatCard.builtIn")}),t&&Object(u.jsx)(N,{label:o("components.storyFormatCard.defaultFormat")}),n&&Object(u.jsx)(N,{label:o("components.storyFormatCard.editorExtensionsDisabled")}),"loaded"===r.loadState&&r.properties.proofing&&Object(u.jsx)(N,{label:o("components.storyFormatCard.proofing")})]})]})})})}),T=n(16),D=n(136),A=n(13),L=n(6),M=n(93),R=n(7),W=function(){var e=Object(h.f)(),t=Object(g.a)().t;return["/","/stories"].includes(e.location.pathname)?null:Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.g,{}),variant:"primary",label:e.length>1?t("common.back"):t("routes.storyList.titleGeneric"),onClick:function(){return e.length>1?e.goBack():e.push("/")}})},U=(n(445),function(e){var t=e.helpUrl,n=void 0===t?"https://twinery.org/2guide":t,r=e.pinnedControls,a=e.tabs,o=Object(g.a)().t;return Object(u.jsx)("div",{className:"route-toolbar",children:Object(u.jsxs)(M.d,{selectedTabClassName:"selected",children:[Object(u.jsxs)("div",{className:"route-toolbar-top",children:[Object(u.jsx)(W,{}),Object(u.jsx)(M.b,{className:"route-toolbar-tablist",children:Object.keys(a).map((function(e){return Object(u.jsx)(M.a,{className:"route-toolbar-tab",children:e},e)}))}),Object(u.jsxs)("div",{className:"route-toolbar-pinned-controls",children:[r,Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.B,{}),label:o("common.help"),onClick:function(){return window.open(n,"_blank")}})]})]}),Object(u.jsx)("div",{children:Object.entries(a).map((function(e){var t=Object(L.a)(e,2),n=t[0],r=t[1];return Object(u.jsx)(M.c,{children:r},n)}))})]})})}),z=n(10),B=n.n(z),J=n(17),V=n(11),q=n(33),G=n(46),Y=n(5),H=n(42);function _(){var e=Object(j.usePrefsContext)().prefs,t=Object(I.useStoryFormatsContext)(),n=t.dispatch,a=t.formats,o=Object(Y.useStoriesContext)().stories;return{publishArchive:r.useCallback(Object(J.a)(B.a.mark((function e(){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(G.b)(o,Object(H.a)()));case 1:case"end":return e.stop()}}),e)}))),[o]),proofStory:r.useCallback(function(){var t=Object(J.a)(B.a.mark((function t(r){var c,s,i;return B.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return c=Object(Y.storyWithId)(o,r),s=Object(I.formatWithNameAndVersion)(a,e.proofingFormat.name,e.proofingFormat.version),t.next=4,Object(I.loadFormatProperties)(s)(n);case 4:if(i=t.sent){t.next=7;break}throw new Error("Couldn't load story format properties");case 7:return t.abrupt("return",Object(G.d)(c,i.source,Object(H.a)()));case 8:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),[a,e.proofingFormat.name,e.proofingFormat.version,o,n]),publishStory:r.useCallback(function(){var e=Object(J.a)(B.a.mark((function e(t,r){var c,s,i;return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=Object(Y.storyWithId)(o,t),s=Object(I.formatWithNameAndVersion)(a,c.storyFormat,c.storyFormatVersion),e.next=4,Object(I.loadFormatProperties)(s)(n);case 4:if(i=e.sent){e.next=7;break}throw new Error("Couldn't load story format properties");case 7:return e.abrupt("return",Object(G.d)(c,i.source,Object(H.a)(),r));case 8:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),[a,o,n]),publishStoryData:r.useCallback((function(e){var t=Object(Y.storyWithId)(o,e);return Object(G.c)(t,Object(H.a)(),{startOptional:!0})}),[o])}}var X=n(38);function $(){var e=_(),t=e.proofStory,n=e.publishStory;if(Object(X.a)()){var r=window.twineElectron;if(!r)throw new Error("Electron bridge is not present on window.");return{playStory:function(){var e=Object(J.a)(B.a.mark((function e(t){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=r.ipcRenderer,e.next=3,n(t);case 3:e.t1=e.sent,e.t0.send.call(e.t0,"open-with-temp-file",e.t1,".html");case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),proofStory:function(){var e=Object(J.a)(B.a.mark((function e(n){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=r.ipcRenderer,e.next=3,t(n);case 3:e.t1=e.sent,e.t0.send.call(e.t0,"open-with-temp-file",e.t1,".html");case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),testStory:function(){var e=Object(J.a)(B.a.mark((function e(t,a){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=r.ipcRenderer,e.next=3,n(t,{formatOptions:"debug",startId:a});case 3:e.t1=e.sent,e.t0.send.call(e.t0,"open-with-temp-file",e.t1,".html");case 5:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()}}return{playStory:function(){var e=Object(J.a)(B.a.mark((function e(t){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:window.open("#/stories/".concat(t,"/play"),"_blank");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),proofStory:function(){var e=Object(J.a)(B.a.mark((function e(t){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:window.open("#/stories/".concat(t,"/proof"),"_blank");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),testStory:function(){var e=Object(J.a)(B.a.mark((function e(t,n){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:window.open(n?"#/stories/".concat(t,"/test/").concat(n):"#/stories/".concat(t,"/test"),"_blank");case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()}}var Z=n(243);function K(e,t){var n=new Blob([e],{type:"text/html;charset=utf-8"});Object(Z.saveAs)(n,t)}var Q=n(37),ee=function(e){var t=e.story,n=_().publishStory,r=$(),a=(r.playStory,r.proofStory),o=(r.testStory,Object(g.a)().t);function c(){return(c=Object(J.a)(B.a.mark((function e(){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}throw new Error("No story provided to publish");case 2:return e.t0=K,e.next=5,n(t.id);case 5:e.t1=e.sent,e.t2=Object(q.storyFileName)(t),(0,e.t0)(e.t1,e.t2);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}return Object(u.jsxs)(V.a,{children:[Object(u.jsx)(R.a,{disabled:!t,icon:Object(u.jsx)(k.v,{}),label:o("routeActions.build.proof"),onClick:t?function(){return a(null===t||void 0===t?void 0:t.id)}:function(){}}),Object(u.jsx)(R.a,{disabled:!t,icon:Object(u.jsx)(k.y,{}),label:o("routeActions.build.publishToFile"),onClick:function(){return c.apply(this,arguments)}}),Object(u.jsx)(R.a,{disabled:!t,icon:Object(u.jsx)(k.m,{}),label:"Download for Caravan",onClick:function(){return function(e){var t=Object(Q.a)(e),n=(e||{}).name,r=void 0===n?"caravan":n,a="data:text/json;chatset=utf-8,".concat(encodeURIComponent(JSON.stringify(t,null,4))),o=document.createElement("a");o.href=a,o.download="".concat(r,".json"),o.click()}(t)}})]})},te=function(){var e=Object(T.useDialogsContext)().dispatch,t=Object(h.f)(),n=Object(g.a)().t;return Object(u.jsxs)(V.a,{children:[Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.N,{}),label:n("routeActions.app.preferences"),onClick:function(){return e({type:"addDialog",component:T.AppPrefsDialog})}}),Object(u.jsx)(R.a,{disabled:"/story-formats"===t.location.pathname,icon:Object(u.jsx)(k.w,{}),label:n("routeActions.app.storyFormats"),onClick:function(){return t.push("/story-formats")}}),Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.j,{}),label:n("routeActions.app.aboutApp"),onClick:function(){return e({type:"addDialog",component:T.AboutTwineDialog})}}),Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.l,{}),label:n("routeActions.app.reportBug"),onClick:function(){return window.open("https://twinery.org/2bugs","_blank")}})]})},ne=n(60),re=n(39);n(446);function ae(e){try{return new URL(e),!0}catch(t){}return!1}var oe=function(){var e=Object(I.useStoryFormatsContext)(),t=e.dispatch,n=e.formats,a=r.useState(""),o=Object(L.a)(a,2),c=o[0],s=o[1],i=Object(g.a)().t;function l(){return(l=Object(J.a)(B.a.mark((function e(){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.t1=I.createFromProperties,e.t2=c,e.next=5,Object(re.a)(c);case 5:e.t3=e.sent,e.t4=(0,e.t1)(e.t2,e.t3),(0,e.t0)(e.t4);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var d=function(){var e=Object(J.a)(B.a.mark((function e(t){var r;return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""!==c.trim()){e.next=2;break}return e.abrupt("return",{valid:!1});case 2:if(ae(c)){e.next=4;break}return e.abrupt("return",{message:i("routes.storyFormatList.toolbar.addStoryFormatButton.invalidUrl"),valid:!1});case 4:return e.prev=4,e.next=7,Object(re.a)(c);case 7:if(r=e.sent,!n.some((function(e){return e.name===r.name&&e.version===r.version}))){e.next=10;break}return e.abrupt("return",{message:i("routes.storyFormatList.toolbar.addStoryFormatButton.alreadyAdded",{storyFormatName:r.name,storyFormatVersion:r.version}),valid:!1});case 10:return e.abrupt("return",{message:i("routes.storyFormatList.toolbar.addStoryFormatButton.addPreview",{storyFormatName:r.name,storyFormatVersion:r.version}),valid:!0});case 13:return e.prev=13,e.t0=e.catch(4),e.abrupt("return",{message:i("routes.storyFormatList.toolbar.addStoryFormatButton.fetchError",{errorMessage:e.t0.message}),valid:!1});case 16:case"end":return e.stop()}}),e,null,[[4,13]])})));return function(t){return e.apply(this,arguments)}}();return Object(u.jsx)("span",{className:"add-format-button",children:Object(u.jsx)(ne.a,{icon:Object(u.jsx)(k.I,{}),label:i("common.add"),onChange:function(e){return s(e.target.value)},onSubmit:function(){return l.apply(this,arguments)},prompt:i("routes.storyFormatList.toolbar.addStoryFormatButton.prompt"),submitIcon:Object(u.jsx)(k.I,{}),submitLabel:i("common.add"),submitVariant:"create",validate:d,value:c})})},ce=function(e){var t=e.format,n=Object(j.usePrefsContext)(),r=n.dispatch,a=n.prefs,o=Object(g.a)().t,c="loaded"!==(null===t||void 0===t?void 0:t.loadState)||t.properties.proofing||a.storyFormat.name===t.name&&a.storyFormat.version===t.version;return Object(u.jsx)(R.a,{disabled:c,icon:Object(u.jsx)(k.Q,{}),label:o("routes.storyFormatList.toolbar.useAsDefaultFormat"),onClick:function(){if(!t)throw new Error("Can't set undefined format as default");r({type:"update",name:"storyFormat",value:{name:t.name,version:t.version}})}})},se=function(e){var t=e.format,n=Object(j.usePrefsContext)(),r=n.dispatch,a=n.prefs,o=Object(g.a)().t,c="loaded"!==(null===t||void 0===t?void 0:t.loadState)||!t.properties.proofing||a.proofingFormat.name===t.name&&a.proofingFormat.version===t.version;return Object(u.jsx)(R.a,{disabled:c,icon:Object(u.jsx)(k.v,{}),label:o("routes.storyFormatList.toolbar.useAsProofingFormat"),onClick:function(){if(!t)throw new Error("Can't set undefined format as proofing");r({type:"update",name:"proofingFormat",value:{name:t.name,version:t.version}})}})},ie=function(e){var t=e.format,n=Object(I.useStoryFormatsContext)().dispatch,r=Object(j.usePrefsContext)().prefs,a=Object(g.a)().t,o=(null===t||void 0===t?void 0:t.name)===r.storyFormat.name&&(null===t||void 0===t?void 0:t.version)===r.storyFormat.version,c=(null===t||void 0===t?void 0:t.name)===r.proofingFormat.name&&(null===t||void 0===t?void 0:t.version)===r.proofingFormat.version;return Object(u.jsx)(R.a,{disabled:!t||!t.userAdded||o||c,icon:Object(u.jsx)(k.U,{}),label:a("common.remove"),onClick:function(){return t&&n(Object(I.deleteFormat)(t))}})},ue=n(4),le=function(e){var t=e.format,n=Object(j.usePrefsContext)(),r=n.dispatch,a=n.prefs,o=Object(g.a)().t,c=a.disabledStoryFormatEditorExtensions.some((function(e){return e.name===(null===t||void 0===t?void 0:t.name)&&e.version===(null===t||void 0===t?void 0:t.version)}));return Object(u.jsx)(R.a,{disabled:!t,icon:Object(u.jsx)(k.J,{}),label:o("routes.storyFormatList.toolbar.".concat(c?"enable":"disable","FormatExtensions")),onClick:function(){if(!t)throw new Error("Format is not set");r(c?Object(j.setPref)("disabledStoryFormatEditorExtensions",a.disabledStoryFormatEditorExtensions.filter((function(e){return e.name!==t.name||e.version!==t.version}))):Object(j.setPref)("disabledStoryFormatEditorExtensions",[].concat(Object(ue.a)(a.disabledStoryFormatEditorExtensions),[{name:t.name,version:t.version}])))}})},de=function(e){var t=e.selectedFormats,n=1===t.length?t[0]:void 0;return Object(u.jsxs)(V.a,{children:[Object(u.jsx)(oe,{}),Object(u.jsx)(ie,{format:n}),Object(u.jsx)(le,{format:n}),Object(u.jsx)(ce,{format:n}),Object(u.jsx)(se,{format:n})]})},fe=n(30),je=function(){var e=Object(j.usePrefsContext)(),t=e.dispatch,n=e.prefs,r=Object(g.a)().t;function a(e){t(Object(j.setPref)("storyFormatListFilter",e))}return Object(u.jsxs)(u.Fragment,{children:[Object(u.jsx)(fe.a,{disabled:"current"===n.storyFormatListFilter,label:r("routes.storyFormatList.title.current"),onChange:function(){return a("current")},value:"current"===n.storyFormatListFilter}),Object(u.jsx)(fe.a,{disabled:"user"===n.storyFormatListFilter,label:r("routes.storyFormatList.title.user"),onChange:function(){return a("user")},value:"user"===n.storyFormatListFilter}),Object(u.jsx)(fe.a,{disabled:"all"===n.storyFormatListFilter,label:r("routes.storyFormatList.title.all"),onChange:function(){return a("all")},value:"all"===n.storyFormatListFilter})]})},be=function(e){var t,n=e.selectedFormats,r=Object(g.a)().t;return Object(u.jsx)(U,{tabs:(t={},Object(A.a)(t,r("common.storyFormat"),Object(u.jsx)(de,{selectedFormats:n})),Object(A.a)(t,r("common.view"),Object(u.jsx)(je,{})),Object(A.a)(t,r("common.appName"),Object(u.jsx)(te,{})),t)})},pe=function(){var e=Object(I.useStoryFormatsContext)(),t=e.dispatch,n=e.formats,a=Object(j.usePrefsContext)(),o=a.dispatch,c=a.prefs,s=Object(g.a)().t,i=n.filter((function(e){return e.selected})),l=Object(I.sortFormats)(Object(I.filteredFormats)(n,c.storyFormatListFilter));return r.useEffect((function(){var e,n=Object(O.a)(i);try{for(n.s();!(e=n.n()).done;){var r=e.value;r.selected&&!l.includes(r)&&t(Object(I.deselectFormat)(r))}}catch(a){n.e(a)}finally{n.f()}}),[o,i,l,t]),Object(u.jsx)("div",{className:"story-format-list-route",children:Object(u.jsxs)(T.DialogsContextProvider,{children:[Object(u.jsx)(be,{selectedFormats:i}),Object(u.jsx)(v,{ignoreSelector:".story-format-card",onClickAway:function(){return t(Object(I.deselectAllFormats)())},children:Object(u.jsxs)(C,{title:s("routes.storyFormatList.title.".concat(c.storyFormatListFilter)),children:[Object(u.jsx)("p",{children:s(l.length>0?"routes.storyFormatList.storyFormatExplanation":"routes.storyFormatList.noneVisible")}),Object(u.jsx)(D.a,{children:Object(u.jsx)(y,{columnWidth:"450px",children:l.map((function(e){return Object(u.jsx)(P,{defaultFormat:e.name===c.storyFormat.name&&e.version===c.storyFormat.version,editorExtensionsDisabled:c.disabledStoryFormatEditorExtensions.some((function(t){return e.name===t.name&&e.version===t.version})),format:e,onSelect:function(){return function(e){t(Object(I.selectFormat)(e,!0))}(e)}},e.id)}))})})]})})]})})},me=n(2),he=n(91),Oe=n(32);n(447);function ge(e,t){var n=t.getBoundingClientRect();return{left:e.clientX-n.left+t.scrollLeft,top:e.clientY-n.top+t.scrollTop}}function ve(e,t){switch(t.type){case"startSelection":return{selecting:!0,exclusive:t.exclusive,start:t.start,current:t.start};case"changeSelection":return e.selecting?Object(me.a)(Object(me.a)({},e),{},{current:t.current}):(console.warn("Marquee reducer received a changeSelection action, but it is not currently selecting; ignoring"),e);case"endSelection":return{selecting:!1}}}var ye=function(e){var t=e.container,n=e.ignoreEventsOnSelector,a=e.onSelectRect,o=r.useReducer(ve,{selecting:!1}),c=Object(L.a)(o,2),s=c[0],i=c[1];return r.useEffect((function(){if("touchOnly"!==he.a&&t.current){var e=t.current,r=function(t){var r;if(n&&(null===(r=t.target)||void 0===r?void 0:r.closest(n)))return;var o=!t.shiftKey&&!t.ctrlKey,c=ge(t,e);i({type:"startSelection",exclusive:o,start:c}),a(Object(me.a)(Object(me.a)({},c),{},{height:0,width:0}),o)};return e.addEventListener("mousedown",r),function(){return e.removeEventListener("mousedown",r)}}}),[t,n,a]),r.useEffect((function(){if(s.selecting&&t.current){var e=t.current,n=function(t){var n=ge(t,e);i({type:"changeSelection",current:n}),a(Object(Oe.e)(s.start,n),s.exclusive)},r=function(){i({type:"endSelection"}),o()},o=function(){window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",r),document.body.classList.remove("marquee-selecting")};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",r),document.body.classList.add("marquee-selecting"),o}}),[t,a,s]),s.selecting&&"touchOnly"!==he.a?Object(u.jsx)("div",{className:"marquee-selection",style:Object(Oe.e)(s.start,s.current)}):null},xe=(n(448),25*Math.sqrt(2)),we=function(e){var t=e.offset,n=e.passage,r={left:n.left,top:n.top};return n.selected&&(r.left+=t.left,r.top+=t.top),Object(u.jsx)("line",{className:"broken-connection",x1:r.left+n.width,y1:r.top+n.height,x2:r.left+n.width+xe,y2:r.top+n.height+xe,style:{markerEnd:"url(#link-broken)"}})};function Se(e){var t=e.start,n=e.end,r=e.radius,a=e.largeArc,o=e.sweep,c=e.rotation;return"M"+t.left+","+t.top+" A"+r.left+","+r.top+" "+(null!==c&&void 0!==c?c:"0")+(a?" 1":" 0")+(o?" 1 ":" 0 ")+n.left+","+n.top}n(449);var Ce=function(e){var t=e.end,n=e.offset,a=e.start,o=e.variant,c=r.useMemo((function(){var e=a,r=t;a.selected&&(e=Object(me.a)(Object(me.a)({},a),{},{left:a.left+n.left,top:a.top+n.top})),t.selected&&(r=Object(me.a)(Object(me.a)({},t),{},{left:t.left+n.left,top:t.top+n.top}));var o=Object(Oe.d)(e),c=Object(Oe.d)(r);if(!(o=Object(Oe.f)(e,o,c)))return"";if(!(c=Object(Oe.f)(r,o,c)))return"";var s=Object(Oe.c)(o,c),i=o.left<c.left;return o.left===c.left&&o.top<c.top&&(i=!0),Se({start:o,end:c,radius:{left:s,top:.75*s},rotation:Object(Oe.b)(o,c),sweep:i})}),[t,n.left,n.top,a]);return Object(u.jsx)("path",{d:c,className:"passage-connection variant-".concat(o),style:{markerEnd:"url(#link-arrowhead)"}})},ke=(n(450),function(e){var t=e.offset,n=e.passage,a=e.variant,o={left:n.left,top:n.top};n.selected&&(o.left+=t.left,o.top+=t.top);var c=r.useMemo((function(){return.4*Math.min(n.width,n.height)}),[n.height,n.width]),s=r.useMemo((function(){return Se({start:{left:o.left,top:o.top+n.height/2},end:{left:o.left,top:o.top},radius:{left:c,top:c},sweep:!0,largeArc:!0})}),[n.height,c,o.left,o.top]);return Object(u.jsx)("path",{className:"self-connection variant-".concat(a),d:s,style:{markerEnd:"url(#link-arrowhead)"}})}),Ie=r.memo((function(e){var t=e.broken,n=e.connections,r=e.offset,a=e.self,o=e.variant,c=void 0===o?"link":o;return Object(u.jsxs)(u.Fragment,{children:[Array.from(n).map((function(e){return Array.from(e[1]).map((function(t){return Object(u.jsx)(Ce,{end:t,offset:r,start:e[0],variant:c},e[0].name+t.name)}))})),Array.from(a).map((function(e){return Object(u.jsx)(ke,{offset:r,passage:e,variant:c},e.name)})),Array.from(t).map((function(e){return Object(u.jsx)(we,{offset:r,passage:e},e.name)}))]})})),Ne=(n(451),function(){return Object(u.jsxs)("defs",{children:[Object(u.jsx)("marker",{id:"link-arrowhead",refX:"6",refY:"4",markerWidth:"8",markerHeight:"8",orient:"auto",children:Object(u.jsx)("path",{d:"M 1,1 7,4 1,7 Z"})}),Object(u.jsxs)("marker",{id:"link-broken",refX:"7.5",refY:"7.5",markerWidth:"15",markerHeight:"15",children:[Object(u.jsx)("circle",{cx:"7.5",cy:"7.5",r:"7.5"}),Object(u.jsx)("path",{d:"M4.5 7.5h 6z"})]}),Object(u.jsxs)("marker",{id:"link-start",markerWidth:"15",markerHeight:"15",refX:"16",refY:"16",viewBox:"0 0 32 32",children:[Object(u.jsx)("circle",{cx:"16",cy:"16",r:"16"}),Object(u.jsx)("path",{d:"M8 17a8 8 0 0 1 7 7a6 6 0 0 0 3 -5a9 9 0 0 0 6 -8a3 3 0 0 0 -3 -3a9 9 0 0 0 -8 6a6 6 0 0 0 -5 3"}),Object(u.jsx)("path",{d:"M11 18a6 6 0 0 0 -3 6a6 6 0 0 0 6 -3"}),Object(u.jsx)("circle",{className:"fill-white",cx:"19",cy:"13",r:"1"})]})]})}),Fe=(n(452),r.memo((function(e){var t=e.offset,n=e.passage,r={left:n.left,top:n.top};return n.selected&&(r.left+=t.left,r.top+=t.top),Object(u.jsx)("line",{className:"start-connection",x1:r.left-50,y1:r.top+n.height/2,x2:r.left,y2:r.top+n.height/2,style:{markerStart:"url(#link-start)"}})}))),Ee=n(76),Pe=function(){return[]};var Te=new Set,De={left:0,top:0},Ae=function(e){var t=e.formatName,n=e.formatVersion,a=e.offset,o=e.passages,c=e.startPassageId,s=function(e,t){var n,a,o=Object(j.usePrefsContext)().prefs,c=Object(I.useStoryFormatsContext)(),s=c.dispatch,i=c.formats,u=Object(I.formatWithNameAndVersion)(i,e,t),l=r.useState(),d=Object(L.a)(l,2),f=d[0],b=d[1],p=Object(j.formatEditorExtensionsDisabled)(o,e,t);return r.useEffect((function(){p||("unloaded"===u.loadState?s(Object(I.loadFormatProperties)(u)):"loaded"===u.loadState&&b(Object(re.b)(u,Ee.a)))}),[s,p,u]),p?Pe:null!==(n=null===f||void 0===f||null===(a=f.references)||void 0===a?void 0:a.parsePassageText)&&void 0!==n?n:Pe}(t,n),i=r.useMemo((function(){return Object(Y.passageConnections)(o)}),[o]),l=i.draggable,d=i.fixed,f=r.useMemo((function(){return Object(Y.passageConnections)(o,s)}),[o,s]),b=f.draggable,p=f.fixed,m=r.useMemo((function(){return o.find((function(e){return e.id===c}))}),[o,c]);return Object(u.jsxs)("svg",{className:"link-connectors",children:[Object(u.jsx)(Ne,{}),m&&Object(u.jsx)(Fe,{offset:a,passage:m}),Object(u.jsx)(Ie,Object(me.a)(Object(me.a)({},l),{},{offset:a})),Object(u.jsx)(Ie,Object(me.a)(Object(me.a)({},d),{},{offset:De})),Object(u.jsx)(Ie,{broken:Te,connections:b.connections,offset:a,self:Te,variant:"reference"}),Object(u.jsx)(Ie,{broken:Te,connections:p.connections,offset:De,self:Te,variant:"reference"})]})},Le=n(499),Me=n(169),Re=n(244),We=n(120),Ue=(n(456),r.memo((function(e){var t=e.onDeselect,n=e.onDrag,a=e.onDragStart,o=e.onDragStop,c=e.onEdit,s=e.onSelect,i=e.passage,l=e.tagColors,d=r.useMemo((function(){return w()("passage-card",{selected:i.selected})}),[i.selected]),f=r.useRef(null),j=r.useMemo((function(){return i.text.substr(0,400)}),[i.text]),b=r.useMemo((function(){return{height:i.height,left:i.left,top:i.top,width:i.width}}),[i.height,i.left,i.top,i.width]),p=r.useCallback((function(e){e.shiftKey||e.ctrlKey?i.selected?t(i):s(i,!1):i.selected||s(i,!0)}),[t,s,i]),m=r.useCallback((function(){return c(i)}),[c,i]);return Object(u.jsx)(Re.DraggableCore,{nodeRef:f,onMouseDown:p,onStart:a,onDrag:n,onStop:o,children:Object(u.jsx)("div",{className:d,onDoubleClick:m,ref:f,style:b,children:Object(u.jsxs)(F.a,{highlighted:i.highlighted,selected:i.selected,children:[Object(u.jsx)(We.a,{tagColors:l,tags:i.tags}),Object(u.jsx)("h2",{children:i.name}),Object(u.jsx)(F.b,{children:j})]})})})}))),ze=(n(457),r.memo((function(e){var t=e.passages;return Object(u.jsx)(Le.a,{component:null,children:t.map((function(t){return Object(u.jsx)(Me.a,{classNames:"pop",timeout:200,children:Object(u.jsx)(Ue,Object(me.a)({passage:t},e))},t.id)}))})})));n(458);function Be(e,t){switch(t.type){case"start":return{dragging:!0,dragX:t.x,dragY:t.y,startX:t.x,startY:t.y};case"move":return Object(me.a)(Object(me.a)({},e),{},{dragX:t.x,dragY:t.y});case"stop":return Promise.resolve().then((function(){return t.callback({left:(e.dragX-e.startX)/t.zoom,top:(e.dragY-e.startY)/t.zoom})})),{dragging:!1,dragX:0,dragY:0,startX:0,startY:0}}}var Je=function(e){var t=e.formatName,n=e.formatVersion,a=e.onDeselect,o=e.onDrag,c=e.onEdit,s=e.onSelect,i=e.passages,l=e.startPassageId,d=e.tagColors,f=e.zoom,j=r.useRef(null),b=r.useMemo((function(){var e=Object(Oe.a)([].concat(Object(ue.a)(i),[{top:0,left:0,width:0,height:0}])),t=window.innerHeight/f,n=window.innerWidth/f;return{height:Math.max(e.height,t)+.75*window.innerHeight,width:Math.max(e.width,n)+.75*window.innerWidth}}),[i,f]),p=r.useMemo((function(){return Object(me.a)(Object(me.a)({},b),{},{transform:"scale(".concat(f,")")})}),[b,f]),m=r.useReducer(Be,{dragging:!1,dragX:0,dragY:0,startX:0,startY:0}),h=Object(L.a)(m,2),O=h[0],g=h[1];r.useEffect((function(){j.current&&(j.current.style.setProperty("--drag-offset-left","".concat((O.dragX-O.startX)/f,"px")),j.current.style.setProperty("--drag-offset-top","".concat((O.dragY-O.startY)/f,"px")))}),[O.dragX,O.dragY,O.startX,O.startY,f]);var v=r.useCallback((function(e,t){document.body.classList.add("dragging-passages"),g({type:"start",x:t.x,y:t.y})}),[]),y=r.useCallback((function(e,t){return g({type:"move",x:t.x,y:t.y})}),[]),x=r.useCallback((function(){document.body.classList.remove("dragging-passages"),g({type:"stop",callback:o,zoom:f})}),[o,f]);return Object(u.jsxs)("div",{className:"passage-map",ref:j,style:p,children:[Object(u.jsx)(Ae,{formatName:t,formatVersion:n,offset:{left:(O.dragX-O.startX)/f,top:(O.dragY-O.startY)/f},passages:i,startPassageId:l}),Object(u.jsx)(ze,{onDeselect:a,onDragStart:v,onDrag:y,onDragStop:x,onEdit:c,onSelect:s,passages:i,tagColors:d,zoom:f})]})},Ve=n(26),qe=n(132),Ge=function(e){var t=e.getCenter,n=e.story,a=Object(Ve.useUndoableStoriesContext)().dispatch,o=r.useCallback((function(){var e=t(),r=e.left,o=e.top;a(Object(Y.createUntitledPassage)(n,r,o),"undoChange.newPassage")}),[a,t,n]),c=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.I,{}),label:c("common.new"),onClick:o})},Ye=function(e){var t=e.passages,n=e.story,r=Object(Ve.useUndoableStoriesContext)().dispatch,a=Object(g.a)().t;return Object(u.jsx)(R.a,{disabled:0===t.length,icon:Object(u.jsx)(k.U,{}),label:t.length>1?a("common.deleteCount",{count:t.length}):a("common.delete"),onClick:function(){r(Object(Y.deletePassages)(n,t),t.length>1?"undoChange.deletePassages":"undoChange.deletePassage")}})},He=function(e){var t=e.passages,n=e.story,r=Object(T.useDialogsContext)().dispatch,a=Object(g.a)().t;return Object(u.jsx)(R.a,{disabled:0===t.length,icon:Object(u.jsx)(k.u,{}),label:t.length>1?a("common.editCount",{count:t.length}):a("common.edit"),onClick:function(){r((function(e){return t.forEach((function(t){return e({type:"addDialog",component:T.PassageEditDialog,props:{passageId:t.id,storyId:n.id}})}))}))}})},_e=function(e){var t=e.story,n=Object(Y.useStoriesContext)().dispatch,r=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.F,{}),label:r("common.selectAll"),onClick:function(){return n(Object(Y.selectAllPassages)(t))}})},Xe=function(e){var t=e.passage,n=e.story,r=Object(Y.useStoriesContext)(),a=r.dispatch,o=r.stories,c=Object(g.a)().t;return Object(u.jsx)(R.a,{disabled:!t||t.id===n.startPassage,icon:Object(u.jsx)(k.L,{}),label:c("routes.storyEdit.toolbar.startStoryHere"),onClick:function(){if(!t)throw new Error("No passage set");a(Object(Y.updateStory)(o,n,{startPassage:t.id}))}})},$e=function(e){var t=e.passage,n=e.story,r=$().testStory,a=Object(g.a)().t;return Object(u.jsx)(R.a,{disabled:!t,icon:Object(u.jsx)(k.T,{}),label:a("routes.storyEdit.toolbar.testFromHere"),onClick:function(){return r(n.id,null===t||void 0===t?void 0:t.id)}})},Ze=function(e){var t=e.getCenter,n=e.story,a=Object(Y.useStoriesContext)().dispatch,o=r.useMemo((function(){return n.passages.filter((function(e){return e.selected}))}),[n.passages]),c=r.useMemo((function(){return 1===o.length?o[0]:void 0}),[o]);return Object(u.jsxs)(V.a,{children:[Object(u.jsx)(Ge,{getCenter:t,story:n}),Object(u.jsx)(He,{passages:o,story:n}),Object(u.jsx)(qe.a,{onRename:function(e){return function(e,t){if(!t)throw new Error("Passage is unset");a(Object(Y.updatePassage)(n,t,{name:e},{dontCreateNewlyLinkedPassages:!0}))}(e,c)},passage:c,story:n}),Object(u.jsx)(Ye,{passages:o,story:n}),Object(u.jsx)($e,{passage:c,story:n}),Object(u.jsx)(Xe,{passage:c,story:n}),Object(u.jsx)(_e,{story:n})]})},Ke=function(){var e=Object(g.a)().t;return Object(u.jsx)(R.a,{disabled:!0,icon:Object(u.jsx)(k.X,{}),label:e("common.rename")})},Qe=function(e){var t=e.existingStories,n=e.onRename,a=e.story,o=r.useState(a.name),c=Object(L.a)(o,2),s=c[0],i=c[1],l=Object(g.a)().t;return r.useEffect((function(){return i(a.name)}),[a]),Object(u.jsx)(ne.a,{icon:Object(u.jsx)(k.X,{}),label:l("common.rename"),onChange:function(e){return i(e.target.value)},onSubmit:n,prompt:l("common.renamePrompt",{name:a.name}),validate:function(e){return""===e.trim()?{message:l("components.renameStoryButton.emptyName"),valid:!1}:t.some((function(t){return t.id!==a.id&&Object(q.storyFileName)(t)===Object(q.storyFileName)(Object(me.a)(Object(me.a)({},a),{},{name:e}))}))?{message:l("components.renameStoryButton.nameAlreadyUsed"),valid:!1}:{valid:!0}},value:s})},et=function(e){return e.story?Object(u.jsx)(Qe,Object(me.a)({},e)):Object(u.jsx)(Ke,{})},tt=function(e){var t=e.story,n=Object(T.useDialogsContext)().dispatch,r=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.E,{}),label:r("common.details"),onClick:function(){return n({type:"addDialog",component:T.StoryDetailsDialog,props:{storyId:t.id}})}})},nt=function(e){var t=e.story,n=Object(T.useDialogsContext)().dispatch,r=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.M,{}),label:r("routes.storyEdit.toolbar.findAndReplace"),onClick:function(){return n({type:"addDialog",component:T.StorySearchDialog,props:{storyId:t.id}})}})},rt=function(e){var t=e.story,n=Object(T.useDialogsContext)().dispatch,r=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.k,{}),label:r("routes.storyEdit.toolbar.javaScript"),onClick:function(){return n({type:"addDialog",component:T.StoryJavaScriptDialog,props:{storyId:t.id}})}})},at=function(e){var t=e.story,n=Object(T.useDialogsContext)().dispatch,r=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.S,{}),label:r("routes.storyEdit.toolbar.passageTags"),onClick:function(){return n({type:"addDialog",component:T.PassageTagsDialog,props:{storyId:t.id}})}})},ot=function(e){var t=e.story,n=Object(T.useDialogsContext)().dispatch,r=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.z,{}),label:r("routes.storyEdit.toolbar.stylesheet"),onClick:function(){return n({type:"addDialog",component:T.StoryStylesheetDialog,props:{storyId:t.id}})}})},ct=function(e){var t=Object(Y.useStoriesContext)(),n=t.dispatch,r=t.stories,a=e.story;return Object(u.jsxs)(V.a,{children:[Object(u.jsx)(nt,{story:a}),Object(u.jsx)(et,{existingStories:r,onRename:function(e){return n(Object(Y.updateStory)(r,a,{name:e}))},story:a}),Object(u.jsx)(tt,{story:a}),Object(u.jsx)(at,{story:a}),Object(u.jsx)(rt,{story:a}),Object(u.jsx)(ot,{story:a})]})},st=function(){var e=Object(Ve.useUndoableStoriesContext)(),t=e.redo,n=e.redoLabel,r=e.undo,a=e.undoLabel,o=Object(g.a)().t;return Object(u.jsxs)(u.Fragment,{children:[Object(u.jsx)(R.a,{disabled:!r,icon:Object(u.jsx)(k.c,{}),label:null!==a&&void 0!==a?a:o("common.undo"),onClick:r}),Object(u.jsx)(R.a,{disabled:!t,icon:Object(u.jsx)(k.f,{}),label:null!==n&&void 0!==n?n:o("common.redo"),onClick:t})]})},it=function(e){var t,n=e.getCenter,r=e.story,a=Object(g.a)().t;return Object(u.jsx)(U,{pinnedControls:Object(u.jsx)(st,{}),tabs:(t={},Object(A.a)(t,a("common.passage"),Object(u.jsx)(Ze,{getCenter:n,story:r})),Object(A.a)(t,a("common.story"),Object(u.jsx)(ct,{story:r})),Object(A.a)(t,a("common.build"),Object(u.jsx)(ee,{story:r})),Object(A.a)(t,a("common.appName"),Object(u.jsx)(te,{})),t)})},ut=(n(459),n(130)),lt=(n(460),n(129)),dt=function(e){var t=e.story,n=Object(Y.useStoriesContext)(),a=n.dispatch,o=n.stories,c=Object(g.a)().t,s=Object(lt.useScrollbarSize)().height,i=r.useCallback((function(e){a(Object(Y.updateStory)(o,t,{zoom:t.zoom+e}))}),[a,o,t]),l={marginBottom:s};return Object(u.jsx)("div",{className:"zoom-buttons",style:l,children:Object(u.jsxs)(ut.a,{children:[Object(u.jsx)(R.a,{disabled:t.zoom>=Y.maxZoom,icon:Object(u.jsx)(k.Z,{}),iconOnly:!0,label:c("routes.storyEdit.zoomIn"),onClick:function(){return i(.2)}}),Object(u.jsx)(R.a,{disabled:t.zoom<=Y.minZoom,icon:Object(u.jsx)(d.d,{}),iconOnly:!0,label:c("routes.storyEdit.zoomOut"),onClick:function(){return i(-.2)}})]})})},ft=function(){var e=r.useState(!1),t=Object(L.a)(e,2),n=t[0],a=t[1],o=Object(T.useDialogsContext)().dispatch,c=r.useRef(null),s=Object(h.g)().storyId,i=Object(Ve.useUndoableStoriesContext)(),l=i.dispatch,d=i.stories,f=Object(Y.storyWithId)(d,s),j=r.useMemo((function(){return f.passages.filter((function(e){return e.selected}))}),[f.passages]),b=r.useCallback((function(){if(!c.current)throw new Error("Asked for the center of the main content, but it does not exist in the DOM yet");return{left:(c.current.scrollLeft+c.current.clientWidth/2)/f.zoom,top:(c.current.scrollTop+c.current.clientHeight/2)/f.zoom}}),[f.zoom]),p=r.useCallback((function(e){return l(Object(Y.deselectPassage)(f,e))}),[f,l]),m=r.useCallback((function(e){Math.abs(e.left)<1&&Math.abs(e.top)<1||l(Object(Y.movePassages)(f,f.passages.reduce((function(e,t){return t.selected?[].concat(Object(ue.a)(e),[t.id]):e}),[]),e.left,e.top),(j.length,"undoChange.movePassages"))}),[j.length,f,l]),O=r.useCallback((function(e){return o({type:"addDialog",component:T.PassageEditDialog,props:{passageId:e.id,storyId:f.id}})}),[o,f.id]),g=r.useCallback((function(e,t){return l(Object(Y.selectPassage)(f,e,t))}),[f,l]),v=r.useCallback((function(e,t){var n={height:e.height/f.zoom,left:e.left/f.zoom,top:e.top/f.zoom,width:e.width/f.zoom};l(Object(Y.selectPassagesInRect)(f,n,t?[]:j.map((function(e){return e.id}))))}),[j,f,l]);return r.useEffect((function(){if(!n&&(a(!0),0===f.passages.length)){var e=b();l(Object(Y.createUntitledPassage)(f,e.left,e.top))}}),[b,n,f,l]),Object(u.jsxs)("div",{className:"story-edit-route",children:[Object(u.jsx)(S.a,{children:Object(u.jsx)("title",{children:f.name})}),Object(u.jsx)(it,{getCenter:b,story:f}),Object(u.jsxs)(C,{padded:!1,ref:c,children:[Object(u.jsx)(ye,{container:c,ignoreEventsOnSelector:".passage-card, .passage-toolbar",onSelectRect:v}),Object(u.jsx)(Je,{formatName:f.storyFormat,formatVersion:f.storyFormatVersion,onDeselect:p,onDrag:m,onEdit:O,onSelect:g,passages:f.passages,startPassageId:f.startPassage,tagColors:f.tagColors,zoom:f.zoom}),Object(u.jsx)(dt,{story:f})]})]})},jt=function(){return Object(u.jsx)(Ve.UndoableStoriesContextProvider,{children:Object(u.jsx)(T.DialogsContextProvider,{children:Object(u.jsx)(ft,{})})})},bt=n(168),pt=n.n(bt),mt=n(245),ht=n.n(mt),Ot=n(62),gt=(n(488),function(e){var t=Object(g.a)().t,n=(new ht.a).getBrowser();if("Safari"!==n.name)return null;if(n.version){var r=parseInt(n.version.replace(/\..*/,""));if(Number.isFinite(r)&&r<13)return null}var a=window.navigator;if(a.standalone)return null;var o=void 0!==a.standalone;return Object(u.jsx)("div",{className:"safari-warning-card",children:Object(u.jsxs)(F.a,{children:[Object(u.jsx)("div",{className:"side-icon",children:Object(u.jsx)(k.a,{})}),Object(u.jsxs)("div",{className:"message",children:[Object(u.jsx)("p",{children:t("components.safariWarningCard.message")}),o&&Object(u.jsx)("p",{children:t("components.safariWarningCard.addToHomeScreen")}),Object(u.jsx)("p",{children:t("components.safariWarningCard.archiveAndUseAnotherBrowser")})]}),Object(u.jsxs)(V.a,{children:[Object(u.jsx)(Ot.a,{href:"https://twinery.org/2ioslocalstorage",icon:Object(u.jsx)(k.E,{}),label:t("components.safariWarningCard.learnMore"),variant:"primary"}),o&&Object(u.jsx)(Ot.a,{href:"https://twinery.org/2ioshomescreen",icon:Object(u.jsx)(k.E,{}),label:t("components.safariWarningCard.howToAddToHomeScreen")})]})]})})});function vt(){return JSON.stringify(window.localStorage).length}function yt(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;return new Promise((function(n){var r="x".repeat(e),a=0,o=window.setInterval((function(){try{window.localStorage.setItem("__freeSpaceTest".concat(a),r),a++}catch(c){for(var t=0;t<=a;t++)try{window.localStorage.removeItem("__freeSpaceTest".concat(t))}catch(s){}window.clearInterval(o),n(a*e)}}),t)}))}n(489);var xt=function(e){var t=e.watch,n=r.useState(),a=Object(L.a)(n,2),o=a[0],c=a[1],s=r.useState(!1),i=Object(L.a)(s,2),l=i[0],f=i[1],j=r.useState(-1),b=Object(L.a)(j,2),p=b[0],m=b[1],h=r.useState(0),O=Object(L.a)(h,2),v=O[0],y=O[1],x=Object(g.a)().t,w=Object(X.a)();return r.useEffect((function(){function e(){return(e=Object(J.a)(B.a.mark((function e(){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return f(!0),y(vt()),e.t0=m,e.next=5,yt();case 5:e.t1=e.sent,(0,e.t0)(e.t1),c(t),f(!1);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}w||l||o===t||function(){e.apply(this,arguments)}()}),[w,o,t,l]),w?null:Object(u.jsxs)("span",{className:"storage-quota",children:[l&&Object(u.jsx)(d.b,{}),-1!==p&&x("components.storageQuota.freeSpace",{percent:Math.round(p/(p+v)*100)})]})},wt=function(){var e=Object(Y.useStoriesContext)().stories,t=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.H,{}),label:t("routes.storyList.toolbar.archive"),onClick:function(){return K(Object(G.b)(e,Object(H.a)()),Object(G.a)())}})},St=function(){var e=Object(T.useDialogsContext)().dispatch,t=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.x,{}),label:t("common.import"),onClick:function(){return e({type:"addDialog",component:T.StoryImportDialog})}})},Ct=function(){var e=Object(T.useDialogsContext)().dispatch,t=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.S,{}),label:t("routes.storyList.toolbar.storyTags"),onClick:function(){e({type:"addDialog",component:T.StoryTagsDialog})}})},kt=function(){return Object(u.jsxs)(V.a,{children:[Object(u.jsx)(Ct,{}),Object(u.jsx)(St,{}),Object(u.jsx)(wt,{})]})},It=n(92),Nt=n.n(It),Ft=function(){var e=Object(Y.useStoriesContext)(),t=e.dispatch,n=e.stories,r=Object(h.f)(),a=Object(j.usePrefsContext)().prefs,o=Object(g.a)().t;return Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.I,{}),label:o("common.new"),onClick:function(){var e=Object(Y.createUntitledStory)(n,a)(t,(function(){return n}));r.push("/stories/".concat(e))}})},Et=n(20),Pt=n(45),Tt=(n(490),function(e){var t=e.cancelIcon,n=e.cancelLabel,a=e.confirmIcon,o=e.confirmLabel,c=e.confirmVariant,s=e.onConfirm,i=e.prompt,l=Object(Et.a)(e,["cancelIcon","cancelLabel","confirmIcon","confirmLabel","confirmVariant","onConfirm","prompt"]),d=r.useState(!1),f=Object(L.a)(d,2),j=f[0],b=f[1],p=Object(g.a)().t;return Object(u.jsx)("span",{className:"confirm-button",children:Object(u.jsxs)(Pt.a,Object(me.a)(Object(me.a)({onChangeOpen:b,open:j},l),{},{children:[Object(u.jsx)(F.b,{children:i}),Object(u.jsxs)(V.a,{children:[Object(u.jsx)(R.a,{icon:null!==a&&void 0!==a?a:Object(u.jsx)(k.n,{}),label:null!==o&&void 0!==o?o:p("common.ok"),onClick:s,variant:null!==c&&void 0!==c?c:"primary"}),Object(u.jsx)(R.a,{icon:null!==t&&void 0!==t?t:Object(u.jsx)(k.Y,{}),label:null!==n&&void 0!==n?n:p("common.cancel"),onClick:function(){return b(!1)}})]})]}))})}),Dt=function(e){var t=e.story,n=Object(Y.useStoriesContext)().dispatch,r=Object(g.a)().t;return Object(u.jsx)(Tt,{confirmIcon:Object(u.jsx)(k.U,{}),confirmLabel:r("common.delete"),confirmVariant:"danger",disabled:!t,icon:Object(u.jsx)(k.U,{}),label:r("common.delete"),onConfirm:t?function(){return n(Object(Y.deleteStory)(t))}:function(){},prompt:r("routes.storyList.toolbar.deleteStoryButton.warning.".concat(Object(X.a)()?"electron":"web"),{storyName:null===t||void 0===t?void 0:t.name})})},At=function(e){var t=e.story,n=Object(Y.useStoriesContext)(),r=n.dispatch,a=n.stories,o=Object(g.a)().t;return Object(u.jsx)(R.a,{disabled:!t,icon:Object(u.jsx)(k.s,{}),label:o("common.duplicate"),onClick:function(){if(!t)throw new Error("No story set");r(Object(Y.duplicateStory)(t,a))}})},Lt=function(e){var t=e.story,n=Object(h.f)(),r=Object(g.a)().t;return Object(u.jsx)(R.a,{disabled:!t,icon:Object(u.jsx)(k.u,{}),label:r("common.edit"),onClick:function(){return n.push("/stories/".concat(null===t||void 0===t?void 0:t.id))}})},Mt=n(78),Rt=function(e){var t,n=e.story,r=Object(j.usePrefsContext)(),a=r.dispatch,o=r.prefs,c=Object(Y.useStoriesContext)(),s=c.dispatch,i=c.stories;return Object(u.jsx)(Mt.a,{assignedTags:null!==(t=null===n||void 0===n?void 0:n.tags)&&void 0!==t?t:[],disabled:!n,existingTags:Object(Y.storyTags)(i),icon:Object(u.jsx)(k.R,{}),onAdd:function(e,t){if(!n)throw new Error("Story is unset");s(Object(Y.updateStory)(i,n,{tags:n.tags?[].concat(Object(ue.a)(n.tags),[e]):[e]})),t&&a(Object(j.setPref)("storyTagColors",Object(me.a)(Object(me.a)({},o.storyTagColors),{},Object(A.a)({},e,t))))}})},Wt=function(e){var t=r.useState(!1),n=Object(L.a)(t,2),a=n[0],o=n[1],c=Object(Y.useStoriesContext)(),s=(c.dispatch,c.stories),i=r.useState([]),l=Object(L.a)(i,2),d=l[0],f=l[1];return Object(u.jsx)(Pt.a,{disabled:!1,icon:Object(u.jsx)(k.X,{}),label:"export stories",onChangeOpen:function(){o(!0)},open:a,children:Object(u.jsxs)(F.b,{style:{width:400,maxHeight:400,overflowY:"auto"},children:[Object(u.jsx)("ul",{children:s.map((function(e){return Object(u.jsx)("li",{children:Object(u.jsx)(fe.a,{label:e.name,onChange:function(t){return function(e,t){f(t?function(t){return[].concat(Object(ue.a)(t),[e])}:function(t){return t.filter((function(t){return t.id!==e.id}))})}(e,t)},value:d.includes(e)},e.id)})}))}),Object(u.jsxs)(V.a,{children:[Object(u.jsx)(R.a,{disabled:!1,icon:Object(u.jsx)(k.I,{}),label:"Export",onClick:function(){e.onSelect(d),o(!1)},variant:"create"}),Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.Y,{}),label:"Cancel",onClick:function(){return o(!1)}})]})]})})},Ut=function(){var e=Object(J.a)(B.a.mark((function e(t){var n,r,a,o;return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="",r=t.reduce((function(e,r){n=1==t.length?r.name.replace(/\s+/g,""):"".concat(n,"_").concat((r.name||"not").substring(0,3));var a=Object(Q.a)(r);return a.length>0?[].concat(Object(ue.a)(e),[a[0]]):e}),[]),a="data:text/json;chatset=utf-8,".concat(encodeURIComponent(JSON.stringify(r,null,4))),e.prev=3,e.next=6,Nt.a.post("/author/save").set("Content-Type","application/json").send({name:n,layer:r});case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(3),console.log("failed to trabsfer to fmundane engine!");case 11:(o=document.createElement("a")).href=a,o.download="".concat(n,".json"),o.click();case 15:case"end":return e.stop()}}),e,null,[[3,8]])})));return function(t){return e.apply(this,arguments)}}(),zt=function(e){var t=e.selectedStory,n=Object(Y.useStoriesContext)(),r=n.dispatch,a=n.stories;return Object(u.jsxs)(V.a,{children:[Object(u.jsx)(Ft,{}),Object(u.jsx)(Lt,{story:t}),Object(u.jsx)(Rt,{story:t}),Object(u.jsx)(et,{existingStories:a,onRename:function(e){return r(Object(Y.updateStory)(a,t,{name:e}))},story:t}),Object(u.jsx)(At,{story:t}),Object(u.jsx)(Dt,{story:t}),Object(u.jsx)(Wt,{onSelect:function(e){Ut(e)}})]})},Bt=n(59),Jt=function(){var e=Object(g.a)().t,t=Object(j.usePrefsContext)(),n=t.dispatch,r=t.prefs;return Object(u.jsx)(Bt.a,{icon:Object(u.jsx)(k.i,{}),items:[{checkable:!0,checked:"date"===r.storyListSort,label:e("routes.storyList.toolbar.sortByDate"),onClick:function(){return n(Object(j.setPref)("storyListSort","date"))}},{checkable:!0,checked:"name"===r.storyListSort,label:e("routes.storyList.toolbar.sortByName"),onClick:function(){return n(Object(j.setPref)("storyListSort","name"))}}],label:e("routes.storyList.toolbar.sort")})},Vt=function(e){var t=Object(j.usePrefsContext)(),n=t.dispatch,r=t.prefs,a=Object(g.a)().t;return Object(u.jsx)(Bt.a,{disabled:0===e.tags.length,icon:Object(u.jsx)(k.R,{}),items:[{checkable:!0,checked:0===r.storyListTagFilter.length,label:a("routes.storyList.toolbar.showAllStories"),onClick:function(){return n({type:"update",name:"storyListTagFilter",value:[]})}},{separator:!0}].concat(Object(ue.a)(e.tags.map((function(e){return{checkable:!0,checked:r.storyListTagFilter.includes(e),label:e,onClick:function(){return n({type:"update",name:"storyListTagFilter",value:r.storyListTagFilter.includes(e)?r.storyListTagFilter.filter((function(t){return t!==e})):[].concat(Object(ue.a)(r.storyListTagFilter),[e])})}}})))),label:a("routes.storyList.toolbar.showTags")})},qt=function(){var e=Object(Y.useStoriesContext)().stories;return Object(u.jsxs)(V.a,{children:[Object(u.jsx)(Jt,{}),Object(u.jsx)(Vt,{tags:Object(Y.storyTags)(e)})]})},Gt=function(e){var t,n=e.selectedStories,r=Object(Y.useStoriesContext)().stories,a=Object(g.a)().t,o=1===n.length?n[0]:void 0;return Object(u.jsx)(U,{pinnedControls:Object(u.jsx)(xt,{watch:r}),tabs:(t={},Object(A.a)(t,a("common.story"),Object(u.jsx)(zt,{selectedStory:o})),Object(A.a)(t,a("routes.storyList.library"),Object(u.jsx)(kt,{})),Object(A.a)(t,a("common.build"),Object(u.jsx)(ee,{story:o})),Object(A.a)(t,a("common.view"),Object(u.jsx)(qt,{})),Object(A.a)(t,a("common.appName"),Object(u.jsx)(te,{})),t)})};n(491);function Yt(e){for(var t=0,n=0;n<e.length;n++)t+=e.charCodeAt(n);return t%360}n(492);var Ht=r.memo((function(e){var t=e.story,n=[Yt(t.name)];n.push((n[0]+15)%360),n.push((n[0]-15)%360),n.push((n[0]+30)%360),n.push((n[0]-30)%360),n.push((n[0]+60)%360);var r=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,s=t.passages.map((function(e){return{key:e.name,x:e.left+e.width/2,y:e.top+e.height/2,radius:Math.max(e.width,e.height)}})).reduce((function(e,t,s){var i=t.radius+200;return r=Math.min(r,t.x-i),a=Math.min(a,t.y-i),o=Math.max(o,t.x+i),c=Math.max(c,t.y+i),e[0].push(Object(u.jsx)("circle",{cx:t.x,cy:t.y,r:i,style:{fill:"hsl(".concat(n[s%n.length],", 80%, 80%)")}},"".concat(t.key,"-bg"))),e[1].push(Object(u.jsx)("circle",{cx:t.x,cy:t.y,r:t.radius,style:{fill:"hsl(".concat(n[s%n.length],", 80%, 60%)")}},"".concat(t.key,"-fg"))),e}),[[],[]]).map((function(e,t){return Object(u.jsx)("g",{className:"story-preview-".concat(0===t?"bg":"fg"),children:e},t)})),i="".concat(r," ").concat(a," ").concat(o-r," ").concat(c-a);return Object(u.jsx)("svg",{className:"story-preview",viewBox:i,xmlns:"http://www.w3.org/2000/svg",children:s})})),_t=new Intl.DateTimeFormat([]),Xt=function(e){var t=e.onChangeTagColor,n=e.onEdit,r=e.onRemoveTag,a=e.onSelect,o=e.story,c=e.storyTagColors,s=Object(Et.a)(e,["onChangeTagColor","onEdit","onRemoveTag","onSelect","story","storyTagColors"]),i=Object(g.a)().t;return Object(u.jsx)("div",{className:"story-card",onClick:a,onDoubleClick:n,children:Object(u.jsx)(F.a,Object(me.a)(Object(me.a)({},s),{},{selected:o.selected,children:Object(u.jsxs)(F.b,{children:[Object(u.jsxs)("div",{className:"story-card-summary",children:[Object(u.jsx)("div",{className:"story-card-summary-preview",children:Object(u.jsx)(Ht,{story:o})}),Object(u.jsxs)("div",{className:"story-card-summary-text",children:[Object(u.jsx)("h2",{children:o.name}),Object(u.jsxs)("p",{children:[i("components.storyCard.lastUpdated",{date:_t.format(o.lastUpdate)}),Object(u.jsx)("br",{}),i("components.storyCard.passageCount",{count:o.passages.length})]})]})]}),o.tags&&Object(u.jsx)("div",{className:"tags",children:o.tags.map((function(e){return Object(u.jsx)(Mt.b,{color:c[e],name:e,onChangeColor:function(n){return t(e,n)},onRemove:function(){return r(e)}},e)}))})]})}))})},$t=function(e){var t=e.onSelectStory,n=e.stories,r=Object(j.usePrefsContext)(),a=r.dispatch,o=r.prefs,c=Object(Ve.useUndoableStoriesContext)().dispatch,s=Object(h.f)();function i(e,t){a(Object(j.setPref)("storyTagColors",Object(me.a)(Object(me.a)({},o.storyTagColors),{},Object(A.a)({},e,t))))}return Object(u.jsx)(u.Fragment,{children:Object(u.jsx)(y,{columnWidth:"360px",children:n.map((function(e){return Object(u.jsx)(Xt,{onChangeTagColor:i,onEdit:function(){return s.push("/stories/".concat(e.id))},onRemoveTag:function(t){return function(e,t){c(Object(Y.updateStory)(n,e,{tags:e.tags.filter((function(e){return e!==t}))}))}(e,t)},onSelect:function(){return t(e)},story:e,storyTagColors:o.storyTagColors},e.id)}))})})},Zt=function(){var e=Object(T.useDialogsContext)().dispatch,t=Object(Y.useStoriesContext)(),n=t.dispatch,a=t.stories,o=Object(j.usePrefsContext)().prefs,c=function(){var e=Object(j.usePrefsContext)().prefs;return{shouldShowDonationPrompt:r.useCallback((function(){return!e.donateShown&&Date.now()>e.firstRunTime+12096e5}),[e.donateShown,e.firstRunTime])}}().shouldShowDonationPrompt,s=Object(g.a)().t,i=r.useMemo((function(){return a.filter((function(e){return e.selected}))}),[a]),l=r.useMemo((function(){var e=o.storyListTagFilter.length>0?a.filter((function(e){return e.tags.some((function(e){return o.storyListTagFilter.includes(e)}))})):a;switch(o.storyListSort){case"date":return pt()(e,"lastUpdated");case"name":return pt()(e,"name")}}),[o.storyListSort,o.storyListTagFilter,a]);return r.useEffect((function(){var e,t=Object(O.a)(i);try{for(t.s();!(e=t.n()).done;){var r=e.value;r.selected&&!l.includes(r)&&n(Object(Y.deselectStory)(r))}}catch(a){t.e(a)}finally{t.f()}}),[i,a,n,l]),r.useEffect((function(){c()&&e({type:"addDialog",component:T.AppDonationDialog})}),[e,c]),Object(u.jsxs)("div",{className:"story-list-route",children:[Object(u.jsx)(Gt,{selectedStories:i}),Object(u.jsx)(v,{ignoreSelector:".story-card",onClickAway:function(){return n(Object(Y.deselectAllStories)())},children:Object(u.jsxs)(C,{title:s(o.storyListTagFilter.length>0?"routes.storyList.taggedTitleCount":"routes.storyList.titleCount",{count:l.length}),children:[Object(u.jsx)(gt,{}),Object(u.jsx)("div",{className:"stories",children:0===a.length?Object(u.jsx)("p",{children:s("routes.storyList.noStories")}):Object(u.jsx)($t,{onSelectStory:function(e){return n(Object(Y.selectStory)(e,!0))},stories:l})})]})})]})},Kt=function(){return Object(u.jsx)(Ve.UndoableStoriesContextProvider,{children:Object(u.jsx)(T.DialogsContextProvider,{children:Object(u.jsx)(Zt,{})})})};function Qt(e){delete window.CodeMirror,delete window.SVG,delete window.Store,delete window.StoryFormat,delete window.amdDefine,delete window.app,delete window.jQuery,document.open(),document.write(e),document.close()}var en=function(){var e=r.useState(!1),t=Object(L.a)(e,2),n=t[0],a=t[1],o=Object(h.g)().storyId,c=_().publishStory;return r.useEffect((function(){function e(){return(e=Object(J.a)(B.a.mark((function e(){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=Qt,e.next=3,c(o);case 3:e.t1=e.sent,(0,e.t0)(e.t1);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}n||(a(!0),function(){e.apply(this,arguments)}())}),[n,c,o]),null},tn=function(){var e=r.useState(!1),t=Object(L.a)(e,2),n=t[0],a=t[1],o=Object(h.g)().storyId,c=_().proofStory;return r.useEffect((function(){function e(){return(e=Object(J.a)(B.a.mark((function e(){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=Qt,e.next=3,c(o);case 3:e.t1=e.sent,(0,e.t0)(e.t1);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}n||(a(!0),function(){e.apply(this,arguments)}())}),[n,c,o]),null},nn=function(){var e=r.useState(!1),t=Object(L.a)(e,2),n=t[0],a=t[1],o=Object(h.g)(),c=o.passageId,s=o.storyId,i=_().publishStory;return r.useEffect((function(){function e(){return(e=Object(J.a)(B.a.mark((function e(){return B.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=Qt,e.next=3,i(s,{formatOptions:"debug",startId:c});case 3:e.t1=e.sent,(0,e.t0)(e.t1);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}n||(a(!0),function(){e.apply(this,arguments)}())}),[n,c,i,s]),null},rn=n(246),an=n.n(rn),on=(n(493),function(e){var t=e.children,n=e.image,r=e.nextLabel,a=e.onNext,o=e.onSkip,c=e.showSkip,s=e.title,i=Object(Et.a)(e,["children","image","nextLabel","onNext","onSkip","showSkip","title"]),l=Object(g.a)().t;return Object(u.jsx)("div",{className:"welcome-card",children:Object(u.jsxs)(F.a,Object(me.a)(Object(me.a)({},i),{},{children:[Object(u.jsx)("div",{className:"welcome-card-image",children:n}),Object(u.jsxs)(F.b,{children:[Object(u.jsx)("h2",{children:s}),t]}),Object(u.jsxs)(V.a,{children:[Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.h,{}),variant:"primary",onClick:a,label:r}),c&&Object(u.jsx)(R.a,{icon:Object(u.jsx)(k.e,{}),label:l("common.skip"),onClick:o})]})]}))})}),cn=function(){return[{html:"routes.welcome.greeting",image:Object(u.jsx)(d.c,{}),nextLabel:"routes.welcome.tellMeMore",title:"routes.welcome.greetingTitle"},{html:"routes.welcome.help",image:Object(u.jsx)(k.B,{}),title:"routes.welcome.helpTitle"},Object(X.a)()?{html:"routes.welcome.autosave",image:Object(u.jsx)(k.t,{}),title:"routes.welcome.autosaveTitle"}:{html:"routes.welcome.browserStorage",image:Object(u.jsx)(k.t,{}),title:"routes.welcome.browserStorageTitle"},{html:"routes.welcome.done",image:Object(u.jsx)(k.G,{}),nextLabel:"routes.welcome.gotoStoryList",title:"routes.welcome.doneTitle"}]},sn=(n(494),function(){var e=r.useRef(null),t=Object(j.usePrefsContext)().dispatch,n=Object(h.f)(),a=r.useState(1),o=Object(L.a)(a,2),c=o[0],s=o[1],i=r.useMemo(cn,[]),l=r.useMemo((function(){return i.slice(0,c)}),[i,c]),d=Object(g.a)().t;r.useEffect((function(){if(e.current){var t,n=e.current.querySelector(".welcome-card:last-of-type");if(n)an.a.top(null!==(t=document.documentElement)&&void 0!==t?t:document.body,n.offsetTop,{duration:400})}}),[c]);var f=function(){t(Object(j.setPref)("welcomeSeen",!0)),n.push("/")},b=function(){return s((function(e){return e+1}))};return Object(u.jsxs)("div",{className:"welcome-route",ref:e,children:[Object(u.jsx)(S.a,{children:Object(u.jsx)("title",{children:d("routes.welcome.greetingTitle")})}),Object(u.jsx)("div",{className:"cards",children:Object(u.jsx)(Le.a,{component:null,children:l.map((function(e,t){return Object(u.jsx)(Me.a,{classNames:"pop",timeout:200,children:Object(u.jsx)(on,{image:e.image,nextLabel:e.nextLabel?d(e.nextLabel):d("common.next"),onNext:t===i.length-1?f:b,onSkip:f,showSkip:0===t,title:d(e.title),children:Object(u.jsx)("div",{dangerouslySetInnerHTML:{__html:d(e.html)}})})},e.title)}))})})]})}),un=function(){var e=Object(j.usePrefsContext)().prefs;return Object(u.jsx)(m.a,{children:e.welcomeSeen?Object(u.jsxs)(h.c,{children:[Object(u.jsx)(h.a,{exact:!0,path:"/",children:Object(u.jsx)(Kt,{})}),Object(u.jsx)(h.a,{path:"/story-formats",children:Object(u.jsx)(pe,{})}),Object(u.jsx)(h.a,{path:"/welcome",children:Object(u.jsx)(sn,{})}),Object(u.jsx)(h.a,{path:"/stories/:storyId/play",children:Object(u.jsx)(en,{})}),Object(u.jsx)(h.a,{path:"/stories/:storyId/proof",children:Object(u.jsx)(tn,{})}),Object(u.jsx)(h.a,{path:"/stories/:storyId/test/:passageId",children:Object(u.jsx)(nn,{})}),Object(u.jsx)(h.a,{path:"/stories/:storyId/test",children:Object(u.jsx)(nn,{})}),Object(u.jsx)(h.a,{path:"/stories/:storyId",children:Object(u.jsx)(jt,{})}),Object(u.jsx)(h.a,{path:"*",render:function(e){return console.warn('No route for path "'.concat(e.location.pathname,'", rendering story list')),Object(u.jsx)(Kt,{})}})]}):Object(u.jsx)(sn,{})})},ln=n(61),dn=function(e){var t=e.children,n=r.useState(!1),a=Object(L.a)(n,2),o=a[0],c=a[1],s=r.useState(!1),i=Object(L.a)(s,2),l=i[0],d=i[1],b=Object(j.usePrefsContext)(),p=b.dispatch,m=b.prefs,h=Object(Y.useStoriesContext)().dispatch,O=Object(I.useStoryFormatsContext)(),g=O.dispatch,v=O.formats,y=Object(ln.a)(),x=y.prefs,w=y.stories,S=y.storyFormats;return r.useEffect((function(){o||(g({type:"init",state:S.load()}),p({type:"init",state:x.load()}),h({type:"init",state:w.load()}),c(!0))}),[g,o,x,p,w,h,S]),r.useEffect((function(){l||(p({type:"repair"}),g({type:"repair"}),h({type:"repair",allFormats:v,defaultFormat:Object(I.formatWithNameAndVersion)(v,m.storyFormat.name,m.storyFormat.version)}),d(!0))}),[g,v,p,m.storyFormat.name,m.storyFormat.version,l,w,h]),o&&l?Object(u.jsx)(u.Fragment,{children:t}):Object(u.jsx)(f,{})},fn=n(131);function jn(){var e=Object(fn.a)();return r.useEffect((function(){document.body.dataset.appTheme=e}),[e]),null}n(495),n(496),n(497);var bn=function(){return Object(u.jsx)(l,{children:Object(u.jsxs)(j.PrefsContextProvider,{children:[Object(u.jsx)(p,{}),Object(u.jsx)(jn,{}),Object(u.jsx)(I.StoryFormatsContextProvider,{children:Object(u.jsx)(Y.StoriesContextProvider,{children:Object(u.jsx)(dn,{children:Object(u.jsx)(r.Suspense,{fallback:Object(u.jsx)(f,{}),children:Object(u.jsx)(un,{})})})})})]})})};a.render(Object(u.jsx)(r.StrictMode,{children:Object(u.jsx)(bn,{})}),document.getElementById("root"))}],[[498,1,2]]]);
//# sourceMappingURL=main.160d2b12.chunk.js.map