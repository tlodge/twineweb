{"version":3,"sources":["store/stories/index.ts","components/control/icon-button.tsx","store/prefs/index.ts","components/container/button-bar/button-bar.tsx","components/container/button-bar/button-bar-separator.tsx","store/story-formats/index.ts","components/container/card/card-content.tsx","dialogs/index.ts","components/onstart/add-actions.tsx","components/control/text-input.tsx","components/container/dialog-card/dialog-card.tsx","components/container/dialog-card/dialog-editor.tsx","components/control/text-select.tsx","store/undoable-stories/index.ts","store/stories/defaults.ts","components/control/checkbox-button.tsx","util/geometry.ts","electron/shared/index.ts","store/persistence/persistable-changes.ts","util/caravan.ts","util/is-electron.ts","util/story-format/editor-extensions.ts","util/story-format/namespace.ts","components/image/icon/empty.tsx","components/image/icon/loading.tsx","components/image/icon/twine.tsx","components/image/icon/zoom-out.tsx","util/app-info.ts","components/control/card-button.tsx","util/publish.ts","util/tag.ts","store/prefs/defaults.ts","util/i18n.ts","components/control/code-area/code-area.tsx","components/control/menu-button.tsx","components/control/prompt-button.tsx","store/persistence/electron-ipc/prefs/load.ts","store/persistence/electron-ipc/save-json.ts","store/persistence/electron-ipc/prefs/save-middleware.ts","store/persistence/electron-ipc/stories/load.ts","store/persistence/electron-ipc/stories/save-middleware.ts","store/persistence/electron-ipc/stories/save-story.ts","store/persistence/electron-ipc/story-formats/load.ts","store/persistence/electron-ipc/story-formats/save-middleware.ts","store/persistence/local-storage/prefs/load.ts","store/persistence/local-storage/prefs/save-middleware.ts","store/persistence/local-storage/prefs/save.ts","store/persistence/local-storage/stories/save-middleware.ts","store/persistence/local-storage/stories/load.ts","store/persistence/local-storage/comma-list.ts","store/persistence/local-storage/stories/save.ts","store/persistence/local-storage/story-formats/load.ts","store/persistence/local-storage/story-formats/save.ts","store/persistence/local-storage/story-formats/save-middleware.ts","store/persistence/use-persistence.ts","store/persistence/electron-ipc/use-electron-ipc-persistence.ts","store/persistence/local-storage/use-local-storage-persistence.ts","components/control/icon-link.tsx","util/story-format/fetch-properties.ts","store/story-formats/defaults.ts","store/use-store-error-reporter.ts","util/color.ts","util/codemirror-options.ts","components/tag/add-tag-button.tsx","components/tag/tag-button.tsx","util/parse-links.ts","util/regexp.ts","components/codemirror/indent-buttons.tsx","store/stories/getters.ts","components/container/card/card.tsx","dialogs/context/dialogs.tsx","components/codemirror/undo-redo-buttons.tsx","components/tag/tag-stripe.tsx","dialogs/context/reducer.ts","dialogs/context/dialogs-context.tsx","util/import.ts","components/container/button-card.tsx","store/prefs/use-computed-theme.ts","components/passage/rename-passage-button.tsx","components/tag/tag-editor.tsx","components/meter/meter.tsx","store/format-loader.tsx","store/prefs/action-creators.ts","store/prefs/getters.ts","electron/shared/story-filename.ts","store/story-formats/action-creators.ts","store/story-formats/getters.ts","store/stories/zoom.ts","dialogs/app-donation.tsx","dialogs/passage-tags.tsx","dialogs/story-javascript.tsx","dialogs/story-search.tsx","dialogs/story-stylesheet.tsx","dialogs/story-tags.tsx","store/stories/action-creators/create-newly-linked-passages.ts","util/unused-name.ts","store/stories/action-creators/create-untitled-passage.ts","store/stories/action-creators/create-untitled-story.ts","store/stories/action-creators/delete-passage.ts","store/stories/action-creators/delete-story.ts","store/stories/action-creators/duplicate-story.ts","store/stories/action-creators/update-passage.ts","store/stories/action-creators/find-replace.ts","store/stories/action-creators/highlight-passages.ts","store/stories/action-creators/import-stories.ts","store/stories/action-creators/move-passages.ts","store/stories/action-creators/rename-passage-tag.ts","store/stories/action-creators/rename-story-tag.ts","store/stories/action-creators/select-passage.ts","store/stories/action-creators/select-story.ts","store/stories/action-creators/tag-color.ts","store/stories/action-creators/tag-passage.ts","store/stories/action-creators/update-story.ts","store/stories/reducer/create-passage.ts","store/stories/reducer/delete-passage.ts","store/stories/reducer/repair/repair-passage.ts","store/stories/reducer/repair/repair-story.ts","store/stories/reducer/update-passage.ts","store/stories/reducer/index.ts","store/stories/reducer/create-passages.ts","store/stories/reducer/create-story.ts","store/stories/reducer/delete-passages.ts","store/stories/reducer/delete-story.ts","store/stories/reducer/init.ts","store/stories/reducer/repair/repair-state.ts","store/stories/reducer/update-passages.ts","store/stories/reducer/update-story.ts","store/stories/stories-context.tsx","components/control/text-area.tsx","components/onstart/add-speech.tsx","components/rules/add-action.tsx","components/rules/actions.tsx","components/rules/add-button-rules.tsx","components/rules/add-speech-rules.tsx","components/rules/add-webhook-rules.tsx","components/rules/add-rules-button.tsx","dialogs/passage-edit/story-format-toolbar.tsx","store/use-format-codemirror-toolbar.ts","dialogs/passage-edit/passage-text.tsx","store/use-format-codemirror-mode.ts","components/onstart/add-onstart-button.tsx","dialogs/passage-edit/passage-edit.tsx","components/control/file-input.tsx","dialogs/story-import/file-chooser.tsx","dialogs/story-import/story-chooser.tsx","dialogs/story-import/story-import.tsx","store/undoable-stories/reverse-action.ts","store/undoable-stories/reverse-thunk.ts","store/undoable-stories/reducer.ts","store/undoable-stories/undoable-stories-context.tsx","components/story-format/story-format-select.tsx","dialogs/story-details/story-stats.tsx","dialogs/story-details/story-details.tsx","components/control/font-select.tsx","util/locales.ts","dialogs/app-prefs.tsx","store/prefs/prefs-context.tsx","store/prefs/reducer.ts","store/story-formats/story-formats-context.tsx","store/story-formats/reducer.ts","dialogs/about-twine/about-twine.tsx","components/global-error-boundary/global-error-boundary.tsx","components/loading-curtain/loading-curtain.tsx","store/locale-switcher.tsx","components/click-away-listener/click-away-listener.tsx","components/container/card-group.tsx","components/container/main-content.tsx","components/badge/badge.tsx","components/story-format/story-format-card/story-format-card-details.tsx","components/story-format/story-format-card/story-format-card.tsx","components/route-toolbar/back-button.tsx","components/route-toolbar/route-toolbar.tsx","store/use-publishing.ts","store/use-story-launch.ts","util/save-html.ts","route-actions/build-actions.tsx","route-actions/app-actions.tsx","routes/story-format-list/toolbar/formats/add-story-format-button.tsx","routes/story-format-list/toolbar/formats/default-story-format-button.tsx","routes/story-format-list/toolbar/formats/proofing-story-format-button.tsx","routes/story-format-list/toolbar/formats/remove-story-format-button.tsx","routes/story-format-list/toolbar/formats/story-format-extensions-button.tsx","routes/story-format-list/toolbar/formats/format-actions.tsx","routes/story-format-list/toolbar/view-actions.tsx","routes/story-format-list/toolbar/story-format-list-toolbar.tsx","routes/story-format-list/story-format-list-route.tsx","components/marquee-selection/marquee-selection.tsx","components/passage/passage-connections/broken-connection.tsx","util/svg.ts","components/passage/passage-connections/passage-connection.tsx","components/passage/passage-connections/self-connection.tsx","components/passage/passage-connections/passage-connection-group.tsx","components/passage/passage-connections/link-markers.tsx","components/passage/passage-connections/start-connection.tsx","store/use-format-reference-parser.ts","components/passage/passage-connections/passage-connections.tsx","components/passage/passage-card.tsx","components/passage/passage-card-group.tsx","components/passage/passage-map/passage-map.tsx","routes/story-edit/toolbar/passage/create-passage-button.tsx","routes/story-edit/toolbar/passage/delete-passages-button.tsx","routes/story-edit/toolbar/passage/edit-passages-buttons.tsx","routes/story-edit/toolbar/passage/select-all-passages-button.tsx","routes/story-edit/toolbar/passage/start-at-passage-button.tsx","routes/story-edit/toolbar/passage/test-passage-button.tsx","routes/story-edit/toolbar/passage/passage-actions.tsx","components/story/rename-story-button.tsx","routes/story-edit/toolbar/story/details-button.tsx","routes/story-edit/toolbar/story/find-replace-button.tsx","routes/story-edit/toolbar/story/javascript-button.tsx","routes/story-edit/toolbar/story/passage-tags-button.tsx","routes/story-edit/toolbar/story/stylesheet-button.tsx","routes/story-edit/toolbar/story/story-actions.tsx","routes/story-edit/toolbar/undo-redo-buttons.tsx","routes/story-edit/toolbar/story-edit-toolbar.tsx","routes/story-edit/zoom-buttons.tsx","routes/story-edit/story-edit-route.tsx","components/safari-warning/safari-warning-card.tsx","util/local-storage-quota.ts","components/storage-quota/storage-quota.tsx","routes/story-list/toolbar/library/archive-button.tsx","routes/story-list/toolbar/library/import-story-button.tsx","routes/story-list/toolbar/library/story-tags-button.tsx","routes/story-list/toolbar/library/library-actions.tsx","routes/story-list/toolbar/story/create-story-button.tsx","components/control/confirm-button.tsx","routes/story-list/toolbar/story/delete-story-button.tsx","routes/story-list/toolbar/story/duplicate-story-button.tsx","routes/story-list/toolbar/story/edit-story-button.tsx","routes/story-list/toolbar/story/tag-story-button.tsx","routes/story-list/toolbar/story/export-stories-button.tsx","routes/story-list/toolbar/story/story-actions.tsx","routes/story-list/toolbar/view/sort-by-button.tsx","routes/story-list/toolbar/view/tag-filter-button.tsx","routes/story-list/toolbar/view/view-actions.tsx","routes/story-list/toolbar/story-list-toolbar.tsx","util/hue-string.ts","components/story/story-preview.tsx","components/story/story-card.tsx","routes/story-list/story-cards.tsx","routes/story-list/story-list-route.tsx","store/prefs/use-donation-check.ts","util/replace-dom.ts","routes/story-play/story-play-route.tsx","routes/story-proof/story-proof-route.tsx","routes/story-test/story-test-route.tsx","components/welcome/welcome-card.tsx","routes/welcome/content.tsx","routes/welcome/welcome-route.tsx","routes/index.tsx","store/state-loader.tsx","store/theme-setter.tsx","app.tsx","index.tsx"],"names":["IconButton","React","props","ref","disabled","icon","iconOnly","iconPosition","onClick","preventDefault","variant","style","className","classNames","aria-label","label","undefined","e","ButtonBar","orientation","children","ButtonBarSeparator","CardContent","Method","TextInput","type","onChange","onInput","placeholder","value","helptext","fontSize","margin","DialogCard","collapsed","fixedSize","headerLabel","onChangeCollapsed","onClose","t","useTranslation","calcdClassName","role","floating","DialogEditor","TextSelect","options","map","option","passageDefaults","height","highlighted","left","name","i18n","selected","tags","text","deviceType","top","width","storyDefaults","ifid","lastUpdate","Date","passages","script","snapToGrid","startPassage","storyFormat","storyFormatVersion","stylesheet","tagColors","zoom","CheckboxButton","checkedIcon","uncheckedIcon","otherProps","calculatedIcon","aria-disabled","aria-checked","lineAngle","p1","p2","Math","atan2","PI","lineDistance","hypot","rectCenter","rect","rectFromPoints","rectsIntersect","r1","r2","rectIntersectionWithLine","segmentStart","segmentEnd","result","NaN","segseg","boundingRect","rects","length","Error","i","right","bottom","trivialPassageProps","trivialStoryProps","trivialStoryFormatProps","isPersistablePassageChange","Object","keys","some","key","includes","isPersistableStoryChange","isPersistableStoryFormatChange","extractType","toks","split","indexOf","typetoks","replace","trim","extractOnstart","substring","extractRulesText","parseSpeechLine","line","tokens","v","l","replaceAll","words","voice","rate","delay","extractParams","tuplestr","str","JSON","parse","err","console","log","formatURL","startsWith","URL","parseActionLine","params","si","ei","lastIndexOf","extractParamsString","paramobj","paramstr","parseErr","action","Number","stringify","method","POST","GET","NONE","extractSpeech","token","speech","extractActions","actions","_actions","parseRuleText","r","rtoks","operand","next","rule","operator","filter","extractRules","rules","endCondition","ruletxt","actionToString","sep","reduce","acc","a","actionsToString","s","extractWordsFromActions","body","w","extractWordsFromParams","extractWordsFromActionsArray","arr","extractWords","nodes","p","convertToObject","node","lookup","onstartspeechwords","onstart","onstartactionwords","rulewords","extractWordsFromNode","convertToString","speechFromNode","onStartFromNode","actionstr","rulesFromNode","onstarttext","convertToCaravanObject","_name","base","id","subscription","data","simplifyActions","simplifyAction","simplify","n","convertToCaravan","story","event","passage","start","events","isElectronRenderer","window","navigator","userAgent","formatEditorExtensions","format","twineVersion","loadState","properties","editorExtensions","twine","extensions","semverSpec","satisfies","warn","version","info","namespaceForFormat","toLowerCase","IconEmpty","viewBox","stroke","strokeWidth","fill","strokeLinecap","strokeLinejoin","IconLoading","IconTwine","xmlns","xmlnsXlink","offset","stopColor","stopOpacity","xlinkHref","x1","y1","x2","y2","gradientUnits","gradientTransform","d","transform","IconZoomOut","cx","cy","getAppInfo","process","CardButton","onChangeOpen","open","other","buttonEl","setButtonEl","cardEl","setCardEl","usePopper","strategy","styles","attributes","closer","target","parentNode","document","addEventListener","removeEventListener","in","mountOnEnter","timeout","unmountOnExit","popper","archiveFilename","timestamp","toLocaleString","publishArchive","stories","appInfo","output","publishStory","startOptional","publishPassage","localId","escape","toString","join","startLocalId","formatOptions","startId","find","passageData","forEach","index","tagData","tag","publishStoryWithFormat","formatSource","isValidTagName","test","defaults","appTheme","codeEditorFontFamily","codeEditorFontScale","disabledStoryFormatEditorExtensions","donateShown","editorCursorBlinks","firstRunTime","getTime","lastUpdateSeen","lastUpdateCheckTime","locale","userLanguage","language","browserLanguage","systemLanguage","passageEditorFontFamily","passageEditorFontScale","proofingFormat","storyFormatListFilter","storyListSort","storyListTagFilter","storyTagColors","welcomeSeen","i18next","createInstance","use","HttpBackend","initReactI18next","init","debug","backend","loadPath","fallbackLng","interpolation","escapeValue","load","CodeArea","fontFamily","fontScale","classnames","labelHidden","MenuButton","items","menuEl","setMenuEl","setOpen","item","separator","checked","PromptButton","cancelIcon","cancelLabel","onSubmit","prompt","submitIcon","submitLabel","submitVariant","validate","validation","setValidation","valid","updateValidation","message","twineElectron","prefKeys","hydrate","prefs","saveJson","filename","ipcRenderer","send","saveMiddleware","state","Array","isArray","file","importStories","htmlSource","mtime","lastState","saveStory","formats","formatWithNameAndVersion","source","fetchStoryFormatProperties","url","storyWithName","storyWithId","storyId","oldStory","newStory","once","passageUpdates","passageId","storyFormats","uuid","userAdded","serialized","localStorage","getItem","serializedPref","previouslySerialized","removeItem","ids","push","setItem","save","serializedStories","serializedStory","serializedPassages","serializedPassage","values","addUnique","list","RegExp","contains","remove","doUpdateTransaction","updater","transaction","passageIds","storyIds","savePassage","deletePassageById","passageWithName","deleteStory","passageWithId","serializedFormat","loadError","usePersistence","electronIpcPersistence","localStoragePersistence","IconLink","href","requestQueue","Promise","resolve","jsonpRequester","jsonp","reject","then","resolveQueue","builtins","useStoreErrorReporter","useSuspense","ready","reportError","error","messageKey","alert","colors","codeMirrorOptionsFromPrefs","extraKeys","Insert","cursorBlinkRate","AddTagButton","assignedTags","existingTags","onAdd","creatingTag","setCreatingTag","newColor","setNewColor","newName","setNewName","validationMessage","canAdd","tagName","color","TagButton","checkable","onChangeColor","onRemove","internalLinks","link","nonEmptyLinks","removeSetters","noSetter","getField","removeEnclosingBrackets","substr","fields","extractLink","tagContent","parseLinks","internalOnly","uniq","match","extractLinkTags","createRegExp","search","flags","useRegexes","escapeRegExp","matchCase","escapeRegExpReplace","IndentButtons","editor","execCommand","command","focus","passageName","passageConnections","connectionParser","parser","passageMap","Map","draggable","broken","Set","connections","self","fixed","targetName","add","targetPassage","get","has","set","passagesMatchingSearch","includePassageNames","matcher","storyPassageTags","from","sort","storyStats","links","brokenLinks","characters","count","storyTags","Card","DialogTransition","Dialogs","useScrollbarSize","useDialogsContext","dispatch","dialogs","marginBottom","marginRight","component","dialog","managementProps","UndoRedoButtons","watch","canRedo","setCanRedo","canUndo","setCanUndo","history","historySize","redo","undo","TagStripe","title","reducer","exists","editedState","stateDialog","isEqual","DialogsContext","displayName","DialogsContextProvider","useThunkReducer","Provider","selectors","float","stringValue","parseFloat","query","el","selector","querySelectorAll","parseDimensions","raw","bits","html","lastUpdateOverride","createElement","innerHTML","storyEl","importedStory","startPassagePid","getAttribute","startPassageId","textContent","passageEl","position","size","domToObject","ButtonCard","useComputedTheme","usePrefsContext","matchMedia","mediaQuery","matches","systemTheme","setSystemTheme","listener","DisabledRenamePassageButton","EnabledRenamePassageButton","onRename","RenamePassageButton","TagEditor","allTags","onChangeName","Meter","domId","percent","aria-labelledby","aria-valuemin","aria-valuemax","aria-valuenow","FormatLoader","block","seenFormats","setSeenFormats","useStoryFormatsContext","newFormats","newFormat","oldFormat","loadAllFormatProperties","loadingFormat","f","loadPercent","setPref","formatEditorExtensionsDisabled","storyFileName","createFromProperties","deleteFormat","deselectAllFormats","getFormats","deselectFormat","loadFormatThunk","hydrateResult","Function","call","toLoad","allSettled","loadFormatProperties","selectFormat","exclusive","getState","filteredFormats","semverLt","formatImageUrl","image","isAbsoluteUrl","formatWithId","sortFormats","b","minZoom","maxZoom","AppDonationDialog","PassageTagsDialog","useUndoableStoriesContext","setTagColor","handleChangeColor","renamePassageTag","handleChangeTagName","StoryJavaScriptDialog","cmEditor","setCmEditor","useStoriesContext","editorDidMount","onBeforeChange","updateStory","autofocus","mode","ignoreTab","Tab","StorySearchDialog","setFlags","setReplace","setFind","toggleFlag","highlightPassagesMatchingSearch","replaceInStory","StoryStylesheetDialog","StoryTagsDialog","storiesDispatch","prefsDispatch","renameStoryTag","createNewlyLinkedPassages","newText","oldText","oldLinks","toCreate","passageDefs","passageGap","newPassagesWidth","needsMoving","unusedName","existing","suffix","createUntitledPassage","centerX","centerY","isFinite","defs","bounds","max","round","createUntitledStory","deletePassages","duplicateStory","updatePassage","oldName","dontCreateNewlyLinkedPassages","oldNameEscaped","newNameEscaped","simpleLinkRegexp","compoundLinkRegexp","reverseLinkRegexp","relinkedPassage","searchFor","replaceWith","replacer","replaceInPassage","matchIds","oldHighlighted","newHighlighted","toImport","existingStories","importStory","otherStory","existingStory","movePassages","xChange","yChange","deselectPassage","selectAllPassages","selectPassage","selectPassagesInRect","ignoreIds","deselectStory","deselectAllStories","selectStory","addPassageTag","removePassageTag","createPassage","passageProps","storyExists","created","newState","newPassage","deletePassage","foundStory","deleted","logRepair","propName","repairedValue","detail","repairStory","allStories","allFormats","defaultFormat","storyDefs","repairs","newId","newIfid","entries","defKey","repairFormat","anyPassageRepaired","repairedPassages","repairedPassage","parentStory","pos","posKey","dim","dimKey","otherPassage","repairPassage","updated","createPassages","storyProps","toUpperCase","createStory","repairState","updatePassages","updatedStory","StoriesContext","StoriesContextProvider","storiesPersistence","persistedReducer","TextArea","rows","voices","AddSpeech","lines","lastline","setWords","setVoice","setRate","setDelay","lineIndex","setLineIndex","newlines","borderBottom","marginTop","audio","Audio","src","play","textAlign","paddingTop","maxWidth","overflow","slice","maxHeight","overflowY","renderLines","description","AddAction","_action","_setAction","setFile","mediaList","setMediaList","idx","_lookupaction","selectedActionProfile","setSelectedActionProfile","request","end","response","files","handleMethodChange","_method","setMethod","setParams","onFileChange","onFileUpload","formData","FormData","append","post","media","setAction","renderURL","renderMethod","paddingBottom","fontWeight","m","borderRadius","padding","_mediaparams","hex","_nanoparams","_hueparams","_messageparams","_printerparams","rotate","power","cool","to","powerlabels","display","flexDirection","isNaN","_fanparams","_speechparams","qrcode","_qrcodeparams","renderParams","_format","Actions","useState","setMode","actionIndex","setActionIndex","actionSubIndex","setActionSubIndex","close","addAction","aindex","subindex","alignItems","flex","onEdit","deleteAction","onDelete","borderLeft","marginLeft","editAction","addParallelAction","AddButtonRules","onCancel","setRules","removeAction","actionarr","j","newactions","updateAction","appendAction","rindex","_rules","renderNext","setNext","renderRule","setOperand","justifyContent","AddSpeechRules","AddWebhookRules","AddRulesButton","creatingStart","background","onSelect","StoryFormatToolbar","toolbarFactory","formatName","formatVersion","loaded","setLoaded","toolbarFunc","setToolbarFunc","extensionsDisabled","namespace","codeMirror","commands","commandName","namespacedCommand","CodeMirror","toolbar","environment","subitem","useFormatCodeMirrorToolbar","toolbarItems","setToolbarItems","alt","PassageText","onEditorChange","changePending","setChangePending","localText","setLocalText","setEditor","modeName","setModeName","defineMode","useFormatCodeMirrorMode","debouncedOnChange","debounce","setTimeout","refresh","lineWrapping","AddOnStartButton","setCreatingStart","startType","setStartType","setLines","setActions","InnerPassageEditDialog","handlePassageTextChange","handleAddStart","passageobj","passagetext","isStart","_updated","_node","handleChangeTagColor","PassageEditDialog","FileInput","onError","changeEvent","reader","FileReader","loadEvent","readAsText","FileChooser","accept","StoryChooser","onImport","selectedStories","setSelectedStories","willReplaceExisting","current","handleChange","StoryImportDialog","setStories","reverseAction","prop","passageResult","reverseThunk","thunk","actionOrThunk","newChange","storiesState","newChanges","changes","currentChange","min","change","UndoableStoriesContext","UndoableStoriesContextProvider","dispatchAndRecordStoryAction","redoLabel","undoLabel","StoryFormatSelect","selectedFormat","loadingFormats","loadingCount","dateFormatter","Intl","DateTimeFormat","dateStyle","timeStyle","StoryDetailsDialogStats","stats","date","rel","StoryDetailsDialog","families","scales","FontSelect","familyLabel","onChangeFamily","onChangeScale","scaleLabel","customScaleVisible","setCustomScaleVisible","customFamilyVisible","setCustomFamilyVisible","customFamily","setCustomFamily","customScale","setCustomScale","scale","parseInt","locales","code","AppPrefsDialog","PrefsContext","PrefsContextProvider","prefKey","defaultBuiltins","StoryFormatsContext","StoryFormatsContextProvider","builtinFormats","keep","builtinFormat","AboutTwineDialog","dangerouslySetInnerHTML","__html","credits","c","localizations","GlobalErrorBoundary","this","LoadingCurtain","LocaleSwitcher","changeLanguage","ClickAwayListener","ignoreSelector","onClickAway","closest","CardGroup","gridTemplateColumns","columnWidth","columns","MainContent","padded","Helmet","Badge","StoryFormatCardDetails","errorMessage","author","license","StoryFormatCard","editorExtensionsDisabled","proofing","BackButton","useHistory","location","pathname","goBack","RouteToolbar","helpUrl","pinnedControls","tabs","selectedTabClassName","tabName","tabContent","usePublishing","storyFormatsDispatch","proofStory","formatProperties","publishOptions","publishStoryData","useStoryLaunch","playStory","testStory","saveHtml","Blob","saveAs","BuildActions","json","jsonString","encodeURIComponent","download","click","exportData","AppActions","isValidUrl","AddStoryFormatButton","newFormatUrl","setNewFormatUrl","storyFormatName","DefaultStoryFormatButton","ProofingStoryFormatButton","RemoveStoryFormatButton","isDefault","isProofing","StoryFormatExtensionsButton","FormatActions","selectedFormats","ViewActions","setFilter","StoryFormatListToolbar","StoryFormatListRoute","formatsDispatch","visibleFormats","disabledFormat","handleSelect","relativeEventPosition","container","containerRect","getBoundingClientRect","clientX","scrollLeft","clientY","scrollTop","marqueeReducer","selecting","MarqueeSelection","ignoreEventsOnSelector","onSelectRect","currentContainer","handleMouseDown","shiftKey","ctrlKey","handleMouseMove","handleMouseUp","cleanUp","classList","lineOffset","sqrt","BrokenConnection","markerEnd","arc","radius","largeArc","sweep","rotation","PassageConnection","path","offsetStart","offsetEnd","startPoint","endPoint","distance","SelfConnection","PassageConnectionGroup","connection","LinkMarkers","refX","refY","markerWidth","markerHeight","orient","StartConnection","markerStart","emptyFunc","emptySet","noOffset","PassageConnections","referenceParser","setEditorExtensions","references","parsePassageText","useFormatReferenceParser","draggableLinks","fixedLinks","draggableReferences","fixedReferences","PassageCard","onDeselect","onDrag","onDragStart","onDragStop","excerpt","handleEdit","nodeRef","onMouseDown","onStart","onStop","onDoubleClick","PassageCardGroup","TransitionGroup","CSSTransition","dragReducer","dragging","dragX","x","dragY","y","startX","startY","callback","PassageMap","passageBounds","scaledWindowHeight","innerHeight","scaledWindowWidth","innerWidth","setProperty","handleDragStart","handleDrag","handleDragStop","CreatePassageButton","getCenter","handleClick","DeletePassagesButton","EditPassagesButton","SelectAllPassagesButton","StartAtPassageButton","TestPassageButton","PassageActions","selectedPassages","soloSelectedPassage","handleRename","DisabledRenameStoryButton","EnabledRenameStoryButton","RenameStoryButton","DetailsButton","FindReplaceButton","JavaScriptButton","PassageTagsButton","StylesheetButton","StoryActions","StoryEditToolbar","ZoomButtons","handleZoomChange","InnerStoryEditRoute","inited","setInited","dialogsDispatch","mainContent","useParams","undoableStoriesDispatch","clientWidth","clientHeight","handleDeselectPassage","handleDragPassages","abs","handleEditPassage","handleSelectPassage","handleSelectRect","logicalRect","center","StoryEditRoute","SafariWarningCard","browser","UAParser","getBrowser","safariNavigator","standalone","canAddToHomeScreen","localStorageUsedSpace","localStorageFreeSpace","chunkSize","intervalDelay","testString","repeat","usedChunks","interval","setInterval","clearInterval","StorageQuota","lastWatch","setLastWatch","working","setWorking","freeSpace","setFreeSpace","usedSpace","setUsedSpace","hide","run","ArchiveButton","ImportStoryButton","StoryTagsButton","LibraryActions","CreateStoryButton","ConfirmButton","confirmIcon","confirmLabel","confirmVariant","onConfirm","DeleteStoryButton","storyName","DuplicateStoryButton","EditStoryButton","TagStoryButton","tagColor","ExportStoriesButton","_stories","layer","selectedStory","SortByButton","TagFilterButton","StoryListToolbar","hueString","charCodeAt","StoryPreview","hues","minX","POSITIVE_INFINITY","minY","maxX","NEGATIVE_INFINITY","maxY","svg","circle","bgRadius","StoryCard","onChangeTagColor","onRemoveTag","StoryCards","onSelectStory","handleRemoveTag","InnerStoryListRoute","shouldShowDonationPrompt","now","useDonationCheck","visibleStories","filteredStories","sortBy","StoryListRoute","replaceDom","SVG","Store","StoryFormat","amdDefine","app","jQuery","write","StoryPlayRoute","StoryProofRoute","StoryTestRoute","WelcomeCard","nextLabel","onNext","onSkip","showSkip","content","WelcomeRoute","containerEl","shown","setShown","allCards","visibleCards","lastCard","querySelector","scroll","documentElement","offsetTop","duration","finish","showNext","card","Routes","exact","render","StateLoader","repaired","setRepaired","prefsState","formatsState","ThemeSetter","computedTheme","dataset","App","fallback","ReactDOM","getElementById"],"mappings":"iGAAA,kjE,8BCAA,8EAiBaA,EAAaC,cACzB,SAACC,EAAOC,GAAS,IAEfC,EAQGF,EARHE,SACAC,EAOGH,EAPHG,KACAC,EAMGJ,EANHI,SAJc,EAUXJ,EALHK,oBALc,MAKC,QALD,EAMdC,EAIGN,EAJHM,QACAC,EAGGP,EAHHO,eAPc,EAUXP,EAFHQ,eARc,MAQJ,YARI,IAUXR,EADHS,aATc,MASR,GATQ,EAYTC,EAAYC,IACjB,cAD2B,wBAEVN,GAFU,kBAGhBG,GACX,CAAC,YAAaJ,IAWf,OACC,yBACCQ,aAAYR,EAAWJ,EAAMa,WAAQC,EACrCZ,SAAUA,EACVQ,UAAWA,EACXJ,QAboB,SAACS,GACtBT,GAAWA,EAAQS,GAEfR,GACHQ,EAAER,kBAUFN,IAAKA,EACLQ,MAAOA,EANR,UAQC,sBAAMC,UAAU,OAAhB,SAAwBP,KACtBC,GAAYJ,EAAMa,a,8BCvDxB,yQ,4ICQaG,EAAsC,SAAAhB,GAAK,aACvD,qBACCU,UAAWC,IACV,aADoB,gCAELX,EAAMiB,mBAFD,QAEgB,eAHtC,SAMEjB,EAAMkB,YCZIC,G,OAA+B,kBAC3C,qBAAKT,UAAU,4B,6BCJhB,mxB,6ICOaU,EAA0C,SAACpB,GAAW,IAAD,EACrCA,EAArBS,aAD0D,MACpD,GADoD,EAChDS,EAAWlB,EAAXkB,SACjB,OAAO,qBAAKR,UAAU,eAAeD,MAAK,eAAMA,GAAzC,SAAkDS,K,sCCT1D,knD,oECeYG,E,4CAAAA,K,YAAAA,E,UAAAA,E,SAAAA,M,sCCfZ,4EAeaC,EAAsC,SAAAtB,GAAU,IAAD,EACrDU,EAAYC,IACjB,aAD2B,sBAEZX,EAAMiB,aAFM,eAGnBjB,EAAMuB,OAGf,OACC,qCACA,sBAAMb,UAAWA,EAAjB,SACC,kCACEV,EAAMkB,UAAY,sBAAMR,UAAU,mBAAhB,SAAoCV,EAAMkB,WAC7D,uBACCM,SAAUxB,EAAMwB,SAChBC,QAASzB,EAAMyB,QACfC,YAAa1B,EAAM0B,YACnBH,KAAI,UAAEvB,EAAMuB,YAAR,QAAgB,OACpBI,MAAO3B,EAAM2B,MACblB,MAAOT,EAAMS,OAAS,UAIxBT,EAAM4B,UAAY,qBAAKnB,MAAO,CAACoB,SAAS,QAASC,OAAO,qBAAtC,SAA6D9B,EAAM4B,UAAU,U,0KCpBrFG,EAAwC,SAAA/B,GAAU,IAE7DkB,EAOGlB,EAPHkB,SACAR,EAMGV,EANHU,UACAsB,EAKGhC,EALHgC,UACAC,EAIGjC,EAJHiC,UACAC,EAGGlC,EAHHkC,YACAC,EAEGnC,EAFHmC,kBACAC,EACGpC,EADHoC,QAEMC,EAAKC,cAALD,EAEDE,EAAiB5B,IAAW,cAAeD,EAAW,CAC3DsB,YACA,aAAcC,IAGf,OACC,qBAAKrB,aAAYsB,EAAaM,KAAK,SAAS9B,UAAW6B,EAAvD,SACC,eAAC,IAAD,CAAME,UAAQ,EAAd,UACC,+BACC,qBAAK/B,UAAU,qBAAf,SACC,cAAC,IAAD,CACCP,KAAM6B,EAAY,cAAC,IAAD,IAAoB,cAAC,IAAD,IACtCnB,MAAOqB,EACP5B,QAAS,kBAAM6B,GAAmBH,QAGpC,qBAAKtB,UAAU,8BAAf,SACC,cAAC,IAAD,CACCP,KAAM,cAAC,IAAD,IACNC,UAAQ,EACRS,MAAOwB,EAAE,gBACT/B,QAAS8B,UAIVJ,GAAad,QCnDNwB,G,OAAyB,SAAA1C,GAAK,OAC1C,qBAAKU,UAAU,gBAAf,SAAgCV,EAAMkB,c,6BCJvC,4EAkBayB,EAAwC,SAAA3C,GAAU,IACvDkB,EAAmDlB,EAAnDkB,SAAUM,EAAyCxB,EAAzCwB,SAAUoB,EAA+B5C,EAA/B4C,QAAS3B,EAAsBjB,EAAtBiB,YAAaU,EAAS3B,EAAT2B,MAC3CjB,EAAYC,IACjB,cAD2B,6BAEZM,QAFY,IAEZA,IAAe,eAG/B,OACC,sBAAMP,UAAWA,EAAjB,SACC,kCACC,sBAAMA,UAAU,oBAAhB,SAAqCQ,IACrC,sBAAMR,UAAU,sBAAhB,SACC,wBAAQc,SAAUA,EAAUG,MAAOA,EAAnC,SACEiB,EAAQC,KAAI,SAAAC,GAAM,OAClB,wBACC5C,SAAU4C,EAAO5C,SAEjByB,MAAOmB,EAAOnB,MAHf,SAKEmB,EAAOjC,OAHHiC,EAAOnB,qB,6BClCpB,kJ,+BCAA,wFAIaoB,EAAkB,iBAAsC,CACpEC,OAAQ,IACRC,aAAa,EACbC,KAAM,EACNC,KAAMC,IAAKf,EAAE,8BACbgB,UAAU,EACVC,KAAM,GACNC,KAAMH,IAAKf,EACK,cAAfmB,IACG,kCACA,mCAEJC,IAAK,EACLC,MAAO,MAGKC,EAAgB,iBAA0B,CACtDC,KAAM,GACNC,WAAY,IAAIC,KAChBC,SAAU,GACVZ,KAAMC,IAAKf,EAAE,4BACb2B,OAAQ,GACRX,UAAU,EACVY,YAAY,EACZC,aAAc,GACdC,YAAa,GACbC,mBAAoB,GACpBC,WAAY,GACZf,KAAM,GACNgB,UAAW,GACXC,KAAM,K,8GCrBMC,EAAgD,SAAAxE,GAAU,IAErEyE,EAMGzE,EANHyE,YACAtE,EAKGH,EALHG,KACAqB,EAIGxB,EAJHwB,SACAkD,EAGG1E,EAHH0E,cACA/C,EAEG3B,EAFH2B,MACGgD,EAPiE,YAQjE3E,EARiE,2DAS/D4E,EAAiBjD,EAAK,OACzB8C,QADyB,IACzBA,IAAe,cAAC,IAAD,IADU,OAEzBC,QAFyB,IAEzBA,IAAiB,cAAC,IAAD,IAEpB,OACC,sBACCG,gBAAeF,EAAWzE,SAC1BQ,UAAU,kBACV8B,KAAK,WACLsC,eAAcnD,EAJf,SAMC,cAAC,IAAD,aACCxB,KAAI,OAAEA,QAAF,IAAEA,IAAQyE,EACdtE,QAAS,kBAAMkB,GAAUG,KACrBgD,Q,+RCpBD,SAASI,EAAUC,EAAWC,GACpC,OAAyD,IAAjDC,KAAKC,MAAMF,EAAGxB,IAAMuB,EAAGvB,IAAKwB,EAAG/B,KAAO8B,EAAG9B,MAAegC,KAAKE,GAM/D,SAASC,EAAaL,EAAWC,GACvC,OAAOC,KAAKI,MAAMN,EAAG9B,KAAO+B,EAAG/B,KAAM8B,EAAGvB,IAAMwB,EAAGxB,KAM3C,SAAS8B,EAAWC,GAC1B,MAAO,CAACtC,KAAMsC,EAAKtC,KAAOsC,EAAK9B,MAAQ,EAAGD,IAAK+B,EAAK/B,IAAM+B,EAAKxC,OAAS,GAOlE,SAASyC,EAAeT,EAAWC,GACzC,IAAMO,EAAa,CAACxC,OAAQ,EAAGE,KAAM,EAAGO,IAAK,EAAGC,MAAO,GAkBvD,OAhBIsB,EAAG9B,KAAO+B,EAAG/B,MAChBsC,EAAKtC,KAAO8B,EAAG9B,KACfsC,EAAK9B,MAAQuB,EAAG/B,KAAO8B,EAAG9B,OAE1BsC,EAAKtC,KAAO+B,EAAG/B,KACfsC,EAAK9B,MAAQsB,EAAG9B,KAAO+B,EAAG/B,MAGvB8B,EAAGvB,IAAMwB,EAAGxB,KACf+B,EAAK/B,IAAMuB,EAAGvB,IACd+B,EAAKxC,OAASiC,EAAGxB,IAAMuB,EAAGvB,MAE1B+B,EAAK/B,IAAMwB,EAAGxB,IACd+B,EAAKxC,OAASgC,EAAGvB,IAAMwB,EAAGxB,KAGpB+B,EAOD,SAASE,EAAeC,EAAUC,GACxC,QACCA,EAAG1C,KAAOyC,EAAGzC,KAAOyC,EAAGjC,OACvBkC,EAAG1C,KAAO0C,EAAGlC,MAAQiC,EAAGzC,MACxB0C,EAAGnC,IAAMkC,EAAGlC,IAAMkC,EAAG3C,QACrB4C,EAAGnC,IAAMmC,EAAG5C,OAAS2C,EAAGlC,KAQnB,SAASoC,EACfL,EACAM,EACAC,GAEA,IAAIC,EAAuB,CAACC,IAAKA,KAIjC,OACCC,YACCF,EACA,CAACR,EAAKtC,KAAMsC,EAAK/B,KACjB,CAAC+B,EAAKtC,KAAMsC,EAAK/B,IAAM+B,EAAKxC,QAC5B,CAAC8C,EAAa5C,KAAM4C,EAAarC,KACjC,CAACsC,EAAW7C,KAAM6C,EAAWtC,OAY9ByC,YACCF,EACA,CAACR,EAAKtC,KAAOsC,EAAK9B,MAAO8B,EAAK/B,KAC9B,CAAC+B,EAAKtC,KAAOsC,EAAK9B,MAAO8B,EAAK/B,IAAM+B,EAAKxC,QACzC,CAAC8C,EAAa5C,KAAM4C,EAAarC,KACjC,CAACsC,EAAW7C,KAAM6C,EAAWtC,OAY9ByC,YACCF,EACA,CAACR,EAAKtC,KAAMsC,EAAK/B,KACjB,CAAC+B,EAAKtC,KAAOsC,EAAK9B,MAAO8B,EAAK/B,KAC9B,CAACqC,EAAa5C,KAAM4C,EAAarC,KACjC,CAACsC,EAAW7C,KAAM6C,EAAWtC,OAY9ByC,YACCF,EACA,CAACR,EAAKtC,KAAMsC,EAAK/B,IAAM+B,EAAKxC,QAC5B,CAACwC,EAAKtC,KAAOsC,EAAK9B,MAAO8B,EAAK/B,IAAM+B,EAAKxC,QACzC,CAAC8C,EAAa5C,KAAM4C,EAAarC,KACjC,CAACsC,EAAW7C,KAAM6C,EAAWtC,MAhDvB,CACNP,KAAM8C,EAAO,GACbvC,IAAKuC,EAAO,IAuDP,KAMD,SAASG,EAAaC,GAC5B,GAAqB,IAAjBA,EAAMC,OACT,MAAM,IAAIC,MAAM,6CAKjB,IAFA,IAAMN,EAAM,eAAOI,EAAM,IAEhBG,EAAI,EAAGA,EAAIH,EAAMC,OAAQE,IAAK,CACtC,IAAMC,EAAQJ,EAAMG,GAAGrD,KAAOkD,EAAMG,GAAG7C,MACjC+C,EAASL,EAAMG,GAAG9C,IAAM2C,EAAMG,GAAGvD,OAEnCoD,EAAMG,GAAGrD,KAAO8C,EAAO9C,OAC1B8C,EAAO9C,KAAOkD,EAAMG,GAAGrD,MAGpBkD,EAAMG,GAAG9C,IAAMuC,EAAOvC,MACzBuC,EAAOvC,IAAM2C,EAAMG,GAAG9C,KAGnBuC,EAAO9C,KAAO8C,EAAOtC,MAAQ8C,IAChCR,EAAOtC,MAAQ8C,EAAQR,EAAO9C,MAG3B8C,EAAOvC,IAAMuC,EAAOhD,OAASyD,IAChCT,EAAOhD,OAASyD,EAAST,EAAOvC,KAIlC,OAAOuC,I,6BC1LR,+J,+BCGA,0GAAMU,EAAyC,CAAC,cAAe,YACzDC,EAAqC,CAAC,aAAc,YAGpDC,EAAoC,CACzC,YACA,YACA,aACA,YAMM,SAASC,EAA2B7G,GAC1C,OAAO8G,OAAOC,KAAK/G,GAAOgH,MACzB,SAAAC,GAAG,OAAKP,EAAoBQ,SAASD,MAOhC,SAASE,EAAyBnH,GACxC,OAAO8G,OAAOC,KAAK/G,GAAOgH,MACzB,SAAAC,GAAG,OAAKN,EAAkBO,SAASD,MAO9B,SAASG,EAA+BpH,GAC9C,OAAO8G,OAAOC,KAAK/G,GAAOgH,MACzB,SAAAC,GAAG,OAAKL,EAAwBM,SAASD,Q,8MCVrCI,EAAc,SAAC9D,GAEjB,IADA,IAAM+D,EAAO/D,EAAKgE,MAAM,MACfhB,EAAI,EAAGA,EAAIe,EAAKjB,OAAQE,IAC7B,IAAiC,GAA7Be,EAAKf,GAAGiB,QAAQ,SAAe,CAC/B,IAAMC,EAAWH,EAAKf,GAAGgB,MAAM,KAC/B,OAAIE,EAASpB,OAAS,EACXoB,EAAS,GAAGC,QAAQ,IAAI,IAAIC,OAChC,SAGf,MAAO,UAGLC,EAAiB,SAACrE,GACpB,OAAmC,IAA/BA,EAAKiE,QAAQ,aACNjE,EAAKsE,UAAUtE,EAAKiE,QAAQ,cAAcD,MAAM,WAAW,GAAGG,QAAQ,YAAY,IAAIC,OAE1F,IAGLG,EAAmB,SAACvE,GACtB,OAAiC,IAA7BA,EAAKiE,QAAQ,WACNjE,EAAKsE,UAAUtE,EAAKiE,QAAQ,YAAYE,QAAQ,UAAU,IAAIC,OAGlE,IAGLI,EAAkB,SAACC,GAErB,IACMC,EADeD,EAAKN,QAAQ,YAAY,SAAAQ,GAAC,OAAEA,EAAER,QAAQ,KAAM,QACnCA,QAAQ,WAAW,IAAIA,QAAS,QAAQ,IAAIA,QAAQ,OAAO,IAAIC,OAAOJ,MAAM,KAAK1E,KAAI,SAAAsF,GAAC,OAAEA,EAAEC,WAAW,IAAI,QAEvI,MAAO,CACHC,MAAMJ,EAAO5B,OAAS,EAAI4B,EAAO,GAAGN,OAAQ,GAC5CW,MAAML,EAAO5B,OAAS,EAAI4B,EAAO,GAAGN,OAA9B,UAtDO,UAuDbY,KAAKN,EAAO5B,OAAU,EAAI4B,EAAO,GAAGN,OAA/B,UAzDQ,KA0Dba,MAAMP,EAAO5B,OAAS,EAAI4B,EAAO,GAAGN,OAA9B,UAzDQ,KA6DhBc,EAAgB,WAA8C,IAA7CC,EAA4C,uDAA5B,KAC7BC,EAAMD,EAAShB,QAAS,OAAO,KAAKA,QAAQ,OAAO,KACzD,IACI,OAAOkB,KAAKC,MAAMF,GACrB,MAAMG,GACHC,QAAQC,IAAI,gBAAiBF,GAEjC,MAAO,IAULG,EAAY,SAACN,GACf,GAAIA,EAAIO,WAAW,QACf,IACI,OAAO,IAAIC,IAAIR,GAClB,MAAMG,IAIX,OAAOH,GAGLS,EAAkB,SAACpB,GACrB,IAAMqB,EAnBkB,SAACV,GACzB,IAAMrB,EAAOqB,EAAIhB,OAAOE,UAAU,EAAGc,EAAIhB,OAAOtB,OAAO,GACjDiD,EAAKhC,EAAKE,QAAQ,KAClB+B,EAAKjC,EAAKkC,YAAY,KAC5B,OAAOF,GAAM,GAAKC,GAAM,EAAIjC,EAAKO,UAAUyB,EAAGC,EAAG,GAAK,GAevCE,CAAoBzB,GAC7BV,EAAOU,EAAKN,QAAQ2B,EAAO,IAAI3B,QAAS,QAAQ,IAAIA,QAAQ,OAAO,IAAIC,OAAOJ,MAAM,KAG1F,GAAID,EAAKjB,OAAS,EAAE,CAEhB,IAAIqD,EAAW,GAGTC,GAAYN,GAAQ,MAAM3B,QAAQ,OAAO,KAAKA,QAAQ,OAAO,KAGnE,IACIgC,EAAWd,KAAKC,MAAMc,GACzB,MAAMb,GACHY,EAAW,CAACE,SAASD,GAGzB,MAAO,CACHE,OAAQZ,EAAU3B,EAAK,IACvBkB,MAAOlB,EAAKjB,OAAS,EAAIyD,OAAOxC,EAAK,GAAGK,QAAU,EAClD0B,OAAQ/B,EAAKjB,OAAS,EAAIuC,KAAKmB,UAAUL,GAAY,KACrDM,OAAQ1C,EAAKjB,OAAS,EAAgB,SAAZiB,EAAK,GAAgBjG,IAAO4I,KAAO5I,IAAO6I,IAAM7I,IAAO8I,MAGzF,MAAO,CAACN,OAAO,KAGbO,EAAgB,SAAC7G,GASnB,IAPA,IAIsB8G,EAJhB/C,EAAO/D,EAAKgE,MAAM,MACpBS,EAAO,EACPsC,EAAkB,GAKftC,EAAOV,EAAKjB,QAAO,CACtB,GAAIiB,EAAKU,GAAML,OAAOuB,WAAW,YAC7B,OAASlB,EAAOV,EAAKjB,QAJD,MADNgE,EAMQ/C,EAAKU,IALlBL,SAAyC,IAAxB0C,EAAM7C,QAAQ,MAMhC8C,EAAM,sBAAOA,GAAP,CAAevC,EAAgBT,EAAKU,MAMtDA,GAAO,EAEX,OAAOsC,GAGLC,EAAiB,SAAChH,GAYpB,IATA,IAIsB8G,EAJhB/C,EAAO/D,EAAKgE,MAAM,MACpBS,EAAO,EACPwC,EAAqB,GAOlBxC,EAAOV,EAAKjB,QAEf,GAAIiB,EAAKU,GAAML,OAAOuB,WAAW,YAAY,CAEzC,IADA,IAAIuB,EAAoB,KACfzC,EAAOV,EAAKjB,QARD,MADNgE,EAWQ/C,EAAKU,IAVlBL,SAAiB0C,EAAM1C,OAAOuB,WAAW,MAW1CuB,EAAQ,sBAAOA,GAAP,CAAiBrB,EAAgB9B,EAAKU,MAKtDwC,EAAO,sBAAOA,GAAP,CAAgBC,SAGvBzC,GAAO,EAIf,OAAOwC,GAGLE,EAAgB,SAACnH,EAAahC,GAAuB,IAAD,EACjCgC,EAAKgE,MAAM,aADsB,mBAC/CoD,EAD+C,KAC5CH,EAD4C,KAIhDI,EAAQD,EAAEjD,QAAQ,KAAK,IAAIA,QAAQ,KAAK,IAAIH,MAAM,KAJF,EAKjCqD,EAAM,GAAGjD,OAAOJ,MAAM,KALW,sBAK/CsD,OAL+C,MAKvC,GALuC,EAMhDC,EAAOF,EAAMvE,OAAS,EAAIuE,EAAM,GAAKC,EAC3C,MAAQ,CACJE,KAAK,CACDC,SAAiB,WAAPzJ,EAAkB,WAAa,SAEzCsJ,QAAiB,WAAPtJ,EAAiBsJ,EAAQnD,QAAQ,OAAO,IAAIH,MAAM,KAAK0D,QAAO,SAAA5I,GAAC,MAAa,KAAXA,EAAEsF,UAAekD,EAAQnD,QAAQ,OAAO,KAEvHoD,KAAMA,EAAKnD,OACX6C,QAAUD,GAAgBC,GAAS,IAAI7C,UAIzCuD,EAAe,SAAC3H,GAQlB,IAR+D,IAAhChC,EAA+B,uDAAnB,SACrC+F,EAAO/D,EAAKoE,OAAOD,QAAQ,UAAU,IAAIH,MAAM,MACjDS,EAAO,EACPmD,EAAgB,GAEdC,EAAe,SAACf,GAClB,OAA8D,IAA5BA,EAAM7C,QAAQ,UAE7CQ,EAAOV,EAAKjB,QACf,GAAIiB,EAAKU,GAAML,OAAOuB,WAAW,SAAS,CACtC,IAAImC,EAAU,GADwB,EAEpB/D,EAAKU,GAAMN,QAAQ,IAAI,IAAIA,QAAQ,IAAI,IAAIH,MAAM,KAF7B,mBAItC,IAJsC,YAI7BS,EAAOV,EAAKjB,SACZ+E,EAAa9D,EAAKU,KACnBqD,GAAO,YAAS/D,EAAKU,IAK7BmD,EAAK,sBAAOA,GAAP,CAAcT,EAAcW,EAAQ1D,OAAQpG,UAEjDyG,GAAO,EAGf,OAAOmD,GASLG,EAAiB,SAACd,GAAgD,IAA9Be,EAA6B,uDAAlB,SACjD,OAAQf,GAAW,IAAIgB,QAAO,SAACC,EAAWC,GACtC,MAAM,GAAN,OAAUD,GAAV,OAAgBF,EAAhB,aAAwBG,EAAE7B,OAA1B,cAAsC6B,EAAElD,OAAO,EAA/C,cAAmEkD,EAAErC,OAArE,cAAkFqC,EAAE1B,OAApF,UACF,KAGA2B,EAAkB,SAACnB,GAAiD,IAA7Be,EAA4B,uDAAjB,OACpD,OAAQf,GAAW,IAAIgB,QAAO,SAACC,EAAWG,GACtC,MAAM,GAAN,OAAUH,EAAV,aAAkBF,EAAlB,qBAAkCD,EAAeM,EAAD,UAAOL,EAAP,UAClD,KAwCAM,EAA0B,SAACrB,GAC7B,OAAOA,EAAQgB,QAAO,SAACC,EAAc5B,GACjC,MAAsB,QAAlBA,EAAOA,OACD,GAAN,mBAAW4B,GAAX,YAbmB,WAAgC,IAAD,EACzChD,EADyC,uDAAhB,MAEnCqD,KAFmD,cAE9C,GAF8C,GAGnDxB,OAEP,YAL0D,MAG5C,GAH4C,GAK5CzH,KAAI,SAACkJ,GAAD,OAA6BA,EAAE1D,SAQtB2D,CAAuBnC,EAAOR,UAE9CoC,IACT,KAGAQ,EAA+B,SAACzB,GAClC,OAAQA,GAAS,IAAIgB,QAAO,SAACC,EAAcS,GACvC,MAAM,GAAN,mBAAWT,GAAX,YAAmBI,EAAwBK,OAC7C,KAYC,SAASC,EAAapI,GACzB,IAAMqI,EAAerI,EAASlB,KAAI,SAAAwJ,GAAC,OAAEC,EAAgBD,MAGrD,OAAOD,EAAMZ,QAAO,SAACC,EAA0Bc,GAC3C,MAAM,GAAN,mBAAWd,GAAX,YAdqB,SAACc,EAAWC,GACrC,IAAMC,EAAkB,aAASF,EAAKG,QAAQpC,QAAU,IAAIzH,KAAI,SAAA+I,GAAC,OAAEA,EAAEvD,UAC/DsE,EAAkB,YAAQV,EAA6BM,EAAKG,QAAQlC,SAAS,KAC7EoC,GAAaL,EAAKpB,OAAS,IAAIK,QAAO,SAACC,EAAcV,GACvD,MAAM,GAAN,mBAAWU,GAAX,YAAmBQ,EAA6BlB,EAAKP,aACvD,IACF,MAAM,GAAN,mBAAWiC,GAAX,YAAkCE,GAAlC,YAAyDC,IAQlCC,CAAqBN,OAC1C,IAIC,SAASO,EAAgBP,GAC5B,MAAM,SAAN,OAAgBA,EAAKhL,KAArB,6BAlEoB,SAACgL,GACrB,MAAM,eAAN,OAPmB,SAACA,GACpB,OAAQA,EAAKG,QAAQpC,QAAU,IAAIkB,QAAO,SAACC,EAAWG,GAClD,MAAM,GAAN,OAAUH,EAAV,eAAoBG,EAAEvD,MAAtB,cAAiCuD,EAAEtD,MAAnC,cAA8CsD,EAAErD,KAAhD,cAA0DqD,EAAEpD,MAA5D,UACF,IAIoBuE,CAAeR,GAArC,0BAA4DZ,EAAgBY,EAAKG,QAAQlC,SAAW,KAiEtDwC,CAAgBT,GAA9D,sBA9DkB,SAACA,GACnB,OAAOA,EAAKpB,MAAMK,QAAO,SAACC,EAAYV,GAClC,IAAMkC,EAAalC,EAAKP,SAAWO,EAAKP,QAAQnE,OAAS,EAAvC,yBAA8DsF,EAAgBZ,EAAKP,QAAS,WAAY,GAC1H,MAAM,GAAN,OAAUiB,EAAV,6BAAkCV,EAAKA,KAAKF,QAA5C,YAAuDE,EAAKD,KAAKnD,OAAjE,aAA4EsF,KAC9E,IA0D+EC,CAAcX,IAG5F,SAASD,EAAgB/I,GAE5B,IAAMhC,EAAO8F,EAAY9D,GACnB4J,EAAcvF,EAAerE,GAKnC,MAAO,CACHhC,OACAmL,QAAU,CACNpC,OAPOF,EAAc+C,GAQrB3C,QAPQD,EAAe4C,IAS3BhC,MARUD,EAAapD,EAAiBvE,GAAMhC,IAYtD,IAAM6L,EAAyB,SAACC,EAAc9J,GAC1C,IAAMJ,EAAOkK,EACP9L,EAAO8F,EAAY9D,GACnB4J,EAAcvF,EAAerE,GAC7B+G,EAASF,EAAc+C,GACvB3C,EAAUD,EAAe4C,GACzBhC,EAAQD,EAAapD,EAAiBvE,GAAMhC,GAE5C+L,EAAO,CACT/L,OACA4B,OACAoK,GAAGpK,EACHqK,aAAuB,WAATjM,EAAoB,UAAqB,WAATA,EAAoB,SAAW,WAC7EmL,QAAU,CACNpC,SACAE,WAEJW,SAEJ,MAAW,WAAP5J,EACO+L,EAEJ,2BACDA,GADN,IAEGG,KAAMtC,EAAMtI,KAAI,SAAA8H,GAAC,OAAEA,EAAEI,KAAKF,cAwC3B6C,EAAkB,SAAClD,GACrB,OAAOA,EAAQ3H,KAAI,SAAA6I,GAAC,OAxBD,SAACA,GACpB,IAAI7B,EAAS,CACTA,OAAQ6B,EAAE7B,OACVR,OAAQ,GACRW,OAAQ,GACRxB,MAAO,GAgBX,OAbIkD,EAAErC,QAAUvC,OAAOC,KAAK2E,EAAErC,QAAQhD,OAAS,IAC3CwD,EAAM,2BACCA,GADD,IAEFR,OAAQT,KAAKC,MAAM6C,EAAErC,QACrBW,OAAQ0B,EAAE1B,eAGFlJ,IAAZ4K,EAAElD,OAAuBkD,EAAElD,MAAQ,IACnCqB,EAAM,2BACCA,GADD,IAEFrB,MAAOkD,EAAElD,SAGVqB,EAGe8D,CAAejC,OASnCkC,EAAW,SAACxB,GACd,OAAOA,EAAMvJ,KAAI,SAACgL,GACd,OAAO/G,OAAOC,KAAK8G,GAAGrC,QAAO,SAACC,EAAKxE,GAC/B,MAAY,YAARA,EACO,2BAAIwE,GAAX,IAAgBiB,SAjDPA,EAiD+BmB,EAAEnB,QAhD/C5F,OAAOC,KAAK2F,GAASlB,QAAO,SAACC,EAAKxE,GACrC,MAAY,WAARA,GAAoByF,EAAQzF,IAAQyF,EAAQzF,GAAKZ,OAAS,EACnD,2BAAIoF,GAAX,kBAAiBxE,EAAMyF,EAAQzF,KAEvB,YAARA,GAAqByF,EAAQzF,GAAKZ,OAAS,GAAKqG,EAAQzF,GAAK,GAAGZ,OAAS,EAClE,2BAAIoF,GAAX,kBAAiBxE,EAAMyF,EAAQzF,GAAKpE,KAAI,SAAC6I,GAAD,OAAcgC,EAAgBhC,QAEnED,IACT,OA0CkB,UAARxE,EACO,2BAAIwE,GAAX,IAAgBN,OAbTA,EAa6B0C,EAAE1C,MAZ3CA,EAAMK,QAAO,SAACC,EAASV,GAC1B,MAAM,GAAN,mBAAWU,GAAX,4BAAmBV,GAAnB,IAAyBP,QAAQO,EAAKP,QAAQ3H,KAAI,SAAA6I,GAAC,OAAEgC,EAAgBhC,YACvE,OAYa,2BAAID,GAAX,kBAAiBxE,EAAK4G,EAAE5G,KAtDZ,IAACyF,EAuCFvB,IAgBb,QAIH,SAAS2C,EAAiBC,GAAc,IAAD,EACHA,GAAS,GAAzChK,EADmC,EACnCA,SAAUG,EADyB,EACzBA,aAAcf,EADW,EACXA,KAK3B6K,EAAQ,GAEN5B,GAASrI,GAAU,IAAIyH,QAAO,SAACC,EAASwC,GAI1C,OAHIA,EAAQV,KAAOrJ,IACf8J,EAAQC,EAAQ9K,MAEhB8K,EAAQ1K,MAA6C,KAApC0K,EAAQ1K,KAAKmE,QAAQ,MAAO,OARX,KADjBnE,EAS0D0K,EAAQ1K,MAR3EiE,QAAQ,eAAsD,IAA/BjE,EAAKiE,QAAQ,eAAoD,IAA7BjE,EAAKiE,QAAQ,YASlF,GAAN,mBAAWiE,GAAX,CAAe2B,EAAuBa,EAAQ9K,KAAK8K,EAAQ1K,QAEpDkI,EAZS,IAAClI,IAcvB,IAWF,MATa,CAAC,CACVgK,GAAIpK,EACJ+K,MAAO,CACH1D,QAAS,CAAC,IACVwD,SAEJG,OAAOP,EAASxB,O,8BCrcxB,8CAMO,IAAMgC,EAAqB,kBACmB,IAApDC,OAAOC,UAAUC,UAAU/G,QAAQ,e,qKCA7B,SAASgH,EACfC,EACAC,GACE,IAAD,EACD,GAAyB,WAArBD,EAAOE,YAIP,UAACF,EAAOG,WAAWC,wBAAnB,aAAC,EAAoCC,OAAzC,CAIA,IAAMC,EAAajI,OAAOC,KACzB0H,EAAOG,WAAWC,iBAAiBC,OAClC7D,QAAO,SAAA+D,GAAU,OAAIC,oBAAUP,EAAcM,MAE/C,GAA0B,IAAtBD,EAAW1I,OAaf,OANI0I,EAAW1I,OAAS,GACvB0C,QAAQmG,KAAR,qDAC+CT,EAAOtL,KADtD,YAC8DsL,EAAOU,QADrE,4BACgGT,EADhG,uBAKMD,EAAOG,WAAWC,iBAAiBC,MAAMC,EAAW,IAZ1DhG,QAAQqG,KAAR,UACIX,EAAOtL,KADX,YACmBsL,EAAOU,QAD1B,iDAC0ET,EAD1E,gB,YClBK,SAASW,EAAmBZ,GAClC,OAAOA,EAAOtL,KAAKmM,cAAc5H,QAAQ,MAAO,KAAO,IAAM+G,EAAOU,U,qLCLxDI,EAAsB,kBAClC,qBACCC,QAAQ,YACR9L,MAAM,KACNV,OAAO,KACPyM,OAAO,eACPC,YAAY,IACZC,KAAK,OACLC,cAAc,QACdC,eAAe,W,OCPJC,G,OAAwB,WACpC,OACC,sBAAMpP,UAAU,eAAhB,SACC,cAAC,IAAD,QCLUqP,EAAsB,kBAClC,sBACCC,MAAM,6BACNC,WAAW,+BACXT,QAAQ,gBACR9L,MAAM,OACNV,OAAO,OALR,UAOC,iCACC,iCAAgBuK,GAAG,IAAnB,UACC,sBAAM2C,OAAO,IAAIC,UAAU,YAC3B,sBAAMD,OAAO,IAAIC,UAAU,UAAUC,YAAY,YAElD,iCAAgB7C,GAAG,IAAnB,UACC,sBAAM2C,OAAO,IAAIC,UAAU,UAAUC,YAAY,SACjD,sBAAMF,OAAO,IAAIC,UAAU,eAE5B,gCACCE,UAAU,KACV9C,GAAG,IACH+C,GAAG,KACHC,GAAG,UACHC,GAAG,MACHC,GAAG,UACHC,cAAc,mBAEf,gCACCL,UAAU,KACV9C,GAAG,IACH+C,GAAG,MACHC,GAAG,IACHC,GAAG,UACHC,GAAG,UACHC,cAAc,iBACdC,kBAAkB,2BAGpB,sBACChB,KAAK,UACLiB,EAAE,0BACFC,UAAU,yBAEX,sBACCD,EAAE,+DACFjB,KAAK,UACLkB,UAAU,6BC1CAC,EAAwB,kBACpC,sBACCd,MAAM,6BACNtP,UAAU,wCACVgD,MAAM,KACNV,OAAO,KACPwM,QAAQ,YACRE,YAAY,IACZD,OAAO,eACPE,KAAK,OACLC,cAAc,QACdC,eAAe,QAVhB,UAYC,sBAAMJ,OAAO,OAAOmB,EAAE,gBAAgBjB,KAAK,SAC3C,wBAAQoB,GAAG,KAAKC,GAAG,KAAKrG,EAAE,MAC1B,sBAAM2F,GAAG,IAAIC,GAAG,KAAKC,GAAG,KAAKC,GAAG,OAChC,sBAAMH,GAAG,KAAKC,GAAG,KAAKC,GAAG,KAAKC,GAAG,Y,8BCZ5B,SAASQ,IACf,MAAO,CACN9N,KAAM+N,QACN/B,QAAS+B,eAPX,mC,mJCOaC,EAAwC,SAAAnR,GAAU,IACvDkB,EAA0ClB,EAA1CkB,SAAUkQ,EAAgCpR,EAAhCoR,aAAcC,EAAkBrR,EAAlBqR,KAASC,EADqB,YACZtR,EADY,sCAE7BD,WAC/B,MAH4D,mBAEtDwR,EAFsD,KAE5CC,EAF4C,OAKjCzR,WAAsC,MALL,mBAKtD0R,EALsD,KAK9CC,EAL8C,OAMhCC,YAAUJ,EAAUE,EAAQ,CAACG,SAAU,UAA7DC,EANsD,EAMtDA,OAAQC,EAN8C,EAM9CA,WAqBf,OAnBA/R,aAAgB,WACf,IAAMgS,EAAS,SAAC/D,GAGf,IAFA,IAAIgE,EAAsBhE,EAAMgE,OAEzBA,GAAUA,IAAWP,GAC3BO,EAASA,EAAOC,WAGbD,IAAWP,GACdL,GAAa,IAIf,GAAIC,EAEH,OADAa,SAASC,iBAAiB,QAASJ,GAC5B,kBAAMG,SAASE,oBAAoB,QAASL,MAElD,CAACN,EAAQL,EAAcC,EAAMrR,IAG/B,uBAAMU,UAAU,cAAhB,UACC,cAAC,IAAD,2BACK4Q,GADL,IAEChR,QAAS,kBAAM8Q,GAAcC,IAC7BpR,IAAKuR,KAEN,cAAC,IAAD,CACC7Q,WAAW,WACX0R,GAAIhB,EACJiB,cAAY,EACZC,QAAS,IACTC,eAAa,EALd,SAOC,6CACC9R,UAAU,mBACVT,IAAKyR,EACLjR,MAAOoR,EAAOY,QACVX,EAAWW,QAJhB,aAMC,cAAC,IAAD,CAAMhQ,UAAQ,EAAd,SAAgBvB,c,6BC3DrB,qKA4BO,SAASwR,IACf,IAAMC,GAAY,IAAI7O,MAAO8O,iBAAiBlL,QAAQ,UAAW,KAEjE,OAAOtE,IAAKf,EAAE,wBAAyB,CAACsQ,cAOlC,SAASE,EAAeC,EAAkBC,GAChD,OAAOD,EAAQtH,QAAO,SAACwH,EAAQjF,GAG9B,OACCiF,EAASC,EAAalF,EAAOgF,EAAS,CAACG,eAAe,IAAS,SAE9D,IAOG,SAASC,EAAelF,EAAkBmF,GAChD,MACC,+BAAwBC,IAAOD,EAAQE,YAAvC,sBACSD,IAAOpF,EAAQ9K,MADxB,sBAESkQ,IAAOpF,EAAQ3K,KAAKiQ,KAAK,MAFlC,0BAGatF,EAAQ/K,KAHrB,YAG6B+K,EAAQxK,IAHrC,sBAISwK,EAAQvK,MAJjB,YAI0BuK,EAAQjL,OAJlC,gBAKGqQ,IAAOpF,EAAQ1K,MALlB,qBAaK,SAAS0P,EACflF,EACAgF,GAEE,IAAD,EAqBGS,EArBH,yDADyD,GAAzDC,EACA,EADAA,cAAeC,EACf,EADeA,QAASR,EACxB,EADwBA,cAMzB,GAJAQ,EAAO,UAAGA,SAAH,QAAc3F,EAAM7J,cAItBgP,EAAe,CACnB,IAAKQ,EACJ,MAAM,IAAIpN,MACT,4EAIF,IAAKyH,EAAMhK,SAAS4P,MAAK,SAAAtH,GAAC,OAAIA,EAAEkB,KAAOmG,KACtC,MAAM,IAAIpN,MACT,oEAQH,IAAIsN,EAAc,GAElB7F,EAAMhK,SAAS8P,SAAQ,SAACxH,EAAGyH,GAC1BF,GAAeT,EAAe9G,EAAGyH,EAAQ,GAErCzH,EAAEkB,KAAOmG,IACZF,EAAeM,EAAQ,MAIzB,IAAMC,EAAUjN,OAAOC,KAAKgH,EAAMzJ,WAAWkH,QAC5C,SAACxF,EAAQgO,GAAT,OACChO,EAAM,wBACWqN,IAAOW,GADlB,oBACkCX,IACvCtF,EAAMzJ,UAAU0P,IAFX,iBAIP,IAGD,MACC,8BAAuBX,IAAOtF,EAAM5K,MAApC,2BACcqQ,GAAgB,GAD9B,yBAEYH,IAAON,EAAQ5P,MAF3B,iCAGoBkQ,IAAON,EAAQ5D,SAHnC,wBAIWkE,IAAOtF,EAAM5J,aAJxB,gCAKmBkP,IAAOtF,EAAM3J,oBALhC,sBAMSiP,IAAOtF,EAAMnK,MANtB,yBAOYyP,IAAOI,GAPnB,qBAQSJ,IAAOtF,EAAMzK,KAAKiQ,KAAK,MARhC,sBASSF,IAAOtF,EAAMxJ,KAAK+O,YAT3B,0FAYAvF,EAAM1J,WAZN,qFAgBA0J,EAAM/J,OAhBN,aAkBA+P,EACAH,EAnBA,kBA2BK,SAASK,EACflG,EACAmG,EACAnB,GAEE,IAAD,yDAD0C,GAA1CU,EACA,EADAA,cAAeC,EACf,EADeA,QAEhB,IAAKQ,EACJ,MAAM,IAAI5N,MAAM,wCAGjB,IAAI0M,EAASkB,EAUb,OAJAlB,GADAA,EAASA,EAAOtL,QAAQ,mBAAmB,kBAAM2L,IAAOtF,EAAM5K,UAC9CuE,QAAQ,mBAAmB,kBAC1CuL,EAAalF,EAAOgF,EAAS,CAACU,gBAAeC,iB,+BC7JxC,SAASS,EAAexS,GAC9B,OAAOA,EAAM0E,OAAS,IAAM,KAAK+N,KAAKzS,GADvC,mC,iCCEA,kCAAO,IAAM0S,EAAW,iBAAmB,CAC1CC,SAAU,QACVC,qBAAsB,yBACtBC,oBAAqB,EACrBC,oCAAqC,GACrCC,aAAa,EACbC,oBAAoB,EACpBC,cAAc,IAAI9Q,MAAO+Q,UACzBC,eAAgB,GAChBC,qBAAqB,IAAIjR,MAAO+Q,UAChCG,OACE3G,OAAOC,UAAkB2G,cAC1B5G,OAAOC,UAAU4G,UAChB7G,OAAOC,UAAkB6G,iBACzB9G,OAAOC,UAAkB8G,gBAC1B,QACDC,wBAAyB,qBACzBC,uBAAwB,EACxBC,eAAgB,CACfpS,KAAM,YACNgM,QAAS,SAEVhL,YAAa,CACZhB,KAAM,UACNgM,QAAS,SAEVqG,sBAAuB,UACvBC,cAAe,OACfC,mBAAoB,GACpBC,eAAgB,GAChBC,aAAa,K,6BChCd,gEAIaxS,EAAOyS,IAAQC,iBAE5B1S,EACE2S,IAAIC,KACJD,IAAIE,KACJC,KAAK,CACLC,OAAOjF,EACPkF,QAAS,CACRC,SAAS,GAAD,OAAKnF,IAAL,0BAEToF,YAAa,QACbC,cAAe,CACdC,aAAa,GAEdC,KAAM,iB,+JCEKC,EAAoC,SAAA1W,GAAU,IACnD2W,EAA+C3W,EAA/C2W,WAAYC,EAAmC5W,EAAnC4W,UAAW/V,EAAwBb,EAAxBa,MAAU8D,EADiB,YACH3E,EADG,oCAEnDS,EAA6B,GAYnC,OAVIkW,IACHlW,EAAMkW,WAAaA,EAAWzP,SAAS,KAApB,WACZyP,EADY,KAEhBA,GAGAC,IACHnW,EAAMoB,SAAN,UAAgC,IAAZ+U,EAApB,MAIA,qBAAKlW,UAAU,YAAYD,MAAOA,EAAlC,SACC,kCACC,sBACCC,UAAWmW,IAAW,QAAS,CAC9B,qBAAsB7W,EAAM8W,cAF9B,SAKEjW,IAEF,cAAC,aAAD,eAAgB8D,W,mLCRPoS,EAAwC,SAAA/W,GAAU,IACvDgX,EAAmBhX,EAAnBgX,MAAU1F,EAD4C,YACnCtR,EADmC,aAE7BD,WAC/B,MAH4D,mBAEtDwR,EAFsD,KAE5CC,EAF4C,OAKjCzR,WAAsC,MALL,mBAKtDkX,EALsD,KAK9CC,EAL8C,OAMrCnX,YAAe,GANsB,mBAMtDsR,EANsD,KAMhD8F,EANgD,OAOhCxF,YAAUJ,EAAU0F,EAAQ,CAACrF,SAAU,UAA7DC,EAPsD,EAOtDA,OAAQC,EAP8C,EAO9CA,WAYf,OAVA/R,aAAgB,WACf,IAAMgS,EAAS,kBAAMoF,GAAQ,IAM7B,OAJI9F,GACHa,SAASC,iBAAiB,QAASJ,GAG7B,kBAAMG,SAASE,oBAAoB,QAASL,MACjD,CAACkF,EAAQ5F,EAAM8F,IAGjB,uBAAMzW,UAAU,cAAhB,UACC,cAAC,IAAD,2BACK4Q,GADL,IAEChR,QAAS,kBAAM6W,GAAQ,SAAA9F,GAAI,OAAKA,MAChCpR,IAAKuR,KAEN,cAAC,IAAD,CACC7Q,WAAW,WACX0R,GAAIhB,EACJiB,cAAY,EACZC,QAAS,IACTC,eAAa,EALd,SAOC,6CACC9R,UAAU,mBACVT,IAAKiX,EACLzW,MAAOoR,EAAOY,QACVX,EAAWW,QAJhB,aAMC,cAAC,IAAD,CAAYhQ,UAAQ,EAApB,SACC,cAAC,IAAD,CAAWxB,YAAY,WAAvB,SACE+V,EAAMnU,KAAI,SAACuU,EAAMtD,GACjB,OAAIsD,EAAKC,UACD,cAAC,IAAD,GAAyBvD,GAG1B,cAAesD,EACrB,cAAC,IAAD,CACC3S,YAAa,cAAC,IAAD,IACbvE,SAAUkX,EAAKlX,SAEfW,MAAOuW,EAAKvW,MACZW,SAAU4V,EAAK9W,QACfoE,cAAe,cAAC,IAAD,IACf/C,MAAOyV,EAAKE,SAJPxD,GAON,cAAC,IAAD,CACC5T,SAAUkX,EAAKlX,SACfC,KAAM,cAAC,IAAD,IAENU,MAAOuW,EAAKvW,MACZP,QAAS8W,EAAK9W,QACdE,QAAS4W,EAAK5W,SAHTsT,oB,sLChEFyD,EAA4C,SAAAvX,GAAU,IAEjEwX,EAWGxX,EAXHwX,WACAC,EAUGzX,EAVHyX,YACAjW,EASGxB,EATHwB,SACAkW,EAQG1X,EARH0X,SACAC,EAOG3X,EAPH2X,OACAC,EAMG5X,EANH4X,WACAC,EAKG7X,EALH6X,YACAC,EAIG9X,EAJH8X,cACAC,EAGG/X,EAHH+X,SACApW,EAEG3B,EAFH2B,MACG2P,EAZ6D,YAa7DtR,EAb6D,6HAczCD,YAAe,GAd0B,mBAc1DsR,EAd0D,KAcpD8F,EAdoD,OAkB7DpX,aAlB6D,mBAgBhEiY,EAhBgE,KAiBhEC,EAjBgE,KAmB1D5V,EAAKC,cAALD,EAmBP,OAjBAtC,aAAgB,WAAM,4CACrB,sBAAA2L,EAAA,0DACKqM,EADL,4BAEEE,EAFF,SAEsBF,EAASpW,GAF/B,wDAIEsW,EAAc,CAACC,OAAO,IAJxB,4CADqB,uBAAC,WAAD,wBASrBC,KACE,CAACJ,EAAUpW,IAQb,sBAAMjB,UAAU,gBAAhB,SACC,eAAC,IAAD,yBAAY0Q,aAAc+F,EAAS9F,KAAMA,GAAUC,GAAnD,cACC,eAAC,IAAD,WACC,cAAC,IAAD,CAAW9P,SAAUA,EAAUP,YAAY,WAAWU,MAAOA,EAA7D,SACEgW,KAES,OAAVK,QAAU,IAAVA,OAAA,EAAAA,EAAYI,UAAW,4BAAIJ,EAAWI,aAExC,eAAC,IAAD,WACC,cAAC,IAAD,CACClY,WAAU,OAAC8X,QAAD,IAACA,OAAD,EAACA,EAAYE,OACvB/X,KAAI,OAAEyX,QAAF,IAAEA,IAAc,cAAC,IAAD,IACpB/W,MAAK,OAAEgX,QAAF,IAAEA,IAAexV,EAAE,aACxB/B,QAnBL,WACCoX,EAAS/V,GACTwV,GAAQ,IAkBJ3W,QAAO,OAAEsX,QAAF,IAAEA,IAAiB,YAE3B,cAAC,IAAD,CACC3X,KAAI,OAAEqX,QAAF,IAAEA,IAAc,cAAC,IAAD,IACpB3W,MAAK,OAAE4W,QAAF,IAAEA,IAAepV,EAAE,iBACxB/B,QAAS,kBAAM6W,GAAQ,iB,kFCtFtB,SAASV,IAA6B,IAAD,EACpC4B,EAAiBhK,OAAjBgK,cACDrS,EAA8B,GAC9BsS,EAAWxR,OAAOC,KAAKsN,eAE7B,IACc,OAAbgE,QAAa,IAAbA,GAAA,UAAAA,EAAeE,eAAf,eAAwBC,QACe,kBAAhCH,EAAcE,QAAQC,MAE7B,IAAK,IAAMvR,KAAOoR,EAAcE,QAAQC,MACnCF,EAASpR,SAASD,KACpBjB,EAAeiB,GAAOoR,EAAcE,QAAQC,MAAMvR,IAKtD,OAAOjB,EClBD,SAASyS,EAASC,EAAkBjL,GAAY,IAC/C4K,EAAiBhK,OAAjBgK,cAEP,IAAKA,EACJ,MAAM,IAAI/R,MAAM,6CAGjB+R,EAAcM,YAAYC,KAAK,YAAaF,EAAUjL,GCFhD,SAASoL,EAAeC,EAAmBjP,GAC7B,WAAhBA,EAAOtI,MAAqC,WAAhBsI,EAAOtI,MACtCkX,EAAS,aAAcK,G,oBCLlB,SAASrC,IAAiB,IAAD,EACxB4B,EAAiBhK,OAAjBgK,cAIP,IAAKA,EACJ,MAAM,IAAI/R,MAAM,6CAGjB,OACc,OAAb+R,QAAa,IAAbA,GAAA,UAAAA,EAAeE,eAAf,eAAwBzF,UACxBiG,MAAMC,QAAQX,EAAcE,QAAQzF,SAEpC,OAAOuF,QAAP,IAAOA,OAAP,EAAOA,EAAeE,QAAQzF,QAAQtH,QAAO,SAACxF,EAAQiT,GACrD,IAAMlL,EAAQmL,YAAcD,EAAKE,WAAYF,EAAKG,OAElD,OAAIrL,EAAM,GACH,GAAN,mBAAW/H,GAAX,CAAmB+H,EAAM,MAG1BhF,QAAQmG,KAAK,4BAA6B+J,EAAKE,YACxCnT,KACL,KAEH+C,QAAQmG,KAAK,4CAGP,I,ICdJmK,E,wECJG,SAAeC,EAAtB,oC,4CAAO,WAAyBvL,EAAcwL,GAAvC,uBAAA7N,EAAA,2DACkB2C,OAAjBgK,EADD,EACCA,cADD,sBAIC,IAAI/R,MAAM,6CAJX,mBAcoB,YANnBmI,EAAS+K,mCACdD,EACAxL,EAAM5J,YACN4J,EAAM3J,qBAGIuK,UAdN,gBAeJ0J,EAAcM,YAAYC,KACzB,kBACA7K,EACAkG,YAAuBlG,EAAOU,EAAOG,WAAW6K,OAAQxI,cAAc,CACrEiC,eAAe,KAnBb,wCAuBmBwG,YAA2BjL,EAAOkL,KAvBrD,iBAuBGF,EAvBH,EAuBGA,OAEPpB,EAAcM,YAAYC,KACzB,kBACA7K,EACAkG,YAAuBlG,EAAO0L,EAAQxI,cAAc,CACnDiC,eAAe,KA7Bb,0DAkCLnK,QAAQmG,KAAR,qCAC+B,KAAMkJ,QADrC,uCAGAC,EAAcM,YAAYC,KACzB,kBACA7K,EACAkF,YAAalF,EAAOkD,cAAc,CAACiC,eAAe,KAxC9C,2D,sBDaA,SAAS2F,EACfC,EACAjP,EACA0P,GACE,IACKlB,EAAiBhK,OAAjBgK,cAEP,IAAKA,EACJ,MAAM,IAAI/R,MAAM,6CAGjB,OAAQuD,EAAOtI,MACd,IAAK,OACL,IAAK,SAIJ,MAED,IAAK,cACJ,IAAKsI,EAAO7J,MAAMmD,KACjB,MAAM,IAAImD,MAAM,kDAGjBgT,EAAUM,wBAAcd,EAAOjP,EAAO7J,MAAMmD,MAAOoW,GACnD,MAED,IAAK,cAIJlB,EAAcM,YAAYC,KACzB,eACAiB,sBAAYR,EAAWxP,EAAOiQ,UAE/B,MAGD,IAAK,cACJ,GAAI3S,YAAyB0C,EAAO7J,OACnC,GAAI6J,EAAO7J,MAAMmD,KAAM,CAKtB,IAAM4W,EAAWF,sBAAYR,EAAWxP,EAAOiQ,SACzCE,EAAWH,sBAAYf,EAAOjP,EAAOiQ,SAK3CzB,EAAcM,YAAYsB,KAAK,iBAAiB,kBAC/CX,EAAUU,EAAUT,MAErBlB,EAAcM,YAAYC,KAAK,eAAgBmB,EAAUC,QAIzDV,EAAUO,sBAAYf,EAAOjP,EAAOiQ,SAAUP,GAGhD,MAED,IAAK,gBACL,IAAK,iBACL,IAAK,gBACL,IAAK,iBACJD,EAAUO,sBAAYf,EAAOjP,EAAOiQ,SAAUP,GAC9C,MAED,IAAK,gBAEA1S,YAA2BgD,EAAO7J,QACrCsZ,EAAUO,sBAAYf,EAAOjP,EAAOiQ,SAAUP,GAE/C,MAED,IAAK,iBAGHzS,OAAOC,KAAK8C,EAAOqQ,gBAAgBlT,MAAK,SAAAmT,GAAS,OAChDtT,YAA2BgD,EAAOqQ,eAAeC,QAGlDb,EAAUO,sBAAYf,EAAOjP,EAAOiQ,SAAUP,GAE/C,MAED,QACCxQ,QAAQmG,KAAR,uBAEGrF,EAAetI,KAFlB,yCAOF8X,EAAS,YAAOP,G,qBEtHV,SAASrC,IAA2B,IAAD,EAClC4B,EAAiBhK,OAAjBgK,cAEP,OACC,OAACA,QAAD,IAACA,GAAD,UAACA,EAAeE,eAAhB,aAAC,EAAwB6B,eACxBrB,MAAMC,QAAQX,EAAcE,QAAQ6B,cAK/B/B,EAAcE,QAAQ6B,aAAavX,KAAI,SAAA4K,GAAI,MAAK,CACtDF,GAAI8M,MACJ1L,UAAW,WACXxL,KAAMsK,EAAKtK,KACXE,UAAU,EACV8L,QAAS1B,EAAK0B,QACdwK,IAAKlM,EAAKkM,IACVW,UAAW7M,EAAK6M,cAVT,GCHF,SAASzB,EACfC,EACAjP,IAGiB,WAAhBA,EAAOtI,MACS,WAAhBsI,EAAOtI,MACS,WAAhBsI,EAAOtI,MACU,WAAhBsI,EAAOtI,MAAqB6F,YAA+ByC,EAAO7J,SAGnEyY,EACC,qBACAK,EAAMjW,KAAI,SAAA4L,GAAM,MAAK,CACpBlB,GAAIkB,EAAOlB,GACXpK,KAAMsL,EAAOtL,KACbE,cAAUvC,EACVqO,QAASV,EAAOU,QAChBwK,IAAKlL,EAAOkL,IACZW,UAAW7L,EAAO6L,eCzBf,SAAS7D,IACf,IAAM8D,EAAalM,OAAOmM,aAAaC,QAAQ,eACzCzU,EAA8B,GAEpC,OAAKuU,GAILA,EAAWhT,MAAM,KAAKsM,SAAQ,SAAAtG,GAC7B,IACC,IAAMmN,EAAiBrM,OAAOmM,aAAaC,QAApB,sBACPlN,IAGhB,IAAKmN,EAEJ,YADA3R,QAAQmG,KAAR,8CAAoD3B,IAIrD,IAAM6J,EAAOxO,KAAKC,MAAM6R,GAEvB1U,EAAeoR,EAAKjU,MAAQiU,EAAKzV,MACjC,MAAOZ,GACRgI,QAAQmG,KAAR,qBACe3B,EADf,2CAECc,OAAOmM,aAAaC,QAApB,sBAA2ClN,IAC3CxM,OAKIiF,GA1BC,GCJF,SAAS6S,EAAeC,EAAmBjP,GAC7B,WAAhBA,EAAOtI,MAAqC,WAAhBsI,EAAOtI,MCDjC,SAAcuX,GAIpB,IAAM6B,EAAuBtM,OAAOmM,aAAaC,QAAQ,eAErDE,GACHA,EAAqBpT,MAAM,KAAKsM,SAAQ,SAAAtG,GACvCc,OAAOmM,aAAaI,WAApB,sBAA8CrN,OAMhD,IAAIsN,EAAgB,GAEpB,IAAK,IAAM1X,KAAQ2V,EAAO,CACzB,IAAMvL,EAAK8M,MAEXQ,EAAIC,KAAKvN,GACTc,OAAOmM,aAAaO,QAApB,sBACgBxN,GACf3E,KAAKmB,UAAU,CACdwD,KACApK,OACAxB,MAAOmX,EAAM3V,MAKhBkL,OAAOmM,aAAaO,QAAQ,cAAeF,EAAItH,KAAK,MD5BnDyH,CAAKlC,G,IEYHO,E,eCXG,SAAS5C,IACf,IAAM3D,EAAiC,GACjCmI,EAAoB5M,OAAOmM,aAAaC,QAAQ,iBAEtD,IAAKQ,EACJ,MAAO,GAMRA,EAAkB1T,MAAM,KAAKsM,SAAQ,SAAAtG,GACpC,IAAM2N,EAAkB7M,OAAOmM,aAAaC,QAApB,wBAA6ClN,IAErE,GAAK2N,EAOL,IACC,IAAMnN,EAAenF,KAAKC,MAAMqS,GAEhC,IAAKnN,EAAMR,GAEV,YADAxE,QAAQmG,KAAK,6CAA8CnB,GAI5D+E,EAAQ/E,EAAMR,IAAd,uCACI5J,eACAoK,GAFJ,IAKClK,WAAYkK,EAAMlK,WACf,IAAIC,KAAKA,KAAK+E,MAAOkF,EAAMlK,aAC3B,IAAIC,KAIPC,SAAU,KAEV,MAAOhD,GACRgI,QAAQmG,KAAR,mDAC6CgM,SA7B7CnS,QAAQmG,KAAR,kCAC4B3B,EAD5B,+BACqDA,EADrD,iCAoCF,IAAM4N,EAAqB9M,OAAOmM,aAAaC,QAAQ,kBAiDvD,OA/CIU,GACHA,EAAmB5T,MAAM,KAAKsM,SAAQ,SAAAtG,GACrC,IAAM6N,EAAoB/M,OAAOmM,aAAaC,QAApB,yBACPlN,IAGnB,GAAK6N,EAOL,IACC,IAAMnN,EAAmBrF,KAAKC,MAAMuS,GAEpC,IAAKnN,IAAYA,EAAQF,MAKxB,YAJAhF,QAAQmG,KAAR,kBACY3B,EADZ,2CAECU,GAKF,IAAK6E,EAAQ7E,EAAQF,OAIpB,YAHAhF,QAAQmG,KAAR,kBACY3B,EADZ,8CACoDU,EAAQF,MAD5D,gBAMD+E,EAAQ7E,EAAQF,OAAOhK,SAAS+W,KAAhC,uCACI/X,KACAkL,GAFJ,IAKC3K,KAAM2K,EAAQ3K,KAAO2K,EAAQ3K,KAAK2H,QAAO,SAAA5I,GAAC,MAAiB,KAAbA,EAAEsF,UAAiB,MAEjE,MAAO5G,GACRgI,QAAQmG,KAAR,qDAC+CkM,SAjC/CrS,QAAQmG,KAAR,oCAC8B3B,EAD9B,gCACwDA,EADxD,iCAwCIzG,OAAOuU,OAAOvI,GC5Ff,SAASwI,EAAUC,EAAc5Z,GACvC,MAAa,KAAT4Z,EACI5Z,EATF,SAAkB4Z,EAAc5Z,GACtC,OAAO,IAAI6Z,OAAO,MAAQ7Z,EAAQ,OAAOyS,KAAKmH,GAW1CE,CAASF,EAAM5Z,GACX4Z,EAGDA,EAAO,IAAM5Z,EAMd,SAAS+Z,EAAOH,EAAc5Z,GAKpC,MAAgB,OAJhB4Z,EAAOA,EAAK7T,QAAQ,IAAI8T,OAAO,KAAO7Z,GAAQ,KAIrC,GACD4Z,EAAK1T,UAAU,GAGhB0T,ECjBD,SAASI,EAAoBC,GAA0B,IAAD,IACtDC,EAAc,CACnBC,WAAU,UAAEzN,OAAOmM,aAAaC,QAAQ,yBAA9B,QAAmD,GAC7DsB,SAAQ,UAAE1N,OAAOmM,aAAaC,QAAQ,wBAA9B,QAAkD,IAG3DmB,EAAQC,GAERxN,OAAOmM,aAAaO,QAAQ,gBAAiBc,EAAYE,UACzD1N,OAAOmM,aAAaO,QAAQ,iBAAkBc,EAAYC,YAMpD,SAASxC,EAAUuC,EAAiC9N,GAC1D,IAAKA,EAAMR,GACV,MAAM,IAAIjH,MAAM,mBAGjBuV,EAAYE,SAAWT,EAAUO,EAAYE,SAAUhO,EAAMR,IAK7Dc,OAAOmM,aAAaO,QAApB,wBACkBhN,EAAMR,IACvB3E,KAAKmB,UAAL,2BAAmBgE,GAAnB,IAA0BhK,cAAUjD,MAoB/B,SAASkb,EAAYH,EAAiC5N,GAC5D,IAAKA,EAAQV,GACZ,MAAM,IAAIjH,MAAM,qBAGjBuV,EAAYC,WAAaR,EAAUO,EAAYC,WAAY7N,EAAQV,IACnEc,OAAOmM,aAAaO,QAApB,yBACmB9M,EAAQV,IAC1B3E,KAAKmB,UAAUkE,IAqBV,SAASgO,EACfJ,EACA1B,GAEA0B,EAAYC,WAAaJ,EAAOG,EAAYC,WAAY3B,GACxD9L,OAAOmM,aAAaI,WAApB,yBAAiDT,IH/E3C,SAAStB,EAAeC,EAAqBjP,GACnD,OAAQA,EAAOtI,MACd,IAAK,OACL,IAAK,SAIJ,MAED,IAAK,gBACJ,IAAKsI,EAAO7J,MAAMmD,KACjB,MAAM,IAAImD,MAAM,kDAGjB,IAAMyH,EAAQ8L,sBAAYf,EAAOjP,EAAOiQ,SAClC7L,EAAUiO,0BAAgBpD,EAAO/K,EAAMR,GAAI1D,EAAO7J,MAAMmD,MAE9DwY,GAAoB,SAAAE,GACnBvC,EAAUuC,EAAa9N,GACvBiO,EAAYH,EAAa5N,MAE1B,MAGD,IAAK,iBACJ,IAAMF,EAAQ8L,sBAAYf,EAAOjP,EAAOiQ,SAExC6B,GAAoB,SAAAE,GACnBvC,EAAUuC,EAAa9N,GACvBlE,EAAO7J,MAAM6T,SAAQ,SAAA7T,GACpB,IAAKA,EAAMmD,KACV,MAAM,IAAImD,MAAM,kDAGjB0V,EACCH,EACAK,0BAAgBpD,EAAO/K,EAAMR,GAAIvN,EAAMmD,aAI1C,MAGD,IAAK,cACJ,IAAK0G,EAAO7J,MAAMmD,KACjB,MAAM,IAAImD,MAAM,gDAGjB,IAAMyH,EAAQ6L,wBAAcd,EAAOjP,EAAO7J,MAAMmD,MAEhDwY,GAAoB,SAAAE,GACnBvC,EAAUuC,EAAa9N,GACvBA,EAAMhK,SAAS8P,SAAQ,SAAA5F,GAAO,OAAI+N,EAAYH,EAAa5N,SAE5D,MAED,IAAK,gBACJ,IAAMF,EAAQ8L,sBAAYf,EAAOjP,EAAOiQ,SAMxC6B,GAAoB,SAAAE,GACnBvC,EAAUuC,EAAa9N,GACvBkO,EAAkBJ,EAAahS,EAAOsQ,cAEvC,MAGD,IAAK,iBACJ,IAAMpM,EAAQ8L,sBAAYf,EAAOjP,EAAOiQ,SAIxC6B,GAAoB,SAAAE,GACnBvC,EAAUuC,EAAa9N,GACvBlE,EAAOiS,WAAWjI,SAAQ,SAAAsG,GAAS,OAClC8B,EAAkBJ,EAAa1B,SAGjC,MAGD,IAAK,cAIJ,IAAMpM,EAAQ8L,sBAAYR,EAAWxP,EAAOiQ,SAE5C6B,GAAoB,SAAAE,GAGnB9N,EAAMhK,SAAS8P,SAAQ,SAAA5F,GAAO,OAC7BgO,EAAkBJ,EAAa5N,EAAQV,OG7DrC,SAAqBsO,EAAiC9N,GAC5D,IAAKA,EAAMR,GACV,MAAM,IAAIjH,MAAM,mBAGjBuV,EAAYE,SAAWL,EAAOG,EAAYE,SAAUhO,EAAMR,IAC1Dc,OAAOmM,aAAaI,WAApB,wBAAgD7M,EAAMR,KH0DnD4O,CAAYN,EAAa9N,MAE1B,MAGD,IAAK,gBACJ,GAAIlH,YAA2BgD,EAAO7J,OAAQ,CAC7C,IAAM+N,EAAQ8L,sBAAYf,EAAOjP,EAAOiQ,SAClC7L,EAAUmO,wBAActD,EAAOjP,EAAOiQ,QAASjQ,EAAOsQ,WAE5DwB,GAAoB,SAAAE,GACnBvC,EAAUuC,EAAa9N,GACvBiO,EAAYH,EAAa5N,MAE1B,MAED,MAED,IAAK,iBACJ,IAAMF,EAAQ8L,sBAAYf,EAAOjP,EAAOiQ,SAExC6B,GAAoB,SAAAE,GACnBvC,EAAUuC,EAAa9N,GACvBjH,OAAOC,KAAK8C,EAAOqQ,gBACjBjP,QAAO,SAAAkP,GAAS,OAChBtT,YAA2BgD,EAAOqQ,eAAeC,OAEjDtG,SAAQ,SAAAsG,GAAS,OACjB6B,EACCH,EACAO,wBAActD,EAAOjP,EAAOiQ,QAASK,UAIzC,MAGD,IAAK,cACJ,IAAMpM,EAAQ8L,sBAAYf,EAAOjP,EAAOiQ,SAExC6B,GAAoB,SAAAE,GACnBvC,EAAUuC,EAAa9N,GACvBA,EAAMhK,SAAS8P,SAAQ,SAAA5F,GAAO,OAAI+N,EAAYH,EAAa5N,SAE5D,MAGD,QACClF,QAAQmG,KAAR,uBAEGrF,EAAetI,KAFlB,8CAOF8X,EAAYP,EI7KN,SAASrC,IACf,IAAMzQ,EAA4B,GAC5BuU,EAAalM,OAAOmM,aAAaC,QAAQ,sBAE/C,OAAKF,GAILA,EAAWhT,MAAM,KAAKsM,SAAQ,SAAAtG,GAC7B,IACC,IAAM8O,EAAmBhO,OAAOmM,aAAaC,QAApB,6BACFlN,IAGvB,IAAK8O,EAIJ,YAHAtT,QAAQmG,KAAR,uDACiD3B,EADjD,eAMDvH,EAAO8U,KAAP,2BAAgBlS,KAAKC,MAAMwT,IAA3B,IAA8C1N,UAAW,cACxD,MAAO5N,GACRgI,QAAQmG,KAAR,uBACiB3B,EADjB,2CAECc,OAAOmM,aAAaC,QAApB,6BAAkDlN,SAK9CvH,GAzBC,GCJF,SAASgV,EAAKlC,GAIpB,IAAM6B,EAAuBtM,OAAOmM,aAAaC,QAChD,sBAGGE,GACHA,EAAqBpT,MAAM,KAAKsM,SAAQ,SAAAtG,GACvCc,OAAOmM,aAAaI,WAApB,6BAAqDrN,OAMvD,IAAIsN,EAAgB,GAEpB/B,EAAMjF,SAAQ,SAAApF,GACb,IAAMlB,EAAK8M,MAKXQ,EAAIC,KAAKvN,GACTc,OAAOmM,aAAaO,QAApB,6BACuBxN,GACtB3E,KAAKmB,UAAL,2BACI0E,GADJ,IAEC6N,eAAWxb,EACX6N,eAAW7N,EACX8N,gBAAY9N,EACZuC,cAAUvC,SAKbuN,OAAOmM,aAAaO,QAAQ,qBAAsBF,EAAItH,KAAK,MChCrD,SAASsF,EACfC,EACAjP,GAEA,OAAQA,EAAOtI,MACd,IAAK,SACL,IAAK,SACL,IAAK,SACJyZ,EAAKlC,GACL,MAED,IAAK,SAEA1R,YAA+ByC,EAAO7J,QACzCgb,EAAKlC,I,YCQF,SAASyD,IACf,IAAMC,ECzBCzc,WACN,iBAAO,CACNyY,MAAO,CACN/B,KAAM+B,EACNK,eAAgBL,GAEjB1F,QAAS,CACR2D,KAAM3D,EACN+F,eAAgB/F,GAEjBsH,aAAc,CACb3D,KAAM2D,EACNvB,eAAgBuB,MAGlB,IDWKqC,EE1BC1c,WACN,iBAAO,CACNyY,MAAO,CACN/B,KAAM+B,EACNK,eAAgBL,GAEjB1F,QAAS,CACR2D,KAAM3D,EACN+F,eAAgB/F,GAEjBsH,aAAc,CACb3D,KAAM2D,EACNvB,eAAgBuB,MAGlB,IFaD,OAAOra,WACN,kBACCqO,cAAuBoO,EAAyBC,IACjD,CAACD,EAAwBC,M,6BGrC3B,4EAYaC,EAAoC,SAAA1c,GAAU,IACnD2c,EAAsC3c,EAAtC2c,KAAMxc,EAAgCH,EAAhCG,KAAMU,EAA0Bb,EAA1Ba,MAAOmR,EAAmBhS,EAAnBgS,OAAQxR,EAAWR,EAAXQ,QAC5BE,EAAYC,IAAW,YAAD,kBAAyBH,IAErD,OACC,oBAAGmc,KAAMA,EAAMjc,UAAWA,EAAWsR,OAAM,OAAEA,QAAF,IAAEA,IAAU,SAAvD,UACC,sBAAMtR,UAAU,OAAhB,SAAwBP,IACvBU,O,4HCEA+b,EAAeC,QAAQC,UAMpB,SAAepD,EAAtB,kC,4CAAO,WACNC,GADM,iCAAAjO,EAAA,6DAEN6G,EAFM,+BAEI,IAFJ,EAIkBlE,OAAjBgK,EAJD,EAICA,cACD0E,EACL3O,gBAAkB,OAAMiK,QAAN,IAAMA,OAAN,EAAMA,EAAe2E,OAAQ3E,EAAc2E,MAAQA,IANhE,kBAQC,IAAIH,SACV,SAACC,EAASG,GAAV,OACEL,EAAeA,EAAaM,MAC5B,kBACC,IAAIL,SAAQ,SAAAM,GACXJ,EAAepD,EAAK,CAACpH,UAASpP,KAAM,gBAAgB,SAAC2F,EAAK2E,GACrD3E,EACHmU,EAAOnU,GAEPgU,EAAQrP,GAGT0P,iBApBA,4C,qDC3BP,kCAAO,IAAMC,EAAW,iBAAM,CAC7B,CACCja,KAAO,UACPwW,IAAK,kCACLxK,QAAS,SAEV,CACChM,KAAM,WACNwW,IAAK,yCACLxK,QAAS,SAEV,CACChM,KAAM,UACNwW,IAAK,wCACLxK,QAAS,SAEV,CACChM,KAAM,UACNwW,IAAK,wCACLxK,QAAS,SAEV,CACChM,KAAM,UACNwW,IAAK,wCACLxK,QAAS,SAEV,CACChM,KAAM,YACNwW,IAAK,0CACLxK,QAAS,SAEV,CACChM,KAAM,UACNwW,IAAK,wCACLxK,QAAS,SAEV,CACChM,KAAM,UACNwW,IAAK,wCACLxK,QAAS,QACTmL,WAAW,GAEZ,CACCnX,KAAM,YACNwW,IAAK,2CACLxK,QAAS,UAEV,CACChM,KAAM,YACNwW,IAAK,2CACLxK,QAAS,a,+BClDX,sDAGO,SAASkO,IAAwB,MAKpB/a,YAAe,GAAI,CAACgb,aAAa,IAA7Cjb,EALgC,EAKhCA,EAAGkb,EAL6B,EAK7BA,MAEV,MAAO,CACNC,YADM,SACMC,EAAcC,GACzB3U,QAAQ0U,MAAM,oBAAqBA,GAE/BF,EACHlP,OAAOsP,MACNtb,EAAEqb,EAAY,CAACD,MAAOA,EAAMrF,UAC3B,IACA/V,EAAE,gBAAD,OAEC+L,cAAuB,WAAa,MAFrC,iBAOHC,OAAOsP,MAAP,0CACoCF,EAAMrF,QAD1C,6D,8BCzBJ,kCAEO,IAAMwF,EAAS,CACrB,OACA,MACA,SACA,SACA,QACA,OACA,W,sFCHM,SAASC,EACfrF,GAIA,IAAIxS,EAA8B,CACjC8X,UAAW,CACVC,OADU,eASZ,OAJKvF,EAAM7D,qBACV3O,EAAOgY,gBAAkB,GAGnBhY,EAlBR,mC,wNCsCaiY,EAA4C,SAAAje,GAAU,IAC3Dke,EAA4Dle,EAA5Dke,aAAche,EAA8CF,EAA9CE,SAAUie,EAAoCne,EAApCme,aAAche,EAAsBH,EAAtBG,KAAMU,EAAgBb,EAAhBa,MAAOud,EAASpe,EAAToe,MADO,EAE3Bre,YAAe,GAFY,mBAE1Dse,EAF0D,KAE7CC,EAF6C,OAGjCve,WAAsB,QAHW,mBAG1Dwe,EAH0D,KAGhDC,EAHgD,OAInCze,WAAe,IAJoB,mBAI1D0e,EAJ0D,KAIjDC,EAJiD,OAKzC3e,YAAe,GAL0B,mBAK1DsR,EAL0D,KAKpD8F,EALoD,KAM1D9U,EAAKC,cAALD,EAEHsc,OAAwC7d,EACxC8d,EAASzK,YAAesK,GA+B5B,OA7BKG,GAAsB,KAAZH,IACdE,EAAoBtc,EAAE,wCAGnBuc,GAAUP,KACbO,GAAUT,EAAajX,SAASuX,MAG/BE,EAAoBtc,EAAE,0CAsBvB,sBAAM3B,UAAU,iBAAhB,SACC,eAAC,IAAD,CACCR,SAAUA,EACVC,KAAI,OAAEA,QAAF,IAAEA,IAAQ,cAAC,IAAD,IACdU,MAAK,OAAEA,QAAF,IAAEA,IAASwB,EAAE,cAClB+O,aAAc+F,EACd9F,KAAMA,EALP,UAOC,eAAC,IAAD,WACC,cAAC,IAAD,CACC7P,SAlBL,SAA4BwM,GAC3B,IAAM6Q,EAAU7Q,EAAMgE,OAAOrQ,MAE7B+c,EAAWG,GACXP,EAA2B,KAAZO,IAeXjc,QAAO,CACN,CAAC/B,MAAOwB,EAAE,kCAAmCV,MAAO,KAD9C,mBAEHwc,EAAatb,KAAI,SAAAmR,GAAG,MAAK,CAC3B9T,SAAUge,EAAahX,SAAS8M,GAChCnT,MAAOmT,EACPrS,MAAOqS,QAGTrS,MAAO0c,EAAc,GAAKI,EAV3B,SAYEpc,EAAE,sCAEHgc,GACA,qCACC,cAAC,IAAD,CACC7c,SAAU,SAAAT,GAAC,OAAI2d,EAAW3d,EAAEiR,OAAOrQ,MAAM+F,QAAQ,MAAO,OACxD/F,MAAO8c,EAFR,SAIEpc,EAAE,0CAEJ,cAAC,IAAD,CACCb,SAAU,SAAAT,GAAC,OAAIyd,EAAYzd,EAAEiR,OAAOrQ,QACpCiB,QAASgb,IAAO/a,KAAI,SAAAic,GAAK,MAAK,CAC7Bje,MAAOwB,EAAE,UAAD,OAAWyc,IACnBnd,MAAOmd,MAERnd,MAAO4c,EANR,SAQElc,EAAE,8CAILgc,KAAiBM,GAAqB,4BAAIA,OAE5C,eAAC,IAAD,WACC,cAAC,IAAD,CACCze,UAAW0e,EACXze,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,cACT/B,QApEL,WACK+d,EACHD,EAAMK,EAASF,GAEfH,EAAMK,GAGPtH,GAAQ,IA8DJ3W,QAAQ,WAET,cAAC,IAAD,CACCL,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACT/B,QAAS,kBAAM6W,GAAQ,e,yBC3HhB4H,G,OAAsC,SAAA/e,GAAU,IACrDqC,EAAKC,cAALD,EAEP,OACC,sBAAM3B,UAAWC,IAAW,aAAD,gBAAwBX,EAAM8e,QAAzD,SACC,cAAC,IAAD,CACC3e,KAAM,cAAC,IAAD,IACNE,aAAa,MACb2W,MAAK,sBACD4G,IAAO/a,KAAI,SAAAic,GAAK,MAAK,CACvBE,WAAW,EACX1H,QAAmB,SAAVwH,GAAoB9e,EAAM8e,MAAQA,IAAU9e,EAAM8e,MAC3Dje,MAAOwB,EAAE,UAAD,OAAWyc,IACnBxe,QAAS,kBAAMN,EAAMif,cAAcH,SALhC,CAOJ,CACCzH,WAAW,GAEZ,CACCxW,MAAOwB,EAAE,iBACT/B,QAASN,EAAMkf,YAGjBre,MAAOb,EAAMmD,W,qCCtCjB,wDAWMgc,EAAgB,SAACC,GAAD,OAAmB,kBAAkBhL,KAAKgL,IAG1DC,EAAgB,SAACD,GAAD,MAA2B,KAATA,GAGlCE,EAAgB,SAACF,GACtB,IAAMG,EAAWC,EAASJ,EAAM,KAAM,GAEtC,cAAOG,QAAP,IAAOA,IAAYH,GAGdK,EAA0B,SAACL,GAAD,OAC/BA,EAAKM,OAAO,EAAGN,EAAK/Y,OAAS,IAMxBmZ,EAAW,SAACJ,EAAc/H,EAAmBvD,GAClD,IAAM6L,EAASP,EAAK7X,MAAM8P,GAE1B,GAAsB,IAAlBsI,EAAOtZ,OAKX,OAAOyN,EAAQ,EAAI6L,EAAOA,EAAOtZ,OAASyN,GAAS6L,EAAO7L,IAQrD8L,EAAc,SAACC,GACpB,OACCL,EAASK,EAAY,MAAO,IAC5BL,EAASK,EAAY,KAAM,IAI3BL,EAASK,EAAY,KAAM,IAE3BA,GAOK,SAASC,EAAWvc,EAAcwc,GAGxC,IAAI/Z,EAASga,IAzDU,SAACzc,GAAD,OAAkBA,EAAK0c,MAAM,iBAAmB,GA0DtEC,CAAgB3c,GACdV,IAAI4c,GACJ5c,IAAIyc,GACJzc,IAAI+c,GACJ3U,OAAOoU,IAOV,OAJIU,IACH/Z,EAASA,EAAOiF,OAAOkU,IAGjBnZ,I,6BC7ER,0FAMO,SAASma,EACfC,EACAC,GAEA,OAAO,IAAI7E,OACV6E,EAAMC,WAAaF,EAASG,IAAaH,GACzCC,EAAMG,UAAY,IAAM,MAQnB,SAASC,EAAoBhH,GAInC,OAAOA,EAAO/R,QAAQ,MAAO,U,0ICZjBgZ,EAA8C,SAAA1gB,GAAU,IAC7D2gB,EAAU3gB,EAAV2gB,OACAte,EAAKC,cAALD,EAEP,SAASue,EAAYC,GACd,OAANF,QAAM,IAANA,KAAQC,YAAYC,GACd,OAANF,QAAM,IAANA,KAAQG,QAGT,OACC,qCACC,cAAC,IAAD,CACC5gB,UAAWygB,EACXxgB,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,mCACT/B,QAAS,kBAAMsgB,EAAY,iBAE5B,cAAC,IAAD,CACC1gB,UAAWygB,EACXxgB,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,qCACT/B,QAAS,kBAAMsgB,EAAY,qB,gcCOxB,SAASxE,EACftJ,EACAgH,EACAK,GAEA,IACMnU,EADQ6T,EAAY/G,EAASgH,GACd/V,SAAS4P,MAAK,SAAAtH,GAAC,OAAIA,EAAEkB,KAAO4M,KAEjD,GAAInU,EACH,OAAOA,EAGR,MAAM,IAAIM,MAAJ,uCAC2B6T,EAD3B,iCAC6DL,EAD7D,OAKA,SAASoC,EACfpJ,EACAgH,EACAiH,GAEA,IACM/a,EADQ6T,EAAY/G,EAASgH,GACd/V,SAAS4P,MAAK,SAAAtH,GAAC,OAAIA,EAAElJ,OAAS4d,KAEnD,GAAI/a,EACH,OAAOA,EAGR,MAAM,IAAIM,MAAJ,yCAC6Bya,EAD7B,iCACiEjH,EADjE,OAUA,SAASkH,EACfjd,EACAkd,GAEA,IAAMC,EAAM,OAAGD,QAAH,IAAGA,IAAqB,SAAC1d,GAAD,OAAkBuc,YAAWvc,GAAM,IACjE4d,EAAa,IAAIC,IAAIrd,EAASlB,KAAI,SAAAwJ,GAAC,MAAI,CAACA,EAAElJ,KAAMkJ,OAChDrG,EAAS,CACdqb,UAAW,CACVC,OAAQ,IAAIC,IACZC,YAAa,IAAIJ,IACjBK,KAAM,IAAIF,KAEXG,MAAO,CACNJ,OAAQ,IAAIC,IACZC,YAAa,IAAIJ,IACjBK,KAAM,IAAIF,MA+BZ,OA3BAxd,EAAS8P,SAAQ,SAAA5F,GAAO,OACvBiT,EAAOjT,EAAQ1K,MAAMsQ,SAAQ,SAAA8N,GAC5B,GAAIA,IAAe1T,EAAQ9K,MACzB8K,EAAQ5K,SAAW2C,EAAOqb,UAAYrb,EAAO0b,OAAOD,KAAKG,IAAI3T,OACxD,CACN,IAAM4T,EAAgBV,EAAWW,IAAIH,GAErC,GAAIE,EAAe,CAClB,IAAM7P,EACL/D,EAAQ5K,UAAYwe,EAAcxe,SAC/B2C,EAAOqb,UACPrb,EAAO0b,MAEP1P,EAAOwP,YAAYO,IAAI9T,GAC1B+D,EAAOwP,YAAYM,IAAI7T,GAAU2T,IAAIC,GAErC7P,EAAOwP,YAAYQ,IAAI/T,EAAS,IAAIsT,IAAI,CAACM,UAGzC5T,EAAQ5K,SAAW2C,EAAOqb,UAAYrb,EAAO0b,OAAOJ,OAAOM,IAC3D3T,UAOEjI,EAOD,SAASic,EACfle,EACAqc,EACAC,GAEA,GAAe,KAAXD,EACH,MAAO,GAFI,IAKL8B,EAA8C7B,EAA9C6B,oBAAqB1B,EAAyBH,EAAzBG,UAAWF,EAAcD,EAAdC,WACjC6B,EAAUhC,YAAaC,EAAQ,CAACI,YAAWF,eAEjD,OAAOvc,EAASyH,QAAO,SAACxF,EAAQiI,GAC/B,OACCkU,EAAQ/N,KAAKnG,EAAQ1K,OACpB2e,GAAuBC,EAAQ/N,KAAKnG,EAAQ9K,MAEvC,GAAN,mBAAW6C,GAAX,CAAmBiI,IAGbjI,IACL,IAGG,SAASoc,EAAiBrU,GAChC,OAAOgL,MAAMsJ,KACZtU,EAAMhK,SAASyH,QAAO,SAACxF,EAAQiI,GAE9B,OADAA,EAAQ3K,MAAQ2K,EAAQ3K,KAAKuQ,SAAQ,SAAAG,GAAG,OAAIhO,EAAO4b,IAAI5N,MAChDhO,IACL,IAAIub,MACNe,OAGI,SAASC,EAAWxU,GAC1B,IAAMyU,EAAQzU,EAAMhK,SAASyH,QAC5B,SAACgX,EAAOvU,GAAR,4BACIuU,GADJ,YAEI1C,YAAW7R,EAAQ1K,MAAM0H,QAAO,SAAAmU,GAAI,OAA6B,IAAzBoD,EAAMhb,QAAQ4X,UAE1D,IAOD,MAAO,CACNqD,YALmBzC,IAAKwC,GAAOvX,QAC/B,SAAAmU,GAAI,OAAKrR,EAAMhK,SAASiD,MAAK,SAAAiH,GAAO,OAAIA,EAAQ9K,OAASic,QAKzDoD,QACAE,WAAY3U,EAAMhK,SAASyH,QAC1B,SAACmX,EAAO1U,GAAR,OAAoB0U,EAAQ1U,EAAQ1K,KAAK8C,SACzC,GAEDtC,SAAUgK,EAAMhK,SAASsC,OACzBgC,MAAO0F,EAAMhK,SAASyH,QACrB,SAACmX,EAAO1U,GAAR,OAAoB0U,EAAQ1U,EAAQ1K,KAAKgE,MAAM,OAAOlB,SACtD,IAKI,SAASuc,EAAU9P,GACzB,OAAOiG,MAAMsJ,KACZvP,EAAQtH,QAAO,SAACxF,EAAQ+H,GAEvB,OADAA,EAAMzK,MAAQyK,EAAMzK,KAAKuQ,SAAQ,SAAAG,GAAG,OAAIhO,EAAO4b,IAAI5N,MAC5ChO,IACL,IAAIub,MACNe,OAGI,SAASzI,EAAY/G,EAAkBgH,GAC7C,IAAM9T,EAAS8M,EAAQa,MAAK,SAAA/H,GAAC,OAAIA,EAAE2B,KAAOuM,KAE1C,GAAI9T,EACH,OAAOA,EAGR,MAAM,IAAIM,MAAJ,qCAAwCwT,EAAxC,OAGA,SAASF,EAAc9G,EAAkB3P,GAC/C,IAAM6C,EAAS8M,EAAQa,MAAK,SAAA/H,GAAC,OAAIA,EAAEzI,OAASA,KAE5C,GAAI6C,EACH,OAAOA,EAGR,MAAM,IAAIM,MAAJ,uCAA0CnD,EAA1C,S,6BC3NP,4EAUa0f,EAA4B,SAAA7iB,GAAU,IAC3CkB,EAA6ClB,EAA7CkB,SAAUuB,EAAmCzC,EAAnCyC,SAAUQ,EAAyBjD,EAAzBiD,YAAaI,EAAYrD,EAAZqD,SAElC3C,EAAYC,IAAW,OAAQ,CACpC8B,WACAQ,cACAI,aAGD,OAAO,qBAAK3C,UAAWA,EAAhB,SAA4BQ,M,qICb9B4hB,EAA6B,SAAA9iB,GAAK,OACvC,cAAC,IAAD,yBAAeW,WAAW,MAAM4R,QAAS,KAASvS,GAAlD,aACEA,EAAMkB,aAII6hB,EAAoB,WAAO,IAAD,EACdC,6BAAjBhgB,EAD+B,EAC/BA,OAAQU,EADuB,EACvBA,MADuB,EAEVuf,cAArBC,EAF+B,EAE/BA,SAAUC,EAFqB,EAErBA,QAEX1iB,EAA6B,CAClC2iB,aAAcpgB,EACdqgB,YAAa3f,GAGd,OACC,qBAAKhD,UAAU,UAAUD,MAAOA,EAAhC,SACC,cAAC,IAAD,CAAiB6iB,UAAW,KAA5B,SACEH,EAAQtgB,KAAI,SAAC0gB,EAAQzP,GACrB,IAAM0P,EAAkB,CACvBxhB,UAAWuhB,EAAOvhB,UAClBG,kBAAmB,SAACH,GAAD,OAClBkhB,EAAS,CAAC3hB,KAAM,qBAAsBS,YAAW8R,WAClD1R,QAAS,kBAAM8gB,EAAS,CAAC3hB,KAAM,eAAgBuS,YAGhD,OACC,cAACgP,EAAD,UACC,cAACS,EAAOD,UAAR,2BAAsBC,EAAOvjB,OAAWwjB,KADlB1P,Y,8GCfhB2P,EAAkD,SAAAzjB,GAAU,IACjE2gB,EAAiB3gB,EAAjB2gB,OAAQ+C,EAAS1jB,EAAT0jB,MACRrhB,EAAKC,cAALD,EAFgE,EAGzCtC,YAAe,GAH0B,mBAGhE4jB,EAHgE,KAGvDC,EAHuD,OAIzC7jB,YAAe,GAJ0B,mBAIhE8jB,EAJgE,KAIvDC,EAJuD,KAkBvE,SAASlD,EAAYC,GACd,OAANF,QAAM,IAANA,KAAQC,YAAYC,GACd,OAANF,QAAM,IAANA,KAAQG,QAGT,OAjBA/gB,aAAgB,WACf,GAAI4gB,EAAQ,CACX,IAAMoD,EAAUpD,EAAOqD,cAEvBJ,EAAWG,EAAQE,KAAO,GAC1BH,EAAWC,EAAQG,KAAO,QAE1BN,GAAW,GACXE,GAAW,KAEV,CAACnD,EAAQ+C,IAQX,qCACC,cAAC,IAAD,CACCxjB,UAAW2jB,EACX1jB,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,eACT/B,QAAS,kBAAMsgB,EAAY,WAE5B,cAAC,IAAD,CACC1gB,UAAWyjB,EACXxjB,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,eACT/B,QAAS,kBAAMsgB,EAAY,gB,6BCrD/B,6DASauD,EAAsCpkB,QAAW,SAAAC,GAC7D,OACC,qBAAKU,UAAU,aAAf,SACEV,EAAMsD,KAAKT,KAAI,SAAAmR,GAAG,OAClB,sBACCtT,UAAS,gBAAWV,EAAMsE,UAAU0P,IAEpCoQ,MAAOpQ,GADFA,Y,oKCXGqQ,EAAsD,SAClEvL,EACAjP,GAEA,OAAQA,EAAOtI,MACd,IAAK,YAIJ,IAAI+iB,GAAS,EACPC,EAAczL,EAAMjW,KAAI,SAAA2hB,GAC7B,OACCC,IAAQD,EAAa,CAEpBxiB,UAAWwiB,EAAYxiB,UACvBshB,UAAWzZ,EAAOyZ,UAClBtjB,MAAO6J,EAAO7J,SAGfskB,GAAS,EACF,2BAAIE,GAAX,IAAwBxiB,WAAW,KAG7BwiB,KAGR,OAAIF,EACIC,EAGF,GAAN,mBACIzL,GADJ,CAEC,CAACwK,UAAWzZ,EAAOyZ,UAAWthB,WAAW,EAAOhC,MAAO6J,EAAO7J,SAGhE,IAAK,eACJ,OAAO8Y,EAAM7N,QAAO,SAACsY,EAAQzP,GAAT,OAAmBA,IAAUjK,EAAOiK,SAEzD,IAAK,qBACJ,OAAOgF,EAAMjW,KAAI,SAAC0gB,EAAQzP,GAAT,OAChBA,IAAUjK,EAAOiK,MAAjB,2BACOyP,GADP,IACevhB,UAAW6H,EAAO7H,YAC9BuhB,O,gBCnCMmB,EAAiB3kB,gBAAyC,CACtEmjB,SAAU,aACVC,QAAS,KAGVuB,EAAeC,YAAc,UAEtB,IAAM1B,EAAoB,kBAAMljB,aAAiB2kB,IAE3CE,EAAmC,SAAA5kB,GAAU,IAAD,EAC5B6kB,IAAgBR,EAAS,IADG,mBACjDlB,EADiD,KACxCD,EADwC,KAGxD,OACC,eAACwB,EAAeI,SAAhB,CAAyBnjB,MAAO,CAACuhB,WAAUC,WAA3C,UACEnjB,EAAMkB,SACP,cAAC,IAAD,S,4HCLG6jB,EAGG,gBAHHA,EAIO,oBAJPA,EAKM,eALNA,EAMM,SANNA,EAOQ,iBAMd,SAASC,EAAMC,GACd,OAAOC,WAAWD,GAMnB,SAASE,EAAMC,EAAaC,GAC3B,OAAOtM,MAAMsJ,KAAK+C,EAAGE,iBAAiBD,IAMvC,SAASE,EAAgBC,GACxB,GAAmB,kBAARA,EAAX,CAIA,IAAMC,EAAOD,EAAIje,MAAM,KAEvB,OAAoB,IAAhBke,EAAKpf,OACD,CAACof,EAAK,GAAIA,EAAK,SADvB,GA0EM,SAASvM,EACfwM,EACAC,GAEA,IAAMvZ,EAAQ8F,SAAS0T,cAAc,OAIrC,OAFAxZ,EAAMyZ,UAAYH,EAEXP,EAAM/Y,EAAO2Y,GAAqBliB,KAAI,SAAAijB,GAC5C,IAAMC,EAtER,SAAqBD,GAAkC,IAAD,UAC/CE,EAAkBF,EAAQG,aAAa,aACzCC,OAAqCplB,EACnCiN,EAAuB,CAC5BnK,KAAI,UAAEkiB,EAAQG,aAAa,eAAvB,QAAkC5L,MACtC9M,GAAI8M,MACJxW,gBAAY/C,EACZqC,KAAI,UAAE2iB,EAAQG,aAAa,eAAvB,aAAkCnlB,EACtCqD,YAAW,UAAE2hB,EAAQG,aAAa,iBAAvB,aAAoCnlB,EAC/CsD,mBAAkB,UAAE0hB,EAAQG,aAAa,yBAAvB,aAA4CnlB,EAC9DkD,OAAQmhB,EAAMW,EAASf,GACrBliB,KAAI,SAAAuiB,GAAE,OAAIA,EAAGe,eACb5S,KAAK,MACPlP,WAAY8gB,EAAMW,EAASf,GACzBliB,KAAI,SAAAuiB,GAAE,OAAIA,EAAGe,eACb5S,KAAK,MACPjQ,KAAMwiB,EAAQG,aAAa,QACxBH,EAAQG,aAAa,QAAS1e,MAAM,OACpC,GACHhD,KAAM2gB,WAAU,UAACY,EAAQG,aAAa,eAAtB,QAAiC,KACjD3hB,UAAW6gB,EAAMW,EAASf,GAAqBvZ,QAAO,SAACxF,EAAQof,GAC9D,IAAMvG,EAAUuG,EAAGa,aAAa,QAEhC,MAAuB,kBAAZpH,EACH7Y,EAGD,2BAAIA,GAAX,kBAAoB6Y,EAAUuG,EAAGa,aAAa,aAC5C,IACHliB,SAAUohB,EAAMW,EAASf,GAAuBliB,KAAI,SAAAujB,GAAc,IAAD,IAC1D7Y,EAAK8M,MACLgM,EAAWd,EAAgBa,EAAUH,aAAa,aAClDK,EAAOf,EAAgBa,EAAUH,aAAa,SAMpD,OAJIG,EAAUH,aAAa,SAAWD,IACrCE,EAAiB3Y,GAGX,CACNA,KACArK,KAAMmjB,EAAWrB,EAAMqB,EAAS,SAAMvlB,EACtC2C,IAAK4iB,EAAWrB,EAAMqB,EAAS,SAAMvlB,EACrC4C,MAAO4iB,EAAOtB,EAAMsB,EAAK,SAAMxlB,EAC/BkC,OAAQsjB,EAAOtB,EAAMsB,EAAK,SAAMxlB,EAChCwC,KAAM8iB,EAAUH,aAAa,QAC1BG,EAAUH,aAAa,QAAS1e,MAAM,OACtC,GACHpE,KAAI,UAAEijB,EAAUH,aAAa,eAAzB,aAAoCnlB,EACxCyC,KAAI,UAAE6iB,EAAUD,mBAAZ,aAA2BrlB,OAMlC,OADAiN,EAAM7J,aAAegiB,EACdnY,EAgBgBwY,CAAYT,GAK5B/X,EAAesG,IAAS0R,EAAe,CAACxY,GAAI8M,OAAS1W,2BAe3D,OAXIgiB,IACH5X,EAAMlK,WAAa8hB,GAMpB5X,EAAMhK,SAAWgK,EAAMhK,SAASlB,KAAI,SAAAoL,GAAO,OAC1CoG,IAASpG,EAASlL,4BAAmB,CAACgL,MAAOA,EAAMR,QAG7CQ,O,iHC1JIyY,EAAkC,SAAAxmB,GAAK,OACnD,qBAAKU,UAAU,cAAf,SACC,cAAC,IAAD,eAAUV,Q,wFCHL,SAASymB,IAAmB,IAG3BjO,EAASkO,4BAATlO,MAH2B,EAIbzY,WACpBsO,OAAOsY,WAAW,iCADZC,EAJ2B,sBAOI7mB,WACrC6mB,EAAWC,QAAU,OAAS,SARG,mBAO3BC,EAP2B,KAOdC,EAPc,KAmBlC,OARAhnB,aAAgB,WACf,IAAMinB,EAAW,SAAChZ,GAAD,OAChB+Y,EAAe/Y,EAAM6Y,QAAU,OAAS,UAGzC,OADAD,EAAWzU,iBAAiB,SAAU6U,GAC/B,kBAAMJ,EAAWxU,oBAAoB,SAAU4U,MACpD,CAACJ,IAEsB,WAAnBpO,EAAMlE,SAAwBwS,EAActO,EAAMlE,W,6HCfpD2S,EAAwC,WAAO,IAC7C5kB,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CAAYnC,UAAQ,EAACC,KAAM,cAAC,IAAD,IAAiBU,MAAOwB,EAAE,oBAU1C6kB,EAAwE,SAAAlnB,GAAU,IACvFmnB,EAA4BnnB,EAA5BmnB,SAAUlZ,EAAkBjO,EAAlBiO,QAASF,EAAS/N,EAAT+N,MADmE,EAE/DhO,WAAekO,EAAQ9K,MAFwC,mBAEtFsb,EAFsF,KAE7EC,EAF6E,KAGtFrc,EAAKC,cAALD,EAoBP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACTb,SAAU,SAAAwM,GAAK,OAAI0Q,EAAW1Q,EAAMgE,OAAOrQ,QAC3C+V,SAAUyP,EACVxP,OAAQtV,EAAE,sBAAuB,CAACc,KAAM8K,EAAQ9K,OAChD4U,SAzBF,SAAkB5U,GACjB,MAAoB,KAAhBA,EAAKwE,OACD,CACNyQ,QAAS/V,EAAE,4CACX6V,OAAO,GAILnK,EAAMhK,SAASiD,MAAK,SAAAqF,GAAC,OAAIA,EAAEkB,KAAOU,EAAQV,IAAMlB,EAAElJ,OAASA,KACvD,CACNiV,QAAS/V,EAAE,kDACX6V,OAAO,GAIF,CAACA,OAAO,IAWdvW,MAAO8c,KAUG2I,EAA0D,SAAApnB,GACtE,OAAIA,EAAMiO,QAER,cAACiZ,EAAD,eACMlnB,IAKD,cAACinB,EAAD,M,yJCtDKI,EAAsC,SAAArnB,GAAU,IACrDsnB,EAAqDtnB,EAArDsnB,QAASxI,EAA4C9e,EAA5C8e,MAAO3b,EAAqCnD,EAArCmD,KAAM8b,EAA+Bjf,EAA/Bif,cAAesI,EAAgBvnB,EAAhBunB,aADe,EAE7BxnB,WAAeoD,GAFc,mBAEpDsb,EAFoD,KAE3CC,EAF2C,KAGpDrc,EAAKC,cAALD,EAUP,OACC,sBAAK3B,UAAU,aAAf,UACC,sBAAMA,UAAWC,IAAW,WAAD,gBAAsBX,EAAM8e,QAAvD,SACE9e,EAAMmD,OAER,cAAC,IAAD,CACChD,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACTb,SAAU,SAAAT,GAAC,OAAI2d,EAAW3d,EAAEiR,OAAOrQ,MAAM+F,QAAQ,MAAO,OACxDgQ,SAAU,kBAAM6P,EAAa9I,IAC7B9G,OAAQtV,EAAE,sBAAuB,CAACc,SAClCxB,MAAO8c,EACP1G,SApBH,SAAkBpW,GACjB,OAAIA,IAAUwB,GAAQmkB,EAAQpgB,SAASvF,GAC/B,CAACyW,QAAS/V,EAAE,sCAAuC6V,OAAO,GAG3D,CAACA,OAAO,MAiBd,cAAC,IAAD,CACC1W,SAAU,SAAAT,GAAC,OAAIke,EAAcle,EAAEiR,OAAOrQ,QACtCiB,QAASgb,IAAO/a,KAAI,SAAAic,GAAK,MAAK,CAC7Bje,MAAOwB,EAAE,UAAD,OAAWyc,IACnBnd,MAAOmd,MAERnd,MAAK,OAAEmd,QAAF,IAAEA,IAAS,GANjB,SAQEzc,EAAE,uB,0GC5CMmlB,EAA8B,SAAC,GAAgC,IAA/BtmB,EAA8B,EAA9BA,SAAUumB,EAAoB,EAApBA,MAAOC,EAAa,EAAbA,QAC7D,OACC,sBACChnB,UAAU,QACV6M,GAAIka,EACJjlB,KAAK,QACLmlB,kBAAA,UAAoBF,EAApB,UACAG,gBAAe,EACfC,gBAAe,IACfC,gBAAyB,IAAVJ,EAPhB,UASC,qBAAKhnB,UAAU,YAAf,SACC,sBAAMA,UAAU,SAASD,MAAO,CAACiD,MAAiB,IAAVgkB,EAAgB,SAEzD,qBAAKhnB,UAAU,cAAc6M,GAAE,UAAKka,EAAL,UAA/B,SACEvmB,Q,QCTQ6mB,EAA4C,SAAC,GAGnD,IAFNC,EAEK,EAFLA,MACA9mB,EACK,EADLA,SACK,EACiCnB,WAA8B,IAD/D,mBACEkoB,EADF,KACeC,EADf,OAEuBC,mCAArBjF,EAFF,EAEEA,SAAU3J,EAFZ,EAEYA,QAMjBxZ,aAAgB,WACf,IAAMqoB,EAAa7O,EAAQtO,QAC1B,SAAAod,GAAS,OACPJ,EAAYtU,MACZ,SAAA2U,GAAS,OACRA,EAAUnlB,OAASklB,EAAUllB,MAC7BmlB,EAAUnZ,UAAYkZ,EAAUlZ,cAIhCiZ,EAAW/hB,OAAS,IACvB6c,EAASqF,kCAAwBH,IACjCF,EAAe,GAAD,mBAAKD,GAAL,YAAqBG,QAElC,CAAClF,EAAU3J,EAAS0O,IAEvB,IAAMO,EAAgBjP,EAAQ5F,MAAK,SAAA8U,GAAC,MAAoB,YAAhBA,EAAE9Z,aACpC+Z,EACLnP,EAAQtO,QAAO,SAAAwd,GAAC,MAAoB,WAAhBA,EAAE9Z,aAAwBtI,OAASkT,EAAQlT,OAEhE,OAAI2hB,GAASU,EAAc,EAEzB,cAAC,EAAD,CAAOjB,MAAM,sBAAsBC,QAASgB,EAA5C,SACEF,GACA,gDACUA,EAAcrlB,KADxB,IAC+BqlB,EAAcrZ,aAO1C,mCAAGjO,M,sxBCtDJ,SAASynB,EACfxlB,EACAxB,GAQA,MAAO,CAACJ,KAAM,SAAU4B,OAAMxB,SAV/B,mC,6BCEO,SAASinB,EACfpQ,EACArV,EACAgM,GAEA,OAAOqJ,EAAM/D,oCAAoCzN,MAChD,SAAAyhB,GAAC,OAAIA,EAAEtlB,OAASA,GAAQslB,EAAEtZ,UAAYA,KATxC,mC,2DCMO,SAAS0Z,EAAc9a,GAC7B,OAAOA,EAAM5K,KAAKuE,QAAQ,YAAa,KAAO,QAP/C,mC,kUCWO,SAASohB,EACfnP,EACA/K,GAEA,IAAKA,EAAWzL,OAASyL,EAAWO,QACnC,MAAM,IAAI7I,MAAM,sDAGjB,MAAO,CACN/E,KAAM,SACNvB,MAAO,CACN2Z,MACAxW,KAAMyL,EAAWzL,KACjBE,UAAU,EACViX,WAAW,EACXnL,QAASP,EAAWO,UAQhB,SAAS4Z,EAAata,GAC5B,MAAO,CAAClN,KAAM,SAAUgM,GAAIkB,EAAOlB,IAM7B,SAASyb,IACf,OAAO,SAAC9F,EAAU+F,GAAgB,IAAD,gBACXA,KADW,IAChC,2BAAmC,CAAC,IAAzBxa,EAAwB,QAC9BA,EAAOpL,UACV6f,EAAS,CAAC3hB,KAAM,SAAUgM,GAAIkB,EAAOlB,GAAIvN,MAAO,CAACqD,UAAU,MAH7B,gCAY3B,SAAS6lB,EAAeza,GAC9B,MAAO,CAAClN,KAAM,SAAUgM,GAAIkB,EAAOlB,GAAIvN,MAAO,CAACqD,UAAU,I,SAG3C8lB,E,gFAAf,WACC1a,EACAyU,GAFD,iBAAAxX,EAAA,6DAICwX,EAAS,CACR3hB,KAAM,SACNgM,GAAIkB,EAAOlB,GACXvN,MAAO,CAAC2O,UAAW,aAPrB,kBAWyB+K,YAA2BjL,EAAOkL,KAX3D,OAmBE,IARI/K,EAXN,QAmBiB2J,QACd,IACO6Q,EAAgD,GAGlC,IAAIC,SAASza,EAAW2J,SAEhC+Q,KAAKF,GACjBxa,EAAU,2BAAOwa,GAAkBxa,GAClC,MAAO7N,GACRgI,QAAQ0U,MAAR,iBACWhP,EAAOlB,GADlB,6DAECxM,GA/BL,OAoCEmiB,EAAS,CACR3hB,KAAM,SACNgM,GAAIkB,EAAOlB,GACXvN,MAAO,CAAC4O,aAAYD,UAAW,YAvClC,kBA0CSC,GA1CT,kCA4CEsU,EAAS,CACR3hB,KAAM,SACNgM,GAAIkB,EAAOlB,GACXvN,MAAO,CAACsc,UAAU,EAAD,GAAmC3N,UAAW,WA/ClE,2D,sBAwDO,SAAS4Z,EACfhP,GAEA,IAAMgQ,EAAShQ,EAAQtO,QACtB,SAAAwd,GAAC,MAAoB,WAAhBA,EAAE9Z,WAA0C,YAAhB8Z,EAAE9Z,aAGpC,OAAK4a,EAIL,uCAAO,WAAOrG,GAAP,SAAAxX,EAAA,sEACAmR,QAAQ2M,WACbD,EAAO1mB,KAAI,SAAA4L,GAAM,OAAI0a,EAAgB1a,EAAQyU,OAFxC,2CAAP,sDAHQ,aAeF,SAASuG,EAAqBhb,GACpC,MAAyB,WAArBA,EAAOE,UACH,kBAAMF,EAAOG,YAGrB,uCAAO,WAAOsU,GAAP,SAAAxX,EAAA,sEACAyd,EAAgB1a,EAAQyU,GADxB,mFAAP,sDAOM,SAASwG,EACfjb,EACAkb,GAEA,OAAO,SAACzG,EAAU0G,GASjB,GARKnb,EAAOpL,UACX6f,EAAS,CACR3hB,KAAM,SACNgM,GAAIkB,EAAOlB,GACXvN,MAAO,CAACqD,UAAU,KAIhBsmB,EAAW,CAAC,IAAD,gBACMC,KADN,IACd,2BAAgC,CAAC,IAAtBtY,EAAqB,QAC3BA,EAAM/D,KAAOkB,EAAOlB,IAAM+D,EAAMjO,UACnC6f,EAAS,CACR3hB,KAAM,SACNgM,GAAI+D,EAAM/D,GACVvN,MAAO,CAACqD,UAAU,MANP,mC,6PC/JV,SAASwmB,EACftQ,EACAtO,GAEA,OAAQA,GACP,IAAK,MACJ,OAAOsO,EAER,IAAK,UACJ,OAAOzS,OAAOuU,OACb9B,EAAQ/N,QAAoC,SAACxF,EAAQyI,GACpD,OACEzI,EAAOyI,EAAOtL,OACf2mB,IAAS9jB,EAAOyI,EAAOtL,MAAMgM,QAASV,EAAOU,SAEtC,2BAAInJ,GAAX,kBAAoByI,EAAOtL,KAAOsL,IAG5BzI,IACL,KAGL,IAAK,OACJ,OAAOuT,EAAQtO,QAAO,SAAAwD,GAAM,OAAIA,EAAO6L,cAInC,SAASyP,EAAetb,GAC9B,GAAyB,WAArBA,EAAOE,YAA2BF,EAAOG,WAAWob,MACvD,MAAM,IAAI1jB,MAAM,gCAGjB,OAAI2jB,IAAcxb,EAAOG,WAAWob,OAC5Bvb,EAAOG,WAAWob,MAGnBvb,EAAOkL,IAAIjS,QAAQ,YAAa,KAAO+G,EAAOG,WAAWob,MAG1D,SAASE,EAAa3Q,EAAwBhM,GACpD,IAAMvH,EAASuT,EAAQ5F,MAAK,SAAA8U,GAAC,OAAIA,EAAElb,KAAOA,KAE1C,GAAIvH,EACH,OAAOA,EAGR,MAAM,IAAIM,MAAJ,4CAA+CiH,EAA/C,OAGA,SAASiM,EACfD,EACApW,EACAgM,GAEA,IAAMnJ,EAASuT,EAAQ5F,MAAK,SAAA8U,GAAC,OAAIA,EAAEtlB,OAASA,GAAQslB,EAAEtZ,UAAYA,KAElE,GAAInJ,EACH,OAAOA,EAGR,MAAM,IAAIM,MAAJ,8CACkCnD,EADlC,0BACwDgM,EADxD,OAKA,SAASgb,EAAY5Q,GAC3B,OAAOA,EAAQ+I,MAAK,SAAC5W,EAAG0e,GAGvB,OAAI1e,EAAEvI,KAAOinB,EAAEjnB,MACN,EAGLuI,EAAEvI,KAAOinB,EAAEjnB,KACP,EAKJuI,EAAEyD,UAAYib,EAAEjb,QACZ,EAGJ2a,IAASM,EAAEjb,QAASzD,EAAEyD,UACjB,EAGF,O,6DC5FT,oEAAO,IAAMkb,EAAU,GACVC,EAAU,G,wLCUVC,EAAoD,SAAAvqB,GAAU,IACnEkjB,EAAYwD,4BAAZxD,SACA7gB,EAAKC,cAALD,EAIP,OAFAtC,aAAgB,kBAAMmjB,EAASyF,kBAAQ,eAAe,MAAQ,CAACzF,IAG9D,eAAC,IAAD,2BACKljB,GADL,IAECU,UAAU,sBACVuB,WAAS,EACTC,YAAaG,EAAE,6BAJhB,UAMC,cAAC,IAAD,UACC,sBAAK3B,UAAU,OAAf,UACC,4BAAI2B,EAAE,wCACN,4BAAIA,EAAE,uCAGR,eAAC,IAAD,WACC,cAAC,IAAD,CACCsa,KAAK,6BACLxc,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,8BACT7B,QAAQ,YAET,cAAC,IAAD,CACCL,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,gCACT/B,QAASN,EAAMoC,mB,qLCrBPooB,EAAsD,SAAAxqB,GAAU,IACrE8Z,EAAqB9Z,EAArB8Z,QAAYxI,EADwD,YAC/CtR,EAD+C,eAE/CyqB,sCAArBvH,EAFoE,EAEpEA,SAAUpQ,EAF0D,EAE1DA,QACVzQ,EAAKC,cAALD,EAED0L,EAAQ8L,sBAAY/G,EAASgH,GAC7BxW,EAAO8e,2BAAiBrU,GAgB9B,OACC,cAAC,IAAD,yBACCrN,UAAU,sBACVuB,WAAS,EACTC,YAAaG,EAAE,8BACXiP,GAJL,aAMC,cAAC,IAAD,UACEhO,EAAK+C,OAAS,EACd/C,EAAKT,KAAI,SAAAmR,GAAG,OACX,cAAC,IAAD,CACCsT,QAAShkB,EACTwb,MAAO/Q,EAAMzJ,UAAU0P,GAEvB7Q,KAAM6Q,EACNiL,cAAe,SAAAH,GAAK,OA7B1B,SAA2BD,EAAiBC,GAC3CoE,EACCwH,sBAAY3c,EAAO8Q,EAASC,GAC5Bzc,EAAE,8BA0B0BsoB,CAAkB3W,EAAK8K,IAC/CyI,aAAc,SAAA9I,GAAO,OAvB3B,SAA6BI,EAAiBJ,GAC7CyE,EACC0H,2BAAiB7c,EAAO8Q,EAASJ,GACjCpc,EAAE,yBAoB2BwoB,CAAoB7W,EAAKyK,KAH7CzK,MAOP,4BAAI3R,EAAE,uC,8KC7CEyoB,EAA8D,SAAA9qB,GAAU,IAC7E8Z,EAAqB9Z,EAArB8Z,QAAYxI,EADgE,YACvDtR,EADuD,eAEnDD,aAFmD,mBAE5EgrB,EAF4E,KAElEC,EAFkE,OAGvDC,8BAArB/H,EAH4E,EAG5EA,SAAUpQ,EAHkE,EAGlEA,QACV0F,EAASkO,4BAATlO,MACDzK,EAAQ8L,sBAAY/G,EAASgH,GAC5BzX,EAAKC,cAALD,EAWP,OACC,eAAC,IAAD,2BACKiP,GADL,IAEC5Q,UAAU,0BACVwB,YAAaG,EAAE,iCAHhB,UAKC,4BAAIA,EAAE,yCACN,eAAC,IAAD,WACC,cAAC,IAAD,CAAiBse,OAAQoK,EAAUrH,MAAO3V,EAAM/J,SAChD,cAAC,IAAD,CAAe2c,OAAQoK,OAExB,cAAC,IAAD,UACC,cAAC,IAAD,CACCG,eAAgBF,EAChBrU,WAAY6B,EAAMjE,qBAClBqC,UAAW4B,EAAMhE,oBACjB3T,MAAOwB,EAAE,uCACTyU,aAAW,EACXqU,eA3BiB,SACpBxK,EACAlT,EACAlK,GAEAynB,EAAYrK,GACZuC,EAASkI,sBAAYtY,EAAS/E,EAAO,CAAC/J,OAAQT,MAsB3CX,QAAO,2BACHib,YAA2BrF,IADxB,IAEN6S,WAAW,EACXC,KAAM,eAEP3pB,MAAOoM,EAAM/J,iB,qLCrCZunB,EAAiB,CACtBC,KAAK,EACL,aAAa,GAODC,EAAsD,SAAAzrB,GAAU,IAAD,MACpE8Z,EAAqB9Z,EAArB8Z,QAAYxI,EADwD,YAC/CtR,EAD+C,eAEjDD,WAAiC,CAC1DmiB,qBAAqB,EACrB1B,WAAW,EACXF,YAAY,IAL8D,mBAEpED,EAFoE,KAE7DqL,EAF6D,OAO7C3rB,WAAe,IAP8B,mBAOpE2H,EAPoE,KAO3DikB,EAP2D,OAQnD5rB,WAAe,IARoC,mBAQpE4T,EARoE,KAQ9DiY,EAR8D,OAS/CnB,sCAArBvH,EAToE,EASpEA,SAAUpQ,EAT0D,EAS1DA,QACVzQ,EAAKC,cAALD,EAED0L,EAAQ8L,sBAAY/G,EAASgH,GAC7B+M,EAAU5E,iCAAuBlU,EAAMhK,SAAU4P,EAAM0M,GA+B7D,SAASwL,EAAW1oB,GACnBuoB,GAAS,SAAArL,GAAK,kCAASA,GAAT,kBAAiBld,GAAQkd,EAAMld,QAG9C,OAjCApD,aAAgB,WAGf,OAFAmjB,EAAS4I,0CAAgC/d,EAAO4F,EAAM0M,IAE/C,kBAAM6C,EAAS4I,0CAAgC/d,EAAO,GAAI,QAC/D,CAACmV,EAAUvP,EAAM0M,EAAOtS,IA8B1B,eAAC,IAAD,2BACKuD,GADL,IAEC5Q,UAAU,sBACVuB,WAAS,EACTC,YAAaG,EAAE,6BAJhB,UAMC,sBAAK3B,UAAU,gBAAf,UACC,cAAC,IAAD,CACCG,MAAOwB,EAAE,4BACT8oB,eA7BJ,SACCxK,EACAlT,EACAlK,GAEAqoB,EAAQroB,IAyBLX,QAAS,CACRkb,UAAWyN,EACXD,KAAM,QAEP3pB,MAAOgS,IAER,cAAC,IAAD,CACC9S,MAAOwB,EAAE,mCACT8oB,eA9CJ,SACCxK,EACAlT,EACAlK,GAEAooB,EAAWpoB,IA0CRX,QAAS,CAACkb,UAAWyN,EAAWD,KAAM,QACtC3pB,MAAO+F,OAGT,sBAAKhH,UAAU,eAAf,UACC,cAAC,IAAD,CACCG,MAAOwB,EAAE,2CACTb,SAAU,kBAAMqqB,EAAW,wBAC3BlqB,MAAK,UAAE0e,EAAM6B,2BAAR,WAEN,cAAC,IAAD,CACCrhB,MAAOwB,EAAE,iCACTb,SAAU,kBAAMqqB,EAAW,cAC3BlqB,MAAK,UAAE0e,EAAMG,iBAAR,WAEN,cAAC,IAAD,CACC3f,MAAOwB,EAAE,kCACTb,SAAU,kBAAMqqB,EAAW,eAC3BlqB,MAAK,UAAE0e,EAAMC,kBAAR,cAGP,sBAAK5f,UAAU,iBAAf,UACC,cAAC,IAAD,CACCR,SAA6B,IAAnB2mB,EAAQxgB,OAClBlG,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,kCACT/B,QAzDJ,WACC4iB,EACC6I,yBAAehe,EAAO4F,EAAMjM,EAAS2Y,GACrC,8BAuDE7f,QAAQ,WAET,+BACEmT,IACCkT,EAAQxgB,OAAS,EACfhE,EAAE,iCAAkC,CAACsgB,MAAOkE,EAAQxgB,SACpDhE,EAAE,6C,8KClHE2pB,EAA8D,SAAAhsB,GAAU,IAC7E8Z,EAAqB9Z,EAArB8Z,QAAYxI,EADgE,YACvDtR,EADuD,eAEnDD,aAFmD,mBAE5EgrB,EAF4E,KAElEC,EAFkE,OAGvDC,8BAArB/H,EAH4E,EAG5EA,SAAUpQ,EAHkE,EAGlEA,QACV0F,EAASkO,4BAATlO,MACDzK,EAAQ8L,sBAAY/G,EAASgH,GAC5BzX,EAAKC,cAALD,EAWP,OACC,eAAC,IAAD,2BACKiP,GADL,IAEC5Q,UAAU,0BACVwB,YAAaG,EAAE,iCAHhB,UAKC,4BAAIA,EAAE,yCACN,eAAC,IAAD,WACC,cAAC,IAAD,CAAiBse,OAAQoK,EAAUrH,MAAO3V,EAAM/J,SAChD,cAAC,IAAD,CAAe2c,OAAQoK,OAExB,cAAC,IAAD,UACC,cAAC,IAAD,CACCG,eAAgBF,EAChBrU,WAAY6B,EAAMjE,qBAClBqC,UAAW4B,EAAMhE,oBACjB3T,MAAOwB,EAAE,uCACTyU,aAAW,EACXqU,eA3BiB,SACpBxK,EACAlT,EACAlK,GAEAynB,EAAYrK,GACZuC,EAASkI,sBAAYtY,EAAS/E,EAAO,CAAC1J,WAAYd,MAsB/CX,QAAO,2BACHib,YAA2BrF,IADxB,IAEN6S,WAAW,EACXC,KAAM,QAEP3pB,MAAOoM,EAAM1J,qB,uJC5CL4nB,EAAkD,SAAAjsB,GAAU,IAAD,EAC1ByqB,sCAA5ByB,EADsD,EAChEhJ,SAA2BpQ,EADqC,EACrCA,QADqC,EAE9B4T,4BAAxByF,EAFsD,EAEhEjJ,SAAyB1K,EAFuC,EAEvCA,MACzBnW,EAAKC,cAALD,EAEDiB,EAAOsf,oBAAU9P,GAYvB,OACC,cAAC,IAAD,yBACCpS,UAAU,oBACVuB,WAAS,EACTC,YAAaG,EAAE,4BACXrC,GAJL,aAMC,cAAC,IAAD,UACEsD,EAAK+C,OAAS,EACd/C,EAAKT,KAAI,SAAAmR,GAAG,OACX,cAAC,IAAD,CACCsT,QAAShkB,EACTwb,MAAOtG,EAAM7C,eAAe3B,GAE5B7Q,KAAM6Q,EACNiL,cAAe,SAAAH,GAAK,OAzB1B,SAA2BD,EAAiBC,GAC3CqN,EACCxD,kBAAQ,iBAAD,YAAC,eAAsBnQ,EAAM7C,gBAA7B,kBAA8CkJ,EAAUC,MAuBnC6L,CAAkB3W,EAAK8K,IAC/CyI,aAAc,SAAA9I,GAAO,OApB3B,SAA6BI,EAAiBJ,GAC7CyN,EAAgBE,yBAAetZ,EAAS+L,EAASJ,IAmBnBoM,CAAoB7W,EAAKyK,KAH7CzK,MAOP,4BAAI3R,EAAE,qC,60BClCJ,SAASgqB,EACfte,EACAE,EACAqe,EACAC,GAEA,IAAKxe,EAAMhK,SAASiD,MAAK,SAAAqF,GAAC,OAAIA,EAAEkB,KAAOU,EAAQV,MAC9C,MAAM,IAAIjH,MAAM,+CAGjB,OAAO,SAAA4c,GACN,IAAMsJ,EAAW1M,YAAWyM,GACtBE,EAAW3M,YAAWwM,GAASrhB,QACpC,SAAA9C,GAAC,OAAKqkB,EAAStlB,SAASiB,KAAO4F,EAAMhK,SAASiD,MAAK,SAAAqF,GAAC,OAAIA,EAAElJ,OAASgF,QAGpE,GAAwB,IAApBskB,EAASpmB,OAAb,CA2BA,IAvBA,IAAMqmB,EAAc3pB,cACd4pB,EAAa,GAEflpB,EAAMwK,EAAQxK,IAAMwK,EAAQjL,OAAS2pB,EACnCC,EACLH,EAASpmB,OAASqmB,EAAYhpB,OAAS+oB,EAASpmB,OAAS,GAAKsmB,EAI3DzpB,EAAO+K,EAAQ/K,MAAQ+K,EAAQvK,MAAQkpB,GAAoB,EAIzDC,EAAc,kBACnB9e,EAAMhK,SAASiD,MAAK,SAAAiH,GAAO,OAC1BvI,YAAeuI,EAAS,CACvB/K,OACAO,MACAT,OAAQ0pB,EAAY1pB,OACpBU,MAAOkpB,QAIHC,MAGN3pB,GAAQwpB,EAAYhpB,MAAQipB,EAEvBE,OAML3pB,GAAQ,GAAKwpB,EAAYhpB,MAAQipB,GAE5BE,MAML3pB,GAAQwpB,EAAYhpB,MAAQipB,EAC5BlpB,GAAOipB,EAAY1pB,OAAS2pB,EAK7BzJ,EAAS,CACR3hB,KAAM,iBACNuY,QAAS/L,EAAMR,GACfvN,MAAOysB,EAAS5pB,KAAI,SAAAM,GACnB,IAAM6C,EAAS,CAAC9C,OAAMC,OAAMM,OAG5B,OADAP,GAAQwpB,EAAYhpB,MAAQipB,EACrB3mB,S,WCvFJ,SAAS8mB,EAAW3pB,EAAc4pB,GACxC,GAAIA,EAAS7lB,SAAS/D,GAAO,CAG5B,IAFA,IAAI6pB,EAAS,EAEND,EAAS7lB,SAAT,UAAqB/D,EAArB,YAA6B6pB,KACnCA,IAGD,MAAM,GAAN,OAAU7pB,EAAV,YAAkB6pB,GAGnB,OAAO7pB,ECLD,SAAS8pB,EACflf,EACAmf,EACAC,GAEA,IAAKrjB,OAAOsjB,SAASF,KAAapjB,OAAOsjB,SAASD,GACjD,MAAM,IAAI7mB,MAAM,2CAGjB,IAAM+mB,EAAOtqB,cACPge,EAAc+L,EACnBO,EAAKlqB,KACL4K,EAAMhK,SAASlB,KAAI,SAAAoL,GAAO,OAAIA,EAAQ9K,SAKjCwpB,EAAa,GACbW,EAAS,CACdtqB,OAAQqqB,EAAKrqB,OACbE,KAAMgC,KAAKqoB,IAAIL,EAAUG,EAAK3pB,MAAQ,EAAG,GACzCD,IAAKyB,KAAKqoB,IAAIJ,EAAUE,EAAKrqB,OAAS,EAAG,GACzCU,MAAO2pB,EAAK3pB,OAGTqK,EAAM9J,aACTqpB,EAAOpqB,KAAOgC,KAAKsoB,MAAMF,EAAOpqB,KAAOypB,GAAcA,EACrDW,EAAO7pB,IAAMyB,KAAKsoB,MAAMF,EAAO7pB,IAAMkpB,GAAcA,GAMpD,IAHA,IAAME,EAAc,kBACnB9e,EAAMhK,SAASiD,MAAK,SAAAiH,GAAO,OAAIvI,YAAeuI,EAASqf,OAEjDT,MAGNS,EAAOpqB,MAAQoqB,EAAO5pB,MAAQipB,EAEzBE,OAMLS,EAAOpqB,MAAQoqB,EAAO5pB,MAAQipB,EAC9BW,EAAO7pB,KAAO6pB,EAAOtqB,OAAS2pB,EAEzBE,MAdgB,CAoBrB,GAAIS,EAAOpqB,MAAQoqB,EAAO5pB,MAAQipB,EAAY,CAG7C,GAFAW,EAAOpqB,MAAQoqB,EAAO5pB,MAAQipB,GAEzBE,IACJ,MAGDS,EAAOpqB,MAAQoqB,EAAO5pB,MAAQipB,EAK/BW,EAAO7pB,KAAO6pB,EAAOtqB,OAAS2pB,EAG/B,MAAO,CACNprB,KAAM,gBACNuY,QAAS/L,EAAMR,GACfvN,MAAM,2BACFstB,GADC,IAEJvf,MAAOA,EAAMR,GACbpK,KAAM4d,K,qBC1EF,SAAS0M,EACf3a,EACA0F,GAEsC,IADtCxY,EACqC,uDADQ,GAEvCuN,EAAK8M,MACLlX,EAAO2pB,EACZnpB,cAAgBR,KAChB2P,EAAQjQ,KAAI,SAAAkL,GAAK,OAAIA,EAAM5K,SAG5B,OAAO,SAAA+f,GAYN,OAXAA,EAAS,CACR3hB,KAAM,cACNvB,MAAM,aACLuN,KACApK,OACAgB,YAAaqU,EAAMrU,YAAYhB,KAC/BiB,mBAAoBoU,EAAMrU,YAAYgL,SACnCnP,KAIEuN,GCTF,SAASmgB,EACf3f,EACAhK,GAEA,MAAO,CACNxC,KAAM,iBACNuY,QAAS/L,EAAMR,GACfuO,WAAY/X,EAASlB,KAAI,SAAAoL,GAAO,OAAIA,EAAQV,OC7BvC,SAAS4O,EAAYpO,GAC3B,MAAO,CAACxM,KAAM,cAAeuY,QAAS/L,EAAMR,ICItC,SAASogB,EACf5f,EACA+E,GAEA,MAAO,CACNvR,KAAM,cACNvB,MAAM,2BACF+N,GADC,IAEJR,GAAI8M,MACJzW,KAAMyW,MACNlX,KAAM2pB,EACL/e,EAAM5K,KACN2P,EAAQjQ,KAAI,SAAAkL,GAAK,OAAIA,EAAM5K,Y,8BCPxB,SAASyqB,EACf7f,EACAE,EACAjO,GAEsC,IADtC4C,EACqC,uDADL,GAEhC,IAAKmL,EAAMhK,SAASiD,MAAK,SAAAqF,GAAC,OAAIA,EAAEkB,KAAOU,EAAQV,MAC9C,MAAM,IAAIjH,MAAM,+CAGjB,GACC,SAAUtG,GACV+N,EAAMhK,SACJkH,QAAO,SAAAoB,GAAC,OAAIA,EAAElJ,OAASnD,EAAMmD,QAC7B6D,MAAK,SAAAqF,GAAC,OAAIA,EAAEkB,KAAOU,EAAQV,MAE7B,MAAM,IAAIjH,MAAJ,4CAA+CtG,EAAMmD,KAArD,OAGP,OAAO,SAAC+f,EAAU0G,GAGjB,IAAMiE,EAAU5f,EAAQ9K,KAClBopB,EAAUte,EAAQ1K,KAexB,GAbA2f,EAAS,CACRljB,QACAuB,KAAM,gBACN4Y,UAAWlM,EAAQV,GACnBuM,QAAS/L,EAAMR,MAKX3K,EAAQkrB,+BAAiC9tB,EAAMuD,MACnD2f,EAASmJ,EAA0Bte,EAAOE,EAASjO,EAAMuD,KAAMgpB,IAG5DvsB,EAAMmD,KAAM,CACf,IAAM4qB,EAAiBxN,IAAasN,GAM9BG,EAAiBhuB,EAAMmD,KAAKuE,QAAQ,MAAO,QAE3CumB,EAAmB,IAAIzS,OAC5B,SAAWuS,EAAiB,qBAC5B,KAEKG,EAAqB,IAAI1S,OAC9B,sBAAwBuS,EAAiB,qBACzC,KAEKI,EAAoB,IAAI3S,OAC7B,SAAWuS,EAAiB,4BAC5B,KAGDhgB,EAAMhK,SAAS8P,SAAQ,SAAAua,GACtB,GACCH,EAAiB7Z,KAAKga,EAAgB7qB,OACtC2qB,EAAmB9Z,KAAKga,EAAgB7qB,OACxC4qB,EAAkB/Z,KAAKga,EAAgB7qB,MACtC,CACD,IAAI+oB,EAAU8B,EAAgB7qB,KAU9B+oB,GAJAA,GAJAA,EAAUA,EAAQ5kB,QACjBumB,EACA,KAAOD,EAAiB,SAEPtmB,QACjBwmB,EACA,SAAWF,EAAiB,SAEXtmB,QACjBymB,EACA,KAAOH,EAAiB,UAGzBJ,EACC7f,EACAqgB,EACA,CAAC7qB,KAAM+oB,GACP1pB,EAJDgrB,CAKE1K,EAAU0G,SC5CV,SAASmC,EACfhe,EACAsgB,EACAC,EACAjO,GAEA,OAAO,SAAC6C,EAAU0G,GAAX,OACN7b,EAAMhK,SAAS8P,SAAQ,SAAA5F,IAlDlB,SACNF,EACAE,EACAogB,EACAC,EACAjO,GAEA,OAAO,SAAC6C,EAAU0G,GACjB,GAAkB,KAAdyE,EACH,MAAM,IAAI/nB,MAAM,iCAGjB,GAAI2H,EAAQF,QAAUA,EAAMR,GAC3B,MAAM,IAAIjH,MAAM,oCANa,IASvB4b,EAA8C7B,EAA9C6B,oBAAqB1B,EAAyBH,EAAzBG,UAAWF,EAAcD,EAAdC,WACjC6B,EAAUhC,YAAakO,EAAW,CAAC7N,YAAWF,eAC9CtgB,EAA0B,GAC1BuuB,EAAWjO,EACdgO,EACA7N,YAAoB6N,GAEjBhC,EAAUre,EAAQ1K,KAAKmE,QAAQya,EAASoM,GAM9C,GAJIjC,IAAYre,EAAQ1K,OACvBvD,EAAMuD,KAAO+oB,GAGVpK,EAAqB,CACxB,IAAMzD,EAAUxQ,EAAQ9K,KAAKuE,QAAQya,EAASoM,GAE1C9P,IAAYxQ,EAAQ9K,OACvBnD,EAAMmD,KAAOsb,GAIX3X,OAAOC,KAAK/G,GAAOqG,OAAS,GAC/BunB,EAAc7f,EAAOE,EAASjO,EAA9B4tB,CAAqC1K,EAAU0G,IAa/C4E,CACCzgB,EACAE,EACAogB,EACAC,EACAjO,EALDmO,CAMEtL,EAAU0G,O,qBC1DR,SAASkC,EACf/d,EACAqS,EACAC,GAEA,OAAO,SAAA6C,GACN,IAAIhJ,EAAmD,GAEvD,GAAe,KAAXkG,EAEHlG,EAAiBnM,EAAMhK,SAASyH,QAAO,SAACxF,EAAQiI,GAC/C,OAAIA,EAAQhL,YACJ,2BAAI+C,GAAX,kBAAoBiI,EAAQV,GAAK,CAACtK,aAAa,KAGzC+C,IACL,QACG,CACN,IAAMyoB,EAAWxM,YAChBlU,EAAMhK,SACNqc,EACAC,GACCxd,KAAI,SAAAoL,GAAO,OAAIA,EAAQV,MAEzBQ,EAAMhK,SAAS8P,SAAQ,SAAA5F,GACtB,IAAMygB,EAAiBzgB,EAAQhL,YACzB0rB,EAAiBF,EAASvnB,SAAS+G,EAAQV,IAE7CohB,IAAmBD,IACtBxU,EAAejM,EAAQV,IAAM,CAACtK,YAAa0rB,OAI1C7nB,OAAOC,KAAKmT,GAAgB7T,OAAS,GACxC6c,EAAS,CACRhJ,iBACA3Y,KAAM,iBACNuY,QAAS/L,EAAMR,M,YCnCZ,SAAS2L,EACf0V,EACAC,GAgBA,OAdAD,EAAS/a,SAAQ,SAAAib,GAChB,GACCF,EAAS5nB,MACR,SAAA+nB,GAAU,OACTA,IAAeD,GACfjG,wBAAckG,KAAgBlG,wBAAciG,MAG9C,MAAM,IAAIxoB,MAAJ,wDAC4CwoB,EAAY3rB,KADxD,SAMD,SAAA+f,GACN0L,EAAS/a,SAAQ,SAAAib,GAGhB,IAAM9uB,EAAqB,eAAO8uB,UAE3B9uB,EAAMuN,GAEb,IAAMyhB,EAAgBH,EAAgBlb,MACrC,SAAA/H,GAAC,OAAIid,wBAAcjd,KAAOid,wBAAciG,MAOxC5L,EADG8L,EACM,CAAChvB,QAAOuB,KAAM,cAAeuY,QAASkV,EAAczhB,IAEpD,CAACvN,QAAOuB,KAAM,oBC3CpB,SAAS0tB,EACflhB,EACA+N,EACAoT,EACAC,GAEA,IAAMjV,EAAmD,GAEzD,IAAKpQ,OAAOsjB,SAAS8B,KAAaplB,OAAOsjB,SAAS+B,GACjD,MAAM,IAAI7oB,MAAM,mCAuBjB,OApBAwV,EAAWjI,SAAQ,SAAAsG,GAClB,IAAMlM,EAAUF,EAAMhK,SAAS4P,MAAK,SAAAtH,GAAC,OAAIA,EAAEkB,KAAO4M,KAElD,IAAKlM,EACJ,MAAM,IAAI3H,MAAJ,qDACyC6T,EADzC,OAKP,IAAIjX,EAAOgC,KAAKqoB,IAAItf,EAAQ/K,KAAOgsB,EAAS,GACxCzrB,EAAMyB,KAAKqoB,IAAItf,EAAQxK,IAAM0rB,EAAS,GAEtCphB,EAAM9J,aACTf,EAA+B,GAAxBgC,KAAKsoB,MAAMtqB,EAAO,IACzBO,EAA6B,GAAvByB,KAAKsoB,MAAM/pB,EAAM,KAGxByW,EAAejM,EAAQV,IAAM,CAACrK,OAAMO,UAG9B,CAAClC,KAAM,iBAAkB2Y,iBAAgBJ,QAAS/L,EAAMR,I,YC3BzD,SAASqd,EACf7c,EACA8f,EACApP,GAEA,IAAKtK,YAAesK,GACnB,MAAM,IAAInY,MAAJ,WAAcmY,EAAd,+BAGP,OAAO,SAAAyE,GAGN,IAAMhJ,EAAmD,GAUzD,GARAnM,EAAMhK,SAAS8P,SAAQ,SAAA5F,GAClBA,EAAQ3K,KAAK4D,SAAS2mB,KACzB3T,EAAejM,EAAQV,IAAM,CAC5BjK,KAAM2K,EAAQ3K,KAAKT,KAAI,SAAAmR,GAAG,OAAKA,IAAQ6Z,EAAUpP,EAAUzK,UAK1DlN,OAAOC,KAAKmT,GAAgB7T,OAAS,EAAG,CAC3C6c,EAAS,CAAC3hB,KAAM,iBAAkB2Y,iBAAgBJ,QAAS/L,EAAMR,KAIjE,IAAMjJ,EAAS,eAAOyJ,EAAMzJ,kBAErBA,EAAUupB,GACjBvpB,EAAUma,GAAW1Q,EAAMzJ,UAAUupB,GACrC3K,EAAS,CACR3hB,KAAM,cACNvB,MAAO,CAACsE,aACRwV,QAAS/L,EAAMR,OCxCZ,SAAS6e,EACftZ,EACA+a,EACApP,GAEA,IAAKtK,YAAesK,GACnB,MAAM,IAAInY,MAAJ,WAAcmY,EAAd,+BAGP,OAAO,SAAAyE,GACNpQ,EAAQe,SAAQ,SAAA9F,GACXA,EAAMzK,KAAK4D,SAAS2mB,IACvB3K,EAAS,CACR3hB,KAAM,cACNuY,QAAS/L,EAAMR,GACfvN,MAAO,CACNsD,KAAMyK,EAAMzK,KAAKT,KAAI,SAAAmR,GAAG,OAAKA,IAAQ6Z,EAAUpP,EAAUzK,YCkBxD,SAASob,EACfrhB,EACAE,GAEA,GAAIA,EAAQF,QAAUA,EAAMR,GAC3B,MAAM,IAAIjH,MAAM,8CAGjB,OAAO,SAAA4c,GACFjV,EAAQ5K,UACX6f,EAAS,CACR3hB,KAAM,gBACN4Y,UAAWlM,EAAQV,GACnBvN,MAAO,CAACqD,UAAU,GAClByW,QAAS/L,EAAMR,MASZ,SAAS8hB,EACfthB,GAEA,OAAO,SAAAmV,GACN,IAAMhJ,EAAmD,GAEzDnM,EAAMhK,SAAS8P,SAAQ,SAAA5F,GACjBA,EAAQ5K,WACZ6W,EAAejM,EAAQV,IAAM,CAAClK,UAAU,OAItCyD,OAAOC,KAAKmT,GAAgB7T,OAAS,GACxC6c,EAAS,CACRhJ,iBACA3Y,KAAM,iBACNuY,QAAS/L,EAAMR,MASZ,SAAS+hB,EACfvhB,EACAE,EACA0b,GAEA,GAAI1b,EAAQF,QAAUA,EAAMR,GAC3B,MAAM,IAAIjH,MAAM,8CAGjB,OAAO,SAAA4c,GACN,IAAMhJ,EAAmD,GAEpDjM,EAAQ5K,WACZ6W,EAAejM,EAAQV,IAAM,CAAClK,UAAU,IAGrCsmB,GACH5b,EAAMhK,SAAS8P,SAAQ,SAAAxH,GAClBA,EAAEkB,KAAOU,EAAQV,IAAMlB,EAAEhJ,WAC5B6W,EAAe7N,EAAEkB,IAAM,CAAClK,UAAU,OAKjCyD,OAAOC,KAAKmT,GAAgB7T,OAAS,GACxC6c,EAAS,CAAC3hB,KAAM,iBAAkB2Y,iBAAgBJ,QAAS/L,EAAMR,MAK7D,SAASgiB,EACfxhB,EACAvI,GAE6C,IAD7CgqB,EAC4C,uDADtB,GAEtB,OAAO,SAAAtM,GACN,IAAMhJ,EAAmD,GAEzDnM,EAAMhK,SAAS8P,SAAQ,SAAA5F,GACtB,IAAIuhB,EAAU7b,MAAK,SAAAhJ,GAAC,OAAIA,IAAMsD,EAAQV,MAAtC,CAMA,IAAMlK,EAAWqC,YAAeF,EAAMyI,GAElCA,EAAQ5K,WAAaA,IACxB6W,EAAejM,EAAQV,IAAM,CAAClK,iBAI5ByD,OAAOC,KAAKmT,GAAgB7T,OAAS,GACxC6c,EAAS,CAAC3hB,KAAM,iBAAkB2Y,iBAAgBJ,QAAS/L,EAAMR,M,YCrI7D,SAASkiB,EACf1hB,GAEA,OAAO,SAACmV,EAAU0G,GACZ7b,EAAM1K,UACV6f,EAAS,CACR3hB,KAAM,cACNuY,QAAS/L,EAAMR,GACfvN,MAAO,CAACqD,UAAU,MASf,SAASqsB,IACf,OAAO,SAACxM,EAAU0G,GAAc,IAAD,gBACVA,KADU,IAC9B,2BAAgC,CAAC,IAAtB7b,EAAqB,QAC3BA,EAAM1K,UACT6f,EAAS,CACR3hB,KAAM,cACNuY,QAAS/L,EAAMR,GACfvN,MAAO,CAACqD,UAAU,MANS,gCAgBzB,SAASssB,EACf5hB,EACA4b,GAEA,OAAO,SAACzG,EAAU0G,GASjB,GARK7b,EAAM1K,UACV6f,EAAS,CACR3hB,KAAM,cACNuY,QAAS/L,EAAMR,GACfvN,MAAO,CAACqD,UAAU,KAIhBsmB,EAAW,CAAC,IAAD,gBACMC,KADN,IACd,2BAAgC,CAAC,IAAtBtY,EAAqB,QAC3BA,EAAM/D,KAAOQ,EAAMR,IAAM+D,EAAMjO,UAClC6f,EAAS,CACR3hB,KAAM,cACNuY,QAASxI,EAAM/D,GACfvN,MAAO,CAACqD,UAAU,MANP,iCChDV,SAASqnB,EACf3c,EACA5K,EACA2b,GAEA,IAAK3K,YAAehR,GACnB,MAAM,IAAImD,MAAJ,WAAcnD,EAAd,+BAGP,OAAO,SAAA+f,GAGN,GAAc,SAAVpE,GACH,GAAI3b,KAAQ4K,EAAMzJ,UAAW,CAC5B,IAAMA,EAAS,eAAOyJ,EAAMzJ,kBAErBA,EAAUnB,GAEjB+f,EAAS,CACR3hB,KAAM,cACNvB,MAAO,CAACsE,aACRwV,QAAS/L,EAAMR,WAIjB2V,EAAS,CACR3hB,KAAM,cACNvB,MAAO,CAACsE,UAAU,2BAAKyJ,EAAMzJ,WAAZ,kBAAwBnB,EAAO2b,KAChDhF,QAAS/L,EAAMR,M,WC3BZ,SAASqiB,EACf7hB,EACAE,EACA4Q,GAEA,GAAI5Q,EAAQF,QAAUA,EAAMR,GAC3B,MAAM,IAAIjH,MAAM,+CAGjB,IAAK6N,YAAe0K,GACnB,MAAM,IAAIvY,MAAJ,WAAcuY,EAAd,+BAGP,GAAI5Q,EAAQ3K,KAAK4D,SAAS2X,GACzB,MAAM,IAAIvY,MAAJ,4CAA+CuY,EAA/C,OAGP,MAAO,CACNtd,KAAM,gBACN4Y,UAAWlM,EAAQV,GACnBuM,QAAS/L,EAAMR,GACfvN,MAAO,CAACsD,KAAK,GAAD,mBAAM2K,EAAQ3K,MAAd,CAAoBub,MAO3B,SAASgR,EACf9hB,EACAE,EACA4Q,GAEA,GAAI5Q,EAAQF,QAAUA,EAAMR,GAC3B,MAAM,IAAIjH,MAAM,+CAGjB,IAAK6N,YAAe0K,GACnB,MAAM,IAAIvY,MAAJ,WAAcuY,EAAd,+BAGP,IAAK5Q,EAAQ3K,KAAK4D,SAAS2X,GAC1B,MAAM,IAAIvY,MAAJ,8CAAiDuY,EAAjD,OAGP,MAAO,CACNtd,KAAM,gBACN4Y,UAAWlM,EAAQV,GACnBuM,QAAS/L,EAAMR,GACfvN,MAAO,CAACsD,KAAM2K,EAAQ3K,KAAK2H,QAAO,SAAA5I,GAAC,OAAIA,IAAMwc,OCjDxC,SAASuM,EACftY,EACA/E,EACA/N,GAEA,GACCA,EAAMmD,MACN2P,EACE7H,QAAO,SAAAW,GAAC,OAAIid,wBAAcjd,KAAOid,wBAAc,2BAAIjd,GAAM5L,OACzDgH,MAAK,SAAA4E,GAAC,OAAIA,EAAE2B,KAAOQ,EAAMR,MAE3B,MAAM,IAAIjH,MAAJ,0CAA6CtG,EAAMmD,KAAnD,OAGP,MAAO,CACNnD,QACA8Z,QAAS/L,EAAMR,GACfhM,KAAM,iB,mLCnBD,SAASuuB,EACfhX,EACAgB,EACAiW,GAEA,IAAIC,GAAc,EACdC,GAAU,EACRC,EAAWpX,EAAMjW,KAAI,SAAAkL,GAC1B,GAAIA,EAAMR,KAAOuM,EAChB,OAAO/L,EAKR,GAFAiiB,GAAc,EAEVjiB,EAAMhK,SAASiD,MAAK,SAAAiH,GAAO,OAAIA,EAAQV,KAAOwiB,EAAaxiB,MAI9D,OAHAxE,QAAQmG,KAAR,4DACsD6gB,EAAaxiB,GADnE,wBAGOQ,EAGR,GACC,SAAUgiB,GACVhiB,EAAMhK,SAASiD,MAAK,SAAAiH,GAAO,OAAIA,EAAQ9K,OAAS4sB,EAAa5sB,QAK7D,OAHA4F,QAAQmG,KAAR,8DACwD6gB,EAAa5sB,KADrE,wBAGO4K,EAGR,IAAMoiB,EAAmB,uCACrBptB,eADqB,IAExBwK,GAAI8M,OACD0V,GAHqB,IAIxBhiB,MAAOA,EAAMR,KAERyM,EAAe,2BACjBjM,GADiB,IAEpBlK,WAAY,IAAIC,KAChBC,SAAS,GAAD,mBAAMgK,EAAMhK,UAAZ,CAAsBosB,MAQ/B,OALiC,IAA7BnW,EAASjW,SAASsC,SACrB2T,EAAS9V,aAAeisB,EAAW5iB,IAGpC0iB,GAAU,EACHjW,KAGR,OAAKgW,EAKAC,EAKEC,EAHCpX,GANP/P,QAAQmG,KAAR,qCAA2C4K,EAA3C,wBACOhB,GCvDF,SAASsX,EACftX,EACAgB,EACAK,GAEA,IAAIkW,GAAa,EACbC,GAAU,EAERJ,EAAWpX,EAAMjW,KAAI,SAAAkL,GAC1B,GAAIA,EAAMR,KAAOuM,EAChB,OAAO/L,EAGRsiB,GAAa,EAEb,IAAMrW,EAAQ,2BACVjM,GADU,IAEbhK,SAAUgK,EAAMhK,SAASkH,QAAO,SAAAgD,GAC/B,OAAIA,EAAQV,KAAO4M,IAClBmW,GAAU,GACH,QAOV,OAAIA,GACHtW,EAASnW,WAAa,IAAIC,KACnBkW,GAGDjM,KAGR,OAAKsiB,EAKAC,EAOEJ,GANNnnB,QAAQmG,KAAR,6CACuCiL,EADvC,gDACwFL,EADxF,uBAGOhB,IARP/P,QAAQmG,KAAR,qCAA2C4K,EAA3C,wBACOhB,G,aCnCT,SAASyX,EACRtiB,EACAuiB,EACAC,EACAC,GAEA,IAAItY,EACH,oCAA6BnK,EAAQ9K,KAArC,kBAAmD8K,EAAQV,GAA3D,yBACWijB,EADX,eAC0BC,EAD1B,iBACgDxiB,EAAQuiB,IAErDE,IACHtY,GAAO,YAASsY,EAAT,MAGR3nB,QAAQqG,KAAKgJ,GCXd,SAASmY,EACRxiB,EACAyiB,EACAC,EACAC,GAEA,IAAItY,EACH,kCAA2BrK,EAAM5K,KAAjC,kBAA+C4K,EAAMR,GAArD,2BACWijB,EADX,eAC0BC,EAD1B,iBACgD1iB,EAAMyiB,IAEnDE,IACHtY,GAAO,YAASsY,EAAT,MAGR3nB,QAAQqG,KAAKgJ,GAGP,SAASuY,EACf5iB,EACA6iB,EACAC,EACAC,GAEA,IAAMC,EAAYptB,cACZqtB,EAA0B,GAIhC,GAAwB,kBAAbjjB,EAAMR,IAAgC,KAAbQ,EAAMR,GAAW,CACpD,IAAM0jB,EAAQ5W,MAEdkW,EAAUxiB,EAAO,KAAMkjB,EAAO,gCAC9BD,EAAQzjB,GAAK0jB,EAKd,GAA0B,kBAAfljB,EAAMnK,MAAkC,KAAbmK,EAAMR,GAAW,CACtD,IAAM2jB,EAAU7W,MAEhBkW,EAAUxiB,EAAO,OAAQmjB,EAAS,gCAClCF,EAAQptB,KAAOstB,EAiBhB,GAZApqB,OAAOqqB,QAAQJ,GAAWld,SAAQ,YAAmB,IAAD,mBAAhB5M,EAAgB,KAAXtF,EAAW,KAC7CyvB,EAASnqB,GAGI,kBAAVtF,IAAuBmI,OAAOsjB,SAASrf,EAAMqjB,YAC9CzvB,WAAiBoM,EAAMqjB,MAE9Bb,EAAUxiB,EAAOqjB,EAAQL,EAAUK,IAClCJ,EAAQI,GAAmCL,EAAUK,OAK1B,kBAAtBrjB,EAAM5J,aACS,KAAtB4J,EAAM5J,aAC8B,kBAA7B4J,EAAM3J,oBACgB,KAA7B2J,EAAM3J,mBAINmsB,EACCxiB,EACA,cACA+iB,EAAc3tB,KACd,yBAEDotB,EACCxiB,EACA,qBACA+iB,EAAc3hB,QACd,yBAED6hB,EAAQ7sB,YAAc2sB,EAAc3tB,KACpC6tB,EAAQ5sB,mBAAqB0sB,EAAc3hB,aACrC,IACL0hB,EAAW7pB,MACX,SAAAyH,GAAM,OACLA,EAAOtL,OAAS4K,EAAM5J,aACtBsK,EAAOU,UAAYpB,EAAM3J,sBAE1B,CAID,IAAMitB,EAAeR,EAAWld,MAC/B,SAAAlF,GAAM,OACLA,EAAOtL,OAAS4K,EAAM5J,aACtB8K,oBAAUR,EAAOU,QAAS,IAAMpB,EAAM3J,uBAGpCitB,GACHd,EACCxiB,EACA,cACAsjB,EAAaluB,KACb,oEAEDotB,EACCxiB,EACA,qBACAsjB,EAAaliB,QACb,oEAED6hB,EAAQ7sB,YAAcktB,EAAaluB,KACnC6tB,EAAQ5sB,mBAAqBitB,EAAaliB,UAE1CohB,EACCxiB,EACA,cACA+iB,EAAc3tB,KACd,6EAEDotB,EACCxiB,EACA,qBACA+iB,EAAc3hB,QACd,6EAED6hB,EAAQ7sB,YAAc2sB,EAAc3tB,KACpC6tB,EAAQ5sB,mBAAqB0sB,EAAc3hB,SAM7C,GACCyhB,EAAW5pB,MAAK,SAAA+nB,GACf,OAAIA,IAAehhB,GAIZghB,EAAWxhB,KAAOQ,EAAMR,MAE/B,CACD,IAAM0jB,EAAQ5W,MAEdkW,EAAUxiB,EAAO,KAAMkjB,EAAO,sCAC9BD,EAAQzjB,GAAK0jB,EAOd,IAAIK,GAAqB,EACnBC,EAAmBxjB,EAAMhK,SAASlB,KAAI,SAAAoL,GAC3C,IAAMujB,ED1ID,SAAuBvjB,EAAkBwjB,GAC/C,IAAM/E,EAAc3pB,cACdiuB,EAA4B,GAIlC,GAA0B,kBAAf/iB,EAAQV,IAAkC,KAAfU,EAAQV,GAAW,CACxD,IAAM0jB,EAAQ5W,MAEdkW,EAAUtiB,EAAS,KAAMgjB,EAAO,iCAChCD,EAAQzjB,GAAK8M,MAgDd,GA3CAvT,OAAOqqB,QAAQzE,GAAa7Y,SAAQ,YAAmB,IAAD,mBAAhB5M,EAAgB,KAAXtF,EAAW,KAC/CyvB,EAASnqB,GAGI,kBAAVtF,IAAuBmI,OAAOsjB,SAASnf,EAAQmjB,YAChDzvB,WAAiBsM,EAAQmjB,MAEhCb,EAAUtiB,EAASmjB,EAAQ1E,EAAY0E,IACtCJ,EAAQI,GAAqC1E,EAAY0E,OAM5D,CAAC,OAAQ,OAAOvd,SAAQ,SAAA6d,GACvB,IAAMC,EAASD,EAEXzjB,EAAQ0jB,GAAU,IACrBpB,EAAUtiB,EAAS0jB,EAAQ,EAAG,gBAC7BX,EAAQW,GAAqC,MAMhD,CAAC,SAAU,SAAS9d,SAAQ,SAAA+d,GAC3B,IAAMC,EAASD,EAEX3jB,EAAQ4jB,GAAU,IACrBtB,EAAUtiB,EAAS4jB,EAAQ,EAAG,mBAC7Bb,EAAQa,GAAqC,MAM5C5jB,EAAQF,QAAU0jB,EAAYlkB,KACjCgjB,EAAUtiB,EAAS,QAASwjB,EAAYlkB,GAAI,6BAC5CyjB,EAAQjjB,MAAQ0jB,EAAYlkB,IAM5BkkB,EAAY1tB,SAASiD,MAAK,SAAA8qB,GACzB,OAAIA,IAAiB7jB,GAId6jB,EAAavkB,KAAOU,EAAQV,MAEnC,CACD,IAAM0jB,EAAQ5W,MAEdkW,EACCtiB,EACA,KACAgjB,EACA,gDAEDD,EAAQzjB,GAAK0jB,EAGd,OAAInqB,OAAOC,KAAKiqB,GAAS3qB,OAAS,EAC1B,2BAAI4H,GAAY+iB,GAGjB/iB,ECwDkB8jB,CAAc9jB,EAAD,YAAC,eAAaF,GAAUijB,IAE7D,OAAIQ,IAAoBvjB,GACvBqjB,GAAqB,EACdE,GAGDvjB,KAOR,OAJIqjB,IACHN,EAAQjtB,SAAWwtB,GAGhBzqB,OAAOC,KAAKiqB,GAAS3qB,OAAS,EAC1B,2BAAI0H,GAAUijB,GAGfjjB,E,YC9KD,SAAS6f,EACf9U,EACAgB,EACAK,EACA4V,GAEA,IAAIC,GAAc,EACdgC,GAAU,EACR9B,EAAWpX,EAAMjW,KAAI,SAAAkL,GAC1B,GAAIA,EAAMR,KAAOuM,EAChB,OAAO/L,EAKR,GAFAiiB,GAAc,EAGb,SAAUD,GACVhiB,EAAMhK,SAASiD,MACd,SAAAiH,GAAO,OACNA,EAAQ9K,OAAS4sB,EAAa5sB,MAAQ8K,EAAQV,KAAO4M,KAMvD,OAHApR,QAAQmG,KAAR,8DACwD6gB,EAAa5sB,KADrE,wBAGO4K,EAGR,IAAMiM,EAAe,2BACjBjM,GADiB,IAEpBhK,SAAUgK,EAAMhK,SAASlB,KAAI,SAAAoL,GAC5B,OAAIA,EAAQV,KAAO4M,EACXlM,GAGR+jB,GAAU,EACH,2BAAI/jB,GAAY8hB,SAIzB,OAAIiC,GACCnrB,YAA2BkpB,KAC9B/V,EAASnW,WAAa,IAAIC,MAGpBkW,IAGRjR,QAAQmG,KAAR,6CACuCiL,EADvC,gDACwFL,EADxF,uBAGO/L,MAGR,OAAKiiB,EAKAgC,EAKE9B,EAHCpX,GANP/P,QAAQmG,KAAR,qCAA2C4K,EAA3C,wBACOhB,GC9CF,IAAMuL,EAAsD,SAClEvL,EACAjP,GAEA,OAAQA,EAAOtI,MACd,IAAK,gBACJ,OAAOuuB,EAAchX,EAAOjP,EAAOiQ,QAASjQ,EAAO7J,OAEpD,IAAK,iBACJ,OCnBI,SACN8Y,EACAgB,EACAiW,GAEA,OAAOA,EAAavkB,QACnB,SAACsN,EAAO9Y,GAAR,OAAkB8vB,EAAchX,EAAOgB,EAAS9Z,KAChD8Y,GDYQmZ,CAAenZ,EAAOjP,EAAOiQ,QAASjQ,EAAO7J,OAErD,IAAK,cACJ,OErBI,SAAqB8Y,EAAqBoZ,GAChD,GAAI,OAAQA,GAAcpZ,EAAM9R,MAAK,SAAA+G,GAAK,OAAIA,EAAMR,KAAO2kB,EAAW3kB,MAIrE,OAHAxE,QAAQmG,KAAR,qDAC+CgjB,EAAW3kB,GAD1D,wBAGOuL,EAGR,GACC,SAAUoZ,GACVpZ,EAAM9R,MAAK,SAAA+G,GAAK,OAAIA,EAAM5K,OAAS+uB,EAAW/uB,QAK9C,OAHA4F,QAAQmG,KAAR,uDACiDgjB,EAAW/uB,KAD5D,wBAGO2V,EAGR,IAAI/K,EAAY,yBACfR,GAAI8M,OACD1W,eAFY,IAGfC,KAAMyW,MAAO8X,cACbtuB,WAAY,IAAIC,KAChBC,SAAU,GACVT,KAAM,GACNgB,UAAW,IACR4tB,GAYJ,OANAnkB,EAAMhK,SAAWgK,EAAMhK,SAASlB,KAAI,SAAAoL,GAAO,8CACvClL,KACAkL,GAFuC,IAG1CF,MAAOA,EAAMR,QAGR,GAAN,mBAAWuL,GAAX,CAAkB/K,IFjBTqkB,CAAYtZ,EAAOjP,EAAO7J,OAElC,IAAK,gBACJ,OAAOowB,EAActX,EAAOjP,EAAOiQ,QAASjQ,EAAOsQ,WAEpD,IAAK,iBACJ,OG5BI,SACNrB,EACAgB,EACAgC,GAEA,OAAOA,EAAWtQ,QACjB,SAACsN,EAAOqB,GAAR,OAAsBiW,EAActX,EAAOgB,EAASK,KACpDrB,GHqBQ4U,CAAe5U,EAAOjP,EAAOiQ,QAASjQ,EAAOiS,YAErD,IAAK,cACJ,OIhCI,SAAqBhD,EAAqBgB,GAChD,IAAIwW,GAAU,EACRJ,EAAWpX,EAAM7N,QAAO,SAAA8C,GAC7B,OAAIA,EAAMR,KAAOuM,IAChBwW,GAAU,GACH,MAMT,OAAKA,EAOEJ,GANNnnB,QAAQmG,KAAR,2CACqC4K,EADrC,sCAGOhB,GJiBCqD,CAAYrD,EAAOjP,EAAOiQ,SAElC,IAAK,OACJ,OKnC4C5D,ELmCpBrM,EAAOiP,MKlC1B,YAAI5C,GLoCV,IAAK,SACJ,OMpCI,SACN4C,EACA+X,EACAC,GAEA,OAAOhY,EAAMjW,KAAI,SAAAkL,GAAK,OACrB4iB,EAAY5iB,EAAO+K,EAAO+X,EAAYC,MN8B9BuB,CAAYvZ,EAAOjP,EAAOgnB,WAAYhnB,EAAOinB,eAErD,IAAK,gBACJ,OAAOlD,EACN9U,EACAjP,EAAOiQ,QACPjQ,EAAOsQ,UACPtQ,EAAO7J,OAGT,IAAK,iBACJ,OOhDI,SACN8Y,EACAgB,EACAI,GAEA,OAAOpT,OAAOC,KAAKmT,GAAgB1O,QAClC,SAACsN,EAAOqB,GAAR,OACCyT,EAAc9U,EAAOgB,EAASK,EAAWD,EAAeC,MACzDrB,GPwCQwZ,CAAexZ,EAAOjP,EAAOiQ,QAASjQ,EAAOqQ,gBAErD,IAAK,cACJ,OQnDI,SACNpB,EACAgB,EACAoY,GAEA,GACC,SAAUA,GACVpZ,EAAM9R,MAAK,SAAA+G,GAAK,OAAIA,EAAM5K,OAAS+uB,EAAW/uB,MAAQ4K,EAAMR,KAAOuM,KAKnE,OAHA/Q,QAAQmG,KAAR,qDAC+CgjB,EAAW/uB,KAD1D,wBAGO2V,EAGR,IAAIkZ,GAAU,EACR9B,EAAWpX,EAAMjW,KAAI,SAAAkL,GAC1B,GAAIA,EAAMR,KAAOuM,EAChB,OAAO/L,EAGRikB,GAAU,EAEV,IAAMO,EAAY,2BAAOxkB,GAAUmkB,GAMnC,OAJI/qB,YAAyB+qB,KAC5BK,EAAa1uB,WAAa,IAAIC,MAGxByuB,KAGR,OAAKP,EAOE9B,GANNnnB,QAAQmG,KAAR,2CACqC4K,EADrC,sCAGOhB,GReCsS,CAAYtS,EAAOjP,EAAOiQ,QAASjQ,EAAO7J,OAElD,QACC+I,QAAQmG,KAAR,UAAiBrF,EAAetI,KAAhC,yBKvDI,IAAwC2U,EL0D9C,OAAO4C,G,uBShDK0Z,EAAiBzyB,gBAAyC,CACtEmjB,SAAU,aACVpQ,QAAS,KAGV0f,EAAe7N,YAAc,UAEtB,IAAMsG,EAAoB,kBAAMlrB,aAAiByyB,IAE3CC,EAAmC,SAAAzyB,GAAU,IACzC0yB,EAAsBnW,cAA/BzJ,QACAyG,EAAW4O,mCAAX5O,QACAiE,EAAeH,cAAfG,YACDmV,EAGF5yB,WACH,kBAAM,SAAC+Y,EAAOjP,GACb,IAAMqmB,EAAW7L,EAAQvL,EAAOjP,GAEhC,IACC6oB,EAAmB7Z,eAAeqX,EAAUrmB,EAAQ0P,GACnD,MAAOkE,GACRD,EAAYC,EAAO,mCAGpB,OAAOyS,KAER,CAAC3W,EAASiE,EAAakV,IAnBgC,EAqB5B7N,IAAgB8N,EAAkB,IArBN,mBAqBjD7f,EArBiD,KAqBxCoQ,EArBwC,KAuBxD,OACC,cAACsP,EAAe1N,SAAhB,CAAyBnjB,MAAO,CAACuhB,WAAUpQ,WAA3C,SACE9S,EAAMkB,a,iQCjCG0xB,EAAoC,SAAA5yB,GAChD,IAAMU,EAAYC,IACjB,YAD2B,sBAEZX,EAAMiB,cAGtB,OACC,sBAAMP,UAAWA,EAAjB,SACC,kCACC,sBAAMA,UAAU,mBAAhB,SAAoCV,EAAMkB,WAC1C,0BACgB2xB,KAAM,EACrBrxB,SAAUxB,EAAMwB,SAChBC,QAASzB,EAAMyB,QACfC,YAAa1B,EAAM0B,YACnBC,MAAO3B,EAAM2B,MACblB,MAAOT,EAAMS,OAAS,WCWrBqyB,G,OAAS,CACX,CAAC3vB,KAAK,UACN,CAACA,KAAK,QACN,CAACA,KAAK,WACN,CAACA,KAAK,QACN,CAACA,KAAK,SACN,CAACA,KAAK,WACN,CAACA,KAAK,QACN,CAACA,KAAK,MACN,CAACA,KAAK,SACN,CAACA,KAAK,QACN,CAACA,KAAK,WACN,CAACA,KAAK,SACN,CAACA,KAAK,QACN,CAACA,KAAK,SACN,CAACA,KAAK,SACN,CAACA,KAAK,WAGG4vB,EAAsC,SAAA/yB,GAAU,IACrDoe,EAAgBpe,EAAhBoe,MAAO4U,EAAShzB,EAATgzB,MACLC,EAAWD,EAAM3sB,OAAS,EAAI2sB,EAAMA,EAAM3sB,OAAO,GAAK,GAFJ,EAIjCtG,WAAekzB,EAAS5qB,OAAS,IAJA,mBAIpDA,EAJoD,KAI7C6qB,EAJ6C,OAK9BnzB,WAAekzB,EAAS3qB,OAAS,IALH,mBAKjDA,EALiD,KAK1C6qB,EAL0C,OAM9BpzB,WAAekzB,EAAS1qB,MAAQ,IANF,mBAMjDA,EANiD,KAM3C6qB,EAN2C,OAO9BrzB,WAAekzB,EAASzqB,OAAS,IAPH,mBAOjDA,EAPiD,KAO1C6qB,EAP0C,OAQtBtzB,WAAemF,KAAKqoB,IAAIyF,EAAM3sB,OAAO,EAAE,IARjB,mBAQjDitB,EARiD,KAQtCC,EARsC,KAyBxDxzB,aAAgB,WACZ,IAAMiI,EAAOgrB,EAAMM,IAAc,GACjCJ,GAAa,OAAJlrB,QAAI,IAAJA,OAAA,EAAAA,EAAMK,QAAS,IACxB8qB,GAAa,OAAJnrB,QAAI,IAAJA,OAAA,EAAAA,EAAMM,QAAS,UACxB8qB,GAAY,OAAJprB,QAAI,IAAJA,OAAA,EAAAA,EAAMO,OAAQ,OACtB8qB,GAAa,OAAJrrB,QAAI,IAAJA,OAAA,EAAAA,EAAMQ,QAAS,OAC1B,CAAC8qB,IAEHvzB,aAAgB,WAKR,IAAMyzB,GAAYR,GAAO,IAAInwB,KAAI,SAACuU,EAAK7Q,GACnC,OAAIA,IAAI+sB,EACG,CAACjrB,QAAOC,QAAOC,OAAMC,SAEzB4O,KAEXgH,EAAMoV,KAEZ,CAACnrB,EAAMC,EAAMC,EAAKC,IAgCXlG,cAALD,EAUJ,OAAQ,sBAAK3B,UAAU,kBAAf,UACA,sBAAKD,MAAO,CAACgzB,aAAa,kBAAmBrQ,aAAa,IAA1D,UACA,qBAAK1iB,UAAU,iBAAf,SACI,cAAC,EAAD,CAAWD,MAAO,CAACiD,MAAM,KAAMhC,YAAY,mBAAmBF,SAAU,SAAAT,GAAC,OAAImyB,EAASnyB,EAAEiR,OAAOrQ,MAAM+F,QAAS,OAAO,OAAO/F,MAAO0G,EAAnI,qBACJ,sBAAK3H,UAAU,YAAYD,MAAO,CAACizB,UAAU,IAA7C,UAEI,cAAC,IAAD,CAAYlyB,SAbE,SAACT,GACvB,IAAI4yB,EAAQ,IAAIC,MAChBD,EAAME,IAAN,yBAA8B9yB,EAAEiR,OAAOrQ,MAAvC,QACAgyB,EAAMG,OACNX,EAASpyB,EAAEiR,OAAOrQ,QAS+BiB,QAASkwB,EAAOjwB,KAAI,SAAA6I,GAAC,MAAK,CAAE7K,MAAO6K,EAAEvI,KAAMxB,MAAO+J,EAAEvI,SAAUxB,MAAO2G,EAA9G,SAAsH,UAGtH,cAAC,IAAD,CAAW7H,MAAO,CAACiD,MAAM,IAAMhC,YAAY,YAAYF,SAAU,SAAAT,GAAC,OAAIsyB,EAAStyB,EAAEiR,OAAOrQ,QAAQA,MAAO6G,OAG3G,qBAAK/H,MAAO,CAACizB,UAAU,GAAItQ,aAAa,GAAI2Q,UAAU,UAAtD,SACI,cAAC,IAAD,CAAY5zB,KAAM,cAAC,IAAD,IAAcU,MAAO,kBAAmBP,QA3FpD,WACd,IAAMkzB,EAAQ,uBAAQR,GAAO,IAAInwB,KAAI,SAACuU,EAAK7Q,GACvC,OAAIA,IAAI+sB,EACG,CAACjrB,QAAOC,QAAOC,OAAMC,SAEzB4O,MAJG,CAKX,KACHgH,EAAMoV,GACND,EAAaP,EAAM3sB,QACnB6sB,EAAS,cACTC,EAAS,UACTC,EAAQ,IACRC,EAAS,KA+E6E7yB,QAAQ,gBAjD9E,WACjB,IAAMqyB,EAAQG,EAAMnwB,KAAI,SAACmF,EAAKzB,GAAN,OAAW,qBAAIjG,QAAS,WAAKizB,EAAahtB,IAA/B,UAEtB,oBAAI9F,MAAO,CAACoB,SAAS,QAASmyB,WAAW,EAAGtwB,MAAM,IAAKuwB,SAAS,IAAKC,SAAS,UAA9E,SAA0FlsB,EAAKK,QAC/F,oBAAI5H,MAAO,CAACoB,SAAS,QAASmyB,WAAW,GAAzC,SAA8ChsB,EAAKM,QACnD,oBAAI7H,MAAO,CAACoB,SAAS,QAASmyB,WAAW,GAAzC,SAA8ChsB,EAAKQ,QACnD,oBAAI/H,MAAO,CAACoB,SAAS,QAASmyB,WAAW,GAAzC,SAA6C,cAAC,IAAD,CAAY7zB,KAAM,cAAC,IAAD,IAAgBC,UAAU,EAAMS,MAAO,GAAIP,QAAS,WAVhH,IAACwT,IAU+HvN,EAT/I6X,EAAM,GAAD,mBAAK4U,EAAMmB,MAAM,EAAGrgB,IAApB,YAA8Bkf,EAAMmB,MAAMrgB,EAAQ,OAS6FtT,QAAQ,gBALjF+F,MAQ3E,OAAQ,qBAAK9F,MAAO,CAAC2zB,UAAU,IAAKC,UAAU,UAAtC,SACA,kCACI,gCACI,+BACI,oBAAI5zB,MAAO,CAACszB,UAAU,QAASlyB,SAAS,SAAxC,mBACA,oBAAIpB,MAAO,CAACszB,UAAU,QAAQlyB,SAAS,SAAvC,mBACA,oBAAIpB,MAAO,CAACszB,UAAU,QAAQlyB,SAAS,SAAvC,uBACA,oBAAIpB,MAAO,CAACszB,UAAU,gBAG9B,gCACSlB,SAgChByB,O,iBCpIP9pB,G,MAAU,CACZ,CAACrH,KAAM,MAAOoK,GAAG,MAAOoM,IAAI,GAAItQ,OAAO,KAAMW,OAAO3I,IAAO6I,IAAKqqB,YAAY,wBAC5E,CAACpxB,KAAM,aAAcoK,GAAG,aAAcoM,IAAI,sCAAuCtQ,OAAO,KAAMW,OAAO3I,IAAO6I,IAAKqqB,YAAY,yDAC7H,CAACpxB,KAAM,eAAgBoK,GAAG,eAAgBoM,IAAI,oCAAqCtQ,OAAO,KAAMW,OAAO3I,IAAO6I,IAAKqqB,YAAY,qDAC/H,CAACpxB,KAAM,MAAOoK,GAAI,MAAOoM,IAAI,kCAAmCtQ,OAAO,qEAAsEW,OAAO3I,IAAO6I,IAAKqqB,YAAY,sEAC5K,CAACpxB,KAAM,iBAAkBoK,GAAI,iBAAkBoM,IAAI,2BAA4B3P,OAAO3I,IAAO6I,IAAKb,OAAO,KAAMkrB,YAAY,sDAC3H,CAACpxB,KAAM,kBAAmBoK,GAAI,kBAAmBoM,IAAI,2BAA4B3P,OAAO3I,IAAO6I,IAAKb,OAAO,KAAMkrB,YAAY,yDAC7H,CAACpxB,KAAM,gBAAiBoK,GAAI,gBAAiBoM,IAAI,0BAA2B3P,OAAO3I,IAAO6I,IAAKb,OAAO,KAAMkrB,YAAY,qDACxH,CAACpxB,KAAM,iBAAkBoK,GAAI,iBAAkBoM,IAAI,0BAA2B3P,OAAO3I,IAAO6I,IAAKb,OAAO,KAAMkrB,YAAY,wDAC1H,CAACpxB,KAAM,WAAYoK,GAAG,WAAYoM,IAAI,kCAAmC3P,OAAO3I,IAAO6I,IAAIb,OAAO,iDAAkDkrB,YAAY,6EAChK,CAACpxB,KAAM,MAAOoK,GAAI,YAAavD,OAAO3I,IAAO6I,IAAIyP,IAAI,kCAAoCtQ,OAAO,6BAA8BkrB,YAAY,0CAE1I,CAACpxB,KAAM,gBAAiBoK,GAAI,gBAAiBvD,OAAO3I,IAAO6I,IAAIyP,IAAI,0BAA4BtQ,OAAO,KAAMkrB,YAAY,uDACxH,CAACpxB,KAAM,YAAaoK,GAAI,YAAavD,OAAO3I,IAAO4I,KAAM0P,IAAI,8BAA+BtQ,OAAO,qCAAsCkrB,YAAY,uDACrJ,CAACpxB,KAAM,SAAUoK,GAAI,SAAUvD,OAAO3I,IAAO4I,KAAM0P,IAAI,kCAAmCtQ,OAAO,qDAAsDkrB,YAAY,+HACnK,CAACpxB,KAAM,gBAAiBoK,GAAI,cAAevD,OAAO3I,IAAO6I,IAAKyP,IAAI,gCAAiCtQ,OAAO,KAAMkrB,YAAY,6DAC5H,CAACpxB,KAAM,iBAAkBoK,GAAI,eAAgBvD,OAAO3I,IAAO6I,IAAKyP,IAAI,+BAAgCtQ,OAAO,KAAMkrB,YAAY,8DAC7H,CAACpxB,KAAM,iBAAkBoK,GAAI,eAAgBvD,OAAO3I,IAAO6I,IAAKyP,IAAI,iCAAkCtQ,OAAO,KAAMkrB,YAAY,6HAC/H,CAACpxB,KAAM,gBAAiBoK,GAAI,oBAAqBvD,OAAO3I,IAAO6I,IAAKyP,IAAI,sCAAwCtQ,OAAO,mCAAoCkrB,YAAY,6IACvK,CAACpxB,KAAM,kBAAmBoK,GAAI,gBAAiBvD,OAAO3I,IAAO6I,IAAKyP,IAAI,kCAAmCtQ,OAAO,KAAMkrB,YAAY,mEAElI,CAACpxB,KAAM,mBAAoBoK,GAAI,UAAWvD,OAAO3I,IAAO6I,IAAKyP,IAAI,mCAAoCtQ,OAAO,oCAAqCkrB,YAAY,oGAC7J,CAACpxB,KAAM,kBAAmBoK,GAAI,SAAUvD,OAAO3I,IAAO6I,IAAKyP,IAAI,kCAAmCtQ,OAAO,kDAAmDkrB,YAAY,kMAU/JC,EAAsC,SAAAx0B,GAAU,IACrDoe,EAAwBpe,EAAxBoe,MAAMhc,EAAkBpC,EAAlBoC,QAAQyH,EAAU7J,EAAV6J,OADsC,EAE7B9J,WAAuB8J,GAFM,mBAEpD4qB,EAFoD,KAE3CC,EAF2C,OAGhC30B,aAHgC,mBAGjDkZ,EAHiD,KAG3C0b,EAH2C,OAItB50B,WAAyB,IAJH,mBAIjD60B,EAJiD,KAItCC,EAJsC,OAKE90B,WAXxC,SAAC8J,GACnB,IAAM8P,GAAO9P,EAAOA,QAAU,IAAIyJ,WAC5BwhB,EAAMtqB,EAAQ3H,KAAI,SAAA6I,GAAC,OAAEA,EAAEiO,OAAKnS,QAAQmS,GAC1C,OAAgB,IAATmb,EAAa,MAAQtqB,EAAQsqB,GAAKvnB,GAQgCwnB,CAAclrB,IAL/B,mBAKjDmrB,EALiD,KAK1BC,EAL0B,KAMpD5yB,EAAKC,cAALD,EAEJtC,aAAgB,WACZm1B,IAAQpT,IAAI,eAAeqT,KAAI,SAACrsB,EAAIssB,GAChC,IAAKtsB,EAAI,CAAC,IAAD,EACcssB,EAAStpB,KAArBupB,MACPR,OAFK,MACQ,GADR,SAMf,CAAC5b,IAEN,IAAMqc,EAAqB,SAACtnB,GAC3B,IAAMunB,EAAUvnB,EAAMgE,OAAOrQ,MAC7B6zB,EAAsB,SAAZD,EAAqBl0B,IAAO4I,KAAO5I,IAAO6I,MAe5CurB,EAAY,WAAqB,IAApBpsB,EAAmB,uDAAL,GAC7BqrB,EAAW,2BACJD,GADG,IAENprB,aAIFmsB,EAAY,WAA8B,IAA7BxrB,EAA4B,uDAAb3I,IAAO6I,IACrCwqB,EAAW,2BACLD,GADI,IAEPzqB,aAiFD0rB,EAAe,SAAC30B,GAAyC,IAAD,EACvCA,EAAEiR,OAAdqjB,aADmD,MAC7C,GAD6C,EAEtDA,GAASA,EAAMhvB,OAAS,GACxBsuB,EAAQU,EAAM,KAIhBM,EAAe,WACjB,GAAI1c,EAAK,CACL,IAAM2c,EAAW,IAAIC,SAGrBD,EAASE,OACL,YACA7c,EACAA,EAAK9V,MAGT+xB,IAAQa,KAAK,iBAAiBnd,KAAKgd,GAAUT,KAAI,SAASrsB,EAAKssB,GAC3DrsB,QAAQC,IAAIF,EAAKssB,GACZtsB,IACD6rB,OAAQ7zB,GACR20B,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAAC6Q,MAAM/c,EAAK9V,eAsK5D,OAAQ,sBAAKzC,UAAU,eAAf,UACI,qBAAKA,UAAU,UAAf,wBACA,qBAAKA,UAAU,WAAf,SACI,cAAC,IAAD,CAAYc,SA3PD,SAACT,GACxBk0B,EAAyBl0B,EAAEiR,OAAOrQ,OAClC+yB,EAAW,2BACJD,GACAjqB,EAAQgB,QAAO,SAACC,EAAK2L,GACpB,OAAIA,EAAK7J,KAAKxM,EAAEiR,OAAOrQ,MACZ,CACHkI,OAAOuN,EAAKuC,IACZtQ,OAAO+N,EAAK/N,OACZW,OAAOoN,EAAKpN,OACZxB,MAAM,GAGPiD,IACT,OA6OgD7I,QAAS4H,EAAQ3H,KAAI,SAAA6I,GAAC,MAAK,CAAE7K,MAAO6K,EAAEvI,KAAMxB,MAAO+J,EAAE6B,OAAQ5L,MAAOqzB,EAA9G,SAAsI,sBAE1I,qBAAKt0B,UAAU,cAAf,SA1OD8J,EAAQgB,QAAO,SAACC,EAAK2L,GACxB,OAAIA,EAAK7J,KAAKynB,EACJ5d,EAAKmd,YAER9oB,IACT,MAwOM,qBAAK/K,UAAU,WAAf,SAdM,WACd,GAA8B,QAA1Bs0B,EACA,OAAO,cAAC,IAAD,CAAWxzB,SAAU,SAAAT,GAAC,OA1RnB,WAAyB,IAAxBkM,EAAuB,uDAAL,GACjCynB,EAAW,2BACJD,GADG,IAEN5qB,OAASoD,KAuRwBgpB,CAAUl1B,EAAEiR,OAAOrQ,QAAQA,MAAO8yB,EAAQ5qB,OAAOyJ,WAAY1R,SAAU,kBAAjG,iBAaEs0B,KAEL,qBAAKx1B,UAAU,WAAf,SA5BS,WACjB,GAA6B,OAAzBs0B,EACA,OAAO,cAAC,IAAD,CAAYxzB,SAAU8zB,EAAoB1yB,QAAS,CACtD,CAAC1C,UAAS,EAAOW,MAAM,MAAOc,MAAMN,IAAO6I,KAC3C,CAAChK,UAAS,EAAOW,MAAM,OAAQc,MAAMN,IAAO4I,OACzCtI,MAAO8yB,EAAQzqB,SAAW3I,IAAO4I,KAAO5I,IAAO4I,KAAO5I,IAAO6I,IAH7D,SAIF,WAuBIisB,KAEL,qBAAKz1B,UAAU,WAAf,SA1DS,WAEjB,OAAQs0B,GACJ,IAAK,oBACD,OAvHS,WAEjB,IAFqB,EAENpsB,KAAKC,MAAM4rB,EAAQprB,QAAU,MACrC8b,MAHc,cAGR,GAHQ,GAId6Q,aAJc,MAIR,GAJQ,EAWrB,OAAQ,sBAAKv1B,MAAO,CAAC21B,cAAc,GAA3B,UACI,sBAAK31B,MAAO,CAACuzB,WAAW,EAAEoC,cAAc,GAAK3C,aAAa,aAA1D,UACI,qBAAKhzB,MAAO,CAACizB,UAAU,EAAEtQ,aAAa,GAAIiT,WAAW,KAArD,iDAGA,cAAC,IAAD,CAAY70B,SAVV,SAACT,GACfgI,QAAQC,IAAI,gBAAiBjI,EAAEiR,OAAOrQ,OACvC8zB,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAAC6Q,MAAMj1B,EAAEiR,OAAOrQ,WAQDiB,QAAO,CAAG,CAAC/B,MAAM,GAAGc,MAAM,KAAnB,mBAA0BizB,EAAU/xB,KAAI,SAAAyzB,GAAC,MAAG,CAACz1B,MAAMy1B,EAAG30B,MAAM20B,QAAO30B,MAAOq0B,EAAnH,iCAEJ,sBAAKv1B,MAAO,CAACuzB,WAAW,GAAGoC,cAAc,GAAzC,UACI,qBAAK31B,MAAO,CAACizB,UAAU,EAAGtQ,aAAa,GAAIiT,WAAW,KAAtD,iCAGA,8BACI,uBAAO90B,KAAK,OAAOC,SAAUk0B,MAEjC,qBAAKj1B,MAAO,CAACizB,UAAU,IAAvB,SACKza,GAAQ,cAAC,IAAD,CACD/Y,UAAU,EACVC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,oBACT/B,QAASq1B,EACTn1B,QAAQ,iBAIR,IAAhBw1B,EAAMruB,QAAgB,sBAAKlH,MAAO,CAACszB,UAAU,SAAUwC,aAAc,EAAGC,QAAQ,GAAI9C,UAAU,GAAI7xB,SAAS,OAArF,UAA6F,iDAA7F,UAA6Hm0B,SAoFhJS,GACX,IAAK,WACD,OA5KQ,WAEhB,IAFoB,EAEL7tB,KAAKC,MAAM4rB,EAAQprB,QAAU,MACrC8b,MAHa,cAGP,GAHO,GAIbuR,WAJa,MAIT,SAJS,EAKpB,OAAO,qCACH,uBAAOn1B,KAAK,QAAQgM,GAAG,WAAWpK,KAAK,WAAWxB,MAAK,WAAM+0B,GAAOl1B,SAAU,SAACT,GAAK00B,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAACuR,IAAI31B,EAAEiR,OAAOrQ,MAAM+F,QAAQ,IAAI,WACpJ,mBAAGhH,UAAU,cAAb,+CAqKWi2B,GACX,IAAK,YACD,OAzLO,WAEf,IAFmB,EAEJ/tB,KAAKC,MAAM4rB,EAAQprB,QAAU,MACrC8b,MAHY,cAGN,GAHM,GAIZuR,WAJY,MAIR,SAJQ,EAKnB,OAAO,qCACH,uBAAOn1B,KAAK,QAAQgM,GAAG,WAAWpK,KAAK,WAAWxB,MAAK,WAAM+0B,GAAOl1B,SAAU,SAACT,GAAK00B,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAACuR,IAAI31B,EAAEiR,OAAOrQ,MAAM+F,QAAQ,IAAI,WACpJ,mBAAGhH,UAAU,cAAb,+CAkLWk2B,GACX,IAAK,MACD,OApKD,cAAC,IAAD,CAAWp1B,SAAU,SAAAT,GAAC,OAAI00B,EAAU10B,EAAEiR,OAAOrQ,QAAQC,SAAQ,sDAAyDD,MAAO8yB,EAAQprB,QAAQ,GAA7I,oBAqKH,IAAK,UACD,OAnKW,WACnB,IADuB,EACRT,KAAKC,MAAM4rB,EAAQprB,QAAU,MACrC8b,MAFgB,cAEV,GAFU,GAGhB/M,eAHgB,MAGR,YAHQ,EAIvB,OAAO,cAAC,IAAD,CAAW5W,SAAU,SAAAT,GAAC,OAAI00B,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAAC/M,QAAQrX,EAAEiR,OAAOrQ,WAAWC,SAAQ,kCAAqCD,MAAOyW,EAA3I,qBA+JQye,GACX,IAAK,YACD,OAzFW,WACnB,IADuB,EACRjuB,KAAKC,MAAM4rB,EAAQprB,QAAU,MACrCyC,KAFgB,cAEX,GAFW,GAGhBvI,YAHgB,MAGX,kBAHW,EAIvB,OAAO,cAAC,IAAD,CAAW/B,SAAU,SAAAT,GAAC,OAAI00B,EAAU7sB,KAAKmB,UAAU,CAAC+B,KAAK,CAACvI,KAAKxC,EAAEiR,OAAOrQ,WAAWC,SAAQ,kCAAqCD,MAAO4B,EAAvI,2BAqFQuzB,GACX,IAAK,MACD,OAnEO,WACf,IADmB,EACJluB,KAAKC,MAAM4rB,EAAQprB,QAAU,MACrC8b,aAFY,MAEN,GAFM,IAGuCA,EAAnD4R,cAHY,WAGuC5R,EAAtC6R,aAHD,MAGO,GAHP,IAGuC7R,EAA5B8R,YAHX,WAGuC9R,EAAjB9C,YAHtB,MAG2B,EAH3B,IAGuC8C,EAAT+R,UAH9B,MAGiC,GAHjC,EA6BbC,EAAc,CAAC,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,IAAIt0B,KAAI,SAAA0D,GAAC,MAAG,CAAC1F,MAAM,GAAD,OAAI0F,GAAK5E,MAAM,GAAD,OAAI4E,OAG7E,OAAQ,sBAAK9F,MAAO,CAAC22B,QAAQ,OAAQC,cAAc,UAA3C,UACI,qBAAK32B,UAAU,WAAf,SACI,cAAC,IAAD,CAAYc,SA7BA,SAACT,GACzB00B,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAAC4R,OAAwB,SAAjBh2B,EAAEiR,OAAOrQ,MAA+Bq1B,QAAOC,OAAM5U,OAAM6U,UA4B3Ct0B,QAAS,CAAC,CAAC/B,MAAM,OAAQc,MAAM,QAAS,CAACd,MAAM,QAASc,MAAM,UAAWA,MAAOo1B,EAAS,OAAQ,QAA7I,sBAEJ,qBAAKr2B,UAAU,WAAf,SACI,cAAC,IAAD,CAAYc,SA5BD,SAACT,GACxB00B,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAAC4R,SAAQC,MAAMltB,OAAO/I,EAAEiR,OAAOrQ,OAAQs1B,OAAM5U,OAAM6U,UA2B5Bt0B,QAASu0B,EAAax1B,MAAOq1B,EAAxE,qBAEJ,qBAAKt2B,UAAU,WAAf,SACI,cAAC,IAAD,CAAYc,SA3BF,SAACT,GACvB00B,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAAC4R,SAAQE,KAAsB,SAAjBl2B,EAAEiR,OAAOrQ,MAA+Bq1B,QAAO3U,OAAM6U,UA0B9Ct0B,QAAS,CAAC,CAAC/B,MAAM,OAAQc,MAAM,QAAS,CAACd,MAAM,QAASc,MAAM,UAAWA,MAAOs1B,EAAO,OAAQ,QAAxI,oBAEJ,qBAAKv2B,UAAU,WAAf,SACI,cAAC,IAAD,CAAWc,SA1BD,SAACT,GAClBu2B,MAAMxtB,OAAO/I,EAAEiR,OAAOrQ,SACvB8zB,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAAC4R,SAAQE,OAAMD,QAAO3U,KAAKvY,OAAO/I,EAAEiR,OAAOrQ,OAAQu1B,UAwBnCt1B,SAAQ,sBAAyBD,MAAO0gB,EAAhF,6BAEJ,qBAAK3hB,UAAU,WAAf,SACI,cAAC,IAAD,CAAWc,SAvBH,SAACT,GAChBu2B,MAAMxtB,OAAO/I,EAAEiR,OAAOrQ,SACvB8zB,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAAC4R,SAAQE,OAAMD,QAAOE,GAAGptB,OAAO/I,EAAEiR,OAAOrQ,OAAQ0gB,YAqBnCzgB,SAAQ,oBAAuBD,MAAOu1B,EAA5E,8BAqBDK,GACX,IAAK,SACD,OA/EU,WAGlB,IAHsB,EAGP3uB,KAAKC,MAAM4rB,EAAQprB,QAAU,MACrCyC,KAJe,cAIV,GAJU,GAKfxB,cALe,MAKR,GALQ,EAMtB,OAAO,cAAC,EAAD,CAAW0oB,MAAO1oB,EAAQ8T,MAAO,SAAC4U,GAASyC,EAAU7sB,KAAKmB,UAAU,CAAC+B,KAAK,CAACxB,OAAO0oB,SAyE1EwE,GACX,IAAK,SACD,OAxFU,WAClB,IADsB,EACP5uB,KAAKC,MAAM4rB,EAAQprB,QAAU,MACrC8b,MAFe,cAET,GAFS,GAGfsS,cAHe,MAGR,2BAHQ,EAItB,OAAO,cAAC,IAAD,CAAWj2B,SAAU,SAAAT,GAAC,OAAI00B,EAAU7sB,KAAKmB,UAAU,CAACob,MAAM,CAACsS,OAAO12B,EAAEiR,OAAOrQ,WAAWC,SAAQ,mCAAsCD,MAAO81B,EAA3I,iBAoFQC,GACX,QACI,QAqCKC,KAEL,qBAAKj3B,UAAU,WAAf,SACI,cAAC,IAAD,CAAWD,MAAO,CAACiD,MAAM,IAAKlC,SAAU,SAAAT,GAAC,OA3RxC,WAAqB,IAApByH,EAAmB,uDAAN,IAC3BksB,EAAW,2BACLD,GADI,IAEPjsB,MAAO8uB,MAAMxtB,OAAOtB,IAAU,EAAIsB,OAAOtB,MAwRa6qB,CAAStyB,EAAEiR,OAAOrQ,QAAQC,SAAQ,kCAAqCD,MAAK,UAAK8yB,EAAQjsB,OAAO,GAA7I,qBAEJ,sBAAK/H,MAAO,CAACszB,UAAU,UAAvB,UACA,cAAC,IAAD,CAAY5zB,KAAM,cAAC,IAAD,IAAeC,UAAU,EAAMS,MAAO,GAAIP,QAAS,kBAAI8d,EAvRrE,SAACvU,GACb,OAAO,2BACAA,GADP,IAEIrB,MAAO8uB,MAAMxtB,OAAOD,EAAOrB,QAAU,EAAIsB,OAAOD,EAAOrB,OACvDwB,OAAQH,EAAOG,OAASH,EAAOG,OAAS3I,IAAO6I,IAC/Cb,OAAQQ,EAAOR,QAAU,KAkR0DuuB,CAAQnD,KAAWj0B,QAAQ,YAC1G,cAAC,IAAD,CAAYL,KAAM,cAAC,IAAD,IAAgBC,UAAU,EAAMS,MAAO,GAAIP,QAAS8B,EAAS5B,QAAQ,mBChY1Fq3B,EAAkC,SAAA73B,GAAU,IAC9CwK,EAAWxK,EAAXwK,QAD6C,EAE5BzK,IAAM+3B,SAAS,IAFa,mBAE7CxM,EAF6C,KAEvCyM,EAFuC,OAGdh4B,IAAM+3B,SAAS,GAHD,mBAG7CE,EAH6C,KAGhCC,EAHgC,OAIRl4B,IAAM+3B,SAAS,GAJP,mBAI7CI,EAJ6C,KAI7BC,EAJ6B,KAqB9CC,EAAQ,WACVrvB,QAAQC,IAAI,0BACZ+uB,EAAQ,KASNM,EAAY,SAACC,EAAezuB,GAC9Bd,QAAQC,IAAI,gBAAiBa,GAC7BuuB,IACAp4B,EAAMq4B,UAAUC,EAAOzuB,IAmB3B,GAAIW,EAAQnE,QAAU,EACpB,OAfS,qBAAK5F,MAAO,CAACizB,UAAU,IAAvB,SACC,cAAC,IAAD,CAAYvzB,KAAM,cAAC,IAAD,IAAcM,MAAO,CAACoB,SAAS,SAAUhB,MAAO,mBAAoBP,QAAS,WAC3F+3B,EAAU,EAAE,CAACxuB,OAAO,GAAIR,OAAO,KAAMW,OAAO3I,IAAO6I,MACnD6tB,EAAQ,SACTv3B,QAAQ,cAcnB,IAAMwyB,EAAQxoB,EAAQ3H,KAAI,SAACqJ,EAAKosB,GAE5B,IAAMzF,EAAQ3mB,EAAIrJ,KAAK,SAACgH,EAAO0uB,GAC3B,OAAO,qBAAmC93B,MAAO,CAAC+1B,QAAQ,GAAnD,SACH,sBAAK/1B,MAAO,CAAC22B,QAAQ,OAAQC,cAAc,MAAOmB,WAAW,UAA7D,UACI,sBAAK/3B,MAAO,CAAC22B,QAAS,OAAQqB,KAAM,WAAYpB,cAAc,UAA9D,UACI,qBAAK52B,MAAO,CAAC+1B,QAAQ,EAAEY,QAAQ,OAAQC,cAAc,OAArD,SACI,sBAAK52B,MAAO,CAACg4B,KAAM,WAAY52B,SAAS,SAAxC,2BAAiEgI,EAAOrB,MAAxE,iBAEJ,qBAAK/H,MAAO,CAAC+1B,QAAQ,EAAEY,QAAQ,OAAQC,cAAc,UAArD,SACI,qBAAK52B,MAAO,CAACg4B,KAAM,WAAY52B,SAAS,QAASw0B,WAAW,KAA5D,SAAmExsB,EAAOA,OAAOyJ,kBAIzF,sBAAK7S,MAAO,CAAC22B,QAAQ,OAAQC,cAAc,OAA3C,UACI,cAAC,IAAD,CAAYl3B,KAAM,cAAC,IAAD,IAAcC,UAAU,EAAMS,MAAO,GAAIP,QAAS,kBAnE5E,SAACg4B,EAAcC,GAC3BR,EAAQ,QACRE,EAAeK,GACfH,EAAkBI,GAgE0EG,CAAOJ,EAAOC,IAAW/3B,QAAQ,YACzG,cAAC,IAAD,CAAYL,KAAM,cAAC,IAAD,IAAgBC,UAAU,EAAMS,MAAO,GAAIP,QAAS,kBA9D5E,SAACg4B,EAAcC,GAC7Bv4B,EAAM24B,aAAaL,EAAOC,GA6DoEK,CAASN,EAAOC,IAAW/3B,QAAQ,YAC7G,cAAC,IAAD,CAAYL,KAAM,cAAC,IAAD,IAAcC,UAAU,EAAMS,MAAO,GAAIP,QAAS,YA3D9E,SAACg4B,GACXP,EAAQ,OACRE,EAAeK,GAyD8Ela,CAAMka,IAAU93B,QAAQ,mBAdtG,UAAa83B,EAAb,YAAuBC,OAmBlC,OAAO,qBAAkB93B,MAAO,CAACo4B,WAAW,kBAAmBzV,aAAa,IAArE,SACFyP,GADYyF,MAKrB,OAAQ,qCACJ,sBAAK73B,MAAO,CAACq4B,WAAW,IAAxB,UACY,QAAPxN,GAAgB,cAAC,EAAD,CAAWlpB,QAASg2B,EAAOvuB,OAAQ,CAACA,OAAO,IAAMuU,MAAO,SAACqW,GAAkB2D,IAASC,EAAUL,EAAYvD,MACnH,SAAPnJ,GAAiB,cAAC,EAAD,CAAWlpB,QAASg2B,EAAOvuB,OAAQW,EAAQwtB,GAAaE,GAAiB9Z,MAAO,SAACqW,GAAW2D,IAAQp4B,EAAM+4B,WAAWf,EAAYE,EAAezD,MACjKzB,KAEL,cAAC,IAAD,CAAY7yB,KAAM,cAAC,IAAD,IAAuBM,MAAO,CAACoB,SAAS,SAAUhB,MAAO,yBAA0BP,QAAS,WAhElHy3B,EAAQ,QACRE,EAAeztB,EAAQnE,QACvBrG,EAAMg5B,qBA8DuIx4B,QAAQ,gBC9EhJy4B,EAA0C,SAAAj5B,GAAU,IACzDoe,EAAmBpe,EAAnBoe,MAAO8a,EAAYl5B,EAAZk5B,SACP72B,EAAKC,cAALD,EAFwD,EAIrCtC,WAAuBC,EAAMmL,OAAS,CAAC,CAACJ,KAAK,CAACC,SAAS,SAAUH,QAAQ,IAAIL,QAAQ,GAAGM,KAAK,MAJxD,mBAIxDK,EAJwD,KAIjDguB,EAJiD,KAUzDC,EAAe,SAAC5uB,EAAoBsJ,EAAcykB,GAEvD,OAAI/tB,EAAQnE,QAAUyN,EACdtJ,GAGAA,GAAW,IAAIgB,QAAO,SAACC,EAAe4tB,EAAmBC,GAChE,GAAIA,IAAMxlB,EACT,MAAM,GAAN,mBAAWrI,GAAX,CAAgB4tB,IACjB,IAAME,EAAcF,EAAUpuB,QAAO,SAACS,EAAEnF,GAAH,OAAOA,IAAMgyB,KAClD,OAAOgB,EAAWlzB,QAAU,EAAIoF,EAAzB,sBAAmCA,GAAnC,CAAwC8tB,MAC9C,KAGGC,EAAe,SAAChvB,EAAoBsJ,EAAcykB,EAAiB1uB,GAExE,OAAIW,EAAQnE,QAAUyN,EACf,GAAN,mBAAWtJ,GAAX,CAAoB,CAACX,MAGdW,GAAW,IAAIgB,QAAO,SAACC,EAAe4tB,EAAmBC,GAChE,MACO,GAAN,mBAAW7tB,GADR6tB,IAAMxlB,EACT,CAAgBulB,GAEjB,CAAgBA,EAAUx2B,KAAI,SAAC6I,EAAEnF,GAChC,OAAOA,IAAMgyB,EAAW1uB,EAAS6B,SAGjC,KAGG+tB,EAAe,SAACjvB,EAAoBsJ,EAAcjK,GAEvD,OAAIW,EAAQnE,QAAUyN,EACf,GAAN,mBAAWtJ,GAAX,CAAoB,CAACX,MAGdW,GAAW,IAAIgB,QAAO,SAACC,EAAe4tB,EAAmBC,GAChE,MACO,GAAN,mBAAW7tB,GADR6tB,IAAMxlB,EACT,CAAgBulB,GAEjB,uBAAoBA,GAApB,CAA+BxvB,QAC9B,KAgDGwuB,EAAY,SAACqB,EAAepB,EAAezuB,GAChD,IAAM8vB,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAASivB,EAAa1uB,EAAKP,QAAS8tB,EAAQzuB,SAG7C,IACFsvB,EAASQ,IAmBJC,EAAa,SAAC9lB,EAAchJ,GACjC,OAAO,sBAAKpK,UAAU,UAAf,UACN,6CACA,cAAC,IAAD,CAAWgB,YAAY,YAAYjB,MAAO,CAAC+1B,QAAQ,GAAIh1B,SAAU,SAAAT,GAAC,OAXpD,SAAC+S,EAAchJ,GAC9BquB,EAAShuB,EAAMK,QAAO,SAACC,EAAY2L,EAAW7Q,GAC7C,MACO,GAAN,mBAAWkF,GADRlF,IAAMuN,EACT,CAAgBsD,GACjB,4BAAoBA,GAApB,IAA0BtM,KAAMA,EAAKnD,aACpC,KAMqEkyB,CAAQ/lB,EAAM/S,EAAEiR,OAAOrQ,QAAQA,MAAOmJ,QAWxGgvB,EAAa,SAAChmB,EAAc/I,GAEjC,OAAQ,gCACN,sBAAKrK,UAAU,UAAf,UACC,uCACA,qBAAKD,MAAO,CAACizB,UAAU,GAAvB,SACC,cAAC,IAAD,CAAWhyB,YAAY,OAAOjB,MAAO,CAAC+1B,QAAQ,EAAE9yB,MAAMwB,KAAKqoB,IAAI,GAA8B,EAA3BxiB,EAAKA,KAAKF,QAAQxE,SAAc7E,SAAU,SAAAT,GAAC,OApC/F,SAAC+S,EAAcjJ,GACjCsuB,EAAShuB,EAAMK,QAAO,SAACC,EAAY2L,EAAW7Q,GAC7C,MACO,GAAN,mBAAWkF,GADRlF,IAAMuN,EACT,CAAgBsD,GACjB,4BAAoBA,GAApB,IAA0BrM,KAAK,2BAAIqM,EAAKrM,MAAV,IAAeF,kBAC5C,KA+BmHkvB,CAAWjmB,EAAO/S,EAAEiR,OAAOrQ,QAAQA,OAb/HA,EAasJoJ,EAAKA,KAAKF,QAZrLkO,MAAMC,QAAQrX,GACVA,EAAM4R,KAAK,KAEZ5R,OAWJ,sBAAKrB,QAAS,WACb+3B,EAAU,EAAE,EAAE,CAAC,OAAS,MADzB,8BAEqBttB,EAAKP,QAAQnE,QAAU,EAAI,UAAY,GAF5D,UAKA0E,EAAKP,QAAQnE,OAAS,GAAK,cAAC,EAAD,CAASmE,QAASO,EAAKP,QAChDmuB,aAAc,SAACjtB,EAAEE,GAAH,OAxGC,SAAC8tB,EAAepB,EAAeC,GACnD,IAAMoB,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAAS4uB,EAAaruB,EAAKP,QAAS8tB,EAAQC,SAG7C,IACFY,EAASQ,GA4FiBhB,CAAa7kB,EAAOpI,EAAEE,IAC3CysB,UAAW,SAACC,EAAe7D,GAAkB4D,EAAUvkB,EAAOwkB,EAAQ7D,IACtEsE,WAAY,SAACT,EAAeC,EAAiB1uB,GAAjC,OA3FC,SAAC6vB,EAAepB,EAAeC,EAAiB1uB,GAClE,IAAM8vB,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAASgvB,EAAazuB,EAAKP,QAAS8tB,EAAQC,EAAU1uB,SAGvD,IACFsvB,EAASQ,GA+EyDZ,CAAWjlB,EAAMwkB,EAAOC,EAAS1uB,IAC9FmvB,kBAAmB,kBA7EC,SAACU,GAC1B,IAAMC,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAAQ,GAAD,mBAAMO,EAAKP,SAAX,CAAoB,CAAC,CAAC,OAAS,aAGvC,IACF2uB,EAASQ,GAiEmBX,CAAkBllB,MAE3C8lB,EAAW9lB,GAAO/I,EAAKD,MAAM,IAAInD,UAjBlBmM,GATM,IAACnS,GAoC1B,OAAQ,qCACN,sBAAK4L,GAAG,QAAQ9M,MAAO,CAAC2iB,aAAa,IAArC,UANMjY,EAAMtI,KAAI,SAAC8H,EAAEpE,GACnB,OAAOuzB,EAAWvzB,EAAEoE,MAOnB,qBAAKlK,MAAO,CAACszB,UAAU,UAAvB,SACC,cAAC,IAAD,CAAY5zB,KAAM,cAAC,IAAD,IAAcC,UAAU,EAAOS,MAAO,mBAAoBP,QA5K7D,WAClB64B,EAAS,GAAD,mBAAKhuB,GAAL,CAAW,CAACJ,KAAK,CAACC,SAAS,SAAUH,QAAQ,IAAIL,QAAQ,GAAGM,KAAK,QA2K2BtK,QAAQ,iBAG3G,qBAAKC,MAAO,CAAC22B,QAAQ,OAAQ4C,eAAe,UAA5C,SACC,eAAC,IAAD,WACC,cAAC,IAAD,CACC95B,UAAU,EACVC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,UACT/B,QAAS,kBAAI8d,EAAMjT,IACnB3K,QAAQ,WAET,cAAC,IAAD,CACCL,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACT/B,QAAS,kBAAM44B,gBC3MRe,EAA0C,SAAAj6B,GAAU,IACzDoe,EAAmBpe,EAAnBoe,MAAO8a,EAAYl5B,EAAZk5B,SACP72B,EAAKC,cAALD,EAFwD,EAIrCtC,WAAuBC,EAAMmL,OAAS,CAAC,CAACJ,KAAK,CAACC,SAAS,SAAUH,QAAQ,IAAIL,QAAQ,GAAGM,KAAK,MAJxD,mBAIxDK,EAJwD,KAIjDguB,EAJiD,KAUzDC,EAAe,SAAC5uB,EAAoBsJ,EAAcykB,GAEvD,OAAI/tB,EAAQnE,QAAUyN,EACdtJ,GAGAA,GAAW,IAAIgB,QAAO,SAACC,EAAe4tB,EAAmBC,GAChE,GAAIA,IAAMxlB,EACT,MAAM,GAAN,mBAAWrI,GAAX,CAAgB4tB,IACjB,IAAME,EAAcF,EAAUpuB,QAAO,SAACS,EAAEnF,GAAH,OAAOA,IAAMgyB,KAClD,OAAOgB,EAAWlzB,QAAU,EAAIoF,EAAzB,sBAAmCA,GAAnC,CAAwC8tB,MAC9C,KAGGC,EAAe,SAAChvB,EAAoBsJ,EAAcykB,EAAiB1uB,GAExE,OAAIW,EAAQnE,QAAUyN,EACf,GAAN,mBAAWtJ,GAAX,CAAoB,CAACX,MAGdW,GAAW,IAAIgB,QAAO,SAACC,EAAe4tB,EAAmBC,GAChE,MACO,GAAN,mBAAW7tB,GADR6tB,IAAMxlB,EACT,CAAgBulB,GAEjB,CAAgBA,EAAUx2B,KAAI,SAAC6I,EAAEnF,GAChC,OAAOA,IAAMgyB,EAAW1uB,EAAS6B,SAGjC,KAGG+tB,EAAe,SAACjvB,EAAoBsJ,EAAcjK,GAEvD,OAAIW,EAAQnE,QAAUyN,EACf,GAAN,mBAAWtJ,GAAX,CAAoB,CAACX,MAGdW,GAAW,IAAIgB,QAAO,SAACC,EAAe4tB,EAAmBC,GAChE,MACO,GAAN,mBAAW7tB,GADR6tB,IAAMxlB,EACT,CAAgBulB,GAEjB,uBAAoBA,GAApB,CAA+BxvB,QAC9B,KAgDGwuB,EAAY,SAACqB,EAAepB,EAAezuB,GAChD,IAAM8vB,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAASivB,EAAa1uB,EAAKP,QAAS8tB,EAAQzuB,SAG7C,IACFsvB,EAASQ,IAmBJC,EAAa,SAAC9lB,EAAchJ,GACjC,OAAO,sBAAKpK,UAAU,UAAf,UACN,6CACA,cAAC,IAAD,CAAWgB,YAAY,YAAYjB,MAAO,CAAC+1B,QAAQ,GAAIh1B,SAAU,SAAAT,GAAC,OAXpD,SAAC+S,EAAchJ,GAC9BquB,EAAShuB,EAAMK,QAAO,SAACC,EAAY2L,EAAW7Q,GAC7C,MACO,GAAN,mBAAWkF,GADRlF,IAAMuN,EACT,CAAgBsD,GACjB,4BAAoBA,GAApB,IAA0BtM,aACzB,KAMqE+uB,CAAQ/lB,EAAM/S,EAAEiR,OAAOrQ,QAAQA,MAAOmJ,QAYxGgvB,EAAa,SAAChmB,EAAc/I,GAEjC,OAAQ,qCAAE,sBAAKrK,UAAU,UAAf,UACP,2EACA,qBAAKD,MAAO,CAACizB,UAAU,GAAItQ,aAAa,GAAxC,SACC,cAAC,IAAD,CAAW1hB,YAAY,OAAOjB,MAAO,CAAC+1B,QAAQ,EAAE9yB,MAAM,KAAMlC,SAAU,SAAAT,GAAC,OApCzD,SAAC+S,EAAcjJ,GACjCsuB,EAAShuB,EAAMK,QAAO,SAACC,EAAY2L,EAAW7Q,GAC7C,MACO,GAAN,mBAAWkF,GADRlF,IAAMuN,EACT,CAAgBsD,GACjB,4BAAoBA,GAApB,IAA0BrM,KAAK,2BAAIqM,EAAKrM,MAAV,IAAeF,kBAC5C,KA+B6EkvB,CAAWjmB,EAAO/S,EAAEiR,OAAOrQ,QAAQA,OAbzFA,EAagHoJ,EAAKA,KAAKF,QAZ/IkO,MAAMC,QAAQrX,GACVA,EAAM4R,KAAK,KAEZ5R,OAWJ,sBAAKlB,MAAO,CAAC2iB,aAAa,GAAIsQ,UAAU,GAAxC,mBAAkD,sBAAMhzB,UAAU,OAAOJ,QAAS,WAAK+3B,EAAU,EAAE,EAAE,CAAC,OAAS,MAA7D,SAAqEttB,EAAKP,QAAQnE,QAAU,EAAI,UAAY,KAA9J,UAGA0E,EAAKP,QAAQnE,OAAS,GAAK,cAAC,EAAD,CAASmE,QAASO,EAAKP,QAChDmuB,aAAc,SAACjtB,EAAEE,GAAH,OAtGC,SAAC8tB,EAAepB,EAAeC,GACnD,IAAMoB,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAAS4uB,EAAaruB,EAAKP,QAAS8tB,EAAQC,SAG7C,IACFY,EAASQ,GA0FiBhB,CAAa7kB,EAAOpI,EAAEE,IAC3CysB,UAAW,SAACC,EAAe7D,GAAkB4D,EAAUvkB,EAAOwkB,EAAQ7D,IACtEsE,WAAY,SAACT,EAAeC,EAAiB1uB,GAAjC,OAzFC,SAAC6vB,EAAepB,EAAeC,EAAiB1uB,GAClE,IAAM8vB,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAASgvB,EAAazuB,EAAKP,QAAS8tB,EAAQC,EAAU1uB,SAGvD,IACFsvB,EAASQ,GA6EyDZ,CAAWjlB,EAAMwkB,EAAOC,EAAS1uB,IAC9FmvB,kBAAmB,kBA3EC,SAACU,GAC1B,IAAMC,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAAQ,GAAD,mBAAMO,EAAKP,SAAX,CAAoB,CAAC,CAAC,OAAS,aAGvC,IACF2uB,EAASQ,GA+DmBX,CAAkBllB,MAE3C8lB,EAAW9lB,EAAM/I,EAAKD,MAAM,OAxBP,IAACnJ,GAkC1B,OAAQ,qCACN,sBAAK4L,GAAG,cAAc9M,MAAO,CAAC2iB,aAAa,IAA3C,UANMjY,EAAMtI,KAAI,SAAC8H,EAAEpE,GACnB,OAAOuzB,EAAWvzB,EAAEoE,MAOnB,qBAAKlK,MAAO,CAACszB,UAAU,UAAvB,SACC,cAAC,IAAD,CAAY5zB,KAAM,cAAC,IAAD,IAAcC,UAAU,EAAOS,MAAO,mBAAoBP,QA1K7D,WAClB64B,EAAS,GAAD,mBAAKhuB,GAAL,CAAW,CAACJ,KAAK,CAACC,SAAS,WAAYH,QAAQ,IAAIL,QAAQ,GAAGM,KAAK,QAyKyBtK,QAAQ,iBAG3G,qBAAKC,MAAO,CAAE22B,QAAQ,OAAQ4C,eAAe,UAA7C,SACC,eAAC,IAAD,WACC,cAAC,IAAD,CACC95B,UAAU,EACVC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,UACT/B,QAAS,kBAAI8d,EAAMjT,IACnB3K,QAAQ,WAET,cAAC,IAAD,CACCL,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACT/B,QAAS,kBAAM44B,gBCrLRgB,EAA2C,SAAAl6B,GAAU,IAC1Doe,EAAmBpe,EAAnBoe,MAAO8a,EAAYl5B,EAAZk5B,SACP72B,EAAKC,cAALD,EAFyD,EAItCtC,WAAuBC,EAAMmL,OAAS,CAAC,CAACJ,KAAK,CAACC,SAAS,SAAUH,QAAQ,IAAIL,QAAQ,GAAGM,KAAK,MAJvD,mBAIzDK,EAJyD,KAIlDguB,EAJkD,KAU1DC,EAAe,SAAC5uB,EAAoBsJ,EAAcykB,GAEvD,OAAI/tB,EAAQnE,QAAUyN,EACdtJ,GAGAA,GAAW,IAAIgB,QAAO,SAACC,EAAe4tB,EAAmBC,GAChE,GAAIA,IAAMxlB,EACT,MAAM,GAAN,mBAAWrI,GAAX,CAAgB4tB,IACjB,IAAME,EAAcF,EAAUpuB,QAAO,SAACS,EAAEnF,GAAH,OAAOA,IAAMgyB,KAClD,OAAOgB,EAAWlzB,QAAU,EAAIoF,EAAzB,sBAAmCA,GAAnC,CAAwC8tB,MAC9C,KAGGC,EAAe,SAAChvB,EAAoBsJ,EAAcykB,EAAiB1uB,GAExE,OAAIW,EAAQnE,QAAUyN,EACf,GAAN,mBAAWtJ,GAAX,CAAoB,CAACX,MAGdW,GAAW,IAAIgB,QAAO,SAACC,EAAe4tB,EAAmBC,GAChE,MACO,GAAN,mBAAW7tB,GADR6tB,IAAMxlB,EACT,CAAgBulB,GAEjB,CAAgBA,EAAUx2B,KAAI,SAAC6I,EAAEnF,GAChC,OAAOA,IAAMgyB,EAAW1uB,EAAS6B,SAGjC,KAGG+tB,EAAe,SAACjvB,EAAoBsJ,EAAcjK,GAEvD,OAAIW,EAAQnE,QAAUyN,EACf,GAAN,mBAAWtJ,GAAX,CAAoB,CAACX,MAGdW,GAAW,IAAIgB,QAAO,SAACC,EAAe4tB,EAAmBC,GAChE,MACO,GAAN,mBAAW7tB,GADR6tB,IAAMxlB,EACT,CAAgBulB,GAEjB,uBAAoBA,GAApB,CAA+BxvB,QAC9B,KAgDGwuB,EAAY,SAACqB,EAAepB,EAAezuB,GAChD,IAAM8vB,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAASivB,EAAa1uB,EAAKP,QAAS8tB,EAAQzuB,SAG7C,IACFsvB,EAASQ,IAmBJC,EAAa,SAAC9lB,EAAchJ,GACjC,OAAO,sBAAKpK,UAAU,UAAf,UACN,6CACA,cAAC,IAAD,CAAWgB,YAAY,YAAYjB,MAAO,CAAC+1B,QAAQ,GAAIh1B,SAAU,SAAAT,GAAC,OAXpD,SAAC+S,EAAchJ,GAC9BquB,EAAShuB,EAAMK,QAAO,SAACC,EAAY2L,EAAW7Q,GAC7C,MACO,GAAN,mBAAWkF,GADRlF,IAAMuN,EACT,CAAgBsD,GACjB,4BAAoBA,GAApB,IAA0BtM,KAAMA,EAAKnD,aACpC,KAMqEkyB,CAAQ/lB,EAAM/S,EAAEiR,OAAOrQ,QAAQA,MAAOmJ,QAWxGgvB,EAAa,SAAChmB,EAAc/I,GAEjC,OAAQ,gCACN,sBAAKrK,UAAU,UAAf,UACC,uCACA,qBAAKD,MAAO,CAACizB,UAAU,GAAvB,SACC,cAAC,IAAD,CAAWhyB,YAAY,OAAOjB,MAAO,CAAC+1B,QAAQ,EAAE9yB,MAAMwB,KAAKqoB,IAAI,GAA8B,EAA3BxiB,EAAKA,KAAKF,QAAQxE,SAAc7E,SAAU,SAAAT,GAAC,OApC/F,SAAC+S,EAAcjJ,GACjCsuB,EAAShuB,EAAMK,QAAO,SAACC,EAAY2L,EAAW7Q,GAC7C,MACO,GAAN,mBAAWkF,GADRlF,IAAMuN,EACT,CAAgBsD,GACjB,4BAAoBA,GAApB,IAA0BrM,KAAK,2BAAIqM,EAAKrM,MAAV,IAAeF,kBAC5C,KA+BmHkvB,CAAWjmB,EAAO/S,EAAEiR,OAAOrQ,QAAQA,OAb/HA,EAasJoJ,EAAKA,KAAKF,QAZrLkO,MAAMC,QAAQrX,GACVA,EAAM4R,KAAK,KAEZ5R,OAWJ,sBAAKrB,QAAS,WACb+3B,EAAU,EAAE,EAAE,CAAC,OAAS,MADzB,6BAEoBttB,EAAKP,QAAQnE,QAAU,EAAI,UAAY,GAF3D,UAKA0E,EAAKP,QAAQnE,OAAS,GAAK,cAAC,EAAD,CAASmE,QAASO,EAAKP,QAChDmuB,aAAc,SAACjtB,EAAEE,GAAH,OAxGC,SAAC8tB,EAAepB,EAAeC,GACnD,IAAMoB,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAAS4uB,EAAaruB,EAAKP,QAAS8tB,EAAQC,SAG7C,IACFY,EAASQ,GA4FiBhB,CAAa7kB,EAAOpI,EAAEE,IAC3CysB,UAAW,SAACC,EAAe7D,GAAkB4D,EAAUvkB,EAAOwkB,EAAQ7D,IACtEsE,WAAY,SAACT,EAAeC,EAAiB1uB,GAAjC,OA3FC,SAAC6vB,EAAepB,EAAeC,EAAiB1uB,GAClE,IAAM8vB,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAASgvB,EAAazuB,EAAKP,QAAS8tB,EAAQC,EAAU1uB,SAGvD,IACFsvB,EAASQ,GA+EyDZ,CAAWjlB,EAAMwkB,EAAOC,EAAS1uB,IAC9FmvB,kBAAmB,kBA7EC,SAACU,GAC1B,IAAMC,EAASxuB,EAAMK,QAAO,SAACC,EAAYV,EAAWxE,GACnD,MACO,GAAN,mBAAWkF,GADRlF,IAAMmzB,EACT,CAAgB3uB,GACjB,4BAGKA,GAHL,IAIEP,QAAQ,GAAD,mBAAMO,EAAKP,SAAX,CAAoB,CAAC,CAAC,OAAS,aAGvC,IACF2uB,EAASQ,GAiEmBX,CAAkBllB,MAE3C8lB,EAAW9lB,GAAO/I,EAAKD,MAAM,IAAInD,UAjBlBmM,GATM,IAACnS,GAoC1B,OAAQ,qCACN,sBAAK4L,GAAG,QAAQ9M,MAAO,CAAC2iB,aAAa,IAArC,UANMjY,EAAMtI,KAAI,SAAC8H,EAAEpE,GACnB,OAAOuzB,EAAWvzB,EAAEoE,MAOnB,qBAAKlK,MAAO,CAACszB,UAAU,UAAvB,SACC,cAAC,IAAD,CAAY5zB,KAAM,cAAC,IAAD,IAAcC,UAAU,EAAOS,MAAO,mBAAoBP,QA5K7D,WAClB64B,EAAS,GAAD,mBAAKhuB,GAAL,CAAW,CAACJ,KAAK,CAACC,SAAS,SAAUH,QAAQ,IAAIL,QAAQ,GAAGM,KAAK,QA2K2BtK,QAAQ,iBAG3G,qBAAKC,MAAO,CAAC22B,QAAQ,OAAQ4C,eAAe,UAA5C,SACC,eAAC,IAAD,WACC,cAAC,IAAD,CACC95B,UAAU,EACVC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,UACT/B,QAAS,kBAAI8d,EAAMjT,IACnB3K,QAAQ,WAET,cAAC,IAAD,CACCL,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACT/B,QAAS,kBAAM44B,gBCxMRiB,EAA0C,SAAAn6B,GAAU,IACzDG,EAA4BH,EAA5BG,KAAMU,EAAsBb,EAAtBa,MAAOU,EAAevB,EAAfuB,KAAM6c,EAASpe,EAAToe,MADqC,EAErBre,YAAe,GAFM,mBAExDq6B,EAFwD,aAGvCr6B,YAAe,IAHwB,mBAGxDsR,EAHwD,KAGlD8F,EAHkD,KAKxD9U,EAAKC,cAALD,EAQP,OACC,sBAAM3B,UAAU,iBAAhB,SACC,cAAC,IAAD,CACCR,UAAU,EACVC,KAAI,OAAEA,QAAF,IAAEA,IAAQ,cAAC,IAAD,IACdU,MAAK,OAAEA,QAAF,IAAEA,IAASwB,EAAE,gBAClB+O,aAAc,WACb+F,GAAQ,IAET9F,KAAMA,EAPP,SASC,cAAC,IAAD,CAAa5Q,MAAO,CAACiD,MAAM,IAAK2wB,UAAU,QAA1C,SACC,sBAAK3zB,UAAU,YAAf,UACC,qBAAKA,UAAU,OAAf,2NAEA,sBAAKD,MAAO,CAAC+1B,QAAQ,GAAI6D,WAAW,UAAW9D,aAAa,EAAG7C,UAAU,IAAzE,UACC,qBAAKjzB,MAAO,CAAC2iB,aAAa,GAAIgT,cAAc,GAAI3C,aAAa,mBAA7D,SACC,cAAC,IAAD,CAAYjyB,SArBA,SAACT,GACnBgI,QAAQC,IAAI,uBAAwBjI,EAAEiR,OAAOrQ,OAC7C3B,EAAMs6B,SAASv5B,EAAEiR,OAAOrQ,QAmBgBiB,QAAS,CAAC,CAAC/B,MAAM,SAAUc,MAAM,UAAW,CAACd,MAAM,UAAWc,MAAM,WAAY,CAACd,MAAM,SAAUc,MAAM,WAAYA,MAAOJ,EAA5J,yBAGS,WAATA,GAAqB,cAAC,EAAD,CAAgB23B,SAAU,WAAK/hB,GAAQ,IAAS5V,KAAMA,EAAM4J,MAAOnL,EAAMmL,MAAQiT,MAAO,SAACjT,GAC9GpC,QAAQC,IAAI,6BAA8BmC,GAC1CgM,GAAQ,GACRiH,EAAMjT,MAGG,YAAT5J,GAAsB,cAAC,EAAD,CAAiB23B,SAAU,WAAK/hB,GAAQ,IAAS5V,KAAMA,EAAM4J,MAAOnL,EAAMmL,MAAQiT,MAAO,SAACjT,GAChHpC,QAAQC,IAAI,+BAAgCmC,GAC5CgM,GAAQ,GACRiH,EAAMjT,MAGG,WAAT5J,GAAqB,cAAC,EAAD,CAAgB23B,SAAU,WAAK/hB,GAAQ,IAAS5V,KAAMA,EAAM4J,MAAOnL,EAAMmL,MAAQiT,MAAO,SAACjT,GAC9GpC,QAAQC,IAAI,8BAA+BmC,GAC3CgM,GAAQ,GACRiH,EAAMjT,SAKPivB,IAAiB,Y,iHC1DXG,G,OAAwD,SAAAv6B,GAAU,IACvE2gB,EAAuB3gB,EAAvB2gB,OAAQxc,EAAenE,EAAfmE,YACTmQ,EAAWmS,cACVjO,EAASkO,4BAATlO,MACDgiB,ECMA,SACNC,EACAC,GACE,IAAD,EAC2BvS,mCAArBjF,EADN,EACMA,SAAU3J,EADhB,EACgBA,QADhB,EAE2BxZ,WAAwC,IAFnE,mBAEM46B,EAFN,KAEcC,EAFd,OAMG76B,aANH,mBAIA86B,EAJA,KAKAC,EALA,KAOKrsB,EAAS+K,mCAAyBD,EAASkhB,EAAYC,GACtDliB,EAASkO,4BAATlO,MACDuiB,EAAqBnS,yCAC1BpQ,EACAiiB,EACAC,GAwGD,OArGA36B,aAAgB,WACf,IAAIg7B,EAIJ,GAAyB,aAArBtsB,EAAOE,UACVuU,EAASuG,+BAAqBhb,SACxB,GACe,WAArBA,EAAOE,YACNgsB,EAAOtrB,YAAmBZ,IAC1B,CAAC,IAAD,IACKusB,EAAY3rB,YAAmBZ,GAC/BI,EAAmBL,YAAuBC,EAAQC,KAExD,UAAIG,QAAJ,IAAIA,GAAJ,UAAIA,EAAkBosB,kBAAtB,aAAI,EAA8BC,SACjC,IAAK,IAAMC,KAAetsB,EAAiBosB,WAAWC,SAAU,CAC/D,IAAME,EAAoBJ,EAAYG,EAElCC,KAAqBC,IAAWH,SACnCnyB,QAAQmG,KAAR,oCAC8BksB,EAD9B,gCAOCC,IAAWH,SACXE,GACGvsB,EAAiBosB,WAAYC,SAAUC,IAK9C,OAAItsB,QAAJ,IAAIA,GAAJ,UAAIA,EAAkBosB,kBAAtB,aAAI,EAA8BK,UACjCR,GACC,kBAAM,SACLna,EACA4a,GACK,IAAD,EAGJ,KAAI,OAAC1sB,QAAD,IAACA,GAAD,UAACA,EAAkBosB,kBAAnB,aAAC,EAA8BK,SAClC,MAAO,GAGR,IAAMtkB,EAAQnI,EAAiBosB,WAAWK,QACzC3a,EACA4a,GAMD,OAAKxiB,MAAMC,QAAQhC,GAOZA,EAAMxL,QAAO,SAACxF,EAAQoR,GAC5B,OAAQA,EAAK7V,MACZ,IAAK,SACJ,MAAM,GAAN,mBACIyE,GADJ,4BAEKoR,GAFL,IAEWyJ,QAASma,EAAY5jB,EAAKyJ,YAGtC,IAAK,OACJ,GAAI9H,MAAMC,QAAQ5B,EAAKJ,OACtB,MAAM,GAAN,mBACIhR,GADJ,4BAGKoR,GAHL,IAIEJ,MAAOI,EAAKJ,MACV/L,QAAO,SAAAuwB,GAAO,MACd,CAAC,SAAU,aAAat0B,SAASs0B,EAAQj6B,SAEzCsB,KAAI,SAAA24B,GAAO,MACM,cAAjBA,EAAQj6B,KACLi6B,EADH,2BAGMA,GAHN,IAIG3a,QAASma,EAAYQ,EAAQ3a,iBAQvC,OAAO7a,IACL,IAtCK,OA2CX40B,GAAU,SAAAD,GAAM,kCAASA,GAAT,kBAAkBtrB,YAAmBZ,IAAU,UAE9D,CAACyU,EAAU6X,EAAoBtsB,EAAQksB,IAEnCE,ED7HgBY,CACtBt3B,EAAYhB,KACZgB,EAAYgL,SANgE,EAQrCpP,WAEtC,IAV2E,mBAQtE27B,EARsE,KAQxDC,EARwD,KAuC7E,OA3BA57B,aAAgB,WACf,GAAIy6B,GAAkB7Z,EACrB,IACCgb,EACCnB,EAAe7Z,EAAQ,CACtBrM,WACAU,OAAQwD,EAAMxD,UAGf,MAAOyI,GACR1U,QAAQ0U,MAAR,+BACyBtZ,EAAYhB,KADrC,YAC6CgB,EAAYgL,QADzD,oCAECsO,QAIFke,EAAgB,MAEf,CACFrnB,EACAqM,EACAnI,EAAMxD,OACN7Q,EAAYhB,KACZgB,EAAYgL,QACZqrB,IAIA,qBAAK95B,UAAU,uBAAf,SACC,cAAC,IAAD,UACEg7B,EAAa74B,KAAI,SAACuU,EAAMtD,GACxB,OAAQsD,EAAK7V,MACZ,IAAK,SACJ,OACC,cAAC,IAAD,CACCrB,SAAUkX,EAAKlX,SACfC,KAAM,qBAAK0zB,IAAKzc,EAAKjX,KAAMy7B,IAAI,KAE/B/6B,MAAOuW,EAAKvW,MACZP,QAAS,yBAAMqgB,QAAN,IAAMA,OAAN,EAAMA,EAAQC,YAAYxJ,EAAKyJ,WAFnC/M,GAMR,IAAK,OACJ,OACC,cAAC,IAAD,CACC5T,SAAUkX,EAAKlX,SACfC,KAAM,qBAAK0zB,IAAKzc,EAAKjX,KAAMy7B,IAAI,KAC/B5kB,MAAOI,EAAKJ,MACV/L,QAAO,SAAAuwB,GAAO,MACd,CAAC,SAAU,aAAat0B,SAASs0B,EAAQj6B,SAEzCsB,KAAI,SAAA24B,GACJ,MAAqB,WAAjBA,EAAQj6B,KACJ,CACNA,KAAM,SACNrB,SAAUs7B,EAAQt7B,SAClBW,MAAO26B,EAAQ36B,MACfP,QAAS,yBAAMqgB,QAAN,IAAMA,OAAN,EAAMA,EAAQC,YAAY4a,EAAQ3a,WAItC,CAACxJ,WAAW,MAGrBxW,MAAOuW,EAAKvW,OADPiT,GAOT,OAAO,cEhFC+nB,EAA0C,SAAA77B,GAAU,IAAD,EACxDwB,EAAkDxB,EAAlDwB,SAAUs6B,EAAwC97B,EAAxC87B,eAAgB7tB,EAAwBjO,EAAxBiO,QAAS9J,EAAenE,EAAfmE,YADqB,EAErBpE,YAAe,GAFM,mBAExDg8B,EAFwD,KAEzCC,EAFyC,OAG7Bj8B,WAAekO,EAAQ1K,MAHM,mBAGxD04B,EAHwD,KAG7CC,EAH6C,OAInCn8B,aAJmC,mBAIxD4gB,EAJwD,KAIhDwb,EAJgD,KAKxD3jB,EAASkO,4BAATlO,MACD8S,EAAI,UCRJ,SACNmP,EACAC,GACE,IAAD,EAC2BvS,mCAArBjF,EADN,EACMA,SAAU3J,EADhB,EACgBA,QACX9K,EAAS+K,mCAAyBD,EAASkhB,EAAYC,GACtDliB,EAASkO,4BAATlO,MAHN,EAI+BzY,aAJ/B,mBAIMq8B,EAJN,KAIgBC,EAJhB,KAKKtB,EAAqBnS,yCAC1BpQ,EACAiiB,EACAC,GAuBD,OApBA36B,aAAgB,WACf,IAAIg7B,EAIJ,GAAyB,aAArBtsB,EAAOE,UACVuU,EAASuG,+BAAqBhb,SACxB,GAAyB,WAArBA,EAAOE,UAAwB,CAAC,IAAD,EACnCE,EAAmBL,YAAuBC,EAAQC,MAExD,OAAIG,QAAJ,IAAIA,GAAJ,UAAIA,EAAkBosB,kBAAtB,aAAI,EAA8B3P,QACjC+P,IAAWiB,WACVjtB,YAAmBZ,GACnBI,EAAiBosB,WAAW3P,MAE7B+Q,EAAYhtB,YAAmBZ,QAG/B,CAACyU,EAAU6X,EAAoBtsB,IAE3B2tB,EDzBNG,CAAwBp4B,EAAYhB,KAAMgB,EAAYgL,gBAD7C,QACyD,OAC5D9M,EAAKC,cAALD,EAQPtC,aAAgB,WAKVg8B,GAAiBE,IAAchuB,EAAQ1K,MAC3C24B,EAAajuB,EAAQ1K,QAEpB,CAACw4B,EAAeE,EAAWhuB,EAAQ1K,OAKtC,IAAMi5B,EAAoBz8B,WACzB,kBACC08B,oBAAS,SAAC96B,GACTH,EAASG,GACTq6B,GAAiB,KACf,OACJ,CAACx6B,IA4BF,OACC,qCACC,cAAC,EAAD,CAAoBmf,OAAQA,EAAQxc,YAAaA,IACjD,cAAC,IAAD,UACC,cAAC,IAAD,CACC+mB,eA9BJ,SAAqBvK,GACpBwb,EAAUxb,GACVmb,EAAenb,GAMftS,OAAOquB,YAAW,WACjB/b,EAAOG,QACPH,EAAOgc,YACL,MAoBAhmB,WAAY6B,EAAMnD,wBAClBuB,UAAW4B,EAAMlD,uBACjBzU,MAAOwB,EAAE,8CACTyU,aAAW,EACXqU,eArBJ,SACCxK,EACAlT,EACAlK,GAEAu4B,EAAenb,GACfqb,GAAiB,GACjBQ,EAAkBj5B,GAClB24B,EAAa34B,IAcV/B,SAAUs6B,EACVl5B,QAAO,2BACHib,YAA2BrF,IADxB,IAEN8S,OACAsR,cAAc,IAEfj7B,MAAOs6B,U,SE5ECY,I,OAAoD,SAAA78B,GAAU,IAEnEG,EAA8BH,EAA9BG,KAAMU,EAAwBb,EAAxBa,MAAOud,EAAiBpe,EAAjBoe,MAAMhc,EAAWpC,EAAXoC,QAF+C,EAG/BrC,YAAe,GAHgB,mBAGlEq6B,EAHkE,KAGnD0C,EAHmD,OAIpC/8B,WAAe,UAJqB,mBAI/Dg9B,EAJ+D,KAIpDC,EAJoD,OAK5Cj9B,WAA8BC,EAAMgzB,OALQ,mBAK/DA,EAL+D,KAKxDiK,EALwD,OAMxCl9B,WAA2BC,EAAMwK,SANO,mBAM/DA,EAN+D,KAMtD0yB,EANsD,OAQjDn9B,YAAe,GARkC,mBAQlEsR,EARkE,KAQ5D8F,EAR4D,KASlE9U,EAAKC,cAALD,EAGM2wB,EAAM3sB,OA+DnB,OACC,sBAAM3F,UAAU,iBAAhB,SACC,eAAC,IAAD,CACCR,UAAU,EACVC,KAAI,OAAEA,QAAF,IAAEA,IAAQ,cAAC,IAAD,IACdU,MAAK,OAAEA,QAAF,IAAEA,IAASwB,EAAE,kBAClB+O,aAAc,SAACrQ,GAAKoW,GAAQ,IAC5B9F,KAAMA,EALP,UAQC,eAAC,IAAD,CAAa5Q,MAAO,CAACiD,MAAM,IAAK8yB,QAAQ,IAAxC,UACgB,qBAAK91B,UAAU,OAAf,iOACA,sBAAKD,MAAO,CAAC+1B,QAAQ,GAAI6D,WAAW,UAAW9D,aAAa,EAAG7C,UAAU,IAAzE,UACI,cAAC,IAAD,CACIlyB,SAtE3B,SAA0BwM,GACzB,IAAM+uB,EAAY/uB,EAAMgE,OAAOrQ,MAC/Bq7B,EAAaD,GACPD,GAAiB,IAoEGl6B,QAAS,CACL,CAAC1C,UAAS,EAAOW,MAAM,SAAUc,MAAM,UACvC,CAACzB,UAAS,EAAOW,MAAM,SAAUc,MAAM,WAE3CA,MAAOo7B,EANX,SAQK16B,EAAE,yCAEQ,WAAd06B,GAEG,cAAC,EAAD,CAASvyB,QAASA,EAClBmuB,aAAc,SAACjtB,EAAEE,GAAH,OA5EjB,SAAC0sB,EAAcC,GAChC,IAAM9tB,EAAuBD,EAAQgB,QAAO,SAACC,EAAgBS,EAAc4H,GACvE,OAAIwkB,IAASxkB,EACQ,IAAbykB,GAAiC,IAAfrsB,EAAI7F,OACfoF,EAEL,GAAN,mBAAWA,GAAX,CAAgBS,EAAIV,QAAO,SAACC,EAAc2L,EAAa9N,GACnD,OAAIA,IAAOivB,EACA9sB,EACL,GAAN,mBAAWA,GAAX,CAAgB2L,MAClB,MAEA,GAAN,mBAAW3L,GAAX,CAAgBS,MAClB,IACFgxB,EAAWzyB,GA8D8BkuB,CAAajtB,EAAEE,IACpCysB,UAAW,SAACC,EAAe7D,IA3DjC,SAAC6D,EAAezuB,GAC9B,GAAuB,IAAnBW,EAAQnE,OACR62B,EAAW,CAAC,CAACrzB,SAEb,CACA,IAAMY,EAAuBD,EAAQ3H,KAAI,SAACqJ,EAAK4H,GAC3C,OAAOA,IAAQwkB,EAAR,sBAAqBpsB,GAArB,CAA0BrC,IAAUqC,KAE/CgxB,EAAWzyB,IAmDkD4tB,CAAUC,EAAQ7D,IAC/DsE,WAAY,SAACT,EAAeC,EAAiB1uB,GAAjC,OA/CjB,SAACyuB,EAAcC,EAAiB1uB,GAC/C,IAAMY,EAAuBD,EAAQgB,QAAO,SAACC,EAAgBS,EAAc4H,GACvE,MACU,GAAN,mBAAWrI,GADX6sB,IAASxkB,EACT,CAAgB5H,EAAIV,QAAO,SAACC,EAAc2L,EAAa9N,GACnD,MACU,GAAN,mBAAWmC,GADXnC,IAAOivB,EACP,CAAe1uB,GACnB,CAAgBuN,MAClB,KAEN,CAAgBlL,MAClB,IACFgxB,EAAWzyB,GAoCsEsuB,CAAWT,EAAOC,EAAS1uB,IACxFmvB,kBAAmB,WAhC7CkE,EAAW,GAAD,mBAAK1yB,GAAL,CAAa,CAAC,CAAC,OAAS,WAmCG,WAAduyB,GACG,cAAC,EAAD,CAAW/J,MAAOA,EAAO5U,MAAO,SAAC4U,GAASiK,EAASjK,SAGtDoH,IAAiB,KAG1B,qBAAK35B,MAAO,CAAE22B,QAAQ,OAAQ4C,eAAe,UAA7C,SACZ,eAAC,IAAD,WACC,cAAC,IAAD,CACC95B,UAAU,EACVC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,cACT/B,QA1GL,WACC8d,EAAM4U,EAAMxoB,GACZ2M,GAAQ,IAyGJ3W,QAAQ,WAET,cAAC,IAAD,CACCL,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACT/B,QAAS,WACa6W,GAAQ,GACR/U,mB,SCtGf+6B,GAA2D,SAAAn9B,GAAU,IAC1Ema,EAAgCna,EAAhCma,UAAWL,EAAqB9Z,EAArB8Z,QAAYxI,EADkD,YACzCtR,EADyC,2BAEhDD,aAFgD,mBAEzEgrB,EAFyE,KAE/DC,EAF+D,OAGpDP,sCAArBvH,EAHyE,EAGzEA,SAAUpQ,EAH+D,EAG/DA,QACVyG,EAAW4O,mCAAX5O,QACDtL,EAAUmO,wBAActJ,EAASgH,EAASK,GAC1CpM,EAAQ8L,sBAAY/G,EAASgH,GAC7B3V,EAAcqV,mCACnBD,EACAxL,EAAM5J,YACN4J,EAAM3J,oBAEA/B,EAAKC,cAALD,EAED+6B,EAA0Br9B,eAC/B,SAACwD,GACA2f,EAAS0K,wBAAc7f,EAAOE,EAAS,CAAC1K,YAEzC,CAAC2f,EAAUjV,EAASF,IAGfsvB,EAAiBt9B,eAAkB,SAACuK,EAAmBE,GAE5D,IAAM8yB,EAAahxB,aAAgB2B,EAAQ1K,MAGrCg6B,EAAczwB,aAAgB,2BAAIwwB,GAAL,IAAiB5wB,QAAQ,2BAAI4wB,EAAW5wB,SAAhB,IAAyBpC,SAAQE,eAG5F0Y,EAAS0K,wBAAc7f,EAAOE,EAAS,CAAC1K,KAAMg6B,OAE7C,CAACra,EAAUjV,EAASF,IA+CtB,IAAMyvB,EAAUzvB,EAAM7J,eAAiB+J,EAAQV,GACzChB,EAAOD,aAAgB2B,EAAQ1K,MAGrC,OACC,eAAC,IAAD,2BACK+N,GADL,IAEC5Q,UAAU,sBACVwB,YAAa+L,EAAQ9K,KAHtB,UAKC,eAAC,IAAD,WACC,cAAC,IAAD,CAAiBwd,OAAQoK,EAAUrH,MAAOzV,EAAQ1K,OAgBlD,cAAC,GAAD,CACCyvB,OAAQ1mB,aAAgB2B,EAAQ1K,MAAM,IAAImJ,SAAW,IAAIpC,QAAU,GACnEE,SAAU8B,aAAgB2B,EAAQ1K,MAAM,IAAImJ,SAAW,IAAIlC,SAAW,GACtE4T,MAAOif,EACPj7B,QAAS,WAAK2G,QAAQC,IAAI,YAC1BnI,MAAO,aAER,cAAC,EAAD,CACCsK,MAAOmB,aAAgB2B,EAAQ1K,MAAM4H,MACrC5J,KAAMgL,EAAKhL,KACXV,MAAM,QACNud,MAAO,SAACjT,GACP,IAAMmyB,EAAU,eAAOhxB,aAAgB2B,EAAQ1K,OAIzCk6B,EAAQ,2BACVH,GADU,IAEbnyB,UAGKoyB,EAAczwB,aAAgB2wB,GACpCva,EAAS0K,wBAAc7f,EAAOE,EAAS,CAAC1K,KAAMg6B,MAG/CjD,SAAU,SAAC/4B,GAEV,IAAMm8B,EAAK,2BACPnxB,GADO,IAEVhL,SAGKg8B,EAAczwB,aAAgB4wB,GAEpC30B,QAAQC,IAAIu0B,GAEZra,EAAS0K,wBAAc7f,EAAOE,EAAS,CAAC1K,KAAMg6B,QAkChD,cAAC,IAAD,CACCpW,SA1HJ,SAAsBhkB,GAMrB+f,EACC0K,wBACC7f,EACAE,EACA,CAAC9K,QACD,CAAC2qB,+BAA+B,MAgH/B7f,QAASA,EACTF,MAAOA,IAER,cAAC,IAAD,CACC7N,SAAUs9B,EACV38B,MAAOwB,EAAE,kCACTb,SAjHJ,WACC0hB,EAASkI,sBAAYtY,EAAS/E,EAAO,CAAC7J,aAAciW,MAiHjDxY,MAAO67B,OAGRvvB,EAAQ3K,KAAK+C,OAAS,GACtB,qBAAK3F,UAAU,OAAf,SACC,cAAC,IAAD,UACEuN,EAAQ3K,KAAKT,KAAI,SAAAmR,GAAG,OACpB,cAAC,IAAD,CACC8K,MAAO/Q,EAAMzJ,UAAU0P,GAEvB7Q,KAAM6Q,EACNiL,cAAe,SAAAH,GAAK,OAzJ3B,SAA8B3b,EAAc2b,GAC3CoE,EACCkI,sBAAYtY,EAAS/E,EAAO,CAC3BzJ,UAAU,2BAAKyJ,EAAMzJ,WAAZ,kBAAwBnB,EAAO2b,OAsJZ6e,CAAqB3pB,EAAK8K,IAClDI,SAAU,kBAlJQ/b,EAkJc6Q,OAjJtCkP,EAAS2M,2BAAiB9hB,EAAOE,EAAS9K,GAAOd,EAAE,yBADpD,IAAyBc,IA+Ib6Q,UASV,cAAC,EAAD,CACCxS,SAAU47B,EACVtB,eAAgB9Q,EAChB/c,QAASA,EACT9J,YAAaA,SAMJy5B,GAAsD,SAAA59B,GAAS,IAIpE8S,EAAW2X,sCAAX3X,QAEP,IACCsJ,wBAActJ,EAAS9S,EAAM8Z,QAAS9Z,EAAMma,WAC3C,MAAOrR,GAGR,OAFAC,QAAQC,IAAI,QAASF,GACrB9I,EAAMoC,UACC,KAGR,OAAO,cAAC,GAAD,eAA4BpC,M,gKCrQvB69B,EAAsC,SAAA79B,GAAU,IACrDkB,EAA2DlB,EAA3DkB,SAAUM,EAAiDxB,EAAjDwB,SAAUs8B,EAAuC99B,EAAvC89B,QAAS78B,EAA8BjB,EAA9BiB,YAAgB0D,EADO,YACO3E,EADP,iDAErDU,EAAYC,IACjB,aAD2B,6BAEZM,QAFY,IAEZA,IAAe,eA0B/B,OACC,sBAAMP,UAAWA,EAAjB,SACC,kCACC,sBAAMA,UAAU,mBAAhB,SAAoCQ,IACpC,sBAAMR,UAAU,qBAAhB,SACC,iDAAWiE,GAAX,IAAuBnD,SA5B3B,SAAsBu8B,GACrB,IAAKA,EAAY/rB,OAAOqjB,MACvB,MAAM,IAAI/uB,MAAM,8CAGjB,IAAM2S,EAAO8kB,EAAY/rB,OAAOqjB,MAAM,GAChC2I,EAAS,IAAIC,WAEnBD,EAAO7rB,iBAAiB,WAAW,SAAA+rB,GAC9BF,EAAOvgB,OACV1U,QAAQmG,KAAK8uB,EAAOvgB,OAEhBqgB,GACHA,EAAQE,EAAOvgB,QAGhBjc,EAASyX,EAAM+kB,EAAOh4B,WAIxBg4B,EAAOG,WAAWllB,IAQgC1X,KAAK,kB,SCvC5C68B,EAA0C,SAAAp+B,GAAU,IACzDwB,EAAYxB,EAAZwB,SACAa,EAAKC,cAALD,EAMP,OACC,qBAAK3B,UAAU,eAAf,SACC,4BACC,cAAC,EAAD,CACC29B,OAAO,QACP78B,SATJ,SAAsByX,EAAYxL,GACjCjM,EAASyX,EAAMC,YAAczL,KAS1BxM,YAAY,WAHb,SAKEoB,EAAE,yC,qCCXKi8B,G,OAA4C,SAAAt+B,GAAU,IAC3D6uB,EAAsC7uB,EAAtC6uB,gBAAiB0P,EAAqBv+B,EAArBu+B,SAAUzrB,EAAW9S,EAAX8S,QAD+B,EAEnB/S,WAAwB,IAFL,mBAE1Dy+B,EAF0D,KAEzCC,EAFyC,KAG1Dp8B,EAAKC,cAALD,EAEP,SAASq8B,EAAoB3wB,GAC5B,OAAO8gB,EAAgB7nB,MACtB,SAAAsK,GAAK,OAAIuX,wBAAcvX,KAAWuX,wBAAc9a,MAclD,OACC,sBAAKrN,UAAU,gBAAf,UACC,4BAAI2B,EAAE,uCACN,6BACEyQ,EAAQjQ,KAAI,SAAAkL,GAAK,OACjB,+BACC,cAAC,IAAD,CAEClN,MAAOkN,EAAM5K,KACb3B,SAAU,SAAA6B,GAAQ,OAnBxB,SAAsB0K,EAAc1K,GAElCo7B,EADGp7B,EACgB,SAAAs7B,GAAO,4BAAQA,GAAR,CAAiB5wB,KAExB,SAAA4wB,GAAO,OACzBA,EAAQ1zB,QAAO,SAAAqG,GAAK,OAAIA,EAAM/D,KAAOQ,EAAMR,QAclBqxB,CAAa7wB,EAAO1K,IAC1C1B,MAAO68B,EAAgBt3B,SAAS6G,IAH3BA,EAAMR,IAKXixB,EAAgBt3B,SAAS6G,IAAU2wB,EAAoB3wB,IACvD,sBAAMrN,UAAU,kBAAhB,SACE2B,EAAE,qDAMR,cAAC,IAAD,CACCnC,SAAqC,IAA3Bs+B,EAAgBn4B,OAC1BlG,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,sCACT/B,QAAS,kBAAMi+B,EAASC,WC9CfK,G,OAAsD,SAAA7+B,GAAU,IACrEoC,EAAWpC,EAAXoC,QACAC,EAAKC,cAALD,EAFoE,EAG9B4oB,8BAAtC/H,EAHoE,EAGpEA,SAAmB2L,EAHiD,EAG1D/b,QAH0D,EAInD/S,aAJmD,mBAIpEkZ,EAJoE,KAI9D0b,EAJ8D,OAK7C50B,WAAwB,IALqB,mBAKpE+S,EALoE,KAK3DgsB,EAL2D,KAiB3E,OACC,cAAC,IAAD,2BACK9+B,GADL,IAECU,UAAU,sBACVuB,WAAS,EACTC,YAAaG,EAAE,6BAJhB,SAMC,eAAC,IAAD,WACC,cAAC,EAAD,CAAab,SAlBhB,SAA0ByX,EAAYnG,GACrC6hB,EAAQ1b,GACR6lB,EAAWhsB,MAiBRmG,GAAQnG,EAAQzM,OAAS,GACzB,cAAC,EAAD,CACCwoB,gBAAiBA,EACjB0P,SAjBL,SAAsBzrB,GACrBoQ,EAAShK,wBAAcpG,EAAS+b,IAChCzsB,KAgBI0Q,QAASA,IAGVmG,GAA2B,IAAnBnG,EAAQzM,QAChB,4BAAIhE,EAAE,kD,wJCjCJ,SAAS08B,EACfl1B,EACAiP,GAEA,OAAQjP,EAAOtI,MACd,IAAK,gBACJ,GAAIsI,EAAO7J,MAAMuN,GAChB,MAAO,CACNhM,KAAM,gBACN4Y,UAAWtQ,EAAO7J,MAAMuN,GACxBuM,QAASjQ,EAAOiQ,SAEX,GAAIjQ,EAAO7J,MAAMmD,KAAM,CAsB7B,OAfyD,SACxD+f,EACA0G,GAEA1G,EAAS,CACR3hB,KAAM,gBACN4Y,UAAW+B,0BACV0N,IACA/f,EAAOiQ,QACPjQ,EAAO7J,MAAMmD,MACZoK,GACFuM,QAASjQ,EAAOiQ,WAMlB,MAAM,IAAIxT,MACT,kEAMH,IAAK,iBACJ,GAAIuD,EAAO7J,MAAMgH,MAAK,SAAAg4B,GAAI,OAAKA,EAAKzxB,KAAOyxB,EAAK77B,QAC/C,MAAM,IAAImD,MACT,yFAIF,OAAO,SAAC4c,EAAU0G,GACjB/f,EAAO7J,MAAM6T,SAAQ,SAAA7T,GAChBA,EAAMuN,GACT2V,EAAS,CACR3hB,KAAM,gBACN4Y,UAAWna,EAAMuN,GACjBuM,QAASjQ,EAAOiQ,UAEP9Z,EAAMmD,MAIhB+f,EAAS,CACR3hB,KAAM,gBACN4Y,UAAW+B,0BAAgB0N,IAAY/f,EAAOiQ,QAAS9Z,EAAMmD,MAC3DoK,GACFuM,QAASjQ,EAAOiQ,cAMrB,IAAK,gBACJ,MAAO,CACNvY,KAAM,gBACNvB,MAAOoc,wBAActD,EAAOjP,EAAOiQ,QAASjQ,EAAOsQ,WACnDL,QAASjQ,EAAOiQ,SAGlB,IAAK,iBACJ,MAAO,CACNvY,KAAM,iBACNvB,MAAO6J,EAAOiS,WAAWjZ,KAAI,SAAAsX,GAAS,OACrCiC,wBAActD,EAAOjP,EAAOiQ,QAASK,MAEtCL,QAASjQ,EAAOiQ,SAGlB,IAAK,gBACJ,IAAM7L,EAAUmO,wBAActD,EAAOjP,EAAOiQ,QAASjQ,EAAOsQ,WAS5D,MAAO,CACN5Y,KAAM,gBACNvB,MAVa8G,OAAOC,KAAK8C,EAAO7J,OAAOwL,QACvC,SAACxF,EAAQwqB,GAAT,mBAAC,eACGxqB,GADJ,kBAEEwqB,EAAWviB,EAAQuiB,OAErB,IAMArW,UAAWtQ,EAAOsQ,UAClBL,QAASjQ,EAAOiQ,SAIlB,IAAK,iBACJ,MAAO,CACNvY,KAAM,iBACN2Y,eAAgBpT,OAAOC,KAAK8C,EAAOqQ,gBAAgB1O,QAClD,SAACxF,EAAQmU,GACR,IAAMlM,EAAUmO,wBAActD,EAAOjP,EAAOiQ,QAASK,GAErD,OAAO,2BACHnU,GADJ,kBAEEmU,EAAYrT,OAAOC,KAAK8C,EAAOqQ,eAAeC,IAAY3O,QAC1D,SAACyzB,EAAezO,GAAhB,mBAAC,eACGyO,GADJ,kBAEEzO,EAAWviB,EAAQuiB,OAErB,QAIH,IAED1W,QAASjQ,EAAOiQ,SAGlB,IAAK,cACJ,IAAM/L,EAAQ8L,sBAAYf,EAAOjP,EAAOiQ,SASxC,MAAO,CACNvY,KAAM,cACNvB,MAVa8G,OAAOC,KAAK8C,EAAO7J,OAAOwL,QACvC,SAACxF,EAAQwqB,GAAT,mBAAC,eACGxqB,GADJ,kBAEEwqB,EAAWziB,EAAMyiB,OAEnB,IAMA1W,QAASjQ,EAAOiQ,SAKnB,MAAM,IAAIxT,MAAJ,kDAAoDuD,EAAOtI,KAA3D,MCxJA,SAAS29B,EACfC,EACArmB,GAEA,IAAMtO,EAAkC,GAYxC,OADA20B,GAVuD,SACtDC,GAE6B,oBAAlBA,EACV50B,EAAQsQ,KAAKokB,EAAaE,EAAetmB,IAEzCtO,EAAQsQ,KAAKikB,EAAcK,EAAetmB,OAI5B,kBAAMA,KACf,SAAAoK,GAAQ,OAAI1Y,EAAQqJ,QAAQqP,ICZ7B,IAAMmB,EAGT,SAACvL,EAAOjP,GACX,OAAQA,EAAOtI,MACd,IAAK,YACJ,IAAM89B,EAAyB,CAC9B9K,YAAa1qB,EAAO0qB,YACpBtQ,KAAMpa,EAAOA,OACbqa,KAC0B,oBAAlBra,EAAOA,OACXq1B,EAAar1B,EAAOA,OAAQA,EAAOy1B,cACnCP,EAAcl1B,EAAOA,OAAQA,EAAOy1B,eAKnCC,EAAU,sBACZzmB,EAAM0mB,QAAQrL,MAAM,EAAGrb,EAAM2mB,cAAgB,IADjC,CAEfJ,IAGD,MAAO,CACNG,QAASD,EACTE,cAAeF,EAAWl5B,OAAS,GAGrC,IAAK,gBACJ,OAAO,2BACHyS,GADJ,IAEC2mB,cAAev6B,KAAKw6B,IACnBx6B,KAAKqoB,IAAIzU,EAAM2mB,cAAgB51B,EAAO81B,QAAS,GAC/C7mB,EAAM0mB,QAAQn5B,OAAS,O,OC9Bfu5B,EAAyB7/B,gBACrC,CACCmjB,SAAU,aACVpQ,QAAS,KAIX8sB,EAAuBjb,YAAc,kBAE9B,IAAM8F,EAA4B,kBACxC1qB,aAAiB6/B,IAELC,EAA2C,SAAA7/B,GAAU,IAAD,EACnBirB,8BAA5BiB,EAD+C,EACzDhJ,SAA2BpQ,EAD8B,EAC9BA,QAD8B,EAEtC/S,aAAiBskB,EAAS,CACnDmb,QAAS,GACTC,eAAgB,IAJ+C,mBAEzD3mB,EAFyD,KAElDoK,EAFkD,KAM1D4c,EAA+B//B,eACpC,SAAC8J,EAA8B0qB,GAU9B,OATIA,GACHrR,EAAS,CACR3hB,KAAM,YACNsI,SACA0qB,YAAaA,EACb+K,aAAcxsB,IAIToZ,EAAgBriB,KAExB,CAACiJ,EAASoZ,IAEJ7pB,EAAKC,cAALD,EAEH4hB,OAAiCnjB,EACjCi/B,OAAgCj/B,EAChCojB,OAAiCpjB,EACjCk/B,OAAgCl/B,EAwBpC,OAtBIgY,EAAM0mB,QAAQn5B,OAAS,IACtByS,EAAM2mB,eAAiB,IAC1Bvb,EAAO,WACNgI,EAAgBpT,EAAM0mB,QAAQ1mB,EAAM2mB,eAAevb,MACnDhB,EAAS,CAAC3hB,KAAM,gBAAiBo+B,QAAS,KAE3CK,EAAY39B,EAAE,oBAAqB,CAClCs9B,OAAQt9B,EAAEyW,EAAM0mB,QAAQ1mB,EAAM2mB,eAAelL,gBAI3Czb,EAAM2mB,cAAgB3mB,EAAM0mB,QAAQn5B,OAAS,IAChD4d,EAAO,WACNiI,EAAgBpT,EAAM0mB,QAAQ1mB,EAAM2mB,cAAgB,GAAGxb,MACvDf,EAAS,CAAC3hB,KAAM,gBAAiBo+B,OAAQ,KAE1CI,EAAY19B,EAAE,oBAAqB,CAClCs9B,OAAQt9B,EAAEyW,EAAM0mB,QAAQ1mB,EAAM2mB,cAAgB,GAAGlL,iBAMnD,cAACqL,EAAuB9a,SAAxB,CACCnjB,MAAO,CACNuhB,SAAU4c,EACV7b,OACA8b,YACAjtB,UACAoR,OACA8b,aAPF,SAUEhgC,EAAMkB,a,wJC9EG++B,EAAsD,SAAAjgC,GAAU,IACrEuZ,EAAqCvZ,EAArCuZ,QAAS2mB,EAA4BlgC,EAA5BkgC,eAAmB5uB,EADwC,YAC/BtR,EAD+B,8BAEpEqC,EAAKC,cAALD,EACD89B,EAAiB5mB,EAAQtO,QAC9B,SAAAwD,GAAM,MAAyB,YAArBA,EAAOE,aAOZ/L,EALiBunB,sBACtB5Q,EAAQtO,QACP,SAAAwD,GAAM,MAAyB,WAArBA,EAAOE,WAA0BF,EAAOlB,KAAO2yB,EAAe3yB,OAG3C1K,KAAI,SAAA4L,GAAM,MAAK,CAC7CvO,UAAU,EACVW,MAAM,GAAD,OAAK4N,EAAOtL,KAAZ,YAAoBsL,EAAOU,SAChCxN,MAAO8M,EAAOlB,OAaf,OAV8B,IAA1B4yB,EAAe95B,QAClBzD,EAAQkY,KAAK,CACZ5a,UAAU,EACVW,MAAOwB,EAAE,4CAA6C,CACrD+9B,aAAcD,EAAe95B,SAE9B1E,MAAO,KAIF,cAAC,IAAD,2BAAgB2P,GAAhB,IAAuB1O,QAASA,EAASjB,MAAOu+B,EAAe3yB,O,gBCjCjE8yB,G,OAAgB,IAAIC,KAAKC,eAAe,GAAI,CACjDC,UAAW,OACXC,UAAW,UAOCC,EAAkE,SAAA1gC,GAAU,IACjF+N,EAAS/N,EAAT+N,MACD4yB,EAAQpe,qBAAWxU,GAClB1L,EAAKC,cAALD,EAEP,OACC,sBAAK3B,UAAU,cAAf,UACC,uBAAOA,UAAU,SAAjB,SACC,kCACC,+BACC,6BAAKigC,EAAMje,aACX,6BAAKrgB,EAAE,8CAER,+BACC,6BAAKs+B,EAAMt4B,QACX,6BAAKhG,EAAE,yCAER,+BACC,6BAAKs+B,EAAM58B,WACX,6BAAK1B,EAAE,4CAER,+BACC,6BAAKs+B,EAAMne,MAAMnc,SACjB,6BAAKhE,EAAE,yCAER,+BACC,6BAAKs+B,EAAMle,YAAYpc,SACvB,6BAAKhE,EAAE,oDAIV,sBAAK3B,UAAU,kBAAf,UACC,4BACE2B,EAAE,wCAAyC,CAC3Cu+B,KAAMP,EAAc5xB,OAAOV,EAAMlK,gBAGnC,8BACExB,EAAE,kCAAmC,CAACuB,KAAMmK,EAAMnK,OADpD,OAEC,mBAAG+Y,KAAK,6BAA6B3K,OAAO,SAAS6uB,IAAI,aAAzD,SACEx+B,EAAE,0DCjCIy+B,EAAwD,SAAA9gC,GAAU,IACvE8Z,EAAqB9Z,EAArB8Z,QAAYxI,EAD0D,YACjDtR,EADiD,eAEjDirB,8BAArB/H,EAFsE,EAEtEA,SAAUpQ,EAF4D,EAE5DA,QACVyG,EAAW4O,mCAAX5O,QACDxL,EAAQ8L,sBAAY/G,EAASgH,GAC5BzX,EAAKC,cAALD,EAaP,OACC,eAAC,IAAD,2BACKiP,GADL,IAEC5Q,UAAU,uBACVuB,WAAS,EACTC,YAAa6L,EAAM5K,KAJpB,UAMC,sBAAKzC,UAAU,eAAf,UACC,cAAC,IAAD,CAAcsnB,OAAO,IACrB,cAAC,EAAD,CACCzO,QAASA,EACT/X,SAtBJ,SAA4BwM,GAC3B,IAAMqa,EAAY6B,uBAAa3Q,EAASvL,EAAMgE,OAAOrQ,OAErDuhB,EACCkI,sBAAYtY,EAAS/E,EAAO,CAC3B5J,YAAakkB,EAAUllB,KACvBiB,mBAAoBikB,EAAUlZ,YAiB7B+wB,eAAgB1mB,mCACfD,EACAxL,EAAM5J,YACN4J,EAAM3J,oBANR,SASE/B,EAAE,wBAEJ,mBACCsa,KAAK,oCACL3K,OAAO,SACP6uB,IAAI,aAHL,SAKEx+B,EAAE,oDAGL,cAAC,IAAD,UACC,cAAC,IAAD,CACCxB,MAAOwB,EAAE,mCACTb,SAAU,SAAAG,GAAK,OACduhB,EAASkI,sBAAYtY,EAAS/E,EAAO,CAAC9J,WAAYtC,MAEnDA,MAAOoM,EAAM9J,eAGf,cAAC,IAAD,WACGqN,EAAMtP,WAAa,cAAC,EAAD,CAAyB+L,MAAOA,Y,+JCvEnDgzB,EAAW,CAAC,yBAA0B,sBACtCC,EAAS,CAAC,GAAK,GAAK,EAAG,KAAM,IAAK,GAW3BC,EAAwC,SAAAjhC,GAAU,IAE7DkhC,EAMGlhC,EANHkhC,YACAvqB,EAKG3W,EALH2W,WACAC,EAIG5W,EAJH4W,UACAuqB,EAGGnhC,EAHHmhC,eACAC,EAEGphC,EAFHohC,cACAC,EACGrhC,EADHqhC,WAP4D,EASTthC,YAClDihC,EAAO95B,SAAS0P,IAV2C,mBAStD0qB,EATsD,KASlCC,EATkC,OAYPxhC,YACpDghC,EAAS75B,SAASyP,IAbyC,mBAYtD6qB,EAZsD,KAYjCC,EAZiC,OAerB1hC,WAAe4W,GAfM,mBAetD+qB,EAfsD,KAexCC,EAfwC,OAgBvB5hC,YACxB,IAAZ6W,GAAiBtD,YAjB0C,mBAgBtDsuB,EAhBsD,KAgBzCC,EAhByC,KAmBtDx/B,EAAKC,cAALD,EAwCP,OACC,sBAAK3B,UAAU,cAAf,UACC,cAAC,IAAD,CACCc,SAzCH,SAA4BwM,GACA,WAAvBA,EAAMgE,OAAOrQ,MAChB8/B,GAAuB,IAEvBA,GAAuB,GACvBN,EAAenzB,EAAMgE,OAAOrQ,SAqC3BiB,QAAS,CACR,CACC/B,MAAOwB,EAAE,sCACTV,MAAO,sBAER,CACCd,MAAOwB,EAAE,0CACTV,MAAO,0BAER,CACCd,MAAOwB,EAAE,iBACTV,MAAO,WAGTA,MAAO6/B,EAAsB,SAAW7qB,EAhBzC,SAkBEuqB,IAEDM,GACA,cAAC,IAAD,CACChgC,SA5CJ,SACCwM,GAEA2zB,EAAgB3zB,EAAMgE,OAAOrQ,OAEK,KAA9BqM,EAAMgE,OAAOrQ,MAAMgG,QACtBw5B,EAAenzB,EAAMgE,OAAOrQ,QAuC1BV,YAAY,WACZU,MAAO+/B,EAHR,SAKEr/B,EAAE,8CAGL,cAAC,IAAD,CACCb,SA7DH,SAA2BwM,GACC,WAAvBA,EAAMgE,OAAOrQ,MAChB4/B,GAAsB,IAEtBA,GAAsB,GACtBH,EAAclc,WAAWlX,EAAMgE,OAAOrQ,UAyDrCiB,QAAO,sBACHo+B,EAAOn+B,KAAI,SAAAi/B,GAAK,MAAK,CACvBjhC,MAAOwB,EAAE,mCAAoC,CAC5CqlB,QAAiB,IAARoa,IAEVngC,MAAOmgC,EAAMxuB,gBALR,CAON,CAACzS,MAAOwB,EAAE,iBAAkBV,MAAO,YAEpCA,MAAO2/B,EAAqB,SAAW1qB,EAAUtD,WAXlD,SAaE+tB,IAEDC,GACA,cAAC,IAAD,CACC9/B,SA1DJ,SAAiCwM,GAChC6zB,EAAe7zB,EAAMgE,OAAOrQ,OAE5B,IAAMA,EAAQogC,SAAS/zB,EAAMgE,OAAOrQ,OAEhCmI,OAAOsjB,SAASzrB,IACnBy/B,EAAcz/B,EAAQ,MAqDpBV,YAAY,WACZU,MAAOigC,EAHR,SAKEv/B,EAAE,iD,OC7HK2/B,EAAU,CACtB,CAACC,KAAM,KAAM9+B,KAAM,aACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,qBACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,SACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,WACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,WACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,cACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,SACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,eACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,YACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,iBACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,mBACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,cACnB,CAAC8+B,KAAM,QAAS9+B,KAAM,2BACtB,CAAC8+B,KAAM,QAAS9+B,KAAM,gBACtB,CAAC8+B,KAAM,KAAM9+B,KAAM,8CACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,WACnB,CAAC8+B,KAAM,KAAM9+B,KAAM,gBACnB,CAAC8+B,KAAM,QAAS9+B,KAAM,+BCXV++B,G,OAET,SAAAliC,GAAU,IAAD,EACc0mB,4BAAnBxD,EADK,EACLA,SAAU1K,EADL,EACKA,MACVnW,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,2BACKrC,GADL,IAECU,UAAU,mBACVuB,WAAS,EACTC,YAAaG,EAAE,0BAJhB,SAMC,eAAC,IAAD,WACC,cAAC,IAAD,CACCb,SAAU,SAAAT,GAAC,OAAImiB,EAASyF,kBAAQ,SAAU5nB,EAAEiR,OAAOrQ,SACnDiB,QAASo/B,EAAQn/B,KAAI,SAAAmS,GAAM,MAAK,CAC/BnU,MAAOmU,EAAO7R,KACdxB,MAAOqT,EAAOitB,SAEftgC,MAAO6W,EAAMxD,OANd,SAQE3S,EAAE,+BAEJ,cAAC,IAAD,CACCb,SAAU,SAAAT,GAAC,OAAImiB,EAASyF,kBAAQ,WAAY5nB,EAAEiR,OAAOrQ,SACrDiB,QAAS,CACR,CAAC/B,MAAOwB,EAAE,gCAAiCV,MAAO,UAClD,CAACd,MAAOwB,EAAE,+BAAgCV,MAAO,SACjD,CAACd,MAAOwB,EAAE,8BAA+BV,MAAO,SAEjDA,MAAO6W,EAAMlE,SAPd,SASEjS,EAAE,4BAEJ,cAAC,IAAD,CACCxB,MAAOwB,EAAE,uCACTb,SAAU,SAAAG,GAAK,OAAIuhB,EAASyF,kBAAQ,qBAAsBhnB,KAC1DA,MAAO6W,EAAM7D,qBAEd,mBAAGjU,UAAU,mBAAb,SACE2B,EAAE,sCAEJ,cAAC,EAAD,CACC6+B,YAAa7+B,EAAE,sCACfsU,WAAY6B,EAAMnD,wBAClBuB,UAAW4B,EAAMlD,uBACjB6rB,eAAgB,SAAAx/B,GAAK,OACpBuhB,EAASyF,kBAAQ,0BAA2BhnB,KAE7Cy/B,cAAe,SAAAz/B,GAAK,OACnBuhB,EAASyF,kBAAQ,yBAA0BhnB,KAE5C0/B,WAAYh/B,EAAE,6CAEf,cAAC,EAAD,CACC6+B,YAAa7+B,EAAE,mCACfsU,WAAY6B,EAAMjE,qBAClBqC,UAAW4B,EAAMhE,oBACjB2sB,eAAgB,SAAAx/B,GAAK,OACpBuhB,EAASyF,kBAAQ,uBAAwBhnB,KAE1Cy/B,cAAe,SAAAz/B,GAAK,OACnBuhB,EAASyF,kBAAQ,sBAAuBhnB,KAEzC0/B,WAAYh/B,EAAE,mD,iKCrEN8/B,EAAepiC,gBAAuC,CAClEmjB,SAAU,aACV1K,MAAOnE,gBAGR8tB,EAAaxd,YAAc,QAEpB,IAAM+B,EAAkB,kBAAM3mB,aAAiBoiC,IAEzCC,EAAiC,SAAApiC,GAAU,IAChDwY,EAAS+D,cAAT/D,MACAgF,EAAeH,cAAfG,YACDmV,EAGF5yB,eACH,SAAC+Y,EAAOjP,GACP,IAAMqmB,ECrBsD,SAC9DpX,EACAjP,GAEA,OAAQA,EAAOtI,MACd,IAAK,OACJ,OAAO,2BAAIuX,GAAUjP,EAAOiP,OAE7B,IAAK,SACJ,IAAI0mB,EAA+B14B,OAAOqqB,QAAQ9c,eAAY7I,QAC7D,SAACxF,EAAD,GAA2B,IAAD,mBAAhBiB,EAAgB,KAAXtF,EAAW,KACnB0gC,EAAUp7B,EAEhB,MACmB,kBAAVtF,IAAuBmI,OAAOsjB,SAAStU,EAAMupB,YAC9C1gC,WAAiBmX,EAAMupB,IAE9Bt5B,QAAQqG,KACP,gCAAyBnI,EAAzB,8BAAkDtF,EAAlD,oBACQmX,EAAMupB,GADd,gBAGM,2BAAIr8B,GAAX,kBAAoBq8B,EAAU1gC,KAGxBqE,IAER,IAED,OAAO,2BAAI8S,GAAU0mB,GAEtB,IAAK,SACJ,OAAO,2BAAI1mB,GAAX,kBAAmBjP,EAAO1G,KAAO0G,EAAOlI,SDVvB0iB,CAAQvL,EAAOjP,GAEhC,IACC2O,EAAMK,eAAeqX,EAAUrmB,GAC9B,MAAO4T,GACRD,EAAYC,EAAO,iCAGpB,OAAOyS,IAER,CAAC1X,EAAOgF,IAlB6C,EAqB5Bzd,aAAiB4yB,EAAkBte,eArBP,mBAqB/CyE,EArB+C,KAqBxCoK,EArBwC,KAuBtD,OACC,cAACif,EAAard,SAAd,CACCnjB,MAAO,CACNuhB,WACA1K,MAAOM,GAHT,SAME9Y,EAAMkB,a,kMEhCJohC,EAAiCllB,cAAWva,KAAI,SAAA4lB,GAAC,kCACnDA,GADmD,IAEtDlb,GAAI8M,MACJ1L,UAAW,WACXtL,UAAU,EACViX,WAAW,OAGCioB,EAAsBxiC,gBAClC,CACCmjB,SAAU,aACV3J,QAAS,KAIXgpB,EAAoB5d,YAAc,eAE3B,IAAMwD,EAAyB,kBACrCpoB,aAAiBwiC,IAELC,EAAwC,SAAAxiC,GAAU,IACvDoa,EAAgBmC,cAAhBnC,aACAoD,EAAeH,cAAfG,YACDmV,EAGF5yB,eACH,SAAC+Y,EAAOjP,GACP,IAAMqmB,EClCoE,SAC5EpX,EACAjP,GAEA,OAAQA,EAAOtI,MACd,IAAK,OACJ,OAAO,YAAIsI,EAAOiP,OAEnB,IAAK,SACJ,IAAM2pB,EAAiBrlB,cAIjBpX,EAAS8S,EAAM7N,QAAO,SAAAwD,GAC3B,IAAMi0B,EACLj0B,EAAO6L,WACPmoB,EAAez7B,MACd,SAAAyhB,GAAC,OAAIA,EAAEtlB,OAASsL,EAAOtL,MAAQslB,EAAEtZ,UAAYV,EAAOU,WAUtD,OAPKuzB,GACJ35B,QAAQqG,KACP,8CAAuCX,EAAOtL,KAA9C,YAAsDsL,EAAOU,QAA7D,8CAKKuzB,KAyBR,OApBAD,EAAe5uB,SAAQ,SAAA8uB,GAEpB38B,EAAOgB,MACP,SAAAyhB,GAAC,OACAA,EAAEtlB,OAASw/B,EAAcx/B,MACzBslB,EAAEtZ,UAAYwzB,EAAcxzB,aAG9BpG,QAAQqG,KAAR,qDAC+CuzB,EAAcx/B,KAD7D,YACqEw/B,EAAcxzB,UAEnFnJ,EAAO8U,KAAP,2BACI6nB,GADJ,IAECp1B,GAAI8M,MACJ1L,UAAW,WACXtL,UAAU,EACViX,WAAW,SAIPtU,EAER,IAAK,SACJ,OACC8S,EAAM9R,MACL,SAAAyH,GAAM,OACLA,EAAOtL,OAAS0G,EAAO7J,MAAMmD,MAC7BsL,EAAOU,UAAYtF,EAAO7J,MAAMmP,WAG3B2J,EAGF,GAAN,mBAAWA,GAAX,4BAAsBjP,EAAO7J,OAA7B,IAAoCuN,GAAI8M,MAAQ1L,UAAW,eAE5D,IAAK,SACJ,OAAOmK,EAAM7N,QAAO,SAAAwd,GAAC,OAAIA,EAAElb,KAAO1D,EAAO0D,MAE1C,IAAK,SACJ,OACCuL,EAAM9R,MACL,SAAAyH,GAAM,OACLA,EAAOlB,KAAO1D,EAAO0D,IACrBkB,EAAOtL,OAAS0G,EAAO7J,MAAMmD,MAC7BsL,EAAOU,UAAYtF,EAAO7J,MAAMmP,WAG3B2J,EAGDA,EAAMjW,KAAI,SAAA4L,GAChB,OAAIA,EAAOlB,KAAO1D,EAAO0D,GACjBkB,EAGD,2BAAIA,GAAW5E,EAAO7J,UAIhC,OAAO8Y,EDzDYuL,CAAQvL,EAAOjP,GAEhC,IACCuQ,EAAavB,eAAeqX,EAAUrmB,GACrC,MAAO4T,GACRD,EAAYC,EAAO,wCAEpB,OAAOyS,IAER,CAAC1S,EAAapD,IAjB8C,EAoBnCyK,IAAgB8N,EAAkB2P,GApBC,mBAoBtDxpB,EApBsD,KAoB/CoK,EApB+C,KAsB7D,OACC,cAACqf,EAAoBzd,SAArB,CACCnjB,MAAO,CACNuhB,WACA3J,QAAST,GAHX,SAME9Y,EAAMkB,a,yJEpDG0hC,EAAmD,SAAA5iC,GAAU,IAClEqC,EAAKC,cAALD,EACD+M,EAAO6B,cAEb,OACC,cAAC,IAAD,2BACKjR,GADL,IAECU,UAAU,qBACVuB,WAAS,EACTC,YAAaG,EAAE,2BAA4B,CAC1C8M,QAASC,EAAKD,UALhB,SAQC,sBAAKzO,UAAU,UAAf,UACC,4BAAI2B,EAAE,yCACN,mBACCwgC,wBAAyB,CACxBC,OAAQzgC,EAAE,iCAGZ,sBAAK3B,UAAU,UAAf,UACC,sBAAKA,UAAU,OAAf,UACC,6BAAK2B,EAAE,mCACP,6BACE0gC,EAAQd,KAAKp/B,KAAI,SAAAmgC,GAAC,OAClB,6BAAaA,GAAJA,WAIZ,sBAAKtiC,UAAU,gBAAf,UACC,6BAAK2B,EAAE,2CACP,6BACE0gC,EAAQE,cAAcpgC,KAAI,SAAAmgC,GAAC,OAC3B,6BAAaA,GAAJA,cAKb,eAAC,IAAD,WACC,cAAC,IAAD,CACCrmB,KAAK,6BACLxc,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,oCACT7B,QAAQ,YAET,cAAC,IAAD,CACCmc,KAAK,qCACLxc,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,4C,25CCnDF6gC,EAAb,kDAIC,WAAYljC,GAAY,IAAD,8BACtB,cAAMA,IACD8Y,MAAQ,CAAC2E,MAAO,MAFC,EAJxB,0CAeC,WACC,OAAI0lB,KAAKrqB,MAAM2E,MACP,oDAAuB0lB,KAAKrqB,MAAM2E,MAAMrF,WAGzC+qB,KAAKnjC,MAAMkB,YApBpB,uCASC,SAAuCuc,GAGtC,OADA1U,QAAQ0U,MAAMA,GACP,CAACA,aAZV,GAAyC1d,a,QCJ5BqjC,G,OAA2B,kBACvC,qBAAK1iC,UAAU,kBAAf,SACC,cAAC,IAAD,Q,eCCW2iC,EAA2B,WAAO,IACvC7qB,EAASkO,4BAATlO,MAMP,OAJAzY,aAAgB,WACfqD,IAAKkgC,eAAe9qB,EAAMxD,UACxB,CAACwD,EAAMxD,SAEH,M,gCCNKuuB,G,OAAsD,SAAAvjC,GAAU,IACrEkB,EAAyClB,EAAzCkB,SAAUsiC,EAA+BxjC,EAA/BwjC,eAAgBC,EAAezjC,EAAfyjC,YAWjC,OAAO,qBAAKnjC,QAViC,SAAA0N,GACvB,IAAD,EAAhBw1B,GACC,UAAEx1B,EAAMgE,cAAR,aAAC,EAA+B0xB,QAAQF,KAC3CC,IAGDA,KAIK,SAA4BviC,MCbvByiC,G,OAAsC,SAAA3jC,GAAU,IAAD,EACrDS,EAA6B,CAClCmjC,oBACC,gBAAiB5jC,EAAjB,2BAEgC,kBAAtBA,EAAM6jC,YACV7jC,EAAM6jC,YAAc,KACpB7jC,EAAM6jC,YAJZ,sBAMa7jC,EAAM8jC,QANnB,UAOD7P,SAAQ,UAAEj0B,EAAMi0B,gBAAR,QAAoB,QAG7B,OACC,qBAAKvzB,UAAU,aAAaD,MAAOA,EAAnC,SACET,EAAMkB,a,yBCVG6iC,G,OAAchkC,cAC1B,SAACC,EAAOC,GAAS,IAAD,EACRiB,EAAmBlB,EAAnBkB,SAAUkjB,EAASpkB,EAATokB,MACX1jB,EAAYC,IAAW,eAAgB,CAC5CqjC,OAAM,UAAEhkC,EAAMgkC,cAAR,WAGP,OACC,sBAAKtjC,UAAWA,EAAWT,IAAKA,EAAhC,UACEmkB,GACA,qCACC,cAAC6f,EAAA,EAAD,UACC,gCAAQ7f,MAET,6BAAKA,OAGNljB,S,eCtBQgjC,G,OAA8B,SAAC,GAAD,IAAErjC,EAAF,EAAEA,MAAF,OAC1C,sBAAMH,UAAU,QAAhB,SAAyBG,M,QCAbsjC,EAAgE,SAAC,GAEvE,IADN11B,EACK,EADLA,OAEOpM,EAAKC,cAALD,EAEP,MAAyB,aAArBoM,EAAOE,WAAiD,YAArBF,EAAOE,UAE5C,qBAAKjO,UAAU,4BAAf,SACC,4BAAI2B,EAAE,gDAKgB,UAArBoM,EAAOE,UAET,qBAAKjO,UAAU,4BAAf,SACC,4BACE2B,EAAE,uCAAwC,CAC1C+hC,aAAc31B,EAAO6N,UAAUlE,cAQnC,sBAAK1X,UAAU,4BAAf,UACE+N,EAAOG,WAAWy1B,QAClB,mBACC3jC,UAAU,2BACVmiC,wBAAyB,CACxBC,OAAQzgC,EAAE,oCAAqC,CAC9CgiC,OAAQ51B,EAAOG,WAAWy1B,YAK7B51B,EAAOG,WAAW2lB,aAClB,qBACC7zB,UAAU,gCACVmiC,wBAAyB,CACxBC,OAAQr0B,EAAOG,WAAW2lB,eAI5B9lB,EAAOG,WAAW01B,SAClB,mBAAG5jC,UAAU,4BAAb,SACE2B,EAAE,qCAAsC,CACxCiiC,QAAS71B,EAAOG,WAAW01B,gBCvCpBC,G,OAAkD,SAAAvkC,GAAU,IACjE8wB,EAA6D9wB,EAA7D8wB,cAAe0T,EAA8CxkC,EAA9CwkC,yBAA0B/1B,EAAoBzO,EAApByO,OAAQ6rB,EAAYt6B,EAAZs6B,SACjDj4B,EAAKC,cAALD,EAEH2nB,EAAQ,6BAaZ,MAXyB,UAArBvb,EAAOE,UACVqb,EAAQ,cAAC,IAAD,IAEa,aAArBvb,EAAOE,WACc,YAArBF,EAAOE,UAEPqb,EAAQ,cAAC,IAAD,IACuB,WAArBvb,EAAOE,WAA0BF,EAAOG,WAAWob,QAC7DA,EAAQ,qBAAK6J,IAAK9J,yBAAetb,GAASmtB,IAAI,MAI9C,qBAAKl7B,UAAU,oBAAoBJ,QAASg6B,EAA5C,SACC,cAAC,IAAD,CAAMj3B,SAAUoL,EAAOpL,SAAvB,SACC,eAAC,IAAD,WACC,qBAAK3C,UAAU,qBAAf,SAAqCspB,IACrC,sBAAKtpB,UAAU,2BAAf,UACC,6BACE2B,EAAE,kCAAmC,CACrCc,KAAMsL,EAAOtL,KACbgM,QAASV,EAAOU,YAGlB,cAAC,EAAD,CAAwBV,OAAQA,OAEjC,sBAAK/N,UAAU,sBAAf,WACG+N,EAAO6L,WACR,cAAC,EAAD,CAAOzZ,MAAOwB,EAAE,wCAEhByuB,GACA,cAAC,EAAD,CAAOjwB,MAAOwB,EAAE,8CAEhBmiC,GACA,cAAC,EAAD,CACC3jC,MAAOwB,EAAE,yDAGW,WAArBoM,EAAOE,WAA0BF,EAAOG,WAAW61B,UACnD,cAAC,EAAD,CAAO5jC,MAAOwB,EAAE,qD,+CCvDVqiC,EAAuB,WACnC,IAAM3gB,EAAU4gB,cACTtiC,EAAKC,cAALD,EAEP,MAAI,CAAC,IAAK,YAAY6E,SAAS6c,EAAQ6gB,SAASC,UACxC,KAIP,cAAC,IAAD,CACC1kC,KAAM,cAAC,IAAD,IACNK,QAAQ,UACRK,MACCkjB,EAAQ1d,OAAS,EACdhE,EAAE,eACFA,EAAE,iCAEN/B,QAAS,kBACRyjB,EAAQ1d,OAAS,EAAI0d,EAAQ+gB,SAAW/gB,EAAQjJ,KAAK,SCV5CiqB,G,OAA4C,SAAA/kC,GAAU,IAAD,EACMA,EAAhEglC,eAD0D,MAChD,6BADgD,EAClBC,EAAwBjlC,EAAxBilC,eAAgBC,EAAQllC,EAARklC,KACxD7iC,EAAKC,cAALD,EAEP,OACC,qBAAK3B,UAAU,gBAAf,SACC,eAAC,IAAD,CAAMykC,qBAAqB,WAA3B,UACC,sBAAKzkC,UAAU,oBAAf,UACC,cAAC,EAAD,IACA,cAAC,IAAD,CAASA,UAAU,wBAAnB,SACEoG,OAAOC,KAAKm+B,GAAMriC,KAAI,SAAAuiC,GAAO,OAC7B,cAAC,IAAD,CAAK1kC,UAAU,oBAAf,SACE0kC,GADsCA,QAK1C,sBAAK1kC,UAAU,gCAAf,UACEukC,EACD,cAAC,IAAD,CACC9kC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,eACT/B,QAAS,kBAAM+N,OAAOgD,KAAK2zB,EAAS,mBAIvC,8BACEl+B,OAAOqqB,QAAQ+T,GAAMriC,KAAI,mCAAEuiC,EAAF,KAAWC,EAAX,YACzB,cAAC,IAAD,UAAyBA,GAAVD,e,gECVd,SAASE,IAAoC,IAI5C9sB,EAASkO,4BAATlO,MAJ4C,EAKD2P,mCAAjCod,EALkC,EAK5CriB,SAAgC3J,EALY,EAKZA,QAChCzG,EAAWmY,8BAAXnY,QAEP,MAAO,CACND,eAAgB9S,cAAA,sBACf,sBAAA2L,EAAA,+EAAYmH,YAAeC,EAAS7B,gBAApC,2CACA,CAAC6B,IAEF0yB,WAAYzlC,cAAA,uCACX,WAAM+Z,GAAN,mBAAApO,EAAA,6DACOqC,EAAQ8L,sBAAY/G,EAASgH,GAC7BrL,EAAS+K,mCACdD,EACAf,EAAMjD,eAAepS,KACrBqV,EAAMjD,eAAepG,SALvB,SAOgCsa,+BAAqBhb,EAArBgb,CAC9B8b,GARF,UAOOE,EAPP,6BAYQ,IAAIn/B,MAAJ,yCAZR,gCAeQ2N,YACNlG,EACA03B,EAAiBhsB,OACjBxI,gBAlBF,2CADW,sDAsBX,CACCsI,EACAf,EAAMjD,eAAepS,KACrBqV,EAAMjD,eAAepG,QACrB2D,EACAyyB,IAGFtyB,aAAclT,cAAA,uCACb,WAAO+Z,EAAS4rB,GAAhB,mBAAAh6B,EAAA,6DACOqC,EAAQ8L,sBAAY/G,EAASgH,GAC7BrL,EAAS+K,mCACdD,EACAxL,EAAM5J,YACN4J,EAAM3J,oBALR,SAOgCqlB,+BAAqBhb,EAArBgb,CAC9B8b,GARF,UAOOE,EAPP,6BAYQ,IAAIn/B,MAAJ,yCAZR,gCAeQ2N,YACNlG,EACA03B,EAAiBhsB,OACjBxI,cACAy0B,IAnBF,2CADa,wDAuBb,CAACnsB,EAASzG,EAASyyB,IAEpBI,iBAAkB5lC,eACjB,SAAC+Z,GACA,IAAM/L,EAAQ8L,sBAAY/G,EAASgH,GAEnC,OAAO7G,YAAalF,EAAOkD,cAAc,CAACiC,eAAe,MAE1D,CAACJ,K,YC3FG,SAAS8yB,IAAuC,IAAD,EAClBN,IAA5BE,EAD8C,EAC9CA,WAAYvyB,EADkC,EAClCA,aAEnB,GAAI7E,cAAsB,CAAC,IACnBiK,EAAiBhK,OAAjBgK,cAEP,IAAKA,EACJ,MAAM,IAAI/R,MAAM,6CAGjB,MAAO,CACNu/B,UAAU,WAAD,4BAAE,WAAM/rB,GAAN,SAAApO,EAAA,kEACV2M,EAAcM,YADJ,SAGH1F,EAAa6G,GAHV,wBACgBlB,KADhB,UAET,sBAFS,KAIT,SAJS,2CAAF,mDAAC,GAOV4sB,WAAW,WAAD,4BAAE,WAAM1rB,GAAN,SAAApO,EAAA,kEACX2M,EAAcM,YADH,SAGJ6sB,EAAW1rB,GAHP,wBACelB,KADf,UAEV,sBAFU,KAIV,SAJU,2CAAF,mDAAC,GAOXktB,UAAU,WAAD,4BAAE,WAAOhsB,EAASoM,GAAhB,SAAAxa,EAAA,kEACV2M,EAAcM,YADJ,SAGH1F,EAAa6G,EAAS,CAC3BrG,cAAe,QACfC,QAASwS,IALD,wBACgBtN,KADhB,UAET,sBAFS,KAOT,SAPS,2CAAF,qDAAC,IAaZ,MAAO,CACNitB,UAAU,WAAD,4BAAE,WAAM/rB,GAAN,SAAApO,EAAA,sDACV2C,OAAOgD,KAAP,oBAAyByI,EAAzB,SAAyC,UAD/B,2CAAF,mDAAC,GAGV0rB,WAAW,WAAD,4BAAE,WAAM1rB,GAAN,SAAApO,EAAA,sDACX2C,OAAOgD,KAAP,oBAAyByI,EAAzB,UAA0C,UAD/B,2CAAF,mDAAC,GAGXgsB,UAAU,WAAD,4BAAE,WAAOhsB,EAASoM,GAAhB,SAAAxa,EAAA,sDACV2C,OAAOgD,KACN6U,EAAc,oBACEpM,EADF,iBACkBoM,GADlB,oBAEEpM,EAFF,SAGd,UALS,2CAAF,qDAAC,I,aCtDL,SAASisB,EAAStsB,EAAgBf,GACxC,IAAMjL,EAAO,IAAIu4B,KAAK,CAACvsB,GAAS,CAAClY,KAAM,4BAEvC0kC,iBAAOx4B,EAAMiL,G,YC2BDwtB,GAA4C,SAAC,GAAa,IAAZn4B,EAAW,EAAXA,MACnDkF,EAAgBqyB,IAAhBryB,aAD8D,EAE1B2yB,IAAzBJ,GAFmD,EAE9DK,UAF8D,EAEnDL,YACXnjC,GAH8D,EAEvCyjC,UAClBxjC,cAALD,GAH8D,4CAKrE,sBAAAqJ,EAAA,yDACMqC,EADN,sBAEQ,IAAIzH,MAAM,gCAFlB,mBAKCy/B,EALD,SAKgB9yB,EAAalF,EAAMR,IALnC,wBAKwCsb,wBAAc9a,IALtD,+DALqE,sBA0BrE,OACC,eAAC,IAAD,WAaC,cAAC,IAAD,CACC7N,UAAW6N,EACX5N,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,4BACT/B,QAASyN,EAAQ,kBAAMy3B,EAAU,OAACz3B,QAAD,IAACA,OAAD,EAACA,EAAOR,KAAM,eAEhD,cAAC,IAAD,CACCrN,UAAW6N,EACX5N,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,oCACT/B,QAlDkE,6CAoDnE,cAAC,IAAD,CACCJ,UAAW6N,EACX5N,KAAM,cAAC,IAAD,IACNU,MAAO,uBACPP,QAAS,kBA1EM,SAACyN,GAGnB,IAAMo4B,EAAOr4B,YAAiBC,GAHM,GAIXA,GAAS,IAA3B5K,YAJ6B,MAIxB,UAJwB,EAS3BijC,EAAU,uCAAmCC,mBACjDz9B,KAAKmB,UAAUo8B,EAAK,KAAK,KAErB/mB,EAAOlN,SAAS0T,cAAc,KACpCxG,EAAKzC,KAAOypB,EACZhnB,EAAKknB,SAAL,UAAmBnjC,EAAnB,SACAic,EAAKmnB,QA2DQC,CAAWz4B,UCnFf04B,GAAuB,WAAO,IACnCvjB,EAAYD,8BAAZC,SACDa,EAAU4gB,cACTtiC,EAAKC,cAALD,EAEP,OACC,eAAC,IAAD,WACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,gCACT/B,QAAS,kBAAM4iB,EAAS,CAAC3hB,KAAM,YAAa+hB,UAAW4e,sBAExD,cAAC,IAAD,CACChiC,SAAwC,mBAA9B6jB,EAAQ6gB,SAASC,SAC3B1kC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iCACT/B,QAAS,kBAAMyjB,EAAQjJ,KAAK,qBAE7B,cAAC,IAAD,CACC3a,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,6BACT/B,QAAS,kBACR4iB,EAAS,CAAC3hB,KAAM,YAAa+hB,UAAWsf,wBAG1C,cAAC,IAAD,CACCziC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,8BACT/B,QAAS,kBAAM+N,OAAOgD,KAAK,4BAA6B,iB,yBCtB5D,SAASq1B,GAAW/kC,GACnB,IAEC,OADA,IAAIwH,IAAIxH,IACD,EACN,MAAOZ,IAET,OAAO,EAGD,IAAM4lC,GAAiC,WAAO,IAAD,EACvBxe,mCAArBjF,EAD4C,EAC5CA,SAAU3J,EADkC,EAClCA,QADkC,EAEXxZ,WAAe,IAFJ,mBAE5C6mC,EAF4C,KAE9BC,EAF8B,KAG5CxkC,EAAKC,cAALD,EAH4C,4CAKnD,sBAAAqJ,EAAA,kEACCwX,EADD,KAEE4F,uBAFF,KAGG8d,EAHH,SAISltB,aAA2BktB,GAJpC,uGALmD,sBAcnD,IAAM7uB,EAA+B,uCAAG,WAAOpW,GAAP,eAAA+J,EAAA,yDACX,KAAxBk7B,EAAaj/B,OADsB,yCAE/B,CAACuQ,OAAO,IAFuB,UAKlCwuB,GAAWE,GALuB,yCAM/B,CACNxuB,QAAS/V,EACR,kEAED6V,OAAO,IAV8B,gCAebwB,aAA2BktB,GAfd,UAehCh4B,EAfgC,QAkBrC2K,EAAQvS,MACP,SAAAyH,GAAM,OACLA,EAAOtL,OAASyL,EAAWzL,MAC3BsL,EAAOU,UAAYP,EAAWO,WArBK,0CAwB9B,CACNiJ,QAAS/V,EACR,mEACA,CACCykC,gBAAiBl4B,EAAWzL,KAC5BiB,mBAAoBwK,EAAWO,UAGjC+I,OAAO,IAhC6B,iCAoC/B,CACNE,QAAS/V,EACR,iEACA,CACCykC,gBAAiBl4B,EAAWzL,KAC5BiB,mBAAoBwK,EAAWO,UAGjC+I,OAAO,IA5C8B,2DA+C/B,CACNE,QAAS/V,EACR,iEACA,CACC+hC,aAAc,KAAMhsB,UAGtBF,OAAO,IAtD8B,0DAAH,sDA2DrC,OACC,sBAAMxX,UAAU,oBAAhB,SACC,cAAC,KAAD,CACCP,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,cACTb,SAAU,SAAAwM,GAAK,OAAI64B,EAAgB74B,EAAMgE,OAAOrQ,QAChD+V,SA/EgD,2CAgFhDC,OAAQtV,EAAE,8DACVuV,WAAY,cAAC,IAAD,IACZC,YAAaxV,EAAE,cACfyV,cAAc,SACdC,SAAUA,EACVpW,MAAOilC,OCjGEG,GAAoE,SAAA/mC,GAAU,IACnFyO,EAAUzO,EAAVyO,OADkF,EAE/DiY,4BAAnBxD,EAFkF,EAElFA,SAAU1K,EAFwE,EAExEA,MACVnW,EAAKC,cAALD,EAEDnC,EACiB,YAAhB,OAANuO,QAAM,IAANA,OAAA,EAAAA,EAAQE,YACRF,EAAOG,WAAW61B,UACjBjsB,EAAMrU,YAAYhB,OAASsL,EAAOtL,MAClCqV,EAAMrU,YAAYgL,UAAYV,EAAOU,QAavC,OACC,cAAC,IAAD,CACCjP,SAAUA,EACVC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,qDACT/B,QAjB2C,WAC5C,IAAKmO,EACJ,MAAM,IAAInI,MAAM,yCAGjB4c,EAAS,CACR3hB,KAAM,SACN4B,KAAM,cACNxB,MAAO,CAACwB,KAAMsL,EAAOtL,KAAMgM,QAASV,EAAOU,eClBjC63B,GAAsE,SAAAhnC,GAAU,IACrFyO,EAAUzO,EAAVyO,OADoF,EAEjEiY,4BAAnBxD,EAFoF,EAEpFA,SAAU1K,EAF0E,EAE1EA,MACVnW,EAAKC,cAALD,EAEDnC,EACiB,YAAhB,OAANuO,QAAM,IAANA,OAAA,EAAAA,EAAQE,aACPF,EAAOG,WAAW61B,UAClBjsB,EAAMjD,eAAepS,OAASsL,EAAOtL,MACrCqV,EAAMjD,eAAepG,UAAYV,EAAOU,QAa1C,OACC,cAAC,IAAD,CACCjP,SAAUA,EACVC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,sDACT/B,QAjB2C,WAC5C,IAAKmO,EACJ,MAAM,IAAInI,MAAM,0CAGjB4c,EAAS,CACR3hB,KAAM,SACN4B,KAAM,iBACNxB,MAAO,CAACwB,KAAMsL,EAAOtL,KAAMgM,QAASV,EAAOU,eCdjC83B,GAAkE,SAAAjnC,GAAU,IACjFyO,EAAUzO,EAAVyO,OACAyU,EAAYiF,mCAAZjF,SACA1K,EAASkO,4BAATlO,MACAnW,EAAKC,cAALD,EAED6kC,GACC,OAANz4B,QAAM,IAANA,OAAA,EAAAA,EAAQtL,QAASqV,EAAMrU,YAAYhB,OAC7B,OAANsL,QAAM,IAANA,OAAA,EAAAA,EAAQU,WAAYqJ,EAAMrU,YAAYgL,QACjCg4B,GACC,OAAN14B,QAAM,IAANA,OAAA,EAAAA,EAAQtL,QAASqV,EAAMjD,eAAepS,OAChC,OAANsL,QAAM,IAANA,OAAA,EAAAA,EAAQU,WAAYqJ,EAAMjD,eAAepG,QAE1C,OACC,cAAC,IAAD,CACCjP,UAAWuO,IAAWA,EAAO6L,WAAa4sB,GAAaC,EACvDhnC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACT/B,QAAS,kBAAMmO,GAAUyU,EAAS6F,uBAAata,Q,QCtBrC24B,GAA0E,SAAApnC,GAAU,IACzFyO,EAAUzO,EAAVyO,OADwF,EAErEiY,4BAAnBxD,EAFwF,EAExFA,SAAU1K,EAF8E,EAE9EA,MACVnW,EAAKC,cAALD,EAED04B,EAAqBviB,EAAM/D,oCAAoCzN,MACpE,SAAAsK,GAAK,OAAIA,EAAMnO,QAAN,OAAesL,QAAf,IAAeA,OAAf,EAAeA,EAAQtL,OAAQmO,EAAMnC,WAAN,OAAkBV,QAAlB,IAAkBA,OAAlB,EAAkBA,EAAQU,YA8BnE,OACC,cAAC,IAAD,CACCjP,UAAWuO,EACXtO,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,kCAAD,OAEN04B,EAAqB,SAAW,UAF1B,qBAKRz6B,QApCF,WACC,IAAKmO,EACJ,MAAM,IAAInI,MAAM,qBAOhB4c,EADG6X,EAEFpS,kBACC,sCACAnQ,EAAM/D,oCAAoCxJ,QACzC,SAAAwd,GAAC,OAAIA,EAAEtlB,OAASsL,EAAOtL,MAAQslB,EAAEtZ,UAAYV,EAAOU,YAMtDwZ,kBAAQ,sCAAD,uBACHnQ,EAAM/D,qCADH,CAEN,CAACtR,KAAMsL,EAAOtL,KAAMgM,QAASV,EAAOU,iBC5B5Bk4B,GAA8C,SAAArnC,GAAU,IAC7DsnC,EAAmBtnC,EAAnBsnC,gBACD74B,EAAoC,IAA3B64B,EAAgBjhC,OAAeihC,EAAgB,QAAKxmC,EAEnE,OACC,eAAC,IAAD,WACC,cAAC,GAAD,IACA,cAAC,GAAD,CAAyB2N,OAAQA,IACjC,cAAC,GAAD,CAA6BA,OAAQA,IACrC,cAAC,GAAD,CAA0BA,OAAQA,IAClC,cAAC,GAAD,CAA2BA,OAAQA,Q,SClBzB84B,GAAwB,WAAO,IAAD,EAChB7gB,4BAAnBxD,EADmC,EACnCA,SAAU1K,EADyB,EACzBA,MACVnW,EAAKC,cAALD,EAEP,SAASmlC,EAAUrkC,GAClB+f,EAASyF,kBAAQ,wBAAyBxlB,IAG3C,OACC,qCACC,cAAC,KAAD,CACCjD,SAA0C,YAAhCsY,EAAMhD,sBAChB3U,MAAOwB,EAAE,wCACTb,SAAU,kBAAMgmC,EAAU,YAC1B7lC,MAAuC,YAAhC6W,EAAMhD,wBAEd,cAAC,KAAD,CACCtV,SAA0C,SAAhCsY,EAAMhD,sBAChB3U,MAAOwB,EAAE,qCACTb,SAAU,kBAAMgmC,EAAU,SAC1B7lC,MAAuC,SAAhC6W,EAAMhD,wBAEd,cAAC,KAAD,CACCtV,SAA0C,QAAhCsY,EAAMhD,sBAChB3U,MAAOwB,EAAE,oCACTb,SAAU,kBAAMgmC,EAAU,QAC1B7lC,MAAuC,QAAhC6W,EAAMhD,4BCnBJiyB,GAAgE,SAAAznC,GAAU,IAAD,EAC9EsnC,EAAmBtnC,EAAnBsnC,gBACAjlC,EAAKC,cAALD,EAEP,OACC,cAAC,EAAD,CACC6iC,MAAI,mBACF7iC,EAAE,sBACF,cAAC,GAAD,CAAeilC,gBAAiBA,KAF9B,cAIFjlC,EAAE,eAAiB,cAAC,GAAD,KAJjB,cAKFA,EAAE,kBAAoB,cAAC,GAAD,KALpB,MCEMqlC,GAAiC,WAAO,IAAD,EACNvf,mCAA5Bwf,EADkC,EAC5CzkB,SAA2B3J,EADiB,EACjBA,QADiB,EAEVmN,4BAAxByF,EAFkC,EAE5CjJ,SAAyB1K,EAFmB,EAEnBA,MACzBnW,EAAKC,cAALD,EAEDilC,EAAkB/tB,EAAQtO,QAAO,SAAAwD,GAAM,OAAIA,EAAOpL,YAElDukC,EAAiBzd,sBACtBN,0BAAgBtQ,EAASf,EAAMhD,wBAiBhC,OAZAzV,aAAgB,WAAO,IAAD,gBACAunC,GADA,IACrB,2BAAsC,CAAC,IAA5B74B,EAA2B,QACjCA,EAAOpL,WAAaukC,EAAe1gC,SAASuH,IAC/Ck5B,EAAgBze,yBAAeza,KAHZ,iCAMnB,CAAC0d,EAAemb,EAAiBM,EAAgBD,IAOnD,qBAAKjnC,UAAU,0BAAf,SACC,eAAC,yBAAD,WACC,cAAC,GAAD,CAAwB4mC,gBAAiBA,IACzC,cAAC,EAAD,CACC9D,eAAe,qBACfC,YAAa,kBAAMkE,EAAgB3e,iCAFpC,SAIC,eAAC+a,EAAD,CACC3f,MAAO/hB,EAAE,gCAAD,OACyBmW,EAAMhD,wBAFxC,UAKC,4BACEnT,EACAulC,EAAevhC,OAAS,EACrB,gDACA,wCAGL,cAAC,IAAD,UACC,cAAC,EAAD,CAAWw9B,YAAY,QAAvB,SACE+D,EAAe/kC,KAAI,SAAA4L,GAAM,OACzB,cAAC,EAAD,CACCqiB,cACCriB,EAAOtL,OAASqV,EAAMrU,YAAYhB,MAClCsL,EAAOU,UAAYqJ,EAAMrU,YAAYgL,QAEtCq1B,yBAA0BhsB,EAAM/D,oCAAoCzN,MACnE,SAAA6gC,GAAc,OACbp5B,EAAOtL,OAAS0kC,EAAe1kC,MAC/BsL,EAAOU,UAAY04B,EAAe14B,WAEpCV,OAAQA,EAER6rB,SAAU,kBAvCnB,SAAsB7rB,GACrBk5B,EAAgBje,uBAAajb,GAAQ,IAsCbq5B,CAAar5B,KADxBA,EAAOlB,sB,iCCzEtB,SAASw6B,GACR/5B,EACAg6B,GAEA,IAAMC,EAAgBD,EAAUE,wBAEhC,MAAO,CACNhlC,KAAM8K,EAAMm6B,QAAUF,EAAc/kC,KAAO8kC,EAAUI,WACrD3kC,IAAKuK,EAAMq6B,QAAUJ,EAAcxkC,IAAMukC,EAAUM,WAoBrD,SAASC,GACRzvB,EACAjP,GAKA,OAAQA,EAAOtI,MACd,IAAK,iBACJ,MAAO,CACNinC,WAAW,EACX7e,UAAW9f,EAAO8f,UAClBzb,MAAOrE,EAAOqE,MACdywB,QAAS90B,EAAOqE,OAGlB,IAAK,kBACJ,OAAK4K,EAAM0vB,UAMJ,6BAAI1vB,GAAX,IAAkB6lB,QAAS90B,EAAO80B,WALjC51B,QAAQmG,KACP,kGAEM4J,GAIT,IAAK,eACJ,MAAO,CAAC0vB,WAAW,IAoBf,IAAMC,GAAoD,SAAAzoC,GAAU,IACnEgoC,EAAmDhoC,EAAnDgoC,UAAWU,EAAwC1oC,EAAxC0oC,uBAAwBC,EAAgB3oC,EAAhB2oC,aAD+B,EAE/C5oC,aAAiBwoC,GAAgB,CAC1DC,WAAW,IAH6D,mBAElE1vB,EAFkE,KAE3DoK,EAF2D,KAmEzE,OA3DAnjB,aAAgB,WAIf,GAAmB,cAAfyD,MAIAwkC,EAAUrJ,QAAS,CACtB,IAAMiK,EAAmBZ,EAAUrJ,QAC7BkK,EAAkB,SAAC76B,GACK,IAAD,EAA5B,GAAI06B,IACH,UAAK16B,EAAMgE,cAAX,aAAI,EAA+B0xB,QAAQgF,IAC1C,OAIF,IAAM/e,GAAa3b,EAAM86B,WAAa96B,EAAM+6B,QACtC76B,EAAQ65B,GAAsB/5B,EAAO46B,GAE3C1lB,EAAS,CAAC3hB,KAAM,iBAAkBooB,YAAWzb,UAC7Cy6B,EAAa,6BAAIz6B,GAAL,IAAYlL,OAAQ,EAAGU,MAAO,IAAIimB,IAK/C,OAFAif,EAAiBz2B,iBAAiB,YAAa02B,GAExC,kBACND,EAAiBx2B,oBAAoB,YAAay2B,OAElD,CAACb,EAAWU,EAAwBC,IAIvC5oC,aAAgB,WACf,GAAI+Y,EAAM0vB,WAAaR,EAAUrJ,QAAS,CACzC,IAAMiK,EAAmBZ,EAAUrJ,QAC7BqK,EAAkB,SAACh7B,GACxB,IAAM2wB,EAAUoJ,GAAsB/5B,EAAO46B,GAE7C1lB,EAAS,CAAC3hB,KAAM,kBAAmBo9B,YACnCgK,EAAaljC,aAAeqT,EAAM5K,MAAOywB,GAAU7lB,EAAM6Q,YAEpDsf,EAAgB,WACrB/lB,EAAS,CAAC3hB,KAAM,iBAChB2nC,KAEKA,EAAU,WACf76B,OAAO+D,oBAAoB,YAAa42B,GACxC36B,OAAO+D,oBAAoB,UAAW62B,GACtC/2B,SAASpG,KAAKq9B,UAAUztB,OAAO,sBAMhC,OAHArN,OAAO8D,iBAAiB,YAAa62B,GACrC36B,OAAO8D,iBAAiB,UAAW82B,GACnC/2B,SAASpG,KAAKq9B,UAAUvnB,IAAI,qBACrBsnB,KAEN,CAAClB,EAAWW,EAAc7vB,IAExBA,EAAM0vB,WAA4B,cAAfhlC,KAKvB,qBACC9C,UAAU,oBACVD,MAAOgF,aAAeqT,EAAM5K,MAAO4K,EAAM6lB,WANnC,MCzIHyK,I,OAAa,GAAKlkC,KAAKmkC,KAAK,IAErBC,GAAoD,SAAAtpC,GAAU,IACnEkQ,EAAmBlQ,EAAnBkQ,OAAQjC,EAAWjO,EAAXiO,QACTC,EAAe,CAAChL,KAAM+K,EAAQ/K,KAAMO,IAAKwK,EAAQxK,KAOvD,OALIwK,EAAQ5K,WACX6K,EAAMhL,MAAQgN,EAAOhN,KACrBgL,EAAMzK,KAAOyM,EAAOzM,KAIpB,sBACC/C,UAAU,oBACV4P,GAAIpC,EAAMhL,KAAO+K,EAAQvK,MACzB6M,GAAIrC,EAAMzK,IAAMwK,EAAQjL,OACxBwN,GAAItC,EAAMhL,KAAO+K,EAAQvK,MAAQ0lC,GACjC34B,GAAIvC,EAAMzK,IAAMwK,EAAQjL,OAASomC,GACjC3oC,MAAO,CAAC8oC,UAAW,wBCdf,SAASC,GAAT,GAAyE,IAA3Dt7B,EAA0D,EAA1DA,MAAOinB,EAAmD,EAAnDA,IAAKsU,EAA8C,EAA9CA,OAAQC,EAAsC,EAAtCA,SAAUC,EAA4B,EAA5BA,MAAOC,EAAqB,EAArBA,SACzD,MACC,IACA17B,EAAMhL,KACN,IACAgL,EAAMzK,IACN,KACAgmC,EAAOvmC,KACP,IACAumC,EAAOhmC,IACP,KARA,OASCmmC,QATD,IASCA,IAAY,MACZF,EAAW,KAAO,OAClBC,EAAQ,MAAQ,OACjBxU,EAAIjyB,KACJ,IACAiyB,EAAI1xB,I,WCZOomC,GAAsD,SAAA7pC,GAAU,IACrEm1B,EAA+Bn1B,EAA/Bm1B,IAAKjlB,EAA0BlQ,EAA1BkQ,OAAQhC,EAAkBlO,EAAlBkO,MAAO1N,EAAWR,EAAXQ,QACrBspC,EAAO/pC,WAAc,WAI1B,IAAIgqC,EAAc77B,EACd87B,EAAY7U,EAEZjnB,EAAM7K,WACT0mC,EAAW,6BACP77B,GADO,IAEVhL,KAAMgL,EAAMhL,KAAOgN,EAAOhN,KAC1BO,IAAKyK,EAAMzK,IAAMyM,EAAOzM,OAItB0xB,EAAI9xB,WACP2mC,EAAS,6BACL7U,GADK,IAERjyB,KAAMiyB,EAAIjyB,KAAOgN,EAAOhN,KACxBO,IAAK0xB,EAAI1xB,IAAMyM,EAAOzM,OAMxB,IAAIwmC,EAA2B1kC,aAAWwkC,GACtCG,EAAyB3kC,aAAWykC,GAMxC,KAFAC,EAAapkC,aAAyBkkC,EAAaE,EAAYC,IAG9D,MAAO,GAKR,KAFAA,EAAWrkC,aAAyBmkC,EAAWC,EAAYC,IAG1D,MAAO,GAUR,IAAMC,EAAW9kC,aAAa4kC,EAAYC,GAMtCP,EAAQM,EAAW/mC,KAAOgnC,EAAShnC,KAWvC,OATI+mC,EAAW/mC,OAASgnC,EAAShnC,MAAQ+mC,EAAWxmC,IAAMymC,EAASzmC,MAClEkmC,GAAQ,GAQFH,GAAI,CACVt7B,MAAO+7B,EACP9U,IAAK+U,EACLT,OAAQ,CAACvmC,KAAMinC,EAAU1mC,IAAgB,IAAX0mC,GAC9BP,SATa7kC,aAAUklC,EAAYC,GAUnCP,YAEC,CAACxU,EAAKjlB,EAAOhN,KAAMgN,EAAOzM,IAAKyK,IAElC,OACC,sBACC0C,EAAGk5B,EACHppC,UAAS,qCAAgCF,GACzCC,MAAO,CAAC8oC,UAAW,2BCxFTa,I,OAAgD,SAAApqC,GAAU,IAC/DkQ,EAA4BlQ,EAA5BkQ,OAAQjC,EAAoBjO,EAApBiO,QAASzN,EAAWR,EAAXQ,QAClB0N,EAAe,CAAChL,KAAM+K,EAAQ/K,KAAMO,IAAKwK,EAAQxK,KAEnDwK,EAAQ5K,WACX6K,EAAMhL,MAAQgN,EAAOhN,KACrBgL,EAAMzK,KAAOyM,EAAOzM,KAGrB,IAAMgmC,EAAS1pC,WACd,iBAAM,GAAMmF,KAAKw6B,IAAIzxB,EAAQvK,MAAOuK,EAAQjL,UAC5C,CAACiL,EAAQjL,OAAQiL,EAAQvK,QAGpBomC,EAAO/pC,WACZ,kBACCypC,GAAI,CACHt7B,MAAO,CACNhL,KAAMgL,EAAMhL,KACZO,IAAKyK,EAAMzK,IAAMwK,EAAQjL,OAAS,GAEnCmyB,IAAK,CACJjyB,KAAMgL,EAAMhL,KACZO,IAAKyK,EAAMzK,KAEZgmC,OAAQ,CACPvmC,KAAMumC,EACNhmC,IAAKgmC,GAENE,OAAO,EACPD,UAAU,MAEZ,CAACz7B,EAAQjL,OAAQymC,EAAQv7B,EAAMhL,KAAMgL,EAAMzK,MAG5C,OACC,sBACC/C,UAAS,kCAA6BF,GACtCoQ,EAAGk5B,EACHrpC,MAAO,CAAC8oC,UAAW,4BCpCTc,GAAgEtqC,QAC5E,SAAAC,GAAU,IACFshB,EAAuDthB,EAAvDshB,OAAQE,EAA+CxhB,EAA/CwhB,YAAatR,EAAkClQ,EAAlCkQ,OAAQuR,EAA0BzhB,EAA1ByhB,KAD5B,EACsDzhB,EAApBQ,eADlC,MAC4C,OAD5C,EAGR,OACC,qCACEuY,MAAMsJ,KAAKb,GAAa3e,KAAI,SAAAynC,GAAU,OACtCvxB,MAAMsJ,KAAKioB,EAAW,IAAIznC,KAAI,SAAAsyB,GAAG,OAChC,cAAC,GAAD,CACCA,IAAKA,EACLjlB,OAAQA,EAERhC,MAAOo8B,EAAW,GAClB9pC,QAASA,GAFJ8pC,EAAW,GAAGnnC,KAAOgyB,EAAIhyB,YAMhC4V,MAAMsJ,KAAKZ,GAAM5e,KAAI,SAAAoL,GAAO,OAC5B,cAAC,GAAD,CAECiC,OAAQA,EACRjC,QAASA,EACTzN,QAASA,GAHJyN,EAAQ9K,SAMd4V,MAAMsJ,KAAKf,GAAQze,KAAI,SAAAoL,GAAO,OAC9B,cAAC,GAAD,CAECiC,OAAQA,EACRjC,QAASA,GAFJA,EAAQ9K,eCjCNonC,I,OAAwB,kBACpC,iCACC,wBACCh9B,GAAG,iBACHi9B,KAAK,IACLC,KAAK,IACLC,YAAY,IACZC,aAAa,IACbC,OAAO,OANR,SAQC,sBAAMh6B,EAAE,sBAET,yBACCrD,GAAG,cACHi9B,KAAK,MACLC,KAAK,MACLC,YAAY,KACZC,aAAa,KALd,UAOC,wBAAQ55B,GAAG,MAAMC,GAAG,MAAMrG,EAAE,QAC5B,sBAAMiG,EAAE,oBAET,yBACCrD,GAAG,aACHm9B,YAAY,KACZC,aAAa,KACbH,KAAK,KACLC,KAAK,KACLj7B,QAAQ,YANT,UAQC,wBAAQuB,GAAG,KAAKC,GAAG,KAAKrG,EAAE,OAC1B,sBAAMiG,EAAE,oGACR,sBAAMA,EAAE,yCACR,wBAAQlQ,UAAU,aAAaqQ,GAAG,KAAKC,GAAG,KAAKrG,EAAE,cChCvCkgC,I,OAAkD9qC,QAC9D,SAAAC,GAAU,IACFkQ,EAAmBlQ,EAAnBkQ,OAAQjC,EAAWjO,EAAXiO,QACTC,EAAe,CAAChL,KAAM+K,EAAQ/K,KAAMO,IAAKwK,EAAQxK,KAOvD,OALIwK,EAAQ5K,WACX6K,EAAMhL,MAAQgN,EAAOhN,KACrBgL,EAAMzK,KAAOyM,EAAOzM,KAIpB,sBACC/C,UAAU,mBACV4P,GAAIpC,EAAMhL,KAAO,GACjBqN,GAAIrC,EAAMzK,IAAMwK,EAAQjL,OAAS,EACjCwN,GAAItC,EAAMhL,KACVuN,GAAIvC,EAAMzK,IAAMwK,EAAQjL,OAAS,EACjCvC,MAAO,CAACqqC,YAAa,0B,SCjBnBC,GAAY,iBAAM,ICMxB,IAAMC,GAAW,IAAIzpB,IACf0pB,GAAkB,CAAC/nC,KAAM,EAAGO,IAAK,GAE1BynC,GAAwD,SAAAlrC,GAAU,IACvEy6B,EAA+Dz6B,EAA/Dy6B,WAAYC,EAAmD16B,EAAnD06B,cAAexqB,EAAoClQ,EAApCkQ,OAAQnM,EAA4B/D,EAA5B+D,SAAUmiB,EAAkBlmB,EAAlBkmB,eAC9CilB,EDTA,SACN1Q,EACAC,GACE,IAAD,IACMliB,EAASkO,4BAATlO,MADN,EAE2B2P,mCAArBjF,EAFN,EAEMA,SAAU3J,EAFhB,EAEgBA,QACX9K,EAAS+K,mCAAyBD,EAASkhB,EAAYC,GAH5D,EAI+C36B,aAJ/C,mBAIM8O,EAJN,KAIwBu8B,EAJxB,KAOKrQ,EAAqBnS,yCAC1BpQ,EACAiiB,EACAC,GAeD,OAZA36B,aAAgB,WACXg7B,IAIqB,aAArBtsB,EAAOE,UACVuU,EAASuG,+BAAqBhb,IACC,WAArBA,EAAOE,WACjBy8B,EAAoB58B,aAAuBC,EAAQC,UAElD,CAACwU,EAAU6X,EAAoBtsB,IAE9BssB,EACIgQ,GAGR,iBAAOl8B,QAAP,IAAOA,GAAP,UAAOA,EAAkBw8B,kBAAzB,aAAO,EAA8BC,wBAArC,QAAyDP,GCvBjCQ,CAAyB9Q,EAAYC,GAFgB,EAGtB36B,WACtD,kBAAMihB,6BAAmBjd,KACzB,CAACA,IAFgBynC,EAH2D,EAGtEnqB,UAAkCoqB,EAHoC,EAG3C/pB,MAH2C,EAUzE3hB,WAAc,kBAAMihB,6BAAmBjd,EAAUonC,KAAkB,CACtEpnC,EACAonC,IAJWO,EARiE,EAQ5ErqB,UACOsqB,EATqE,EAS5EjqB,MAMKxd,EAAenE,WACpB,kBAAMgE,EAAS4P,MAAK,SAAA1F,GAAO,OAAIA,EAAQV,KAAO2Y,OAC9C,CAACniB,EAAUmiB,IAKZ,OACC,sBAAKxlB,UAAU,kBAAf,UACC,cAAC,GAAD,IACCwD,GACA,cAAC2mC,GAAD,CAAiB36B,OAAQA,EAAQjC,QAAS/J,IAE3C,cAACmmC,GAAD,6BAA4BmB,GAA5B,IAA4Ct7B,OAAQA,KACpD,cAACm6B,GAAD,6BAA4BoB,GAA5B,IAAwCv7B,OAAQ+6B,MAChD,cAACZ,GAAD,CACC/oB,OAAQ0pB,GACRxpB,YAAakqB,EAAoBlqB,YACjCtR,OAAQA,EACRuR,KAAMupB,GACNxqC,QAAQ,cAET,cAAC6pC,GAAD,CACC/oB,OAAQ0pB,GACRxpB,YAAamqB,EAAgBnqB,YAC7BtR,OAAQ+6B,GACRxpB,KAAMupB,GACNxqC,QAAQ,kB,wCCtCCorC,I,OAA0C7rC,QAAW,SAAAC,GAAU,IAE1E6rC,EAQG7rC,EARH6rC,WACAC,EAOG9rC,EAPH8rC,OACAC,EAMG/rC,EANH+rC,YACAC,EAKGhsC,EALHgsC,WACAtT,EAIG14B,EAJH04B,OACA4B,EAGGt6B,EAHHs6B,SACArsB,EAEGjO,EAFHiO,QACA3J,EACGtE,EADHsE,UAEK5D,EAAYX,WACjB,kBAAMY,IAAW,eAAgB,CAAC0C,SAAU4K,EAAQ5K,aACpD,CAAC4K,EAAQ5K,WAEJ2kC,EAAYjoC,SAA6B,MACzCksC,EAAUlsC,WAAc,kBAAMkO,EAAQ1K,KAAKmc,OAAO,EAlBnC,OAkBsD,CAC1EzR,EAAQ1K,OAEH9C,EAAQV,WACb,iBAAO,CACNiD,OAAQiL,EAAQjL,OAChBE,KAAM+K,EAAQ/K,KACdO,IAAKwK,EAAQxK,IACbC,MAAOuK,EAAQvK,SAEhB,CAACuK,EAAQjL,OAAQiL,EAAQ/K,KAAM+K,EAAQxK,IAAKwK,EAAQvK,QAE/CmlC,EAAkB9oC,eACvB,SAACiO,GAMIA,EAAM86B,UAAY96B,EAAM+6B,QACvB96B,EAAQ5K,SACXwoC,EAAW59B,GAEXqsB,EAASrsB,GAAS,GAERA,EAAQ5K,UACnBi3B,EAASrsB,GAAS,KAGpB,CAAC49B,EAAYvR,EAAUrsB,IAElBi+B,EAAansC,eAAkB,kBAAM24B,EAAOzqB,KAAU,CAC3DyqB,EACAzqB,IAGD,OACC,cAAC,iBAAD,CACCk+B,QAASnE,EACToE,YAAavD,EACbwD,QAASN,EACTD,OAAQA,EACRQ,OAAQN,EALT,SAOC,qBACCtrC,UAAWA,EACX6rC,cAAeL,EACfjsC,IAAK+nC,EACLvnC,MAAOA,EAJR,SAMC,eAAC,IAAD,CAAMwC,YAAagL,EAAQhL,YAAaI,SAAU4K,EAAQ5K,SAA1D,UACC,cAAC,KAAD,CAAWiB,UAAWA,EAAWhB,KAAM2K,EAAQ3K,OAC/C,6BAAK2K,EAAQ9K,OACb,cAAC,IAAD,UAAc8oC,eCjFNO,I,OAAoDzsC,QAChE,SAAAC,GAAU,IACF+D,EAAY/D,EAAZ+D,SAEP,OACC,cAAC0oC,GAAA,EAAD,CAAiBnpB,UAAW,KAA5B,SACEvf,EAASlB,KAAI,SAAAoL,GAAO,OACpB,cAACy+B,GAAA,EAAD,CAAe/rC,WAAW,MAAuB4R,QAAS,IAA1D,SACC,cAACq5B,GAAD,cAAa39B,QAASA,GAAajO,KADCiO,EAAQV,a,OCgBlD,SAASo/B,GAAY7zB,EAAkBjP,GACtC,OAAQA,EAAOtI,MACd,IAAK,QACJ,MAAO,CACNqrC,UAAU,EACVC,MAAOhjC,EAAOijC,EACdC,MAAOljC,EAAOmjC,EACdC,OAAQpjC,EAAOijC,EACfI,OAAQrjC,EAAOmjC,GAGjB,IAAK,OACJ,OAAO,6BAAIl0B,GAAX,IAAkB+zB,MAAOhjC,EAAOijC,EAAGC,MAAOljC,EAAOmjC,IAElD,IAAK,OAeJ,OANAnwB,QAAQC,UAAUI,MAAK,kBACtBrT,EAAOsjC,SAAS,CACfjqC,MAAO4V,EAAM+zB,MAAQ/zB,EAAMm0B,QAAUpjC,EAAOtF,KAC5Cd,KAAMqV,EAAMi0B,MAAQj0B,EAAMo0B,QAAUrjC,EAAOtF,UAGtC,CAACqoC,UAAU,EAAOC,MAAO,EAAGE,MAAO,EAAGE,OAAQ,EAAGC,OAAQ,IAI5D,IAAME,GAAwC,SAAAptC,GAAU,IAE7Dy6B,EAUGz6B,EAVHy6B,WACAC,EASG16B,EATH06B,cACAmR,EAQG7rC,EARH6rC,WACAC,EAOG9rC,EAPH8rC,OACApT,EAMG14B,EANH04B,OACA4B,EAKGt6B,EALHs6B,SACAv2B,EAIG/D,EAJH+D,SACAmiB,EAGGlmB,EAHHkmB,eACA5hB,EAEGtE,EAFHsE,UACAC,EACGvE,EADHuE,KAEKyjC,EAAYjoC,SAA6B,MACzCutB,EAASvtB,WAAc,WAI5B,IAAMstC,EAAgBlnC,aAAa,GAAD,oBAC9BpC,GAD8B,CAEjC,CAACN,IAAK,EAAGP,KAAM,EAAGQ,MAAO,EAAGV,OAAQ,MAE/BsqC,EAAqBj/B,OAAOk/B,YAAchpC,EAC1CipC,EAAoBn/B,OAAOo/B,WAAalpC,EAE9C,MAAO,CACNvB,OACCkC,KAAKqoB,IAAI8f,EAAcrqC,OAAQsqC,GACV,IAArBj/B,OAAOk/B,YACR7pC,MACCwB,KAAKqoB,IAAI8f,EAAc3pC,MAAO8pC,GACV,IAApBn/B,OAAOo/B,cAEP,CAAC1pC,EAAUQ,IAER9D,EAAQV,WACb,+BAAC,gBACGutB,GADJ,IAECzc,UAAU,SAAD,OAAWtM,EAAX,SAEV,CAAC+oB,EAAQ/oB,IAxCmD,EA2CnCxE,aAAiB4sC,GAAa,CACvDC,UAAU,EACVC,MAAO,EACPE,MAAO,EACPE,OAAQ,EACRC,OAAQ,IAhDoD,mBA2CtDp0B,EA3CsD,KA2C/CoK,EA3C+C,KAmD7DnjB,aAAgB,WACVioC,EAAUrJ,UAIfqJ,EAAUrJ,QAAQl+B,MAAMitC,YACvB,qBADD,WAEK50B,EAAM+zB,MAAQ/zB,EAAMm0B,QAAU1oC,EAFnC,OAIAyjC,EAAUrJ,QAAQl+B,MAAMitC,YACvB,oBADD,WAEK50B,EAAMi0B,MAAQj0B,EAAMo0B,QAAU3oC,EAFnC,UAIE,CAACuU,EAAM+zB,MAAO/zB,EAAMi0B,MAAOj0B,EAAMm0B,OAAQn0B,EAAMo0B,OAAQ3oC,IAE1D,IAAMopC,EAAkB5tC,eAAkB,SAACiO,EAAOP,GACjDyE,SAASpG,KAAKq9B,UAAUvnB,IAAI,qBAC5BsB,EAAS,CAAC3hB,KAAM,QAASurC,EAAGr/B,EAAKq/B,EAAGE,EAAGv/B,EAAKu/B,MAC1C,IACGY,EAAa7tC,eAClB,SAACiO,EAAOP,GAAR,OACCyV,EAAS,CAAC3hB,KAAM,OAAQurC,EAAGr/B,EAAKq/B,EAAGE,EAAGv/B,EAAKu/B,MAC5C,IAEKa,EAAiB9tC,eAAkB,WACxCmS,SAASpG,KAAKq9B,UAAUztB,OAAO,qBAC/BwH,EAAS,CAAC3hB,KAAM,OAAQ4rC,SAAUrB,EAAQvnC,WACxC,CAACunC,EAAQvnC,IAEZ,OACC,sBAAK7D,UAAU,cAAcT,IAAK+nC,EAAWvnC,MAAOA,EAApD,UACC,cAAC,GAAD,CACCg6B,WAAYA,EACZC,cAAeA,EACfxqB,OAAQ,CACPhN,MAAO4V,EAAM+zB,MAAQ/zB,EAAMm0B,QAAU1oC,EACrCd,KAAMqV,EAAMi0B,MAAQj0B,EAAMo0B,QAAU3oC,GAErCR,SAAUA,EACVmiB,eAAgBA,IAEjB,cAACsmB,GAAD,CACCX,WAAYA,EACZE,YAAa4B,EACb7B,OAAQ8B,EACR5B,WAAY6B,EACZnV,OAAQA,EACR4B,SAAUA,EACVv2B,SAAUA,EACVO,UAAWA,EACXC,KAAMA,Q,mBC3JGupC,GAA0D,SAAA9tC,GAAU,IACzE+tC,EAAoB/tC,EAApB+tC,UAAWhgC,EAAS/N,EAAT+N,MACXmV,EAAYuH,uCAAZvH,SACD8qB,EAAcjuC,eAAkB,WAAO,IAAD,EACvBguC,IAAb7qC,EADoC,EACpCA,KAAMO,EAD8B,EAC9BA,IAEbyf,EAAS+J,gCAAsBlf,EAAO7K,EAAMO,GAAM,2BAChD,CAACyf,EAAU6qB,EAAWhgC,IAClB1L,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,cACT/B,QAAS0tC,KCfCC,GAA4D,SAAAjuC,GAAU,IAC3E+D,EAAmB/D,EAAnB+D,SAAUgK,EAAS/N,EAAT+N,MACVmV,EAAYuH,uCAAZvH,SACA7gB,EAAKC,cAALD,EAWP,OACC,cAAC,IAAD,CACCnC,SAA8B,IAApB6D,EAASsC,OACnBlG,KAAM,cAAC,IAAD,IACNU,MACCkD,EAASsC,OAAS,EACfhE,EAAE,qBAAsB,CAACsgB,MAAO5e,EAASsC,SACzChE,EAAE,iBAEN/B,QAlBF,WACC4iB,EACCwK,yBAAe3f,EAAOhK,GACtBA,EAASsC,OAAS,EACf,4BACA,gCCVO6nC,GAAwD,SAAAluC,GAAU,IACvE+D,EAAmB/D,EAAnB+D,SAAUgK,EAAS/N,EAAT+N,MACVmV,EAAYD,8BAAZC,SACA7gB,EAAKC,cAALD,EAcP,OACC,cAAC,IAAD,CACCnC,SAA8B,IAApB6D,EAASsC,OACnBlG,KAAM,cAAC,IAAD,IACNU,MACCkD,EAASsC,OAAS,EACfhE,EAAE,mBAAoB,CAACsgB,MAAO5e,EAASsC,SACvChE,EAAE,eAEN/B,QArBF,WACC4iB,GAAS,SAAAA,GAAQ,OAChBnf,EAAS8P,SAAQ,SAAA5F,GAAO,OACvBiV,EAAS,CACR3hB,KAAM,YACN+hB,UAAWsa,oBACX59B,MAAO,CAACma,UAAWlM,EAAQV,GAAIuM,QAAS/L,EAAMR,gBCTtC4gC,GAAkE,SAAAnuC,GAAU,IACjF+N,EAAS/N,EAAT+N,MACAmV,EAAY+H,8BAAZ/H,SACA7gB,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,oBACT/B,QAAS,kBAAM4iB,EAASmM,4BAAkBthB,QCPhCqgC,GAA4D,SAAApuC,GAAU,IAC3EiO,EAAkBjO,EAAlBiO,QAASF,EAAS/N,EAAT+N,MADiE,EAErDkd,8BAArB/H,EAF0E,EAE1EA,SAAUpQ,EAFgE,EAEhEA,QACVzQ,EAAKC,cAALD,EAUP,OACC,cAAC,IAAD,CACCnC,UAAW+N,GAAWA,EAAQV,KAAOQ,EAAM7J,aAC3C/D,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,2CACT/B,QAbF,WACC,IAAK2N,EACJ,MAAM,IAAI3H,MAAM,kBAGjB4c,EAASkI,sBAAYtY,EAAS/E,EAAO,CAAC7J,aAAc+J,EAAQV,UCdjD8gC,GAAsD,SAAAruC,GAAU,IACrEiO,EAAkBjO,EAAlBiO,QAASF,EAAS/N,EAAT+N,MACT+3B,EAAaF,IAAbE,UACAzjC,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACCnC,UAAW+N,EACX9N,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,yCACT/B,QAAS,kBAAMwlC,EAAU/3B,EAAMR,GAAP,OAAWU,QAAX,IAAWA,OAAX,EAAWA,EAASV,QCAlC+gC,GAAgD,SAAC,GAGvD,IAFNP,EAEK,EAFLA,UACAhgC,EACK,EADLA,MAEOmV,EAAY+H,8BAAZ/H,SACDqrB,EAAmBxuC,WACxB,kBAAMgO,EAAMhK,SAASkH,QAAO,SAAAgD,GAAO,OAAIA,EAAQ5K,cAC/C,CAAC0K,EAAMhK,WAEFyqC,EAAsBzuC,WAC3B,kBAAmC,IAA5BwuC,EAAiBloC,OAAekoC,EAAiB,QAAKztC,IAC7D,CAACytC,IAuBF,OACC,eAAC,IAAD,WACC,cAAC,GAAD,CAAqBR,UAAWA,EAAWhgC,MAAOA,IAClD,cAAC,GAAD,CAAoBhK,SAAUwqC,EAAkBxgC,MAAOA,IACvD,cAAC,KAAD,CACCoZ,SAAU,SAAAhkB,GAAI,OAzBjB,SAAsBA,EAAc8K,GACnC,IAAKA,EACJ,MAAM,IAAI3H,MAAM,oBAQjB4c,EACC0K,wBACC7f,EACAE,EACA,CAAC9K,QACD,CAAC2qB,+BAA+B,KAUd2gB,CAAatrC,EAAMqrC,IACrCvgC,QAASugC,EACTzgC,MAAOA,IAER,cAAC,GAAD,CAAsBhK,SAAUwqC,EAAkBxgC,MAAOA,IACzD,cAAC,GAAD,CAAmBE,QAASugC,EAAqBzgC,MAAOA,IACxD,cAAC,GAAD,CAAsBE,QAASugC,EAAqBzgC,MAAOA,IAC3D,cAAC,GAAD,CAAyBA,MAAOA,QCzD7B2gC,GAAsC,WAAO,IAC3CrsC,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CAAYnC,UAAQ,EAACC,KAAM,cAAC,IAAD,IAAiBU,MAAOwB,EAAE,oBAUjDssC,GAAoE,SAAA3uC,GAAU,IAC5E6uB,EAAoC7uB,EAApC6uB,gBAAiB1H,EAAmBnnB,EAAnBmnB,SAAUpZ,EAAS/N,EAAT+N,MADgD,EAEpDhO,WAAegO,EAAM5K,MAF+B,mBAE3Esb,EAF2E,KAElEC,EAFkE,KAG3Erc,EAAKC,cAALD,EA4BP,OA1BAtC,aAAgB,kBAAM2e,EAAW3Q,EAAM5K,QAAO,CAAC4K,IA2B9C,cAAC,KAAD,CACC5N,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACTb,SAAU,SAAAwM,GAAK,OAAI0Q,EAAW1Q,EAAMgE,OAAOrQ,QAC3C+V,SAAUyP,EACVxP,OAAQtV,EAAE,sBAAuB,CAACc,KAAM4K,EAAM5K,OAC9C4U,SA/BF,SAAkB5U,GACjB,MAAoB,KAAhBA,EAAKwE,OACD,CACNyQ,QAAS/V,EAAE,0CACX6V,OAAO,GAKR2W,EAAgB7nB,MACf,SAAA4E,GAAC,OACAA,EAAE2B,KAAOQ,EAAMR,IACfsb,wBAAcjd,KAAOid,wBAAc,6BAAI9a,GAAL,IAAY5K,aAGzC,CACNiV,QAAS/V,EAAE,gDACX6V,OAAO,GAIF,CAACA,OAAO,IAWdvW,MAAO8c,KAUGmwB,GAAsD,SAAA5uC,GAClE,OAAIA,EAAM+N,MAER,cAAC,GAAD,gBAA+B/N,IAI1B,cAAC,GAAD,KCtEK6uC,GAA8C,SAAA7uC,GAAU,IAC7D+N,EAAS/N,EAAT+N,MACAmV,EAAYD,8BAAZC,SACA7gB,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,kBACT/B,QAAS,kBACR4iB,EAAS,CACR3hB,KAAM,YACN+hB,UAAWwd,qBACX9gC,MAAO,CAAC8Z,QAAS/L,EAAMR,UCbfuhC,GAAsD,SAAA9uC,GAAU,IACrE+N,EAAS/N,EAAT+N,MACAmV,EAAYD,8BAAZC,SACA7gB,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,2CACT/B,QAAS,kBACR4iB,EAAS,CACR3hB,KAAM,YACN+hB,UAAWmI,oBACXzrB,MAAO,CAAC8Z,QAAS/L,EAAMR,UCbfwhC,GAAoD,SAAA/uC,GAAU,IACnE+N,EAAS/N,EAAT+N,MACAmV,EAAYD,8BAAZC,SACA7gB,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,uCACT/B,QAAS,kBACR4iB,EAAS,CACR3hB,KAAM,YACN+hB,UAAWwH,wBACX9qB,MAAO,CAAC8Z,QAAS/L,EAAMR,UCbfyhC,GAAsD,SAAAhvC,GAAU,IACrE+N,EAAS/N,EAAT+N,MACAmV,EAAYD,8BAAZC,SACA7gB,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,wCACT/B,QAAS,kBACR4iB,EAAS,CACR3hB,KAAM,YACN+hB,UAAWkH,oBACXxqB,MAAO,CAAC8Z,QAAS/L,EAAMR,UCbf0hC,GAAoD,SAAAjvC,GAAU,IACnE+N,EAAS/N,EAAT+N,MACAmV,EAAYD,8BAAZC,SACA7gB,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,uCACT/B,QAAS,kBACR4iB,EAAS,CACR3hB,KAAM,YACN+hB,UAAW0I,wBACXhsB,MAAO,CAAC8Z,QAAS/L,EAAMR,UCVf2hC,GAA4C,SAAAlvC,GAAU,IAAD,EACrCirB,8BAArB/H,EAD0D,EAC1DA,SAAUpQ,EADgD,EAChDA,QACV/E,EAAS/N,EAAT+N,MAEP,OACC,eAAC,IAAD,WACC,cAAC,GAAD,CAAmBA,MAAOA,IAC1B,cAAC,GAAD,CACC8gB,gBAAiB/b,EACjBqU,SAAU,SAAAhkB,GAAI,OAAI+f,EAASkI,sBAAYtY,EAAS/E,EAAO,CAAC5K,WACxD4K,MAAOA,IAER,cAAC,GAAD,CAAeA,MAAOA,IACtB,cAAC,GAAD,CAAmBA,MAAOA,IAC1B,cAAC,GAAD,CAAkBA,MAAOA,IACzB,cAAC,GAAD,CAAkBA,MAAOA,QCvBf0V,GAA4B,WAAO,IAAD,EACHgH,uCAApCxG,EADuC,EACvCA,KAAM8b,EADiC,EACjCA,UAAW7b,EADsB,EACtBA,KAAM8b,EADgB,EAChBA,UACvB39B,EAAKC,cAALD,EAEP,OACC,qCACC,cAAC,IAAD,CACCnC,UAAWgkB,EACX/jB,KAAM,cAAC,IAAD,IACNU,MAAK,OAAEm/B,QAAF,IAAEA,IAAa39B,EAAE,eACtB/B,QAAS4jB,IAEV,cAAC,IAAD,CACChkB,UAAW+jB,EACX9jB,KAAM,cAAC,IAAD,IACNU,MAAK,OAAEk/B,QAAF,IAAEA,IAAa19B,EAAE,eACtB/B,QAAS2jB,QCPAkrB,GAAoD,SAAAnvC,GAAU,IAAD,EAClE+tC,EAAoB/tC,EAApB+tC,UAAWhgC,EAAS/N,EAAT+N,MACX1L,EAAKC,cAALD,EAEP,OACC,cAAC,EAAD,CACC4iC,eAAgB,cAAC,GAAD,IAChBC,MAAI,mBACF7iC,EAAE,kBACF,cAAC,GAAD,CAAgB0rC,UAAWA,EAAWhgC,MAAOA,KAF3C,cAIF1L,EAAE,gBAAkB,cAAC,GAAD,CAAc0L,MAAOA,KAJvC,cAKF1L,EAAE,gBAAkB,cAAC,GAAD,CAAc0L,MAAOA,KALvC,cAMF1L,EAAE,kBAAoB,cAAC,GAAD,KANpB,M,sCCFM+sC,GAA0C,SAAC,GAAa,IAAZrhC,EAAW,EAAXA,MAAW,EACvCkd,8BAArB/H,EAD4D,EAC5DA,SAAUpQ,EADkD,EAClDA,QACVzQ,EAAKC,cAALD,EACAW,EAAUggB,8BAAVhgB,OAEDqsC,EAAmBtvC,eACxB,SAAC4/B,GACAzc,EAASkI,sBAAYtY,EAAS/E,EAAO,CAACxJ,KAAMwJ,EAAMxJ,KAAOo7B,OAE1D,CAACzc,EAAUpQ,EAAS/E,IAGftN,EAA6B,CAClC2iB,aAAcpgB,GAGf,OACC,qBAAKtC,UAAU,eAAeD,MAAOA,EAArC,SACC,eAAC,KAAD,WACC,cAAC,IAAD,CACCP,SAAU6N,EAAMxJ,MAAQ+lB,UACxBnqB,KAAM,cAAC,IAAD,IACNC,UAAQ,EACRS,MAAOwB,EAAE,2BACT/B,QAAS,kBAAM+uC,EAAiB,OAEjC,cAAC,IAAD,CACCnvC,SAAU6N,EAAMxJ,MAAQ8lB,UACxBlqB,KAAM,cAAC,IAAD,IACNC,UAAQ,EACRS,MAAOwB,EAAE,4BACT/B,QAAS,kBAAM+uC,GAAkB,aCtBzBC,GAAgC,WAAO,IAAD,EACtBvvC,YAAe,GADO,mBAC3CwvC,EAD2C,KACnCC,EADmC,KAEjCC,EAAmBxsB,8BAA7BC,SACDwsB,EAAc3vC,SAA6B,MAC1C+Z,EAAW61B,cAAX71B,QAJ2C,EAQ9C2Q,uCAFOmlB,EANuC,EAMjD1sB,SACApQ,EAPiD,EAOjDA,QAEK/E,EAAQ8L,sBAAY/G,EAASgH,GAE7By0B,EAAmBxuC,WACxB,kBAAMgO,EAAMhK,SAASkH,QAAO,SAAAgD,GAAO,OAAIA,EAAQ5K,cAC/C,CAAC0K,EAAMhK,WAGFgqC,EAAYhuC,eAAkB,WACnC,IAAK2vC,EAAY/Q,QAChB,MAAM,IAAIr4B,MACT,kFAIF,MAAO,CACNpD,MACEwsC,EAAY/Q,QAAQyJ,WAAasH,EAAY/Q,QAAQkR,YAAc,GACpE9hC,EAAMxJ,KACPd,KACEisC,EAAY/Q,QAAQ2J,UAAYoH,EAAY/Q,QAAQmR,aAAe,GACpE/hC,EAAMxJ,QAEN,CAACwJ,EAAMxJ,OAEJwrC,EAAwBhwC,eAC7B,SAACkO,GAAD,OACC2hC,EAAwBxgB,0BAAgBrhB,EAAOE,MAChD,CAACF,EAAO6hC,IAGHI,EAAqBjwC,eAC1B,SAAC4/B,GAIIz6B,KAAK+qC,IAAItQ,EAAOz8B,MAAQ,GAAKgC,KAAK+qC,IAAItQ,EAAOl8B,KAAO,GAIxDmsC,EACC3gB,uBACClhB,EACAA,EAAMhK,SAASyH,QACd,SAACxF,EAAQ24B,GAAT,OACCA,EAAQt7B,SAAR,uBAAuB2C,GAAvB,CAA+B24B,EAAQpxB,KAAMvH,IAC9C,IAED25B,EAAOz8B,KACPy8B,EAAOl8B,MAER8qC,EAAiBloC,OACd,8BAIL,CAACkoC,EAAiBloC,OAAQ0H,EAAO6hC,IAG5BM,EAAoBnwC,eACzB,SAACkO,GAAD,OACCwhC,EAAgB,CACfluC,KAAM,YACN+hB,UAAWsa,oBACX59B,MAAO,CAACma,UAAWlM,EAAQV,GAAIuM,QAAS/L,EAAMR,QAEhD,CAACkiC,EAAiB1hC,EAAMR,KAGnB4iC,EAAsBpwC,eAC3B,SAACkO,EAAkB0b,GAAnB,OACCimB,EAAwBtgB,wBAAcvhB,EAAOE,EAAS0b,MACvD,CAAC5b,EAAO6hC,IAGHQ,EAAmBrwC,eACxB,SAACyF,EAAYmkB,GAIZ,IAAM0mB,EAAoB,CACzBrtC,OAAQwC,EAAKxC,OAAS+K,EAAMxJ,KAC5BrB,KAAMsC,EAAKtC,KAAO6K,EAAMxJ,KACxBd,IAAK+B,EAAK/B,IAAMsK,EAAMxJ,KACtBb,MAAO8B,EAAK9B,MAAQqK,EAAMxJ,MAK3BqrC,EACCrgB,+BACCxhB,EACAsiC,EACA1mB,EAAY,GAAK4kB,EAAiB1rC,KAAI,SAAAoL,GAAO,OAAIA,EAAQV,UAI5D,CAACghC,EAAkBxgC,EAAO6hC,IAsB3B,OAdA7vC,aAAgB,WACf,IAAKwvC,IACJC,GAAU,GAEoB,IAA1BzhC,EAAMhK,SAASsC,QAAc,CAChC,IAAMiqC,EAASvC,IAEf6B,EACC3iB,gCAAsBlf,EAAOuiC,EAAOptC,KAAMotC,EAAO7sC,SAIlD,CAACsqC,EAAWwB,EAAQxhC,EAAO6hC,IAG7B,sBAAKlvC,UAAU,mBAAf,UACC,cAACujC,EAAA,EAAD,UACC,gCAAQl2B,EAAM5K,SAEf,cAAC,GAAD,CAAkB4qC,UAAWA,EAAWhgC,MAAOA,IAC/C,eAACg2B,EAAD,CAAaC,QAAQ,EAAO/jC,IAAKyvC,EAAjC,UACC,cAAC,GAAD,CACC1H,UAAW0H,EACXhH,uBAAuB,kCACvBC,aAAcyH,IAEf,cAAC,GAAD,CACC3V,WAAY1sB,EAAM5J,YAClBu2B,cAAe3sB,EAAM3J,mBACrBynC,WAAYkE,EACZjE,OAAQkE,EACRtX,OAAQwX,EACR5V,SAAU6V,EACVpsC,SAAUgK,EAAMhK,SAChBmiB,eAAgBnY,EAAM7J,aACtBI,UAAWyJ,EAAMzJ,UACjBC,KAAMwJ,EAAMxJ,OAEb,cAAC,GAAD,CAAawJ,MAAOA,WASXwiC,GAA2B,kBACvC,cAAC,kCAAD,UACC,cAAC,yBAAD,UACC,cAAC,GAAD,S,mDCnLUC,I,OAA8B,SAAAxwC,GAAU,IAC7CqC,EAAKC,cAALD,EACDouC,GAAU,IAAIC,MAAWC,aAE/B,GAAqB,WAAjBF,EAAQttC,KACX,OAAO,KAGR,GAAIstC,EAAQthC,QAAS,CACpB,IAAMA,EAAU4yB,SAAS0O,EAAQthC,QAAQzH,QAAQ,OAAQ,KAEzD,GAAIoC,OAAOsjB,SAASje,IAAYA,EAAU,GACzC,OAAO,KAIT,IAAMyhC,EAAkBviC,OAAOC,UAE/B,GAAIsiC,EAAgBC,WAInB,OAAO,KAGR,IAAMC,OAAoDhwC,IAA/B8vC,EAAgBC,WAE3C,OACC,qBAAKnwC,UAAU,sBAAf,SACC,eAAC,IAAD,WACC,qBAAKA,UAAU,YAAf,SACC,cAAC,IAAD,MAED,sBAAKA,UAAU,UAAf,UACC,4BAAI2B,EAAE,0CACLyuC,GACA,4BAAIzuC,EAAE,kDAEP,4BAAIA,EAAE,iEAEP,eAAC,IAAD,WACC,cAAC,KAAD,CACCsa,KAAK,uCACLxc,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,0CACT7B,QAAQ,YAERswC,GACA,cAAC,KAAD,CACCn0B,KAAK,qCACLxc,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iEC7DT,SAAS0uC,KACf,OAAOnoC,KAAKmB,UAAUsE,OAAOmM,cAAcnU,OAQrC,SAAS2qC,KAA+D,IAAzCC,EAAwC,uDAA5B,IAAQC,EAAoB,uDAAJ,GACzE,OAAO,IAAIr0B,SAAgB,SAAAC,GAC1B,IAAMq0B,EAAa,IAAIC,OAAOH,GAC1BI,EAAa,EACXC,EAAWjjC,OAAOkjC,aAAY,WACnC,IACCljC,OAAOmM,aAAaO,QAApB,yBAA8Cs2B,GAAcF,GAC5DE,IACC,MAAO5zB,GAGR,IAAK,IAAIlX,EAAI,EAAGA,GAAK8qC,EAAY9qC,IAChC,IACC8H,OAAOmM,aAAaI,WAApB,yBAAiDrU,IAChD,MAAOxF,IAMVsN,OAAOmjC,cAAcF,GACrBx0B,EAAQu0B,EAAaJ,MAEpBC,M,WCrBQO,GAA4C,SAAAzxC,GAAU,IAC3D0jB,EAAS1jB,EAAT0jB,MAD0D,EAE/B3jB,aAF+B,mBAE1D2xC,EAF0D,KAE/CC,EAF+C,OAGnC5xC,YAAe,GAHoB,mBAG1D6xC,EAH0D,KAGjDC,EAHiD,OAS/B9xC,YAAgB,GATe,mBAS1D+xC,EAT0D,KAS/CC,EAT+C,OAU/BhyC,WAAe,GAVgB,mBAU1DiyC,EAV0D,KAU/CC,EAV+C,KAW1D5vC,EAAKC,cAALD,EAED6vC,EAAO9jC,cAkBb,OAdArO,aAAgB,WAAM,4CACrB,sBAAA2L,EAAA,6DACCmmC,GAAW,GACXI,EAAalB,MAFd,KAGCgB,EAHD,SAGoBf,KAHpB,kCAICW,EAAajuB,GACbmuB,GAAW,GALZ,4CADqB,sBAShBK,GAASN,GAAWF,IAAchuB,GATjB,WAAD,wBAUpByuB,KAEC,CAACD,EAAMR,EAAWhuB,EAAOkuB,IAExBM,EACI,KAIP,uBAAMxxC,UAAU,gBAAhB,UACEkxC,GAAW,cAAC,IAAD,KACI,IAAfE,GACAzvC,EAAE,oCAAqC,CACtCqlB,QAASxiB,KAAKsoB,MAAOskB,GAAaA,EAAYE,GAAc,WC7CpDI,GAA0B,WAAO,IACtCt/B,EAAWmY,8BAAXnY,QACAzQ,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,oCACT/B,QAAS,kBACRylC,EAASlzB,YAAeC,EAAS7B,eAAeyB,mBCZvC2/B,GAA8B,WAAO,IAC1CnvB,EAAYD,8BAAZC,SACA7gB,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACT/B,QAAS,kBACR4iB,EAAS,CAAC3hB,KAAM,YAAa+hB,UAAWub,0BCT/ByT,GAA4B,WAAO,IACxCpvB,EAAYD,8BAAZC,SACA7gB,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,sCACT/B,QAAS,WACR4iB,EAAS,CAAC3hB,KAAM,YAAa+hB,UAAW2I,wBCT/BsmB,GAA2B,kBACvC,eAAC,IAAD,WACC,cAAC,GAAD,IACA,cAAC,GAAD,IACA,cAAC,GAAD,Q,oBCCWC,GAA8B,WAAO,IAAD,EACpBvnB,8BAArB/H,EADyC,EACzCA,SAAUpQ,EAD+B,EAC/BA,QACXiR,EAAU4gB,cACTnsB,EAASkO,4BAATlO,MACAnW,EAAKC,cAALD,EAQP,OACC,cAAC,IAAD,CACClC,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,cACT/B,QAVF,WACC,IAAMiN,EAAKkgB,8BAAoB3a,EAAS0F,EAA7BiV,CAAoCvK,GAAU,kBAAMpQ,KAE/DiR,EAAQjJ,KAAR,mBAAyBvN,Q,kBCAdklC,I,OAA8C,SAAAzyC,GAAU,IAEnEwX,EAQGxX,EARHwX,WACAC,EAOGzX,EAPHyX,YACAi7B,EAMG1yC,EANH0yC,YACAC,EAKG3yC,EALH2yC,aACAC,EAIG5yC,EAJH4yC,eACAC,EAGG7yC,EAHH6yC,UACAl7B,EAEG3X,EAFH2X,OACGrG,EAT+D,aAU/DtR,EAV+D,mGAW3CD,YAAe,GAX4B,mBAW5DsR,EAX4D,KAWtD8F,EAXsD,KAY5D9U,EAAKC,cAALD,EAEP,OACC,sBAAM3B,UAAU,iBAAhB,SACC,eAAC,KAAD,2BAAY0Q,aAAc+F,EAAS9F,KAAMA,GAAUC,GAAnD,cACC,cAAC,IAAD,UAAcqG,IACd,eAAC,IAAD,WACC,cAAC,IAAD,CACCxX,KAAI,OAAEuyC,QAAF,IAAEA,IAAe,cAAC,IAAD,IACrB7xC,MAAK,OAAE8xC,QAAF,IAAEA,IAAgBtwC,EAAE,aACzB/B,QAASuyC,EACTryC,QAAO,OAAEoyC,QAAF,IAAEA,IAAkB,YAE5B,cAAC,IAAD,CACCzyC,KAAI,OAAEqX,QAAF,IAAEA,IAAc,cAAC,IAAD,IACpB3W,MAAK,OAAE4W,QAAF,IAAEA,IAAepV,EAAE,iBACxB/B,QAAS,kBAAM6W,GAAQ,iBCrChB27B,GAAsD,SAAC,GAE7D,IADN/kC,EACK,EADLA,MAEOmV,EAAY+H,8BAAZ/H,SACA7gB,EAAKC,cAALD,EAEP,OACC,cAAC,GAAD,CACCqwC,YAAa,cAAC,IAAD,IACbC,aAActwC,EAAE,iBAChBuwC,eAAe,SACf1yC,UAAW6N,EACX5N,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,iBACTwwC,UAAW9kC,EAAQ,kBAAMmV,EAAS/G,sBAAYpO,KAAU,aACxD4J,OAAQtV,EAAE,sDAAD,OAEP+L,cAAuB,WAAa,OAErC,CAAC2kC,UAAS,OAAEhlC,QAAF,IAAEA,OAAF,EAAEA,EAAO5K,UChBV6vC,GAA4D,SAAC,GAEnE,IADNjlC,EACK,EADLA,MACK,EACuBkd,8BAArB/H,EADF,EACEA,SAAUpQ,EADZ,EACYA,QACVzQ,EAAKC,cAALD,EAUP,OACC,cAAC,IAAD,CACCnC,UAAW6N,EACX5N,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,oBACT/B,QAbF,WACC,IAAKyN,EACJ,MAAM,IAAIzH,MAAM,gBAGjB4c,EAASyK,yBAAe5f,EAAO+E,QCdpBmgC,GAAkD,SAAC,GAAa,IAAZllC,EAAW,EAAXA,MAC1DgW,EAAU4gB,cACTtiC,EAAKC,cAALD,EAEP,OACC,cAAC,IAAD,CACCnC,UAAW6N,EACX5N,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,eACT/B,QAAS,kBAAMyjB,EAAQjJ,KAAR,0BAAyB/M,QAAzB,IAAyBA,OAAzB,EAAyBA,EAAOR,S,SCLrC2lC,GAAgD,SAAAlzC,GAAU,IAAD,EAC9D+N,EAAS/N,EAAT+N,MAD8D,EAE5B2Y,4BAAxByF,EAFoD,EAE9DjJ,SAAyB1K,EAFqC,EAErCA,MAFqC,EAGxByS,8BAA5BiB,EAHoD,EAG9DhJ,SAA2BpQ,EAHmC,EAGnCA,QAuBlC,OACC,cAAC,KAAD,CACCoL,aAAY,iBAAEnQ,QAAF,IAAEA,OAAF,EAAEA,EAAOzK,YAAT,QAAiB,GAC7BpD,UAAW6N,EACXoQ,aAAcyE,oBAAU9P,GACxB3S,KAAM,cAAC,IAAD,IACNie,MA3BF,SAAsBS,EAAiBs0B,GACtC,IAAKplC,EACJ,MAAM,IAAIzH,MAAM,kBAGjB4lB,EACCd,sBAAYtY,EAAS/E,EAAO,CAC3BzK,KAAMyK,EAAMzK,KAAN,uBAAiByK,EAAMzK,MAAvB,CAA6Bub,IAAW,CAACA,MAI7Cs0B,GACHhnB,EACCxD,kBAAQ,iBAAD,aAAC,gBACJnQ,EAAM7C,gBADH,kBAELkJ,EAAUs0B,UCpBHC,GAAwD,SAAApzC,GAAU,IAAD,EAClDD,YAAwB,GAD0B,mBACnEsR,EADmE,KAC7D8F,EAD6D,OAEjD8T,8BAAXnY,GAF4D,EAEtEoQ,SAFsE,EAE5DpQ,SAF4D,EAG5B/S,WAAwB,IAHI,mBAGnEy+B,EAHmE,KAGlDC,EAHkD,KAa1E,OAAO,cAAC,KAAD,CACPv+B,UAAU,EACVC,KAAM,cAAC,IAAD,IACNU,MAAO,iBACPuQ,aAAc,WACb+F,GAAQ,IAET9F,KAAMA,EAPC,SAQP,eAAC,IAAD,CAAa5Q,MAAO,CAACiD,MAAM,IAAK0wB,UAAU,IAAKC,UAAU,QAAzD,UACgB,6BAAKvhB,EAAQjQ,KAAI,SAAAkL,GAAK,OACtB,6BACQ,cAAC,KAAD,CAEIlN,MAAOkN,EAAM5K,KACb3B,SAAU,SAAA6B,GAAQ,OAvBjD,SAAsB0K,EAAc1K,GAElCo7B,EADGp7B,EACgB,SAAAs7B,GAAO,6BAAQA,GAAR,CAAiB5wB,KAExB,SAAA4wB,GAAO,OACzBA,EAAQ1zB,QAAO,SAAAqG,GAAK,OAAIA,EAAM/D,KAAOQ,EAAMR,QAkBOqxB,CAAa7wB,EAAO1K,IAC1C1B,MAAO68B,EAAgBt3B,SAAS6G,IAH3BA,EAAMR,WAOvB,eAAC,IAAD,WACf,cAAC,IAAD,CACCrN,UAAU,EACVC,KAAM,cAAC,IAAD,IACNU,MAAO,SACPP,QAAS,WACaN,EAAMs6B,SAASkE,GACfrnB,GAAQ,IAE9B3W,QAAQ,WAET,cAAC,IAAD,CACCL,KAAM,cAAC,IAAD,IACNU,MAAO,SACPP,QAAS,kBAAM6W,GAAQ,eC5CvBqvB,GAAU,uCAAG,WAAO1zB,GAAP,qBAAApH,EAAA,6DACdvI,EAAO,GAELkwC,EAAWvgC,EAAQtH,QAAO,SAACC,EAAQG,GACxCzI,EAAyB,GAAlB2P,EAAQzM,OAAcuF,EAAEzI,KAAKuE,QAAQ,OAAO,IAA5C,UAAqDvE,EAArD,aAA8DyI,EAAEzI,MAAQ,OAAO0E,UAAU,EAAE,IAClG,IAAMqE,EAAM4B,YAAiBlC,GAC7B,OAAIM,EAAI7F,OAAS,EACV,GAAN,oBAAWoF,GAAX,CAAgBS,EAAI,KAEdT,IACN,IAEO26B,EAZS,uCAYoCC,mBACjDz9B,KAAKmB,UAAUspC,EAAS,KAAK,KAbhB,kBAiBXne,KAAQa,KAAK,gBAAgB/T,IAAI,eAAgB,oBAAoBpJ,KAAK,CAACzV,OAAKmwC,MAAMD,IAjB3E,uDAmBjBtqC,QAAQC,IAAI,0CAnBK,SAqBToW,EAAOlN,SAAS0T,cAAc,MAC/BjJ,KAAOypB,EACZhnB,EAAKknB,SAAL,UAAmBnjC,EAAnB,SACAic,EAAKmnB,QAxBU,yDAAH,sDA2BH2I,GAA4C,SAAAlvC,GAAU,IAC3DuzC,EAAiBvzC,EAAjBuzC,cAD0D,EAErCtoB,8BAArB/H,EAF0D,EAE1DA,SAAUpQ,EAFgD,EAEhDA,QAEjB,OACC,eAAC,IAAD,WACC,cAAC,GAAD,IACA,cAAC,GAAD,CAAiB/E,MAAOwlC,IACxB,cAAC,GAAD,CAAgBxlC,MAAOwlC,IACvB,cAAC,GAAD,CACC1kB,gBAAiB/b,EACjBqU,SAAU,SAAAhkB,GAAI,OACb+f,EAASkI,sBAAYtY,EAASygC,EAAgB,CAACpwC,WAEhD4K,MAAOwlC,IAER,cAAC,GAAD,CAAsBxlC,MAAOwlC,IAC7B,cAAC,GAAD,CAAmBxlC,MAAOwlC,IAC1B,cAAC,GAAD,CAAqBjZ,SAAU,SAACxnB,GAAmB0zB,GAAW1zB,U,SCxDpD0gC,GAAyB,WAAO,IACrCnxC,EAAKC,cAALD,EADoC,EAEjBqkB,4BAAnBxD,EAFoC,EAEpCA,SAAU1K,EAF0B,EAE1BA,MAEjB,OACC,cAAC,KAAD,CACCrY,KAAM,cAAC,IAAD,IACN6W,MAAO,CACN,CACCgI,WAAW,EACX1H,QAAiC,SAAxBkB,EAAM/C,cACf5U,MAAOwB,EAAE,uCACT/B,QAAS,kBAAM4iB,EAASyF,kBAAQ,gBAAiB,WAElD,CACC3J,WAAW,EACX1H,QAAiC,SAAxBkB,EAAM/C,cACf5U,MAAOwB,EAAE,uCACT/B,QAAS,kBAAM4iB,EAASyF,kBAAQ,gBAAiB,YAGnD9nB,MAAOwB,EAAE,oCCjBCoxC,GAAkD,SAAAzzC,GAAU,IAAD,EAC7C0mB,4BAAnBxD,EADgE,EAChEA,SAAU1K,EADsD,EACtDA,MACVnW,EAAKC,cAALD,EAEP,OACC,cAAC,KAAD,CACCnC,SAAgC,IAAtBF,EAAMsD,KAAK+C,OACrBlG,KAAM,cAAC,IAAD,IACN6W,MAAK,CACJ,CACCgI,WAAW,EACX1H,QAA6C,IAApCkB,EAAM9C,mBAAmBrP,OAClCxF,MAAOwB,EAAE,2CACT/B,QAAS,kBACR4iB,EAAS,CAAC3hB,KAAM,SAAU4B,KAAM,qBAAsBxB,MAAO,OAE/D,CAAC0V,WAAW,IARR,oBASDrX,EAAMsD,KAAKT,KAAI,SAAAmR,GAAG,MAAK,CACzBgL,WAAW,EACX1H,QAASkB,EAAM9C,mBAAmBxO,SAAS8M,GAC3CnT,MAAOmT,EACP1T,QAAS,kBACR4iB,EAAS,CACR3hB,KAAM,SACN4B,KAAM,qBACNxB,MAAO6W,EAAM9C,mBAAmBxO,SAAS8M,GACtCwE,EAAM9C,mBAAmBzK,QAAO,SAAA5I,GAAC,OAAIA,IAAM2R,KADvC,uBAEAwE,EAAM9C,oBAFN,CAE0B1B,aAIrCnT,MAAOwB,EAAE,wCCnCCklC,GAAwB,WAAO,IACpCz0B,EAAWmY,8BAAXnY,QAEP,OACC,eAAC,IAAD,WACC,cAAC,GAAD,IACA,cAAC,GAAD,CAAiBxP,KAAMsf,oBAAU9P,SCEvB4gC,GAAoD,SAAA1zC,GAAU,IAAD,EAClEw+B,EAAmBx+B,EAAnBw+B,gBACA1rB,EAAWmY,8BAAXnY,QACAzQ,EAAKC,cAALD,EACDkxC,EACsB,IAA3B/U,EAAgBn4B,OAAem4B,EAAgB,QAAK19B,EAErD,OACC,cAAC,EAAD,CACCmkC,eAAgB,cAAC,GAAD,CAAcvhB,MAAO5Q,IACrCoyB,MAAI,mBACF7iC,EAAE,gBAAkB,cAAC,GAAD,CAAckxC,cAAeA,KAD/C,cAEFlxC,EAAE,4BAA8B,cAAC,GAAD,KAF9B,cAGFA,EAAE,gBAAkB,cAAC,GAAD,CAAc0L,MAAOwlC,KAHvC,cAIFlxC,EAAE,eAAiB,cAAC,GAAD,KAJjB,cAKFA,EAAE,kBAAoB,cAAC,GAAD,KALpB,M,OCrBA,SAASsxC,GAAUhyC,GAGzB,IAFA,IAAIqE,EAAS,EAEJO,EAAI,EAAGA,EAAI5E,EAAM0E,OAAQE,IACjCP,GAAUrE,EAAMiyC,WAAWrtC,GAG5B,OAAOP,EAAS,I,WCDJ6tC,GAA4C9zC,QAAW,SAAAC,GAAU,IACtE+N,EAAS/N,EAAT+N,MACD+lC,EAAO,CAACH,GAAU5lC,EAAM5K,OAE9B2wC,EAAKh5B,MAAMg5B,EAAK,GAAK,IAAM,KAC3BA,EAAKh5B,MAAMg5B,EAAK,GAAK,IAAM,KAC3BA,EAAKh5B,MAAMg5B,EAAK,GAAK,IAAM,KAC3BA,EAAKh5B,MAAMg5B,EAAK,GAAK,IAAM,KAC3BA,EAAKh5B,MAAMg5B,EAAK,GAAK,IAAM,KAE3B,IAAIC,EAAOjqC,OAAOkqC,kBACdC,EAAOnqC,OAAOkqC,kBACdE,EAAOpqC,OAAOqqC,kBACdC,EAAOtqC,OAAOqqC,kBASZE,EAPUtmC,EAAMhK,SAASlB,KAAI,SAAAoL,GAAO,MAAK,CAC9ChH,IAAKgH,EAAQ9K,KACb2pC,EAAG7+B,EAAQ/K,KAAO+K,EAAQvK,MAAQ,EAClCspC,EAAG/+B,EAAQxK,IAAMwK,EAAQjL,OAAS,EAClCymC,OAAQvkC,KAAKqoB,IAAItf,EAAQvK,MAAOuK,EAAQjL,YAIvCwI,QACA,SAACxF,EAAQsuC,EAAQxgC,GAIhB,IAAMygC,EAAWD,EAAO7K,OAAS,IAiCjC,OA7BAsK,EAAO7uC,KAAKw6B,IAAIqU,EAAMO,EAAOxH,EAAIyH,GACjCN,EAAO/uC,KAAKw6B,IAAIuU,EAAMK,EAAOtH,EAAIuH,GACjCL,EAAOhvC,KAAKqoB,IAAI2mB,EAAMI,EAAOxH,EAAIyH,GACjCH,EAAOlvC,KAAKqoB,IAAI6mB,EAAME,EAAOtH,EAAIuH,GAEjCvuC,EAAO,GAAG8U,KACT,wBACC/J,GAAIujC,EAAOxH,EACX97B,GAAIsjC,EAAOtH,EAEXriC,EAAG4pC,EACH9zC,MAAO,CACNkP,KAAK,OAAD,OAASmkC,EAAKhgC,EAAQggC,EAAKztC,QAA3B,iBANN,UAGSiuC,EAAOrtC,IAHhB,SAWDjB,EAAO,GAAG8U,KACT,wBACC/J,GAAIujC,EAAOxH,EACX97B,GAAIsjC,EAAOtH,EAEXriC,EAAG2pC,EAAO7K,OACVhpC,MAAO,CACNkP,KAAK,OAAD,OAASmkC,EAAKhgC,EAAQggC,EAAKztC,QAA3B,iBANN,UAGSiuC,EAAOrtC,IAHhB,SAWMjB,IAER,CAAC,GAAI,KAELnD,KAAI,SAACuJ,EAAO0H,GAAR,OACJ,mBAAGpT,UAAS,wBAA6B,IAAVoT,EAAc,KAAO,MAApD,SACE1H,GAD+D0H,MAK7DtE,EAAO,UAAMukC,EAAN,YAAcE,EAAd,YAAsBC,EAAOH,EAA7B,YAAqCK,EAAOH,GAEzD,OACC,qBACCvzC,UAAU,gBACV8O,QAASA,EACTQ,MAAM,6BAHP,SAKEqkC,OC/EEhU,GAAgB,IAAIC,KAAKC,eAAe,IAWjCiU,GAAsC,SAAAx0C,GAAU,IAE3Dy0C,EAOGz0C,EAPHy0C,iBACA/b,EAMG14B,EANH04B,OACAgc,EAKG10C,EALH00C,YACApa,EAIGt6B,EAJHs6B,SACAvsB,EAGG/N,EAHH+N,MACA4H,EAEG3V,EAFH2V,eACGhR,EARuD,aASvD3E,EATuD,iFAUpDqC,EAAKC,cAALD,EAEP,OACC,qBAAK3B,UAAU,aAAaJ,QAASg6B,EAAUiS,cAAe7T,EAA9D,SACC,cAAC,IAAD,6BAAU/zB,GAAV,IAAsBtB,SAAU0K,EAAM1K,SAAtC,SACC,eAAC,IAAD,WACC,sBAAK3C,UAAU,qBAAf,UACC,qBAAKA,UAAU,6BAAf,SACC,cAACmzC,GAAD,CAAc9lC,MAAOA,MAEtB,sBAAKrN,UAAU,0BAAf,UACC,6BAAKqN,EAAM5K,OACX,8BACEd,EAAE,mCAAoC,CACtCu+B,KAAMP,GAAc5xB,OAAOV,EAAMlK,cAElC,uBACCxB,EAAE,oCAAqC,CACvCsgB,MAAO5U,EAAMhK,SAASsC,kBAKzB0H,EAAMzK,MACN,qBAAK5C,UAAU,OAAf,SACEqN,EAAMzK,KAAKT,KAAI,SAAAmR,GAAG,OAClB,cAAC,KAAD,CACC8K,MAAOnJ,EAAe3B,GAEtB7Q,KAAM6Q,EACNiL,cAAe,SAAAH,GAAK,OAAI21B,EAAiBzgC,EAAK8K,IAC9CI,SAAU,kBAAMw1B,EAAY1gC,KAHvBA,iBCvCD2gC,GAAwC,SAAA30C,GAAU,IACvD40C,EAA0B50C,EAA1B40C,cAAe9hC,EAAW9S,EAAX8S,QADuC,EAEpB4T,4BAAxByF,EAF4C,EAEtDjJ,SAAyB1K,EAF6B,EAE7BA,MACf0T,EAAmBzB,uCAA7BvH,SACDa,EAAU4gB,cAEhB,SAAShH,EAAqB9e,EAAiBC,GAC9CqN,EACCxD,kBAAQ,iBAAD,aAAC,gBACJnQ,EAAM7C,gBADH,kBAELkJ,EAAUC,MAad,OACC,mCACC,cAAC,EAAD,CAAW+kB,YAhCI,QAgCf,SACE/wB,EAAQjQ,KAAI,SAAAkL,GAAK,OACjB,cAAC,GAAD,CAEC0mC,iBAAkB9W,EAClBjF,OAAQ,kBAAM3U,EAAQjJ,KAAR,mBAAyB/M,EAAMR,MAC7CmnC,YAAa,SAAAvxC,GAAI,OAhBtB,SAAyB4K,EAAc8Q,GACtCqN,EACCd,sBAAYtY,EAAS/E,EAAO,CAC3BzK,KAAMyK,EAAMzK,KAAK2H,QAAO,SAAA+I,GAAG,OAAIA,IAAQ6K,QAahBg2B,CAAgB9mC,EAAO5K,IAC5Cm3B,SAAU,kBAAMsa,EAAc7mC,IAC9BA,MAAOA,EACP4H,eAAgB6C,EAAM7C,gBANjB5H,EAAMR,YCxBJunC,GAAgC,WAAO,IAClCrF,EAAmBxsB,8BAA7BC,SAD2C,EAEL+H,8BAA5BiB,EAFiC,EAE3ChJ,SAA2BpQ,EAFgB,EAEhBA,QAC3B0F,EAASkO,4BAATlO,MACAu8B,EClBD,WAA6B,IAC5Bv8B,EAASkO,4BAATlO,MAUP,MAAO,CAACu8B,yBARyBh1C,eAAkB,WAClD,OAAIyY,EAAM9D,aAIH5Q,KAAKkxC,MAAQx8B,EAAM5D,aAVC,UAWzB,CAAC4D,EAAM9D,YAAa8D,EAAM5D,gBDSMqgC,GAA5BF,yBACA1yC,EAAKC,cAALD,EAEDm8B,EAAkBz+B,WACvB,kBAAM+S,EAAQ7H,QAAO,SAAA8C,GAAK,OAAIA,EAAM1K,cACpC,CAACyP,IAGIoiC,EAAiBn1C,WAAc,WACpC,IAAMo1C,EACL38B,EAAM9C,mBAAmBrP,OAAS,EAC/ByM,EAAQ7H,QAAO,SAAA8C,GAAK,OACpBA,EAAMzK,KAAK0D,MAAK,SAAAgN,GAAG,OAAIwE,EAAM9C,mBAAmBxO,SAAS8M,SAEzDlB,EAEJ,OAAQ0F,EAAM/C,eACb,IAAK,OACJ,OAAO2/B,KAAOD,EAAiB,eAChC,IAAK,OACJ,OAAOC,KAAOD,EAAiB,WAE/B,CAAC38B,EAAM/C,cAAe+C,EAAM9C,mBAAoB5C,IAkBnD,OAdA/S,aAAgB,WAAO,IAAD,gBACDy+B,GADC,IACrB,2BAAqC,CAAC,IAA3BzwB,EAA0B,QAChCA,EAAM1K,WAAa6xC,EAAehuC,SAAS6G,IAC9Cme,EAAgBuD,wBAAc1hB,KAHX,iCAMnB,CAACywB,EAAiB1rB,EAASoZ,EAAiBgpB,IAE/Cn1C,aAAgB,WACXg1C,KACHtF,EAAgB,CAACluC,KAAM,YAAa+hB,UAAWiH,wBAE9C,CAACklB,EAAiBsF,IAGpB,sBAAKr0C,UAAU,mBAAf,UACC,cAAC,GAAD,CAAkB89B,gBAAiBA,IACnC,cAAC,EAAD,CACCgF,eAAe,cACfC,YAAa,kBAAMvX,EAAgBwD,iCAFpC,SAIC,eAACqU,EAAD,CACC3f,MAAO/hB,EACNmW,EAAM9C,mBAAmBrP,OAAS,EAC/B,oCACA,8BACH,CAACsc,MAAOuyB,EAAe7uC,SALzB,UAQC,cAAC,GAAD,IACA,qBAAK3F,UAAU,UAAf,SACqB,IAAnBoS,EAAQzM,OACR,4BAAIhE,EAAE,gCAEN,cAAC,GAAD,CACCuyC,cAAe,SAAA7mC,GAAK,OACnBme,EAAgByD,sBAAY5hB,GAAO,KAEpC+E,QAASoiC,eAUJG,GAA2B,kBACvC,cAAC,kCAAD,UACC,cAAC,yBAAD,UACC,cAAC,GAAD,SExGI,SAASC,GAAW5vB,UAGlBrX,OAAegtB,kBACfhtB,OAAeknC,WACflnC,OAAemnC,aACfnnC,OAAeonC,mBACfpnC,OAAeqnC,iBACfrnC,OAAesnC,WACftnC,OAAeunC,OAIvB1jC,SAASb,OACTa,SAAS2jC,MAAMnwB,GACfxT,SAASkmB,QCVH,IAAM0d,GAA2B,WAAO,IAAD,EACjB/1C,YAAe,GADE,mBACtCwvC,EADsC,KAC9BC,EAD8B,KAEtC11B,EAAW61B,cAAX71B,QACA7G,EAAgBqyB,IAAhBryB,aAaP,OAXAlT,aAAgB,WAAM,4CACrB,sBAAA2L,EAAA,kEACC4pC,GADD,SACkBriC,EAAa6G,GAD/B,8EADqB,sBAKhBy1B,IACJC,GAAU,GANW,WAAD,wBAOpB/4B,MAEC,CAAC84B,EAAQt8B,EAAc6G,IAEnB,MChBKi8B,GAA4B,WAAO,IAAD,EAClBh2C,YAAe,GADG,mBACvCwvC,EADuC,KAC/BC,EAD+B,KAEvC11B,EAAW61B,cAAX71B,QACA0rB,EAAcF,IAAdE,WAaP,OAXAzlC,aAAgB,WAAM,4CACrB,sBAAA2L,EAAA,kEACC4pC,GADD,SACkB9P,EAAW1rB,GAD7B,8EADqB,sBAKhBy1B,IACJC,GAAU,GANW,WAAD,wBAOpB/4B,MAEC,CAAC84B,EAAQ/J,EAAY1rB,IAEjB,MChBKk8B,GAA2B,WAAO,IAAD,EACjBj2C,YAAe,GADE,mBACtCwvC,EADsC,KAC9BC,EAD8B,OAEhBG,cAAtBx1B,EAFsC,EAEtCA,UAAWL,EAF2B,EAE3BA,QAIX7G,EAAgBqyB,IAAhBryB,aAkBP,OAhBAlT,aAAgB,WAAM,4CACrB,sBAAA2L,EAAA,kEACC4pC,GADD,SAEQriC,EAAa6G,EAAS,CAC3BrG,cAAe,QACfC,QAASyG,IAJZ,8EADqB,sBAUhBo1B,IACJC,GAAU,GAXW,WAAD,wBAYpB/4B,MAEC,CAAC84B,EAAQp1B,EAAWlH,EAAc6G,IAE9B,M,qBCZKm8B,I,OAA0C,SAAAj2C,GAAU,IAE/DkB,EAQGlB,EARHkB,SACA8oB,EAOGhqB,EAPHgqB,MACAksB,EAMGl2C,EANHk2C,UACAC,EAKGn2C,EALHm2C,OACAC,EAIGp2C,EAJHo2C,OACAC,EAGGr2C,EAHHq2C,SACAjyB,EAEGpkB,EAFHokB,MACGzf,EAT2D,aAU3D3E,EAV2D,uEAWxDqC,EAAKC,cAALD,EAEP,OACC,qBAAK3B,UAAU,eAAf,SACC,eAAC,IAAD,6BAAUiE,GAAV,cACC,qBAAKjE,UAAU,qBAAf,SAAqCspB,IACrC,eAAC,IAAD,WACC,6BAAK5F,IACJljB,KAEF,eAAC,IAAD,WACC,cAAC,IAAD,CACCf,KAAM,cAAC,IAAD,IACNK,QAAQ,UACRF,QAAS61C,EACTt1C,MAAOq1C,IAEPG,GACA,cAAC,IAAD,CACCl2C,KAAM,cAAC,IAAD,IACNU,MAAOwB,EAAE,eACT/B,QAAS81C,eC7CHE,GAAU,iBAAM,CAC5B,CACC5wB,KAAM,0BACNsE,MAAO,cAAC,IAAD,IACPksB,UAAW,4BACX9xB,MAAO,gCAER,CACCsB,KAAM,sBACNsE,MAAO,cAAC,IAAD,IACP5F,MAAO,4BAERhW,cACG,CACAsX,KAAM,0BACNsE,MAAO,cAAC,IAAD,IACP5F,MAAO,gCAEP,CACAsB,KAAM,gCACNsE,MAAO,cAAC,IAAD,IACP5F,MAAO,sCAEV,CACCsB,KAAM,sBACNsE,MAAO,cAAC,IAAD,IACPksB,UAAW,+BACX9xB,MAAO,8BCpBImyB,I,OAAyB,WACrC,IAAMC,EAAcz2C,SAA6B,MAC1CmjB,EAAYwD,4BAAZxD,SACDa,EAAU4gB,cAH2B,EAIjB5kC,WAAe,GAJE,mBAIpC02C,EAJoC,KAI7BC,EAJ6B,KAKrCC,EAAW52C,UAAcu2C,GAAS,IAClCM,EAAe72C,WAAc,kBAAM42C,EAASxiB,MAAM,EAAGsiB,KAAQ,CAClEE,EACAF,IAEMp0C,EAAKC,cAALD,EAEPtC,aAAgB,WACf,GAAIy2C,EAAY7X,QAAS,CACxB,IAIc,EAJRkY,EAAWL,EAAY7X,QAAQmY,cACpC,8BAGD,GAAID,EACHE,KAAOtzC,IAAP,UACCyO,SAAS8kC,uBADV,QAC6B9kC,SAASpG,KACpC+qC,EAAyBI,UAC1B,CAACC,SAAU,SAIZ,CAACT,IAEJ,IAAMU,EAAS,WACdj0B,EAASyF,kBAAQ,eAAe,IAChC5E,EAAQjJ,KAAK,MAGRs8B,EAAW,kBAAMV,GAAS,SAAAD,GAAK,OAAIA,EAAQ,MAEjD,OACC,sBAAK/1C,UAAU,gBAAgBT,IAAKu2C,EAApC,UACC,cAACvS,EAAA,EAAD,UACC,gCAAQ5hC,EAAE,oCAEX,qBAAK3B,UAAU,QAAf,SACC,cAAC+rC,GAAA,EAAD,CAAiBnpB,UAAW,KAA5B,SACEszB,EAAa/zC,KAAI,SAACw0C,EAAMvjC,GAAP,OACjB,cAAC44B,GAAA,EAAD,CAAe/rC,WAAW,MAAuB4R,QAAS,IAA1D,SACC,cAAC,GAAD,CACCyX,MAAOqtB,EAAKrtB,MACZksB,UACCmB,EAAKnB,UAAY7zC,EAAEg1C,EAAKnB,WAAa7zC,EAAE,eAExC8zC,OAAQriC,IAAU6iC,EAAStwC,OAAS,EAAI8wC,EAASC,EACjDhB,OAAQe,EACRd,SAAoB,IAAVviC,EACVsQ,MAAO/hB,EAAEg1C,EAAKjzB,OARf,SAUC,qBAAKye,wBAAyB,CAACC,OAAQzgC,EAAEg1C,EAAK3xB,YAXX2xB,EAAKjzB,mBC3CnCkzB,GAAmB,WAAO,IAC/B9+B,EAASkO,4BAATlO,MAOP,OACC,cAAC,IAAD,UACEA,EAAM5C,YACN,eAAC,IAAD,WACC,cAAC,IAAD,CAAO2hC,OAAK,EAACzN,KAAK,IAAlB,SACC,cAAC,GAAD,MAED,cAAC,IAAD,CAAOA,KAAK,iBAAZ,SACC,cAAC,GAAD,MAED,cAAC,IAAD,CAAOA,KAAK,WAAZ,SACC,cAAC,GAAD,MAED,cAAC,IAAD,CAAOA,KAAK,yBAAZ,SACC,cAAC,GAAD,MAED,cAAC,IAAD,CAAOA,KAAK,0BAAZ,SACC,cAAC,GAAD,MAED,cAAC,IAAD,CAAOA,KAAK,oCAAZ,SACC,cAAC,GAAD,MAED,cAAC,IAAD,CAAOA,KAAK,yBAAZ,SACC,cAAC,GAAD,MAED,cAAC,IAAD,CAAOA,KAAK,oBAAZ,SACC,cAAC,GAAD,MAED,cAAC,IAAD,CACCA,KAAK,IACL0N,OAAQ,SAAA1N,GAIP,OAHA/gC,QAAQmG,KAAR,6BACuB46B,EAAKlF,SAASC,SADrC,4BAGO,cAAC,GAAD,UAKV,cAAC,GAAD,O,SChDS4S,GAAwB,SAAC,GAAgB,IAAfv2C,EAAc,EAAdA,SAAc,EACxBnB,YAAe,GADS,mBAC7CwvC,EAD6C,KACrCC,EADqC,OAEpBzvC,YAAe,GAFK,mBAE7C23C,EAF6C,KAEnCC,EAFmC,OAGCjxB,4BAApCyF,EAHmC,EAG7CjJ,SAAgC00B,EAHa,EAGpBp/B,MACf0T,EAAmBjB,8BAA7B/H,SAJ6C,EAQhDiF,mCAFOwf,EANyC,EAMnDzkB,SACS20B,EAP0C,EAOnDt+B,QAPmD,EASbgD,eAAhC/D,EAT6C,EAS7CA,MAAO1F,EATsC,EAStCA,QAASsH,EAT6B,EAS7BA,aA+CvB,OA3CAra,aAAgB,WACVwvC,IACJ5H,EAAgB,CAACpmC,KAAM,OAAQuX,MAAOsB,EAAa3D,SACnD0V,EAAc,CAAC5qB,KAAM,OAAQuX,MAAON,EAAM/B,SAC1CyV,EAAgB,CAAC3qB,KAAM,OAAQuX,MAAOhG,EAAQ2D,SAC9C+4B,GAAU,MAET,CACF7H,EACA4H,EACA/2B,EACA2T,EACArZ,EACAoZ,EACA9R,IAGDra,aAAgB,WACV23C,IACJvrB,EAAc,CAAC5qB,KAAM,WACrBomC,EAAgB,CAACpmC,KAAM,WACvB2qB,EAAgB,CACf3qB,KAAM,SACNsvB,WAAYgnB,EACZ/mB,cAAetX,mCACdq+B,EACAD,EAAWzzC,YAAYhB,KACvBy0C,EAAWzzC,YAAYgL,WAGzBwoC,GAAY,MAEX,CACFhQ,EACAkQ,EACA1rB,EACAyrB,EAAWzzC,YAAYhB,KACvBy0C,EAAWzzC,YAAYgL,QACvBuoC,EACA5kC,EACAoZ,IAGMqjB,GAAUmI,EAAW,mCAAGx2C,IAAe,cAAC,EAAD,K,UC/DxC,SAAS42C,KACf,IAAMC,EAAgBtxB,eAMtB,OAJA1mB,aAAgB,WACfmS,SAASpG,KAAKksC,QAAQ1jC,SAAWyjC,IAC/B,CAACA,IAEG,K,yBCIKE,GAAgB,WAC5B,OACC,cAAC,EAAD,UACC,eAAC,uBAAD,WACC,cAAC,EAAD,IACA,cAACH,GAAD,IACA,cAAC,8BAAD,UACC,cAAC,yBAAD,UACC,cAAC,GAAD,UACC,cAAC,WAAD,CAAgBI,SAAU,cAAC,EAAD,IAA1B,SACC,cAAC,GAAD,kBCnBRC,SACC,cAAC,aAAD,UACC,cAAC,GAAD,MAEDjmC,SAASkmC,eAAe,W","file":"static/js/main.160d2b12.chunk.js","sourcesContent":["export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './stories-context';\nexport * from './stories.types';\nexport * from './zoom';\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './icon-button-link.css';\n\nexport interface IconButtonProps {\n\tbuttonType?: 'button' | 'submit';\n\tdisabled?: boolean;\n\ticon: React.ReactNode;\n\ticonOnly?: boolean;\n\ticonPosition?: 'start' | 'end';\n\tlabel: string;\n\tonClick?: (e: React.MouseEvent) => void;\n\tpreventDefault?: boolean;\n\tvariant?: 'create' | 'danger' | 'primary' | 'secondary';\n\tstyle?: object;\n}\n\nexport const IconButton = React.forwardRef<HTMLButtonElement, IconButtonProps>(\n\t(props, ref) => {\n\t\tconst {\n\t\t\tdisabled,\n\t\t\ticon,\n\t\t\ticonOnly,\n\t\t\ticonPosition = 'start',\n\t\t\tonClick,\n\t\t\tpreventDefault,\n\t\t\tvariant = 'secondary',\n\t\t\tstyle={}\n\t\t} = props;\n\n\t\tconst className = classNames(\n\t\t\t'icon-button',\n\t\t\t`icon-position-${iconPosition}`,\n\t\t\t`variant-${variant}`,\n\t\t\t{'icon-only': iconOnly}\n\t\t);\n\n\t\tconst handleOnClick = (e: React.MouseEvent) => {\n\t\t\tonClick && onClick(e);\n\n\t\t\tif (preventDefault) {\n\t\t\t\te.preventDefault();\n\t\t\t}\n\t\t};\n\n\t\treturn (\n\t\t\t<button\n\t\t\t\taria-label={iconOnly ? props.label : undefined}\n\t\t\t\tdisabled={disabled}\n\t\t\t\tclassName={className}\n\t\t\t\tonClick={handleOnClick}\n\t\t\t\tref={ref}\n\t\t\t\tstyle={style}\n\t\t\t>\n\t\t\t\t<span className=\"icon\">{icon}</span>\n\t\t\t\t{!iconOnly && props.label}\n\t\t\t</button>\n\t\t);\n\t}\n);\n","export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './prefs-context';\nexport * from './prefs.types';\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './button-bar.css';\n\nexport interface ButtonBarProps {\n\torientation?: 'horizontal' | 'vertical';\n}\n\nexport const ButtonBar: React.FC<ButtonBarProps> = props => (\n\t<div\n\t\tclassName={classNames(\n\t\t\t'button-bar',\n\t\t\t`orientation-${props.orientation ?? 'horizontal'}`\n\t\t)}\n\t>\n\t\t{props.children}\n\t</div>\n);\n","import * as React from 'react';\nimport './button-bar-separator.css';\n\nexport const ButtonBarSeparator: React.FC = () => (\n\t<div className=\"button-bar-separator\" />\n);\n","export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './story-formats-context';\nexport * from './story-formats.types';\n","import * as React from 'react';\nimport './card-content.css';\n\nexport interface CardContentProps {\n\tstyle?: object;\n}\n\nexport const CardContent: React.FC<CardContentProps> = (props) => {\n\tconst {style={}, children}= props;\n\treturn <div className=\"card-content\" style={{...style}}>{children}</div>\n}\n","export * from './about-twine';\nexport * from './app-donation';\nexport * from './app-prefs';\nexport * from './context';\nexport * from './context/dialogs';\nexport * from './dialogs.types';\nexport * from './passage-edit';\nexport * from './passage-tags';\nexport * from './story-import';\nexport * from './story-javascript';\nexport * from './story-details';\nexport * from './story-search';\nexport * from './story-stylesheet';\nexport * from './story-tags';\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport { Color} from '../../util/color';\nimport {TextInput} from '../control/text-input';\n\nimport './add-onstart-button.css';\n\nexport interface AddActionProps {\n\t/**\n\t * Called when the user chooses to add a tag. If they are adding a\n\t * pre-existing tag, it will only send a name.\n\t */\n\tonAdd: (name: string, color?: Color) => void;\n}\n\nexport enum Method {\n    POST = 'POST',\n    GET = 'GET',\n    NONE = ''\n}\n\nexport interface Action {\n    action: string | URL\n    delay?:Number\n    params?: string\n    method?: Method\n}\n\n\n\n\nexport const AddActions: React.FC<AddActionProps> = props => {\n\tconst {onAdd} = props;\n\tconst [action, setAction] = React.useState('');\n\tconst {t} = useTranslation();\n\treturn (<TextInput onChange={e => setAction(e.target.value.replace(/\\s/g, '-'))} value={action}>Action</TextInput>);\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport './text-input.css';\n\nexport interface TextInputProps {\n\tonChange?: (event: React.ChangeEvent<HTMLInputElement>) => void;\n\tonInput?: (event: React.FormEvent<HTMLInputElement>) => void;\n\torientation?: 'horizontal' | 'vertical';\n\tplaceholder?: string;\n\ttype?: 'search' | 'text';\n\tvalue: string;\n\tstyle?: object;\n\thelptext?:string;\n}\n\nexport const TextInput: React.FC<TextInputProps> = props => {\n\tconst className = classNames(\n\t\t'text-input',\n\t\t`orientation-${props.orientation}`,\n\t\t`type-${props.type}`\n\t);\n\n\treturn (\n\t\t<>\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t{props.children && <span className=\"text-input-label\">{props.children}</span>}\n\t\t\t\t<input\n\t\t\t\t\tonChange={props.onChange}\n\t\t\t\t\tonInput={props.onInput}\n\t\t\t\t\tplaceholder={props.placeholder}\n\t\t\t\t\ttype={props.type ?? 'text'}\n\t\t\t\t\tvalue={props.value}\n\t\t\t\t\tstyle={props.style || {}}\n\t\t\t\t/>\n\t\t\t</label>\n\t\t</span>\n\t\t{props.helptext && <div style={{fontSize:\"0.8em\", margin:\"5px 0px 0px 100px\"}}>{props.helptext||\"\"}</div>}\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport {useTranslation} from 'react-i18next';\nimport {IconChevronDown, IconChevronUp, IconX} from '@tabler/icons';\nimport {Card} from '../card';\nimport {IconButton} from '../../control/icon-button';\nimport './dialog-card.css';\n\nexport interface DialogCardProps {\n\tclassName?: string;\n\tcollapsed: boolean;\n\tfixedSize?: boolean;\n\theaderLabel: string;\n\tonChangeCollapsed: (value: boolean) => void;\n\tonClose: () => void;\n}\n\nexport const DialogCard: React.FC<DialogCardProps> = props => {\n\tconst {\n\t\tchildren,\n\t\tclassName,\n\t\tcollapsed,\n\t\tfixedSize,\n\t\theaderLabel,\n\t\tonChangeCollapsed,\n\t\tonClose\n\t} = props;\n\tconst {t} = useTranslation();\n\n\tconst calcdClassName = classNames('dialog-card', className, {\n\t\tcollapsed,\n\t\t'fixed-size': fixedSize\n\t});\n\n\treturn (\n\t\t<div aria-label={headerLabel} role=\"dialog\" className={calcdClassName}>\n\t\t\t<Card floating>\n\t\t\t\t<h2>\n\t\t\t\t\t<div className=\"dialog-card-header\">\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={collapsed ? <IconChevronUp /> : <IconChevronDown />}\n\t\t\t\t\t\t\tlabel={headerLabel}\n\t\t\t\t\t\t\tonClick={() => onChangeCollapsed(!collapsed)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"dialog-card-header-controls\">\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\t\ticonOnly\n\t\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</h2>\n\t\t\t\t{!collapsed && children}\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport './dialog-editor.css';\n\nexport const DialogEditor: React.FC = props => (\n\t<div className=\"dialog-editor\">{props.children}</div>\n);\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './text-select.css';\n\nexport interface SelectOption {\n\tdisabled?: boolean;\n\tlabel: string;\n\tvalue: string;\n}\n\nexport interface TextSelectProps {\n\tchildren: React.ReactNode;\n\tonChange?: React.ChangeEventHandler<HTMLSelectElement>;\n\toptions: SelectOption[];\n\torientation?: 'horizontal' | 'vertical';\n\tvalue: string;\n}\n\nexport const TextSelect: React.FC<TextSelectProps> = props => {\n\tconst {children, onChange, options, orientation, value} = props;\n\tconst className = classNames(\n\t\t'text-select',\n\t\t`orientation-${orientation ?? 'horizontal'}`\n\t);\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"text-select-label\">{children}</span>\n\t\t\t\t<span className=\"text-select-control\">\n\t\t\t\t\t<select onChange={onChange} value={value}>\n\t\t\t\t\t\t{options.map(option => (\n\t\t\t\t\t\t\t<option\n\t\t\t\t\t\t\t\tdisabled={option.disabled}\n\t\t\t\t\t\t\t\tkey={option.value}\n\t\t\t\t\t\t\t\tvalue={option.value}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{option.label}\n\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</select>\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","export * from './undoable-stories-context';\nexport * from './undoable-stories.types';\n","import {deviceType} from 'detect-it';\nimport {i18n} from '../../util/i18n';\nimport {Passage, Story} from './stories.types';\n\nexport const passageDefaults = (): Omit<Passage, 'id' | 'story'> => ({\n\theight: 100,\n\thighlighted: false,\n\tleft: 0,\n\tname: i18n.t('store.passageDefaults.name'),\n\tselected: false,\n\ttags: [],\n\ttext: i18n.t(\n\t\tdeviceType === 'touchOnly'\n\t\t\t? 'store.passageDefaults.textClick'\n\t\t\t: 'store.passageDefaults.textTouch'\n\t),\n\ttop: 0,\n\twidth: 100\n});\n\nexport const storyDefaults = (): Omit<Story, 'id'> => ({\n\tifid: '',\n\tlastUpdate: new Date(),\n\tpassages: [],\n\tname: i18n.t('store.storyDefaults.name'),\n\tscript: '',\n\tselected: false,\n\tsnapToGrid: true,\n\tstartPassage: '',\n\tstoryFormat: '',\n\tstoryFormatVersion: '',\n\tstylesheet: '',\n\ttags: [],\n\ttagColors: {},\n\tzoom: 1\n});\n","import * as React from 'react';\nimport {IconSquare, IconSquareCheck} from '@tabler/icons';\nimport {IconButton, IconButtonProps} from './icon-button';\n\nexport interface CheckboxButtonProps\n\textends Omit<IconButtonProps, 'icon' | 'onClick'> {\n\tcheckedIcon?: React.ReactNode;\n\ticon?: React.ReactNode;\n\tonChange: (value: boolean) => void;\n\tuncheckedIcon?: React.ReactNode;\n\tvalue: boolean;\n}\n\nexport const CheckboxButton: React.FC<CheckboxButtonProps> = props => {\n\tconst {\n\t\tcheckedIcon,\n\t\ticon,\n\t\tonChange,\n\t\tuncheckedIcon,\n\t\tvalue,\n\t\t...otherProps\n\t} = props;\n\tconst calculatedIcon = value\n\t\t? checkedIcon ?? <IconSquareCheck />\n\t\t: uncheckedIcon ?? <IconSquare />;\n\n\treturn (\n\t\t<span\n\t\t\taria-disabled={otherProps.disabled}\n\t\t\tclassName=\"checkbox-button\"\n\t\t\trole=\"checkbox\"\n\t\t\taria-checked={value}\n\t\t>\n\t\t\t<IconButton\n\t\t\t\ticon={icon ?? calculatedIcon}\n\t\t\t\tonClick={() => onChange(!value)}\n\t\t\t\t{...otherProps}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","import segseg, {SegSegVector} from 'segseg';\n\nexport interface Point {\n\ttop: number;\n\tleft: number;\n}\n\nexport interface Rect extends Point {\n\theight: number;\n\twidth: number;\n}\n\n/**\n * Returns the angle between two points in degrees.\n * @see https://gist.github.com/conorbuck/2606166\n */\nexport function lineAngle(p1: Point, p2: Point) {\n\treturn (Math.atan2(p2.top - p1.top, p2.left - p1.left) * 180) / Math.PI;\n}\n\n/**\n * Returns the length of the line segment between two points.\n */\nexport function lineDistance(p1: Point, p2: Point) {\n\treturn Math.hypot(p1.left - p2.left, p1.top - p2.top);\n}\n\n/**\n * Returns the center of a rectangle.\n */\nexport function rectCenter(rect: Rect): Point {\n\treturn {left: rect.left + rect.width / 2, top: rect.top + rect.height / 2};\n}\n\n/**\n * Creates a rectangle from two points, regardless of their relative position.\n */\n\nexport function rectFromPoints(p1: Point, p2: Point): Rect {\n\tconst rect: Rect = {height: 0, left: 0, top: 0, width: 0};\n\n\tif (p1.left < p2.left) {\n\t\trect.left = p1.left;\n\t\trect.width = p2.left - p1.left;\n\t} else {\n\t\trect.left = p2.left;\n\t\trect.width = p1.left - p2.left;\n\t}\n\n\tif (p1.top < p2.top) {\n\t\trect.top = p1.top;\n\t\trect.height = p2.top - p1.top;\n\t} else {\n\t\trect.top = p2.top;\n\t\trect.height = p1.top - p2.top;\n\t}\n\n\treturn rect;\n}\n\n/**\n * Returns whether two rectangles intersect.\n * @see http://stackoverflow.com/questions/2752349/fast-rectangle-to-rectangle-intersection\n */\nexport function rectsIntersect(r1: Rect, r2: Rect) {\n\treturn !(\n\t\tr2.left > r1.left + r1.width ||\n\t\tr2.left + r2.width < r1.left ||\n\t\tr2.top > r1.top + r1.height ||\n\t\tr2.top + r2.height < r1.top\n\t);\n}\n\n/**\n * Returns the intersection point between a rectangle and a line segment. If\n * none exists, this returns null.\n */\nexport function rectIntersectionWithLine(\n\trect: Rect,\n\tsegmentStart: Point,\n\tsegmentEnd: Point\n): Point | null {\n\tlet result: SegSegVector = [NaN, NaN];\n\n\t// Left side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top],\n\t\t\t[rect.left, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Right side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left + rect.width, rect.top],\n\t\t\t[rect.left + rect.width, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Top side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top],\n\t\t\t[rect.left + rect.width, rect.top],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Bottom side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top + rect.height],\n\t\t\t[rect.left + rect.width, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\treturn null;\n}\n\n/**\n * Returns a rectangle enclosing a set of rectangles.\n */\nexport function boundingRect(rects: Rect[]) {\n\tif (rects.length === 0) {\n\t\tthrow new Error(\"Can't calculate bounding rect for 0 rects\");\n\t}\n\n\tconst result = {...rects[0]};\n\n\tfor (let i = 1; i < rects.length; i++) {\n\t\tconst right = rects[i].left + rects[i].width;\n\t\tconst bottom = rects[i].top + rects[i].height;\n\n\t\tif (rects[i].left < result.left) {\n\t\t\tresult.left = rects[i].left;\n\t\t}\n\n\t\tif (rects[i].top < result.top) {\n\t\t\tresult.top = rects[i].top;\n\t\t}\n\n\t\tif (result.left + result.width < right) {\n\t\t\tresult.width = right - result.left;\n\t\t}\n\n\t\tif (result.top + result.height < bottom) {\n\t\t\tresult.height = bottom - result.top;\n\t\t}\n\t}\n\n\treturn result;\n}\n","export * from './electron-shared.types';\nexport * from './story-filename';\n","import {Passage, Story} from '../stories';\nimport {StoryFormat} from '../story-formats';\n\nconst trivialPassageProps: (keyof Passage)[] = ['highlighted', 'selected'];\nconst trivialStoryProps: (keyof Story)[] = ['lastUpdate', 'selected'];\n\n// Loosely typing this because of the different load states possible in the type.\nconst trivialStoryFormatProps: string[] = [\n\t'loadError',\n\t'loadState',\n\t'properties',\n\t'selected'\n];\n\n/**\n * Is a passage change persistable? e.g. is it nontrivial?\n */\nexport function isPersistablePassageChange(props: Partial<Passage>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialPassageProps.includes(key as keyof Passage)\n\t);\n}\n\n/**\n * Is a story change persistable? e.g. is it nontrivial?\n */\nexport function isPersistableStoryChange(props: Partial<Story>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialStoryProps.includes(key as keyof Story)\n\t);\n}\n\n/**\n * Is a story format persistable? e.g. is it nontrivial?\n */\nexport function isPersistableStoryFormatChange(props: Partial<StoryFormat>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialStoryFormatProps.includes(key as keyof StoryFormat)\n\t);\n}","import { Speech } from \"../components/onstart/add-speech\";\nimport { Action } from \"../components/onstart/add-actions\";\nimport { Rule } from \"../components/rules/add-button-rules\";\nimport { Method } from \"../components/onstart/add-actions\";\nimport {Story} from '../store/stories';\n\nconst DEFAULTRATE \t= 180;\nconst DEFAULTDELAY \t= 0;\nconst DEFAULTVOICE = \"Daniel\";\n\n\nexport interface Node{\n    type:string,\n    onstart : {\n        actions?:Action[][]\n        speech?:Speech[]\n    }\n    rules : Rule[]\n}\n\nexport interface CaravanAction{\n    params: object,\n    method: any,\n    action: any,\n    delay: any,\n}\n\nconst extractType = (text:string): string=>{\n    const toks = text.split(\"\\n\");\n    for (let i = 0; i < toks.length; i++){\n        if (toks[i].indexOf(\"[type\") != -1){\n            const typetoks = toks[i].split(\":\");\n            if (typetoks.length > 1)\n                return typetoks[1].replace(\"]\",\"\").trim();\n            return \"button\";\n        }\n    }\n    return \"button\";\n}\n\nconst extractOnstart = (text:string) : string=>{\n    if (text.indexOf(\"[onstart]\") !== -1){\n        return text.substring(text.indexOf(\"[onstart]\")).split(\"[rules]\")[0].replace(\"[onstart]\",\"\").trim();\n    }\n    return \"\";\n}\n\nconst extractRulesText = (text:string) : string=>{\n    if (text.indexOf(\"[rules]\") !== -1){\n        return text.substring(text.indexOf(\"[rules]\")).replace(\"[rules]\",\"\").trim();\n    }\n  \n    return \"\";\n}\n\nconst parseSpeechLine = (line:string) : Speech =>{\n    //temporarily replace any commas in speech with special symbol\n    var commasreplaced = line.replace(/\"[^\"]+\"/g, v=>v.replace(/,/g, '#'));\n    const tokens = commasreplaced.replace(\"[speech]\",\"\").replace( /[()]/g,\"\").replace(/[\"]/g,\"\").trim().split(',').map(l=>l.replaceAll(\"#\",\",\"));\n    \n    return {\n        words:tokens.length > 0 ? tokens[0].trim(): \"\", \n        voice:tokens.length > 1 ? tokens[1].trim(): `${DEFAULTVOICE}`,\n        rate:tokens.length  > 2 ? tokens[2].trim(): `${DEFAULTRATE}`, \n        delay:tokens.length > 3 ? tokens[3].trim(): `${DEFAULTDELAY}`\n    }\n}\n\nconst extractParams = (tuplestr:string=\"()\") : Record<string,any>=>{\n    const str = tuplestr.replace( /[(]/g,\"{\").replace(/[)]/g,\"}\");\n    try{\n        return JSON.parse(str);\n    }catch(err){\n        console.log(\"error parsing\", err);\n    }\n    return {};\n}\n\nconst extractParamsString = (str:string)=>{\n    const toks = str.trim().substring(1, str.trim().length-1);\n    const si = toks.indexOf(\"{\");\n    const ei = toks.lastIndexOf(\"}\");\n    return si > -1 && ei > -1 ? toks.substring(si,ei+1) : \"\";\n}\n\nconst formatURL = (str:string)=>{\n    if (str.startsWith(\"http\")){\n        try {\n            return new URL(str);\n        }catch(err){\n\n        }\n    } \n    return str;\n}\n\nconst parseActionLine = (line:string) : Action=>{\n    const params = extractParamsString(line);\n    const toks = line.replace(params,\"\").replace( /[()]/g,\"\").replace(/[\"]/g,\"\").trim().split(',');\n \n\n    if (toks.length > 0){\n        \n        let paramobj = {};\n      \n\n        const paramstr = (params||\"{}\").replace(/[(]/g,\"{\").replace(/[)]/g,\"}\");//.replace(/[']/g,\"\\\"\");\n        \n\n        try{\n            paramobj = JSON.parse(paramstr);\n        }catch(err){\n            paramobj = {parseErr:paramstr}\n        }\n      \n        return {\n            action: formatURL(toks[0]), \n            delay: toks.length > 1 ? Number(toks[1].trim()) : 0, \n            params: toks.length > 2 ? JSON.stringify(paramobj) : \"{}\",\n            method: toks.length > 3 ? toks[2] === \"POST\" ? Method.POST : Method.GET : Method.NONE \n        }\n    }\n    return {action:\"\"}\n}\n\nconst extractSpeech = (text:string) : Speech[]=>{\n    \n    const toks = text.split('\\n');\n    let line = 0;\n    let speech:Speech[] = [];\n\n    const endCondition = (token:string)=>{\n        return token.trim() === \"\" || token.indexOf(\"[\") !== -1;\n    }\n    while (line < toks.length){\n        if (toks[line].trim().startsWith(\"[speech]\")){\n            while (++line < toks.length){\n                if (!endCondition(toks[line])){\n                    speech = [...speech, parseSpeechLine(toks[line])]\n                }else{\n                    break;\n                }\t\n            }\n        }\n        line +=1;\n    }\n    return speech;\n}\n\nconst extractActions = (text:string) : (Action)[][] =>{\n\n\n    const toks = text.split('\\n');\n    let line = 0;\n    let actions:Action[][] = [];\n\n    const endCondition = (token:string)=>{\n        return token.trim() === \"\" || token.trim().startsWith(\"[\");\n    }\n\n   \n    while (line < toks.length){\n       \n        if (toks[line].trim().startsWith(\"[action]\")){\n            let _actions:Action[] = [];\n            while (++line < toks.length){\n              \n                if (!endCondition(toks[line])){\n                    _actions = [..._actions, parseActionLine(toks[line])]\n                }else{\n                    break;\n                }\t\n            }\n            actions = [...actions, _actions]\n           \n        }else{\n            line +=1;\n        }\n    }\n  \n    return actions;\n}\n\nconst parseRuleText = (text:string, type:string) : Rule =>{\n    const [r, actions] = text.split('[actions]');\n    \n    \n    const rtoks = r.replace(\"[[\",\"\").replace(\"]]\",\"\").split(\"|\");\n    const [operand=\"\"] = rtoks[0].trim().split(\" \");\n    const next = rtoks.length > 1 ? rtoks[1] : operand;\n    return  {\n        rule:{\n            operator: type===\"speech\" ? \"contains\" : \"equals\", \n            //operand:  type===\"speech\"? operand.split(\",\").filter(t=>t.trim()!==\"\") : operand,\n            operand:  type===\"speech\"? operand.replace(/\\s+/g,\"\").split(\",\").filter(t=>t.trim()!==\"\") : operand.replace(/\\s+/g,\"\"),\n        },\n        next: next.trim(),//.replace(/\\s+/g,\"\"),\n        actions : extractActions((actions||\"\").trim())\n    }\n}\n\nconst extractRules = (text:string, type:string=\"button\"): Rule[]=>{\n    const toks = text.trim().replace(\"[rules]\",\"\").split('\\n');\n    let line = 0;\n    let rules: Rule[] = [];\n\n    const endCondition = (token:string)=>{\n        return /*token.trim() === \"\" ||*/ token.indexOf(\"[rule\") !== -1;\n    }\n    while (line < toks.length){\n        if (toks[line].trim().startsWith(\"[rule\")){\n            let ruletxt = \"\";\n            const [_,_type] = toks[line].replace(\"[\",\"\").replace(\"]\",\"\").split(\":\");\n           \n            while (++line < toks.length){\n                if (!endCondition(toks[line])){\n                    ruletxt += `\\n${toks[line]}`;\n                }else{\n                    break;\n                }\t\n            }\n            rules = [...rules, parseRuleText(ruletxt.trim(), type)]\n        }else{\n            line +=1;\n        }\n    }\n    return rules;\n}\n\n\n\nconst paramToTuple = (params:any) : string=>{\n    return params;\n}\n\nconst actionToString = (actions:Action[], sep:string='\\t\\t\\t'):string=>{\n    return (actions || []).reduce((acc:string,a:Action)=>{\n        return `${acc}${sep}(\"${a.action}\",\"${a.delay||0}\",\"${paramToTuple(a.params)}\",\"${a.method}\")\\n`\n    },\"\");\n}\n\nconst actionsToString = (actions:Action[][], sep:string='\\t\\t'): string=>{\n    return (actions || []).reduce((acc:string,s:Action[])=>{\n        return `${acc}\\n${sep}[action]\\n${actionToString(s, `${sep}\\t`)}`\n    },\"\");\n}\n\nconst speechFromNode = (node: Node): string=>{\n    return (node.onstart.speech || []).reduce((acc:string,s:Speech)=>{\n        return `${acc}\\t(\"${s.words}\",\"${s.voice}\",\"${s.rate}\",\"${s.delay}\")\\n`\n    },\"\");\n}\n\nconst onStartFromNode = (node:Node):string=>{\n    return `\\t[speech]\\n${speechFromNode(node)}\\n\\n\\t[actions]${actionsToString(node.onstart.actions || [])}`\n}\n\nconst rulesFromNode = (node:Node):string=>{\n    return node.rules.reduce((acc:string, rule:Rule)=>{\n        const actionstr = (rule.actions && rule.actions.length > 0) ? `\\n\\t\\t[actions]${actionsToString(rule.actions, '\\t\\t\\t')}`:\"\";\n        return `${acc}\\n\\t[rule]\\n\\t\\t[[${rule.rule.operand}|${rule.next.trim()}]]${actionstr}`\n    },\"\");\n}\n\n\n /*return [...acc, (rule.actions||[]).reduce((row:string[], arr:Action[][])=>{\n            return arr.reduce((row:string[], item:Action[]))=>{\n                return [...row, \"\"];\n            },[])     \n       },[])]*/\n\n  /*     ...(node.rules || []).reduce((acc:string[], rule:Rule)=>{\n        return [...acc, \"\"];*/\n\nconst extractWordsFromParams = (params:string=\"()\"):string[]=>{\n    const paramobj = extractParams(params);\n    const {body={}} = paramobj;\n    const {speech=[]} = body;\n    \n    return speech.map((w:Record<string,string>) => w.words);\n  \n   \n}\n\nconst extractWordsFromActions = (actions: Action[]):string[]=>{\n    return actions.reduce((acc:string[], action:Action)=>{\n        if (action.action === \"say\"){\n            return [...acc, ...extractWordsFromParams(action.params)]\n        }\n        return acc;\n    },[]);\n}\n\nconst extractWordsFromActionsArray = (actions:Action[][]):string[]=>{\n    return (actions||[]).reduce((acc:string[], arr:Action[])=>{\n        return [...acc, ...extractWordsFromActions(arr)]\n    },[]);\n}\n\nconst extractWordsFromNode = (node:Node, lookup:Record<string,string>|never[]) : (string|undefined)[]=>{\n    const onstartspeechwords  = [...(node.onstart.speech || []).map(s=>s.words)];\n    const onstartactionwords  = [...extractWordsFromActionsArray(node.onstart.actions||[])]\n    const rulewords = (node.rules || []).reduce((acc:string[], rule:Rule)=>{\n        return [...acc, ...extractWordsFromActionsArray(rule.actions)]\n    },[]);\n    return [...onstartspeechwords, ...onstartactionwords, ...rulewords];\n;}\n\nexport function extractWords(passages:string[]){\n    const nodes:Node[] = passages.map(p=>convertToObject(p));\n    let lookup:Record<string,string>|never[] = [];\n\n    return nodes.reduce((acc:(string|undefined)[], node:Node)=>{\n        return [...acc, ...extractWordsFromNode(node,lookup)]\n    },[]);\n\n}\n\nexport function convertToString(node:Node): string{\n    return `[type:${node.type}]\\n\\n[onstart]\\n\\n${onStartFromNode(node)}\\n[rules]\\n${rulesFromNode(node)}`\n}\n\nexport function convertToObject(text:string): Node{\n\n    const type = extractType(text);\n    const onstarttext = extractOnstart(text);\n    const speech = extractSpeech(onstarttext)\n    const actions = extractActions(onstarttext);\n    const rules = extractRules(extractRulesText(text),type);\n    \n    return {\n        type,\n        onstart : {\n            speech,\n            actions\n        },\n        rules\n    }\n}\n\nconst convertToCaravanObject = (_name:string, text:string)=>{\n    const name = _name;//.replace(/\\s+/g,\"\");\n    const type = extractType(text);\n    const onstarttext = extractOnstart(text); \n    const speech = extractSpeech(onstarttext)\n    const actions = extractActions(onstarttext);\n    const rules = extractRules(extractRulesText(text),type);\n\n    const base = {\n        type,\n        name,\n        id:name,\n        subscription: type === \"speech\" ? \"/speech\" : type === \"button\" ? \"/press\" : \"/webhook\",\n        onstart : {\n            speech,\n            actions\n        },\n        rules\n    }\n    if (type===\"speech\"){\n        return base;\n    }\n    return {\n       ...base,\n       data: rules.map(r=>r.rule.operand),\n    }\n}\n\n\nconst simplifyOnstart = (onstart:any)=>{\n    return Object.keys(onstart).reduce((acc, key)=>{\n        if (key === \"speech\" && onstart[key] && onstart[key].length > 0){\n            return {...acc, [key]: onstart[key]}\n        }\n        if (key === \"actions\" && onstart[key].length > 0 && onstart[key][0].length > 0){\n            return {...acc, [key]: onstart[key].map((a:Action[])=>simplifyActions(a))}\n        }\n        return acc;\n    },{})\n}\n\nconst simplifyAction = (a:any)=>{\n    let action = {\n        action: a.action,\n        params: {},\n        method: \"\",\n        delay: 0,\n    };\n\n    if (a.params && Object.keys(a.params).length > 0){\n        action = {\n            ...action,\n            params: JSON.parse(a.params),\n            method: a.method,\n        }\n    }\n    if (a.delay !== undefined && a.delay > 0){\n        action = {\n            ...action,\n            delay: a.delay\n        }\n    }\n    return action;\n}\nconst simplifyActions = (actions:Action[])=>{\n    return actions.map(a=>simplifyAction(a));\n}\n\nconst simplifyRules = (rules:Rule[])=>{\n    return rules.reduce((acc:any, rule)=>{\n        return [...acc,{...rule, actions:rule.actions.map(a=>simplifyActions(a))}]\n    },[]);\n}\n\nconst simplify = (nodes:any)=>{\n    return nodes.map((n:any)=>{\n        return Object.keys(n).reduce((acc, key)=>{\n            if (key === \"onstart\"){\n                return {...acc, onstart:simplifyOnstart(n.onstart)}\n            }\n            if (key === \"rules\"){\n                return {...acc, rules:simplifyRules(n.rules)}\n            }\n            return {...acc, [key]:n[key]}\n        },{});\n    })\n}\n\nexport function convertToCaravan(story?:Story){\n    const {passages, startPassage, name} = story || {};\n   \n    const eligiblePassage = (text:string) : boolean =>{\n        return text.indexOf(\"[onstart]\") !== -1 || text.indexOf(\"[actions]\") !== -1 || text.indexOf(\"[rules]\") !== -1;\n    }\n    let event = \"\";\n\n    const nodes = (passages||[]).reduce((acc:any, passage)=>{\n        if (passage.id === startPassage){\n            event = passage.name;//.replace(/\\s/g, '');\n        }    \n        if (passage.text && (passage.text.replace(/\\s/g, '') !== \"\" && eligiblePassage(passage.text))){\n            return [...acc,convertToCaravanObject(passage.name,passage.text)]\n        }else{\n            return acc;\n        }\n    },[]);\n\n    const root = [{\n        id: name,\n        start: {\n            actions: [[]],\n            event,\n        },\n        events:simplify(nodes),\n    }];\n\n    return root;\n}\n","/**\n * Is this code currently in an Electron renderer process? Returns false if\n * either this is running in the Electron main process, or Electron is not\n * involved at all.\n * @see https://github.com/electron/electron/issues/2288#issuecomment-337858978\n */\nexport const isElectronRenderer = () =>\n\twindow.navigator.userAgent.indexOf('Electron') !== -1;\n\n/**\n * Is this code currently running in an Electron main process? Returns false if\n * either this is running in an Electron renderer process, or Electron is not\n * involved at all.\n * @see https://github.com/electron/electron/issues/2288#issuecomment-611231970\n */\n\nexport const isElectronMain = () => process.versions.hasOwnProperty('electron');\n","import {StoryFormat} from '../../store/story-formats';\nimport {satisfies} from 'semver';\n\n/**\n * Returns editor extensions in a format that fit the Twine version specified.\n * If none are available, then this returns undefined.\n */\nexport function formatEditorExtensions(\n\tformat: StoryFormat,\n\ttwineVersion: string\n) {\n\tif (format.loadState !== 'loaded') {\n\t\treturn;\n\t}\n\n\tif (!format.properties.editorExtensions?.twine) {\n\t\treturn;\n\t}\n\n\tconst extensions = Object.keys(\n\t\tformat.properties.editorExtensions.twine\n\t).filter(semverSpec => satisfies(twineVersion, semverSpec));\n\n\tif (extensions.length === 0) {\n\t\tconsole.info(\n\t\t\t`${format.name} ${format.version} has editor extensions, but none that ${twineVersion} satisfies`\n\t\t);\n\t\treturn;\n\t}\n\n\tif (extensions.length > 1) {\n\t\tconsole.warn(\n\t\t\t`More than one set of editor extensions for ${format.name} ${format.version} is satisfied by ${twineVersion}. Using the first.`\n\t\t);\n\t}\n\n\treturn format.properties.editorExtensions.twine[extensions[0]];\n}\n","import {StoryFormat} from '../../store/story-formats';\n\n/**\n * Returns a namespace prefix for a story format that is compatible with\n * CodeMirror names (modes and commands).\n */\nexport function namespaceForFormat(format: StoryFormat) {\n\treturn format.name.toLowerCase().replace(/\\s/g, '-') + '-' + format.version;\n}\n","import * as React from 'react';\n\nexport const IconEmpty: React.FC = () => (\n\t<svg\n\t\tviewBox=\"0 0 24 24\"\n\t\twidth=\"24\"\n\t\theight=\"24\"\n\t\tstroke=\"currentColor\"\n\t\tstrokeWidth=\"2\"\n\t\tfill=\"none\"\n\t\tstrokeLinecap=\"round\"\n\t\tstrokeLinejoin=\"round\"\n\t></svg>\n);\n","import * as React from 'react';\nimport {IconCircle} from '@tabler/icons';\nimport './loading.css';\n\nexport const IconLoading: React.FC = () => {\n\treturn (\n\t\t<span className=\"icon-loading\">\n\t\t\t<IconCircle />\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\n\nexport const IconTwine: React.FC = () => (\n\t<svg\n\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\txmlnsXlink=\"http://www.w3.org/1999/xlink\"\n\t\tviewBox=\"0 0 1200 1200\"\n\t\twidth=\"1200\"\n\t\theight=\"1200\"\n\t>\n\t\t<defs>\n\t\t\t<linearGradient id=\"b\">\n\t\t\t\t<stop offset=\"0\" stopColor=\"#127aee\" />\n\t\t\t\t<stop offset=\"1\" stopColor=\"#117aef\" stopOpacity=\".251\" />\n\t\t\t</linearGradient>\n\t\t\t<linearGradient id=\"a\">\n\t\t\t\t<stop offset=\"0\" stopColor=\"#10f05e\" stopOpacity=\".251\" />\n\t\t\t\t<stop offset=\"1\" stopColor=\"#10f05e\" />\n\t\t\t</linearGradient>\n\t\t\t<linearGradient\n\t\t\t\txlinkHref=\"#a\"\n\t\t\t\tid=\"d\"\n\t\t\t\tx1=\"52\"\n\t\t\t\ty1=\"604.362\"\n\t\t\t\tx2=\"972\"\n\t\t\t\ty2=\"604.362\"\n\t\t\t\tgradientUnits=\"userSpaceOnUse\"\n\t\t\t/>\n\t\t\t<linearGradient\n\t\t\t\txlinkHref=\"#b\"\n\t\t\t\tid=\"c\"\n\t\t\t\tx1=\"256\"\n\t\t\t\ty1=\"0\"\n\t\t\t\tx2=\"231.987\"\n\t\t\t\ty2=\"725.548\"\n\t\t\t\tgradientUnits=\"userSpaceOnUse\"\n\t\t\t\tgradientTransform=\"translate(0 28.362)\"\n\t\t\t/>\n\t\t</defs>\n\t\t<path\n\t\t\tfill=\"url(#c)\"\n\t\t\td=\"M64 28.362h384v1024H64z\"\n\t\t\ttransform=\"translate(88 59.638)\"\n\t\t/>\n\t\t<path\n\t\t\td=\"M64 860.362c0-704 896-704 896-704v384s-512 0-512 320v192H64z\"\n\t\t\tfill=\"url(#d)\"\n\t\t\ttransform=\"translate(88 59.638)\"\n\t\t/>\n\t</svg>\n);\n","// Fixes a bug in Tabler icons where the zoom out icon is not exported as a\n// React component. This SVG should be an exact copy of what's in the package.\n\nimport * as React from 'react';\n\nexport const IconZoomOut: React.FC = () => (\n\t<svg\n\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\tclassName=\"icon icon-tabler icon-tabler-zoom-out\"\n\t\twidth=\"24\"\n\t\theight=\"24\"\n\t\tviewBox=\"0 0 24 24\"\n\t\tstrokeWidth=\"2\"\n\t\tstroke=\"currentColor\"\n\t\tfill=\"none\"\n\t\tstrokeLinecap=\"round\"\n\t\tstrokeLinejoin=\"round\"\n\t>\n\t\t<path stroke=\"none\" d=\"M0 0h24v24H0z\" fill=\"none\" />\n\t\t<circle cx=\"10\" cy=\"10\" r=\"7\" />\n\t\t<line x1=\"7\" y1=\"10\" x2=\"13\" y2=\"10\" />\n\t\t<line x1=\"21\" y1=\"21\" x2=\"15\" y2=\"15\" />\n\t</svg>\n);\n","export interface AppInfo {\n\tname: string;\n\tversion: string;\n}\n\n/**\n * Retrieves information about the Twine app itself based on buildtime\n * environment\n */\nexport function getAppInfo(): AppInfo {\n\treturn {\n\t\tname: process.env.REACT_APP_NAME as string,\n\t\tversion: process.env.REACT_APP_VERSION as string\n\t};\n}\n","import * as React from 'react';\nimport {usePopper} from 'react-popper';\nimport {CSSTransition} from 'react-transition-group';\nimport {Card} from '../container/card';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './card-button.css';\n\nexport interface CardButtonProps extends Omit<IconButtonProps, 'onClick'> {\n\tonChangeOpen: (value: boolean) => void;\n\topen?: boolean;\n}\n\nexport const CardButton: React.FC<CardButtonProps> = props => {\n\tconst {children, onChangeOpen, open, ...other} = props;\n\tconst [buttonEl, setButtonEl] = React.useState<HTMLButtonElement | null>(\n\t\tnull\n\t);\n\tconst [cardEl, setCardEl] = React.useState<HTMLDivElement | null>(null);\n\tconst {styles, attributes} = usePopper(buttonEl, cardEl, {strategy: 'fixed'});\n\n\tReact.useEffect(() => {\n\t\tconst closer = (event: MouseEvent) => {\n\t\t\tlet target: Node | null = event.target as HTMLElement;\n\n\t\t\twhile (target && target !== cardEl) {\n\t\t\t\ttarget = target.parentNode;\n\t\t\t}\n\n\t\t\tif (target !== cardEl) {\n\t\t\t\tonChangeOpen(false);\n\t\t\t}\n\t\t};\n\n\t\tif (open) {\n\t\t\tdocument.addEventListener('click', closer);\n\t\t\treturn () => document.removeEventListener('click', closer);\n\t\t}\n\t}, [cardEl, onChangeOpen, open, props]);\n\n\treturn (\n\t\t<span className=\"card-button\">\n\t\t\t<IconButton\n\t\t\t\t{...other}\n\t\t\t\tonClick={() => onChangeOpen(!open)}\n\t\t\t\tref={setButtonEl}\n\t\t\t/>\n\t\t\t<CSSTransition\n\t\t\t\tclassNames=\"fade-out\"\n\t\t\t\tin={open}\n\t\t\t\tmountOnEnter\n\t\t\t\ttimeout={200}\n\t\t\t\tunmountOnExit\n\t\t\t>\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"card-button-card\"\n\t\t\t\t\tref={setCardEl}\n\t\t\t\t\tstyle={styles.popper}\n\t\t\t\t\t{...attributes.popper}\n\t\t\t\t>\n\t\t\t\t\t<Card floating>{children}</Card>\n\t\t\t\t</div>\n\t\t\t</CSSTransition>\n\t\t</span>\n\t);\n};\n","import escape from 'lodash/escape';\nimport {Passage, Story} from '../store/stories';\nimport {AppInfo} from './app-info';\nimport {i18n} from './i18n';\n\nexport interface PublishOptions {\n\t/**\n\t * Options that will be passed as-is to the format in the `options` attribute\n\t * of the published `<tw-storydata>` tag.\n\t */\n\tformatOptions?: string;\n\n\t/**\n\t * ID of the passage to start the story at. This overrides what is set at the\n\t * story level.\n\t */\n\tstartId?: string;\n\n\t/**\n\t * If true, publishing will proceed even if the story has no starting passage\n\t * set and one wasn't set manually.\n\t */\n\tstartOptional?: boolean;\n}\n\n/**\n * Returns a filename for an archive file.\n */\nexport function archiveFilename() {\n\tconst timestamp = new Date().toLocaleString().replace(/[/:\\\\]/g, '.');\n\n\treturn i18n.t('store.archiveFilename', {timestamp});\n}\n\n/**\n * Publishes an archive of stories, e.g. all stories in one file with no story\n * format binding.\n */\nexport function publishArchive(stories: Story[], appInfo: AppInfo) {\n\treturn stories.reduce((output, story) => {\n\t\t// Force publishing even if there is no start point set.\n\n\t\treturn (\n\t\t\toutput + publishStory(story, appInfo, {startOptional: true}) + '\\n\\n'\n\t\t);\n\t}, '');\n}\n\n/**\n * Publishes a passage to an HTML fragment. This takes a id argument because\n * passages are numbered sequentially in published stories, not with a UUID.\n */\nexport function publishPassage(passage: Passage, localId: number) {\n\treturn (\n\t\t`<tw-passagedata pid=\"${escape(localId.toString())}\" ` +\n\t\t`name=\"${escape(passage.name)}\" ` +\n\t\t`tags=\"${escape(passage.tags.join(' '))}\" ` +\n\t\t`position=\"${passage.left},${passage.top}\" ` +\n\t\t`size=\"${passage.width},${passage.height}\">` +\n\t\t`${escape(passage.text)}</tw-passagedata>`\n\t);\n}\n\n/**\n * Does a \"naked\" publish of a story -- creating an HTML representation of it,\n * but without any story format binding.\n */\nexport function publishStory(\n\tstory: Story,\n\tappInfo: AppInfo,\n\t{formatOptions, startId, startOptional}: PublishOptions = {}\n) {\n\tstartId = startId ?? story.startPassage;\n\n\t// Verify that the start passage exists.\n\n\tif (!startOptional) {\n\t\tif (!startId) {\n\t\t\tthrow new Error(\n\t\t\t\t'There is no starting point set for this story and none was set manually.'\n\t\t\t);\n\t\t}\n\n\t\tif (!story.passages.find(p => p.id === startId)) {\n\t\t\tthrow new Error(\n\t\t\t\t'The passage set as starting point for this story does not exist.'\n\t\t\t);\n\t\t}\n\t}\n\n\t// The id of the start passage as it is published (*not* a UUID).\n\n\tlet startLocalId;\n\tlet passageData = '';\n\n\tstory.passages.forEach((p, index) => {\n\t\tpassageData += publishPassage(p, index + 1);\n\n\t\tif (p.id === startId) {\n\t\t\tstartLocalId = index + 1;\n\t\t}\n\t});\n\n\tconst tagData = Object.keys(story.tagColors).reduce(\n\t\t(result, tag) =>\n\t\t\tresult +\n\t\t\t`<tw-tag name=\"${escape(tag)}\" color=\"${escape(\n\t\t\t\tstory.tagColors[tag]\n\t\t\t)}\"></tw-tag>`,\n\t\t''\n\t);\n\n\treturn (\n\t\t`<tw-storydata name=\"${escape(story.name)}\" ` +\n\t\t`startnode=\"${startLocalId || ''}\" ` +\n\t\t`creator=\"${escape(appInfo.name)}\" ` +\n\t\t`creator-version=\"${escape(appInfo.version)}\" ` +\n\t\t`format=\"${escape(story.storyFormat)}\" ` +\n\t\t`format-version=\"${escape(story.storyFormatVersion)}\" ` +\n\t\t`ifid=\"${escape(story.ifid)}\" ` +\n\t\t`options=\"${escape(formatOptions)}\"` +\n\t\t`tags=\"${escape(story.tags.join(' '))}\" ` +\n\t\t`zoom=\"${escape(story.zoom.toString())}\" hidden>` +\n\t\t`<style role=\"stylesheet\" id=\"twine-user-stylesheet\" ` +\n\t\t`type=\"text/twine-css\">` +\n\t\tstory.stylesheet +\n\t\t`</style>` +\n\t\t`<script role=\"script\" id=\"twine-user-script\" ` +\n\t\t`type=\"text/twine-javascript\">` +\n\t\tstory.script +\n\t\t`</script>` +\n\t\ttagData +\n\t\tpassageData +\n\t\t`</tw-storydata>`\n\t);\n}\n\n/**\n * Publishes a story and binds it to the source of a story format.\n */\nexport function publishStoryWithFormat(\n\tstory: Story,\n\tformatSource: string,\n\tappInfo: AppInfo,\n\t{formatOptions, startId}: PublishOptions = {}\n) {\n\tif (!formatSource) {\n\t\tthrow new Error('Story format source cannot be empty.');\n\t}\n\n\tlet output = formatSource;\n\n\t// We use function replacements to protect the data from accidental\n\t// interactions with the special string replacement patterns.\n\n\toutput = output.replace(/{{STORY_NAME}}/g, () => escape(story.name));\n\toutput = output.replace(/{{STORY_DATA}}/g, () =>\n\t\tpublishStory(story, appInfo, {formatOptions, startId})\n\t);\n\n\treturn output;\n}\n","export function isValidTagName(value: string) {\n\treturn value.length > 0 && !/\\s/.test(value);\n}\n","import {PrefsState} from './prefs.types';\n\nexport const defaults = (): PrefsState => ({\n\tappTheme: 'light',\n\tcodeEditorFontFamily: 'var(--font-monospaced)',\n\tcodeEditorFontScale: 1,\n\tdisabledStoryFormatEditorExtensions: [],\n\tdonateShown: false,\n\teditorCursorBlinks: true,\n\tfirstRunTime: new Date().getTime(),\n\tlastUpdateSeen: '',\n\tlastUpdateCheckTime: new Date().getTime(),\n\tlocale:\n\t\t(window.navigator as any).userLanguage ||\n\t\twindow.navigator.language ||\n\t\t(window.navigator as any).browserLanguage ||\n\t\t(window.navigator as any).systemLanguage ||\n\t\t'en-us',\n\tpassageEditorFontFamily: 'var(--font-system)',\n\tpassageEditorFontScale: 1,\n\tproofingFormat: {\n\t\tname: 'Paperthin',\n\t\tversion: '1.0.0'\n\t},\n\tstoryFormat: {\n\t\tname: 'Harlowe',\n\t\tversion: '3.2.3'\n\t},\n\tstoryFormatListFilter: 'current',\n\tstoryListSort: 'name',\n\tstoryListTagFilter: [],\n\tstoryTagColors: {},\n\twelcomeSeen: false\n});\n","import i18next from 'i18next';\nimport HttpBackend from 'i18next-http-backend';\nimport {initReactI18next} from 'react-i18next';\n\nexport const i18n = i18next.createInstance();\n\ni18n\n\t.use(HttpBackend)\n\t.use(initReactI18next)\n\t.init({\n\t\tdebug: process.env.NODE_ENV === 'development',\n\t\tbackend: {\n\t\t\tloadPath: `${process.env.PUBLIC_URL}/locales/{{lng}}.json`\n\t\t},\n\t\tfallbackLng: 'en-us',\n\t\tinterpolation: {\n\t\t\tescapeValue: false\n\t\t},\n\t\tload: 'currentOnly'\n\t});\n","import * as React from 'react';\nimport {\n\tControlled as CodeMirror,\n\tIControlledCodeMirror\n} from 'react-codemirror2';\nimport 'codemirror/lib/codemirror.css';\nimport 'codemirror/mode/css/css';\nimport 'codemirror/mode/javascript/javascript';\nimport './code-area.css';\nimport './codemirror-theme.css';\nimport classnames from 'classnames';\n\nexport interface CodeAreaProps extends IControlledCodeMirror {\n\tfontFamily?: string;\n\tfontScale?: number;\n\tlabel: string;\n\tlabelHidden?: boolean;\n\tvalue: string;\n}\n\nexport const CodeArea: React.FC<CodeAreaProps> = props => {\n\tconst {fontFamily, fontScale, label, ...otherProps} = props;\n\tconst style: React.CSSProperties = {};\n\n\tif (fontFamily) {\n\t\tstyle.fontFamily = fontFamily.includes(' ')\n\t\t\t? `\"${fontFamily}\"`\n\t\t\t: fontFamily;\n\t}\n\n\tif (fontScale) {\n\t\tstyle.fontSize = `${fontScale * 100}%`;\n\t}\n\n\treturn (\n\t\t<div className=\"code-area\" style={style}>\n\t\t\t<label>\n\t\t\t\t<span\n\t\t\t\t\tclassName={classnames('label', {\n\t\t\t\t\t\t'screen-reader-only': props.labelHidden\n\t\t\t\t\t})}\n\t\t\t\t>\n\t\t\t\t\t{label}\n\t\t\t\t</span>\n\t\t\t\t<CodeMirror {...otherProps} />\n\t\t\t</label>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {usePopper} from 'react-popper';\nimport {CSSTransition} from 'react-transition-group';\nimport {ButtonBar, ButtonBarSeparator} from '../container/button-bar';\nimport {ButtonCard} from '../container/button-card';\nimport {IconEmpty} from '../image/icon';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './menu-button.css';\nimport {CheckboxButton} from './checkbox-button';\nimport {IconCheck} from '@tabler/icons';\n\nexport interface UncheckableLabeledMenuItem {\n\tdisabled?: boolean;\n\tlabel: string;\n\tonClick: () => void;\n\tseparator?: undefined;\n\tvariant?: IconButtonProps['variant'];\n}\n\nexport interface CheckableLabeledMenuItem extends UncheckableLabeledMenuItem {\n\tcheckable: true;\n\tchecked: boolean;\n}\n\nexport type LabeledMenuItem =\n\t| UncheckableLabeledMenuItem\n\t| CheckableLabeledMenuItem;\n\nexport interface MenuSeparator {\n\tseparator: true;\n}\n\nexport interface MenuButtonProps extends Omit<IconButtonProps, 'onClick'> {\n\titems: (LabeledMenuItem | MenuSeparator)[];\n}\n\nexport const MenuButton: React.FC<MenuButtonProps> = props => {\n\tconst {items, ...other} = props;\n\tconst [buttonEl, setButtonEl] = React.useState<HTMLButtonElement | null>(\n\t\tnull\n\t);\n\tconst [menuEl, setMenuEl] = React.useState<HTMLDivElement | null>(null);\n\tconst [open, setOpen] = React.useState(false);\n\tconst {styles, attributes} = usePopper(buttonEl, menuEl, {strategy: 'fixed'});\n\n\tReact.useEffect(() => {\n\t\tconst closer = () => setOpen(false);\n\n\t\tif (open) {\n\t\t\tdocument.addEventListener('click', closer);\n\t\t}\n\n\t\treturn () => document.removeEventListener('click', closer);\n\t}, [menuEl, open, setOpen]);\n\n\treturn (\n\t\t<span className=\"menu-button\">\n\t\t\t<IconButton\n\t\t\t\t{...other}\n\t\t\t\tonClick={() => setOpen(open => !open)}\n\t\t\t\tref={setButtonEl}\n\t\t\t/>\n\t\t\t<CSSTransition\n\t\t\t\tclassNames=\"fade-out\"\n\t\t\t\tin={open}\n\t\t\t\tmountOnEnter\n\t\t\t\ttimeout={200}\n\t\t\t\tunmountOnExit\n\t\t\t>\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"menu-button-menu\"\n\t\t\t\t\tref={setMenuEl}\n\t\t\t\t\tstyle={styles.popper}\n\t\t\t\t\t{...attributes.popper}\n\t\t\t\t>\n\t\t\t\t\t<ButtonCard floating>\n\t\t\t\t\t\t<ButtonBar orientation=\"vertical\">\n\t\t\t\t\t\t\t{items.map((item, index) => {\n\t\t\t\t\t\t\t\tif (item.separator) {\n\t\t\t\t\t\t\t\t\treturn <ButtonBarSeparator key={index} />;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn 'checkable' in item ? (\n\t\t\t\t\t\t\t\t\t<CheckboxButton\n\t\t\t\t\t\t\t\t\t\tcheckedIcon={<IconCheck />}\n\t\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\t\tonChange={item.onClick}\n\t\t\t\t\t\t\t\t\t\tuncheckedIcon={<IconEmpty />}\n\t\t\t\t\t\t\t\t\t\tvalue={item.checked}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\t\ticon={<IconEmpty />}\n\t\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\t\tonClick={item.onClick}\n\t\t\t\t\t\t\t\t\t\tvariant={item.variant}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t</ButtonBar>\n\t\t\t\t\t</ButtonCard>\n\t\t\t\t</div>\n\t\t\t</CSSTransition>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconCheck, IconX} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton, CardButtonProps} from './card-button';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport {TextInput} from './text-input';\n\nexport interface PromptValidationResponse {\n\tmessage?: string;\n\tvalid: boolean;\n}\n\nexport type PromptButtonValidator = (\n\tvalue: string\n) => PromptValidationResponse | Promise<PromptValidationResponse>;\n\nexport interface PromptButtonProps\n\textends Omit<CardButtonProps, 'onChangeOpen' | 'open'> {\n\tcancelIcon?: React.ReactNode;\n\tcancelLabel?: string;\n\tonChange: React.ChangeEventHandler<HTMLInputElement>;\n\tonSubmit: (value: string) => void;\n\tprompt: string;\n\tsubmitIcon?: React.ReactNode;\n\tsubmitLabel?: string;\n\tsubmitVariant?: IconButtonProps['variant'];\n\tvalidate?: PromptButtonValidator;\n\tvalue: string;\n}\n\nexport const PromptButton: React.FC<PromptButtonProps> = props => {\n\tconst {\n\t\tcancelIcon,\n\t\tcancelLabel,\n\t\tonChange,\n\t\tonSubmit,\n\t\tprompt,\n\t\tsubmitIcon,\n\t\tsubmitLabel,\n\t\tsubmitVariant,\n\t\tvalidate,\n\t\tvalue,\n\t\t...other\n\t} = props;\n\tconst [open, setOpen] = React.useState(false);\n\tconst [\n\t\tvalidation,\n\t\tsetValidation\n\t] = React.useState<PromptValidationResponse>();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tasync function updateValidation() {\n\t\t\tif (validate) {\n\t\t\t\tsetValidation(await validate(value));\n\t\t\t} else {\n\t\t\t\tsetValidation({valid: true});\n\t\t\t}\n\t\t}\n\n\t\tupdateValidation();\n\t}, [validate, value]);\n\n\tfunction handleSubmit() {\n\t\tonSubmit(value);\n\t\tsetOpen(false);\n\t}\n\n\treturn (\n\t\t<span className=\"prompt-button\">\n\t\t\t<CardButton onChangeOpen={setOpen} open={open} {...other}>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<TextInput onChange={onChange} orientation=\"vertical\" value={value}>\n\t\t\t\t\t\t{prompt}\n\t\t\t\t\t</TextInput>\n\t\t\t\t\t{validation?.message && <p>{validation.message}</p>}\n\t\t\t\t</CardContent>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={!validation?.valid}\n\t\t\t\t\t\ticon={submitIcon ?? <IconCheck />}\n\t\t\t\t\t\tlabel={submitLabel ?? t('common.ok')}\n\t\t\t\t\t\tonClick={handleSubmit}\n\t\t\t\t\t\tvariant={submitVariant ?? 'primary'}\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={cancelIcon ?? <IconX />}\n\t\t\t\t\t\tlabel={cancelLabel ?? t('common.cancel')}\n\t\t\t\t\t\tonClick={() => setOpen(false)}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import {PrefsState} from '../../../prefs';\nimport {TwineElectronWindow} from '../../../../electron/shared';\nimport {defaults} from '../../../prefs/defaults';\n\nexport function load(): Partial<PrefsState> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\tconst result: Partial<PrefsState> = {};\n\tconst prefKeys = Object.keys(defaults());\n\n\tif (\n\t\ttwineElectron?.hydrate?.prefs &&\n\t\ttypeof twineElectron.hydrate.prefs === 'object'\n\t) {\n\t\tfor (const key in twineElectron.hydrate.prefs) {\n\t\t\tif (prefKeys.includes(key)) {\n\t\t\t\t(result as any)[key] = twineElectron.hydrate.prefs[key];\n\t\t\t}\n\t\t}\n\t}\n\n\treturn result;\n}\n","import {TwineElectronWindow} from '../../../electron/shared';\n\nexport function saveJson(filename: string, data: any) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\ttwineElectron.ipcRenderer.send('save-json', filename, data);\n}\n","import {PrefsAction, PrefsState} from '../../../prefs';\nimport {saveJson} from '../save-json';\n\n/**\n * A middleware function to save changes to disk. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(state: PrefsState, action: PrefsAction) {\n\tif (action.type === 'repair' || action.type === 'update') {\n\t\tsaveJson('prefs.json', state);\n\t}\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {Story} from '../../../stories/stories.types';\nimport {importStories} from '../../../../util/import';\n\nexport function load(): Story[] {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\t// TODO make this consistent across modules\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tif (\n\t\ttwineElectron?.hydrate?.stories &&\n\t\tArray.isArray(twineElectron.hydrate.stories)\n\t) {\n\t\treturn twineElectron?.hydrate.stories.reduce((result, file) => {\n\t\t\tconst story = importStories(file.htmlSource, file.mtime);\n\n\t\t\tif (story[0]) {\n\t\t\t\treturn [...result, story[0]];\n\t\t\t}\n\n\t\t\tconsole.warn('Could not hydrate story: ', file.htmlSource);\n\t\t\treturn result;\n\t\t}, [] as Story[]);\n\t} else {\n\t\tconsole.warn('No stories to hydrate in Electron bridge');\n\t}\n\n\treturn [];\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {\n\tStoriesAction,\n\tStoriesState,\n\tstoryWithId,\n\tstoryWithName\n} from '../../../stories';\nimport {StoryFormatsState} from '../../../story-formats';\nimport {\n\tisPersistablePassageChange,\n\tisPersistableStoryChange\n} from '../../persistable-changes';\nimport {saveStory} from './save-story';\n\n// When a story is deleted, we need to be able to look up information about it\n// from the last state.\n\nlet lastState: StoriesState;\n\n/**\n * A middleware function to save changes to disk. This should be called *after*\n * the main reducer runs.\n *\n * This has an extra argument: functions to archive and publish a story. This is\n * because the Electron app saves stories in published format.\n */\nexport function saveMiddleware(\n\tstate: StoriesState,\n\taction: StoriesAction,\n\tformats: StoryFormatsState\n) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\tcase 'repair':\n\t\t\t// We take no action here on a repair action. This is to prevent messing up a\n\t\t\t// story's last modified date. If the user then edits the story, we'll save\n\t\t\t// their change and the repair then.\n\t\t\tbreak;\n\n\t\tcase 'createStory':\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t}\n\n\t\t\tsaveStory(storyWithName(state, action.props.name), formats);\n\t\t\tbreak;\n\n\t\tcase 'deleteStory': {\n\t\t\t// We have to look up the story in our saved last state to know what file\n\t\t\t// to delete.\n\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'delete-story',\n\t\t\t\tstoryWithId(lastState, action.storyId)\n\t\t\t);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updateStory':\n\t\t\tif (isPersistableStoryChange(action.props)) {\n\t\t\t\tif (action.props.name) {\n\t\t\t\t\t// The story has been renamed, and we need to process it\n\t\t\t\t\t// specially. We rename the story file, then save it to catch\n\t\t\t\t\t// any other changes.\n\n\t\t\t\t\tconst oldStory = storyWithId(lastState, action.storyId);\n\t\t\t\t\tconst newStory = storyWithId(state, action.storyId);\n\n\t\t\t\t\t// It's crucial that we only respond to this event once. Otherwise,\n\t\t\t\t\t// multiple renames in one session will cause mayhem.\n\n\t\t\t\t\ttwineElectron.ipcRenderer.once('story-renamed', () =>\n\t\t\t\t\t\tsaveStory(newStory, formats)\n\t\t\t\t\t);\n\t\t\t\t\ttwineElectron.ipcRenderer.send('rename-story', oldStory, newStory);\n\t\t\t\t} else {\n\t\t\t\t\t// An ordinary update.\n\n\t\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'createPassage':\n\t\tcase 'createPassages':\n\t\tcase 'deletePassage':\n\t\tcase 'deletePassages':\n\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\tbreak;\n\n\t\tcase 'updatePassage':\n\t\t\t// Skip updates that wouldn't be saved.\n\t\t\tif (isPersistablePassageChange(action.props)) {\n\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'updatePassages':\n\t\t\t// Skip updates that wouldn't be saved.\n\t\t\tif (\n\t\t\t\tObject.keys(action.passageUpdates).some(passageId =>\n\t\t\t\t\tisPersistablePassageChange(action.passageUpdates[passageId])\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tconsole.warn(\n\t\t\t\t`Story action ${\n\t\t\t\t\t(action as any).type\n\t\t\t\t} has no Electron persistence handler`\n\t\t\t);\n\t}\n\n\tlastState = [...state];\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {Story} from '../../../stories';\nimport {publishStory, publishStoryWithFormat} from '../../../../util/publish';\nimport {\n\tformatWithNameAndVersion,\n\tStoryFormatsState\n} from '../../../story-formats';\nimport {getAppInfo} from '../../../../util/app-info';\nimport {fetchStoryFormatProperties} from '../../../../util/story-format/fetch-properties';\n\n/**\n * Sends an IPC message to save a story to disk, ideally in published form.\n */\nexport async function saveStory(story: Story, formats: StoryFormatsState) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\ttry {\n\t\tconst format = formatWithNameAndVersion(\n\t\t\tformats,\n\t\t\tstory.storyFormat,\n\t\t\tstory.storyFormatVersion\n\t\t);\n\n\t\tif (format.loadState === 'loaded') {\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'save-story-html',\n\t\t\t\tstory,\n\t\t\t\tpublishStoryWithFormat(story, format.properties.source, getAppInfo(), {\n\t\t\t\t\tstartOptional: true\n\t\t\t\t})\n\t\t\t);\n\t\t} else {\n\t\t\tconst {source} = await fetchStoryFormatProperties(format.url);\n\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'save-story-html',\n\t\t\t\tstory,\n\t\t\t\tpublishStoryWithFormat(story, source, getAppInfo(), {\n\t\t\t\t\tstartOptional: true\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(\n\t\t\t`Could not save full story (${error.message}). Trying to save story data only.`\n\t\t);\n\t\ttwineElectron.ipcRenderer.send(\n\t\t\t'save-story-html',\n\t\t\tstory,\n\t\t\tpublishStory(story, getAppInfo(), {startOptional: true})\n\t\t);\n\t}\n}\n","import uuid from 'tiny-uuid';\nimport {TwineElectronWindow} from '../../../../electron/shared';\nimport {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport function load(): StoryFormatsState {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (\n\t\t!twineElectron?.hydrate?.storyFormats ||\n\t\t!Array.isArray(twineElectron.hydrate.storyFormats)\n\t) {\n\t\treturn [];\n\t}\n\n\treturn twineElectron.hydrate.storyFormats.map(data => ({\n\t\tid: uuid(),\n\t\tloadState: 'unloaded',\n\t\tname: data.name,\n\t\tselected: false,\n\t\tversion: data.version,\n\t\turl: data.url,\n\t\tuserAdded: data.userAdded\n\t}));\n}\n","import {StoryFormatsAction, StoryFormatsState} from '../../../story-formats';\nimport {isPersistableStoryFormatChange} from '../../persistable-changes';\nimport {saveJson} from '../save-json';\n\n/**\n * A middleware function to save changes to disk. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(\n\tstate: StoryFormatsState,\n\taction: StoryFormatsAction\n) {\n\tconst shouldSave =\n\t\taction.type === 'create' ||\n\t\taction.type === 'delete' ||\n\t\taction.type === 'repair' ||\n\t\t(action.type === 'update' && isPersistableStoryFormatChange(action.props));\n\n\tif (shouldSave) {\n\t\tsaveJson(\n\t\t\t'story-formats.json',\n\t\t\tstate.map(format => ({\n\t\t\t\tid: format.id,\n\t\t\t\tname: format.name,\n\t\t\t\tselected: undefined,\n\t\t\t\tversion: format.version,\n\t\t\t\turl: format.url,\n\t\t\t\tuserAdded: format.userAdded\n\t\t\t}))\n\t\t);\n\t}\n}\n","import {PrefsState} from '../../../prefs';\n\nexport function load(): Partial<PrefsState> {\n\tconst serialized = window.localStorage.getItem('twine-prefs');\n\tconst result: Partial<PrefsState> = {};\n\n\tif (!serialized) {\n\t\treturn {};\n\t}\n\n\tserialized.split(',').forEach(id => {\n\t\ttry {\n\t\t\tconst serializedPref = window.localStorage.getItem(\n\t\t\t\t`twine-prefs-${id}`\n\t\t\t);\n\n\t\t\tif (!serializedPref) {\n\t\t\t\tconsole.warn(`No preference stored at twine-prefs-${id}`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst item = JSON.parse(serializedPref);\n\n\t\t\t(result as any)[item.name] = item.value;\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Preference ${id} had corrupt serialized value, skipping`,\n\t\t\t\twindow.localStorage.getItem(`twine-prefs-${id}`),\n\t\t\t\te\n\t\t\t);\n\t\t}\n\t});\n\n\treturn result;\n}\n","import {PrefsAction, PrefsState} from '../../../prefs';\nimport {save} from './save';\n\nexport function saveMiddleware(state: PrefsState, action: PrefsAction) {\n\tif (action.type === 'repair' || action.type === 'update') {\n\t\tsave(state);\n\t}\n}\n","import uuid from 'tiny-uuid';\nimport {PrefsState} from '../../../prefs';\n\nexport function save(state: PrefsState) {\n\t// Delete existing prefs in local storage, since we aren't bothering to\n\t// preserve IDs.\n\n\tconst previouslySerialized = window.localStorage.getItem('twine-prefs');\n\n\tif (previouslySerialized) {\n\t\tpreviouslySerialized.split(',').forEach(id => {\n\t\t\twindow.localStorage.removeItem(`twine-prefs-${id}`);\n\t\t});\n\t}\n\n\t/* Save new ones. */\n\n\tlet ids: string[] = [];\n\n\tfor (const name in state) {\n\t\tconst id = uuid();\n\n\t\tids.push(id);\n\t\twindow.localStorage.setItem(\n\t\t\t`twine-prefs-${id}`,\n\t\t\tJSON.stringify({\n\t\t\t\tid,\n\t\t\t\tname,\n\t\t\t\tvalue: state[name as keyof PrefsState]\n\t\t\t})\n\t\t);\n\t}\n\n\twindow.localStorage.setItem('twine-prefs', ids.join(','));\n}\n","import {\n\tpassageWithId,\n\tpassageWithName,\n\tStoriesAction,\n\tStoriesState,\n\tstoryWithId,\n\tstoryWithName\n} from '../../../stories';\nimport {isPersistablePassageChange} from '../../persistable-changes';\nimport {\n\tdeletePassageById,\n\tdeleteStory,\n\tdoUpdateTransaction,\n\tsavePassage,\n\tsaveStory\n} from './save';\n\nlet lastState: StoriesState;\n\n/**\n * A middleware function to save changes to local storage. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(state: StoriesState, action: StoriesAction) {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\tcase 'repair':\n\t\t\t// We take no action here on a repair action. This is to prevent messing up a\n\t\t\t// story's last modified date. If the user then edits the story, we'll save\n\t\t\t// their change and the repair then.\n\t\t\tbreak;\n\n\t\tcase 'createPassage': {\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t}\n\n\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\tconst passage = passageWithName(state, story.id, action.props.name);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tsavePassage(transaction, passage);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'createPassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\taction.props.forEach(props => {\n\t\t\t\t\tif (!props.name) {\n\t\t\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t\t\t}\n\n\t\t\t\t\tsavePassage(\n\t\t\t\t\t\ttransaction,\n\t\t\t\t\t\tpassageWithName(state, story.id, props.name)\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'createStory':\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Story was created but with no name specified');\n\t\t\t}\n\n\t\t\tconst story = storyWithName(state, action.props.name);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tstory.passages.forEach(passage => savePassage(transaction, passage));\n\t\t\t});\n\t\t\tbreak;\n\n\t\tcase 'deletePassage': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\t// We can't dig up the passage in question right now, because\n\t\t\t// previousStories is only a shallow copy, and it's gone there at\n\t\t\t// this point in time.\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tdeletePassageById(transaction, action.passageId);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deletePassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\t// See above comment about passages.\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\taction.passageIds.forEach(passageId =>\n\t\t\t\t\tdeletePassageById(transaction, passageId)\n\t\t\t\t);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deleteStory': {\n\t\t\t// The story will be gone from state by the time we're called, so we\n\t\t\t// need a cached copy.\n\n\t\t\tconst story = storyWithId(lastState, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\t// We have to delete all passages, then the story itself.\n\n\t\t\t\tstory.passages.forEach(passage =>\n\t\t\t\t\tdeletePassageById(transaction, passage.id)\n\t\t\t\t);\n\n\t\t\t\tdeleteStory(transaction, story);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updatePassage':\n\t\t\tif (isPersistablePassageChange(action.props)) {\n\t\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\t\tconst passage = passageWithId(state, action.storyId, action.passageId);\n\n\t\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\t\tsaveStory(transaction, story);\n\t\t\t\t\tsavePassage(transaction, passage);\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'updatePassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tObject.keys(action.passageUpdates)\n\t\t\t\t\t.filter(passageId =>\n\t\t\t\t\t\tisPersistablePassageChange(action.passageUpdates[passageId])\n\t\t\t\t\t)\n\t\t\t\t\t.forEach(passageId =>\n\t\t\t\t\t\tsavePassage(\n\t\t\t\t\t\t\ttransaction,\n\t\t\t\t\t\t\tpassageWithId(state, action.storyId, passageId)\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updateStory': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tstory.passages.forEach(passage => savePassage(transaction, passage));\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tdefault:\n\t\t\tconsole.warn(\n\t\t\t\t`Story action ${\n\t\t\t\t\t(action as any).type\n\t\t\t\t} has no local storage persistence handler`\n\t\t\t);\n\t}\n\n\tlastState = state;\n}\n","import {passageDefaults, storyDefaults} from '../../../stories/defaults';\nimport {Passage, Story} from '../../../stories/stories.types';\n\n/**\n * Parses initial state from local storage.\n */\nexport function load(): Story[] {\n\tconst stories: Record<string, Story> = {};\n\tconst serializedStories = window.localStorage.getItem('twine-stories');\n\n\tif (!serializedStories) {\n\t\treturn [];\n\t}\n\n\t// First, deserialize stories. We index them by ID so that we can quickly add\n\t// passages to them as they are deserialized.\n\n\tserializedStories.split(',').forEach(id => {\n\t\tconst serializedStory = window.localStorage.getItem(`twine-stories-${id}`);\n\n\t\tif (!serializedStory) {\n\t\t\tconsole.warn(\n\t\t\t\t`Story list contained ID ${id}, but twine-stories-${id} does not exist, skipping`\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst story: Story = JSON.parse(serializedStory);\n\n\t\t\tif (!story.id) {\n\t\t\t\tconsole.warn('Story in local storage had no ID, skipping', story);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tstories[story.id] = {\n\t\t\t\t...storyDefaults(),\n\t\t\t\t...story,\n\n\t\t\t\t// Coerce lastUpdate to a date.\n\t\t\t\tlastUpdate: story.lastUpdate\n\t\t\t\t\t? new Date(Date.parse((story.lastUpdate as unknown) as string))\n\t\t\t\t\t: new Date(),\n\n\t\t\t\t// Force the passages property to be an empty array -- we'll populate it\n\t\t\t\t// when we load passages below.\n\t\t\t\tpassages: []\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Could not parse story as JSON, skipping: ${serializedStory}`\n\t\t\t);\n\t\t}\n\t});\n\n\t// Then create passages, adding them to their parent story.\n\n\tconst serializedPassages = window.localStorage.getItem('twine-passages');\n\n\tif (serializedPassages) {\n\t\tserializedPassages.split(',').forEach(id => {\n\t\t\tconst serializedPassage = window.localStorage.getItem(\n\t\t\t\t`twine-passages-${id}`\n\t\t\t);\n\n\t\t\tif (!serializedPassage) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Passage list contained ID ${id}, but twine-passages-${id} does not exist, skipping`\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst passage: Passage = JSON.parse(serializedPassage);\n\n\t\t\t\tif (!passage || !passage.story) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`Passage ${id} did not have parent story ID, skipping`,\n\t\t\t\t\t\tpassage\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!stories[passage.story]) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`Passage ${id} is orphaned (looking for story ID ${passage.story}), skipping`\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tstories[passage.story].passages.push({\n\t\t\t\t\t...passageDefaults,\n\t\t\t\t\t...passage,\n\n\t\t\t\t\t// Remove empty tags.\n\t\t\t\t\ttags: passage.tags ? passage.tags.filter(t => t.trim() !== '') : []\n\t\t\t\t});\n\t\t\t} catch (e) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Could not parse passage as JSON, skipping: ${serializedPassage}`\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\t}\n\n\t// Flatten the stories object.\n\treturn Object.values(stories);\n}\n","// Lightweight functions for dealing with comma-delimited strings (e.g. that don't\n// deal with all the intracacies of dealing with the actual CSV format, e.g.\n// quotation marks).\n\n/**\n * Returns whether a list contains a value.\n */\nexport function contains(list: string, value: string) {\n\treturn new RegExp('\\\\b' + value + '\\\\b').test(list);\n}\n\n/**\n * Adds a value to a list if it's not already present.\n */\nexport function addUnique(list: string, value: string) {\n\tif (list === '') {\n\t\treturn value;\n\t}\n\n\tif (contains(list, value)) {\n\t\treturn list;\n\t}\n\n\treturn list + ',' + value;\n}\n\n/**\n * Removes a value from a list.\n */\nexport function remove(list: string, value: string) {\n\tlist = list.replace(new RegExp(',?' + value), '');\n\n\t// We end up with a leading comma if we just removed the first value.\n\n\tif (list[0] === ',') {\n\t\treturn list.substring(1);\n\t}\n\n\treturn list;\n}\n","// Functions for moving stories into local storage. This module in particular\n// needs to remain well-optimized, as it has a direct effect on load time. As a\n// result, saving requires that you start and end a transaction manually. This\n// minimizes the number of writes to local storage.\n\nimport {Passage, Story} from '../../../stories/stories.types';\nimport {addUnique, remove} from '../comma-list';\n\nexport interface StorageTransaction {\n\tpassageIds: string;\n\tstoryIds: string;\n}\n\nexport type StorageUpdater = (transaction: StorageTransaction) => void;\n\n/**\n * A wrapper for a series of save/delete operations. This takes a function as\n * argument that will receive an object keeping track of the transaction. This\n * function should then make save and delete calls as necessary, passing the\n * provided transaction object as their first argument.\n */\nexport function doUpdateTransaction(updater: StorageUpdater) {\n\tconst transaction = {\n\t\tpassageIds: window.localStorage.getItem('twine-passages') ?? '',\n\t\tstoryIds: window.localStorage.getItem('twine-stories') ?? ''\n\t};\n\n\tupdater(transaction);\n\n\twindow.localStorage.setItem('twine-stories', transaction.storyIds);\n\twindow.localStorage.setItem('twine-passages', transaction.passageIds);\n}\n\n/**\n * Saves a story to local storage. This does *not* affect any child passages.\n **/\nexport function saveStory(transaction: StorageTransaction, story: Story) {\n\tif (!story.id) {\n\t\tthrow new Error('Story has no ID');\n\t}\n\n\ttransaction.storyIds = addUnique(transaction.storyIds, story.id);\n\n\t// We have to remove the passages property before serializing the story,\n\t// as those are serialized under separate keys.\n\n\twindow.localStorage.setItem(\n\t\t`twine-stories-${story.id}`,\n\t\tJSON.stringify({...story, passages: undefined})\n\t);\n}\n\n/**\n * Deletes a story from local storage. This does *not* affect any child\n * passages. You *must* delete child passages manually.\n */\nexport function deleteStory(transaction: StorageTransaction, story: Story) {\n\tif (!story.id) {\n\t\tthrow new Error('Story has no ID');\n\t}\n\n\ttransaction.storyIds = remove(transaction.storyIds, story.id);\n\twindow.localStorage.removeItem(`twine-stories-${story.id}`);\n}\n\n/**\n * Saves a passage to local storage.\n */\nexport function savePassage(transaction: StorageTransaction, passage: Passage) {\n\tif (!passage.id) {\n\t\tthrow new Error('Passage has no ID');\n\t}\n\n\ttransaction.passageIds = addUnique(transaction.passageIds, passage.id);\n\twindow.localStorage.setItem(\n\t\t`twine-passages-${passage.id}`,\n\t\tJSON.stringify(passage)\n\t);\n}\n\n/**\n * Deletes a passage from local storage.\n */\nexport function deletePassage(\n\ttransaction: StorageTransaction,\n\tpassage: Passage\n) {\n\tif (!passage.id) {\n\t\tthrow new Error('Passage has no ID');\n\t}\n\n\tdeletePassageById(transaction, passage.id);\n}\n\n/**\n * Deletes a passage from local storage by ID only.\n */\nexport function deletePassageById(\n\ttransaction: StorageTransaction,\n\tpassageId: string\n) {\n\ttransaction.passageIds = remove(transaction.passageIds, passageId);\n\twindow.localStorage.removeItem(`twine-passages-${passageId}`);\n}\n","import {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport function load(): StoryFormatsState {\n\tconst result: StoryFormatsState = [];\n\tconst serialized = window.localStorage.getItem('twine-storyformats');\n\n\tif (!serialized) {\n\t\treturn [];\n\t}\n\n\tserialized.split(',').forEach(id => {\n\t\ttry {\n\t\t\tconst serializedFormat = window.localStorage.getItem(\n\t\t\t\t`twine-storyformats-${id}`\n\t\t\t);\n\n\t\t\tif (!serializedFormat) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`No story format stored at twine-storyformats-${id}, skipping`\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tresult.push({...JSON.parse(serializedFormat), loadState: 'unloaded'});\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Story format ${id} had corrupt serialized value, skipping`,\n\t\t\t\twindow.localStorage.getItem(`twine-storyformats-${id}`)\n\t\t\t);\n\t\t}\n\t});\n\n\treturn result;\n}\n","import uuid from 'tiny-uuid';\nimport {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport function save(state: StoryFormatsState) {\n\t// Delete existing formats in local storage, since we aren't bothering to\n\t// preserve ids.\n\n\tconst previouslySerialized = window.localStorage.getItem(\n\t\t'twine-storyformats'\n\t);\n\n\tif (previouslySerialized) {\n\t\tpreviouslySerialized.split(',').forEach(id => {\n\t\t\twindow.localStorage.removeItem(`twine-storyformats-${id}`);\n\t\t});\n\t}\n\n\t// Save new ones.\n\n\tlet ids: string[] = [];\n\n\tstate.forEach(format => {\n\t\tconst id = uuid();\n\n\t\t// We have to remove the `properties` property if it exists, as that is\n\t\t// dynamically added when loading.\n\n\t\tids.push(id);\n\t\twindow.localStorage.setItem(\n\t\t\t`twine-storyformats-${id}`,\n\t\t\tJSON.stringify({\n\t\t\t\t...format,\n\t\t\t\tloadError: undefined,\n\t\t\t\tloadState: undefined,\n\t\t\t\tproperties: undefined,\n\t\t\t\tselected: undefined\n\t\t\t})\n\t\t);\n\t});\n\n\twindow.localStorage.setItem('twine-storyformats', ids.join(','));\n}\n","import {StoryFormatsAction, StoryFormatsState} from '../../../story-formats';\nimport {isPersistableStoryFormatChange} from '../../persistable-changes';\nimport {save} from './save';\n\n/**\n * A middleware function to save changes to local storage. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(\n\tstate: StoryFormatsState,\n\taction: StoryFormatsAction\n) {\n\tswitch (action.type) {\n\t\tcase 'create':\n\t\tcase 'delete':\n\t\tcase 'repair':\n\t\t\tsave(state);\n\t\t\tbreak;\n\n\t\tcase 'update':\n\t\t\t// Is this a significant update?\n\t\t\tif (isPersistableStoryFormatChange(action.props)) {\n\t\t\t\tsave(state);\n\t\t\t}\n\t\t\tbreak;\n\t}\n}\n","import * as React from 'react';\nimport {useElectronIpcPersistence} from './electron-ipc/use-electron-ipc-persistence';\nimport {useLocalStoragePersistence} from './local-storage/use-local-storage-persistence';\nimport {isElectronRenderer} from '../../util/is-electron';\nimport {StoriesAction, StoriesState} from '../stories';\nimport {StoryFormatsAction, StoryFormatsState} from '../story-formats';\nimport {PrefsAction, PrefsState} from '../prefs';\n\nexport interface PersistenceHooks {\n\tprefs: {\n\t\tload: () => Partial<PrefsState>;\n\t\tsaveMiddleware: (state: PrefsState, action: PrefsAction) => void;\n\t};\n\tstories: {\n\t\tload: () => StoriesState;\n\t\tsaveMiddleware: (\n\t\t\tstate: StoriesState,\n\t\t\taction: StoriesAction,\n\t\t\tformats: StoryFormatsState\n\t\t) => void;\n\t};\n\tstoryFormats: {\n\t\tload: () => StoryFormatsState;\n\t\tsaveMiddleware: (\n\t\t\tstate: StoryFormatsState,\n\t\t\taction: StoryFormatsAction\n\t\t) => void;\n\t};\n}\n\nexport function usePersistence(): PersistenceHooks {\n\tconst electronIpcPersistence = useElectronIpcPersistence();\n\tconst localStoragePersistence = useLocalStoragePersistence();\n\n\treturn React.useMemo(\n\t\t() =>\n\t\t\tisElectronRenderer() ? electronIpcPersistence : localStoragePersistence,\n\t\t[electronIpcPersistence, localStoragePersistence]\n\t);\n}\n","import * as React from 'react';\nimport * as prefs from './prefs';\nimport * as stories from './stories';\nimport * as storyFormats from './story-formats';\n\nexport function useElectronIpcPersistence() {\n\treturn React.useMemo(\n\t\t() => ({\n\t\t\tprefs: {\n\t\t\t\tload: prefs.load,\n\t\t\t\tsaveMiddleware: prefs.saveMiddleware\n\t\t\t},\n\t\t\tstories: {\n\t\t\t\tload: stories.load,\n\t\t\t\tsaveMiddleware: stories.saveMiddleware\n\t\t\t},\n\t\t\tstoryFormats: {\n\t\t\t\tload: storyFormats.load,\n\t\t\t\tsaveMiddleware: storyFormats.saveMiddleware\n\t\t\t}\n\t\t}),\n\t\t[]\n\t);\n}\n","import * as React from 'react';\nimport * as prefs from './prefs';\nimport * as stories from './stories';\nimport * as storyFormats from './story-formats';\n\nexport function useLocalStoragePersistence() {\n\treturn React.useMemo(\n\t\t() => ({\n\t\t\tprefs: {\n\t\t\t\tload: prefs.load,\n\t\t\t\tsaveMiddleware: prefs.saveMiddleware\n\t\t\t},\n\t\t\tstories: {\n\t\t\t\tload: stories.load,\n\t\t\t\tsaveMiddleware: stories.saveMiddleware\n\t\t\t},\n\t\t\tstoryFormats: {\n\t\t\t\tload: storyFormats.load,\n\t\t\t\tsaveMiddleware: storyFormats.saveMiddleware\n\t\t\t}\n\t\t}),\n\t\t[]\n\t);\n}\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './icon-button-link.css';\n\nexport interface IconLinkProps {\n\thref: string;\n\ticon: React.ReactNode;\n\tlabel: string;\n\tvariant?: 'create' | 'danger' | 'primary' | 'secondary';\n\ttarget?: string;\n}\n\nexport const IconLink: React.FC<IconLinkProps> = props => {\n\tconst {href, icon, label, target, variant} = props;\n\tconst className = classNames('icon-link', `variant-${variant}`);\n\n\treturn (\n\t\t<a href={href} className={className} target={target ?? '_blank'}>\n\t\t\t<span className=\"icon\">{icon}</span>\n\t\t\t{label}\n\t\t</a>\n\t);\n};\n","// Manages requesting a story format via URL. There are two aspects that add\n// complexity:\n//\n// - The difference between web and Electron contexts. In a web context, the app is\n//   able to make JSON requests freely. In Electron contexts, however, it is\n//   restricted to HTTP/HTTPS only. To allow users to add story formats via\n//   file:/// URL, the main process will make JSONP requests on behalf of a web\n//   process.\n//\n//   This is only needed for requests outside the app bundle (e.g. loading a locale\n//   or an external story format).\n//\n// - Throttling requests. Because all story formats load via the same global\n//   callback, we can only load one at a time safely--otherwise they will compete\n//   for the same callback.\n\nimport jsonp from 'jsonp';\nimport {TwineElectronWindow} from '../../electron/shared';\nimport {StoryFormatProperties} from '../../store/story-formats';\nimport {isElectronRenderer} from '../is-electron';\n\nlet requestQueue = Promise.resolve();\n\n/**\n * Fetches a story format's properties via JSONP. If multiple requests are made\n * at once, they will be queued by this function.\n */\nexport async function fetchStoryFormatProperties(\n\turl: string,\n\ttimeout = 2000\n): Promise<StoryFormatProperties> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\tconst jsonpRequester =\n\t\tisElectronRenderer() && twineElectron?.jsonp ? twineElectron.jsonp : jsonp;\n\n\treturn new Promise(\n\t\t(resolve, reject) =>\n\t\t\t(requestQueue = requestQueue.then(\n\t\t\t\t() =>\n\t\t\t\t\tnew Promise(resolveQueue => {\n\t\t\t\t\t\tjsonpRequester(url, {timeout, name: 'storyFormat'}, (err, data) => {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\treject(err);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tresolve(data);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolveQueue();\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t))\n\t);\n}\n","export const builtins = () => [\n\t{\n\t\tname : 'Mundane',\n\t\turl: 'story-formats/mundane/format.js',\n\t\tversion: '0.0.1'\n\t},\n\t{\n\t\tname: 'Chapbook',\n\t\turl: 'story-formats/chapbook-1.2.1/format.js',\n\t\tversion: '1.2.1'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-1.2.4/format.js',\n\t\tversion: '1.2.4'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-2.1.0/format.js',\n\t\tversion: '2.1.0'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-3.2.3/format.js',\n\t\tversion: '3.2.3'\n\t},\n\t{\n\t\tname: 'Paperthin',\n\t\turl: 'story-formats/paperthin-1.0.0/format.js',\n\t\tversion: '1.0.0'\n\t},\n\t{\n\t\tname: 'Snowman',\n\t\turl: 'story-formats/snowman-1.4.0/format.js',\n\t\tversion: '1.4.0'\n\t},\n\t{\n\t\tname: 'Snowman',\n\t\turl: 'story-formats/snowman-2.0.2/format.js',\n\t\tversion: '2.0.2',\n\t\tuserAdded: false\n\t},\n\t{\n\t\tname: 'SugarCube',\n\t\turl: 'story-formats/sugarcube-1.0.35/format.js',\n\t\tversion: '1.0.35'\n\t},\n\t{\n\t\tname: 'SugarCube',\n\t\turl: 'story-formats/sugarcube-2.36.1/format.js',\n\t\tversion: '2.36.1'\n\t}\n];\n","import {useTranslation} from 'react-i18next';\nimport {isElectronRenderer} from '../util/is-electron';\n\nexport function useStoreErrorReporter() {\n\t// We can't use suspense here because we're too high in the component tree--we\n\t// need to report errors as soon as possible, and if prefs fail, we might not\n\t// have i18n initialized.\n\n\tconst {t, ready} = useTranslation('', {useSuspense: false});\n\n\treturn {\n\t\treportError(error: Error, messageKey: string) {\n\t\t\tconsole.error('Twine store error', error);\n\n\t\t\tif (ready) {\n\t\t\t\twindow.alert(\n\t\t\t\t\tt(messageKey, {error: error.message}) +\n\t\t\t\t\t\t' ' +\n\t\t\t\t\t\tt(\n\t\t\t\t\t\t\t`store.errors.${\n\t\t\t\t\t\t\t\tisElectronRenderer() ? 'electron' : 'web'\n\t\t\t\t\t\t\t}Remediation`\n\t\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\twindow.alert(\n\t\t\t\t\t`An error occurred while saving (${error.message}). Reloading or restarting the application may help.`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t};\n}\n","// See https://stackoverflow.com/a/64174790\n\nexport const colors = [\n\t'none',\n\t'red',\n\t'orange',\n\t'yellow',\n\t'green',\n\t'blue',\n\t'purple'\n];\n\nexport type Color = typeof colors[number];\n","import {EditorConfiguration} from 'codemirror';\nimport {PrefsState} from '../store/prefs';\n\n/**\n * Returns baseline CodeMirror options based on user preferences.\n */\nexport function codeMirrorOptionsFromPrefs(\n\tprefs: PrefsState\n): EditorConfiguration {\n\t// Disable overstrike mode.\n\n\tlet result: EditorConfiguration = {\n\t\textraKeys: {\n\t\t\tInsert() {}\n\t\t}\n\t};\n\n\tif (!prefs.editorCursorBlinks) {\n\t\tresult.cursorBlinkRate = 0;\n\t}\n\n\treturn result;\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {colors, Color} from '../../util/color';\nimport {IconPlus, IconX} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton} from '../control/card-button';\nimport {IconButton} from '../control/icon-button';\nimport {TextInput} from '../control/text-input';\nimport {TextSelect} from '../control/text-select';\nimport {isValidTagName} from '../../util/tag';\nimport './add-tag-button.css';\n\nexport interface AddTagButtonProps {\n\t/**\n\t * Tags that have been assigned to this object.\n\t */\n\tassignedTags: string[];\n\t/**\n\t * Is the button disabled?\n\t */\n\tdisabled?: boolean;\n\t/**\n\t * Other tags that have been assigned to this type of object.\n\t */\n\texistingTags: string[];\n\t/**\n\t * Icon for the button.\n\t */\n\ticon?: React.ReactNode;\n\t/**\n\t * Label for the button.\n\t */\n\tlabel?: string;\n\t/**\n\t * Called when the user chooses to add a tag. If they are adding a\n\t * pre-existing tag, it will only send a name.\n\t */\n\tonAdd: (name: string, color?: Color) => void;\n}\n\nexport const AddTagButton: React.FC<AddTagButtonProps> = props => {\n\tconst {assignedTags, disabled, existingTags, icon, label, onAdd} = props;\n\tconst [creatingTag, setCreatingTag] = React.useState(true);\n\tconst [newColor, setNewColor] = React.useState<Color>('none');\n\tconst [newName, setNewName] = React.useState('');\n\tconst [open, setOpen] = React.useState(false);\n\tconst {t} = useTranslation();\n\n\tlet validationMessage: string | undefined = undefined;\n\tlet canAdd = isValidTagName(newName);\n\n\tif (!canAdd && newName !== '') {\n\t\tvalidationMessage = t('components.addTagButton.invalidName');\n\t}\n\n\tif (canAdd && creatingTag) {\n\t\tcanAdd = !existingTags.includes(newName);\n\n\t\tif (!canAdd) {\n\t\t\tvalidationMessage = t('components.addTagButton.alreadyAdded');\n\t\t}\n\t}\n\n\tfunction handleAdd() {\n\t\tif (creatingTag) {\n\t\t\tonAdd(newName, newColor);\n\t\t} else {\n\t\t\tonAdd(newName);\n\t\t}\n\n\t\tsetOpen(false);\n\t}\n\n\tfunction handleSelectChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tconst tagName = event.target.value;\n\n\t\tsetNewName(tagName);\n\t\tsetCreatingTag(tagName === '');\n\t}\n\n\treturn (\n\t\t<span className=\"add-tag-button\">\n\t\t\t<CardButton\n\t\t\t\tdisabled={disabled}\n\t\t\t\ticon={icon ?? <IconPlus />}\n\t\t\t\tlabel={label ?? t('common.tag')}\n\t\t\t\tonChangeOpen={setOpen}\n\t\t\t\topen={open}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<TextSelect\n\t\t\t\t\t\tonChange={handleSelectChange}\n\t\t\t\t\t\toptions={[\n\t\t\t\t\t\t\t{label: t('components.addTagButton.newTag'), value: ''},\n\t\t\t\t\t\t\t...existingTags.map(tag => ({\n\t\t\t\t\t\t\t\tdisabled: assignedTags.includes(tag),\n\t\t\t\t\t\t\t\tlabel: tag,\n\t\t\t\t\t\t\t\tvalue: tag\n\t\t\t\t\t\t\t}))\n\t\t\t\t\t\t]}\n\t\t\t\t\t\tvalue={creatingTag ? '' : newName}\n\t\t\t\t\t>\n\t\t\t\t\t\t{t('components.addTagButton.addLabel')}\n\t\t\t\t\t</TextSelect>\n\t\t\t\t\t{creatingTag && (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<TextInput\n\t\t\t\t\t\t\t\tonChange={e => setNewName(e.target.value.replace(/\\s/g, '-'))}\n\t\t\t\t\t\t\t\tvalue={newName}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{t('components.addTagButton.tagNameLabel')}\n\t\t\t\t\t\t\t</TextInput>\n\t\t\t\t\t\t\t<TextSelect\n\t\t\t\t\t\t\t\tonChange={e => setNewColor(e.target.value)}\n\t\t\t\t\t\t\t\toptions={colors.map(color => ({\n\t\t\t\t\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\t\t\t\t\tvalue: color\n\t\t\t\t\t\t\t\t}))}\n\t\t\t\t\t\t\t\tvalue={newColor}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{t('components.addTagButton.tagColorLabel')}\n\t\t\t\t\t\t\t</TextSelect>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)}\n\t\t\t\t\t{creatingTag && !!validationMessage && <p>{validationMessage}</p>}\n\t\t\t\t</CardContent>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={!canAdd}\n\t\t\t\t\t\ticon={<IconPlus />}\n\t\t\t\t\t\tlabel={t('common.add')}\n\t\t\t\t\t\tonClick={handleAdd}\n\t\t\t\t\t\tvariant=\"create\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.cancel')}\n\t\t\t\t\t\tonClick={() => setOpen(false)}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport {useTranslation} from 'react-i18next';\nimport {IconChevronDown} from '@tabler/icons';\nimport {MenuButton} from '../control/menu-button';\nimport {colors, Color} from '../../util/color';\nimport './tag-button.css';\n\nexport interface TagButtonProps {\n\tcolor?: Color;\n\tname: string;\n\tonChangeColor: (color: Color) => void;\n\tonRemove: () => void;\n}\n\nexport const TagButton: React.FC<TagButtonProps> = props => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<span className={classNames('tag-button', `color-${props.color}`)}>\n\t\t\t<MenuButton\n\t\t\t\ticon={<IconChevronDown />}\n\t\t\t\ticonPosition=\"end\"\n\t\t\t\titems={[\n\t\t\t\t\t...colors.map(color => ({\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: color === 'none' ? !props.color : color === props.color,\n\t\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\t\tonClick: () => props.onChangeColor(color)\n\t\t\t\t\t})),\n\t\t\t\t\t{\n\t\t\t\t\t\tseparator: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('common.remove'),\n\t\t\t\t\t\tonClick: props.onRemove\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tlabel={props.name}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","/*\nParses passage text for links. Optionally, it returns internal links only --\ne.g. those pointing to other passages in a story, not to an external web site.\n*/\n\nimport uniq from 'lodash/uniq';\n\n// The top level regular expression to catch links -- i.e. [[link]].\nconst extractLinkTags = (text: string) => text.match(/\\[\\[.*?\\]\\]/g) || [];\n\n// Links _not_ starting with a protocol, e.g. abcd://.\nconst internalLinks = (link: string) => !/^\\w+:\\/\\/\\/?\\w/i.test(link);\n\n// Links with some text in them.\nconst nonEmptyLinks = (link: string) => link !== '';\n\n// Setter is the second [] block if exists.\nconst removeSetters = (link: string) => {\n\tconst noSetter = getField(link, '][', 0);\n\n\treturn noSetter ?? link;\n};\n\nconst removeEnclosingBrackets = (link: string) =>\n\tlink.substr(2, link.length - 4);\n\n/**\n * Split the link by the separator and return the field in the given index.\n * Negative indices start from the end of the array.\n */\nconst getField = (link: string, separator: string, index: number) => {\n\tconst fields = link.split(separator);\n\n\tif (fields.length === 1) {\n\t\t/* Separator not present. */\n\t\treturn undefined;\n\t}\n\n\treturn index < 0 ? fields[fields.length + index] : fields[index];\n};\n\n// Arrow links:\n// [[display text->link]] format\n// [[link<-display text]] format\n// Interpret the rightmost '->' and the leftmost '<-' as the divider.\n\nconst extractLink = (tagContent: string) => {\n\treturn (\n\t\tgetField(tagContent, '->', -1) ||\n\t\tgetField(tagContent, '<-', 0) ||\n\t\t//  TiddlyWiki links:\n\t\t//  [[display text|link]] format\n\n\t\tgetField(tagContent, '|', -1) ||\n\t\t// [[link]] format\n\t\ttagContent\n\t);\n};\n\n/**\n * Returns a list of unique links in passage source code.\n */\nexport function parseLinks(text: string, internalOnly?: boolean) {\n\t// Link matching regexps ignore setter components, should they exist.\n\n\tlet result = uniq(\n\t\textractLinkTags(text)\n\t\t\t.map(removeEnclosingBrackets)\n\t\t\t.map(removeSetters)\n\t\t\t.map(extractLink)\n\t\t\t.filter(nonEmptyLinks)\n\t);\n\n\tif (internalOnly) {\n\t\tresult = result.filter(internalLinks);\n\t}\n\n\treturn result;\n}\n","import escapeRegExp from 'lodash/escapeRegExp';\nimport {StorySearchFlags} from '../store/stories/stories.types';\n\n/**\n * Creates RegExps using UI-visible settings.\n */\nexport function createRegExp(\n\tsearch: string,\n\tflags: Omit<StorySearchFlags, 'includePassages'>\n) {\n\treturn new RegExp(\n\t\tflags.useRegexes ? search : escapeRegExp(search),\n\t\tflags.matchCase ? 'g' : 'gi'\n\t);\n}\n\n/**\n * Escapes replacement strings if the user didn't intend them to be regexps.\n * @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace#Specifying_a_string_as_a_parameter\n */\nexport function escapeRegExpReplace(source: string) {\n\t// This implementation is a little tricky in that it needs to escape the $s\n\t// itself in the replacement.\n\n\treturn source.replace(/\\$/g, '$$$$');\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconIndentDecrease, IconIndentIncrease} from '@tabler/icons';\nimport {IconButton} from '../control/icon-button';\n\nexport interface IndentButtonsProps {\n\t/**\n\t * CodeMirror instance to interact with.\n\t */\n\teditor?: CodeMirror.Editor;\n}\n\nexport const IndentButtons: React.FC<IndentButtonsProps> = props => {\n\tconst {editor} = props;\n\tconst {t} = useTranslation();\n\n\tfunction execCommand(command: string) {\n\t\teditor?.execCommand(command);\n\t\teditor?.focus();\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!editor}\n\t\t\t\ticon={<IconIndentIncrease />}\n\t\t\t\tlabel={t('components.indentButtons.indent')}\n\t\t\t\tonClick={() => execCommand('indentMore')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!editor}\n\t\t\t\ticon={<IconIndentDecrease />}\n\t\t\t\tlabel={t('components.indentButtons.unindent')}\n\t\t\t\tonClick={() => execCommand('indentLess')}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import escape from 'lodash/escape';\nimport uniq from 'lodash/uniq';\nimport {Passage, StorySearchFlags, Story} from './stories.types';\nimport {createRegExp} from '../../util/regexp';\nimport {parseLinks} from '../../util/parse-links';\n\n/**\n * Returns a passage name and text with matches for a search highlighted with\n * `<mark>` tags. The result should be displayed as HTML with no escaping.\n */\nexport function markPassageMatches(\n\tpassage: Passage,\n\tsearch: string,\n\tflags: StorySearchFlags\n) {\n\tconst {includePassageNames, matchCase, useRegexes} = flags;\n\tconst matcher = createRegExp(search, {matchCase, useRegexes});\n\tconst highlight = (value: string) => `\\ue000${value}\\ue001`;\n\tconst markHighlights = (value: string) =>\n\t\tvalue.replace(/\\ue000/g, '<mark>').replace(/\\ue001/g, '</mark>');\n\n\tlet nameHighlightedHtml = escape(passage.name);\n\tlet textHighlightedHtml = escape(passage.text);\n\n\tif (includePassageNames) {\n\t\tnameHighlightedHtml = markHighlights(\n\t\t\tescape(passage.name.replace(matcher, highlight))\n\t\t);\n\t}\n\n\ttextHighlightedHtml = markHighlights(\n\t\tescape(passage.text.replace(matcher, highlight))\n\t);\n\n\treturn {\n\t\tnameHighlightedHtml,\n\t\ttextHighlightedHtml\n\t};\n}\n\nexport function passageWithId(\n\tstories: Story[],\n\tstoryId: string,\n\tpassageId: string\n) {\n\tconst story = storyWithId(stories, storyId);\n\tconst result = story.passages.find(p => p.id === passageId);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no passage with ID \"${passageId}\" in a story with ID \"${storyId}\".`\n\t);\n}\n\nexport function passageWithName(\n\tstories: Story[],\n\tstoryId: string,\n\tpassageName: string\n) {\n\tconst story = storyWithId(stories, storyId);\n\tconst result = story.passages.find(p => p.name === passageName);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no passage with name \"${passageName}\" in a story with ID \"${storyId}\".`\n\t);\n}\n\n/**\n * Returns connections between passages in a structure optimized for rendering.\n * Connections are divided between draggable and fixed, depending on whether\n * either of their passages are selected (and could be dragged by the user).\n */\nexport function passageConnections(\n\tpassages: Passage[],\n\tconnectionParser?: (text: string) => string[]\n) {\n\tconst parser = connectionParser ?? ((text: string) => parseLinks(text, true));\n\tconst passageMap = new Map(passages.map(p => [p.name, p]));\n\tconst result = {\n\t\tdraggable: {\n\t\t\tbroken: new Set<Passage>(),\n\t\t\tconnections: new Map<Passage, Set<Passage>>(),\n\t\t\tself: new Set<Passage>()\n\t\t},\n\t\tfixed: {\n\t\t\tbroken: new Set<Passage>(),\n\t\t\tconnections: new Map<Passage, Set<Passage>>(),\n\t\t\tself: new Set<Passage>()\n\t\t}\n\t};\n\n\tpassages.forEach(passage =>\n\t\tparser(passage.text).forEach(targetName => {\n\t\t\tif (targetName === passage.name) {\n\t\t\t\t(passage.selected ? result.draggable : result.fixed).self.add(passage);\n\t\t\t} else {\n\t\t\t\tconst targetPassage = passageMap.get(targetName);\n\n\t\t\t\tif (targetPassage) {\n\t\t\t\t\tconst target =\n\t\t\t\t\t\tpassage.selected || targetPassage.selected\n\t\t\t\t\t\t\t? result.draggable\n\t\t\t\t\t\t\t: result.fixed;\n\n\t\t\t\t\tif (target.connections.has(passage)) {\n\t\t\t\t\t\ttarget.connections.get(passage)!.add(targetPassage);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttarget.connections.set(passage, new Set([targetPassage]));\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t(passage.selected ? result.draggable : result.fixed).broken.add(\n\t\t\t\t\t\tpassage\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t);\n\n\treturn result;\n}\n\n/**\n * Returns all passages matching a search criteria. Use\n * `highlightPassageMatches()` to highlight exactly what matched.\n */\nexport function passagesMatchingSearch(\n\tpassages: Passage[],\n\tsearch: string,\n\tflags: StorySearchFlags\n): Passage[] {\n\tif (search === '') {\n\t\treturn [];\n\t}\n\n\tconst {includePassageNames, matchCase, useRegexes} = flags;\n\tconst matcher = createRegExp(search, {matchCase, useRegexes});\n\n\treturn passages.reduce((result, passage) => {\n\t\tif (\n\t\t\tmatcher.test(passage.text) ||\n\t\t\t(includePassageNames && matcher.test(passage.name))\n\t\t) {\n\t\t\treturn [...result, passage];\n\t\t}\n\n\t\treturn result;\n\t}, [] as Passage[]);\n}\n\nexport function storyPassageTags(story: Story) {\n\treturn Array.from(\n\t\tstory.passages.reduce((result, passage) => {\n\t\t\tpassage.tags && passage.tags.forEach(tag => result.add(tag));\n\t\t\treturn result;\n\t\t}, new Set<string>())\n\t).sort();\n}\n\nexport function storyStats(story: Story) {\n\tconst links = story.passages.reduce<string[]>(\n\t\t(links, passage) => [\n\t\t\t...links,\n\t\t\t...parseLinks(passage.text).filter(link => links.indexOf(link) === -1)\n\t\t],\n\t\t[]\n\t);\n\n\tconst brokenLinks = uniq(links).filter(\n\t\tlink => !story.passages.some(passage => passage.name === link)\n\t);\n\n\treturn {\n\t\tbrokenLinks,\n\t\tlinks,\n\t\tcharacters: story.passages.reduce(\n\t\t\t(count, passage) => count + passage.text.length,\n\t\t\t0\n\t\t),\n\t\tpassages: story.passages.length,\n\t\twords: story.passages.reduce(\n\t\t\t(count, passage) => count + passage.text.split(/\\s+/).length,\n\t\t\t0\n\t\t)\n\t};\n}\n\nexport function storyTags(stories: Story[]) {\n\treturn Array.from(\n\t\tstories.reduce((result, story) => {\n\t\t\tstory.tags && story.tags.forEach(tag => result.add(tag));\n\t\t\treturn result;\n\t\t}, new Set<string>())\n\t).sort();\n}\n\nexport function storyWithId(stories: Story[], storyId: string) {\n\tconst result = stories.find(s => s.id === storyId);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story with ID \"${storyId}\".`);\n}\n\nexport function storyWithName(stories: Story[], name: string) {\n\tconst result = stories.find(s => s.name === name);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story with name \"${name}\".`);\n}\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './card.css';\n\nexport interface CardProps {\n\tfloating?: boolean;\n\thighlighted?: boolean;\n\tselected?: boolean;\n}\n\nexport const Card: React.FC<CardProps> = props => {\n\tconst {children, floating, highlighted, selected} = props;\n\n\tconst className = classNames('card', {\n\t\tfloating,\n\t\thighlighted,\n\t\tselected\n\t});\n\n\treturn <div className={className}>{children}</div>;\n};\n","import * as React from 'react';\nimport {useScrollbarSize} from 'react-scrollbar-size';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {useDialogsContext} from '.';\nimport './dialogs.css';\n\nconst DialogTransition: React.FC = props => (\n\t<CSSTransition classNames=\"pop\" timeout={200} {...props}>\n\t\t{props.children}\n\t</CSSTransition>\n);\n\nexport const Dialogs: React.FC = () => {\n\tconst {height, width} = useScrollbarSize();\n\tconst {dispatch, dialogs} = useDialogsContext();\n\n\tconst style: React.CSSProperties = {\n\t\tmarginBottom: height,\n\t\tmarginRight: width\n\t};\n\n\treturn (\n\t\t<div className=\"dialogs\" style={style}>\n\t\t\t<TransitionGroup component={null}>\n\t\t\t\t{dialogs.map((dialog, index) => {\n\t\t\t\t\tconst managementProps = {\n\t\t\t\t\t\tcollapsed: dialog.collapsed,\n\t\t\t\t\t\tonChangeCollapsed: (collapsed: boolean) =>\n\t\t\t\t\t\t\tdispatch({type: 'setDialogCollapsed', collapsed, index}),\n\t\t\t\t\t\tonClose: () => dispatch({type: 'removeDialog', index})\n\t\t\t\t\t};\n\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<DialogTransition key={index}>\n\t\t\t\t\t\t\t<dialog.component {...dialog.props} {...managementProps} />\n\t\t\t\t\t\t</DialogTransition>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</TransitionGroup>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowBack, IconArrowForward} from '@tabler/icons';\nimport {IconButton} from '../control/icon-button';\n\nexport interface UndoRedoButtonsProps {\n\t/**\n\t * CodeMirror instance to interact with.\n\t */\n\teditor?: CodeMirror.Editor;\n\t/**\n\t * A change in this prop triggers a render (probably, put the editor value\n\t * here). This is necessary because the editor instance itself is mutable, so\n\t * we need some way of knowing when to re-check whether undo/redo is availble.\n\t */\n\twatch: string;\n}\n\nexport const UndoRedoButtons: React.FC<UndoRedoButtonsProps> = props => {\n\tconst {editor, watch} = props;\n\tconst {t} = useTranslation();\n\tconst [canRedo, setCanRedo] = React.useState(false);\n\tconst [canUndo, setCanUndo] = React.useState(false);\n\n\tReact.useEffect(() => {\n\t\tif (editor) {\n\t\t\tconst history = editor.historySize();\n\n\t\t\tsetCanRedo(history.redo > 0);\n\t\t\tsetCanUndo(history.undo > 0);\n\t\t} else {\n\t\t\tsetCanRedo(false);\n\t\t\tsetCanUndo(false);\n\t\t}\n\t}, [editor, watch]);\n\n\tfunction execCommand(command: string) {\n\t\teditor?.execCommand(command);\n\t\teditor?.focus();\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!canUndo}\n\t\t\t\ticon={<IconArrowBack />}\n\t\t\t\tlabel={t('common.undo')}\n\t\t\t\tonClick={() => execCommand('undo')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!canRedo}\n\t\t\t\ticon={<IconArrowForward />}\n\t\t\t\tlabel={t('common.redo')}\n\t\t\t\tonClick={() => execCommand('redo')}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {TagColors} from '../../store/stories';\nimport './tag-stripe.css';\n\nexport interface TagStripeProps {\n\ttagColors: TagColors;\n\ttags: string[];\n}\n\nexport const TagStripe: React.FC<TagStripeProps> = React.memo(props => {\n\treturn (\n\t\t<div className=\"tag-stripe\">\n\t\t\t{props.tags.map(tag => (\n\t\t\t\t<span\n\t\t\t\t\tclassName={`color-${props.tagColors[tag]}`}\n\t\t\t\t\tkey={tag}\n\t\t\t\t\ttitle={tag}\n\t\t\t\t/>\n\t\t\t))}\n\t\t</div>\n\t);\n});\n","import * as React from 'react';\nimport isEqual from 'lodash/isEqual';\nimport {DialogsAction, DialogsState} from '../dialogs.types';\n\nexport const reducer: React.Reducer<DialogsState, DialogsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'addDialog':\n\t\t\t// If the dialog has been previously added, expand it. Otherwise, add it\n\t\t\t// to the end.\n\n\t\t\tlet exists = false;\n\t\t\tconst editedState = state.map(stateDialog => {\n\t\t\t\tif (\n\t\t\t\t\tisEqual(stateDialog, {\n\t\t\t\t\t\t// Ignore collapsed property for comparison\n\t\t\t\t\t\tcollapsed: stateDialog.collapsed,\n\t\t\t\t\t\tcomponent: action.component,\n\t\t\t\t\t\tprops: action.props\n\t\t\t\t\t})\n\t\t\t\t) {\n\t\t\t\t\texists = true;\n\t\t\t\t\treturn {...stateDialog, collapsed: false};\n\t\t\t\t}\n\n\t\t\t\treturn stateDialog;\n\t\t\t});\n\n\t\t\tif (exists) {\n\t\t\t\treturn editedState;\n\t\t\t}\n\n\t\t\treturn [\n\t\t\t\t...state,\n\t\t\t\t{component: action.component, collapsed: false, props: action.props}\n\t\t\t];\n\n\t\tcase 'removeDialog':\n\t\t\treturn state.filter((dialog, index) => index !== action.index);\n\n\t\tcase 'setDialogCollapsed':\n\t\t\treturn state.map((dialog, index) =>\n\t\t\t\tindex === action.index\n\t\t\t\t\t? {...dialog, collapsed: action.collapsed}\n\t\t\t\t\t: dialog\n\t\t\t);\n\t}\n};\n","import * as React from 'react';\nimport useThunkReducer, {Thunk} from 'react-hook-thunk-reducer';\nimport {reducer} from './reducer';\nimport {Dialogs} from './dialogs';\nimport {DialogsAction, DialogsState} from '../dialogs.types';\n\nexport interface DialogsContextProps {\n\tdispatch: React.Dispatch<DialogsAction | Thunk<DialogsState, DialogsAction>>;\n\tdialogs: DialogsState;\n}\n\nexport const DialogsContext = React.createContext<DialogsContextProps>({\n\tdispatch: () => {},\n\tdialogs: []\n});\n\nDialogsContext.displayName = 'Dialogs';\n\nexport const useDialogsContext = () => React.useContext(DialogsContext);\n\nexport const DialogsContextProvider: React.FC = props => {\n\tconst [dialogs, dispatch] = useThunkReducer(reducer, []);\n\n\treturn (\n\t\t<DialogsContext.Provider value={{dispatch, dialogs}}>\n\t\t\t{props.children}\n\t\t\t<Dialogs />\n\t\t</DialogsContext.Provider>\n\t);\n};\n","// Handles importing HTML source code into story objects ready to be saved to\n// the store. This works on both published story files and archives.\n//\n// It's important that this code be as efficient as possible, as it directly\n// affects startup time in the Twine desktop app. This module moves data from\n// the filesystem into local storage, and the app can't begin until it's done.\n\nimport defaults from 'lodash/defaults';\nimport uuid from 'tiny-uuid';\nimport {passageDefaults, storyDefaults, Passage, Story} from '../store/stories';\n\n/**\n * An imported story, which may contain incomplete or malformed data.\n */\nexport interface ImportedStory extends Omit<Partial<Story>, 'passages'> {\n\tpassages: Partial<Passage>[];\n}\n\n/**\n * HTML selectors used to find data in HTML format.\n */\nconst selectors = {\n\tpassage: 'tw-passage',\n\tstory: 'tw-story',\n\tscript: '[role=script]',\n\tstylesheet: '[role=stylesheet]',\n\tstoryData: 'tw-storydata',\n\ttagColors: 'tw-tag',\n\tpassageData: 'tw-passagedata'\n};\n\n/**\n * Convenience function to convert a string value to an float.\n */\nfunction float(stringValue: string) {\n\treturn parseFloat(stringValue);\n}\n\n/**\n * Convenience function to query an element by a selector.\n */\nfunction query(el: Element, selector: string) {\n\treturn Array.from(el.querySelectorAll(selector));\n}\n\n/**\n * Convenience function to parse a string like \"100,50\".\n */\nfunction parseDimensions(raw: any): [string, string] | undefined {\n\tif (typeof raw !== 'string') {\n\t\treturn undefined;\n\t}\n\n\tconst bits = raw.split(',');\n\n\tif (bits.length === 2) {\n\t\treturn [bits[0], bits[1]];\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Converts a DOM <tw-storydata> element to a story object matching the format\n * in the store. This *may* be missing data, or data it returns may be\n * malformed. This function does its best to reflect the contents of the\n * element.\n */\nfunction domToObject(storyEl: Element): ImportedStory {\n\tconst startPassagePid = storyEl.getAttribute('startnode');\n\tlet startPassageId: string | undefined = undefined;\n\tconst story: ImportedStory = {\n\t\tifid: storyEl.getAttribute('ifid') ?? uuid(),\n\t\tid: uuid(),\n\t\tlastUpdate: undefined,\n\t\tname: storyEl.getAttribute('name') ?? undefined,\n\t\tstoryFormat: storyEl.getAttribute('format') ?? undefined,\n\t\tstoryFormatVersion: storyEl.getAttribute('format-version') ?? undefined,\n\t\tscript: query(storyEl, selectors.script)\n\t\t\t.map(el => el.textContent)\n\t\t\t.join('\\n'),\n\t\tstylesheet: query(storyEl, selectors.stylesheet)\n\t\t\t.map(el => el.textContent)\n\t\t\t.join('\\n'),\n\t\ttags: storyEl.getAttribute('tags')\n\t\t\t? storyEl.getAttribute('tags')!.split(/\\s+/)\n\t\t\t: [],\n\t\tzoom: parseFloat(storyEl.getAttribute('zoom') ?? '1'),\n\t\ttagColors: query(storyEl, selectors.tagColors).reduce((result, el) => {\n\t\t\tconst tagName = el.getAttribute('name');\n\n\t\t\tif (typeof tagName !== 'string') {\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\treturn {...result, [tagName]: el.getAttribute('color')};\n\t\t}, {}),\n\t\tpassages: query(storyEl, selectors.passageData).map(passageEl => {\n\t\t\tconst id = uuid();\n\t\t\tconst position = parseDimensions(passageEl.getAttribute('position'));\n\t\t\tconst size = parseDimensions(passageEl.getAttribute('size'));\n\n\t\t\tif (passageEl.getAttribute('pid') === startPassagePid) {\n\t\t\t\tstartPassageId = id;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tid,\n\t\t\t\tleft: position ? float(position[0]) : undefined,\n\t\t\t\ttop: position ? float(position[1]) : undefined,\n\t\t\t\twidth: size ? float(size[0]) : undefined,\n\t\t\t\theight: size ? float(size[1]) : undefined,\n\t\t\t\ttags: passageEl.getAttribute('tags')\n\t\t\t\t\t? passageEl.getAttribute('tags')!.split(/\\s+/)\n\t\t\t\t\t: [],\n\t\t\t\tname: passageEl.getAttribute('name') ?? undefined,\n\t\t\t\ttext: passageEl.textContent ?? undefined\n\t\t\t};\n\t\t})\n\t};\n\n\tstory.startPassage = startPassageId;\n\treturn story;\n}\n\n/**\n * Imports stories from HTML. If there are any missing attributes in the HTML,\n * defaults will be applied.\n */\nexport function importStories(\n\thtml: string,\n\tlastUpdateOverride?: Date\n): Story[] {\n\tconst nodes = document.createElement('div');\n\n\tnodes.innerHTML = html;\n\n\treturn query(nodes, selectors.storyData).map(storyEl => {\n\t\tconst importedStory = domToObject(storyEl);\n\n\t\t// Merge in defaults. We can't use object spreads here because undefined\n\t\t// values would override defaults.\n\n\t\tconst story: Story = defaults(importedStory, {id: uuid()}, storyDefaults());\n\n\t\t// Override the last update as requested.\n\n\t\tif (lastUpdateOverride) {\n\t\t\tstory.lastUpdate = lastUpdateOverride;\n\t\t}\n\n\t\t// Merge in passage defaults. We don't need to set ID here--domToObject did\n\t\t// this for us.\n\n\t\tstory.passages = story.passages.map(passage =>\n\t\t\tdefaults(passage, passageDefaults(), {story: story.id})\n\t\t);\n\n\t\treturn story;\n\t});\n}\n","import * as React from 'react';\nimport {Card, CardProps} from './card/card';\nimport './button-card.css';\n\nexport const ButtonCard: React.FC<CardProps> = props => (\n\t<div className=\"button-card\">\n\t\t<Card {...props} />\n\t</div>\n);\n","import * as React from 'react';\nimport {usePrefsContext} from '.';\n\nexport function useComputedTheme() {\n\t// See https://developer.mozilla.org/en-US/docs/Web/API/Window/matchMedia\n\n\tconst {prefs} = usePrefsContext();\n\tconst [mediaQuery] = React.useState(\n\t\twindow.matchMedia('(prefers-color-scheme: dark)')\n\t);\n\tconst [systemTheme, setSystemTheme] = React.useState<'dark' | 'light'>(\n\t\tmediaQuery.matches ? 'dark' : 'light'\n\t);\n\n\tReact.useEffect(() => {\n\t\tconst listener = (event: MediaQueryListEvent) =>\n\t\t\tsetSystemTheme(event.matches ? 'dark' : 'light');\n\n\t\tmediaQuery.addEventListener('change', listener);\n\t\treturn () => mediaQuery.removeEventListener('change', listener);\n\t}, [mediaQuery]);\n\n\treturn prefs.appTheme === 'system' ? systemTheme : prefs.appTheme;\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconWriting} from '@tabler/icons';\nimport {PromptButton} from '../control/prompt-button';\nimport {Passage, Story} from '../../store/stories';\nimport {IconButton} from '../control/icon-button';\n\nconst DisabledRenamePassageButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton disabled icon={<IconWriting />} label={t('common.rename')} />\n\t);\n};\n\nexport interface EnabledRenamePassageButtonProps {\n\tonRename: (value: string) => void;\n\tpassage: Passage;\n\tstory: Story;\n}\n\nexport const EnabledRenamePassageButton: React.FC<EnabledRenamePassageButtonProps> = props => {\n\tconst {onRename, passage, story} = props;\n\tconst [newName, setNewName] = React.useState(passage.name);\n\tconst {t} = useTranslation();\n\n\tfunction validate(name: string) {\n\t\tif (name.trim() === '') {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renamePassageButton.emptyName'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\tif (story.passages.some(p => p.id !== passage.id && p.name === name)) {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renamePassageButton.nameAlreadyUsed'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconWriting />}\n\t\t\tlabel={t('common.rename')}\n\t\t\tonChange={event => setNewName(event.target.value)}\n\t\t\tonSubmit={onRename}\n\t\t\tprompt={t('common.renamePrompt', {name: passage.name})}\n\t\t\tvalidate={validate}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n\nexport interface RenamePassageButtonProps\n\textends Omit<EnabledRenamePassageButtonProps, 'passage'> {\n\tpassage?: Passage;\n}\n\nexport const RenamePassageButton: React.FC<RenamePassageButtonProps> = props => {\n\tif (props.passage) {\n\t\treturn (\n\t\t\t<EnabledRenamePassageButton\n\t\t\t\t{...(props as EnabledRenamePassageButtonProps)}\n\t\t\t/>\n\t\t);\n\t}\n\n\treturn <DisabledRenamePassageButton />;\n};","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport classNames from 'classnames';\nimport {IconWriting} from '@tabler/icons';\nimport {colors, Color} from '../../util/color';\nimport {PromptButton, PromptValidationResponse} from '../control/prompt-button';\nimport {TextSelect} from '../control/text-select';\nimport './tag-editor.css';\n\nexport interface TagEditorProps {\n\tallTags: string[];\n\tcolor?: Color;\n\tname: string;\n\tonChangeColor: (color: Color) => void;\n\tonChangeName: (name: string) => void;\n}\n\nexport const TagEditor: React.FC<TagEditorProps> = props => {\n\tconst {allTags, color, name, onChangeColor, onChangeName} = props;\n\tconst [newName, setNewName] = React.useState(name);\n\tconst {t} = useTranslation();\n\n\tfunction validate(value: string): PromptValidationResponse {\n\t\tif (value !== name && allTags.includes(value)) {\n\t\t\treturn {message: t('components.tagEditor.alreadyExists'), valid: false};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<div className=\"tag-editor\">\n\t\t\t<span className={classNames('tag-name', `color-${props.color}`)}>\n\t\t\t\t{props.name}\n\t\t\t</span>\n\t\t\t<PromptButton\n\t\t\t\ticon={<IconWriting />}\n\t\t\t\tlabel={t('common.rename')}\n\t\t\t\tonChange={e => setNewName(e.target.value.replace(/\\s/g, '-'))}\n\t\t\t\tonSubmit={() => onChangeName(newName)}\n\t\t\t\tprompt={t('common.renamePrompt', {name})}\n\t\t\t\tvalue={newName}\n\t\t\t\tvalidate={validate}\n\t\t\t/>\n\t\t\t<TextSelect\n\t\t\t\tonChange={e => onChangeColor(e.target.value)}\n\t\t\t\toptions={colors.map(color => ({\n\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\tvalue: color\n\t\t\t\t}))}\n\t\t\t\tvalue={color ?? ''}\n\t\t\t>\n\t\t\t\t{t('common.color')}\n\t\t\t</TextSelect>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport './meter.css';\n\nexport interface MeterProps {\n\tdomId: string;\n\tpercent: number;\n}\n\nexport const Meter: React.FC<MeterProps> = ({children, domId, percent}) => {\n\treturn (\n\t\t<div\n\t\t\tclassName=\"meter\"\n\t\t\tid={domId}\n\t\t\trole=\"meter\"\n\t\t\taria-labelledby={`${domId}-label`}\n\t\t\taria-valuemin={0}\n\t\t\taria-valuemax={100}\n\t\t\taria-valuenow={percent * 100}\n\t\t>\n\t\t\t<div className=\"meter-bar\">\n\t\t\t\t<span className=\"filled\" style={{width: percent * 100 + '%'}}></span>\n\t\t\t</div>\n\t\t\t<div className=\"meter-label\" id={`${domId}-label`}>\n\t\t\t\t{children}\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","// Initiates story format loading, optionally showing a progress meter while it works.\n\nimport * as React from 'react';\nimport {Meter} from '../components/meter';\nimport {\n\tloadAllFormatProperties,\n\tuseStoryFormatsContext,\n\tStoryFormat\n} from './story-formats';\n\nexport interface FormatLoaderProps {\n\tblock?: boolean;\n}\n\nexport const FormatLoader: React.FC<FormatLoaderProps> = ({\n\tblock,\n\tchildren\n}) => {\n\tconst [seenFormats, setSeenFormats] = React.useState<StoryFormat[]>([]);\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\n\t// We can't directly use formats in an effect because it will change as\n\t// loading takes place. Instead, we need to maintain a list of formats to load\n\t// that only ever changes if new formats appear in state.\n\n\tReact.useEffect(() => {\n\t\tconst newFormats = formats.filter(\n\t\t\tnewFormat =>\n\t\t\t\t!seenFormats.find(\n\t\t\t\t\toldFormat =>\n\t\t\t\t\t\toldFormat.name === newFormat.name &&\n\t\t\t\t\t\toldFormat.version === newFormat.version\n\t\t\t\t)\n\t\t);\n\n\t\tif (newFormats.length > 0) {\n\t\t\tdispatch(loadAllFormatProperties(newFormats));\n\t\t\tsetSeenFormats([...seenFormats, ...newFormats]);\n\t\t}\n\t}, [dispatch, formats, seenFormats]);\n\n\tconst loadingFormat = formats.find(f => f.loadState === 'loading');\n\tconst loadPercent =\n\t\tformats.filter(f => f.loadState === 'loaded').length / formats.length;\n\n\tif (block && loadPercent < 1) {\n\t\treturn (\n\t\t\t<Meter domId=\"story-format-loader\" percent={loadPercent}>\n\t\t\t\t{loadingFormat && (\n\t\t\t\t\t<>\n\t\t\t\t\t\tLoading {loadingFormat.name} {loadingFormat.version}\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t</Meter>\n\t\t);\n\t}\n\n\treturn <>{children}</>;\n};\n","import {PrefsAction, PrefsState} from './prefs.types';\nimport {Color} from '../../util/color';\n\nexport function setPref(\n\tname: keyof PrefsState,\n\tvalue:\n\t\t| boolean\n\t\t| number\n\t\t| string\n\t\t| {name: string; version: string}\n\t\t| {name: string; version: string}[]\n\t\t| Record<string, Color>\n): PrefsAction {\n\treturn {type: 'update', name, value};\n}\n","import {PrefsState} from './prefs.types';\n\n/**\n * Returns whether the user has disabled editor extensions for a story format.\n */\nexport function formatEditorExtensionsDisabled(\n\tprefs: PrefsState,\n\tname: string,\n\tversion: string\n) {\n\treturn prefs.disabledStoryFormatEditorExtensions.some(\n\t\tf => f.name === name && f.version === version\n\t);\n}\n","import {Story} from '../../store/stories/stories.types';\n\n/**\n * Returns a filename for a story object that's guaranteed to be safe across all\n * platforms. For this, we use POSIX's definition\n * (http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap03.html#tag_03_276)\n * with the addition of spaces, for legibility.\n */\nexport function storyFileName(story: Story) {\n\treturn story.name.replace(/[^\\w. -]/g, '_') + '.html';\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoryFormatsState} from '.';\nimport {fetchStoryFormatProperties} from '../../util/story-format/fetch-properties';\nimport {\n\tStoryFormat,\n\tStoryFormatProperties,\n\tStoryFormatsAction,\n\tStoryFormatsDispatch\n} from './story-formats.types';\n\n/**\n * Creates a new story format based on properties (probably loaded externally).\n */\nexport function createFromProperties(\n\turl: string,\n\tproperties: StoryFormatProperties\n): StoryFormatsAction {\n\tif (!properties.name || !properties.version) {\n\t\tthrow new Error('Missing required properties for a new story format');\n\t}\n\n\treturn {\n\t\ttype: 'create',\n\t\tprops: {\n\t\t\turl,\n\t\t\tname: properties.name,\n\t\t\tselected: false,\n\t\t\tuserAdded: true,\n\t\t\tversion: properties.version\n\t\t}\n\t};\n}\n\n/**\n * Deletes a story format.\n */\nexport function deleteFormat(format: StoryFormat): StoryFormatsAction {\n\treturn {type: 'delete', id: format.id};\n}\n\n/**\n * Deselects all formats.\n */\nexport function deselectAllFormats(): Thunk<StoryFormat[], StoryFormatsAction> {\n\treturn (dispatch, getFormats) => {\n\t\tfor (const format of getFormats()) {\n\t\t\tif (format.selected) {\n\t\t\t\tdispatch({type: 'update', id: format.id, props: {selected: false}});\n\t\t\t}\n\t\t}\n\t};\n}\n\n/**\n * Deselects a single format.\n */\nexport function deselectFormat(format: StoryFormat): StoryFormatsAction {\n\treturn {type: 'update', id: format.id, props: {selected: false}};\n}\n\nasync function loadFormatThunk(\n\tformat: StoryFormat,\n\tdispatch: StoryFormatsDispatch\n) {\n\tdispatch({\n\t\ttype: 'update',\n\t\tid: format.id,\n\t\tprops: {loadState: 'loading'}\n\t});\n\n\ttry {\n\t\tlet properties = await fetchStoryFormatProperties(format.url);\n\n\t\t// If the format contains a `hydrate` property, try running it and merge in\n\t\t// properties that function creates by modifiying what's bound to its\n\t\t// `this`. This allows creation of properties that can't be serialized to\n\t\t// JSON on the format. The hydrate function cannot override properties\n\t\t// already present in the format properties, e.g. to change its source.\n\n\t\tif (properties.hydrate) {\n\t\t\ttry {\n\t\t\t\tconst hydrateResult: Partial<StoryFormatProperties> = {};\n\n\t\t\t\t// eslint-disable-next-line no-new-func\n\t\t\t\tconst hydrateFunc = new Function(properties.hydrate);\n\n\t\t\t\thydrateFunc.call(hydrateResult);\n\t\t\t\tproperties = {...hydrateResult, ...properties};\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t`Format ${format.id} has a hydrate property but it threw an error when called`,\n\t\t\t\t\te\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tid: format.id,\n\t\t\tprops: {properties, loadState: 'loaded'}\n\t\t});\n\n\t\treturn properties;\n\t} catch (loadError) {\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tid: format.id,\n\t\t\tprops: {loadError: (loadError as unknown) as Error, loadState: 'error'}\n\t\t});\n\t}\n}\n\n/**\n * Loads all format properties. If loading previously failed, this will try\n * again.\n */\nexport function loadAllFormatProperties(\n\tformats: StoryFormat[]\n): Thunk<StoryFormat[], StoryFormatsAction> {\n\tconst toLoad = formats.filter(\n\t\tf => f.loadState !== 'loaded' && f.loadState !== 'loading'\n\t);\n\n\tif (!toLoad) {\n\t\treturn () => {};\n\t}\n\n\treturn async (dispatch: StoryFormatsDispatch) => {\n\t\tawait Promise.allSettled(\n\t\t\ttoLoad.map(format => loadFormatThunk(format, dispatch))\n\t\t);\n\t};\n}\n\n/**\n * Loads a format's properties. If loading previously failed, this function will\n * try again. This returns a thunk which in turns returns a promise resolving to\n * the format properties, which can be useful if you need them immediately.\n */\nexport function loadFormatProperties(format: StoryFormat) {\n\tif (format.loadState === 'loaded') {\n\t\treturn () => format.properties;\n\t}\n\n\treturn async (dispatch: StoryFormatsDispatch) =>\n\t\tawait loadFormatThunk(format, dispatch);\n}\n\n/**\n * Selects a single format.\n */\nexport function selectFormat(\n\tformat: StoryFormat,\n\texclusive?: boolean\n): Thunk<StoryFormatsState, StoryFormatsAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!format.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'update',\n\t\t\t\tid: format.id,\n\t\t\t\tprops: {selected: true}\n\t\t\t});\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tfor (const other of getState()) {\n\t\t\t\tif (other.id !== format.id && other.selected) {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'update',\n\t\t\t\t\t\tid: other.id,\n\t\t\t\t\t\tprops: {selected: false}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}","import isAbsoluteUrl from 'is-absolute-url';\nimport semverLt from 'semver/functions/lt';\nimport {StoryFormat} from './story-formats.types';\nimport {PrefsState} from '../prefs';\n\nexport function filteredFormats(\n\tformats: StoryFormat[],\n\tfilter: PrefsState['storyFormatListFilter']\n): StoryFormat[] {\n\tswitch (filter) {\n\t\tcase 'all':\n\t\t\treturn formats;\n\n\t\tcase 'current':\n\t\t\treturn Object.values(\n\t\t\t\tformats.reduce<Record<string, StoryFormat>>((result, format) => {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!result[format.name] ||\n\t\t\t\t\t\tsemverLt(result[format.name].version, format.version)\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn {...result, [format.name]: format};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn result;\n\t\t\t\t}, {})\n\t\t\t);\n\n\t\tcase 'user':\n\t\t\treturn formats.filter(format => format.userAdded);\n\t}\n}\n\nexport function formatImageUrl(format: StoryFormat) {\n\tif (format.loadState !== 'loaded' || !format.properties.image) {\n\t\tthrow new Error('Format has no image property');\n\t}\n\n\tif (isAbsoluteUrl(format.properties.image)) {\n\t\treturn format.properties.image;\n\t}\n\n\treturn format.url.replace(/\\/[^/]*?$/, '/') + format.properties.image;\n}\n\nexport function formatWithId(formats: StoryFormat[], id: string) {\n\tconst result = formats.find(f => f.id === id);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story format with ID \"${id}\".`);\n}\n\nexport function formatWithNameAndVersion(\n\tformats: StoryFormat[],\n\tname: string,\n\tversion: string\n) {\n\tconst result = formats.find(f => f.name === name && f.version === version);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no story format with name \"${name}\" and version \"${version}\".`\n\t);\n}\n\nexport function sortFormats(formats: StoryFormat[]) {\n\treturn formats.sort((a, b) => {\n\t\t// First sort by name ascending...\n\n\t\tif (a.name < b.name) {\n\t\t\treturn -1;\n\t\t}\n\n\t\tif (a.name > b.name) {\n\t\t\treturn 1;\n\t\t}\n\n\t\t// ... then by version, in descending order.\n\n\t\tif (a.version === b.version) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tif (semverLt(b.version, a.version)) {\n\t\t\treturn -1;\n\t\t}\n\n\t\treturn 1;\n\t});\n}\n","export const minZoom = 0.2;\nexport const maxZoom = 2;\n","import {IconHeart, IconX} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {CardContent} from '../components/container/card';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {IconButton} from '../components/control/icon-button';\nimport {IconLink} from '../components/control/icon-link';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {DialogComponentProps} from './dialogs.types';\n\nexport const AppDonationDialog: React.FC<DialogComponentProps> = props => {\n\tconst {dispatch} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => dispatch(setPref('donateShown', true)), [dispatch]);\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"app-donation-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.appDonation.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<div className=\"text\">\n\t\t\t\t\t<p>{t('dialogs.appDonation.supportMessage')}</p>\n\t\t\t\t\t<p>{t('dialogs.appDonation.onlyOnce')}</p>\n\t\t\t\t</div>\n\t\t\t</CardContent>\n\t\t\t<ButtonBar>\n\t\t\t\t<IconLink\n\t\t\t\t\thref=\"https://twinery.org/donate\"\n\t\t\t\t\ticon={<IconHeart />}\n\t\t\t\t\tlabel={t('dialogs.appDonation.donate')}\n\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\tlabel={t('dialogs.appDonation.noThanks')}\n\t\t\t\t\tonClick={props.onClose}\n\t\t\t\t/>\n\t\t\t</ButtonBar>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CardContent} from '../components/container/card';\nimport {DialogComponentProps} from './dialogs.types';\nimport {\n\tsetTagColor,\n\tstoryWithId,\n\trenamePassageTag,\n\tstoryPassageTags\n} from '../store/stories';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {Color} from '../util/color';\nimport {TagEditor} from '../components/tag/tag-editor';\n\nexport interface PassageTagsDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const PassageTagsDialog: React.FC<PassageTagsDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\tconst story = storyWithId(stories, storyId);\n\tconst tags = storyPassageTags(story);\n\n\tfunction handleChangeColor(tagName: string, color: Color) {\n\t\tdispatch(\n\t\t\tsetTagColor(story, tagName, color),\n\t\t\tt('undoChange.changeTagColor')\n\t\t);\n\t}\n\n\tfunction handleChangeTagName(tagName: string, newName: string) {\n\t\tdispatch(\n\t\t\trenamePassageTag(story, tagName, newName),\n\t\t\tt('undoChange.renameTag')\n\t\t);\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\tclassName=\"passage-tags-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.passageTags.title')}\n\t\t\t{...other}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t{tags.length > 0 ? (\n\t\t\t\t\ttags.map(tag => (\n\t\t\t\t\t\t<TagEditor\n\t\t\t\t\t\t\tallTags={tags}\n\t\t\t\t\t\t\tcolor={story.tagColors[tag]}\n\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\tonChangeColor={color => handleChangeColor(tag, color)}\n\t\t\t\t\t\t\tonChangeName={newName => handleChangeTagName(tag, newName)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t) : (\n\t\t\t\t\t<p>{t('dialogs.passageTags.noTags')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IndentButtons, UndoRedoButtons} from '../components/codemirror';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {DialogCard, DialogEditor} from '../components/container/dialog-card';\nimport {CodeArea} from '../components/control/code-area';\nimport {usePrefsContext} from '../store/prefs';\nimport {storyWithId, updateStory, useStoriesContext} from '../store/stories';\nimport {codeMirrorOptionsFromPrefs} from '../util/codemirror-options';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-javascript.css';\n\nexport interface StoryJavaScriptDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryJavaScriptDialog: React.FC<StoryJavaScriptDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tconst handleChange = (\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) => {\n\t\tsetCmEditor(editor);\n\t\tdispatch(updateStory(stories, story, {script: text}));\n\t};\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-javascript-dialog\"\n\t\t\theaderLabel={t('dialogs.storyJavaScript.title')}\n\t\t>\n\t\t\t<p>{t('dialogs.storyJavaScript.explanation')}</p>\n\t\t\t<ButtonBar>\n\t\t\t\t<UndoRedoButtons editor={cmEditor} watch={story.script} />\n\t\t\t\t<IndentButtons editor={cmEditor} />\n\t\t\t</ButtonBar>\n\t\t\t<DialogEditor>\n\t\t\t\t<CodeArea\n\t\t\t\t\teditorDidMount={setCmEditor}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tlabel={t('dialogs.storyJavaScript.editorLabel')}\n\t\t\t\t\tlabelHidden\n\t\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\t\t\t\tautofocus: true,\n\t\t\t\t\t\tmode: 'javascript'\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={story.script}\n\t\t\t\t/>\n\t\t\t</DialogEditor>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconReplace} from '@tabler/icons';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CheckboxButton} from '../components/control/checkbox-button';\nimport {CodeArea} from '../components/control/code-area';\nimport {IconButton} from '../components/control/icon-button';\nimport {\n\thighlightPassagesMatchingSearch,\n\tpassagesMatchingSearch,\n\treplaceInStory,\n\tstoryWithId,\n\tStorySearchFlags\n} from '../store/stories';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-search.css';\n\n// See https://github.com/codemirror/CodeMirror/issues/5444\n\nconst ignoreTab: any = {\n\tTab: false,\n\t'Shift-Tab': false\n};\n\nexport interface StorySearchDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StorySearchDialog: React.FC<StorySearchDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [flags, setFlags] = React.useState<StorySearchFlags>({\n\t\tincludePassageNames: true,\n\t\tmatchCase: false,\n\t\tuseRegexes: false\n\t});\n\tconst [replace, setReplace] = React.useState('');\n\tconst [find, setFind] = React.useState('');\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\tconst story = storyWithId(stories, storyId);\n\tconst matches = passagesMatchingSearch(story.passages, find, flags);\n\n\tReact.useEffect(() => {\n\t\tdispatch(highlightPassagesMatchingSearch(story, find, flags));\n\n\t\treturn () => dispatch(highlightPassagesMatchingSearch(story, '', {}));\n\t}, [dispatch, find, flags, story]);\n\n\tfunction handleReplaceWithChange(\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) {\n\t\tsetReplace(text);\n\t}\n\n\tfunction handleSearchForChange(\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) {\n\t\tsetFind(text);\n\t}\n\n\tfunction handleReplace() {\n\t\tdispatch(\n\t\t\treplaceInStory(story, find, replace, flags),\n\t\t\t'undoChange.replaceAllText'\n\t\t);\n\t}\n\n\tfunction toggleFlag(name: keyof StorySearchFlags) {\n\t\tsetFlags(flags => ({...flags, [name]: !flags[name]}));\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-search-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storySearch.title')}\n\t\t>\n\t\t\t<div className=\"search-fields\">\n\t\t\t\t<CodeArea\n\t\t\t\t\tlabel={t('dialogs.storySearch.find')}\n\t\t\t\t\tonBeforeChange={handleSearchForChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\textraKeys: ignoreTab,\n\t\t\t\t\t\tmode: 'text'\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={find}\n\t\t\t\t/>\n\t\t\t\t<CodeArea\n\t\t\t\t\tlabel={t('dialogs.storySearch.replaceWith')}\n\t\t\t\t\tonBeforeChange={handleReplaceWithChange}\n\t\t\t\t\toptions={{extraKeys: ignoreTab, mode: 'text'}}\n\t\t\t\t\tvalue={replace}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"search-flags\">\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.includePassageNames')}\n\t\t\t\t\tonChange={() => toggleFlag('includePassageNames')}\n\t\t\t\t\tvalue={flags.includePassageNames ?? false}\n\t\t\t\t/>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.matchCase')}\n\t\t\t\t\tonChange={() => toggleFlag('matchCase')}\n\t\t\t\t\tvalue={flags.matchCase ?? false}\n\t\t\t\t/>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.useRegexes')}\n\t\t\t\t\tonChange={() => toggleFlag('useRegexes')}\n\t\t\t\t\tvalue={flags.useRegexes ?? false}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"search-results\">\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={matches.length === 0}\n\t\t\t\t\ticon={<IconReplace />}\n\t\t\t\t\tlabel={t('dialogs.storySearch.replaceAll')}\n\t\t\t\t\tonClick={handleReplace}\n\t\t\t\t\tvariant=\"danger\"\n\t\t\t\t/>\n\t\t\t\t<span>\n\t\t\t\t\t{find &&\n\t\t\t\t\t\t(matches.length > 0\n\t\t\t\t\t\t\t? t('dialogs.storySearch.matchCount', {count: matches.length})\n\t\t\t\t\t\t\t: t('dialogs.storySearch.noMatches'))}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IndentButtons, UndoRedoButtons} from '../components/codemirror';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {DialogCard, DialogEditor} from '../components/container/dialog-card';\nimport {CodeArea} from '../components/control/code-area';\nimport {usePrefsContext} from '../store/prefs';\nimport {storyWithId, updateStory, useStoriesContext} from '../store/stories';\nimport {codeMirrorOptionsFromPrefs} from '../util/codemirror-options';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-stylesheet.css';\n\nexport interface StoryStylesheetDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryStylesheetDialog: React.FC<StoryStylesheetDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tconst handleChange = (\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) => {\n\t\tsetCmEditor(editor);\n\t\tdispatch(updateStory(stories, story, {stylesheet: text}));\n\t};\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-stylesheet-dialog\"\n\t\t\theaderLabel={t('dialogs.storyStylesheet.title')}\n\t\t>\n\t\t\t<p>{t('dialogs.storyStylesheet.explanation')}</p>\n\t\t\t<ButtonBar>\n\t\t\t\t<UndoRedoButtons editor={cmEditor} watch={story.script} />\n\t\t\t\t<IndentButtons editor={cmEditor} />\n\t\t\t</ButtonBar>\n\t\t\t<DialogEditor>\n\t\t\t\t<CodeArea\n\t\t\t\t\teditorDidMount={setCmEditor}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tlabel={t('dialogs.storyStylesheet.editorLabel')}\n\t\t\t\t\tlabelHidden\n\t\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\t\t\t\tautofocus: true,\n\t\t\t\t\t\tmode: 'css'\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={story.stylesheet}\n\t\t\t\t/>\n\t\t\t</DialogEditor>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CardContent} from '../components/container/card';\nimport {DialogComponentProps} from './dialogs.types';\nimport {renameStoryTag, storyTags} from '../store/stories';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {Color} from '../util/color';\nimport {TagEditor} from '../components/tag/tag-editor';\n\nexport type StoryTagsDialogProps = DialogComponentProps;\n\nexport const StoryTagsDialog: React.FC<StoryTagsDialogProps> = props => {\n\tconst {dispatch: storiesDispatch, stories} = useUndoableStoriesContext();\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst tags = storyTags(stories);\n\n\tfunction handleChangeColor(tagName: string, color: Color) {\n\t\tprefsDispatch(\n\t\t\tsetPref('storyTagColors', {...prefs.storyTagColors, [tagName]: color})\n\t\t);\n\t}\n\n\tfunction handleChangeTagName(tagName: string, newName: string) {\n\t\tstoriesDispatch(renameStoryTag(stories, tagName, newName));\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\tclassName=\"story-tags-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storyTags.title')}\n\t\t\t{...props}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t{tags.length > 0 ? (\n\t\t\t\t\ttags.map(tag => (\n\t\t\t\t\t\t<TagEditor\n\t\t\t\t\t\t\tallTags={tags}\n\t\t\t\t\t\t\tcolor={prefs.storyTagColors[tag]}\n\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\tonChangeColor={color => handleChangeColor(tag, color)}\n\t\t\t\t\t\t\tonChangeName={newName => handleChangeTagName(tag, newName)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t) : (\n\t\t\t\t\t<p>{t('dialogs.storyTags.noTags')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tCreatePassagesAction,\n\tPassage,\n\tStoriesState,\n\tStory\n} from '../stories.types';\nimport {passageDefaults} from '../defaults';\nimport {rectsIntersect} from '../../../util/geometry';\nimport {parseLinks} from '../../../util/parse-links';\n\n/**\n * Creates newly linked passages from a passage. You shouldn't need to call this\n * directly--it will be invoked automatically by updatePassage() if you change\n * the passage text.\n */\nexport function createNewlyLinkedPassages(\n\tstory: Story,\n\tpassage: Passage,\n\tnewText: string,\n\toldText: string\n): Thunk<StoriesState, CreatePassagesAction> {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\treturn dispatch => {\n\t\tconst oldLinks = parseLinks(oldText);\n\t\tconst toCreate = parseLinks(newText).filter(\n\t\t\tl => !oldLinks.includes(l) && !story.passages.some(p => p.name === l)\n\t\t);\n\n\t\tif (toCreate.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst passageDefs = passageDefaults();\n\t\tconst passageGap = 25;\n\n\t\tlet top = passage.top + passage.height + passageGap;\n\t\tconst newPassagesWidth =\n\t\t\ttoCreate.length * passageDefs.width + (toCreate.length - 1) * passageGap;\n\n\t\t// Horizontally center the passages.\n\n\t\tlet left = passage.left + (passage.width - newPassagesWidth) / 2;\n\n\t\t// Move them to avoid overlaps.\n\n\t\tconst needsMoving = () =>\n\t\t\tstory.passages.some(passage =>\n\t\t\t\trectsIntersect(passage, {\n\t\t\t\t\tleft,\n\t\t\t\t\ttop,\n\t\t\t\t\theight: passageDefs.height,\n\t\t\t\t\twidth: newPassagesWidth\n\t\t\t\t})\n\t\t\t);\n\n\t\twhile (needsMoving()) {\n\t\t\t// Try rightward.\n\n\t\t\tleft += passageDefs.width + passageGap;\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Try leftward.\n\n\t\t\tleft -= 2 * (passageDefs.width + passageGap);\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Move downward and try again.\n\n\t\t\tleft += passageDefs.width + passageGap;\n\t\t\ttop += passageDefs.height + passageGap;\n\t\t}\n\n\t\t// Actually create them.\n\n\t\tdispatch({\n\t\t\ttype: 'createPassages',\n\t\t\tstoryId: story.id,\n\t\t\tprops: toCreate.map(name => {\n\t\t\t\tconst result = {left, name, top};\n\n\t\t\t\tleft += passageDefs.width + passageGap;\n\t\t\t\treturn result;\n\t\t\t})\n\t\t});\n\t};\n}\n","/**\n * Returns an unique name among an array of existing, making it unique if need\n * be by adding a number at the end.\n */\nexport function unusedName(name: string, existing: string[]): string {\n\tif (existing.includes(name)) {\n\t\tlet suffix = 1;\n\n\t\twhile (existing.includes(`${name} ${suffix}`)) {\n\t\t\tsuffix++;\n\t\t}\n\n\t\treturn `${name} ${suffix}`;\n\t}\n\n\treturn name;\n}\n","import {passageDefaults} from '../defaults';\nimport {CreatePassageAction, Story} from '../stories.types';\nimport {rectsIntersect} from '../../../util/geometry';\nimport {unusedName} from '../../../util/unused-name';\n\n/**\n * Creates a new, untitled passage centered at a point in the story. This\n * automatically increments a number at the end of the passage name to ensure\n * it's unique.\n */\nexport function createUntitledPassage(\n\tstory: Story,\n\tcenterX: number,\n\tcenterY: number\n): CreatePassageAction {\n\tif (!Number.isFinite(centerX) || !Number.isFinite(centerY)) {\n\t\tthrow new Error('Center must be a finite coordinate pair');\n\t}\n\n\tconst defs = passageDefaults();\n\tconst passageName = unusedName(\n\t\tdefs.name,\n\t\tstory.passages.map(passage => passage.name)\n\t);\n\n\t// Center it at the position requested, but move it outward until no overlaps are found.\n\n\tconst passageGap = 25;\n\tconst bounds = {\n\t\theight: defs.height,\n\t\tleft: Math.max(centerX - defs.width / 2, 0),\n\t\ttop: Math.max(centerY - defs.height / 2, 0),\n\t\twidth: defs.width\n\t};\n\n\tif (story.snapToGrid) {\n\t\tbounds.left = Math.round(bounds.left / passageGap) * passageGap;\n\t\tbounds.top = Math.round(bounds.top / passageGap) * passageGap;\n\t}\n\n\tconst needsMoving = () =>\n\t\tstory.passages.some(passage => rectsIntersect(passage, bounds));\n\n\twhile (needsMoving()) {\n\t\t// Try rightward.\n\n\t\tbounds.left += bounds.width + passageGap;\n\n\t\tif (!needsMoving()) {\n\t\t\tbreak;\n\t\t}\n\n\t\t// Try downward.\n\n\t\tbounds.left -= bounds.width + passageGap;\n\t\tbounds.top += bounds.height + passageGap;\n\n\t\tif (!needsMoving()) {\n\t\t\tbreak;\n\t\t}\n\n\t\t// Try leftward.\n\n\t\tif (bounds.left >= bounds.width + passageGap) {\n\t\t\tbounds.left -= bounds.width + passageGap;\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tbounds.left += bounds.width + passageGap;\n\t\t}\n\n\t\t// Move downward permanently and repeat.\n\n\t\tbounds.top += bounds.height + passageGap;\n\t}\n\n\treturn {\n\t\ttype: 'createPassage',\n\t\tstoryId: story.id,\n\t\tprops: {\n\t\t\t...bounds,\n\t\t\tstory: story.id,\n\t\t\tname: passageName\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport uuid from 'tiny-uuid';\nimport {PrefsState} from '../../prefs';\nimport {StoriesAction, StoriesState, Story} from '../stories.types';\nimport {storyDefaults} from '../defaults';\nimport {unusedName} from '../../../util/unused-name';\n\n/**\n * Creates a new story with the default story format.\n */\nexport function createUntitledStory(\n\tstories: Story[],\n\tprefs: PrefsState,\n\tprops: Partial<Omit<Story, 'id' | 'name'>> = {}\n): Thunk<StoriesState, StoriesAction> {\n\tconst id = uuid();\n\tconst name = unusedName(\n\t\tstoryDefaults().name,\n\t\tstories.map(story => story.name)\n\t);\n\n\treturn dispatch => {\n\t\tdispatch({\n\t\t\ttype: 'createStory',\n\t\t\tprops: {\n\t\t\t\tid,\n\t\t\t\tname,\n\t\t\t\tstoryFormat: prefs.storyFormat.name,\n\t\t\t\tstoryFormatVersion: prefs.storyFormat.version,\n\t\t\t\t...props\n\t\t\t}\n\t\t});\n\n\t\treturn id;\n\t};\n}\n","import {\n\tPassage,\n\tStory,\n\tDeletePassageAction,\n\tDeletePassagesAction\n} from '../stories.types';\n\n/**\n * Deletes a passage.\n */\nexport function deletePassage(\n\tstory: Story,\n\tpassage: Passage\n): DeletePassageAction {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\treturn {type: 'deletePassage', storyId: story.id, passageId: passage.id};\n}\n\n/**\n * Deletes multiple passages.\n */\nexport function deletePassages(\n\tstory: Story,\n\tpassages: Passage[]\n): DeletePassagesAction {\n\treturn {\n\t\ttype: 'deletePassages',\n\t\tstoryId: story.id,\n\t\tpassageIds: passages.map(passage => passage.id)\n\t};\n}\n","import {StoriesAction, Story} from '../stories.types';\n\nexport function deleteStory(story: Story): StoriesAction {\n\treturn {type: 'deleteStory', storyId: story.id};\n}\n","import uuid from 'tiny-uuid';\nimport {CreateStoryAction, Story} from '../stories.types';\nimport {unusedName} from '../../../util/unused-name';\n\n/**\n * Creates a duplicate of an existing story.\n */\nexport function duplicateStory(\n\tstory: Story,\n\tstories: Story[]\n): CreateStoryAction {\n\treturn {\n\t\ttype: 'createStory',\n\t\tprops: {\n\t\t\t...story,\n\t\t\tid: uuid(),\n\t\t\tifid: uuid(),\n\t\t\tname: unusedName(\n\t\t\t\tstory.name,\n\t\t\t\tstories.map(story => story.name)\n\t\t\t)\n\t\t}\n\t};\n}\n","import escapeRegExp from 'lodash/escapeRegExp';\nimport {Thunk} from 'react-hook-thunk-reducer';\nimport {Passage, StoriesAction, StoriesState, Story} from '../stories.types';\nimport {createNewlyLinkedPassages} from './create-newly-linked-passages';\n\nexport interface UpdatePassageOptions {\n\tdontCreateNewlyLinkedPassages?: boolean;\n}\n\n/**\n * General update of a passage.\n */\nexport function updatePassage(\n\tstory: Story,\n\tpassage: Passage,\n\tprops: Partial<Passage>,\n\toptions: UpdatePassageOptions = {}\n): Thunk<StoriesState, StoriesAction> {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (\n\t\t'name' in props &&\n\t\tstory.passages\n\t\t\t.filter(p => p.name === props.name)\n\t\t\t.some(p => p.id !== passage.id)\n\t) {\n\t\tthrow new Error(`There is already a passage named \"${props.name}\".`);\n\t}\n\n\treturn (dispatch, getState) => {\n\t\t// Do the passage update itself.\n\n\t\tconst oldName = passage.name;\n\t\tconst oldText = passage.text;\n\n\t\tdispatch({\n\t\t\tprops,\n\t\t\ttype: 'updatePassage',\n\t\t\tpassageId: passage.id,\n\t\t\tstoryId: story.id\n\t\t});\n\n\t\t// Side effects from changes.\n\n\t\tif (!options.dontCreateNewlyLinkedPassages && props.text) {\n\t\t\tdispatch(createNewlyLinkedPassages(story, passage, props.text, oldText));\n\t\t}\n\n\t\tif (props.name) {\n\t\t\tconst oldNameEscaped = escapeRegExp(oldName);\n\n\t\t\t// We only need to escape $ stuff in the new name, because it will be the\n\t\t\t// second argument to replace(). This is a little mindbending, but the\n\t\t\t// purpose of this is to replace $ with $$.\n\n\t\t\tconst newNameEscaped = props.name.replace(/\\$/g, '$$$$');\n\n\t\t\tconst simpleLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[' + oldNameEscaped + '(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\t\t\tconst compoundLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[(.*?)(\\\\||->)' + oldNameEscaped + '(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\t\t\tconst reverseLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[' + oldNameEscaped + '(<-.*?)(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\n\t\t\tstory.passages.forEach(relinkedPassage => {\n\t\t\t\tif (\n\t\t\t\t\tsimpleLinkRegexp.test(relinkedPassage.text) ||\n\t\t\t\t\tcompoundLinkRegexp.test(relinkedPassage.text) ||\n\t\t\t\t\treverseLinkRegexp.test(relinkedPassage.text)\n\t\t\t\t) {\n\t\t\t\t\tlet newText = relinkedPassage.text;\n\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\tsimpleLinkRegexp,\n\t\t\t\t\t\t'[[' + newNameEscaped + '$1]]'\n\t\t\t\t\t);\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\tcompoundLinkRegexp,\n\t\t\t\t\t\t'[[$1$2' + newNameEscaped + '$3]]'\n\t\t\t\t\t);\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\treverseLinkRegexp,\n\t\t\t\t\t\t'[[' + newNameEscaped + '$1$2]]'\n\t\t\t\t\t);\n\n\t\t\t\t\tupdatePassage(\n\t\t\t\t\t\tstory,\n\t\t\t\t\t\trelinkedPassage,\n\t\t\t\t\t\t{text: newText},\n\t\t\t\t\t\toptions\n\t\t\t\t\t)(dispatch, getState);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {createRegExp, escapeRegExpReplace} from '../../../util/regexp';\nimport {updatePassage} from './update-passage';\nimport {\n\tPassage,\n\tStoriesAction,\n\tStoriesState,\n\tStory,\n\tStorySearchFlags\n} from '../stories.types';\n\nexport function replaceInPassage(\n\tstory: Story,\n\tpassage: Passage,\n\tsearchFor: string,\n\treplaceWith: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, StoriesAction> {\n\treturn (dispatch, getState) => {\n\t\tif (searchFor === '') {\n\t\t\tthrow new Error(\"Can't replace an empty string\");\n\t\t}\n\n\t\tif (passage.story !== story.id) {\n\t\t\tthrow new Error('Passage does not belong to story');\n\t\t}\n\n\t\tconst {includePassageNames, matchCase, useRegexes} = flags;\n\t\tconst matcher = createRegExp(searchFor, {matchCase, useRegexes});\n\t\tconst props: Partial<Passage> = {};\n\t\tconst replacer = useRegexes\n\t\t\t? replaceWith\n\t\t\t: escapeRegExpReplace(replaceWith);\n\n\t\tconst newText = passage.text.replace(matcher, replacer);\n\n\t\tif (newText !== passage.text) {\n\t\t\tprops.text = newText;\n\t\t}\n\n\t\tif (includePassageNames) {\n\t\t\tconst newName = passage.name.replace(matcher, replacer);\n\n\t\t\tif (newName !== passage.name) {\n\t\t\t\tprops.name = newName;\n\t\t\t}\n\t\t}\n\n\t\tif (Object.keys(props).length > 0) {\n\t\t\tupdatePassage(story, passage, props)(dispatch, getState);\n\t\t}\n\t};\n}\n\nexport function replaceInStory(\n\tstory: Story,\n\tsearchFor: string,\n\treplaceWith: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, StoriesAction> {\n\treturn (dispatch, getState) =>\n\t\tstory.passages.forEach(passage => {\n\t\t\treplaceInPassage(\n\t\t\t\tstory,\n\t\t\t\tpassage,\n\t\t\t\tsearchFor,\n\t\t\t\treplaceWith,\n\t\t\t\tflags\n\t\t\t)(dispatch, getState);\n\t\t});\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tStorySearchFlags,\n\tUpdatePassagesAction\n} from '../stories.types';\nimport {passagesMatchingSearch} from '../getters';\n\nexport function highlightPassagesMatchingSearch(\n\tstory: Story,\n\tsearch: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tlet passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tif (search === '') {\n\t\t\t// Remove all highlights.\n\t\t\tpassageUpdates = story.passages.reduce((result, passage) => {\n\t\t\t\tif (passage.highlighted) {\n\t\t\t\t\treturn {...result, [passage.id]: {highlighted: false}};\n\t\t\t\t}\n\n\t\t\t\treturn result;\n\t\t\t}, {});\n\t\t} else {\n\t\t\tconst matchIds = passagesMatchingSearch(\n\t\t\t\tstory.passages,\n\t\t\t\tsearch,\n\t\t\t\tflags\n\t\t\t).map(passage => passage.id);\n\n\t\t\tstory.passages.forEach(passage => {\n\t\t\t\tconst oldHighlighted = passage.highlighted;\n\t\t\t\tconst newHighlighted = matchIds.includes(passage.id);\n\n\t\t\t\tif (newHighlighted !== oldHighlighted) {\n\t\t\t\t\tpassageUpdates[passage.id] = {highlighted: newHighlighted};\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tCreateStoryAction,\n\tStoriesState,\n\tStory,\n\tUpdateStoryAction\n} from '../stories.types';\nimport {storyFileName} from '../../../electron/shared';\n\n/**\n * Imports stories, overwriting any stories with the same name.\n */\nexport function importStories(\n\ttoImport: Story[],\n\texistingStories: Story[]\n): Thunk<StoriesState, CreateStoryAction | UpdateStoryAction> {\n\ttoImport.forEach(importStory => {\n\t\tif (\n\t\t\ttoImport.some(\n\t\t\t\totherStory =>\n\t\t\t\t\totherStory !== importStory &&\n\t\t\t\t\tstoryFileName(otherStory) === storyFileName(importStory)\n\t\t\t)\n\t\t) {\n\t\t\tthrow new Error(\n\t\t\t\t`Stories to import cannot have the same name: \"${importStory.name}\"`\n\t\t\t);\n\t\t}\n\t});\n\n\treturn dispatch => {\n\t\ttoImport.forEach(importStory => {\n\t\t\t// Remove the temp ID that was assigned to the new story.\n\n\t\t\tconst props: Partial<Story> = {...importStory};\n\n\t\t\tdelete props.id;\n\n\t\t\tconst existingStory = existingStories.find(\n\t\t\t\ts => storyFileName(s) === storyFileName(importStory)\n\t\t\t);\n\n\t\t\t// Do an update so that if something goes awry, we won't have deleted the\n\t\t\t// story.\n\n\t\t\tif (existingStory) {\n\t\t\t\tdispatch({props, type: 'updateStory', storyId: existingStory.id});\n\t\t\t} else {\n\t\t\t\tdispatch({props, type: 'createStory'});\n\t\t\t}\n\t\t});\n\t};\n}\n","import {Passage, Story, UpdatePassagesAction} from '../stories.types';\n\n/**\n * Moves passages by an offset, e.g. after dragging.\n */\nexport function movePassages(\n\tstory: Story,\n\tpassageIds: string[],\n\txChange: number,\n\tyChange: number\n): UpdatePassagesAction {\n\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\tif (!Number.isFinite(xChange) || !Number.isFinite(yChange)) {\n\t\tthrow new Error('Offset must be a finite number.');\n\t}\n\n\tpassageIds.forEach(passageId => {\n\t\tconst passage = story.passages.find(p => p.id === passageId);\n\n\t\tif (!passage) {\n\t\t\tthrow new Error(\n\t\t\t\t`There is no passage in this story with ID \"${passageId}\".`\n\t\t\t);\n\t\t}\n\n\t\tlet left = Math.max(passage.left + xChange, 0);\n\t\tlet top = Math.max(passage.top + yChange, 0);\n\n\t\tif (story.snapToGrid) {\n\t\t\tleft = Math.round(left / 25) * 25;\n\t\t\ttop = Math.round(top / 25) * 25;\n\t\t}\n\n\t\tpassageUpdates[passage.id] = {left, top};\n\t});\n\n\treturn {type: 'updatePassages', passageUpdates, storyId: story.id};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tUpdatePassagesAction,\n\tUpdateStoryAction\n} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\nexport function renamePassageTag(\n\tstory: Story,\n\toldName: string,\n\tnewName: string\n): Thunk<StoriesState, UpdatePassagesAction | UpdateStoryAction> {\n\tif (!isValidTagName(newName)) {\n\t\tthrow new Error(`\"${newName}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\t// Change tags in passages.\n\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (passage.tags.includes(oldName)) {\n\t\t\t\tpassageUpdates[passage.id] = {\n\t\t\t\t\ttags: passage.tags.map(tag => (tag === oldName ? newName : tag))\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\n\t\t\t// Move the tag color to the new one.\n\n\t\t\tconst tagColors = {...story.tagColors};\n\n\t\t\tdelete tagColors[oldName];\n\t\t\ttagColors[newName] = story.tagColors[oldName];\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops: {tagColors},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesAction, StoriesState, Story} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\nexport function renameStoryTag(\n\tstories: Story[],\n\toldName: string,\n\tnewName: string\n): Thunk<StoriesState, StoriesAction> {\n\tif (!isValidTagName(newName)) {\n\t\tthrow new Error(`\"${newName}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\tstories.forEach(story => {\n\t\t\tif (story.tags.includes(oldName)) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tstoryId: story.id,\n\t\t\t\t\tprops: {\n\t\t\t\t\t\ttags: story.tags.map(tag => (tag === oldName ? newName : tag))\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {Rect, rectsIntersect} from '../../../util/geometry';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tUpdatePassageAction,\n\tUpdatePassagesAction\n} from '../stories.types';\n\n/**\n * Deselects all passages.\n */\nexport function deselectAllPassages(\n\tstory: Story\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (passage.selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected: false};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Deselects a single passage.\n */\nexport function deselectPassage(\n\tstory: Story,\n\tpassage: Passage\n): Thunk<StoriesState, UpdatePassageAction> {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story');\n\t}\n\n\treturn dispatch => {\n\t\tif (passage.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updatePassage',\n\t\t\t\tpassageId: passage.id,\n\t\t\t\tprops: {selected: false},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Selects all passages.\n */\nexport function selectAllPassages(\n\tstory: Story\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (!passage.selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected: true};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Selects a single passage.\n */\nexport function selectPassage(\n\tstory: Story,\n\tpassage: Passage,\n\texclusive: boolean\n): Thunk<StoriesState, UpdatePassagesAction> {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story');\n\t}\n\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tif (!passage.selected) {\n\t\t\tpassageUpdates[passage.id] = {selected: true};\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tstory.passages.forEach(p => {\n\t\t\t\tif (p.id !== passage.id && p.selected) {\n\t\t\t\t\tpassageUpdates[p.id] = {selected: false};\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\t\t}\n\t};\n}\n\nexport function selectPassagesInRect(\n\tstory: Story,\n\trect: Rect,\n\tignoreIds: string[] = []\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (ignoreIds.find(r => r === passage.id)) {\n\t\t\t\t// We are ignoring this passage, e.g. this is an additive selection and it\n\t\t\t\t// was already selected.\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst selected = rectsIntersect(rect, passage);\n\n\t\t\tif (passage.selected !== selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesState, Story, UpdateStoryAction} from '../stories.types';\n\n/**\n * Deselects a single story.\n */\nexport function deselectStory(\n\tstory: Story\n): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!story.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tstoryId: story.id,\n\t\t\t\tprops: {selected: false}\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Deselects all stories.\n */\nexport function deselectAllStories(): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tfor (const story of getState()) {\n\t\t\tif (story.selected) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tstoryId: story.id,\n\t\t\t\t\tprops: {selected: false}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t};\n}\n\n/**\n * Selects a single story.\n */\nexport function selectStory(\n\tstory: Story,\n\texclusive: boolean\n): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!story.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tstoryId: story.id,\n\t\t\t\tprops: {selected: true}\n\t\t\t});\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tfor (const other of getState()) {\n\t\t\t\tif (other.id !== story.id && other.selected) {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\t\tstoryId: other.id,\n\t\t\t\t\t\tprops: {selected: false}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {Color} from '../../../util/color';\nimport {isValidTagName} from '../../../util/tag';\nimport {StoriesState, Story, UpdateStoryAction} from '../stories.types';\n\nexport function setTagColor(\n\tstory: Story,\n\tname: string,\n\tcolor: Color\n): Thunk<StoriesState, UpdateStoryAction> {\n\tif (!isValidTagName(name)) {\n\t\tthrow new Error(`\"${name}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\t// Special handling: if the color is set to none, just delete it.\n\n\t\tif (color === 'none') {\n\t\t\tif (name in story.tagColors) {\n\t\t\t\tconst tagColors = {...story.tagColors};\n\n\t\t\t\tdelete tagColors[name];\n\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tprops: {tagColors},\n\t\t\t\t\tstoryId: story.id\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops: {tagColors: {...story.tagColors, [name]: color}},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Passage, Story, UpdatePassageAction} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\n/**\n * Adds a tag to a passage.\n */\nexport function addPassageTag(\n\tstory: Story,\n\tpassage: Passage,\n\ttagName: string\n): UpdatePassageAction {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (!isValidTagName(tagName)) {\n\t\tthrow new Error(`\"${tagName}\" is not a valid tag name.`);\n\t}\n\n\tif (passage.tags.includes(tagName)) {\n\t\tthrow new Error(`This passage already has the tag \"${tagName}\".`);\n\t}\n\n\treturn {\n\t\ttype: 'updatePassage',\n\t\tpassageId: passage.id,\n\t\tstoryId: story.id,\n\t\tprops: {tags: [...passage.tags, tagName]}\n\t};\n}\n\n/**\n * Removes a tag from a passage.\n */\nexport function removePassageTag(\n\tstory: Story,\n\tpassage: Passage,\n\ttagName: string\n): UpdatePassageAction {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (!isValidTagName(tagName)) {\n\t\tthrow new Error(`\"${tagName}\" is not a valid tag name.`);\n\t}\n\n\tif (!passage.tags.includes(tagName)) {\n\t\tthrow new Error(`This passage does not have the tag \"${tagName}\".`);\n\t}\n\n\treturn {\n\t\ttype: 'updatePassage',\n\t\tpassageId: passage.id,\n\t\tstoryId: story.id,\n\t\tprops: {tags: passage.tags.filter(t => t !== tagName)}\n\t};\n}\n","import {Story, UpdateStoryAction} from '../stories.types';\nimport {storyFileName} from '../../../electron/shared';\n\n/**\n * General update of a story.\n */\nexport function updateStory(\n\tstories: Story[],\n\tstory: Story,\n\tprops: Partial<Story>\n): UpdateStoryAction {\n\tif (\n\t\tprops.name &&\n\t\tstories\n\t\t\t.filter(s => storyFileName(s) === storyFileName({...s, ...props}))\n\t\t\t.some(s => s.id !== story.id)\n\t) {\n\t\tthrow new Error(`There is already a story named \"${props.name}\".`);\n\t}\n\n\treturn {\n\t\tprops,\n\t\tstoryId: story.id,\n\t\ttype: 'updateStory'\n\t};\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults} from '../defaults';\nimport {Passage, Story, StoriesState} from '../stories.types';\n\nexport function createPassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageProps: Partial<Passage>\n) {\n\tlet storyExists = false;\n\tlet created = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tstoryExists = true;\n\n\t\tif (story.passages.some(passage => passage.id === passageProps.id)) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with ID \"${passageProps.id}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tif (\n\t\t\t'name' in passageProps &&\n\t\t\tstory.passages.some(passage => passage.name === passageProps.name)\n\t\t) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with name \"${passageProps.name}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tconst newPassage: Passage = {\n\t\t\t...passageDefaults(),\n\t\t\tid: uuid(),\n\t\t\t...passageProps,\n\t\t\tstory: story.id\n\t\t};\n\t\tconst newStory: Story = {\n\t\t\t...story,\n\t\t\tlastUpdate: new Date(),\n\t\t\tpassages: [...story.passages, newPassage]\n\t\t};\n\n\t\tif (newStory.passages.length === 1) {\n\t\t\tnewStory.startPassage = newPassage.id;\n\t\t}\n\n\t\tcreated = true;\n\t\treturn newStory;\n\t});\n\n\tif (!storyExists) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!created) {\n\t\t// Should have warned above.\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {StoriesState} from '../stories.types';\n\nexport function deletePassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageId: string\n) {\n\tlet foundStory = false;\n\tlet deleted = false;\n\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tfoundStory = true;\n\n\t\tconst newStory = {\n\t\t\t...story,\n\t\t\tpassages: story.passages.filter(passage => {\n\t\t\t\tif (passage.id === passageId) {\n\t\t\t\t\tdeleted = true;\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\treturn true;\n\t\t\t})\n\t\t};\n\n\t\tif (deleted) {\n\t\t\tnewStory.lastUpdate = new Date();\n\t\t\treturn newStory;\n\t\t}\n\n\t\treturn story;\n\t});\n\n\tif (!foundStory) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!deleted) {\n\t\tconsole.warn(\n\t\t\t`Asked to delete a passage with ID \"${passageId}\", but it does not exist in story ID ${storyId}, taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults} from '../../defaults';\nimport {Passage, Story} from '../../stories.types';\n\nfunction logRepair(\n\tpassage: Passage,\n\tpropName: keyof Passage,\n\trepairedValue: any,\n\tdetail?: string\n) {\n\tlet message =\n\t\t`Repairing passage (name: \"${passage.name}\", id: ${passage.id}): ` +\n\t\t`setting ${propName} to ${repairedValue}, was ${passage[propName]}`;\n\n\tif (detail) {\n\t\tmessage += ` (${detail})`;\n\t}\n\n\tconsole.info(message);\n}\n\nexport function repairPassage(passage: Passage, parentStory: Story): Passage {\n\tconst passageDefs = passageDefaults();\n\tconst repairs: Partial<Passage> = {};\n\n\t// Give the passage an ID if it has none.\n\n\tif (typeof passage.id !== 'string' || passage.id === '') {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(passage, 'id', newId, 'was undefined or empty string');\n\t\trepairs.id = uuid();\n\t}\n\n\t// Apply default properties to the passage.\n\n\tObject.entries(passageDefs).forEach(([key, value]) => {\n\t\tconst defKey = key as keyof typeof passageDefs;\n\n\t\tif (\n\t\t\t(typeof value === 'number' && !Number.isFinite(passage[defKey])) ||\n\t\t\ttypeof value !== typeof passage[defKey]\n\t\t) {\n\t\t\tlogRepair(passage, defKey, passageDefs[defKey]);\n\t\t\t(repairs[defKey] as Passage[typeof defKey]) = passageDefs[defKey];\n\t\t}\n\t});\n\n\t// Make passage coordinates 0 or greater.\n\n\t['left', 'top'].forEach(pos => {\n\t\tconst posKey = pos as keyof Passage;\n\n\t\tif (passage[posKey] < 0) {\n\t\t\tlogRepair(passage, posKey, 0, 'was negative');\n\t\t\t(repairs[posKey] as Passage[typeof posKey]) = 0;\n\t\t}\n\t});\n\n\t// Make passage dimensions 5 or greater.\n\n\t['height', 'width'].forEach(dim => {\n\t\tconst dimKey = dim as keyof Passage;\n\n\t\tif (passage[dimKey] < 5) {\n\t\t\tlogRepair(passage, dimKey, 0, 'was less than 5');\n\t\t\t(repairs[dimKey] as Passage[typeof dimKey]) = 5;\n\t\t}\n\t});\n\n\t// Repair story property if it doesn't point to the parent story.\n\n\tif (passage.story !== parentStory.id) {\n\t\tlogRepair(passage, 'story', parentStory.id, \"didn't match parent story\");\n\t\trepairs.story = parentStory.id;\n\t}\n\n\t// Repair ID conflicts with any other passage in the story.\n\n\tif (\n\t\tparentStory.passages.some(otherPassage => {\n\t\t\tif (otherPassage === passage) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn otherPassage.id === passage.id;\n\t\t})\n\t) {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(\n\t\t\tpassage,\n\t\t\t'id',\n\t\t\tnewId,\n\t\t\t'conflicted with another passage in the story'\n\t\t);\n\t\trepairs.id = newId;\n\t}\n\n\tif (Object.keys(repairs).length > 0) {\n\t\treturn {...passage, ...repairs};\n\t}\n\n\treturn passage;\n}\n","import {satisfies} from 'semver';\nimport uuid from 'tiny-uuid';\nimport {Story} from '../../stories.types';\nimport {storyDefaults} from '../../defaults';\nimport {StoryFormat} from '../../../story-formats';\nimport {repairPassage} from './repair-passage';\n\nfunction logRepair(\n\tstory: Story,\n\tpropName: keyof Story,\n\trepairedValue: any,\n\tdetail?: string\n) {\n\tlet message =\n\t\t`Repairing story (name: \"${story.name}\", id: ${story.id}) by ` +\n\t\t`setting ${propName} to ${repairedValue}, was ${story[propName]}`;\n\n\tif (detail) {\n\t\tmessage += ` (${detail})`;\n\t}\n\n\tconsole.info(message);\n}\n\nexport function repairStory(\n\tstory: Story,\n\tallStories: Story[],\n\tallFormats: StoryFormat[],\n\tdefaultFormat: StoryFormat\n): Story {\n\tconst storyDefs = storyDefaults();\n\tconst repairs: Partial<Story> = {};\n\n\t// Give the story an ID if it has none.\n\n\tif (typeof story.id !== 'string' || story.id === '') {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(story, 'id', newId, 'was bad type or empty string');\n\t\trepairs.id = newId;\n\t}\n\n\t// Give the story an IFID if it has none.\n\n\tif (typeof story.ifid !== 'string' || story.id === '') {\n\t\tconst newIfid = uuid();\n\n\t\tlogRepair(story, 'ifid', newIfid, 'was bad type or empty string');\n\t\trepairs.ifid = newIfid;\n\t}\n\n\t// Apply default properties to the story.\n\n\tObject.entries(storyDefs).forEach(([key, value]) => {\n\t\tconst defKey = key as keyof typeof storyDefs;\n\n\t\tif (\n\t\t\t(typeof value === 'number' && !Number.isFinite(story[defKey])) ||\n\t\t\ttypeof value !== typeof story[defKey]\n\t\t) {\n\t\t\tlogRepair(story, defKey, storyDefs[defKey]);\n\t\t\t(repairs[defKey] as Story[typeof defKey]) = storyDefs[defKey];\n\t\t}\n\t});\n\n\tif (\n\t\ttypeof story.storyFormat !== 'string' ||\n\t\tstory.storyFormat === '' ||\n\t\ttypeof story.storyFormatVersion !== 'string' ||\n\t\tstory.storyFormatVersion === ''\n\t) {\n\t\t// Assign the story the default story format if it has none.\n\n\t\tlogRepair(\n\t\t\tstory,\n\t\t\t'storyFormat',\n\t\t\tdefaultFormat.name,\n\t\t\t'was bad type or unset'\n\t\t);\n\t\tlogRepair(\n\t\t\tstory,\n\t\t\t'storyFormatVersion',\n\t\t\tdefaultFormat.version,\n\t\t\t'was bad type or unset'\n\t\t);\n\t\trepairs.storyFormat = defaultFormat.name;\n\t\trepairs.storyFormatVersion = defaultFormat.version;\n\t} else if (\n\t\t!allFormats.some(\n\t\t\tformat =>\n\t\t\t\tformat.name === story.storyFormat &&\n\t\t\t\tformat.version === story.storyFormatVersion\n\t\t)\n\t) {\n\t\t// If the story has a nonexistent story format, try to match it to one that\n\t\t// does, using semver as a guide.\n\n\t\tconst repairFormat = allFormats.find(\n\t\t\tformat =>\n\t\t\t\tformat.name === story.storyFormat &&\n\t\t\t\tsatisfies(format.version, '^' + story.storyFormatVersion)\n\t\t);\n\n\t\tif (repairFormat) {\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormat',\n\t\t\t\trepairFormat.name,\n\t\t\t\t'no match in existing formats but found one that satisfies semver'\n\t\t\t);\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormatVersion',\n\t\t\t\trepairFormat.version,\n\t\t\t\t'no match in existing formats but found one that satisfies semver'\n\t\t\t);\n\t\t\trepairs.storyFormat = repairFormat.name;\n\t\t\trepairs.storyFormatVersion = repairFormat.version;\n\t\t} else {\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormat',\n\t\t\t\tdefaultFormat.name,\n\t\t\t\t'no match in existing formats and could not find one that satisfies semver'\n\t\t\t);\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormatVersion',\n\t\t\t\tdefaultFormat.version,\n\t\t\t\t'no match in existing formats and could not find one that satisfies semver'\n\t\t\t);\n\t\t\trepairs.storyFormat = defaultFormat.name;\n\t\t\trepairs.storyFormatVersion = defaultFormat.version;\n\t\t}\n\t}\n\n\t// Repair ID conflicts with other stories.\n\n\tif (\n\t\tallStories.some(otherStory => {\n\t\t\tif (otherStory === story) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn otherStory.id === story.id;\n\t\t})\n\t) {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(story, 'id', newId, \"conflicted with another story's ID\");\n\t\trepairs.id = newId;\n\t}\n\n\t// Repair all passages. All story ID changes must be before this to prevent\n\t// mismatches. We merge in repairs temporarily here so that passages see the\n\t// most correct ID.\n\n\tlet anyPassageRepaired = false;\n\tconst repairedPassages = story.passages.map(passage => {\n\t\tconst repairedPassage = repairPassage(passage, {...story, ...repairs});\n\n\t\tif (repairedPassage !== passage) {\n\t\t\tanyPassageRepaired = true;\n\t\t\treturn repairedPassage;\n\t\t}\n\n\t\treturn passage;\n\t});\n\n\tif (anyPassageRepaired) {\n\t\trepairs.passages = repairedPassages;\n\t}\n\n\tif (Object.keys(repairs).length > 0) {\n\t\treturn {...story, ...repairs};\n\t}\n\n\treturn story;\n}\n","import {Passage, Story, StoriesState} from '../stories.types';\nimport {isPersistablePassageChange} from '../../persistence/persistable-changes';\n\nexport function updatePassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageId: string,\n\tpassageProps: Omit<Partial<Passage>, 'id' | 'story'>\n) {\n\tlet storyExists = false;\n\tlet updated = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tstoryExists = true;\n\n\t\tif (\n\t\t\t'name' in passageProps &&\n\t\t\tstory.passages.some(\n\t\t\t\tpassage =>\n\t\t\t\t\tpassage.name === passageProps.name && passage.id !== passageId\n\t\t\t)\n\t\t) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with name \"${passageProps.name}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tconst newStory: Story = {\n\t\t\t...story,\n\t\t\tpassages: story.passages.map(passage => {\n\t\t\t\tif (passage.id !== passageId) {\n\t\t\t\t\treturn passage;\n\t\t\t\t}\n\n\t\t\t\tupdated = true;\n\t\t\t\treturn {...passage, ...passageProps};\n\t\t\t})\n\t\t};\n\n\t\tif (updated) {\n\t\t\tif (isPersistablePassageChange(passageProps)) {\n\t\t\t\tnewStory.lastUpdate = new Date();\n\t\t\t}\n\n\t\t\treturn newStory;\n\t\t}\n\n\t\tconsole.warn(\n\t\t\t`Asked to update a passage with ID \"${passageId}\", but it does not exist in story ID ${storyId}, taking no action`\n\t\t);\n\t\treturn story;\n\t});\n\n\tif (!storyExists) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!updated) {\n\t\t// Should have warned above.\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {createPassage} from './create-passage';\nimport {createPassages} from './create-passages';\nimport {createStory} from './create-story';\nimport {deletePassage} from './delete-passage';\nimport {deletePassages} from './delete-passages';\nimport {deleteStory} from './delete-story';\nimport {initState} from './init';\nimport {repairState} from './repair';\nimport {updatePassage} from './update-passage';\nimport {updatePassages} from './update-passages';\nimport {updateStory} from './update-story';\nimport {StoriesAction, StoriesState} from '../stories.types';\n\nexport const reducer: React.Reducer<StoriesState, StoriesAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'createPassage':\n\t\t\treturn createPassage(state, action.storyId, action.props);\n\n\t\tcase 'createPassages':\n\t\t\treturn createPassages(state, action.storyId, action.props);\n\n\t\tcase 'createStory':\n\t\t\treturn createStory(state, action.props);\n\n\t\tcase 'deletePassage':\n\t\t\treturn deletePassage(state, action.storyId, action.passageId);\n\n\t\tcase 'deletePassages':\n\t\t\treturn deletePassages(state, action.storyId, action.passageIds);\n\n\t\tcase 'deleteStory':\n\t\t\treturn deleteStory(state, action.storyId);\n\n\t\tcase 'init':\n\t\t\treturn initState(state, action.state);\n\n\t\tcase 'repair':\n\t\t\treturn repairState(state, action.allFormats, action.defaultFormat);\n\n\t\tcase 'updatePassage':\n\t\t\treturn updatePassage(\n\t\t\t\tstate,\n\t\t\t\taction.storyId,\n\t\t\t\taction.passageId,\n\t\t\t\taction.props\n\t\t\t);\n\n\t\tcase 'updatePassages':\n\t\t\treturn updatePassages(state, action.storyId, action.passageUpdates);\n\n\t\tcase 'updateStory':\n\t\t\treturn updateStory(state, action.storyId, action.props);\n\n\t\tdefault:\n\t\t\tconsole.warn(`${(action as any).type} not implemented yet`);\n\t}\n\n\treturn state;\n};\n","import {Passage, StoriesState} from '../stories.types';\nimport {createPassage} from './create-passage';\n\nexport function createPassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageProps: Partial<Passage>[]\n) {\n\treturn passageProps.reduce(\n\t\t(state, props) => createPassage(state, storyId, props),\n\t\tstate\n\t);\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults, storyDefaults} from '../defaults';\nimport {Story, StoriesState} from '../stories.types';\n\nexport function createStory(state: StoriesState, storyProps: Partial<Story>) {\n\tif ('id' in storyProps && state.some(story => story.id === storyProps.id)) {\n\t\tconsole.warn(\n\t\t\t`There is already a story in state with ID \"${storyProps.id}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tif (\n\t\t'name' in storyProps &&\n\t\tstate.some(story => story.name === storyProps.name)\n\t) {\n\t\tconsole.warn(\n\t\t\t`There is already a story in state with name \"${storyProps.name}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tlet story: Story = {\n\t\tid: uuid(),\n\t\t...storyDefaults(),\n\t\tifid: uuid().toUpperCase(),\n\t\tlastUpdate: new Date(),\n\t\tpassages: [],\n\t\ttags: [],\n\t\ttagColors: {},\n\t\t...storyProps\n\t};\n\n\t// If we are prepopulating the story with passages, make sure they have the\n\t// correct ID linkage, and at least make sure basic properties are set.\n\n\tstory.passages = story.passages.map(passage => ({\n\t\t...passageDefaults,\n\t\t...passage,\n\t\tstory: story.id\n\t}));\n\n\treturn [...state, story];\n}\n","import {StoriesState} from '../stories.types';\nimport {deletePassage} from './delete-passage';\n\nexport function deletePassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageIds: string[]\n) {\n\treturn passageIds.reduce(\n\t\t(state, passageId) => deletePassage(state, storyId, passageId),\n\t\tstate\n\t);\n}\n","import {StoriesState} from '../stories.types';\n\nexport function deleteStory(state: StoriesState, storyId: string) {\n\tlet deleted = false;\n\tconst newState = state.filter(story => {\n\t\tif (story.id === storyId) {\n\t\t\tdeleted = true;\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t});\n\n\tif (!deleted) {\n\t\tconsole.warn(\n\t\t\t`Asked to delete a story with ID \"${storyId}\", but it does not exist in state`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {Story, StoriesState} from '../stories.types';\n\nexport function initState(state: StoriesState, init: Story[]) {\n\treturn [...init];\n}\n","import {repairStory} from './repair-story';\nimport {StoryFormat} from '../../../story-formats';\nimport {StoriesState} from '../../stories.types';\n\nexport function repairState(\n\tstate: StoriesState,\n\tallFormats: StoryFormat[],\n\tdefaultFormat: StoryFormat\n): StoriesState {\n\treturn state.map(story =>\n\t\trepairStory(story, state, allFormats, defaultFormat)\n\t);\n}\n","import {Passage, StoriesState} from '../stories.types';\nimport {updatePassage} from './update-passage';\n\nexport function updatePassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageUpdates: Record<string, Partial<Passage>>\n) {\n\treturn Object.keys(passageUpdates).reduce(\n\t\t(state, passageId) =>\n\t\t\tupdatePassage(state, storyId, passageId, passageUpdates[passageId]),\n\t\tstate\n\t);\n}\n","import {Story, StoriesState} from '../stories.types';\nimport {isPersistableStoryChange} from '../../persistence/persistable-changes';\n\nexport function updateStory(\n\tstate: StoriesState,\n\tstoryId: string,\n\tstoryProps: Partial<Omit<Story, 'id'>>\n) {\n\tif (\n\t\t'name' in storyProps &&\n\t\tstate.some(story => story.name === storyProps.name && story.id !== storyId)\n\t) {\n\t\tconsole.warn(\n\t\t\t`There is another story in state with name \"${storyProps.name}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tlet updated = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tupdated = true;\n\n\t\tconst updatedStory = {...story, ...storyProps};\n\n\t\tif (isPersistableStoryChange(storyProps)) {\n\t\t\tupdatedStory.lastUpdate = new Date();\n\t\t}\n\n\t\treturn updatedStory;\n\t});\n\n\tif (!updated) {\n\t\tconsole.warn(\n\t\t\t`Asked to update a story with ID \"${storyId}\", but it does not exist in state`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import * as React from 'react';\nimport useThunkReducer from 'react-hook-thunk-reducer';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {reducer} from './reducer';\nimport {\n\tStoriesContextProps,\n\tStoriesAction,\n\tStoriesState\n} from './stories.types';\nimport {useStoryFormatsContext} from '../story-formats';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\n\nexport const StoriesContext = React.createContext<StoriesContextProps>({\n\tdispatch: () => {},\n\tstories: []\n});\n\nStoriesContext.displayName = 'Stories';\n\nexport const useStoriesContext = () => React.useContext(StoriesContext);\n\nexport const StoriesContextProvider: React.FC = props => {\n\tconst {stories: storiesPersistence} = usePersistence();\n\tconst {formats} = useStoryFormatsContext();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tStoriesState,\n\t\tStoriesAction\n\t> = React.useMemo(\n\t\t() => (state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tstoriesPersistence.saveMiddleware(newState, action, formats);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistStories');\n\t\t\t}\n\n\t\t\treturn newState;\n\t\t},\n\t\t[formats, reportError, storiesPersistence]\n\t);\n\tconst [stories, dispatch] = useThunkReducer(persistedReducer, []);\n\n\treturn (\n\t\t<StoriesContext.Provider value={{dispatch, stories}}>\n\t\t\t{props.children}\n\t\t</StoriesContext.Provider>\n\t);\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport './text-area.css';\n\nexport interface TextAreaProps {\n\tonChange?: (event: React.ChangeEvent<HTMLTextAreaElement>) => void;\n\tonInput?: (event: React.FormEvent<HTMLTextAreaElement>) => void;\n\torientation?: 'horizontal' | 'vertical';\n\tplaceholder?: string;\n\tvalue: string;\n\tstyle?: object;\n}\n\nexport const TextArea: React.FC<TextAreaProps> = props => {\n\tconst className = classNames(\n\t\t'text-area',\n\t\t`orientation-${props.orientation}`\n\t);\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"text-input-label\">{props.children}</span>\n\t\t\t\t<textarea\n                    rows={3}\n\t\t\t\t\tonChange={props.onChange}\n\t\t\t\t\tonInput={props.onInput}\n\t\t\t\t\tplaceholder={props.placeholder}\n\t\t\t\t\tvalue={props.value}\n\t\t\t\t\tstyle={props.style || {}}\n\t\t\t\t/>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {TextInput} from '../control/text-input';\nimport {TextArea} from '../control/text-area';\n\nimport './add-onstart-button.css';\nimport { IconButton } from '../control/icon-button';\nimport { IconPlus, IconTrashX } from '@tabler/icons';\nimport { TextSelect } from '../control/text-select';\n\nexport interface Speech {\n    words?: string,\n    voice?: string,\n    rate?: string,\n    delay?: string,\n}\n\nexport interface AddSpeechProps {\n\tonAdd: (lines:Speech[]) => void,\n    lines: Speech[]\n}\n/*\n {name:\"Daniel\", id:\"p226\"},\n    {name:\"Fred\", id:\"p228\"},\n    {name:\"Richard\", id:\"p230\"},\n    {name:\"Dave\", id:\"p231\"},\n    {name:\"Robin\", id:\"p234\"},\n    {name:\"Charlie\", id:\"p236\"},\n    {name:\"Kate\", id:\"p237\"},\n    {name:\"Ed\", id:\"p239\"},\n    {name:\"Geeta\", id:\"p240\"},\n    {name:\"Paul\", id:\"p241\"},\n    {name:\"Eleanor\", id:\"p243\"},\n    {name:\"Molly\", id:\"p245\"},\n    {name:\"Izzy\", id:\"p248\"},\n    {name:\"Holly\", id:\"p374\"},\n    {name:\"Nadia\", id:\"p362\"},\n    {name:\"Chloe\", id:\"p361\"},\n]*/\n\nconst voices = [\n    {name:\"Daniel\"},\n    {name:\"Fred\"},\n    {name:\"Richard\"},\n    {name:\"Dave\"},\n    {name:\"Robin\"},\n    {name:\"Charlie\"},\n    {name:\"Kate\"},\n    {name:\"Ed\"},\n    {name:\"Geeta\"},\n    {name:\"Paul\"},\n    {name:\"Eleanor\"},\n    {name:\"Molly\"},\n    {name:\"Izzy\"},\n    {name:\"Holly\"},\n    {name:\"Nadia\"},\n    {name:\"Chloe\"},\n]\n\nexport const AddSpeech: React.FC<AddSpeechProps> = props => {\n\tconst {onAdd, lines} = props;\n    const lastline = lines.length > 0 ? lines[lines.length-1] : {};\n\n\tconst [words, setWords] = React.useState(lastline.words || '');\n    const [voice, setVoice] = React.useState(lastline.voice || '');\n    const [rate, setRate]   = React.useState(lastline.rate || '') ;\n    const [delay, setDelay] = React.useState(lastline.delay || '');\n    const [lineIndex, setLineIndex] = React.useState(Math.max(lines.length-1,0));\n\n    const handleAdd = ()=>{\n        const newlines = [...(lines||[]).map((item,i)=>{\n            if (i===lineIndex){\n                return {words, voice, rate, delay}\n            }\n            return item;\n        }),{}];\n        onAdd(newlines);\n        setLineIndex(lines.length);\n        setWords('some words');\n        setVoice('Daniel');\n        setRate('');\n        setDelay('');\n    }\n\n    React.useEffect(()=>{\n        const line = lines[lineIndex] || {};\n        setWords(line?.words || \"\");\n        setVoice(line?.voice || \"Daniel\");\n        setRate(line?.rate || \"180\");\n        setDelay(line?.delay || \"0\");\n    },[lineIndex])\n\n    React.useEffect(()=>{\n       // if (lineIndex === 0){\n        //    onAdd([{words, voice, rate, delay}]);\n       // }\n       // else{\n            const newlines = (lines||[]).map((item,i)=>{\n                if (i===lineIndex){\n                    return {words, voice, rate, delay}\n                }\n                return item;\n            })\n            onAdd(newlines)\n      //  }\n    },[words,voice,rate,delay]);\n\n    const deleteLine = (index:number)=>{\n        onAdd([...lines.slice(0, index),...lines.slice(index + 1)]);\n    }\n\n    const renderLines = ()=>{\n       const rows =  lines.map((line,i)=>(<tr onClick={()=>{setLineIndex(i)}} key={i} >\n          \n                    <td style={{fontSize:\"0.9em\", paddingTop:7, width:220, maxWidth:220, overflow:\"hidden\"}}>{line.words}</td> \n                    <td style={{fontSize:\"0.9em\", paddingTop:7}}>{line.voice}</td>\n                    <td style={{fontSize:\"0.9em\", paddingTop:7}}>{line.delay}</td>\n                    <td style={{fontSize:\"0.9em\", paddingTop:7}}><IconButton icon={<IconTrashX />} iconOnly={true} label={\"\"} onClick={()=>{deleteLine(i)}} variant=\"primary\"/></td>\n                </tr>))\n\n        return  <div style={{maxHeight:500, overflowY:\"scroll\"}}>\n                <table>\n                    <thead>\n                        <tr>\n                            <th style={{textAlign:\"start\", fontSize:\"0.9em\"}}>words</th>\n                            <th style={{textAlign:\"start\",fontSize:\"0.9em\"}}>voice</th>\n                            <th style={{textAlign:\"start\",fontSize:\"0.9em\"}}>pause(ms)</th>\n                            <th style={{textAlign:\"start\"}}></th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                            {rows}\n                    </tbody>\n                </table>\n                </div>\n    }\n\n\tconst {t} = useTranslation();\n\n\n    const handleVoiceSelect = (e:React.ChangeEvent<HTMLSelectElement>)=>{\n        var audio = new Audio();\n        audio.src = `/speechsamples/${e.target.value}.wav`;\n        audio.play();\n        setVoice(e.target.value)\n    }\n\n    return (<div className=\"speechcontainer\">\n            <div style={{borderBottom:\"1px solid black\", marginBottom:15}}>\n            <div className=\"speechformitem\">\n                <TextArea  style={{width:268}} placeholder=\"something to say\" onChange={e => setWords(e.target.value.replace( /[,]/g,\" \"))} value={words}>words</TextArea></div>\n            <div className=\"paramline\" style={{marginTop:15}}>\n               \n                <TextSelect onChange={handleVoiceSelect} options={voices.map(a => ({ label: a.name, value: a.name }))} value={voice}>{\"voice\"}</TextSelect>\n                \n                {/*<TextInput style={{width:60}}  placeholder=\"rate\" onChange={e => setRate(e.target.value)} value={rate}></TextInput>*/}\n                <TextInput style={{width:90}}  placeholder=\"delay(ms)\" onChange={e => setDelay(e.target.value)} value={delay}></TextInput>\n            </div>\n            \n            <div style={{marginTop:10, marginBottom:15, textAlign:\"center\"}}>\n                <IconButton icon={<IconPlus />} label={'add more speech'} onClick={handleAdd} variant=\"create\"/>\n            </div>\n            </div>\n            {renderLines()}\n        </div>);\n}\n","import { IconCheck, IconTrashX, IconUpload } from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport { IconButton } from '../control/icon-button';\nimport {TextInput} from '../control/text-input';\nimport { TextSelect } from '../control/text-select';\nimport { Action, Method } from '../onstart/add-actions';\nimport { AddSpeech } from '../onstart/add-speech';\nimport request from 'superagent';\n\nimport './add-rules-button.css';\n\nexport interface AddActionProps {\n\t/**\n\t * Called when the user chooses to add a tag. If they are adding a\n\t * pre-existing tag, it will only send a name.\n\t */\n\tonAdd: (action:Action) => void;\n    onClose: () => void;\n    action: Action;\n}\n\nexport interface Rule {\n    operator: string\n    operand: string\n    actions: Action[][]\n    next: string\n}\n\n//TODO - put in placeholders for urls!\n\nconst actions = [\n    {name: \"raw\", id:\"raw\", url:\"\", params:\"{}\", method:Method.GET, description:\"Call this custom url\"},\n    {name: \"arm expand\", id:\"arm-expand\", url:\"http://[lenovo]:9107/api/arm/expand\", params:\"{}\", method:Method.GET, description:\"This will move the camera arm into the extended state\"},\n    {name: \"arm collapse\", id:\"arm-collapse\", url:\"http://[lenovo]:9107/api/collapse\", params:\"{}\", method:Method.GET, description:\"This will move the camera arm into the rest state\"},\n    {name: \"fan\", id: \"fan\", url:\"http://[lenovo]:9097/ui/api/fan\", params:`{\"query\":{\"rotate\": true,\"power\":10,\"cool\":true,\"from\":0,\"to\":90}}`, method:Method.GET, description:\"This will control the dyson fan (temperature, air speed, rotation)\"},\n    {name: \"smell right on\", id: \"smell-right-on\", url:\"http://[smell-right]/on3\", method:Method.GET, params:\"{}\", description:\"This will start the right hand side smell actuator\"},\n    {name: \"smell right off\", id: \"smell-right-off\", url:\"http://[smell-right]/off\", method:Method.GET, params:\"{}\", description:\"This will turn off the right hand side smell actuator\"},\n    {name: \"smell left on\", id: \"smell-left-on\", url:\"http://[smell-left]/on3\", method:Method.GET, params:\"{}\", description:\"This will start the left hand side smell actuator\"},\n    {name: \"smell left off\", id: \"smell-left-off\", url:\"http://[smell-left]/off\", method:Method.GET, params:\"{}\", description:\"This will turn off the left hand side smell actuator\"},\n    {name: \"nanoleaf\", id:\"nanoleaf\", url:\"http://[lenovo]:9104/ui/api/hex\", method:Method.GET,params:`{\"query\":{\"hue\":203,\"sat\":91,\"brightness\":99}}`, description:\"This will set the colours of the nanoleaf lights (under the caravan seat)\"},\n    {name: \"hue\", id: \"huecolour\", method:Method.GET,url:\"http://[lenovo]:9092/ui/api/hex\",  params:`{\"query\":{\"hex\":\"ff0000\"}}`, description:\"This will change the hue lights colour\"},\n    /*{name: \"huescript\", id: \"huescript\", method:Method.GET,url:\"http://[lenovo]:9092/ui/api/light_script\",  params:`{\"query\":{\"script_id\":\"alightscript\"}}`, description:\"This will run a pre-authored script that sets the hue light's colours (the strip above the screen)\"},*/\n    {name: \"togglewindows\", id: \"togglewindows\", method:Method.GET,url:\"http://[windows]:9222/H\",  params:\"{}\", description:\"This will toggle the opacity of the caravan windows\"},\n    {name: \"printline\", id: \"printline\", method:Method.POST, url:\"http://[receipt]:8080/print\", params:`{\"body\":{\"text\":\"a line of text\"}}`, description:\"This will print a line of text on the label printer\"},\n    {name: \"speech\", id: \"speech\", method:Method.POST, url:\"http://[speech]:9105/api/speech\", params:`{\"body\":{\"speech\":[{\"words\":\"a line of speech\"}]}}`, description:\"This will send text to the speech synthesizer, or if you render, it will play speech generated Mozilla's speech synthesizer\"},\n    {name: \"screen - home\", id: \"screen-home\", method:Method.GET, url:\"http://[lenovo]:9102/api/home\", params:\"{}\", description:\"This set the caravan screen to the 'future mundane' title\"},\n    {name: \"screen - dyson\", id: \"screen-dyson\", method:Method.GET, url:\"http://[lenovo]:9102/api/air\", params:\"{}\", description:\"This will show the air quality readings from the dyson fan\"},\n    {name: \"screen - media\", id: \"screen-media\", method:Method.GET, url:\"http://[lenovo]:9102/api/media\", params:\"{}\", description:\"This will make the caravan screen go black, ready to play a media file.  Follow this action with a 'screen - play' action\"},\n    {name: \"screen - play\", id: \"screen-media-play\", method:Method.GET, url:\"http://[lenovo]:9102/api/media/play\",  params:`{\"query\":{\"media\":\"\",\"delay\":0}}`, description:\"This will play a media (mp4) file, which must be in the media directory on the lenovo.  Make sure you have called 'screen - media' first \"},\n    {name: \"screen - camera\", id: \"screen-camera\", method:Method.GET, url:\"http://[lenovo]:9102/api/camera\", params:\"{}\", description:\"This will show live video from the camera on the caravan screen\"},\n    /*{name: \"screen - scan\", id: \"screen-scan\", method:Method.GET, url:\"http://[lenovo]:9102/api/camera/scan\", params:\"{}\", description:\"This will place face meshes over all faces in the streamed video (make sure you have called the 'screen-camera' action first\"},*/\n    {name: \"screen - message\", id: \"message\", method:Method.GET, url:\"http://[lenovo]:9102/api/message\", params:`{\"query\":{\"message\":\"a message\"}}`, description:\"This will flash up a message on the screen, it will overlay it on whatever is currently on there\"},\n    {name: \"screen - qrcode\", id: \"qrcode\", method:Method.GET, url:\"http://[lenovo]:9102/api/qrcode\", params:`{\"query\":{\"qrcode\":\"http://[lenovo]:3001/wa/\"}}`, description:\"This will put a qrcode up on the screen to, for example, get a user to use a webapp served by the caravan.  Webapps could call bespoke webhook event to make something happen in the caravan\"},\n    /*{name: \"mini screen\", id:\"mini-screen\", method:Method.GET, url:\"http://[lenovo]:9107/api/update\", params:`{\"query\":{\"html\":\"<img src='https://via.placeholder.com/150'>\"}}`, description:\"This will send arbitrary HTML to the caravan's mini screens\"},*/\n]\n\nconst _lookupaction = (action:Action)=>{\n    const url = (action.action || \"\").toString();\n    const idx = actions.map(a=>a.url).indexOf(url);\n    return idx === -1 ? \"raw\" : actions[idx].id;\n}\n\nexport const AddAction: React.FC<AddActionProps> = props => {\n\tconst {onAdd,onClose,action} = props;\n\tconst [_action, _setAction] = React.useState<Action>(action);\n    const [file, setFile] = React.useState<File>();\n    const [mediaList, setMediaList] = React.useState<string[]>([]);\n    const [selectedActionProfile, setSelectedActionProfile] = React.useState(_lookupaction(action));\n\tconst {t} = useTranslation();\n\n    React.useEffect(()=>{\n        request.get(\"/media/list\").end((err,response)=>{\n            if (!err){\n                const {files=[]} = response.body;\n                setMediaList(files);\n            }\n        })\n        \n    },[file]);\n\n\tconst handleMethodChange = (event: React.ChangeEvent<HTMLSelectElement>)=>{\n\t\tconst _method = event.target.value;\n\t\tsetMethod(_method === \"POST\" ? Method.POST : Method.GET);\n\t}\n\n\tconst cancel = (e:React.MouseEvent<Element, MouseEvent>)=>{\n\t\te.stopPropagation();\n\t}\n\n    //convert to URL later!\n    const setAction = (actionstr: string=\"\")=>{\n        _setAction({ \n            ..._action,\n            action : actionstr\n        })\n    }\n\n    const setParams = (params:string=\"\")=>{\n        _setAction({ \n            ..._action,\n            params \n        })\n    }\n\n    const setMethod = (method: Method=Method.GET)=>{\n        _setAction({ \n           ..._action,\n           method,\n        })\n    }\n\n    const setDelay = (delay:string=\"0\")=>{\n        _setAction({ \n           ..._action,\n           delay: isNaN(Number(delay)) ? 0 : Number(delay)\n        })\n    }\n\n    const _format = (action:Action)=>{\n        return {\n            ...action,\n            delay: isNaN(Number(action.delay)) ? 0 : Number(action.delay),\n            method: action.method ? action.method : Method.GET,\n            params: action.params || \"\",\n        }\n\n    }\n\n    const handleActionChange = (e:React.ChangeEvent<HTMLSelectElement>)=>{\n        setSelectedActionProfile(e.target.value);\n        _setAction({\n            ..._action,\n            ...actions.reduce((acc, item)=>{\n                if (item.id===e.target.value){\n                    return {\n                        action:item.url,\n                        params:item.params,\n                        method:item.method,\n                        delay:0\n                    }\n                }\n                return acc;\n            },{})\n        })\n    }\n\n    const description = ()=>{\n        return actions.reduce((acc, item)=>{\n            if (item.id===selectedActionProfile){\n               return item.description;\n            }\n            return acc;\n        },\"\")\n    }\n\n    const _hueparams = ()=>{\n       \n        const params = JSON.parse(_action.params || \"{}\");\n        const {query={}} = params;\n        const {hex=\"ff0000\"} = query;\n        return <> \n            <input type=\"color\" id=\"favcolor\" name=\"favcolor\" value={`#${hex}`} onChange={(e)=>{setParams(JSON.stringify({query:{hex:e.target.value.replace(\"#\",\"\")}}))}}/>\n            <p className=\"description\">select a colour for the lights</p>\n        </>\n    }\n\n    const _nanoparams = ()=>{\n       \n        const params = JSON.parse(_action.params || \"{}\");\n        const {query={}} = params;\n        const {hex=\"ff0000\"} = query;\n        return <> \n            <input type=\"color\" id=\"favcolor\" name=\"favcolor\" value={`#${hex}`} onChange={(e)=>{setParams(JSON.stringify({query:{hex:e.target.value.replace(\"#\",\"\")}}))}}/>\n            <p className=\"description\">select a colour for the lights</p>\n        </>\n    }\n\n    const _rawparams = ()=>{\n        return <TextInput onChange={e => setParams(e.target.value)} helptext={`as a json object e.g {'greeting':{'hello':'world'}}`} value={_action.params||\"\"}>params</TextInput>\n    }\n\n    const _messageparams = ()=>{\n        const params = JSON.parse(_action.params || \"{}\");\n        const {query={}} = params;\n        const {message=\"a message\"} = query;\n        return <TextInput onChange={e => setParams(JSON.stringify({query:{message:e.target.value}}))} helptext={`the message you want to display`} value={message}>message</TextInput>\n    }\n\n    const onFileChange = (e:React.ChangeEvent<HTMLInputElement>)=>{\n        const {files=[]} = e.target;\n        if (files && files.length > 0){\n            setFile(files[0]);\n        }\n    }\n\n    const onFileUpload = ()=>{\n        if (file){\n            const formData = new FormData(); \n     \n            // Update the formData object \n            formData.append( \n                \"mediaFile\", \n                file,\n                file.name \n            ); \n\n            request.post(\"/media/upload\").send(formData).end(function(err, response) {\n                console.log(err, response);\n                if (!err){\n                    setFile(undefined);\n                    setParams(JSON.stringify({query:{media:file.name}}));\n                }\n            });\n        }\n        \n    }\n\n    const _mediaparams = ()=>{\n\n        const params = JSON.parse(_action.params || \"{}\");\n        const {query={}} = params;\n        const {media=\"\"} = query;\n\n        const _setMedia = (e:React.ChangeEvent<HTMLSelectElement>)=>{\n            console.log(\"setting media\", e.target.value);\n           setParams(JSON.stringify({query:{media:e.target.value}}));\n        }\n\n        return  <div style={{paddingBottom:7}}>\n                    <div style={{paddingTop:7,paddingBottom:15,  borderBottom:\"1px solid\"}}>\n                        <div style={{marginTop:7,marginBottom:15, fontWeight:700}}>\n                                Select from media on caravan server\n                        </div>\n                        <TextSelect onChange={_setMedia}  options={[{label:\"\",value:\"\"},...mediaList.map(m=>({label:m, value:m}))]} value={media}>media in caravan</TextSelect>\n                    </div>\n                    <div style={{paddingTop:15,paddingBottom:7}}>\n                        <div style={{marginTop:7, marginBottom:15, fontWeight:700}}>\n                            Or upload new media\n                        </div>\n                        <div>\n                            <input type=\"file\" onChange={onFileChange} /> \n                        </div>\n                        <div style={{marginTop:10}}>\n                            {file && <IconButton\n                                    disabled={false}\n                                    icon={<IconUpload />}\n                                    label={t('Upload this file')}\n                                    onClick={onFileUpload}\n                                    variant=\"primary\"\n                            />}\n                        </div>\n                    </div>\n                   {media.trim() != \"\" && <div style={{textAlign:\"center\", borderRadius: 5, padding:10, marginTop:15, fontSize:\"1em\"}}><strong>play file: </strong>{`${media}`}</div>}\n                </div>\n    }\n\n    //{\"body\":{\"text\":\"a line of text\"}}\n    const _printerparams = ()=>{\n        const params = JSON.parse(_action.params || \"{}\");\n        const {body={}} = params;\n        const {text=\"a line to print\"} = body;\n        return <TextInput onChange={e => setParams(JSON.stringify({body:{text:e.target.value}}))} helptext={`the message you want to display`} value={text}>line to print</TextInput>\n    }\n\n    const _qrcodeparams = ()=>{\n        const params = JSON.parse(_action.params || \"{}\");\n        const {query={}} = params;\n        const {qrcode=\"http://[lenovo]:3001/wa/\"} = query;\n        return <TextInput onChange={e => setParams(JSON.stringify({query:{qrcode:e.target.value}}))} helptext={`the url to embed with the qrcode`} value={qrcode}>url</TextInput>\n    }\n\n    const _speechparams = ()=>{\n        \n        //FIX!!\n        const params = JSON.parse(_action.params || \"{}\");\n        const {body={}} = params;\n        const {speech=[]} = body;\n        return <AddSpeech lines={speech} onAdd={(lines)=>{setParams(JSON.stringify({body:{speech:lines}}))}}/>\n    }\n\n\n    const _fanparams = ()=>{\n        const params = JSON.parse(_action.params || \"{}\");\n        const {query={}} = params;\n        const {rotate=true, power=10, cool=true, from=0, to=90} = query;\n        \n        const _handleRotateChange = (e:React.ChangeEvent<HTMLSelectElement>)=>{\n            setParams(JSON.stringify({query:{rotate:e.target.value===\"true\" ? true : false, power, cool, from, to}}));\n        }\n\n        const _handlePowerChange = (e:React.ChangeEvent<HTMLSelectElement>)=>{\n            setParams(JSON.stringify({query:{rotate, power:Number(e.target.value), cool, from, to}}));\n        }\n\n        const _handleTempChange = (e:React.ChangeEvent<HTMLSelectElement>)=>{\n            setParams(JSON.stringify({query:{rotate, cool:e.target.value===\"true\" ? true : false, power, from, to}}));\n        }\n\n        const _handleFromChange = (e:React.ChangeEvent<HTMLInputElement>)=>{\n            if (!isNaN(Number(e.target.value))){\n                setParams(JSON.stringify({query:{rotate, cool, power, from:Number(e.target.value), to}}));\n            }\n        }\n\n        const _handleToChange = (e:React.ChangeEvent<HTMLInputElement>)=>{\n            if (!isNaN(Number(e.target.value))){\n                setParams(JSON.stringify({query:{rotate, cool, power, to:Number(e.target.value), from}}));\n            }\n        }\n\n        const powerlabels = [0,1,2,3,4,5,6,7,8,9,10].map(i=>({label:`${i}`, value:`${i}`}))\n\n\n        return  <div style={{display:\"flex\", flexDirection:\"column\"}}>\n                    <div className=\"formItem\">\n                        <TextSelect onChange={_handleRotateChange}  options={[{label:\"true\", value:\"true\"}, {label:\"false\", value:\"false\"}]} value={rotate ? \"true\": \"false\"}>rotate</TextSelect>\n                    </div>\n                    <div className=\"formItem\">\n                        <TextSelect onChange={_handlePowerChange}  options={powerlabels} value={power}>power</TextSelect>\n                    </div>\n                    <div className=\"formItem\">\n                        <TextSelect onChange={_handleTempChange} options={[{label:\"true\", value:\"true\"}, {label:\"false\", value:\"false\"}]} value={cool ? \"true\": \"false\"}>cool</TextSelect>\n                    </div>\n                    <div className=\"formItem\">\n                        <TextInput onChange={_handleFromChange} helptext={`rotation from (deg)`} value={from}>rotation from</TextInput>\n                    </div>\n                    <div className=\"formItem\">\n                        <TextInput onChange={_handleToChange} helptext={`rotation to (deg)`} value={to}>rotation to</TextInput>\n                    </div>\n                </div>\n    }\n\n    const renderParams = ()=>{\n       \n        switch (selectedActionProfile){\n            case \"screen-media-play\":\n                return _mediaparams();\n            case \"nanoleaf\":\n                return _nanoparams();\n            case \"huecolour\":\n                return _hueparams();\n            case \"raw\":\n                return _rawparams();\n            case \"message\": // message on screen!\n                return _messageparams();\n            case \"printline\": // send to label printer\n                return _printerparams();\n            case \"fan\":\n                return _fanparams();\n            case \"speech\":    \n                return _speechparams();\n            case \"qrcode\":\n                return _qrcodeparams();    \n            default:\n                return;\n\n        }\n    }\n\n    const renderMethod = ()=>{\n        if (selectedActionProfile == \"raw\"){\n            return <TextSelect onChange={handleMethodChange} options={[\n                {disabled:false, label:\"GET\", value:Method.GET},\n                {disabled:false, label:\"POST\", value:Method.POST}\n                ]} value={_action.method === Method.POST ? Method.POST : Method.GET}>\n                {\"method\"}\n            </TextSelect>\n        }\n    }\n\n    const renderURL = ()=>{\n        if (selectedActionProfile === \"raw\"){\n            return <TextInput onChange={e => setAction(e.target.value)} value={_action.action.toString()} helptext={'a url or a tag!'}>url</TextInput>\n        }\n    }\n\n    return (<div className=\"add-dialogue\">\n                <div className=\"heading\">add action</div>\n                <div className=\"formItem\">\n                    <TextSelect onChange={handleActionChange} options={actions.map(a => ({ label: a.name, value: a.id }))} value={selectedActionProfile}>{\"action profiles\"}</TextSelect>\n                </div>\n                <div className=\"description\">\n                    {description()}\n                </div>\n                <div className=\"formItem\">\n                    {renderURL()}\n                </div>\n                <div className=\"formItem\">\n                    {renderMethod()}\n                </div>\n                <div className=\"formItem\">\n                    {renderParams()}\n                </div>\n                <div className=\"formItem\">\n                    <TextInput style={{width:60}} onChange={e => setDelay(e.target.value)} helptext={`pause in ms BEFORE action fires`} value={`${_action.delay||0}`}>delay</TextInput>\n                </div>\n                <div style={{textAlign:\"center\"}}>\n                <IconButton icon={<IconCheck />} iconOnly={true} label={\"\"} onClick={()=>onAdd(_format(_action))} variant=\"primary\"/> \n                <IconButton icon={<IconTrashX />} iconOnly={true} label={\"\"} onClick={onClose} variant=\"primary\"/> \n                </div>\n            </div>)\n\n};\n","import { IconButton } from \"../control/icon-button\";\nimport { Action, Method } from \"../onstart/add-actions\";\nimport {  IconArrowBarRight, IconEdit, IconPlus, IconTrashX } from '@tabler/icons';\nimport { AddAction } from './add-action';\nimport React from \"react\";\n\nexport interface ActionsProps {\n    actions: Action[][];\n    deleteAction: (aindex:number,subindex:number)=>void;\n    addParallelAction:()=>void;\n    addAction:(aindex:number, action:Action)=>void;\n    editAction:(aindex:number, subindex:number, action:Action)=>void;\n}\n\n\nexport const Actions: React.FC<ActionsProps> = props => {\n    const {actions} = props;\n    const [mode, setMode] = React.useState(\"\");\n    const [actionIndex, setActionIndex] = React.useState(0);\n    const [actionSubIndex, setActionSubIndex] = React.useState(0);\n\n    const onEdit  = (aindex:number,subindex:number)=>{\n        setMode(\"edit\");\n        setActionIndex(aindex); \n        setActionSubIndex(subindex); \n    }\n\n    const onDelete  = (aindex:number,subindex:number)=>{\n        props.deleteAction(aindex,subindex)\n    }\n\n    const onAdd = (aindex:number)=>{\n        setMode(\"add\");\n        setActionIndex(aindex)\n    }\n\n    const close = ()=>{\n        console.log(\"settin gmode to emot!!\");\n        setMode(\"\");\n    }\n\n    const addParallelAction = ()=>{\n        setMode(\"edit\");\n        setActionIndex(actions.length);\n        props.addParallelAction()\n    }\n\n    const addAction = (aindex:number, action:Action)=>{\n        console.log(\"Adding action\", action);\n        close();\n        props.addAction(aindex,action)\n    }\n\n    const bootstrap = ()=>{\n\n        return <div style={{marginTop:10}}>\n                <IconButton icon={<IconPlus />} style={{fontSize:\"0.8em\"}} label={\"add a new action\"} onClick={()=>{\n                    addAction(0,{action:\"\", params:\"{}\", method:Method.GET});\n                    setMode(\"edit\");\n                }} variant=\"primary\"/> \n        </div>\n        /*return (<>\t\t\t\t\n                {<AddAction onClose={close} action={{action:\"\"}} onAdd={(_action:Action)=>addAction(0,_action)}/>}\n                <div style={{textAlign:\"center\"}}>\n                    <IconButton icon={<IconPlus />} iconOnly={true} label={\"\"} onClick={()=>setMode(\"add\")} variant=\"primary\"/> \n                </div>\n        </>)*/\n    }\n\n    if (actions.length <= 0){\n      return bootstrap();\n    }else{\n        //TODO: schekc edit action here (how can it remember speech aprams!!)\n        const lines = actions.map((arr, aindex)=>{\n            \n            const rows =  arr.map(((action,subindex)=>{\n                return <div key={`${aindex}-${subindex}`} style={{padding:7}}>\n                    <div style={{display:\"flex\", flexDirection:\"row\", alignItems:\"center\"}}>\n                        <div style={{display: \"flex\", flex: \"1 1 auto\", flexDirection:\"column\"}}>\n                            <div style={{padding:4,display:\"flex\", flexDirection:\"row\"}}>\n                                <div style={{flex: \"1 1 auto\", fontSize:\"0.9em\"}}>after waiting {action.delay} ms, call</div> \n                            </div>\n                            <div style={{padding:4,display:\"flex\", flexDirection:\"column\"}}>\n                                <div style={{flex: \"1 1 auto\", fontSize:\"0.9em\", fontWeight:700}}>{action.action.toString()}</div> \n                            </div>\n                            \n                        </div>\t\n                        <div style={{display:\"flex\", flexDirection:\"row\"}}>\n                            <IconButton icon={<IconEdit />} iconOnly={true} label={\"\"} onClick={()=>onEdit(aindex,subindex)} variant=\"primary\"/>\n                            <IconButton icon={<IconTrashX />} iconOnly={true} label={\"\"} onClick={()=>onDelete(aindex,subindex)} variant=\"primary\"/>\n                            <IconButton icon={<IconPlus />} iconOnly={true} label={\"\"} onClick={()=>{onAdd(aindex)}} variant=\"primary\"/>\n                        </div>\n                    </div>\n                </div>\n            }))\t\t\t\t\t\n            return <div key={aindex} style={{borderLeft:\"2px solid black\", marginBottom:10}}>\n                {rows}\n            </div>\n        })\n      \n        return (<>\n            <div style={{marginLeft:10}}>\n                {mode===\"add\" && <AddAction onClose={close} action={{action:\"\"}}  onAdd={(_action:Action)=>{close(); addAction(actionIndex,_action)}}/>}\n                {mode===\"edit\" && <AddAction onClose={close} action={actions[actionIndex][actionSubIndex]} onAdd={(_action)=>{close();props.editAction(actionIndex,actionSubIndex,_action)}}/>}\n                {lines}\n            </div>\n            <IconButton icon={<IconArrowBarRight />} style={{fontSize:\"0.8em\"}} label={\"add parallel action(s)\"} onClick={()=>{addParallelAction()}} variant=\"primary\"/> \n            </>\n        )\n    }\n    \n\n}\n","import {  IconPlus,  IconX } from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport { ButtonBar } from '../container/button-bar';\nimport { IconButton } from '../control/icon-button';\nimport {TextInput} from '../control/text-input';\nimport { Action } from '../onstart/add-actions';\nimport { Actions } from './actions';\n\nimport './add-rules-button.css';\n\nexport interface AddRulesProps {\n\tonAdd: (rules:Rule[]) => void;\n\tonCancel:()=>void;\n\ttype:string;\n\trules?: Rule[];\n}\n\nexport interface Rule {\n\ttype?: string,\n    rule:{\n\t\toperator: string\n    \toperand: string | string[]\n\t}\n    actions: Action[][]\n    next: string\n}\n\nexport const AddButtonRules: React.FC<AddRulesProps> = props => {\n\tconst {onAdd, onCancel} = props;\n\tconst {t} = useTranslation();\n\n\tconst [rules, setRules] = React.useState<Rule[]>(props.rules || [{rule:{operator:\"equals\", operand:\"\"},actions:[],next:\"\"}]);\n\n\tconst addNewRule = ()=>{\n\t\tsetRules([...rules,{rule:{operator:\"equals\", operand:\"\"},actions:[],next:\"\"}]);\n\t}\n\n\tconst removeAction = (actions:Action[][], index:number, subindex:number) : Action[][]=>{\n\t\t\n\t\tif (actions.length <= index){\n\t\t\treturn actions;\n\t\t}\n\n\t\treturn (actions || []).reduce((acc:Action[][],actionarr:Action[],j)=>{\n\t\t\tif (j !== index)\n\t\t\t\treturn [...acc, actionarr]\n\t\t\tconst newactions =  actionarr.filter((a,i)=>i !== subindex);\n\t\t\treturn newactions.length <= 0 ? acc : [...acc, newactions];\n\t\t},[])\n\t}\n\n\tconst updateAction = (actions:Action[][], index:number, subindex:number, action:Action) : Action[][]=>{\n\t\t\n\t\tif (actions.length <= index){\n\t\t\treturn [...actions, [action]];\n\t\t}\n\n\t\treturn (actions || []).reduce((acc:Action[][],actionarr:Action[],j)=>{\n\t\t\tif (j !== index)\n\t\t\t\treturn [...acc, actionarr]\n\n\t\t\treturn [...acc, actionarr.map((a,i)=>{\n\t\t\t\treturn i === subindex ? action : a;\n\t\t\t})]\n\n\t\t},[])\n\t}\n\n\tconst appendAction = (actions:Action[][], index:number, action:Action) : Action[][]=>{\n\t\t\n\t\tif (actions.length <= index){\n\t\t\treturn [...actions, [action]];\n\t\t}\n\n\t\treturn (actions || []).reduce((acc:Action[][],actionarr:Action[],j)=>{\n\t\t\tif (j !== index)\n\t\t\t\treturn [...acc, actionarr]\n\n\t\t\treturn [...acc, [...actionarr, action]]\n\t\t},[])\n\t}\n\n\tconst deleteAction = (rindex:number, aindex:number, subindex:number)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: removeAction(rule.actions, aindex, subindex)\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst editAction = (rindex:number, aindex:number, subindex:number, action:Action)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: updateAction(rule.actions, aindex, subindex, action)\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst addParallelAction = (rindex:number)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: [...rule.actions, [{\"action\":\"\"}]]\t\t\t\t\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst addAction = (rindex:number, aindex:number, action:Action)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: appendAction(rule.actions, aindex, action)\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst setOperand = (index:number, operand:string)=>{\n\t\tsetRules(rules.reduce((acc:Rule[], item:Rule, i:number)=>{\n\t\t\tif (i !== index)\n\t\t\t\treturn [...acc, item];\n\t\t\treturn [...acc, {...item, rule:{...item.rule,operand}}];\n\t\t},[]));\n\t}\n\n\tconst setNext = (index:number, next:string)=>{\n\t\tsetRules(rules.reduce((acc:Rule[], item:Rule, i:number)=>{\n\t\t\tif (i !== index)\n\t\t\t\treturn [...acc, item];\n\t\t\treturn [...acc, {...item, next: next.trim()}];\n\t\t},[]));\n\t}\n\n\tconst renderNext = (index:number, next:string)=>{\n\t\treturn <div className=\"rulerow\">\n\t\t\t<div>then go to</div>\n\t\t\t<TextInput placeholder=\"next part\" style={{padding:2}} onChange={e => setNext(index,e.target.value)} value={next}></TextInput> \n\t\t</div>\n\t}\n\n\tconst operandtostring  = (value: string | string[]) : string=>{\n\t\tif (Array.isArray(value)){\n\t\t\treturn value.join(\",\")\n\t\t}\n\t\treturn value;\n\t}\n\n\tconst renderRule = (index:number, rule:Rule)=>{\n\t\t\n\t\treturn (<div key={index}>\n\t\t\t\t<div className=\"rulerow\">\t\n\t\t\t\t\t<div>when</div>\n\t\t\t\t\t<div style={{marginTop:2}}>\n\t\t\t\t\t\t<TextInput placeholder=\"name\" style={{padding:2,width:Math.max(20,rule.rule.operand.length * 9)}} onChange={e => setOperand(index, e.target.value)} value={operandtostring(rule.rule.operand)}></TextInput> \n\t\t\t\t\t</div>\n\t\t\t\t\t<div onClick={()=>{\n\t\t\t\t\t\taddAction(0,0,{\"action\":\"\"})\n\t\t\t\t\t}}>is pressed, call {rule.actions.length <= 0 ? \"nothing\" : \"\"} </div>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t{rule.actions.length > 0 && <Actions actions={rule.actions} \n\t\t\t\t\t\t deleteAction={(a,s)=>deleteAction(index, a,s)}\n\t\t\t\t\t\t addAction={(aindex:number, _action:Action)=>{addAction(index, aindex, _action)}}\n\t\t\t\t\t\t editAction={(aindex:number, subindex:number, action:Action)=>editAction(index,aindex,subindex,action)}\n\t\t\t\t\t\t addParallelAction={()=>addParallelAction(index)}/>}\n\t\t\t\t\n\t\t\t\t{renderNext(index,(rule.next||\"\").trim())}\n\t\t\t</div>)\n\t}\n\n\tconst renderRules = ()=>{\n\t\treturn rules.map((r,i)=>{\n\t\t\treturn renderRule(i,r);\n\t\t});\n\t}\n\n\treturn (<>\n\t\t\t<div id=\"rules\" style={{marginBottom:40}}>\t\t\n\t\t\t\t{renderRules()}\n\t\t\t\t<div style={{textAlign:\"center\"}}>\n\t\t\t\t\t<IconButton icon={<IconPlus />} iconOnly={false} label={\"add another rule\"} onClick={addNewRule} variant=\"primary\"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div style={{display:\"flex\", justifyContent:\"center\"}}>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={false}\n\t\t\t\t\t\ticon={<IconPlus />}\n\t\t\t\t\t\tlabel={t('Update')}\n\t\t\t\t\t\tonClick={()=>onAdd(rules)}\n\t\t\t\t\t\tvariant=\"create\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.cancel')}\n\t\t\t\t\t\tonClick={() => onCancel()}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</div>\n\t\t</>)\n};\n","import {  IconPlus,  IconX } from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport { ButtonBar } from '../container/button-bar';\nimport { IconButton } from '../control/icon-button';\nimport {TextInput} from '../control/text-input';\nimport { Action } from '../onstart/add-actions';\nimport { Actions } from './actions';\nimport {Rule} from './add-button-rules';\nimport './add-rules-button.css';\n\nexport interface AddRulesProps {\n\tonAdd: (rules:Rule[]) => void;\n\tonCancel:()=>void;\n\ttype:string;\n\trules?: Rule[];\n}\n\nexport const AddSpeechRules: React.FC<AddRulesProps> = props => {\n\tconst {onAdd, onCancel} = props;\n\tconst {t} = useTranslation();\n\n\tconst [rules, setRules] = React.useState<Rule[]>(props.rules || [{rule:{operator:\"equals\", operand:\"\"},actions:[],next:\"\"}]);\n\n\tconst addNewRule = ()=>{\n\t\tsetRules([...rules,{rule:{operator:\"contains\", operand:\"\"},actions:[],next:\"\"}]);\n\t}\n\n\tconst removeAction = (actions:Action[][], index:number, subindex:number) : Action[][]=>{\n\t\t\n\t\tif (actions.length <= index){\n\t\t\treturn actions;\n\t\t}\n\n\t\treturn (actions || []).reduce((acc:Action[][],actionarr:Action[],j)=>{\n\t\t\tif (j !== index)\n\t\t\t\treturn [...acc, actionarr]\n\t\t\tconst newactions =  actionarr.filter((a,i)=>i !== subindex);\n\t\t\treturn newactions.length <= 0 ? acc : [...acc, newactions];\n\t\t},[])\n\t}\n\n\tconst updateAction = (actions:Action[][], index:number, subindex:number, action:Action) : Action[][]=>{\n\t\t\n\t\tif (actions.length <= index){\n\t\t\treturn [...actions, [action]];\n\t\t}\n\n\t\treturn (actions || []).reduce((acc:Action[][],actionarr:Action[],j)=>{\n\t\t\tif (j !== index)\n\t\t\t\treturn [...acc, actionarr]\n\n\t\t\treturn [...acc, actionarr.map((a,i)=>{\n\t\t\t\treturn i === subindex ? action : a;\n\t\t\t})]\n\n\t\t},[])\n\t}\n\n\tconst appendAction = (actions:Action[][], index:number, action:Action) : Action[][]=>{\n\t\t\n\t\tif (actions.length <= index){\n\t\t\treturn [...actions, [action]];\n\t\t}\n\n\t\treturn (actions || []).reduce((acc:Action[][],actionarr:Action[],j)=>{\n\t\t\tif (j !== index)\n\t\t\t\treturn [...acc, actionarr]\n\n\t\t\treturn [...acc, [...actionarr, action]]\n\t\t},[])\n\t}\n\n\tconst deleteAction = (rindex:number, aindex:number, subindex:number)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: removeAction(rule.actions, aindex, subindex)\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst editAction = (rindex:number, aindex:number, subindex:number, action:Action)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: updateAction(rule.actions, aindex, subindex, action)\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst addParallelAction = (rindex:number)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: [...rule.actions, [{\"action\":\"\"}]]\t\t\t\t\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst addAction = (rindex:number, aindex:number, action:Action)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: appendAction(rule.actions, aindex, action)\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst setOperand = (index:number, operand:string)=>{\n\t\tsetRules(rules.reduce((acc:Rule[], item:Rule, i:number)=>{\n\t\t\tif (i !== index)\n\t\t\t\treturn [...acc, item];\n\t\t\treturn [...acc, {...item, rule:{...item.rule,operand}}];\n\t\t},[]));\n\t}\n\n\tconst setNext = (index:number, next:string)=>{\n\t\tsetRules(rules.reduce((acc:Rule[], item:Rule, i:number)=>{\n\t\t\tif (i !== index)\n\t\t\t\treturn [...acc, item];\n\t\t\treturn [...acc, {...item, next}];\n\t\t},[]));\n\t}\n\n\tconst renderNext = (index:number, next:string)=>{\n\t\treturn <div className=\"rulerow\">\n\t\t\t<div>then go to</div>\n\t\t\t<TextInput placeholder=\"next part\" style={{padding:2}} onChange={e => setNext(index,e.target.value)} value={next}></TextInput> \n\t\t</div>\n    }\n\n\tconst operandtostring  = (value: string | string[]) : string=>{\n\t\tif (Array.isArray(value)){\n\t\t\treturn value.join(\",\")\n\t\t}\n\t\treturn value;\n\t}\n\n\n\tconst renderRule = (index:number, rule:Rule)=>{\n\t\t\n\t\treturn (<><div className=\"rulecol\">\t\n\t\t\t\t\t<div>If any of the following words are spoken</div>\n\t\t\t\t\t<div style={{marginTop:15, marginBottom:7}}>\n\t\t\t\t\t\t<TextInput placeholder=\"name\" style={{padding:2,width:300}} onChange={e => setOperand(index, e.target.value)} value={operandtostring(rule.rule.operand)}></TextInput> \n\t\t\t\t\t</div>\n\t\t\t\t\t<div style={{marginBottom:15, marginTop:7}}>call  <span className=\"link\" onClick={()=>{addAction(0,0,{\"action\":\"\"})}}>{rule.actions.length <= 0 ? \"nothing\" : \"\"}</span> </div>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t{rule.actions.length > 0 && <Actions actions={rule.actions} \n\t\t\t\t\t\t deleteAction={(a,s)=>deleteAction(index, a,s)}\n\t\t\t\t\t\t addAction={(aindex:number, _action:Action)=>{addAction(index, aindex, _action)}}\n\t\t\t\t\t\t editAction={(aindex:number, subindex:number, action:Action)=>editAction(index,aindex,subindex,action)}\n\t\t\t\t\t\t addParallelAction={()=>addParallelAction(index)}/>}\n\t\t\t\t\n\t\t\t\t{renderNext(index,rule.next||\"\")}\n\t\t\t</>)\n\t}\n\n\tconst renderRules = ()=>{\n\t\treturn rules.map((r,i)=>{\n\t\t\treturn renderRule(i,r);\n\t\t});\n\t}\n\n\treturn (<>\n\t\t\t<div id=\"speechrules\" style={{marginBottom:10}}>\t\t\n\t\t\t\t{renderRules()}\n\t\t\t\t<div style={{textAlign:\"center\"}}>\n\t\t\t\t\t<IconButton icon={<IconPlus />} iconOnly={false} label={\"add another rule\"} onClick={addNewRule} variant=\"primary\"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div style={{ display:\"flex\", justifyContent:\"center\"}}>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={false}\n\t\t\t\t\t\ticon={<IconPlus />}\n\t\t\t\t\t\tlabel={t('Update')}\n\t\t\t\t\t\tonClick={()=>onAdd(rules)}\n\t\t\t\t\t\tvariant=\"create\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.cancel')}\n\t\t\t\t\t\tonClick={() => onCancel()}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</div>\n\t\t</>)\n};\n","import {  IconPlus,  IconX } from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport { ButtonBar } from '../container/button-bar';\nimport { IconButton } from '../control/icon-button';\nimport {TextInput} from '../control/text-input';\nimport { Action } from '../onstart/add-actions';\nimport { Actions } from './actions';\n\nimport './add-rules-button.css';\n\nexport interface AddRulesProps {\n\tonAdd: (rules:Rule[]) => void;\n\tonCancel:()=>void;\n\ttype:string;\n\trules?: Rule[];\n}\n\nexport interface Rule {\n\ttype?: string,\n    rule:{\n\t\toperator: string\n    \toperand: string | string[]\n\t}\n    actions: Action[][]\n    next: string\n}\n\nexport const AddWebhookRules: React.FC<AddRulesProps> = props => {\n\tconst {onAdd, onCancel} = props;\n\tconst {t} = useTranslation();\n\n\tconst [rules, setRules] = React.useState<Rule[]>(props.rules || [{rule:{operator:\"equals\", operand:\"\"},actions:[],next:\"\"}]);\n\n\tconst addNewRule = ()=>{\n\t\tsetRules([...rules,{rule:{operator:\"equals\", operand:\"\"},actions:[],next:\"\"}]);\n\t}\n\n\tconst removeAction = (actions:Action[][], index:number, subindex:number) : Action[][]=>{\n\t\t\n\t\tif (actions.length <= index){\n\t\t\treturn actions;\n\t\t}\n\n\t\treturn (actions || []).reduce((acc:Action[][],actionarr:Action[],j)=>{\n\t\t\tif (j !== index)\n\t\t\t\treturn [...acc, actionarr]\n\t\t\tconst newactions =  actionarr.filter((a,i)=>i !== subindex);\n\t\t\treturn newactions.length <= 0 ? acc : [...acc, newactions];\n\t\t},[])\n\t}\n\n\tconst updateAction = (actions:Action[][], index:number, subindex:number, action:Action) : Action[][]=>{\n\t\t\n\t\tif (actions.length <= index){\n\t\t\treturn [...actions, [action]];\n\t\t}\n\n\t\treturn (actions || []).reduce((acc:Action[][],actionarr:Action[],j)=>{\n\t\t\tif (j !== index)\n\t\t\t\treturn [...acc, actionarr]\n\n\t\t\treturn [...acc, actionarr.map((a,i)=>{\n\t\t\t\treturn i === subindex ? action : a;\n\t\t\t})]\n\n\t\t},[])\n\t}\n\n\tconst appendAction = (actions:Action[][], index:number, action:Action) : Action[][]=>{\n\t\t\n\t\tif (actions.length <= index){\n\t\t\treturn [...actions, [action]];\n\t\t}\n\n\t\treturn (actions || []).reduce((acc:Action[][],actionarr:Action[],j)=>{\n\t\t\tif (j !== index)\n\t\t\t\treturn [...acc, actionarr]\n\n\t\t\treturn [...acc, [...actionarr, action]]\n\t\t},[])\n\t}\n\n\tconst deleteAction = (rindex:number, aindex:number, subindex:number)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: removeAction(rule.actions, aindex, subindex)\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst editAction = (rindex:number, aindex:number, subindex:number, action:Action)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: updateAction(rule.actions, aindex, subindex, action)\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst addParallelAction = (rindex:number)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: [...rule.actions, [{\"action\":\"\"}]]\t\t\t\t\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst addAction = (rindex:number, aindex:number, action:Action)=>{\n\t\tconst _rules = rules.reduce((acc:Rule[], rule:Rule, i:number)=>{\n\t\t\tif (i !== rindex)\n\t\t\t\treturn [...acc, rule];\n\t\t\treturn [\t\n\t\t\t\t...acc, \n\t\t\t\t{\n\t\t\t\t\t...rule, \n\t\t\t\t\tactions: appendAction(rule.actions, aindex, action)\n\t\t\t\t}\t\n\t\t\t]\n\t\t},[]);\n\t\tsetRules(_rules);\n\t}\n\n\tconst setOperand = (index:number, operand:string)=>{\n\t\tsetRules(rules.reduce((acc:Rule[], item:Rule, i:number)=>{\n\t\t\tif (i !== index)\n\t\t\t\treturn [...acc, item];\n\t\t\treturn [...acc, {...item, rule:{...item.rule,operand}}];\n\t\t},[]));\n\t}\n\n\tconst setNext = (index:number, next:string)=>{\n\t\tsetRules(rules.reduce((acc:Rule[], item:Rule, i:number)=>{\n\t\t\tif (i !== index)\n\t\t\t\treturn [...acc, item];\n\t\t\treturn [...acc, {...item, next: next.trim()}];\n\t\t},[]));\n\t}\n\n\tconst renderNext = (index:number, next:string)=>{\n\t\treturn <div className=\"rulerow\">\n\t\t\t<div>then go to</div>\n\t\t\t<TextInput placeholder=\"next part\" style={{padding:2}} onChange={e => setNext(index,e.target.value)} value={next}></TextInput> \n\t\t</div>\n\t}\n\n\tconst operandtostring  = (value: string | string[]) : string=>{\n\t\tif (Array.isArray(value)){\n\t\t\treturn value.join(\",\")\n\t\t}\n\t\treturn value;\n\t}\n\n\tconst renderRule = (index:number, rule:Rule)=>{\n\t\t\n\t\treturn (<div key={index}>\n\t\t\t\t<div className=\"rulerow\">\t\n\t\t\t\t\t<div>when</div>\n\t\t\t\t\t<div style={{marginTop:2}}>\n\t\t\t\t\t\t<TextInput placeholder=\"name\" style={{padding:2,width:Math.max(20,rule.rule.operand.length * 9)}} onChange={e => setOperand(index, e.target.value)} value={operandtostring(rule.rule.operand)}></TextInput> \n\t\t\t\t\t</div>\n\t\t\t\t\t<div onClick={()=>{\n\t\t\t\t\t\taddAction(0,0,{\"action\":\"\"})\n\t\t\t\t\t}}>is called, call {rule.actions.length <= 0 ? \"nothing\" : \"\"} </div>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t{rule.actions.length > 0 && <Actions actions={rule.actions} \n\t\t\t\t\t\t deleteAction={(a,s)=>deleteAction(index, a,s)}\n\t\t\t\t\t\t addAction={(aindex:number, _action:Action)=>{addAction(index, aindex, _action)}}\n\t\t\t\t\t\t editAction={(aindex:number, subindex:number, action:Action)=>editAction(index,aindex,subindex,action)}\n\t\t\t\t\t\t addParallelAction={()=>addParallelAction(index)}/>}\n\t\t\t\t\n\t\t\t\t{renderNext(index,(rule.next||\"\").trim())}\n\t\t\t</div>)\n\t}\n\n\tconst renderRules = ()=>{\n\t\treturn rules.map((r,i)=>{\n\t\t\treturn renderRule(i,r);\n\t\t});\n\t}\n\n\treturn (<>\n\t\t\t<div id=\"rules\" style={{marginBottom:40}}>\t\t\n\t\t\t\t{renderRules()}\n\t\t\t\t<div style={{textAlign:\"center\"}}>\n\t\t\t\t\t<IconButton icon={<IconPlus />} iconOnly={false} label={\"add another rule\"} onClick={addNewRule} variant=\"primary\"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div style={{display:\"flex\", justifyContent:\"center\"}}>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={false}\n\t\t\t\t\t\ticon={<IconPlus />}\n\t\t\t\t\t\tlabel={t('Update')}\n\t\t\t\t\t\tonClick={()=>onAdd(rules)}\n\t\t\t\t\t\tvariant=\"create\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.cancel')}\n\t\t\t\t\t\tonClick={() => onCancel()}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</div>\n\t\t</>)\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPlus} from '@tabler/icons';\nimport {CardContent} from '../container/card';\nimport {CardButton} from '../control/card-button';\nimport { AddButtonRules } from './add-button-rules';\nimport { AddSpeechRules } from './add-speech-rules';\nimport { AddWebhookRules } from './add-webhook-rules';\nimport './add-rules-button.css';\nimport {Rule} from './add-button-rules';\nimport { TextSelect } from '../control/text-select';\n\nexport interface AddRuleButton {\n\ticon?: React.ReactNode;\n\tlabel?: string;\n\ttype: string;\n\tonAdd: (rules:Rule[]) => void;\n\tonSelect: (event:string) => void;\n    rules: Rule[];\n}\n\nexport const AddRulesButton: React.FC<AddRuleButton> = props => {\n\tconst {icon, label, type, onAdd} = props;\n\tconst [creatingStart, setCreatingStart] = React.useState(true);\n\tconst [open, setOpen] = React.useState(false);\n\n\tconst {t} = useTranslation();\n\n\tlet validationMessage: string | undefined = undefined;\n\n\tconst typeChange = (e: React.ChangeEvent<HTMLSelectElement>)=>{\n\t\tconsole.log(\"seen a type change!!\", e.target.value);\n\t\tprops.onSelect(e.target.value);\n\t}\n\treturn (\n\t\t<span className=\"add-tag-button\">\n\t\t\t<CardButton\n\t\t\t\tdisabled={false}\n\t\t\t\ticon={icon ?? <IconPlus />}\n\t\t\t\tlabel={label ?? t('common.rules')}\n\t\t\t\tonChangeOpen={()=>{\n\t\t\t\t\tsetOpen(true)\n\t\t\t\t}}\n\t\t\t\topen={open}\n\t\t\t>\n\t\t\t\t<CardContent style={{width:460, overflowY:\"auto\"}}>\n\t\t\t\t\t<div className=\"container\">\n\t\t\t\t\t\t<div className=\"help\">Rules determine what needs to happen to move from this node to another node.  So far we support buttons being pressed (by the experience controller) or keywords being said by the particpants (experimental)</div>\n\t\t\t\t\t\t\n\t\t\t\t\t\t<div style={{padding:15, background:\"#cfe4fc\", borderRadius:5, marginTop:15}}>\n\t\t\t\t\t\t\t<div style={{marginBottom:15, paddingBottom:15, borderBottom:\"1px solid black\"}}>\n\t\t\t\t\t\t\t\t<TextSelect onChange={typeChange} options={[{label:\"button\", value:\"button\"}, {label:\"webhook\", value:\"webhook\"}, {label:\"speech\", value:\"speech\"}]} value={type}>rule type</TextSelect>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t{type === \"button\" && <AddButtonRules onCancel={()=>{setOpen(false)}} type={type} rules={props.rules}  onAdd={(rules:Rule[])=>{\n\t\t\t\t\t\t\t\tconsole.log(\"add buttn rules, add rukes\", rules);\n\t\t\t\t\t\t\t\tsetOpen(false);\n\t\t\t\t\t\t\t\tonAdd(rules);\n\t\t\t\t\t\t\t}}/>}\n\t\t\t\t\t\t\n\t\t\t\t\t\t\t{type === \"webhook\" && <AddWebhookRules onCancel={()=>{setOpen(false)}} type={type} rules={props.rules}  onAdd={(rules:Rule[])=>{\n\t\t\t\t\t\t\t\tconsole.log(\"add webhook rules, add rukes\", rules);\n\t\t\t\t\t\t\t\tsetOpen(false);\n\t\t\t\t\t\t\t\tonAdd(rules);\n\t\t\t\t\t\t\t}}/>}\n\t\t\t\t\t\t\n\t\t\t\t\t\t\t{type === \"speech\" && <AddSpeechRules onCancel={()=>{setOpen(false)}} type={type} rules={props.rules}  onAdd={(rules:Rule[])=>{\n\t\t\t\t\t\t\t\tconsole.log(\"add speech rules, add rukes\", rules);\n\t\t\t\t\t\t\t\tsetOpen(false);\n\t\t\t\t\t\t\t\tonAdd(rules);\n\t\t\t\t\t\t\t}}/>}\n\n\t\t\t\t\t\t\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t{creatingStart && !!validationMessage && <p>{validationMessage}</p>}\n\t\t\t\t\t</div>\n\t\t\t\t</CardContent>\n\t\t\t\t\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport CodeMirror from 'codemirror';\nimport {usePrefsContext} from '../../store/prefs';\nimport {StoryFormat, StoryFormatToolbarItem} from '../../store/story-formats';\nimport {useComputedTheme} from '../../store/prefs/use-computed-theme';\nimport {useFormatCodeMirrorToolbar} from '../../store/use-format-codemirror-toolbar';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {IconButton} from '../../components/control/icon-button';\nimport {MenuButton} from '../../components/control/menu-button';\nimport './story-format-toolbar.css';\n\nexport interface StoryFormatToolbarProps {\n\teditor?: CodeMirror.Editor;\n\tstoryFormat: StoryFormat;\n}\n\nexport const StoryFormatToolbar: React.FC<StoryFormatToolbarProps> = props => {\n\tconst {editor, storyFormat} = props;\n\tconst appTheme = useComputedTheme();\n\tconst {prefs} = usePrefsContext();\n\tconst toolbarFactory = useFormatCodeMirrorToolbar(\n\t\tstoryFormat.name,\n\t\tstoryFormat.version\n\t);\n\tconst [toolbarItems, setToolbarItems] = React.useState<\n\t\tStoryFormatToolbarItem[]\n\t>([]);\n\n\tReact.useEffect(() => {\n\t\tif (toolbarFactory && editor) {\n\t\t\ttry {\n\t\t\t\tsetToolbarItems(\n\t\t\t\t\ttoolbarFactory(editor, {\n\t\t\t\t\t\tappTheme,\n\t\t\t\t\t\tlocale: prefs.locale\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t`Toolbar function for ${storyFormat.name} ${storyFormat.version} threw an error, skipping update`,\n\t\t\t\t\terror\n\t\t\t\t);\n\t\t\t}\n\t\t} else {\n\t\t\tsetToolbarItems([]);\n\t\t}\n\t}, [\n\t\tappTheme,\n\t\teditor,\n\t\tprefs.locale,\n\t\tstoryFormat.name,\n\t\tstoryFormat.version,\n\t\ttoolbarFactory\n\t]);\n\n\treturn (\n\t\t<div className=\"story-format-toolbar\">\n\t\t\t<ButtonBar>\n\t\t\t\t{toolbarItems.map((item, index) => {\n\t\t\t\t\tswitch (item.type) {\n\t\t\t\t\t\tcase 'button':\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\ticon={<img src={item.icon} alt=\"\" />}\n\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\tonClick={() => editor?.execCommand(item.command)}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\tcase 'menu': {\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t<MenuButton\n\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\ticon={<img src={item.icon} alt=\"\" />}\n\t\t\t\t\t\t\t\t\titems={item.items\n\t\t\t\t\t\t\t\t\t\t.filter(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t['button', 'separator'].includes(subitem.type)\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t.map(subitem => {\n\t\t\t\t\t\t\t\t\t\t\tif (subitem.type === 'button') {\n\t\t\t\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: 'button',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisabled: subitem.disabled,\n\t\t\t\t\t\t\t\t\t\t\t\t\tlabel: subitem.label,\n\t\t\t\t\t\t\t\t\t\t\t\t\tonClick: () => editor?.execCommand(subitem.command)\n\t\t\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\treturn {separator: true};\n\t\t\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn null;\n\t\t\t\t})}\n\t\t\t</ButtonBar>\n\t\t</div>\n\t);\n};\n","import CodeMirror from 'codemirror';\nimport * as React from 'react';\nimport {version as twineVersion} from '../../package.json';\nimport {formatEditorExtensions, namespaceForFormat} from '../util/story-format';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tStoryFormatToolbarFactory,\n\tStoryFormatToolbarFactoryEnvironment,\n\tStoryFormatToolbarItem,\n\tuseStoryFormatsContext\n} from './story-formats';\n\n/**\n * Manages working with a CodeMirror toolbar for a story format, which consists\n * of:\n *\n * - (optionally, but usually) a set of CodeMirror commands\n * - A function that returns an array of objects describing the toolbar, which\n *   uses those commands for functionality\n *\n * This loads the story format if it hasn't already been loaded, and installs\n * CodeMirror commands it provides. It returns the toolbar factory function if\n * everything succeeds. Otherwise, it will return undefined.\n */\nexport function useFormatCodeMirrorToolbar(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst [loaded, setLoaded] = React.useState<Record<string, boolean>>({});\n\tconst [\n\t\ttoolbarFunc,\n\t\tsetToolbarFunc\n\t] = React.useState<StoryFormatToolbarFactory>();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst {prefs} = usePrefsContext();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (\n\t\t\tformat.loadState === 'loaded' &&\n\t\t\t!loaded[namespaceForFormat(format)]\n\t\t) {\n\t\t\tconst namespace = namespaceForFormat(format);\n\t\t\tconst editorExtensions = formatEditorExtensions(format, twineVersion);\n\n\t\t\tif (editorExtensions?.codeMirror?.commands) {\n\t\t\t\tfor (const commandName in editorExtensions.codeMirror.commands) {\n\t\t\t\t\tconst namespacedCommand = namespace + commandName;\n\n\t\t\t\t\tif (namespacedCommand in CodeMirror.commands) {\n\t\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t\t`CodeMirror already has a \"${namespacedCommand}\" command defined, skipping`\n\t\t\t\t\t\t);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Using any here because the type is defined with factory\n\t\t\t\t\t\t// commands only.\n\n\t\t\t\t\t\t(CodeMirror.commands as any)[\n\t\t\t\t\t\t\tnamespacedCommand\n\t\t\t\t\t\t] = editorExtensions.codeMirror!.commands![commandName];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (editorExtensions?.codeMirror?.toolbar) {\n\t\t\t\tsetToolbarFunc(\n\t\t\t\t\t() => (\n\t\t\t\t\t\teditor: CodeMirror.Editor,\n\t\t\t\t\t\tenvironment: StoryFormatToolbarFactoryEnvironment\n\t\t\t\t\t) => {\n\t\t\t\t\t\t// If somehow we lost our format's toolbar function, exit early.\n\n\t\t\t\t\t\tif (!editorExtensions?.codeMirror?.toolbar) {\n\t\t\t\t\t\t\treturn [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst items = editorExtensions.codeMirror.toolbar(\n\t\t\t\t\t\t\teditor,\n\t\t\t\t\t\t\tenvironment\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\t// If we didn't get an array from the function, coerce it to an\n\t\t\t\t\t\t// empty one.\n\n\t\t\t\t\t\tif (!Array.isArray(items)) {\n\t\t\t\t\t\t\treturn [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Namespace command properties and filter out any types that aren't\n\t\t\t\t\t\t// buttons or menus.\n\n\t\t\t\t\t\treturn items.reduce((result, item) => {\n\t\t\t\t\t\t\tswitch (item.type) {\n\t\t\t\t\t\t\t\tcase 'button':\n\t\t\t\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t\t\t\t{...item, command: namespace + item.command}\n\t\t\t\t\t\t\t\t\t];\n\n\t\t\t\t\t\t\t\tcase 'menu':\n\t\t\t\t\t\t\t\t\tif (Array.isArray(item.items)) {\n\t\t\t\t\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t...item,\n\t\t\t\t\t\t\t\t\t\t\t\titems: item.items\n\t\t\t\t\t\t\t\t\t\t\t\t\t.filter(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t['button', 'separator'].includes(subitem.type)\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.map(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsubitem.type === 'separator'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? subitem\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t...subitem,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcommand: namespace + subitem.command\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t}, [] as StoryFormatToolbarItem[]);\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tsetLoaded(loaded => ({...loaded, [namespaceForFormat(format)]: true}));\n\t\t}\n\t}, [dispatch, extensionsDisabled, format, loaded]);\n\n\treturn toolbarFunc;\n}\n","import {debounce} from 'lodash';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogEditor} from '../../components/container/dialog-card';\nimport {CodeArea} from '../../components/control/code-area';\nimport {usePrefsContext} from '../../store/prefs';\nimport {Passage} from '../../store/stories';\nimport {StoryFormat} from '../../store/story-formats';\nimport {useFormatCodeMirrorMode} from '../../store/use-format-codemirror-mode';\nimport {codeMirrorOptionsFromPrefs} from '../../util/codemirror-options';\nimport {StoryFormatToolbar} from './story-format-toolbar';\n\nexport interface PassageTextProps {\n\tonChange: (value: string) => void;\n\tonEditorChange: (value: CodeMirror.Editor) => void;\n\tpassage: Passage;\n\tstoryFormat: StoryFormat;\n}\n\nexport const PassageText: React.FC<PassageTextProps> = props => {\n\tconst {onChange, onEditorChange, passage, storyFormat} = props;\n\tconst [changePending, setChangePending] = React.useState(false);\n\tconst [localText, setLocalText] = React.useState(passage.text);\n\tconst [editor, setEditor] = React.useState<CodeMirror.Editor>();\n\tconst {prefs} = usePrefsContext();\n\tconst mode =\n\t\tuseFormatCodeMirrorMode(storyFormat.name, storyFormat.version) ?? 'text';\n\tconst {t} = useTranslation();\n\n\t// Effects to handle debouncing updates upward. The idea here is that the\n\t// component maintains a local state so that the CodeMirror instance always is\n\t// up-to-date with what the user has typed, but the global context may not be.\n\t// This is because updating global context causes re-rendering in the story\n\t// map, which can be time-intensive.\n\n\tReact.useEffect(() => {\n\t\t// A change to passage text has occurred externally, e.g. through a find and\n\t\t// replace. We ignore this if a change is pending so that users don't see\n\t\t// things they've typed in disappear or be replaced.\n\n\t\tif (!changePending && localText !== passage.text) {\n\t\t\tsetLocalText(passage.text);\n\t\t}\n\t}, [changePending, localText, passage.text]);\n\n\t// The code below handles user changes in the text field. 1 second is a\n\t// guesstimate.\n\n\tconst debouncedOnChange = React.useMemo(\n\t\t() =>\n\t\t\tdebounce((value: string) => {\n\t\t\t\tonChange(value);\n\t\t\t\tsetChangePending(false);\n\t\t\t}, 1000),\n\t\t[onChange]\n\t);\n\n\tfunction handleMount(editor: CodeMirror.Editor) {\n\t\tsetEditor(editor);\n\t\tonEditorChange(editor);\n\n\t\t// The potential combination of loading a mode and the dialog entrance\n\t\t// animation seems to mess up CodeMirror's cursor rendering. The delay below\n\t\t// is intended to run after the animation completes.\n\n\t\twindow.setTimeout(() => {\n\t\t\teditor.focus();\n\t\t\teditor.refresh();\n\t\t}, 400);\n\t}\n\n\tfunction handleChange(\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) {\n\t\tonEditorChange(editor);\n\t\tsetChangePending(true);\n\t\tdebouncedOnChange(text);\n\t\tsetLocalText(text);\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<StoryFormatToolbar editor={editor} storyFormat={storyFormat} />\n\t\t\t<DialogEditor>\n\t\t\t\t<CodeArea\n\t\t\t\t\teditorDidMount={handleMount}\n\t\t\t\t\tfontFamily={prefs.passageEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.passageEditorFontScale}\n\t\t\t\t\tlabel={t('dialogs.passageEdit.passageTextEditorLabel')}\n\t\t\t\t\tlabelHidden\n\t\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\t\tonChange={onEditorChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\t\t\t\tmode,\n\t\t\t\t\t\tlineWrapping: true\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={localText}\n\t\t\t\t/>\n\t\t\t</DialogEditor>\n\t\t</>\n\t);\n};\n","import {version as twineVersion} from '../../package.json';\nimport CodeMirror from 'codemirror';\nimport * as React from 'react';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {formatEditorExtensions, namespaceForFormat} from '../util/story-format';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\n\n/**\n * Sets up a CodeMirror mode for a format, if the format has defined one via\n * properties.codeMirror.mode. Once one is fully set up, this returns the name\n * of that mode. If the mode is being set up or the format hasn't defined one,\n * this returns undefined.\n */\nexport function useFormatCodeMirrorMode(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst {prefs} = usePrefsContext();\n\tconst [modeName, setModeName] = React.useState<string>();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (format.loadState === 'loaded') {\n\t\t\tconst editorExtensions = formatEditorExtensions(format, twineVersion);\n\n\t\t\tif (editorExtensions?.codeMirror?.mode) {\n\t\t\t\tCodeMirror.defineMode(\n\t\t\t\t\tnamespaceForFormat(format),\n\t\t\t\t\teditorExtensions.codeMirror.mode\n\t\t\t\t);\n\t\t\t\tsetModeName(namespaceForFormat(format));\n\t\t\t}\n\t\t}\n\t}, [dispatch, extensionsDisabled, format]);\n\n\treturn modeName;\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPlus, IconX} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton} from '../control/card-button';\nimport {IconButton} from '../control/icon-button';\nimport {TextSelect} from '../control/text-select';\nimport { AddSpeech } from './add-speech';\nimport './add-onstart-button.css';\nimport { Speech } from './add-speech';\nimport {Action} from './add-actions';\nimport { Actions } from '../rules/actions';\n\nexport interface AddOnStartButtonProps {\n\ticon?: React.ReactNode;\n\tlabel?: string;\n\tonAdd: (lines:Speech[], actions:Action[][]) => void;\n    onClose : ()=>void\n    lines: Speech[]\n    actions: Action[][]\n}\n\nexport const AddOnStartButton: React.FC<AddOnStartButtonProps> = props => {\n\n\tconst {icon, label, onAdd,onClose} = props;\n\tconst [creatingStart, setCreatingStart] = React.useState(true);\n    const [startType, setStartType] = React.useState('speech');\n    const [lines, setLines] = React.useState<Array<Speech>>(props.lines);\n    const [actions, setActions] = React.useState<Action[][]>(props.actions);\n\n\tconst [open, setOpen] = React.useState(false);\n\tconst {t} = useTranslation();\n\n\tlet validationMessage: string | undefined = undefined;\n\tlet canAdd = lines.length > 0;\n\n\tfunction handleAdd() {\n\t\tonAdd(lines,actions);\n\t\tsetOpen(false);\n\t}\n\n\tfunction handleTypeChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tconst startType = event.target.value;\n\t\tsetStartType(startType);\n        setCreatingStart(true);\n\t}\n\n    const deleteAction = (aindex:number,subindex:number)=>{\n        const _actions:Action[][] =  actions.reduce((acc:Action[][], arr:Action[], index:number)=>{\n            if (aindex===index){\n                if (subindex === 0 && arr.length === 1){\n                    return acc;\n                }\n                return [...acc, arr.reduce((acc:Action[], item:Action, si:number)=>{\n                    if (si === subindex)\n                        return acc;\n                    return [...acc, item];\n                },[])]\n            }\n            return [...acc, arr];\n        },[]);\n        setActions(_actions);\n    }\n\n   \n    const addAction = (aindex:number, action:Action)=>{\n        if (actions.length === 0){\n            setActions([[action]])\n        }\n        else{\n            const _actions:Action[][] =  actions.map((arr, index)=>{\n                return index===aindex ? [...arr, action] : arr;\n            });\n            setActions(_actions);\n        }\n    }\n    \n\n    const editAction = (aindex:number,subindex:number, action:Action)=>{\n        const _actions:Action[][] =  actions.reduce((acc:Action[][], arr:Action[], index:number)=>{\n            if (aindex===index){\n                return [...acc, arr.reduce((acc:Action[], item:Action, si:number)=>{\n                    if (si === subindex)\n                        return [...acc,action]\n                    return [...acc, item];\n                },[])]\n            }\n            return [...acc, arr];\n        },[]);\n        setActions(_actions);\n    }\n\n\n    const addParallelAction = ()=>{\n\t\tsetActions([...actions,[{\"action\":\"\"}]]);\n\t}\n\n\treturn (\n\t\t<span className=\"add-tag-button\">\n\t\t\t<CardButton\n\t\t\t\tdisabled={false}\n\t\t\t\ticon={icon ?? <IconPlus />}\n\t\t\t\tlabel={label ?? t('common.onstart')}\n\t\t\t\tonChangeOpen={(e)=>{setOpen(true)}}\n\t\t\t\topen={open}\n\t\t\t>\n            \n\t\t\t\t<CardContent style={{width:440, padding:15}}>\n                    <div className=\"help\">Make something happen immediately when this node is triggered. You could either have a voice in the caravan say something (choose type: speech), and/or you could control the caravan' sensors (choose type:action)</div>\n                    <div style={{padding:15, background:\"#cfe4fc\", borderRadius:5, marginTop:15}}>\n                        <TextSelect\n                            onChange={handleTypeChange}\n                            options={[\n                                {disabled:false, label:\"action\", value:\"action\"},\n                                {disabled:false, label:\"speech\", value:\"speech\"}\n                            ]}\n                            value={startType}\n                        >\n                            {t('components.onStartButton.selectType')}\n                        </TextSelect>\n                        {startType === \"action\" && (\n                          \n                            <Actions actions={actions} \n                            deleteAction={(a,s)=>deleteAction(a,s)}\n                            addAction={(aindex:number, _action:Action)=>{addAction(aindex, _action)}}\n                            editAction={(aindex:number, subindex:number, action:Action)=>editAction(aindex,subindex,action)}\n                            addParallelAction={()=>addParallelAction()}/>\n                            \n                        )}\n                        {startType === \"speech\" && (\n                            <AddSpeech lines={lines} onAdd={(lines)=>{setLines(lines)}}/>\n                        )}\n                        </div>\n                        {creatingStart && !!validationMessage && <p>{validationMessage}</p>}\n                    \n\t\t\t\t</CardContent>\n                <div style={{ display:\"flex\", justifyContent:\"center\"}}>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={false}\n\t\t\t\t\t\ticon={<IconPlus />}\n\t\t\t\t\t\tlabel={t('common.add')}\n\t\t\t\t\t\tonClick={handleAdd}\n\t\t\t\t\t\tvariant=\"create\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.cancel')}\n\t\t\t\t\t\tonClick={() => {\n                            setOpen(false);\n                            onClose();\n                        }}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n                </div>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {composeInitialProps, useTranslation} from 'react-i18next';\nimport {IconResize} from '@tabler/icons';\nimport {UndoRedoButtons} from '../../components/codemirror/undo-redo-buttons';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {\n\tDialogCard,\n\tDialogCardProps\n} from '../../components/container/dialog-card';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {MenuButton} from '../../components/control/menu-button';\nimport {AddTagButton, TagButton} from '../../components/tag';\nimport { AddRulesButton } from '../../components/rules/add-rules-button';\nimport { ChooseTypeButton } from '../../components/choosetype/choose-type-button';\nimport {\n\tformatWithNameAndVersion,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {\n\taddPassageTag,\n\tpassageWithId,\n\tremovePassageTag,\n\tsetTagColor,\n\tstoryPassageTags,\n\tstoryWithId,\n\tupdatePassage,\n\tupdateStory\n} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\nimport {PassageText} from './passage-text';\nimport {RenamePassageButton} from '../../components/passage/rename-passage-button';\nimport './passage-edit.css';\nimport { AddOnStartButton } from '../../components/onstart';\nimport { AddSpeech, Speech } from '../../components/onstart/add-speech';\nimport { Rule } from '../../components/rules/add-button-rules';\n\nimport {convertToObject, convertToString} from '../../util/caravan';\nimport { Action } from '../../components/onstart/add-actions';\nimport { TextSelect } from '../../components/control/text-select';\n\n\nexport interface PassageEditDialogProps\n\textends Omit<DialogCardProps, 'headerLabel'> {\n\tpassageId: string;\n\tstoryId: string;\n}\n\n\nexport const InnerPassageEditDialog: React.FC<PassageEditDialogProps> = props => {\n\tconst {passageId, storyId, ...other} = props;\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {formats} = useStoryFormatsContext();\n\tconst passage = passageWithId(stories, storyId, passageId);\n\tconst story = storyWithId(stories, storyId);\n\tconst storyFormat = formatWithNameAndVersion(\n\t\tformats,\n\t\tstory.storyFormat,\n\t\tstory.storyFormatVersion\n\t);\n\tconst {t} = useTranslation();\n\n\tconst handlePassageTextChange = React.useCallback(\n\t\t(text: string) => {\n\t\t\tdispatch(updatePassage(story, passage, {text}));\n\t\t},\n\t\t[dispatch, passage, story]\n\t);\n\n\tconst handleAddStart = React.useCallback((speech : Speech[], actions:Action[][])=>{\n\t\t//get the current text and turn into a node object\n\t\tconst passageobj = convertToObject(passage.text);\n\n\t\t//set the new text using a passage object modified with speech lines\n\t\tconst passagetext = convertToString({...passageobj, onstart:{...passageobj.onstart, speech, actions}});\n\t\t\n\t\t//update the passage object\n\t\tdispatch(updatePassage(story, passage, {text: passagetext}));\n\n\t},[dispatch, passage, story]);\n\t// TODO: make tag changes undoable\n\n\tfunction handleAddTag(name: string, color?: Color) {\n\t\tdispatch(addPassageTag(story, passage, name));\n\n\t\tif (color) {\n\t\t\tdispatch(setTagColor(story, name, color));\n\t\t}\n\t}\n\n\tfunction handleChangeTagColor(name: string, color: Color) {\n\t\tdispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttagColors: {...story.tagColors, [name]: color}\n\t\t\t})\n\t\t);\n\t}\n\n\tfunction handleRemoveTag(name: string) {\n\t\tdispatch(removePassageTag(story, passage, name), t('undoChange.removeTag'));\n\t}\n\n\tfunction handleRename(name: string) {\n\t\t// Don't create newly linked passages here because the update action will\n\t\t// try to recreate the passage as it's been renamed--it sees new links in\n\t\t// existing passages, updates them, but does not see that the passage name\n\t\t// has been updated since that hasn't happened yet.\n\n\t\tdispatch(\n\t\t\tupdatePassage(\n\t\t\t\tstory,\n\t\t\t\tpassage,\n\t\t\t\t{name},\n\t\t\t\t{dontCreateNewlyLinkedPassages: true}\n\t\t\t)\n\t\t);\n\t}\n\n\tfunction handleSetAsStart() {\n\t\tdispatch(updateStory(stories, story, {startPassage: passageId}));\n\t}\n\n\tfunction handleSetSize({height, width}: {height: number; width: number}) {\n\t\tdispatch(updatePassage(story, passage, {height, width}));\n\t}\n\n\tconst isStart = story.startPassage === passage.id;\n\tconst node = convertToObject(passage.text);\n\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"passage-edit-dialog\"\n\t\t\theaderLabel={passage.name}\n\t\t>\n\t\t\t<ButtonBar>\n\t\t\t\t<UndoRedoButtons editor={cmEditor} watch={passage.text} />\n\t\t\t\t{/*<AddTagButton\n\t\t\t\t\tassignedTags={passage.tags}\n\t\t\t\t\texistingTags={storyPassageTags(story)}\n\t\t\t\t\tonAdd={handleAddTag}\n\t\t\t\t/>*/}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t{/*<ChooseTypeButton type={node.type} onSelect={(e)=>{\n\t\t\t\t\tconst _node = {\n\t\t\t\t\t\t...node,\n\t\t\t\t\t\ttype:e,\n\t\t\t\t\t}\n\t\t\t\t\tconst passagetext = convertToString(_node);\n\t\t\t\t\tdispatch(updatePassage(story, passage, {text: passagetext}));\n\t\t\t\t}}/>*/}\n\t\t\t\t<AddOnStartButton\n\t\t\t\t\tlines={(convertToObject(passage.text||\"\").onstart || {}).speech || []}\n\t\t\t\t\tactions={(convertToObject(passage.text||\"\").onstart || {}).actions || []}\n\t\t\t\t\tonAdd={handleAddStart}\n\t\t\t\t\tonClose={()=>{console.log(\"closed!\")}}\n\t\t\t\t\tlabel={\"on start\"}\n\t\t\t\t/>\n\t\t\t\t<AddRulesButton\n\t\t\t\t\trules={convertToObject(passage.text).rules}\n\t\t\t\t\ttype={node.type}\n\t\t\t\t\tlabel=\"rules\"\n\t\t\t\t\tonAdd={(rules:Rule[])=>{\n\t\t\t\t\t\tconst passageobj = {...convertToObject(passage.text)}\n\n\t\t\t\t\t\t\n\n\t\t\t\t\t\tconst _updated = {\n\t\t\t\t\t\t\t...passageobj,\n\t\t\t\t\t\t\trules /*: [...passageobj.rules, ...rules]*/\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tconst passagetext = convertToString(_updated);\n\t\t\t\t\t\tdispatch(updatePassage(story, passage, {text: passagetext}));\n\n\t\t\t\t\t}}\n\t\t\t\t\tonSelect={(type)=>{\n\t\t\t\t\t\t\n\t\t\t\t\t\tconst _node = {\n\t\t\t\t\t\t\t...node,\n\t\t\t\t\t\t\ttype\n\t\t\t\t\t\t}\n\t\t\t\t\t\t//THIS IS THE BIT THAT ADDS /t/n!!\n\t\t\t\t\t\tconst passagetext = convertToString(_node);\n\t\t\t\t\t\t\n\t\t\t\t\t\tconsole.log(passagetext);\n\n\t\t\t\t\t\tdispatch(updatePassage(story, passage, {text: passagetext}));\n\t\t\t\t\t}}\n\t\t\t\t/>\t\t\n\t\t\t\t\n\t\t\t\t{/*<MenuButton\n\t\t\t\t\ticon={<IconResize />}\n\t\t\t\t\titems={[\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\t\tchecked: passage.height === 100 && passage.width === 100,\n\t\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeSmall'),\n\t\t\t\t\t\t\tonClick: () => handleSetSize({height: 100, width: 100})\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\t\tchecked: passage.height === 200 && passage.width === 200,\n\t\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeLarge'),\n\t\t\t\t\t\t\tonClick: () => handleSetSize({height: 200, width: 200})\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\t\tchecked: passage.height === 200 && passage.width === 100,\n\t\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeTall'),\n\t\t\t\t\t\t\tonClick: () => handleSetSize({height: 200, width: 100})\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\t\tchecked: passage.height === 100 && passage.width === 200,\n\t\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeWide'),\n\t\t\t\t\t\t\tonClick: () => handleSetSize({height: 100, width: 200})\n\t\t\t\t\t\t}\n\t\t\t\t\t]}\n\t\t\t\t\tlabel={t('dialogs.passageEdit.size')}\n\t\t\t\t/>*/}\n\t\t\t\t<RenamePassageButton\n\t\t\t\t\tonRename={handleRename}\n\t\t\t\t\tpassage={passage}\n\t\t\t\t\tstory={story}\n\t\t\t\t/>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tdisabled={isStart}\n\t\t\t\t\tlabel={t('dialogs.passageEdit.setAsStart')}\n\t\t\t\t\tonChange={handleSetAsStart}\n\t\t\t\t\tvalue={isStart}\n\t\t\t\t/>\n\t\t\t</ButtonBar>\n\t\t\t{passage.tags.length > 0 && (\n\t\t\t\t<div className=\"tags\">\n\t\t\t\t\t<ButtonBar>\n\t\t\t\t\t\t{passage.tags.map(tag => (\n\t\t\t\t\t\t\t<TagButton\n\t\t\t\t\t\t\t\tcolor={story.tagColors[tag]}\n\t\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\t\tonChangeColor={color => handleChangeTagColor(tag, color)}\n\t\t\t\t\t\t\t\tonRemove={() => handleRemoveTag(tag)}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</ButtonBar>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t\t<PassageText\n\t\t\t\tonChange={handlePassageTextChange}\n\t\t\t\tonEditorChange={setCmEditor}\n\t\t\t\tpassage={passage}\n\t\t\t\tstoryFormat={storyFormat}\n\t\t\t/>\n\t\t</DialogCard>\n\t);\n};\n\nexport const PassageEditDialog: React.FC<PassageEditDialogProps> = props => {\n\t// Check for the existence of the passage. If it doesn't (e.g. it was deleted\n\t// after the dialog was opened), render nothing and call onClose.\n\n\tconst {stories} = useUndoableStoriesContext();\n\n\ttry {\n\t\tpassageWithId(stories, props.storyId, props.passageId);\n\t} catch (err) {\n\t\tconsole.log(\"ERROR\", err);\n\t\tprops.onClose();\n\t\treturn null;\n\t}\n\n\treturn <InnerPassageEditDialog {...props} />;\n};","import classNames from 'classnames';\nimport * as React from 'react';\nimport './file-input.css';\n\n// See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file\n\nexport interface FileInputProps {\n\taccept?: string;\n\tchildren: React.ReactNode;\n\tonChange: (file: File, data: string) => void;\n\tonError?: (error: Error) => void;\n\torientation?: 'horizontal' | 'vertical';\n}\n\nexport const FileInput: React.FC<FileInputProps> = props => {\n\tconst {children, onChange, onError, orientation, ...otherProps} = props;\n\tconst className = classNames(\n\t\t'file-input',\n\t\t`orientation-${orientation ?? 'horizontal'}`\n\t);\n\n\tfunction handleChange(changeEvent: React.ChangeEvent<HTMLInputElement>) {\n\t\tif (!changeEvent.target.files) {\n\t\t\tthrow new Error('Change event occurred but no files present');\n\t\t}\n\n\t\tconst file = changeEvent.target.files[0];\n\t\tconst reader = new FileReader();\n\n\t\treader.addEventListener('loadend', loadEvent => {\n\t\t\tif (reader.error) {\n\t\t\t\tconsole.warn(reader.error);\n\n\t\t\t\tif (onError) {\n\t\t\t\t\tonError(reader.error);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tonChange(file, reader.result as string);\n\t\t\t}\n\t\t});\n\n\t\treader.readAsText(file);\n\t}\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"file-input-label\">{children}</span>\n\t\t\t\t<span className=\"file-input-control\">\n\t\t\t\t\t<input {...otherProps} onChange={handleChange} type=\"file\" />\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {FileInput} from '../../components/control/file-input';\nimport {Story} from '../../store/stories';\nimport {importStories} from '../../util/import';\n\nexport interface FileChooserProps {\n\tonChange: (file: File, stories: Story[]) => void;\n}\n\nexport const FileChooser: React.FC<FileChooserProps> = props => {\n\tconst {onChange} = props;\n\tconst {t} = useTranslation();\n\n\tfunction handleChange(file: File, data: string) {\n\t\tonChange(file, importStories(data));\n\t}\n\n\treturn (\n\t\t<div className=\"file-chooser\">\n\t\t\t<p>\n\t\t\t\t<FileInput\n\t\t\t\t\taccept=\".html\"\n\t\t\t\t\tonChange={handleChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.storyImport.filePrompt')}\n\t\t\t\t</FileInput>\n\t\t\t</p>\n\t\t</div>\n\t);\n};\n","import {IconFileImport} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {IconButton} from '../../components/control/icon-button';\nimport {storyFileName} from '../../electron/shared';\nimport {Story} from '../../store/stories';\nimport './story-chooser.css';\n\nexport interface StoryChooserProps {\n\texistingStories: Story[];\n\tonImport: (stories: Story[]) => void;\n\tstories: Story[];\n}\n\nexport const StoryChooser: React.FC<StoryChooserProps> = props => {\n\tconst {existingStories, onImport, stories} = props;\n\tconst [selectedStories, setSelectedStories] = React.useState<Story[]>([]);\n\tconst {t} = useTranslation();\n\n\tfunction willReplaceExisting(story: Story) {\n\t\treturn existingStories.some(\n\t\t\tother => storyFileName(other) === storyFileName(story)\n\t\t);\n\t}\n\n\tfunction handleChange(story: Story, selected: boolean) {\n\t\tif (selected) {\n\t\t\tsetSelectedStories(current => [...current, story]);\n\t\t} else {\n\t\t\tsetSelectedStories(current =>\n\t\t\t\tcurrent.filter(other => other.id !== story.id)\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<div className=\"story-chooser\">\n\t\t\t<p>{t('dialogs.storyImport.storiesPrompt')}</p>\n\t\t\t<ul>\n\t\t\t\t{stories.map(story => (\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<CheckboxButton\n\t\t\t\t\t\t\tkey={story.id}\n\t\t\t\t\t\t\tlabel={story.name}\n\t\t\t\t\t\t\tonChange={selected => handleChange(story, selected)}\n\t\t\t\t\t\t\tvalue={selectedStories.includes(story)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{selectedStories.includes(story) && willReplaceExisting(story) && (\n\t\t\t\t\t\t\t<span className=\"replace-warning\">\n\t\t\t\t\t\t\t\t{t('dialogs.storyImport.willReplaceExisting')}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</li>\n\t\t\t\t))}\n\t\t\t</ul>\n\t\t\t<IconButton\n\t\t\t\tdisabled={selectedStories.length === 0}\n\t\t\t\ticon={<IconFileImport />}\n\t\t\t\tlabel={t('dialogs.storyImport.importSelected')}\n\t\t\t\tonClick={() => onImport(selectedStories)}\n\t\t\t/>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CardContent} from '../../components/container/card';\nimport {\n\tDialogCard,\n\tDialogCardProps\n} from '../../components/container/dialog-card';\nimport {importStories, Story, useStoriesContext} from '../../store/stories';\nimport {FileChooser} from './file-chooser';\nimport {StoryChooser} from './story-chooser';\nimport './story-import.css';\n\nexport type StoryImportDialogProps = DialogCardProps;\n\nexport const StoryImportDialog: React.FC<StoryImportDialogProps> = props => {\n\tconst {onClose} = props;\n\tconst {t} = useTranslation();\n\tconst {dispatch, stories: existingStories} = useStoriesContext();\n\tconst [file, setFile] = React.useState<File>();\n\tconst [stories, setStories] = React.useState<Story[]>([]);\n\n\tfunction handleFileChange(file: File, stories: Story[]) {\n\t\tsetFile(file);\n\t\tsetStories(stories);\n\t}\n\n\tfunction handleImport(stories: Story[]) {\n\t\tdispatch(importStories(stories, existingStories));\n\t\tonClose();\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"story-import-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storyImport.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<FileChooser onChange={handleFileChange} />\n\t\t\t\t{file && stories.length > 0 && (\n\t\t\t\t\t<StoryChooser\n\t\t\t\t\t\texistingStories={existingStories}\n\t\t\t\t\t\tonImport={handleImport}\n\t\t\t\t\t\tstories={stories}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t\t{file && stories.length === 0 && (\n\t\t\t\t\t<p>{t('dialogs.storyImport.noStoriesInFile')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tpassageWithId,\n\tpassageWithName,\n\tstoryWithId,\n\tPassage,\n\tStoriesAction,\n\tStoriesState,\n\tStory\n} from '../stories';\nimport {StoriesActionOrThunk} from './undoable-stories.types';\n\n/**\n * Returns an action or thunk to reverse a single action.\n */\nexport function reverseAction(\n\taction: StoriesAction,\n\tstate: StoriesState\n): StoriesActionOrThunk {\n\tswitch (action.type) {\n\t\tcase 'createPassage':\n\t\t\tif (action.props.id) {\n\t\t\t\treturn {\n\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\tpassageId: action.props.id,\n\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t};\n\t\t\t} else if (action.props.name) {\n\t\t\t\t// This is dependant on the fact that we will only undo this action\n\t\t\t\t// immediately--otherwise this could create havoc if the passage has\n\t\t\t\t// been renamed in the meantime.\n\t\t\t\t//\n\t\t\t\t// This also assumes that the create action will succeed--e.g. there are\n\t\t\t\t// no conflicts.\n\t\t\t\tconst reverseThunk: Thunk<StoriesState, StoriesAction> = (\n\t\t\t\t\tdispatch,\n\t\t\t\t\tgetState\n\t\t\t\t) => {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\tpassageId: passageWithName(\n\t\t\t\t\t\t\tgetState(),\n\t\t\t\t\t\t\taction.storyId,\n\t\t\t\t\t\t\taction.props.name!\n\t\t\t\t\t\t).id,\n\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t});\n\t\t\t\t};\n\n\t\t\t\treturn reverseThunk;\n\t\t\t} else {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t\"Can't reverse a createPassage action without either name or ID\"\n\t\t\t\t);\n\t\t\t}\n\n\t\t// TODO: crashes on a replace all that affects a passage name, unclear why\n\n\t\tcase 'createPassages':\n\t\t\tif (action.props.some(prop => !prop.id && !prop.name)) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t\"Can't reverse a createPassages action where a prop set doesn't have either name or ID\"\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn (dispatch, getState) => {\n\t\t\t\taction.props.forEach(props => {\n\t\t\t\t\tif (props.id) {\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\t\tpassageId: props.id,\n\t\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t\t});\n\t\t\t\t\t} else if (props.name) {\n\t\t\t\t\t\t// This is dependent on the fact that we will only undo this action\n\t\t\t\t\t\t// immediately--see comment about the createPassage action.\n\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\t\tpassageId: passageWithName(getState(), action.storyId, props.name)\n\t\t\t\t\t\t\t\t.id,\n\t\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t};\n\n\t\tcase 'deletePassage':\n\t\t\treturn {\n\t\t\t\ttype: 'createPassage',\n\t\t\t\tprops: passageWithId(state, action.storyId, action.passageId),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'deletePassages':\n\t\t\treturn {\n\t\t\t\ttype: 'createPassages',\n\t\t\t\tprops: action.passageIds.map(passageId =>\n\t\t\t\t\tpassageWithId(state, action.storyId, passageId)\n\t\t\t\t),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'updatePassage': {\n\t\t\tconst passage = passageWithId(state, action.storyId, action.passageId);\n\t\t\tconst props = Object.keys(action.props).reduce(\n\t\t\t\t(result, propName) => ({\n\t\t\t\t\t...result,\n\t\t\t\t\t[propName]: passage[propName as keyof Passage]\n\t\t\t\t}),\n\t\t\t\t{} as Passage\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\ttype: 'updatePassage',\n\t\t\t\tprops,\n\t\t\t\tpassageId: action.passageId,\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\t\t}\n\n\t\tcase 'updatePassages':\n\t\t\treturn {\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tpassageUpdates: Object.keys(action.passageUpdates).reduce(\n\t\t\t\t\t(result, passageId) => {\n\t\t\t\t\t\tconst passage = passageWithId(state, action.storyId, passageId);\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t[passageId]: Object.keys(action.passageUpdates[passageId]).reduce(\n\t\t\t\t\t\t\t\t(passageResult, propName) => ({\n\t\t\t\t\t\t\t\t\t...passageResult,\n\t\t\t\t\t\t\t\t\t[propName]: passage[propName as keyof Passage]\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t{} as Passage\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t};\n\t\t\t\t\t},\n\t\t\t\t\t{} as Record<string, Partial<Passage>>\n\t\t\t\t),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'updateStory': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\tconst props = Object.keys(action.props).reduce(\n\t\t\t\t(result, propName) => ({\n\t\t\t\t\t...result,\n\t\t\t\t\t[propName]: story[propName as keyof Story]\n\t\t\t\t}),\n\t\t\t\t{} as Story\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops,\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\t\t}\n\t}\n\n\tthrow new Error(`Don't know how to reverse action type \"${action.type}\"`);\n}\n","import * as React from 'react';\nimport {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesAction, StoriesState} from '../stories';\nimport {reverseAction} from './reverse-action';\nimport {StoriesActionOrThunk} from './undoable-stories.types';\n\n/**\n * Returns a thunk to reverse a thunk's actions. **This only works with thunks\n * that dispatch all actions synchronously.**\n */\nexport function reverseThunk(\n\tthunk: Thunk<StoriesState, StoriesAction>,\n\tstate: StoriesState\n): Thunk<StoriesState, StoriesAction> {\n\tconst actions: StoriesActionOrThunk[] = [];\n\tconst dispatch: React.Dispatch<StoriesActionOrThunk> = (\n\t\tactionOrThunk: StoriesActionOrThunk\n\t) => {\n\t\tif (typeof actionOrThunk === 'function') {\n\t\t\tactions.push(reverseThunk(actionOrThunk, state));\n\t\t} else {\n\t\t\tactions.push(reverseAction(actionOrThunk, state));\n\t\t}\n\t};\n\n\tthunk(dispatch, () => state);\n\treturn dispatch => actions.forEach(dispatch);\n}\n","// This reducer manages tracking undo states only. It does not actually perform\n// the undo/redos itself--that is instead done by\n// <UndoableStoriesContextProvider>, which orchestrates things between this\n// reducer and the main stories reducer.\n\nimport * as React from 'react';\nimport {reverseAction} from './reverse-action';\nimport {reverseThunk} from './reverse-thunk';\nimport {\n\tStoryChange,\n\tUndoableStoriesAction,\n\tUndoableStoriesState\n} from './undoable-stories.types';\n\nexport const reducer: React.Reducer<\n\tUndoableStoriesState,\n\tUndoableStoriesAction\n> = (state, action) => {\n\tswitch (action.type) {\n\t\tcase 'addChange':\n\t\t\tconst newChange: StoryChange = {\n\t\t\t\tdescription: action.description,\n\t\t\t\tredo: action.action,\n\t\t\t\tundo:\n\t\t\t\t\ttypeof action.action === 'function'\n\t\t\t\t\t\t? reverseThunk(action.action, action.storiesState)\n\t\t\t\t\t\t: reverseAction(action.action, action.storiesState)\n\t\t\t};\n\n\t\t\t// Slice off any changes after the current one.\n\n\t\t\tconst newChanges = [\n\t\t\t\t...state.changes.slice(0, state.currentChange + 1),\n\t\t\t\tnewChange\n\t\t\t];\n\n\t\t\treturn {\n\t\t\t\tchanges: newChanges,\n\t\t\t\tcurrentChange: newChanges.length - 1\n\t\t\t};\n\n\t\tcase 'updateCurrent':\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tcurrentChange: Math.min(\n\t\t\t\t\tMath.max(state.currentChange + action.change, -1),\n\t\t\t\t\tstate.changes.length - 1\n\t\t\t\t)\n\t\t\t};\n\t}\n};\n","// This context wraps access to a StoriesContext so that changes made can be\n// undone. To properly use this, a change should be dispatched via either a\n// single action object or a thunk. This context assumes that each dispatch call\n// should be treated as a discrete change. If this context is being used, all\n// changes should go through this context--the StoriesContext shouldn't be\n// accessed directly.\n\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {\n\tStoriesActionOrThunk,\n\tUndoableStoriesContextProps\n} from './undoable-stories.types';\nimport {reducer} from './reducer';\nimport {useStoriesContext} from '../stories';\n\nexport const UndoableStoriesContext = React.createContext<UndoableStoriesContextProps>(\n\t{\n\t\tdispatch: () => {},\n\t\tstories: []\n\t}\n);\n\nUndoableStoriesContext.displayName = 'UndoableStories';\n\nexport const useUndoableStoriesContext = () =>\n\tReact.useContext(UndoableStoriesContext);\n\nexport const UndoableStoriesContextProvider: React.FC = props => {\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\tconst [state, dispatch] = React.useReducer(reducer, {\n\t\tchanges: [],\n\t\tcurrentChange: -1\n\t});\n\tconst dispatchAndRecordStoryAction = React.useCallback(\n\t\t(action: StoriesActionOrThunk, description?: string) => {\n\t\t\tif (description) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addChange',\n\t\t\t\t\taction,\n\t\t\t\t\tdescription: description,\n\t\t\t\t\tstoriesState: stories\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn storiesDispatch(action);\n\t\t},\n\t\t[stories, storiesDispatch]\n\t);\n\tconst {t} = useTranslation();\n\n\tlet redo: (() => void) | undefined = undefined;\n\tlet redoLabel: string | undefined = undefined;\n\tlet undo: (() => void) | undefined = undefined;\n\tlet undoLabel: string | undefined = undefined;\n\n\tif (state.changes.length > 0) {\n\t\tif (state.currentChange >= 0) {\n\t\t\tundo = () => {\n\t\t\t\tstoriesDispatch(state.changes[state.currentChange].undo);\n\t\t\t\tdispatch({type: 'updateCurrent', change: -1});\n\t\t\t};\n\t\t\tundoLabel = t('common.undoChange', {\n\t\t\t\tchange: t(state.changes[state.currentChange].description)\n\t\t\t});\n\t\t}\n\n\t\tif (state.currentChange < state.changes.length - 1) {\n\t\t\tredo = () => {\n\t\t\t\tstoriesDispatch(state.changes[state.currentChange + 1].redo);\n\t\t\t\tdispatch({type: 'updateCurrent', change: 1});\n\t\t\t};\n\t\t\tredoLabel = t('common.redoChange', {\n\t\t\t\tchange: t(state.changes[state.currentChange + 1].description)\n\t\t\t});\n\t\t}\n\t}\n\n\treturn (\n\t\t<UndoableStoriesContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch: dispatchAndRecordStoryAction,\n\t\t\t\tredo,\n\t\t\t\tredoLabel,\n\t\t\t\tstories,\n\t\t\t\tundo,\n\t\t\t\tundoLabel\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</UndoableStoriesContext.Provider>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {StoryFormat, sortFormats} from '../../store/story-formats';\nimport {TextSelect, TextSelectProps} from '../control/text-select';\n\nexport interface StoryFormatSelectProps\n\textends Omit<TextSelectProps, 'options' | 'value'> {\n\tformats: StoryFormat[];\n\tselectedFormat: StoryFormat;\n}\n\nexport const StoryFormatSelect: React.FC<StoryFormatSelectProps> = props => {\n\tconst {formats, selectedFormat, ...other} = props;\n\tconst {t} = useTranslation();\n\tconst loadingFormats = formats.filter(\n\t\tformat => format.loadState === 'loading'\n\t);\n\tconst visibleFormats = sortFormats(\n\t\tformats.filter(\n\t\t\tformat => format.loadState === 'loaded' || format.id === selectedFormat.id\n\t\t)\n\t);\n\tconst options = visibleFormats.map(format => ({\n\t\tdisabled: false,\n\t\tlabel: `${format.name} ${format.version}`,\n\t\tvalue: format.id\n\t}));\n\n\tif (loadingFormats.length !== 0) {\n\t\toptions.push({\n\t\t\tdisabled: true,\n\t\t\tlabel: t('components.storyFormatSelect.loadingCount', {\n\t\t\t\tloadingCount: loadingFormats.length\n\t\t\t}),\n\t\t\tvalue: ''\n\t\t});\n\t}\n\n\treturn <TextSelect {...other} options={options} value={selectedFormat.id} />;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {storyStats, Story} from '../../store/stories';\nimport './story-stats.css';\n\nconst dateFormatter = new Intl.DateTimeFormat([], {\n\tdateStyle: 'full',\n\ttimeStyle: 'long'\n});\n\nexport interface StoryDetailsDialogStatsProps {\n\tstory: Story;\n}\n\nexport const StoryDetailsDialogStats: React.FC<StoryDetailsDialogStatsProps> = props => {\n\tconst {story} = props;\n\tconst stats = storyStats(story);\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"story-stats\">\n\t\t\t<table className=\"counts\">\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.characters}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.characters')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.words}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.words')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.passages}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.passages')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.links.length}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.links')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.brokenLinks.length}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.brokenLinks')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t<div className=\"update-and-ifid\">\n\t\t\t\t<p>\n\t\t\t\t\t{t('dialogs.storyDetails.stats.lastUpdate', {\n\t\t\t\t\t\tdate: dateFormatter.format(story.lastUpdate)\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t\t<p>\n\t\t\t\t\t{t('dialogs.storyDetails.stats.ifid', {ifid: story.ifid})}&nbsp;\n\t\t\t\t\t<a href=\"https://ifdb.org/help-ifid\" target=\"_blank\" rel=\"noreferrer\">\n\t\t\t\t\t\t{t('dialogs.storyDetails.stats.ifidExplanation')}\n\t\t\t\t\t</a>\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {CardContent} from '../../components/container/card';\nimport {DialogCard} from '../../components/container/dialog-card';\nimport {StoryFormatSelect} from '../../components/story-format/story-format-select';\nimport {storyWithId, updateStory, useStoriesContext} from '../../store/stories';\nimport {\n\tformatWithId,\n\tformatWithNameAndVersion,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {FormatLoader} from '../../store/format-loader';\nimport {DialogComponentProps} from '../dialogs.types';\nimport {StoryDetailsDialogStats} from './story-stats';\n\nexport interface StoryDetailsDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryDetailsDialog: React.FC<StoryDetailsDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {formats} = useStoryFormatsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tfunction handleFormatChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tconst newFormat = formatWithId(formats, event.target.value);\n\n\t\tdispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\tstoryFormat: newFormat.name,\n\t\t\t\tstoryFormatVersion: newFormat.version\n\t\t\t})\n\t\t);\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-details-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={story.name}\n\t\t>\n\t\t\t<div className=\"story-format\">\n\t\t\t\t<FormatLoader block={false} />\n\t\t\t\t<StoryFormatSelect\n\t\t\t\t\tformats={formats}\n\t\t\t\t\tonChange={handleFormatChange}\n\t\t\t\t\tselectedFormat={formatWithNameAndVersion(\n\t\t\t\t\t\tformats,\n\t\t\t\t\t\tstory.storyFormat,\n\t\t\t\t\t\tstory.storyFormatVersion\n\t\t\t\t\t)}\n\t\t\t\t>\n\t\t\t\t\t{t('common.storyFormat')}\n\t\t\t\t</StoryFormatSelect>\n\t\t\t\t<a\n\t\t\t\t\thref=\"https://twinery.org/2storyformats\"\n\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\trel=\"noreferrer\"\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.storyDetails.storyFormatExplanation')}\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t\t<ButtonBar>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storyDetails.snapToGrid')}\n\t\t\t\t\tonChange={value =>\n\t\t\t\t\t\tdispatch(updateStory(stories, story, {snapToGrid: value}))\n\t\t\t\t\t}\n\t\t\t\t\tvalue={story.snapToGrid}\n\t\t\t\t/>\n\t\t\t</ButtonBar>\n\t\t\t<CardContent>\n\t\t\t\t{!other.collapsed && <StoryDetailsDialogStats story={story} />}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {TextInput} from './text-input';\nimport {TextSelect} from './text-select';\nimport './font-select.css';\n\nconst families = ['var(--font-monospaced)', 'var(--font-system)'];\nconst scales = [0.8, 0.9, 1, 1.25, 1.5, 2];\n\nexport interface FontSelectProps {\n\tfamilyLabel: string;\n\tfontFamily: string;\n\tfontScale: number;\n\tonChangeFamily: (value: string) => void;\n\tonChangeScale: (value: number) => void;\n\tscaleLabel: string;\n}\n\nexport const FontSelect: React.FC<FontSelectProps> = props => {\n\tconst {\n\t\tfamilyLabel,\n\t\tfontFamily,\n\t\tfontScale,\n\t\tonChangeFamily,\n\t\tonChangeScale,\n\t\tscaleLabel\n\t} = props;\n\tconst [customScaleVisible, setCustomScaleVisible] = React.useState(\n\t\t!scales.includes(fontScale)\n\t);\n\tconst [customFamilyVisible, setCustomFamilyVisible] = React.useState(\n\t\t!families.includes(fontFamily)\n\t);\n\tconst [customFamily, setCustomFamily] = React.useState(fontFamily);\n\tconst [customScale, setCustomScale] = React.useState(\n\t\t(fontScale * 100).toString()\n\t);\n\tconst {t} = useTranslation();\n\n\tfunction handleFamilyChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tif (event.target.value === 'custom') {\n\t\t\tsetCustomFamilyVisible(true);\n\t\t} else {\n\t\t\tsetCustomFamilyVisible(false);\n\t\t\tonChangeFamily(event.target.value);\n\t\t}\n\t}\n\n\tfunction handleScaleChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tif (event.target.value === 'custom') {\n\t\t\tsetCustomScaleVisible(true);\n\t\t} else {\n\t\t\tsetCustomScaleVisible(false);\n\t\t\tonChangeScale(parseFloat(event.target.value));\n\t\t}\n\t}\n\n\tfunction handleCustomFamilyChange(\n\t\tevent: React.ChangeEvent<HTMLInputElement>\n\t) {\n\t\tsetCustomFamily(event.target.value);\n\n\t\tif (event.target.value.trim() !== '') {\n\t\t\tonChangeFamily(event.target.value);\n\t\t}\n\t}\n\n\tfunction handleCustomScaleChange(event: React.ChangeEvent<HTMLInputElement>) {\n\t\tsetCustomScale(event.target.value);\n\n\t\tconst value = parseInt(event.target.value);\n\n\t\tif (Number.isFinite(value)) {\n\t\t\tonChangeScale(value / 100);\n\t\t}\n\t}\n\n\treturn (\n\t\t<div className=\"font-select\">\n\t\t\t<TextSelect\n\t\t\t\tonChange={handleFamilyChange}\n\t\t\t\toptions={[\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('components.fontSelect.fonts.system'),\n\t\t\t\t\t\tvalue: 'var(--font-system)'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('components.fontSelect.fonts.monospaced'),\n\t\t\t\t\t\tvalue: 'var(--font-monospaced)'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('common.custom'),\n\t\t\t\t\t\tvalue: 'custom'\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tvalue={customFamilyVisible ? 'custom' : fontFamily}\n\t\t\t>\n\t\t\t\t{familyLabel}\n\t\t\t</TextSelect>\n\t\t\t{customFamilyVisible && (\n\t\t\t\t<TextInput\n\t\t\t\t\tonChange={handleCustomFamilyChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t\tvalue={customFamily}\n\t\t\t\t>\n\t\t\t\t\t{t('components.fontSelect.customFamilyDetail')}\n\t\t\t\t</TextInput>\n\t\t\t)}\n\t\t\t<TextSelect\n\t\t\t\tonChange={handleScaleChange}\n\t\t\t\toptions={[\n\t\t\t\t\t...scales.map(scale => ({\n\t\t\t\t\t\tlabel: t('components.fontSelect.percentage', {\n\t\t\t\t\t\t\tpercent: scale * 100\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tvalue: scale.toString()\n\t\t\t\t\t})),\n\t\t\t\t\t{label: t('common.custom'), value: 'custom'}\n\t\t\t\t]}\n\t\t\t\tvalue={customScaleVisible ? 'custom' : fontScale.toString()}\n\t\t\t>\n\t\t\t\t{scaleLabel}\n\t\t\t</TextSelect>\n\t\t\t{customScaleVisible && (\n\t\t\t\t<TextInput\n\t\t\t\t\tonChange={handleCustomScaleChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t\tvalue={customScale}\n\t\t\t\t>\n\t\t\t\t\t{t('components.fontSelect.customScaleDetail')}\n\t\t\t\t</TextInput>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n","/**\n * Locales supported in the app.\n * @see https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes\n */\nexport const locales = [\n\t{code: 'ca', name: 'Català'},\n\t{code: 'cs', name: 'Čeština'},\n\t{code: 'da', name: 'Dansk'},\n\t{code: 'de', name: 'Deutsch'},\n\t{code: 'en', name: 'English'},\n\t{code: 'es', name: 'Castellano'},\n\t{code: 'fi', name: 'Suomi'},\n\t{code: 'fr', name: 'Français'},\n\t{code: 'it', name: 'Italiano'},\n\t{code: 'ms', name: 'Bahasa Melayu'},\n\t{code: 'nb', name: 'Norsk bokmål'},\n\t{code: 'nl', name: 'Nederlands'},\n\t{code: 'pt-br', name: 'Português Brasileiro'},\n\t{code: 'pt-pt', name: 'Português'},\n\t{code: 'ru', name: 'русский'},\n\t{code: 'sv', name: 'Svenska'},\n\t{code: 'tr', name: 'Türkçe'},\n\t{code: 'zh-cn', name: '中文(简体)'}\n];\n\n/**\n * Mappings of locale codes to flag codes, when they aren't the same.\n * @see https://flagicons.lipis.dev/\n */\nexport const flags = {\n\tca: 'catalonia', // Special case--see src/components/image/flag.css\n\tcs: 'cz',\n\tda: 'dk',\n\ten: 'gb',\n\tms: 'my',\n\tnb: 'no',\n\t'pt-br': 'br',\n\t'pt-pt': 'pt',\n\tsv: 'se',\n\t'zh-cn': 'cn'\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CardContent} from '../components/container/card';\nimport {DialogCard, DialogCardProps} from '../components/container/dialog-card';\nimport {CheckboxButton} from '../components/control/checkbox-button';\nimport {FontSelect} from '../components/control/font-select';\nimport {TextSelect} from '../components/control/text-select';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {locales} from '../util/locales';\nimport './app-prefs.css';\n\nexport const AppPrefsDialog: React.FC<\n\tOmit<DialogCardProps, 'headerLabel'>\n> = props => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"app-prefs-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.appPrefs.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<TextSelect\n\t\t\t\t\tonChange={e => dispatch(setPref('locale', e.target.value))}\n\t\t\t\t\toptions={locales.map(locale => ({\n\t\t\t\t\t\tlabel: locale.name,\n\t\t\t\t\t\tvalue: locale.code\n\t\t\t\t\t}))}\n\t\t\t\t\tvalue={prefs.locale}\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.appPrefs.language')}\n\t\t\t\t</TextSelect>\n\t\t\t\t<TextSelect\n\t\t\t\t\tonChange={e => dispatch(setPref('appTheme', e.target.value))}\n\t\t\t\t\toptions={[\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeSystem'), value: 'system'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeLight'), value: 'light'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeDark'), value: 'dark'}\n\t\t\t\t\t]}\n\t\t\t\t\tvalue={prefs.appTheme}\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.appPrefs.theme')}\n\t\t\t\t</TextSelect>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.appPrefs.editorCursorBlinks')}\n\t\t\t\t\tonChange={value => dispatch(setPref('editorCursorBlinks', value))}\n\t\t\t\t\tvalue={prefs.editorCursorBlinks}\n\t\t\t\t/>\n\t\t\t\t<p className=\"font-explanation\">\n\t\t\t\t\t{t('dialogs.appPrefs.fontExplanation')}\n\t\t\t\t</p>\n\t\t\t\t<FontSelect\n\t\t\t\t\tfamilyLabel={t('dialogs.appPrefs.passageEditorFont')}\n\t\t\t\t\tfontFamily={prefs.passageEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.passageEditorFontScale}\n\t\t\t\t\tonChangeFamily={value =>\n\t\t\t\t\t\tdispatch(setPref('passageEditorFontFamily', value))\n\t\t\t\t\t}\n\t\t\t\t\tonChangeScale={value =>\n\t\t\t\t\t\tdispatch(setPref('passageEditorFontScale', value))\n\t\t\t\t\t}\n\t\t\t\t\tscaleLabel={t('dialogs.appPrefs.passageEditorFontScale')}\n\t\t\t\t/>\n\t\t\t\t<FontSelect\n\t\t\t\t\tfamilyLabel={t('dialogs.appPrefs.codeEditorFont')}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tonChangeFamily={value =>\n\t\t\t\t\t\tdispatch(setPref('codeEditorFontFamily', value))\n\t\t\t\t\t}\n\t\t\t\t\tonChangeScale={value =>\n\t\t\t\t\t\tdispatch(setPref('codeEditorFontScale', value))\n\t\t\t\t\t}\n\t\t\t\t\tscaleLabel={t('dialogs.appPrefs.codeEditorFontScale')}\n\t\t\t\t/>\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\nimport {defaults} from './defaults';\nimport {PrefsAction, PrefsContextProps, PrefsState} from './prefs.types';\nimport {reducer} from './reducer';\n\nexport const PrefsContext = React.createContext<PrefsContextProps>({\n\tdispatch: () => {},\n\tprefs: defaults()\n});\n\nPrefsContext.displayName = 'Prefs';\n\nexport const usePrefsContext = () => React.useContext(PrefsContext);\n\nexport const PrefsContextProvider: React.FC = props => {\n\tconst {prefs} = usePersistence();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tPrefsState,\n\t\tPrefsAction\n\t> = React.useCallback(\n\t\t(state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tprefs.saveMiddleware(newState, action);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistPrefs');\n\t\t\t}\n\n\t\t\treturn newState;\n\t\t},\n\t\t[prefs, reportError]\n\t);\n\n\tconst [state, dispatch] = React.useReducer(persistedReducer, defaults());\n\n\treturn (\n\t\t<PrefsContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch,\n\t\t\t\tprefs: state\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</PrefsContext.Provider>\n\t);\n};\n","import {PrefsAction, PrefsState} from './prefs.types';\nimport {defaults} from './defaults';\n\nexport const reducer: React.Reducer<PrefsState, PrefsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\t\treturn {...state, ...action.state};\n\n\t\tcase 'repair':\n\t\t\tlet changes: Partial<PrefsState> = Object.entries(defaults()).reduce(\n\t\t\t\t(result, [key, value]) => {\n\t\t\t\t\tconst prefKey = key as keyof PrefsState;\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t(typeof value === 'number' && !Number.isFinite(state[prefKey])) ||\n\t\t\t\t\t\ttypeof value !== typeof state[prefKey]\n\t\t\t\t\t) {\n\t\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t\t`Repairing preference \"${key}\" by setting it to ${value}, ` +\n\t\t\t\t\t\t\t\t`was ${state[prefKey]} (bad type)`\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn {...result, [prefKey]: value};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn result;\n\t\t\t\t},\n\t\t\t\t{}\n\t\t\t);\n\t\t\treturn {...state, ...changes};\n\n\t\tcase 'update': {\n\t\t\treturn {...state, [action.name]: action.value};\n\t\t}\n\t}\n};\n","import uuid from 'tiny-uuid';\nimport * as React from 'react';\nimport useThunkReducer from 'react-hook-thunk-reducer';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {builtins} from './defaults';\nimport {\n\tStoryFormat,\n\tStoryFormatsAction,\n\tStoryFormatsContextProps,\n\tStoryFormatsState\n} from './story-formats.types';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\nimport {reducer} from './reducer';\n\nconst defaultBuiltins: StoryFormat[] = builtins().map(f => ({\n\t...f,\n\tid: uuid(),\n\tloadState: 'unloaded',\n\tselected: false,\n\tuserAdded: false\n}));\n\nexport const StoryFormatsContext = React.createContext<StoryFormatsContextProps>(\n\t{\n\t\tdispatch: () => {},\n\t\tformats: []\n\t}\n);\n\nStoryFormatsContext.displayName = 'StoryFormats';\n\nexport const useStoryFormatsContext = () =>\n\tReact.useContext(StoryFormatsContext);\n\nexport const StoryFormatsContextProvider: React.FC = props => {\n\tconst {storyFormats} = usePersistence();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tStoryFormatsState,\n\t\tStoryFormatsAction\n\t> = React.useCallback(\n\t\t(state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tstoryFormats.saveMiddleware(newState, action);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistStoryFormats');\n\t\t\t}\n\t\t\treturn newState;\n\t\t},\n\t\t[reportError, storyFormats]\n\t);\n\n\tconst [state, dispatch] = useThunkReducer(persistedReducer, defaultBuiltins);\n\n\treturn (\n\t\t<StoryFormatsContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch,\n\t\t\t\tformats: state\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</StoryFormatsContext.Provider>\n\t);\n};\n","import uuid from 'tiny-uuid';\nimport {builtins} from './defaults';\nimport {\n\tStoryFormat,\n\tStoryFormatsAction,\n\tStoryFormatsState\n} from './story-formats.types';\n\nexport const reducer: React.Reducer<StoryFormatsState, StoryFormatsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\t\treturn [...action.state];\n\n\t\tcase 'repair':\n\t\t\tconst builtinFormats = builtins();\n\n\t\t\t// Filter out any outdated builtins.\n\n\t\t\tconst result = state.filter(format => {\n\t\t\t\tconst keep =\n\t\t\t\t\tformat.userAdded ||\n\t\t\t\t\tbuiltinFormats.some(\n\t\t\t\t\t\tf => f.name === format.name && f.version === format.version\n\t\t\t\t\t);\n\n\t\t\t\tif (!keep) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story formats by removing ${format.name} ${format.version} ` +\n\t\t\t\t\t\t\t`(outdated version of built-in format)`\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\treturn keep;\n\t\t\t});\n\n\t\t\t// Add any builtins not present.\n\n\t\t\tbuiltinFormats.forEach(builtinFormat => {\n\t\t\t\tif (\n\t\t\t\t\t!result.some(\n\t\t\t\t\t\tf =>\n\t\t\t\t\t\t\tf.name === builtinFormat.name &&\n\t\t\t\t\t\t\tf.version === builtinFormat.version\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story formats by adding built-in ${builtinFormat.name} ${builtinFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tresult.push({\n\t\t\t\t\t\t...builtinFormat,\n\t\t\t\t\t\tid: uuid(),\n\t\t\t\t\t\tloadState: 'unloaded',\n\t\t\t\t\t\tselected: false,\n\t\t\t\t\t\tuserAdded: false\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn result;\n\n\t\tcase 'create':\n\t\t\tif (\n\t\t\t\tstate.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.name === action.props.name &&\n\t\t\t\t\t\tformat.version === action.props.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\treturn [...state, {...action.props, id: uuid(), loadState: 'unloaded'}];\n\n\t\tcase 'delete':\n\t\t\treturn state.filter(f => f.id !== action.id);\n\n\t\tcase 'update':\n\t\t\tif (\n\t\t\t\tstate.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.id !== action.id &&\n\t\t\t\t\t\tformat.name === action.props.name &&\n\t\t\t\t\t\tformat.version === action.props.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\treturn state.map(format => {\n\t\t\t\tif (format.id !== action.id) {\n\t\t\t\t\treturn format;\n\t\t\t\t}\n\n\t\t\t\treturn {...format, ...action.props} as StoryFormat;\n\t\t\t});\n\t}\n\n\treturn state;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconCode, IconHeart} from '@tabler/icons';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {DialogCard} from '../../components/container/dialog-card';\nimport {IconLink} from '../../components/control/icon-link';\nimport {getAppInfo} from '../../util/app-info';\nimport {DialogComponentProps} from '../dialogs.types';\nimport credits from './credits.json';\nimport './about-twine.css';\n\nexport const AboutTwineDialog: React.FC<DialogComponentProps> = props => {\n\tconst {t} = useTranslation();\n\tconst info = getAppInfo();\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"about-twine-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.aboutTwine.title', {\n\t\t\t\tversion: info.version\n\t\t\t})}\n\t\t>\n\t\t\t<div className=\"content\">\n\t\t\t\t<p>{t('dialogs.aboutTwine.twineDescription')}</p>\n\t\t\t\t<p\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: t('dialogs.aboutTwine.license')\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t\t<div className=\"credits\">\n\t\t\t\t\t<div className=\"code\">\n\t\t\t\t\t\t<h3>{t('dialogs.aboutTwine.codeHeader')}</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t{credits.code.map(c => (\n\t\t\t\t\t\t\t\t<li key={c}>{c}</li>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"localizations\">\n\t\t\t\t\t\t<h3>{t('dialogs.aboutTwine.localizationHeader')}</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t{credits.localizations.map(c => (\n\t\t\t\t\t\t\t\t<li key={c}>{c}</li>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://twinery.org/donate\"\n\t\t\t\t\t\ticon={<IconHeart />}\n\t\t\t\t\t\tlabel={t('dialogs.aboutTwine.donateToTwine')}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://github.com/klembot/twinejs\"\n\t\t\t\t\t\ticon={<IconCode />}\n\t\t\t\t\t\tlabel={t('dialogs.aboutTwine.codeRepo')}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</div>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\n\n// TODO make this user-friendly\n\nexport interface GlobalErrorBoundaryState {\n\terror: Error | null;\n}\n\nexport class GlobalErrorBoundary extends React.Component<\n\t{},\n\tGlobalErrorBoundaryState\n> {\n\tconstructor(props: {}) {\n\t\tsuper(props);\n\t\tthis.state = {error: null};\n\t}\n\n\tpublic static getDerivedStateFromError(error: Error) {\n\t\t// Update state so the next render will show the fallback UI.\n\t\tconsole.error(error);\n\t\treturn {error};\n\t}\n\n\tpublic render() {\n\t\tif (this.state.error) {\n\t\t\treturn <p>An error occurred: {this.state.error.message}</p>;\n\t\t}\n\n\t\treturn this.props.children;\n\t}\n}\n","import * as React from 'react';\nimport {IconLoading} from '../image/icon';\nimport './loading-curtain.css';\n\nexport const LoadingCurtain: React.FC = () => (\n\t<div className=\"loading-curtain\">\n\t\t<IconLoading />\n\t</div>\n);\n","// Listens to changes in the locale preference and changes i18n's language\n// accordingly.\n\nimport * as React from 'react';\nimport {usePrefsContext} from './prefs';\nimport {i18n} from '../util/i18n';\n\nexport const LocaleSwitcher: React.FC = () => {\n\tconst {prefs} = usePrefsContext();\n\n\tReact.useEffect(() => {\n\t\ti18n.changeLanguage(prefs.locale);\n\t}, [prefs.locale]);\n\n\treturn null;\n};\n","import * as React from 'react';\nimport 'element-closest';\n\nexport interface ClickAwayListenerProps {\n\tignoreSelector?: string;\n\tonClickAway: () => void;\n}\n\nexport const ClickAwayListener: React.FC<ClickAwayListenerProps> = props => {\n\tconst {children, ignoreSelector, onClickAway} = props;\n\tconst handleClick: React.MouseEventHandler = event => {\n\t\tif (ignoreSelector) {\n\t\t\tif (!(event.target as HTMLElement)?.closest(ignoreSelector)) {\n\t\t\t\tonClickAway();\n\t\t\t}\n\t\t} else {\n\t\t\tonClickAway();\n\t\t}\n\t};\n\n\treturn <div onClick={handleClick}>{children}</div>;\n};\n","import * as React from 'react';\nimport './card-group.css';\n\nexport type CardGroupProps =\n\t| {columns: number; maxWidth?: string}\n\t| {columnWidth: number | string; maxWidth?: string};\n\nexport const CardGroup: React.FC<CardGroupProps> = props => {\n\tconst style: React.CSSProperties = {\n\t\tgridTemplateColumns:\n\t\t\t'columnWidth' in props\n\t\t\t\t? `repeat(auto-fit, ${\n\t\t\t\t\t\ttypeof props.columnWidth === 'number'\n\t\t\t\t\t\t\t? props.columnWidth + 'px'\n\t\t\t\t\t\t\t: props.columnWidth\n\t\t\t\t  })`\n\t\t\t\t: `repeat(${props.columns}, 1fr)`,\n\t\tmaxWidth: props.maxWidth ?? 'auto'\n\t};\n\n\treturn (\n\t\t<div className=\"card-group\" style={style}>\n\t\t\t{props.children}\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport {Helmet} from 'react-helmet';\nimport './main-content.css';\n\nexport interface MainContentProps\n\textends React.ComponentPropsWithoutRef<'div'> {\n\tgrabbable?: boolean;\n\tpadded?: boolean;\n\ttitle?: string;\n}\n\nexport const MainContent = React.forwardRef<HTMLDivElement, MainContentProps>(\n\t(props, ref) => {\n\t\tconst {children, title} = props;\n\t\tconst className = classNames('main-content', {\n\t\t\tpadded: props.padded ?? true\n\t\t});\n\n\t\treturn (\n\t\t\t<div className={className} ref={ref}>\n\t\t\t\t{title && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<Helmet>\n\t\t\t\t\t\t\t<title>{title}</title>\n\t\t\t\t\t\t</Helmet>\n\t\t\t\t\t\t<h1>{title}</h1>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t\t{children}\n\t\t\t</div>\n\t\t);\n\t}\n);\n","import * as React from 'react';\nimport './badge.css';\n\nexport interface BadgeProps {\n\tlabel: string;\n}\n\nexport const Badge: React.FC<BadgeProps> = ({label}) => (\n\t<span className=\"badge\">{label}</span>\n);\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {StoryFormat} from '../../../store/story-formats';\n\nexport interface StoryFormatCardDetailsProps {\n\tformat: StoryFormat;\n}\n\nexport const StoryFormatCardDetails: React.FC<StoryFormatCardDetailsProps> = ({\n\tformat\n}) => {\n\tconst {t} = useTranslation();\n\n\tif (format.loadState === 'unloaded' || format.loadState === 'loading') {\n\t\treturn (\n\t\t\t<div className=\"story-format-card-details\">\n\t\t\t\t<p>{t('components.storyFormatCard.loadingFormat')}</p>\n\t\t\t</div>\n\t\t);\n\t}\n\n\tif (format.loadState === 'error') {\n\t\treturn (\n\t\t\t<div className=\"story-format-card-details\">\n\t\t\t\t<p>\n\t\t\t\t\t{t('components.storyFormatCard.loadError', {\n\t\t\t\t\t\terrorMessage: format.loadError.message\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t);\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-card-details\">\n\t\t\t{format.properties.author && (\n\t\t\t\t<p\n\t\t\t\t\tclassName=\"story-format-card-author\"\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: t('components.storyFormatCard.author', {\n\t\t\t\t\t\t\tauthor: format.properties.author\n\t\t\t\t\t\t})\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t{format.properties.description && (\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"story-format-card-description\"\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: format.properties.description\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t{format.properties.license && (\n\t\t\t\t<p className=\"story-format-card-license\">\n\t\t\t\t\t{t('components.storyFormatCard.license', {\n\t\t\t\t\t\tlicense: format.properties.license\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n","import {IconAlertTriangle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {formatImageUrl, StoryFormat} from '../../../store/story-formats';\nimport {Badge} from '../../badge/badge';\nimport {Card, CardContent} from '../../container/card';\nimport {IconLoading} from '../../image/icon';\nimport {StoryFormatCardDetails} from './story-format-card-details';\nimport './story-format-card.css';\n\nexport interface StoryFormatCardProps {\n\tdefaultFormat: boolean;\n\teditorExtensionsDisabled: boolean;\n\tformat: StoryFormat;\n\tonSelect: () => void;\n}\n\nexport const StoryFormatCard: React.FC<StoryFormatCardProps> = props => {\n\tconst {defaultFormat, editorExtensionsDisabled, format, onSelect} = props;\n\tconst {t} = useTranslation();\n\n\tlet image = <></>;\n\n\tif (format.loadState === 'error') {\n\t\timage = <IconAlertTriangle />;\n\t} else if (\n\t\tformat.loadState === 'unloaded' ||\n\t\tformat.loadState === 'loading'\n\t) {\n\t\timage = <IconLoading />;\n\t} else if (format.loadState === 'loaded' && format.properties.image) {\n\t\timage = <img src={formatImageUrl(format)} alt=\"\" />;\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-card\" onClick={onSelect}>\n\t\t\t<Card selected={format.selected}>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<div className=\"story-format-image\">{image}</div>\n\t\t\t\t\t<div className=\"story-format-description\">\n\t\t\t\t\t\t<h2>\n\t\t\t\t\t\t\t{t('components.storyFormatCard.name', {\n\t\t\t\t\t\t\t\tname: format.name,\n\t\t\t\t\t\t\t\tversion: format.version\n\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<StoryFormatCardDetails format={format} />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"story-format-badges\">\n\t\t\t\t\t\t{!format.userAdded && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.builtIn')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{defaultFormat && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.defaultFormat')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{editorExtensionsDisabled && (\n\t\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\t\tlabel={t('components.storyFormatCard.editorExtensionsDisabled')}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{format.loadState === 'loaded' && format.properties.proofing && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.proofing')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</CardContent>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import {IconArrowLeft} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconButton} from '../control/icon-button';\n\nexport const BackButton: React.FC = () => {\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\tif (['/', '/stories'].includes(history.location.pathname)) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconArrowLeft />}\n\t\t\tvariant=\"primary\"\n\t\t\tlabel={\n\t\t\t\thistory.length > 1\n\t\t\t\t\t? t('common.back')\n\t\t\t\t\t: t('routes.storyList.titleGeneric')\n\t\t\t}\n\t\t\tonClick={() =>\n\t\t\t\thistory.length > 1 ? history.goBack() : history.push('/')\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconHelp} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {Tab, TabList, TabPanel, Tabs} from 'react-tabs';\nimport {IconButton} from '../control/icon-button';\nimport {BackButton} from './back-button';\nimport './route-toolbar.css';\n\nexport interface RouteToolbarProps {\n\thelpUrl?: string;\n\tpinnedControls?: React.ReactNode;\n\ttabs: Record<string, React.ReactNode>;\n}\n\nexport const RouteToolbar: React.FC<RouteToolbarProps> = props => {\n\tconst {helpUrl = 'https://twinery.org/2guide', pinnedControls, tabs} = props;\n\tconst {t} = useTranslation();\n\t\n\treturn (\n\t\t<div className=\"route-toolbar\">\n\t\t\t<Tabs selectedTabClassName=\"selected\">\n\t\t\t\t<div className=\"route-toolbar-top\">\n\t\t\t\t\t<BackButton />\n\t\t\t\t\t<TabList className=\"route-toolbar-tablist\">\n\t\t\t\t\t\t{Object.keys(tabs).map(tabName => (\n\t\t\t\t\t\t\t<Tab className=\"route-toolbar-tab\" key={tabName}>\n\t\t\t\t\t\t\t\t{tabName}\n\t\t\t\t\t\t\t</Tab>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</TabList>\n\t\t\t\t\t<div className=\"route-toolbar-pinned-controls\">\n\t\t\t\t\t\t{pinnedControls}\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconHelp />}\n\t\t\t\t\t\t\tlabel={t('common.help')}\n\t\t\t\t\t\t\tonClick={() => window.open(helpUrl, '_blank')}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div>\n\t\t\t\t\t{Object.entries(tabs).map(([tabName, tabContent]) => (\n\t\t\t\t\t\t<TabPanel key={tabName}>{tabContent}</TabPanel>\n\t\t\t\t\t))}\n\t\t\t\t</div>\n\t\t\t</Tabs>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {\n\tpublishArchive,\n\tpublishStory,\n\tpublishStoryWithFormat,\n\tPublishOptions\n} from '../util/publish';\nimport {usePrefsContext} from './prefs';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {storyWithId, useStoriesContext} from './stories';\nimport {getAppInfo} from '../util/app-info';\n\nexport interface UsePublishingProps {\n\tproofStory: (storyId: string) => Promise<string>;\n\tpublishArchive: (storyIds?: string[]) => Promise<string>;\n\tpublishStory: (\n\t\tstoryId: string,\n\t\tpublishOptions?: PublishOptions\n\t) => Promise<string>;\n\tpublishStoryData: (storyId: string) => string;\n}\n\n/**\n * A React hook publish stories from context. You probably want to use\n * `useStoryLaunch` instead--this is for doing the actual binding of the story\n * and story format.\n */\nexport function usePublishing(): UsePublishingProps {\n\t// As little logic as possible should live here--instead it should be in\n\t// util/publish.ts.\n\n\tconst {prefs} = usePrefsContext();\n\tconst {dispatch: storyFormatsDispatch, formats} = useStoryFormatsContext();\n\tconst {stories} = useStoriesContext();\n\n\treturn {\n\t\tpublishArchive: React.useCallback(\n\t\t\tasync () => publishArchive(stories, getAppInfo()),\n\t\t\t[stories]\n\t\t),\n\t\tproofStory: React.useCallback(\n\t\t\tasync storyId => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\t\t\t\tconst format = formatWithNameAndVersion(\n\t\t\t\t\tformats,\n\t\t\t\t\tprefs.proofingFormat.name,\n\t\t\t\t\tprefs.proofingFormat.version\n\t\t\t\t);\n\t\t\t\tconst formatProperties = await loadFormatProperties(format)(\n\t\t\t\t\tstoryFormatsDispatch\n\t\t\t\t);\n\n\t\t\t\tif (!formatProperties) {\n\t\t\t\t\tthrow new Error(`Couldn't load story format properties`);\n\t\t\t\t}\n\n\t\t\t\treturn publishStoryWithFormat(\n\t\t\t\t\tstory,\n\t\t\t\t\tformatProperties.source,\n\t\t\t\t\tgetAppInfo()\n\t\t\t\t);\n\t\t\t},\n\t\t\t[\n\t\t\t\tformats,\n\t\t\t\tprefs.proofingFormat.name,\n\t\t\t\tprefs.proofingFormat.version,\n\t\t\t\tstories,\n\t\t\t\tstoryFormatsDispatch\n\t\t\t]\n\t\t),\n\t\tpublishStory: React.useCallback(\n\t\t\tasync (storyId, publishOptions) => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\t\t\t\tconst format = formatWithNameAndVersion(\n\t\t\t\t\tformats,\n\t\t\t\t\tstory.storyFormat,\n\t\t\t\t\tstory.storyFormatVersion\n\t\t\t\t);\n\t\t\t\tconst formatProperties = await loadFormatProperties(format)(\n\t\t\t\t\tstoryFormatsDispatch\n\t\t\t\t);\n\n\t\t\t\tif (!formatProperties) {\n\t\t\t\t\tthrow new Error(`Couldn't load story format properties`);\n\t\t\t\t}\n\n\t\t\t\treturn publishStoryWithFormat(\n\t\t\t\t\tstory,\n\t\t\t\t\tformatProperties.source,\n\t\t\t\t\tgetAppInfo(),\n\t\t\t\t\tpublishOptions\n\t\t\t\t);\n\t\t\t},\n\t\t\t[formats, stories, storyFormatsDispatch]\n\t\t),\n\t\tpublishStoryData: React.useCallback(\n\t\t\t(storyId: string) => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\n\t\t\t\treturn publishStory(story, getAppInfo(), {startOptional: true});\n\t\t\t},\n\t\t\t[stories]\n\t\t)\n\t};\n}\n","import {usePublishing} from './use-publishing';\nimport {isElectronRenderer} from '../util/is-electron';\nimport {TwineElectronWindow} from '../electron/shared';\n\nexport interface UseStoryLaunchProps {\n\tplayStory: (storyId: string) => Promise<void>;\n\tproofStory: (storyId: string) => Promise<void>;\n\ttestStory: (storyId: string, startPassageId?: string) => Promise<void>;\n}\n\n/**\n * Provides functions to launch a story that include the correct handling for\n * both web and Electron contexts.\n */\nexport function useStoryLaunch(): UseStoryLaunchProps {\n\tconst {proofStory, publishStory} = usePublishing();\n\n\tif (isElectronRenderer()) {\n\t\tconst {twineElectron} = window as TwineElectronWindow;\n\n\t\tif (!twineElectron) {\n\t\t\tthrow new Error('Electron bridge is not present on window.');\n\t\t}\n\n\t\treturn {\n\t\t\tplayStory: async storyId => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait publishStory(storyId),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t},\n\t\t\tproofStory: async storyId => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait proofStory(storyId),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t},\n\t\t\ttestStory: async (storyId, startPassageId) => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait publishStory(storyId, {\n\t\t\t\t\t\tformatOptions: 'debug',\n\t\t\t\t\t\tstartId: startPassageId\n\t\t\t\t\t}),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\t}\n\n\treturn {\n\t\tplayStory: async storyId => {\n\t\t\twindow.open(`#/stories/${storyId}/play`, '_blank');\n\t\t},\n\t\tproofStory: async storyId => {\n\t\t\twindow.open(`#/stories/${storyId}/proof`, '_blank');\n\t\t},\n\t\ttestStory: async (storyId, startPassageId) => {\n\t\t\twindow.open(\n\t\t\t\tstartPassageId\n\t\t\t\t\t? `#/stories/${storyId}/test/${startPassageId}`\n\t\t\t\t\t: `#/stories/${storyId}/test`,\n\t\t\t\t'_blank'\n\t\t\t);\n\t\t}\n\t};\n}\n","import {saveAs} from 'file-saver';\n\n/**\n * Saves text to a file. This works in either a browser or Electron context.\n */\nexport function saveHtml(source: string, filename: string) {\n\tconst data = new Blob([source], {type: 'text/html;charset=utf-8'});\n\n\tsaveAs(data, filename);\n}\n","import {IconCaravan, IconDeviceSpeaker, IconEye, IconFileText, IconPlayerPlay, IconTool} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next/';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {IconButton} from '../components/control/icon-button';\nimport {storyFileName} from '../electron/shared';\nimport {Story} from '../store/stories';\nimport {usePublishing} from '../store/use-publishing';\nimport {useStoryLaunch} from '../store/use-story-launch';\nimport {saveHtml} from '../util/save-html';\nimport {convertToObject, convertToCaravan, extractWords} from '../util/caravan';\n\nexport interface BuildActionsProps {\n\tstory?: Story;\n}\n\n\nconst exportData = (story?:Story) => {\n\t\n\t//console.log(convertToCaravan(story));\n\tconst json = convertToCaravan(story);\n\tconst {name=\"caravan\"} = story || {};\n\t//const jsonobj = (story?.passages || []).map(p=>{\n//\t\treturn convertToObject(p.text);\n//\t})\n//\tconsole.log(jsonobj);\n    const jsonString = `data:text/json;chatset=utf-8,${encodeURIComponent(\n      JSON.stringify(json,null,4)\n    )}`;\n    const link = document.createElement(\"a\");\n    link.href = jsonString;\n    link.download = `${name}.json`;\n    link.click();\n};\n\nexport const BuildActions: React.FC<BuildActionsProps> = ({story}) => {\n\tconst {publishStory} = usePublishing();\n\tconst {playStory, proofStory, testStory} = useStoryLaunch();\n\tconst {t} = useTranslation();\n\n\tasync function handlePublishFile() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to publish');\n\t\t}\n\n\t\tsaveHtml(await publishStory(story.id), storyFileName(story));\n\t}\n\n\tasync function handleRender(){\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to render');\n\t\t}\n\t\tconst passagetexts = story.passages.map(p=>{\n\t\t\treturn p.text;\n\t\t})\n\t\t\n\t\tconst speech = extractWords(passagetexts);\n\t\tconsole.log(speech);\n\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t{/*<IconButton\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconTool />}\n\t\t\t\tlabel={t('routeActions.build.test')}\n\t\t\t\tonClick={story ? () => testStory(story.id) : () => {}}\n\t\t\t/>*/}\n\t\t\t{/*<IconButton\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconPlayerPlay />}\n\t\t\t\tlabel={t('routeActions.build.play')}\n\t\t\t\tonClick={story ? () => playStory(story.id) : () => {}}\n\t\t\t/>*/}\n\t\t\t<IconButton\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconEye />}\n\t\t\t\tlabel={t('routeActions.build.proof')}\n\t\t\t\tonClick={story ? () => proofStory(story?.id) : () => {}}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconFileText />}\n\t\t\t\tlabel={t('routeActions.build.publishToFile')}\n\t\t\t\tonClick={handlePublishFile}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconCaravan />}\n\t\t\t\tlabel={'Download for Caravan'}\n\t\t\t\tonClick={()=>exportData(story)}\n\t\t\t/>\n\t\t</ButtonBar>\n\t);\n};\n","import {IconAward, IconBug, IconFileCode, IconSettings} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {IconButton} from '../components/control/icon-button';\nimport {AboutTwineDialog, AppPrefsDialog, useDialogsContext} from '../dialogs';\n\nexport const AppActions: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconSettings />}\n\t\t\t\tlabel={t('routeActions.app.preferences')}\n\t\t\t\tonClick={() => dispatch({type: 'addDialog', component: AppPrefsDialog})}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={history.location.pathname === '/story-formats'}\n\t\t\t\ticon={<IconFileCode />}\n\t\t\t\tlabel={t('routeActions.app.storyFormats')}\n\t\t\t\tonClick={() => history.push('/story-formats')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconAward />}\n\t\t\t\tlabel={t('routeActions.app.aboutApp')}\n\t\t\t\tonClick={() =>\n\t\t\t\t\tdispatch({type: 'addDialog', component: AboutTwineDialog})\n\t\t\t\t}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconBug />}\n\t\t\t\tlabel={t('routeActions.app.reportBug')}\n\t\t\t\tonClick={() => window.open('https://twinery.org/2bugs', '_blank')}\n\t\t\t/>\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPlus} from '@tabler/icons';\nimport {\n\tcreateFromProperties,\n\tuseStoryFormatsContext\n} from '../../../../store/story-formats';\nimport {\n\tPromptButton,\n\tPromptButtonValidator\n} from '../../../../components/control/prompt-button';\nimport {fetchStoryFormatProperties} from '../../../../util/story-format';\nimport './add-story-format-button.css';\n\nfunction isValidUrl(value: string) {\n\ttry {\n\t\tnew URL(value);\n\t\treturn true;\n\t} catch (e) {}\n\n\treturn false;\n}\n\nexport const AddStoryFormatButton: React.FC = () => {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst [newFormatUrl, setNewFormatUrl] = React.useState('');\n\tconst {t} = useTranslation();\n\n\tasync function handleSubmit() {\n\t\tdispatch(\n\t\t\tcreateFromProperties(\n\t\t\t\tnewFormatUrl,\n\t\t\t\tawait fetchStoryFormatProperties(newFormatUrl)\n\t\t\t)\n\t\t);\n\t}\n\n\tconst validate: PromptButtonValidator = async (value: string) => {\n\t\tif (newFormatUrl.trim() === '') {\n\t\t\treturn {valid: false};\n\t\t}\n\n\t\tif (!isValidUrl(newFormatUrl)) {\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.invalidUrl'\n\t\t\t\t),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\ttry {\n\t\t\tconst properties = await fetchStoryFormatProperties(newFormatUrl);\n\n\t\t\tif (\n\t\t\t\tformats.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.name === properties.name &&\n\t\t\t\t\t\tformat.version === properties.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn {\n\t\t\t\t\tmessage: t(\n\t\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.alreadyAdded',\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstoryFormatName: properties.name,\n\t\t\t\t\t\t\tstoryFormatVersion: properties.version\n\t\t\t\t\t\t}\n\t\t\t\t\t),\n\t\t\t\t\tvalid: false\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.addPreview',\n\t\t\t\t\t{\n\t\t\t\t\t\tstoryFormatName: properties.name,\n\t\t\t\t\t\tstoryFormatVersion: properties.version\n\t\t\t\t\t}\n\t\t\t\t),\n\t\t\t\tvalid: true\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.fetchError',\n\t\t\t\t\t{\n\t\t\t\t\t\terrorMessage: error.message\n\t\t\t\t\t}\n\t\t\t\t),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\t};\n\n\treturn (\n\t\t<span className=\"add-format-button\">\n\t\t\t<PromptButton\n\t\t\t\ticon={<IconPlus />}\n\t\t\t\tlabel={t('common.add')}\n\t\t\t\tonChange={event => setNewFormatUrl(event.target.value)}\n\t\t\t\tonSubmit={handleSubmit}\n\t\t\t\tprompt={t('routes.storyFormatList.toolbar.addStoryFormatButton.prompt')}\n\t\t\t\tsubmitIcon={<IconPlus />}\n\t\t\t\tsubmitLabel={t('common.add')}\n\t\t\t\tsubmitVariant=\"create\"\n\t\t\t\tvalidate={validate}\n\t\t\t\tvalue={newFormatUrl}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","import {IconStar} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface DefaultStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const DefaultStoryFormatButton: React.FC<DefaultStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst disabled =\n\t\tformat?.loadState !== 'loaded' ||\n\t\tformat.properties.proofing ||\n\t\t(prefs.storyFormat.name === format.name &&\n\t\t\tprefs.storyFormat.version === format.version);\n\tconst handleClick: React.MouseEventHandler = () => {\n\t\tif (!format) {\n\t\t\tthrow new Error(\"Can't set undefined format as default\");\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tname: 'storyFormat',\n\t\t\tvalue: {name: format.name, version: format.version}\n\t\t});\n\t};\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={disabled}\n\t\t\ticon={<IconStar />}\n\t\t\tlabel={t('routes.storyFormatList.toolbar.useAsDefaultFormat')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEye} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface ProofingStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const ProofingStoryFormatButton: React.FC<ProofingStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst disabled =\n\t\tformat?.loadState !== 'loaded' ||\n\t\t!format.properties.proofing ||\n\t\t(prefs.proofingFormat.name === format.name &&\n\t\t\tprefs.proofingFormat.version === format.version);\n\tconst handleClick: React.MouseEventHandler = () => {\n\t\tif (!format) {\n\t\t\tthrow new Error(\"Can't set undefined format as proofing\");\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tname: 'proofingFormat',\n\t\t\tvalue: {name: format.name, version: format.version}\n\t\t});\n\t};\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={disabled}\n\t\t\ticon={<IconEye />}\n\t\t\tlabel={t('routes.storyFormatList.toolbar.useAsProofingFormat')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {\n\tdeleteFormat,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from '../../../../store/story-formats';\n\nexport interface RemoveStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const RemoveStoryFormatButton: React.FC<RemoveStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch} = useStoryFormatsContext();\n\tconst {prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst isDefault =\n\t\tformat?.name === prefs.storyFormat.name &&\n\t\tformat?.version === prefs.storyFormat.version;\n\tconst isProofing =\n\t\tformat?.name === prefs.proofingFormat.name &&\n\t\tformat?.version === prefs.proofingFormat.version;\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!format || !format.userAdded || isDefault || isProofing}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={t('common.remove')}\n\t\t\tonClick={() => format && dispatch(deleteFormat(format))}\n\t\t/>\n\t);\n};\n","import {IconPuzzle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface StoryFormatExtensionsButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const StoryFormatExtensionsButton: React.FC<StoryFormatExtensionsButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst extensionsDisabled = prefs.disabledStoryFormatEditorExtensions.some(\n\t\tother => other.name === format?.name && other.version === format?.version\n\t);\n\n\tfunction handleClick() {\n\t\tif (!format) {\n\t\t\tthrow new Error('Format is not set');\n\t\t}\n\n\t\t// This logic is a little backwards--the user is setting whether to use the\n\t\t// extensions but our preferences track disabled ones.\n\n\t\tif (extensionsDisabled) {\n\t\t\tdispatch(\n\t\t\t\tsetPref(\n\t\t\t\t\t'disabledStoryFormatEditorExtensions',\n\t\t\t\t\tprefs.disabledStoryFormatEditorExtensions.filter(\n\t\t\t\t\t\tf => f.name !== format.name || f.version !== format.version\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t);\n\t\t} else {\n\t\t\tdispatch(\n\t\t\t\tsetPref('disabledStoryFormatEditorExtensions', [\n\t\t\t\t\t...prefs.disabledStoryFormatEditorExtensions,\n\t\t\t\t\t{name: format.name, version: format.version}\n\t\t\t\t])\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!format}\n\t\t\ticon={<IconPuzzle />}\n\t\t\tlabel={t(\n\t\t\t\t`routes.storyFormatList.toolbar.${\n\t\t\t\t\textensionsDisabled ? 'enable' : 'disable'\n\t\t\t\t}FormatExtensions`\n\t\t\t)}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {StoryFormat} from '../../../../store/story-formats';\nimport {AddStoryFormatButton} from './add-story-format-button';\nimport {DefaultStoryFormatButton} from './default-story-format-button';\nimport {ProofingStoryFormatButton} from './proofing-story-format-button';\nimport {RemoveStoryFormatButton} from './remove-story-format-button';\nimport {StoryFormatExtensionsButton} from './story-format-extensions-button';\n\nexport interface FormatActionsProps {\n\tselectedFormats: StoryFormat[];\n}\n\nexport const FormatActions: React.FC<FormatActionsProps> = props => {\n\tconst {selectedFormats} = props;\n\tconst format = selectedFormats.length === 1 ? selectedFormats[0] : undefined;\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<AddStoryFormatButton />\n\t\t\t<RemoveStoryFormatButton format={format} />\n\t\t\t<StoryFormatExtensionsButton format={format} />\n\t\t\t<DefaultStoryFormatButton format={format} />\n\t\t\t<ProofingStoryFormatButton format={format} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../../components/control/checkbox-button';\nimport {setPref, usePrefsContext} from '../../../store/prefs';\n\nexport const ViewActions: React.FC = () => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tfunction setFilter(name: string) {\n\t\tdispatch(setPref('storyFormatListFilter', name));\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'current'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.current')}\n\t\t\t\tonChange={() => setFilter('current')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'current'}\n\t\t\t/>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'user'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.user')}\n\t\t\t\tonChange={() => setFilter('user')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'user'}\n\t\t\t/>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'all'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.all')}\n\t\t\t\tonChange={() => setFilter('all')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'all'}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {AppActions} from '../../../route-actions';\nimport {StoryFormat} from '../../../store/story-formats';\nimport {FormatActions} from './formats/format-actions';\nimport {ViewActions} from './view-actions';\n\nexport interface StoryFormatListToolbarProps {\n\tselectedFormats: StoryFormat[];\n}\n\nexport const StoryFormatListToolbar: React.FC<StoryFormatListToolbarProps> = props => {\n\tconst {selectedFormats} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\ttabs={{\n\t\t\t\t[t('common.storyFormat')]: (\n\t\t\t\t\t<FormatActions selectedFormats={selectedFormats} />\n\t\t\t\t),\n\t\t\t\t[t('common.view')]: <ViewActions />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ClickAwayListener} from '../../components/click-away-listener';\nimport {CardGroup} from '../../components/container/card-group';\nimport {MainContent} from '../../components/container/main-content';\nimport {StoryFormatCard} from '../../components/story-format/story-format-card/story-format-card';\nimport {DialogsContextProvider} from '../../dialogs';\nimport {FormatLoader} from '../../store/format-loader';\nimport {usePrefsContext} from '../../store/prefs';\nimport {\n\tdeselectAllFormats,\n\tdeselectFormat,\n\tfilteredFormats,\n\tselectFormat,\n\tsortFormats,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {StoryFormatListToolbar} from './toolbar';\n\nexport const StoryFormatListRoute: React.FC = () => {\n\tconst {dispatch: formatsDispatch, formats} = useStoryFormatsContext();\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst selectedFormats = formats.filter(format => format.selected);\n\n\tconst visibleFormats = sortFormats(\n\t\tfilteredFormats(formats, prefs.storyFormatListFilter)\n\t);\n\n\t// Any formats no longer visible should be deselected.\n\n\tReact.useEffect(() => {\n\t\tfor (const format of selectedFormats) {\n\t\t\tif (format.selected && !visibleFormats.includes(format)) {\n\t\t\t\tformatsDispatch(deselectFormat(format));\n\t\t\t}\n\t\t}\n\t}, [prefsDispatch, selectedFormats, visibleFormats, formatsDispatch]);\n\n\tfunction handleSelect(format: StoryFormat) {\n\t\tformatsDispatch(selectFormat(format, true));\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-list-route\">\n\t\t\t<DialogsContextProvider>\n\t\t\t\t<StoryFormatListToolbar selectedFormats={selectedFormats} />\n\t\t\t\t<ClickAwayListener\n\t\t\t\t\tignoreSelector=\".story-format-card\"\n\t\t\t\t\tonClickAway={() => formatsDispatch(deselectAllFormats())}\n\t\t\t\t>\n\t\t\t\t\t<MainContent\n\t\t\t\t\t\ttitle={t(\n\t\t\t\t\t\t\t`routes.storyFormatList.title.${prefs.storyFormatListFilter}`\n\t\t\t\t\t\t)}\n\t\t\t\t\t>\n\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t{t(\n\t\t\t\t\t\t\t\tvisibleFormats.length > 0\n\t\t\t\t\t\t\t\t\t? 'routes.storyFormatList.storyFormatExplanation'\n\t\t\t\t\t\t\t\t\t: 'routes.storyFormatList.noneVisible'\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<FormatLoader>\n\t\t\t\t\t\t\t<CardGroup columnWidth=\"450px\">\n\t\t\t\t\t\t\t\t{visibleFormats.map(format => (\n\t\t\t\t\t\t\t\t\t<StoryFormatCard\n\t\t\t\t\t\t\t\t\t\tdefaultFormat={\n\t\t\t\t\t\t\t\t\t\t\tformat.name === prefs.storyFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\tformat.version === prefs.storyFormat.version\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\teditorExtensionsDisabled={prefs.disabledStoryFormatEditorExtensions.some(\n\t\t\t\t\t\t\t\t\t\t\tdisabledFormat =>\n\t\t\t\t\t\t\t\t\t\t\t\tformat.name === disabledFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\t\tformat.version === disabledFormat.version\n\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\tformat={format}\n\t\t\t\t\t\t\t\t\t\tkey={format.id}\n\t\t\t\t\t\t\t\t\t\tonSelect={() => handleSelect(format)}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</CardGroup>\n\t\t\t\t\t\t</FormatLoader>\n\t\t\t\t\t</MainContent>\n\t\t\t\t</ClickAwayListener>\n\t\t\t</DialogsContextProvider>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {deviceType} from 'detect-it';\nimport 'element-closest';\nimport {rectFromPoints, Point, Rect} from '../../util/geometry';\nimport './marquee-selection.css';\n\nfunction relativeEventPosition(\n\tevent: MouseEvent,\n\tcontainer: HTMLElement\n): Point {\n\tconst containerRect = container.getBoundingClientRect();\n\n\treturn {\n\t\tleft: event.clientX - containerRect.left + container.scrollLeft,\n\t\ttop: event.clientY - containerRect.top + container.scrollTop\n\t};\n}\n\ntype MarqueeState =\n\t| {selecting: false}\n\t| {selecting: true; exclusive: boolean; start: Point; current: Point};\n\ntype MarqueeAction =\n\t| {\n\t\t\ttype: 'startSelection';\n\t\t\tstart: Point;\n\t\t\texclusive: boolean;\n\t  }\n\t| {\n\t\t\ttype: 'changeSelection';\n\t\t\tcurrent: Point;\n\t  }\n\t| {type: 'endSelection'};\n\nfunction marqueeReducer(\n\tstate: MarqueeState,\n\taction: MarqueeAction\n): MarqueeState {\n\t// The side effect with onSelectRect is not best practice, but it avoids\n\t// having to add a useEffect() in the component.\n\n\tswitch (action.type) {\n\t\tcase 'startSelection':\n\t\t\treturn {\n\t\t\t\tselecting: true,\n\t\t\t\texclusive: action.exclusive,\n\t\t\t\tstart: action.start,\n\t\t\t\tcurrent: action.start\n\t\t\t};\n\n\t\tcase 'changeSelection':\n\t\t\tif (!state.selecting) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t'Marquee reducer received a changeSelection action, but it is not currently selecting; ignoring'\n\t\t\t\t);\n\t\t\t\treturn state;\n\t\t\t}\n\t\t\treturn {...state, current: action.current};\n\n\t\tcase 'endSelection':\n\t\t\treturn {selecting: false};\n\t}\n}\n\nexport interface MarqueeSelectionProps {\n\t/**\n\t * Container DOM element to attach events to.\n\t */\n\tcontainer: React.RefObject<HTMLElement>;\n\t/**\n\t * Ignores click events on any element matching this selector. This is so that\n\t * drags beginning on a passage card can be ignored.\n\t */\n\tignoreEventsOnSelector?: string;\n\t/**\n\t * Callback for when selection occurs.\n\t */\n\tonSelectRect: (rect: Rect, additive: boolean) => void;\n}\n\nexport const MarqueeSelection: React.FC<MarqueeSelectionProps> = props => {\n\tconst {container, ignoreEventsOnSelector, onSelectRect} = props;\n\tconst [state, dispatch] = React.useReducer(marqueeReducer, {\n\t\tselecting: false\n\t});\n\n\t// Listener for the beginning of a selection.\n\n\tReact.useEffect(() => {\n\t\t// This component only works in mouse-enabled environments. It would otherwise\n\t\t// block the ability to scroll with a touch.\n\n\t\tif (deviceType === 'touchOnly') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (container.current) {\n\t\t\tconst currentContainer = container.current;\n\t\t\tconst handleMouseDown = (event: MouseEvent) => {\n\t\t\t\tif (ignoreEventsOnSelector) {\n\t\t\t\t\tif ((event.target as HTMLElement)?.closest(ignoreEventsOnSelector)) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst exclusive = !event.shiftKey && !event.ctrlKey;\n\t\t\t\tconst start = relativeEventPosition(event, currentContainer);\n\n\t\t\t\tdispatch({type: 'startSelection', exclusive, start});\n\t\t\t\tonSelectRect({...start, height: 0, width: 0}, exclusive);\n\t\t\t};\n\n\t\t\tcurrentContainer.addEventListener('mousedown', handleMouseDown);\n\n\t\t\treturn () =>\n\t\t\t\tcurrentContainer.removeEventListener('mousedown', handleMouseDown);\n\t\t}\n\t}, [container, ignoreEventsOnSelector, onSelectRect]);\n\n\t// Listeners while the selection is taking place.\n\n\tReact.useEffect(() => {\n\t\tif (state.selecting && container.current) {\n\t\t\tconst currentContainer = container.current;\n\t\t\tconst handleMouseMove = (event: MouseEvent) => {\n\t\t\t\tconst current = relativeEventPosition(event, currentContainer);\n\n\t\t\t\tdispatch({type: 'changeSelection', current});\n\t\t\t\tonSelectRect(rectFromPoints(state.start, current), state.exclusive);\n\t\t\t};\n\t\t\tconst handleMouseUp = () => {\n\t\t\t\tdispatch({type: 'endSelection'});\n\t\t\t\tcleanUp();\n\t\t\t};\n\t\t\tconst cleanUp = () => {\n\t\t\t\twindow.removeEventListener('mousemove', handleMouseMove);\n\t\t\t\twindow.removeEventListener('mouseup', handleMouseUp);\n\t\t\t\tdocument.body.classList.remove('marquee-selecting');\n\t\t\t};\n\n\t\t\twindow.addEventListener('mousemove', handleMouseMove);\n\t\t\twindow.addEventListener('mouseup', handleMouseUp);\n\t\t\tdocument.body.classList.add('marquee-selecting');\n\t\t\treturn cleanUp;\n\t\t}\n\t}, [container, onSelectRect, state]);\n\n\tif (!state.selecting || deviceType === 'touchOnly') {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<div\n\t\t\tclassName=\"marquee-selection\"\n\t\t\tstyle={rectFromPoints(state.start, state.current)}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport './broken-connection.css';\n\nexport interface BrokenConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n}\n\n// Making this equal in length to <StartConnector>.\nconst lineOffset = 25 * Math.sqrt(2);\n\nexport const BrokenConnection: React.FC<BrokenConnectionProps> = props => {\n\tconst {offset, passage} = props;\n\tconst start: Point = {left: passage.left, top: passage.top};\n\n\tif (passage.selected) {\n\t\tstart.left += offset.left;\n\t\tstart.top += offset.top;\n\t}\n\n\treturn (\n\t\t<line\n\t\t\tclassName=\"broken-connection\"\n\t\t\tx1={start.left + passage.width}\n\t\t\ty1={start.top + passage.height}\n\t\t\tx2={start.left + passage.width + lineOffset}\n\t\t\ty2={start.top + passage.height + lineOffset}\n\t\t\tstyle={{markerEnd: 'url(#link-broken)'}}\n\t\t/>\n\t);\n};\n","import {Point} from './geometry';\n\nexport interface ArcProps {\n\tend: Point;\n\tlargeArc?: boolean;\n\tradius: Point;\n\trotation?: number;\n\tstart: Point;\n\tsweep?: boolean;\n}\n\n/**\n * Returns an SVG path string between two points.\n * @see https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths#arcs\n */\nexport function arc({start, end, radius, largeArc, sweep, rotation}: ArcProps) {\n\treturn (\n\t\t'M' +\n\t\tstart.left +\n\t\t',' +\n\t\tstart.top +\n\t\t' A' +\n\t\tradius.left +\n\t\t',' +\n\t\tradius.top +\n\t\t' ' +\n\t\t(rotation ?? '0') +\n\t\t(largeArc ? ' 1' : ' 0') +\n\t\t(sweep ? ' 1 ' : ' 0 ') +\n\t\tend.left +\n\t\t',' +\n\t\tend.top\n\t);\n}\n","import * as React from 'react';\nimport {arc} from '../../../util/svg';\nimport {\n\tlineAngle,\n\tlineDistance,\n\trectCenter,\n\trectIntersectionWithLine,\n\tPoint\n} from '../../../util/geometry';\nimport {Passage} from '../../../store/stories';\nimport './passage-connection.css';\n\nexport interface PassageConnectionProps {\n\tend: Passage;\n\toffset: Point;\n\tstart: Passage;\n\tvariant: 'link' | 'reference';\n}\n\nexport const PassageConnection: React.FC<PassageConnectionProps> = props => {\n\tconst {end, offset, start, variant} = props;\n\tconst path = React.useMemo(() => {\n\t\t// If either passage is selected, offset it. We need to take care not to\n\t\t// overwrite the passage information.\n\n\t\tlet offsetStart = start;\n\t\tlet offsetEnd = end;\n\n\t\tif (start.selected) {\n\t\t\toffsetStart = {\n\t\t\t\t...start,\n\t\t\t\tleft: start.left + offset.left,\n\t\t\t\ttop: start.top + offset.top\n\t\t\t};\n\t\t}\n\n\t\tif (end.selected) {\n\t\t\toffsetEnd = {\n\t\t\t\t...end,\n\t\t\t\tleft: end.left + offset.left,\n\t\t\t\ttop: end.top + offset.top\n\t\t\t};\n\t\t}\n\n\t\t// Start at the center of both passages.\n\n\t\tlet startPoint: Point | null = rectCenter(offsetStart);\n\t\tlet endPoint: Point | null = rectCenter(offsetEnd);\n\n\t\t// Move both points to where they intersect with the edges of their passages.\n\n\t\tstartPoint = rectIntersectionWithLine(offsetStart, startPoint, endPoint);\n\n\t\tif (!startPoint) {\n\t\t\treturn '';\n\t\t}\n\n\t\tendPoint = rectIntersectionWithLine(offsetEnd, startPoint, endPoint);\n\n\t\tif (!endPoint) {\n\t\t\treturn '';\n\t\t}\n\n\t\t// Draw a flattened arc, to make it easier to distinguish between links\n\t\t// between passages with the same horizontal or vertical position (which\n\t\t// would otherwise be overlapping flat lines).\n\t\t//\n\t\t// The horizontal radius of our arc is proportional to the distance\n\t\t// the line will travel.\n\n\t\tconst distance = lineDistance(startPoint, endPoint);\n\n\t\t// Rotate the arc so that its underside will always face downward. We cheat\n\t\t// vertical lines so that their undersides face right--an aesthetic choice,\n\t\t// and so that bidirectional links line up.\n\n\t\tlet sweep = startPoint.left < endPoint.left;\n\n\t\tif (startPoint.left === endPoint.left && startPoint.top < endPoint.top) {\n\t\t\tsweep = true;\n\t\t}\n\n\t\tconst angle = lineAngle(startPoint, endPoint);\n\n\t\t// The Y radius is another aesthetic choice. The lower the ratio, the less\n\t\t// curved the lines become.\n\n\t\treturn arc({\n\t\t\tstart: startPoint,\n\t\t\tend: endPoint,\n\t\t\tradius: {left: distance, top: distance * 0.75},\n\t\t\trotation: angle,\n\t\t\tsweep\n\t\t});\n\t}, [end, offset.left, offset.top, start]);\n\n\treturn (\n\t\t<path\n\t\t\td={path}\n\t\t\tclassName={`passage-connection variant-${variant}`}\n\t\t\tstyle={{markerEnd: 'url(#link-arrowhead)'}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {arc} from '../../../util/svg';\nimport './self-connection.css';\n\nexport interface SelfConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n\tvariant: 'link' | 'reference';\n}\n\nexport const SelfConnection: React.FC<SelfConnectionProps> = props => {\n\tconst {offset, passage, variant} = props;\n\tconst start: Point = {left: passage.left, top: passage.top};\n\n\tif (passage.selected) {\n\t\tstart.left += offset.left;\n\t\tstart.top += offset.top;\n\t}\n\n\tconst radius = React.useMemo(\n\t\t() => 0.4 * Math.min(passage.width, passage.height),\n\t\t[passage.height, passage.width]\n\t);\n\n\tconst path = React.useMemo(\n\t\t() =>\n\t\t\tarc({\n\t\t\t\tstart: {\n\t\t\t\t\tleft: start.left,\n\t\t\t\t\ttop: start.top + passage.height / 2\n\t\t\t\t},\n\t\t\t\tend: {\n\t\t\t\t\tleft: start.left,\n\t\t\t\t\ttop: start.top\n\t\t\t\t},\n\t\t\t\tradius: {\n\t\t\t\t\tleft: radius,\n\t\t\t\t\ttop: radius\n\t\t\t\t},\n\t\t\t\tsweep: true,\n\t\t\t\tlargeArc: true\n\t\t\t}),\n\t\t[passage.height, radius, start.left, start.top]\n\t);\n\n\treturn (\n\t\t<path\n\t\t\tclassName={`self-connection variant-${variant}`}\n\t\t\td={path}\n\t\t\tstyle={{markerEnd: 'url(#link-arrowhead)'}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {BrokenConnection} from './broken-connection';\nimport {PassageConnection} from './passage-connection';\nimport {SelfConnection} from './self-connection';\nimport {Point} from '../../../util/geometry';\n\nexport interface PassageConnectionGroupProps {\n\tbroken: Set<Passage>;\n\tconnections: Map<Passage, Set<Passage>>;\n\toffset: Point;\n\tself: Set<Passage>;\n\tvariant?: 'link' | 'reference';\n}\n\nexport const PassageConnectionGroup: React.FC<PassageConnectionGroupProps> = React.memo(\n\tprops => {\n\t\tconst {broken, connections, offset, self, variant = 'link'} = props;\n\n\t\treturn (\n\t\t\t<>\n\t\t\t\t{Array.from(connections).map(connection =>\n\t\t\t\t\tArray.from(connection[1]).map(end => (\n\t\t\t\t\t\t<PassageConnection\n\t\t\t\t\t\t\tend={end}\n\t\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\t\tkey={connection[0].name + end.name}\n\t\t\t\t\t\t\tstart={connection[0]}\n\t\t\t\t\t\t\tvariant={variant}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t)}\n\t\t\t\t{Array.from(self).map(passage => (\n\t\t\t\t\t<SelfConnection\n\t\t\t\t\t\tkey={passage.name}\n\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\tpassage={passage}\n\t\t\t\t\t\tvariant={variant}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t\t{Array.from(broken).map(passage => (\n\t\t\t\t\t<BrokenConnection\n\t\t\t\t\t\tkey={passage.name}\n\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\tpassage={passage}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</>\n\t\t);\n\t}\n);\n","import * as React from 'react';\nimport './link-markers.css';\n\n/**\n * Arrowheads used on connectors. Arrowheads must be applied by an inline style.\n * There seems to be disagreement on the proper way to implement this, but it\n * does not work in an external stylesheet in Firefox.\n * @see https://developer.mozilla.org/en-US/docs/Web/SVG/Element/marker\n */\nexport const LinkMarkers: React.FC = () => (\n\t<defs>\n\t\t<marker\n\t\t\tid=\"link-arrowhead\"\n\t\t\trefX=\"6\"\n\t\t\trefY=\"4\"\n\t\t\tmarkerWidth=\"8\"\n\t\t\tmarkerHeight=\"8\"\n\t\t\torient=\"auto\"\n\t\t>\n\t\t\t<path d=\"M 1,1 7,4 1,7 Z\" />\n\t\t</marker>\n\t\t<marker\n\t\t\tid=\"link-broken\"\n\t\t\trefX=\"7.5\"\n\t\t\trefY=\"7.5\"\n\t\t\tmarkerWidth=\"15\"\n\t\t\tmarkerHeight=\"15\"\n\t\t>\n\t\t\t<circle cx=\"7.5\" cy=\"7.5\" r=\"7.5\" />\n\t\t\t<path d=\"M4.5 7.5h 6z\" />\n\t\t</marker>\n\t\t<marker\n\t\t\tid=\"link-start\"\n\t\t\tmarkerWidth=\"15\"\n\t\t\tmarkerHeight=\"15\"\n\t\t\trefX=\"16\"\n\t\t\trefY=\"16\"\n\t\t\tviewBox=\"0 0 32 32\"\n\t\t>\n\t\t\t<circle cx=\"16\" cy=\"16\" r=\"16\" />\n\t\t\t<path d=\"M8 17a8 8 0 0 1 7 7a6 6 0 0 0 3 -5a9 9 0 0 0 6 -8a3 3 0 0 0 -3 -3a9 9 0 0 0 -8 6a6 6 0 0 0 -5 3\" />\n\t\t\t<path d=\"M11 18a6 6 0 0 0 -3 6a6 6 0 0 0 6 -3\" />\n\t\t\t<circle className=\"fill-white\" cx=\"19\" cy=\"13\" r=\"1\" />\n\t\t</marker>\n\t</defs>\n);\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport './start-connection.css';\n\nexport interface StartConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n}\n\nexport const StartConnection: React.FC<StartConnectionProps> = React.memo(\n\tprops => {\n\t\tconst {offset, passage} = props;\n\t\tconst start: Point = {left: passage.left, top: passage.top};\n\n\t\tif (passage.selected) {\n\t\t\tstart.left += offset.left;\n\t\t\tstart.top += offset.top;\n\t\t}\n\n\t\treturn (\n\t\t\t<line\n\t\t\t\tclassName=\"start-connection\"\n\t\t\t\tx1={start.left - 50}\n\t\t\t\ty1={start.top + passage.height / 2}\n\t\t\t\tx2={start.left}\n\t\t\t\ty2={start.top + passage.height / 2}\n\t\t\t\tstyle={{markerStart: 'url(#link-start)'}}\n\t\t\t/>\n\t\t);\n\t}\n);\n","import * as React from 'react';\nimport {version as twineVersion} from '../../package.json';\nimport {formatEditorExtensions} from '../util/story-format';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\n\nconst emptyFunc = () => [];\n\nexport function useFormatReferenceParser(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {prefs} = usePrefsContext();\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst [editorExtensions, setEditorExtensions] = React.useState<\n\t\tReturnType<typeof formatEditorExtensions>\n\t>();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (format.loadState === 'loaded') {\n\t\t\tsetEditorExtensions(formatEditorExtensions(format, twineVersion));\n\t\t}\n\t}, [dispatch, extensionsDisabled, format]);\n\n\tif (extensionsDisabled) {\n\t\treturn emptyFunc;\n\t}\n\n\treturn editorExtensions?.references?.parsePassageText ?? emptyFunc;\n}\n","import * as React from 'react';\nimport {Passage, passageConnections} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {PassageConnectionGroup} from './passage-connection-group';\nimport {LinkMarkers} from './link-markers';\nimport {StartConnection} from './start-connection';\nimport {useFormatReferenceParser} from '../../../store/use-format-reference-parser';\n\nexport interface PassageConnectionsProps {\n\tformatName: string;\n\tformatVersion: string;\n\toffset: Point;\n\tpassages: Passage[];\n\tstartPassageId: string;\n}\n\nconst emptySet = new Set<Passage>();\nconst noOffset: Point = {left: 0, top: 0};\n\nexport const PassageConnections: React.FC<PassageConnectionsProps> = props => {\n\tconst {formatName, formatVersion, offset, passages, startPassageId} = props;\n\tconst referenceParser = useFormatReferenceParser(formatName, formatVersion);\n\tconst {draggable: draggableLinks, fixed: fixedLinks} = React.useMemo(\n\t\t() => passageConnections(passages),\n\t\t[passages]\n\t);\n\tconst {\n\t\tdraggable: draggableReferences,\n\t\tfixed: fixedReferences\n\t} = React.useMemo(() => passageConnections(passages, referenceParser), [\n\t\tpassages,\n\t\treferenceParser\n\t]);\n\n\tconst startPassage = React.useMemo(\n\t\t() => passages.find(passage => passage.id === startPassageId),\n\t\t[passages, startPassageId]\n\t);\n\n\t// References only show existing connections.\n\n\treturn (\n\t\t<svg className=\"link-connectors\">\n\t\t\t<LinkMarkers />\n\t\t\t{startPassage && (\n\t\t\t\t<StartConnection offset={offset} passage={startPassage} />\n\t\t\t)}\n\t\t\t<PassageConnectionGroup {...draggableLinks} offset={offset} />\n\t\t\t<PassageConnectionGroup {...fixedLinks} offset={noOffset} />\n\t\t\t<PassageConnectionGroup\n\t\t\t\tbroken={emptySet}\n\t\t\t\tconnections={draggableReferences.connections}\n\t\t\t\toffset={offset}\n\t\t\t\tself={emptySet}\n\t\t\t\tvariant=\"reference\"\n\t\t\t/>\n\t\t\t<PassageConnectionGroup\n\t\t\t\tbroken={emptySet}\n\t\t\t\tconnections={fixedReferences.connections}\n\t\t\t\toffset={noOffset}\n\t\t\t\tself={emptySet}\n\t\t\t\tvariant=\"reference\"\n\t\t\t/>\n\t\t</svg>\n\t);\n};\n","import * as React from 'react';\nimport {DraggableCore, DraggableCoreProps} from 'react-draggable';\nimport classNames from 'classnames';\nimport {Card, CardContent} from '../container/card';\nimport {Passage, TagColors} from '../../store/stories';\nimport {TagStripe} from '../tag/tag-stripe';\nimport './passage-card.css';\n\nexport interface PassageCardProps {\n\tonEdit: (passage: Passage) => void;\n\tonDeselect: (passage: Passage) => void;\n\tonDragStart?: DraggableCoreProps['onStart'];\n\tonDrag?: DraggableCoreProps['onDrag'];\n\tonDragStop?: DraggableCoreProps['onStop'];\n\tonSelect: (passage: Passage, exclusive: boolean) => void;\n\tpassage: Passage;\n\ttagColors: TagColors;\n\tzoom: number;\n}\n\n// Needs to fill a large-sized passage card.\nconst excerptLength = 400;\n\nexport const PassageCard: React.FC<PassageCardProps> = React.memo(props => {\n\tconst {\n\t\tonDeselect,\n\t\tonDrag,\n\t\tonDragStart,\n\t\tonDragStop,\n\t\tonEdit,\n\t\tonSelect,\n\t\tpassage,\n\t\ttagColors\n\t} = props;\n\tconst className = React.useMemo(\n\t\t() => classNames('passage-card', {selected: passage.selected}),\n\t\t[passage.selected]\n\t);\n\tconst container = React.useRef<HTMLDivElement>(null);\n\tconst excerpt = React.useMemo(() => passage.text.substr(0, excerptLength), [\n\t\tpassage.text\n\t]);\n\tconst style = React.useMemo(\n\t\t() => ({\n\t\t\theight: passage.height,\n\t\t\tleft: passage.left,\n\t\t\ttop: passage.top,\n\t\t\twidth: passage.width\n\t\t}),\n\t\t[passage.height, passage.left, passage.top, passage.width]\n\t);\n\tconst handleMouseDown = React.useCallback(\n\t\t(event: MouseEvent) => {\n\t\t\t// Shift- or control-clicking toggles our selected status, but doesn't\n\t\t\t// affect any other passage's selected status. If the shift or control key\n\t\t\t// was not held down and we were not already selected, we know the user\n\t\t\t// wants to select only this passage.\n\n\t\t\tif (event.shiftKey || event.ctrlKey) {\n\t\t\t\tif (passage.selected) {\n\t\t\t\t\tonDeselect(passage);\n\t\t\t\t} else {\n\t\t\t\t\tonSelect(passage, false);\n\t\t\t\t}\n\t\t\t} else if (!passage.selected) {\n\t\t\t\tonSelect(passage, true);\n\t\t\t}\n\t\t},\n\t\t[onDeselect, onSelect, passage]\n\t);\n\tconst handleEdit = React.useCallback(() => onEdit(passage), [\n\t\tonEdit,\n\t\tpassage\n\t]);\n\n\treturn (\n\t\t<DraggableCore\n\t\t\tnodeRef={container}\n\t\t\tonMouseDown={handleMouseDown}\n\t\t\tonStart={onDragStart}\n\t\t\tonDrag={onDrag}\n\t\t\tonStop={onDragStop}\n\t\t>\n\t\t\t<div\n\t\t\t\tclassName={className}\n\t\t\t\tonDoubleClick={handleEdit}\n\t\t\t\tref={container}\n\t\t\t\tstyle={style}\n\t\t\t>\n\t\t\t\t<Card highlighted={passage.highlighted} selected={passage.selected}>\n\t\t\t\t\t<TagStripe tagColors={tagColors} tags={passage.tags} />\n\t\t\t\t\t<h2>{passage.name}</h2>\n\t\t\t\t\t<CardContent>{excerpt}</CardContent>\n\t\t\t\t</Card>\n\t\t\t</div>\n\t\t</DraggableCore>\n\t);\n});\n","import * as React from 'react';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {Passage} from '../../store/stories';\nimport {PassageCard, PassageCardProps} from './passage-card';\nimport '../../styles/animations.css';\n\nexport interface PassageCardGroupProps\n\textends Omit<PassageCardProps, 'passage'> {\n\tpassages: Passage[];\n}\n\nexport const PassageCardGroup: React.FC<PassageCardGroupProps> = React.memo(\n\tprops => {\n\t\tconst {passages} = props;\n\n\t\treturn (\n\t\t\t<TransitionGroup component={null}>\n\t\t\t\t{passages.map(passage => (\n\t\t\t\t\t<CSSTransition classNames=\"pop\" key={passage.id} timeout={200}>\n\t\t\t\t\t\t<PassageCard passage={passage} {...props} />\n\t\t\t\t\t</CSSTransition>\n\t\t\t\t))}\n\t\t\t</TransitionGroup>\n\t\t);\n\t}\n);\n","import * as React from 'react';\nimport {DraggableData} from 'react-draggable';\nimport {Passage, Story} from '../../../store/stories';\nimport {boundingRect, Point} from '../../../util/geometry';\nimport {PassageConnections} from '../passage-connections';\nimport {PassageCardGroup} from '../passage-card-group';\nimport './passage-map.css';\n\nexport interface PassageMapProps {\n\tformatName: string;\n\tformatVersion: string;\n\tonDeselect: (passage: Passage) => void;\n\tonDrag: (change: Point) => void;\n\tonEdit: (passage: Passage) => void;\n\tonSelect: (passage: Passage, exclusive: boolean) => void;\n\tpassages: Passage[];\n\tstartPassageId: string;\n\ttagColors: Story['tagColors'];\n\tzoom: number;\n}\n\ninterface DragState {\n\tdragging: boolean;\n\tdragX: number;\n\tdragY: number;\n\tstartX: number;\n\tstartY: number;\n}\n\ntype DragAction =\n\t| {type: 'start'; x: number; y: number}\n\t| {type: 'move'; x: number; y: number}\n\t| {type: 'stop'; callback: (change: Point) => void; zoom: number};\n\nfunction dragReducer(state: DragState, action: DragAction) {\n\tswitch (action.type) {\n\t\tcase 'start':\n\t\t\treturn {\n\t\t\t\tdragging: true,\n\t\t\t\tdragX: action.x,\n\t\t\t\tdragY: action.y,\n\t\t\t\tstartX: action.x,\n\t\t\t\tstartY: action.y\n\t\t\t};\n\n\t\tcase 'move':\n\t\t\treturn {...state, dragX: action.x, dragY: action.y};\n\n\t\tcase 'stop':\n\t\t\t// This is bad reducer practice, probably—this dispatch causes a side\n\t\t\t// effect. However, it allows us to avoid re-renders as state\n\t\t\t// changes--otherwise state becomes a dependency of the handleDragStop\n\t\t\t// callback below--which have a large performance impact.\n\t\t\t//\n\t\t\t// This also must be deferred to avoid changing state mid-render through\n\t\t\t// the callback.\n\n\t\t\tPromise.resolve().then(() =>\n\t\t\t\taction.callback({\n\t\t\t\t\tleft: (state.dragX - state.startX) / action.zoom,\n\t\t\t\t\ttop: (state.dragY - state.startY) / action.zoom\n\t\t\t\t})\n\t\t\t);\n\t\t\treturn {dragging: false, dragX: 0, dragY: 0, startX: 0, startY: 0};\n\t}\n}\n\nexport const PassageMap: React.FC<PassageMapProps> = props => {\n\tconst {\n\t\tformatName,\n\t\tformatVersion,\n\t\tonDeselect,\n\t\tonDrag,\n\t\tonEdit,\n\t\tonSelect,\n\t\tpassages,\n\t\tstartPassageId,\n\t\ttagColors,\n\t\tzoom\n\t} = props;\n\tconst container = React.useRef<HTMLDivElement>(null);\n\tconst bounds = React.useMemo(() => {\n\t\t// Need to inject a fake rect at the very top-left corner to anchor the\n\t\t// bounds there.\n\n\t\tconst passageBounds = boundingRect([\n\t\t\t...passages,\n\t\t\t{top: 0, left: 0, width: 0, height: 0}\n\t\t]);\n\t\tconst scaledWindowHeight = window.innerHeight / zoom;\n\t\tconst scaledWindowWidth = window.innerWidth / zoom;\n\n\t\treturn {\n\t\t\theight:\n\t\t\t\tMath.max(passageBounds.height, scaledWindowHeight) +\n\t\t\t\twindow.innerHeight * 0.75,\n\t\t\twidth:\n\t\t\t\tMath.max(passageBounds.width, scaledWindowWidth) +\n\t\t\t\twindow.innerWidth * 0.75\n\t\t};\n\t}, [passages, zoom]);\n\n\tconst style = React.useMemo(\n\t\t() => ({\n\t\t\t...bounds,\n\t\t\ttransform: `scale(${zoom})`\n\t\t}),\n\t\t[bounds, zoom]\n\t);\n\n\tconst [state, dispatch] = React.useReducer(dragReducer, {\n\t\tdragging: false,\n\t\tdragX: 0,\n\t\tdragY: 0,\n\t\tstartX: 0,\n\t\tstartY: 0\n\t});\n\n\tReact.useEffect(() => {\n\t\tif (!container.current) {\n\t\t\treturn;\n\t\t}\n\n\t\tcontainer.current.style.setProperty(\n\t\t\t'--drag-offset-left',\n\t\t\t`${(state.dragX - state.startX) / zoom}px`\n\t\t);\n\t\tcontainer.current.style.setProperty(\n\t\t\t'--drag-offset-top',\n\t\t\t`${(state.dragY - state.startY) / zoom}px`\n\t\t);\n\t}, [state.dragX, state.dragY, state.startX, state.startY, zoom]);\n\n\tconst handleDragStart = React.useCallback((event, data: DraggableData) => {\n\t\tdocument.body.classList.add('dragging-passages');\n\t\tdispatch({type: 'start', x: data.x, y: data.y});\n\t}, []);\n\tconst handleDrag = React.useCallback(\n\t\t(event, data: DraggableData) =>\n\t\t\tdispatch({type: 'move', x: data.x, y: data.y}),\n\t\t[]\n\t);\n\tconst handleDragStop = React.useCallback(() => {\n\t\tdocument.body.classList.remove('dragging-passages');\n\t\tdispatch({type: 'stop', callback: onDrag, zoom});\n\t}, [onDrag, zoom]);\n\n\treturn (\n\t\t<div className=\"passage-map\" ref={container} style={style}>\n\t\t\t<PassageConnections\n\t\t\t\tformatName={formatName}\n\t\t\t\tformatVersion={formatVersion}\n\t\t\t\toffset={{\n\t\t\t\t\tleft: (state.dragX - state.startX) / zoom,\n\t\t\t\t\ttop: (state.dragY - state.startY) / zoom\n\t\t\t\t}}\n\t\t\t\tpassages={passages}\n\t\t\t\tstartPassageId={startPassageId}\n\t\t\t/>\n\t\t\t<PassageCardGroup\n\t\t\t\tonDeselect={onDeselect}\n\t\t\t\tonDragStart={handleDragStart}\n\t\t\t\tonDrag={handleDrag}\n\t\t\t\tonDragStop={handleDragStop}\n\t\t\t\tonEdit={onEdit}\n\t\t\t\tonSelect={onSelect}\n\t\t\t\tpassages={passages}\n\t\t\t\ttagColors={tagColors}\n\t\t\t\tzoom={zoom}\n\t\t\t/>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPlus} from '@tabler/icons';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {createUntitledPassage, Story} from '../../../../store/stories';\nimport {useUndoableStoriesContext} from '../../../../store/undoable-stories';\nimport {Point} from '../../../../util/geometry';\n\nexport interface CreatePassageButtonProps {\n\tgetCenter: () => Point;\n\tstory: Story;\n}\n\nexport const CreatePassageButton: React.FC<CreatePassageButtonProps> = props => {\n\tconst {getCenter, story} = props;\n\tconst {dispatch} = useUndoableStoriesContext();\n\tconst handleClick = React.useCallback(() => {\n\t\tconst {left, top} = getCenter();\n\n\t\tdispatch(createUntitledPassage(story, left, top), 'undoChange.newPassage');\n\t}, [dispatch, getCenter, story]);\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconPlus />}\n\t\t\tlabel={t('common.new')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {deletePassages, Passage, Story} from '../../../../store/stories';\nimport {useUndoableStoriesContext} from '../../../../store/undoable-stories';\n\nexport interface DeletePassagesButtonProps {\n\tpassages: Passage[];\n\tstory: Story;\n}\n\nexport const DeletePassagesButton: React.FC<DeletePassagesButtonProps> = props => {\n\tconst {passages, story} = props;\n\tconst {dispatch} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tdispatch(\n\t\t\tdeletePassages(story, passages),\n\t\t\tpassages.length > 1\n\t\t\t\t? 'undoChange.deletePassages'\n\t\t\t\t: 'undoChange.deletePassage'\n\t\t);\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={passages.length === 0}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={\n\t\t\t\tpassages.length > 1\n\t\t\t\t\t? t('common.deleteCount', {count: passages.length})\n\t\t\t\t\t: t('common.delete')\n\t\t\t}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEdit} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {PassageEditDialog, useDialogsContext} from '../../../../dialogs';\nimport {Passage, Story} from '../../../../store/stories';\n\nexport interface EditPassagesButtonProps {\n\tpassages: Passage[];\n\tstory: Story;\n}\n\nexport const EditPassagesButton: React.FC<EditPassagesButtonProps> = props => {\n\tconst {passages, story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tdispatch(dispatch =>\n\t\t\tpassages.forEach(passage =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: PassageEditDialog,\n\t\t\t\t\tprops: {passageId: passage.id, storyId: story.id}\n\t\t\t\t})\n\t\t\t)\n\t\t);\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={passages.length === 0}\n\t\t\ticon={<IconEdit />}\n\t\t\tlabel={\n\t\t\t\tpassages.length > 1\n\t\t\t\t\t? t('common.editCount', {count: passages.length})\n\t\t\t\t\t: t('common.edit')\n\t\t\t}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconMarquee} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tselectAllPassages,\n\tStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface SelectAllPassagesButtonProps {\n\tstory: Story;\n}\n\nexport const SelectAllPassagesButton: React.FC<SelectAllPassagesButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconMarquee />}\n\t\t\tlabel={t('common.selectAll')}\n\t\t\tonClick={() => dispatch(selectAllPassages(story))}\n\t\t/>\n\t);\n};\n","import {IconRocket} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tPassage,\n\tStory,\n\tupdateStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface StartAtPassageButtonProps {\n\tpassage?: Passage;\n\tstory: Story;\n}\n\nexport const StartAtPassageButton: React.FC<StartAtPassageButtonProps> = props => {\n\tconst {passage, story} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tif (!passage) {\n\t\t\tthrow new Error('No passage set');\n\t\t}\n\n\t\tdispatch(updateStory(stories, story, {startPassage: passage.id}));\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!passage || passage.id === story.startPassage}\n\t\t\ticon={<IconRocket />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.startStoryHere')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTool} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {Passage, Story} from '../../../../store/stories';\nimport {useStoryLaunch} from '../../../../store/use-story-launch';\n\nexport interface TestPassageButtonProps {\n\tpassage?: Passage;\n\tstory: Story;\n}\n\nexport const TestPassageButton: React.FC<TestPassageButtonProps> = props => {\n\tconst {passage, story} = props;\n\tconst {testStory} = useStoryLaunch();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!passage}\n\t\t\ticon={<IconTool />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.testFromHere')}\n\t\t\tonClick={() => testStory(story.id, passage?.id)}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenamePassageButton} from '../../../../components/passage/rename-passage-button';\nimport {\n\tPassage,\n\tStory,\n\tupdatePassage,\n\tuseStoriesContext\n} from '../../../../store/stories';\nimport {Point} from '../../../../util/geometry';\nimport {CreatePassageButton} from './create-passage-button';\nimport {DeletePassagesButton} from './delete-passages-button';\nimport {EditPassagesButton} from './edit-passages-buttons';\nimport {SelectAllPassagesButton} from './select-all-passages-button';\nimport {StartAtPassageButton} from './start-at-passage-button';\nimport {TestPassageButton} from './test-passage-button';\n\nexport interface PassageActionsProps {\n\tgetCenter: () => Point;\n\tstory: Story;\n}\n\nexport const PassageActions: React.FC<PassageActionsProps> = ({\n\tgetCenter,\n\tstory\n}) => {\n\tconst {dispatch} = useStoriesContext();\n\tconst selectedPassages = React.useMemo(\n\t\t() => story.passages.filter(passage => passage.selected),\n\t\t[story.passages]\n\t);\n\tconst soloSelectedPassage = React.useMemo(\n\t\t() => (selectedPassages.length === 1 ? selectedPassages[0] : undefined),\n\t\t[selectedPassages]\n\t);\n\n\tfunction handleRename(name: string, passage?: Passage) {\n\t\tif (!passage) {\n\t\t\tthrow new Error('Passage is unset');\n\t\t}\n\n\t\t// Don't create newly linked passages here because the update action will\n\t\t// try to recreate the passage as it's been renamed--it sees new links in\n\t\t// existing passages, updates them, but does not see that the passage name\n\t\t// has been updated since that hasn't happened yet.\n\n\t\tdispatch(\n\t\t\tupdatePassage(\n\t\t\t\tstory,\n\t\t\t\tpassage,\n\t\t\t\t{name},\n\t\t\t\t{dontCreateNewlyLinkedPassages: true}\n\t\t\t)\n\t\t);\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<CreatePassageButton getCenter={getCenter} story={story} />\n\t\t\t<EditPassagesButton passages={selectedPassages} story={story} />\n\t\t\t<RenamePassageButton\n\t\t\t\tonRename={name => handleRename(name, soloSelectedPassage)}\n\t\t\t\tpassage={soloSelectedPassage}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<DeletePassagesButton passages={selectedPassages} story={story} />\n\t\t\t<TestPassageButton passage={soloSelectedPassage} story={story} />\n\t\t\t<StartAtPassageButton passage={soloSelectedPassage} story={story} />\n\t\t\t<SelectAllPassagesButton story={story} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconWriting} from '@tabler/icons';\nimport {PromptButton} from '../control/prompt-button';\nimport {storyFileName} from '../../electron/shared';\nimport {Story} from '../../store/stories';\nimport {IconButton} from '../control/icon-button';\n\n// This is here because it's used in two places--the story list and the story\n// info dialog.\n\nconst DisabledRenameStoryButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton disabled icon={<IconWriting />} label={t('common.rename')} />\n\t);\n};\n\ninterface EnabledRenameStoryButtonProps {\n\texistingStories: Story[];\n\tonRename: (value: string) => void;\n\tstory: Story;\n}\n\nconst EnabledRenameStoryButton: React.FC<EnabledRenameStoryButtonProps> = props => {\n\tconst {existingStories, onRename, story} = props;\n\tconst [newName, setNewName] = React.useState(story.name);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => setNewName(story.name), [story]);\n\n\tfunction validate(name: string) {\n\t\tif (name.trim() === '') {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renameStoryButton.emptyName'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\texistingStories.some(\n\t\t\t\ts =>\n\t\t\t\t\ts.id !== story.id &&\n\t\t\t\t\tstoryFileName(s) === storyFileName({...story, name})\n\t\t\t)\n\t\t) {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renameStoryButton.nameAlreadyUsed'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconWriting />}\n\t\t\tlabel={t('common.rename')}\n\t\t\tonChange={event => setNewName(event.target.value)}\n\t\t\tonSubmit={onRename}\n\t\t\tprompt={t('common.renamePrompt', {name: story.name})}\n\t\t\tvalidate={validate}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n\nexport interface RenameStoryButtonProps\n\textends Omit<EnabledRenameStoryButtonProps, 'story'> {\n\tstory?: Story;\n}\n\nexport const RenameStoryButton: React.FC<RenameStoryButtonProps> = props => {\n\tif (props.story) {\n\t\treturn (\n\t\t\t<EnabledRenameStoryButton {...(props as EnabledRenameStoryButtonProps)} />\n\t\t);\n\t}\n\n\treturn <DisabledRenameStoryButton />;\n};","import {IconInfoCircle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryDetailsDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface DetailsButtonProps {\n\tstory: Story;\n}\n\nexport const DetailsButton: React.FC<DetailsButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconInfoCircle />}\n\t\t\tlabel={t('common.details')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryDetailsDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconSearch} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StorySearchDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface FindReplaceButtonProps {\n\tstory: Story;\n}\n\nexport const FindReplaceButton: React.FC<FindReplaceButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconSearch />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.findAndReplace')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StorySearchDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconBraces} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryJavaScriptDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface JavaScriptButtonProps {\n\tstory: Story;\n}\n\nexport const JavaScriptButton: React.FC<JavaScriptButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconBraces />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.javaScript')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryJavaScriptDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconTags} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {PassageTagsDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface PassageTagsButtonProps {\n\tstory: Story;\n}\n\nexport const PassageTagsButton: React.FC<PassageTagsButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconTags />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.passageTags')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: PassageTagsDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconHash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryStylesheetDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface StylesheetButtonProps {\n\tstory: Story;\n}\n\nexport const StylesheetButton: React.FC<StylesheetButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconHash />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.stylesheet')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryStylesheetDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenameStoryButton} from '../../../../components/story/rename-story-button';\nimport {Story, updateStory, useStoriesContext} from '../../../../store/stories';\nimport {DetailsButton} from './details-button';\nimport {FindReplaceButton} from './find-replace-button';\nimport {JavaScriptButton} from './javascript-button';\nimport {PassageTagsButton} from './passage-tags-button';\nimport {StylesheetButton} from './stylesheet-button';\n\nexport interface StoryActionsProps {\n\tstory: Story;\n}\n\nexport const StoryActions: React.FC<StoryActionsProps> = props => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {story} = props;\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<FindReplaceButton story={story} />\n\t\t\t<RenameStoryButton\n\t\t\t\texistingStories={stories}\n\t\t\t\tonRename={name => dispatch(updateStory(stories, story, {name}))}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<DetailsButton story={story} />\n\t\t\t<PassageTagsButton story={story} />\n\t\t\t<JavaScriptButton story={story} />\n\t\t\t<StylesheetButton story={story} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowBack, IconArrowForward} from '@tabler/icons';\nimport {useUndoableStoriesContext} from '../../../store/undoable-stories';\nimport {IconButton} from '../../../components/control/icon-button';\n\nexport const UndoRedoButtons: React.FC = () => {\n\tconst {redo, redoLabel, undo, undoLabel} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!undo}\n\t\t\t\ticon={<IconArrowBack />}\n\t\t\t\tlabel={undoLabel ?? t('common.undo')}\n\t\t\t\tonClick={undo}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!redo}\n\t\t\t\ticon={<IconArrowForward />}\n\t\t\t\tlabel={redoLabel ?? t('common.redo')}\n\t\t\t\tonClick={redo}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {AppActions, BuildActions} from '../../../route-actions';\nimport {Story} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {PassageActions} from './passage/passage-actions';\nimport {StoryActions} from './story/story-actions';\nimport {UndoRedoButtons} from './undo-redo-buttons';\n\nexport interface StoryEditToolbarProps {\n\tgetCenter: () => Point;\n\tstory: Story;\n}\n\nexport const StoryEditToolbar: React.FC<StoryEditToolbarProps> = props => {\n\tconst {getCenter, story} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\tpinnedControls={<UndoRedoButtons />}\n\t\t\ttabs={{\n\t\t\t\t[t('common.passage')]: (\n\t\t\t\t\t<PassageActions getCenter={getCenter} story={story} />\n\t\t\t\t),\n\t\t\t\t[t('common.story')]: <StoryActions story={story} />,\n\t\t\t\t[t('common.build')]: <BuildActions story={story} />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconZoomIn} from '@tabler/icons';\nimport {IconZoomOut} from '../../components/image/icon';\nimport {IconButton} from '../../components/control/icon-button';\nimport {\n\tminZoom,\n\tmaxZoom,\n\tupdateStory,\n\tuseStoriesContext,\n\tStory\n} from '../../store/stories';\nimport {ButtonCard} from '../../components/container/button-card';\nimport './zoom-buttons.css';\nimport {useScrollbarSize} from 'react-scrollbar-size';\n\nexport interface ZoomButtonsProps {\n\tstory: Story;\n}\n\nexport const ZoomButtons: React.FC<ZoomButtonsProps> = ({story}) => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\tconst {height} = useScrollbarSize();\n\n\tconst handleZoomChange = React.useCallback(\n\t\t(change: number) => {\n\t\t\tdispatch(updateStory(stories, story, {zoom: story.zoom + change}));\n\t\t},\n\t\t[dispatch, stories, story]\n\t);\n\n\tconst style: React.CSSProperties = {\n\t\tmarginBottom: height\n\t};\n\n\treturn (\n\t\t<div className=\"zoom-buttons\" style={style}>\n\t\t\t<ButtonCard>\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={story.zoom >= maxZoom}\n\t\t\t\t\ticon={<IconZoomIn />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomIn')}\n\t\t\t\t\tonClick={() => handleZoomChange(0.2)}\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={story.zoom <= minZoom}\n\t\t\t\t\ticon={<IconZoomOut />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomOut')}\n\t\t\t\t\tonClick={() => handleZoomChange(-0.2)}\n\t\t\t\t/>\n\t\t\t</ButtonCard>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {Helmet} from 'react-helmet';\nimport {useParams} from 'react-router-dom';\nimport {MainContent} from '../../components/container/main-content';\nimport {MarqueeSelection} from '../../components/marquee-selection';\nimport {PassageMap} from '../../components/passage/passage-map/passage-map';\nimport {\n\tDialogsContextProvider,\n\tPassageEditDialog,\n\tuseDialogsContext\n} from '../../dialogs';\nimport {\n\tcreateUntitledPassage,\n\tdeselectPassage,\n\tmovePassages,\n\tPassage,\n\tselectPassage,\n\tselectPassagesInRect,\n\tstoryWithId\n} from '../../store/stories';\nimport {\n\tUndoableStoriesContextProvider,\n\tuseUndoableStoriesContext\n} from '../../store/undoable-stories';\nimport {Point, Rect} from '../../util/geometry';\nimport {StoryEditToolbar} from './toolbar';\nimport './story-edit-route.css';\nimport {ZoomButtons} from './zoom-buttons';\n\nexport const InnerStoryEditRoute: React.FC = () => {\n\tconst [inited, setInited] = React.useState(false);\n\tconst {dispatch: dialogsDispatch} = useDialogsContext();\n\tconst mainContent = React.useRef<HTMLDivElement>(null);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {\n\t\tdispatch: undoableStoriesDispatch,\n\t\tstories\n\t} = useUndoableStoriesContext();\n\tconst story = storyWithId(stories, storyId);\n\n\tconst selectedPassages = React.useMemo(\n\t\t() => story.passages.filter(passage => passage.selected),\n\t\t[story.passages]\n\t);\n\n\tconst getCenter = React.useCallback(() => {\n\t\tif (!mainContent.current) {\n\t\t\tthrow new Error(\n\t\t\t\t'Asked for the center of the main content, but it does not exist in the DOM yet'\n\t\t\t);\n\t\t}\n\n\t\treturn {\n\t\t\tleft:\n\t\t\t\t(mainContent.current.scrollLeft + mainContent.current.clientWidth / 2) /\n\t\t\t\tstory.zoom,\n\t\t\ttop:\n\t\t\t\t(mainContent.current.scrollTop + mainContent.current.clientHeight / 2) /\n\t\t\t\tstory.zoom\n\t\t};\n\t}, [story.zoom]);\n\n\tconst handleDeselectPassage = React.useCallback(\n\t\t(passage: Passage) =>\n\t\t\tundoableStoriesDispatch(deselectPassage(story, passage)),\n\t\t[story, undoableStoriesDispatch]\n\t);\n\n\tconst handleDragPassages = React.useCallback(\n\t\t(change: Point) => {\n\t\t\t// Ignore tiny drags--they're probably caused by the user moving their\n\t\t\t// mouse slightly during double-clicking.\n\n\t\t\tif (Math.abs(change.left) < 1 && Math.abs(change.top) < 1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tundoableStoriesDispatch(\n\t\t\t\tmovePassages(\n\t\t\t\t\tstory,\n\t\t\t\t\tstory.passages.reduce<string[]>(\n\t\t\t\t\t\t(result, current) =>\n\t\t\t\t\t\t\tcurrent.selected ? [...result, current.id] : result,\n\t\t\t\t\t\t[]\n\t\t\t\t\t),\n\t\t\t\t\tchange.left,\n\t\t\t\t\tchange.top\n\t\t\t\t),\n\t\t\t\tselectedPassages.length > 1\n\t\t\t\t\t? 'undoChange.movePassages'\n\t\t\t\t\t: 'undoChange.movePassages'\n\t\t\t);\n\t\t},\n\t\t[selectedPassages.length, story, undoableStoriesDispatch]\n\t);\n\n\tconst handleEditPassage = React.useCallback(\n\t\t(passage: Passage) =>\n\t\t\tdialogsDispatch({\n\t\t\t\ttype: 'addDialog',\n\t\t\t\tcomponent: PassageEditDialog,\n\t\t\t\tprops: {passageId: passage.id, storyId: story.id}\n\t\t\t}),\n\t\t[dialogsDispatch, story.id]\n\t);\n\n\tconst handleSelectPassage = React.useCallback(\n\t\t(passage: Passage, exclusive: boolean) =>\n\t\t\tundoableStoriesDispatch(selectPassage(story, passage, exclusive)),\n\t\t[story, undoableStoriesDispatch]\n\t);\n\n\tconst handleSelectRect = React.useCallback(\n\t\t(rect: Rect, exclusive: boolean) => {\n\t\t\t// The rect we receive is in screen coordinates--we need to convert to\n\t\t\t// logical ones.\n\n\t\t\tconst logicalRect: Rect = {\n\t\t\t\theight: rect.height / story.zoom,\n\t\t\t\tleft: rect.left / story.zoom,\n\t\t\t\ttop: rect.top / story.zoom,\n\t\t\t\twidth: rect.width / story.zoom\n\t\t\t};\n\n\t\t\t// This should not be undoable.\n\n\t\t\tundoableStoriesDispatch(\n\t\t\t\tselectPassagesInRect(\n\t\t\t\t\tstory,\n\t\t\t\t\tlogicalRect,\n\t\t\t\t\texclusive ? [] : selectedPassages.map(passage => passage.id)\n\t\t\t\t)\n\t\t\t);\n\t\t},\n\t\t[selectedPassages, story, undoableStoriesDispatch]\n\t);\n\n\t// TODO: space bar scrolling\n\n\t// If we have just mounted and the story has no passages, create one for the\n\t// user (and skip undo history, since it was an automatic action).\n\n\tReact.useEffect(() => {\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\n\t\t\tif (story.passages.length === 0) {\n\t\t\t\tconst center = getCenter();\n\n\t\t\t\tundoableStoriesDispatch(\n\t\t\t\t\tcreateUntitledPassage(story, center.left, center.top)\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}, [getCenter, inited, story, undoableStoriesDispatch]);\n\n\treturn (\n\t\t<div className=\"story-edit-route\">\n\t\t\t<Helmet>\n\t\t\t\t<title>{story.name}</title>\n\t\t\t</Helmet>\n\t\t\t<StoryEditToolbar getCenter={getCenter} story={story} />\n\t\t\t<MainContent padded={false} ref={mainContent}>\n\t\t\t\t<MarqueeSelection\n\t\t\t\t\tcontainer={mainContent}\n\t\t\t\t\tignoreEventsOnSelector=\".passage-card, .passage-toolbar\"\n\t\t\t\t\tonSelectRect={handleSelectRect}\n\t\t\t\t/>\n\t\t\t\t<PassageMap\n\t\t\t\t\tformatName={story.storyFormat}\n\t\t\t\t\tformatVersion={story.storyFormatVersion}\n\t\t\t\t\tonDeselect={handleDeselectPassage}\n\t\t\t\t\tonDrag={handleDragPassages}\n\t\t\t\t\tonEdit={handleEditPassage}\n\t\t\t\t\tonSelect={handleSelectPassage}\n\t\t\t\t\tpassages={story.passages}\n\t\t\t\t\tstartPassageId={story.startPassage}\n\t\t\t\t\ttagColors={story.tagColors}\n\t\t\t\t\tzoom={story.zoom}\n\t\t\t\t/>\n\t\t\t\t<ZoomButtons story={story} />\n\t\t\t</MainContent>\n\t\t</div>\n\t);\n};;\n\n// This is a separate component so that the inner one can use\n// `useEditorsContext()` and `useUndoableStoriesContext()` inside it.\n\nexport const StoryEditRoute: React.FC = () => (\n\t<UndoableStoriesContextProvider>\n\t\t<DialogsContextProvider>\n\t\t\t<InnerStoryEditRoute />\n\t\t</DialogsContextProvider>\n\t</UndoableStoriesContextProvider>\n);\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconAlertOctagon, IconInfoCircle} from '@tabler/icons';\nimport UAParser from 'ua-parser-js';\nimport {ButtonBar} from '../container/button-bar';\nimport {IconLink} from '../control/icon-link';\nimport {Card} from '../container/card';\nimport './safari-warning-card.css';\n\nexport interface SafariNavigator extends Navigator {\n\tstandalone?: boolean;\n}\n\nexport const SafariWarningCard: React.FC = props => {\n\tconst {t} = useTranslation();\n\tconst browser = new UAParser().getBrowser();\n\n\tif (browser.name !== 'Safari') {\n\t\treturn null;\n\t}\n\n\tif (browser.version) {\n\t\tconst version = parseInt(browser.version.replace(/\\..*/, ''));\n\n\t\tif (Number.isFinite(version) && version < 13) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tconst safariNavigator = window.navigator as SafariNavigator;\n\n\tif (safariNavigator.standalone) {\n\t\t// We are in \"standalone\" or full-screen mode. This is supposed to have\n\t\t// its own localStorage which is not subject to the seven-day limit.\n\t\t// https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html\n\t\treturn null;\n\t}\n\n\tconst canAddToHomeScreen = safariNavigator.standalone !== undefined;\n\n\treturn (\n\t\t<div className=\"safari-warning-card\">\n\t\t\t<Card>\n\t\t\t\t<div className=\"side-icon\">\n\t\t\t\t\t<IconAlertOctagon />\n\t\t\t\t</div>\n\t\t\t\t<div className=\"message\">\n\t\t\t\t\t<p>{t('components.safariWarningCard.message')}</p>\n\t\t\t\t\t{canAddToHomeScreen && (\n\t\t\t\t\t\t<p>{t('components.safariWarningCard.addToHomeScreen')}</p>\n\t\t\t\t\t)}\n\t\t\t\t\t<p>{t('components.safariWarningCard.archiveAndUseAnotherBrowser')}</p>\n\t\t\t\t</div>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://twinery.org/2ioslocalstorage\"\n\t\t\t\t\t\ticon={<IconInfoCircle />}\n\t\t\t\t\t\tlabel={t('components.safariWarningCard.learnMore')}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t\t{canAddToHomeScreen && (\n\t\t\t\t\t\t<IconLink\n\t\t\t\t\t\t\thref=\"https://twinery.org/2ioshomescreen\"\n\t\t\t\t\t\t\ticon={<IconInfoCircle />}\n\t\t\t\t\t\t\tlabel={t('components.safariWarningCard.howToAddToHomeScreen')}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</ButtonBar>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","/**\n * Returns how much local storage space is being used in characters.\n */\nexport function localStorageUsedSpace() {\n\treturn JSON.stringify(window.localStorage).length;\n}\n\n/**\n * Resolves to how much local storage space is available in characters.\n * @param chunkSize granularity of the check\n * @param intervalDelay how much time to allow between checks\n */\nexport function localStorageFreeSpace(chunkSize = 100000, intervalDelay = 20) {\n\treturn new Promise<number>(resolve => {\n\t\tconst testString = 'x'.repeat(chunkSize);\n\t\tlet usedChunks = 0;\n\t\tconst interval = window.setInterval(() => {\n\t\t\ttry {\n\t\t\t\twindow.localStorage.setItem(`__freeSpaceTest${usedChunks}`, testString);\n\t\t\t\tusedChunks++;\n\t\t\t} catch (error) {\n\t\t\t\t// We've run out of space. Clean up our test items and resolve.\n\n\t\t\t\tfor (let i = 0; i <= usedChunks; i++) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\twindow.localStorage.removeItem(`__freeSpaceTest${i}`);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t// Keep going--hopefully it was a temporary error. We still need to\n\t\t\t\t\t\t// clean up the rest of our work.\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\twindow.clearInterval(interval);\n\t\t\t\tresolve(usedChunks * chunkSize);\n\t\t\t}\n\t\t}, intervalDelay);\n\t});\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {isElectronRenderer} from '../../util/is-electron';\nimport {\n\tlocalStorageFreeSpace,\n\tlocalStorageUsedSpace\n} from '../../util/local-storage-quota';\nimport {IconLoading} from '../image/icon';\nimport './storage-quota.css';\n\nexport interface StorageQuotaProps {\n\twatch: any;\n}\n\nexport const StorageQuota: React.FC<StorageQuotaProps> = props => {\n\tconst {watch} = props;\n\tconst [lastWatch, setLastWatch] = React.useState<any>();\n\tconst [working, setWorking] = React.useState(false);\n\n\t// This is set to -1 so that we can hide the percentage while doing the\n\t// initial calculation. Later ones will show the same percentage but with a\n\t// loading icon beside it until finishes.\n\n\tconst [freeSpace, setFreeSpace] = React.useState(-1);\n\tconst [usedSpace, setUsedSpace] = React.useState(0);\n\tconst {t} = useTranslation();\n\n\tconst hide = isElectronRenderer();\n\n\t// When the watch prop changes, start calculating space.\n\n\tReact.useEffect(() => {\n\t\tasync function run() {\n\t\t\tsetWorking(true);\n\t\t\tsetUsedSpace(localStorageUsedSpace());\n\t\t\tsetFreeSpace(await localStorageFreeSpace());\n\t\t\tsetLastWatch(watch);\n\t\t\tsetWorking(false);\n\t\t}\n\n\t\tif (!hide && !working && lastWatch !== watch) {\n\t\t\trun();\n\t\t}\n\t}, [hide, lastWatch, watch, working]);\n\n\tif (hide) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<span className=\"storage-quota\">\n\t\t\t{working && <IconLoading />}\n\t\t\t{freeSpace !== -1 &&\n\t\t\t\tt('components.storageQuota.freeSpace', {\n\t\t\t\t\tpercent: Math.round((freeSpace / (freeSpace + usedSpace)) * 100)\n\t\t\t\t})}\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPackage} from '@tabler/icons';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {useStoriesContext} from '../../../../store/stories';\nimport {archiveFilename, publishArchive} from '../../../../util/publish';\nimport {saveHtml} from '../../../../util/save-html';\nimport {getAppInfo} from '../../../../util/app-info';\n\nexport const ArchiveButton: React.FC = () => {\n\tconst {stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconPackage />}\n\t\t\tlabel={t('routes.storyList.toolbar.archive')}\n\t\t\tonClick={() =>\n\t\t\t\tsaveHtml(publishArchive(stories, getAppInfo()), archiveFilename())\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconFileImport} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryImportDialog, useDialogsContext} from '../../../../dialogs';\n\nexport const ImportStoryButton: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconFileImport />}\n\t\t\tlabel={t('common.import')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({type: 'addDialog', component: StoryImportDialog})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconTags} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryTagsDialog, useDialogsContext} from '../../../../dialogs';\n\nexport const StoryTagsButton: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconTags />}\n\t\t\tlabel={t('routes.storyList.toolbar.storyTags')}\n\t\t\tonClick={() => {\n\t\t\t\tdispatch({type: 'addDialog', component: StoryTagsDialog});\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {ArchiveButton} from './archive-button';\nimport {ImportStoryButton} from './import-story-button';\nimport {StoryTagsButton} from './story-tags-button';\n\nexport const LibraryActions: React.FC = () => (\n\t<ButtonBar>\n\t\t<StoryTagsButton />\n\t\t<ImportStoryButton />\n\t\t<ArchiveButton />\n\t</ButtonBar>\n);\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconPlus} from '@tabler/icons';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {\n\tcreateUntitledStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport const CreateStoryButton: React.FC = () => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst history = useHistory();\n\tconst {prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleCreate() {\n\t\tconst id = createUntitledStory(stories, prefs)(dispatch, () => stories);\n\n\t\thistory.push(`/stories/${id}`);\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconPlus />}\n\t\t\tlabel={t('common.new')}\n\t\t\tonClick={handleCreate}\n\t\t/>\n\t);\n};\n","import {IconCheck, IconX} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton, CardButtonProps} from './card-button';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './confirm-button.css';\n\nexport interface ConfirmButtonProps\n\textends Omit<CardButtonProps, 'open' | 'onChangeOpen'> {\n\tcancelIcon?: React.ReactNode;\n\tcancelLabel?: string;\n\tconfirmIcon?: React.ReactNode;\n\tconfirmLabel?: string;\n\tconfirmVariant?: IconButtonProps['variant'];\n\tonConfirm: () => void;\n\tprompt: string;\n}\n\nexport const ConfirmButton: React.FC<ConfirmButtonProps> = props => {\n\tconst {\n\t\tcancelIcon,\n\t\tcancelLabel,\n\t\tconfirmIcon,\n\t\tconfirmLabel,\n\t\tconfirmVariant,\n\t\tonConfirm,\n\t\tprompt,\n\t\t...other\n\t} = props;\n\tconst [open, setOpen] = React.useState(false);\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<span className=\"confirm-button\">\n\t\t\t<CardButton onChangeOpen={setOpen} open={open} {...other}>\n\t\t\t\t<CardContent>{prompt}</CardContent>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={confirmIcon ?? <IconCheck />}\n\t\t\t\t\t\tlabel={confirmLabel ?? t('common.ok')}\n\t\t\t\t\t\tonClick={onConfirm}\n\t\t\t\t\t\tvariant={confirmVariant ?? 'primary'}\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={cancelIcon ?? <IconX />}\n\t\t\t\t\t\tlabel={cancelLabel ?? t('common.cancel')}\n\t\t\t\t\t\tonClick={() => setOpen(false)}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ConfirmButton} from '../../../../components/control/confirm-button';\nimport {deleteStory, Story, useStoriesContext} from '../../../../store/stories';\nimport {isElectronRenderer} from '../../../../util/is-electron';\n\nexport interface DeleteStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const DeleteStoryButton: React.FC<DeleteStoryButtonProps> = ({\n\tstory\n}) => {\n\tconst {dispatch} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<ConfirmButton\n\t\t\tconfirmIcon={<IconTrash />}\n\t\t\tconfirmLabel={t('common.delete')}\n\t\t\tconfirmVariant=\"danger\"\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={t('common.delete')}\n\t\t\tonConfirm={story ? () => dispatch(deleteStory(story)) : () => {}}\n\t\t\tprompt={t(\n\t\t\t\t`routes.storyList.toolbar.deleteStoryButton.warning.${\n\t\t\t\t\tisElectronRenderer() ? 'electron' : 'web'\n\t\t\t\t}`,\n\t\t\t\t{storyName: story?.name}\n\t\t\t)}\n\t\t/>\n\t);\n};\n","import {IconCopy} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tduplicateStory,\n\tStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface DuplicateStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const DuplicateStoryButton: React.FC<DuplicateStoryButtonProps> = ({\n\tstory\n}) => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story set');\n\t\t}\n\n\t\tdispatch(duplicateStory(story, stories));\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconCopy />}\n\t\t\tlabel={t('common.duplicate')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEdit} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {Story} from '../../../../store/stories';\n\nexport interface EditStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const EditStoryButton: React.FC<EditStoryButtonProps> = ({story}) => {\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconEdit />}\n\t\t\tlabel={t('common.edit')}\n\t\t\tonClick={() => history.push(`/stories/${story?.id}`)}\n\t\t/>\n\t);\n};\n","import {IconTag} from '@tabler/icons';\nimport * as React from 'react';\nimport {AddTagButton} from '../../../../components/tag';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\nimport {\n\tStory,\n\tstoryTags,\n\tupdateStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface TagStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const TagStoryButton: React.FC<TagStoryButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\n\tfunction handleAddTag(tagName: string, tagColor?: string) {\n\t\tif (!story) {\n\t\t\tthrow new Error('Story is unset');\n\t\t}\n\n\t\tstoriesDispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttags: story.tags ? [...story.tags, tagName] : [tagName]\n\t\t\t})\n\t\t);\n\n\t\tif (tagColor) {\n\t\t\tprefsDispatch(\n\t\t\t\tsetPref('storyTagColors', {\n\t\t\t\t\t...prefs.storyTagColors,\n\t\t\t\t\t[tagName]: tagColor\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<AddTagButton\n\t\t\tassignedTags={story?.tags ?? []}\n\t\t\tdisabled={!story}\n\t\t\texistingTags={storyTags(stories)}\n\t\t\ticon={<IconTag />}\n\t\t\tonAdd={handleAddTag}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {Story, useStoriesContext} from '../../../../store/stories';\nimport {CheckboxButton} from '../../../../components/control/checkbox-button';\nimport {IconPlus, IconWriting, IconX} from '@tabler/icons';\nimport { CardButton } from '../../../../components/control/card-button';\nimport { CardContent } from '../../../../components/container/card';\nimport { IconButton } from '../../../../components/control/icon-button';\nimport { ButtonBar } from '../../../../components/container/button-bar';\n\n\n\nexport interface RenameStoryButtonProps{\n    onSelect: (stories: Story[]) => void;\n}\n\nexport const ExportStoriesButton: React.FC<RenameStoryButtonProps> = props => {\n    const [open, setOpen] = React.useState<boolean>(false);\n\tconst {dispatch, stories} = useStoriesContext();\n    const [selectedStories, setSelectedStories] = React.useState<Story[]>([]);\n\tfunction handleChange(story: Story, selected: boolean) {\n\t\tif (selected) {\n\t\t\tsetSelectedStories(current => [...current, story]);\n\t\t} else {\n\t\t\tsetSelectedStories(current =>\n\t\t\t\tcurrent.filter(other => other.id !== story.id)\n\t\t\t);\n\t\t}\n\t}\n    return <CardButton\n\t\t\t\tdisabled={false}\n\t\t\t\ticon={<IconWriting/>}\n\t\t\t\tlabel={\"export stories\"}\n\t\t\t\tonChangeOpen={()=>{\n\t\t\t\t\tsetOpen(true)\n\t\t\t\t}}\n\t\t\t\topen={open}>\n\t\t\t\t<CardContent style={{width:400, maxHeight:400, overflowY:\"auto\"}}>\n                    <ul>{stories.map(story => (\n                    <li>\n                            <CheckboxButton\n                                key={story.id}\n                                label={story.name}\n                                onChange={selected => handleChange(story, selected)}\n                                value={selectedStories.includes(story)}\n                            />\n                        </li>\n                    ))}</ul>\n                    <ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={false}\n\t\t\t\t\t\ticon={<IconPlus />}\n\t\t\t\t\t\tlabel={\"Export\"}\n\t\t\t\t\t\tonClick={()=>{\n                            props.onSelect(selectedStories);\n                            setOpen(false);\n                        }}\n\t\t\t\t\t\tvariant=\"create\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={\"Cancel\"}\n\t\t\t\t\t\tonClick={() => setOpen(false)}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t\t</CardContent>\n\t\t\t</CardButton>\n};","import * as React from 'react';\nimport request from 'superagent';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenameStoryButton} from '../../../../components/story/rename-story-button';\nimport {Story, updateStory, useStoriesContext} from '../../../../store/stories';\nimport {CreateStoryButton} from './create-story-button';\nimport {DeleteStoryButton} from './delete-story-button';\nimport {DuplicateStoryButton} from './duplicate-story-button';\nimport {EditStoryButton} from './edit-story-button';\nimport {TagStoryButton} from './tag-story-button';\nimport {ExportStoriesButton} from './export-stories-button';\nimport { convertToCaravan } from '../../../../util/caravan';\n\n\nexport interface StoryActionsProps {\n\tselectedStory?: Story;\n}\nconst exportData = async (stories:Story[]) => {\n\tlet name = \"\";\n\t\n\tconst _stories = stories.reduce((acc:any,s)=>{\n\t\tname = stories.length == 1 ? s.name.replace(/\\s+/g,'') : `${name}_${(s.name || \"not\").substring(0,3)}`;\n\t\tconst arr = convertToCaravan(s);\n\t\tif (arr.length > 0){\n\t\t\treturn [...acc, arr[0]]\n\t\t}\n\t\treturn acc;\n\t},[])\n\n    const jsonString = `data:text/json;chatset=utf-8,${encodeURIComponent(\n      JSON.stringify(_stories,null,4)\n    )}`;\n\t\n\ttry{\t\n\t\tawait request.post('/author/save').set('Content-Type', 'application/json').send({name,layer:_stories});\n\t}catch(err){\n\t\tconsole.log(\"failed to trabsfer to fmundane engine!\");\n\t}\n    const link = document.createElement(\"a\");\n    link.href = jsonString;\n    link.download = `${name}.json`;\n    link.click();\n};\n\nexport const StoryActions: React.FC<StoryActionsProps> = props => {\n\tconst {selectedStory} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<CreateStoryButton />\n\t\t\t<EditStoryButton story={selectedStory} />\n\t\t\t<TagStoryButton story={selectedStory} />\n\t\t\t<RenameStoryButton\n\t\t\t\texistingStories={stories}\n\t\t\t\tonRename={name =>\n\t\t\t\t\tdispatch(updateStory(stories, selectedStory!, {name}))\n\t\t\t\t}\n\t\t\t\tstory={selectedStory}\n\t\t\t/>\n\t\t\t<DuplicateStoryButton story={selectedStory} />\n\t\t\t<DeleteStoryButton story={selectedStory} />\n\t\t\t<ExportStoriesButton onSelect={(stories:Story[])=>{exportData(stories)}}/>\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowsSort} from '@tabler/icons';\nimport {MenuButton} from '../../../../components/control/menu-button';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\n\nexport const SortByButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\tconst {dispatch, prefs} = usePrefsContext();\n\n\treturn (\n\t\t<MenuButton\n\t\t\ticon={<IconArrowsSort />}\n\t\t\titems={[\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListSort === 'date',\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.sortByDate'),\n\t\t\t\t\tonClick: () => dispatch(setPref('storyListSort', 'date'))\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListSort === 'name',\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.sortByName'),\n\t\t\t\t\tonClick: () => dispatch(setPref('storyListSort', 'name'))\n\t\t\t\t}\n\t\t\t]}\n\t\t\tlabel={t('routes.storyList.toolbar.sort')}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconTag} from '@tabler/icons';\nimport {MenuButton} from '../../../../components/control/menu-button';\nimport {usePrefsContext} from '../../../../store/prefs';\n\nexport interface TagFilterButtonProps {\n\ttags: string[];\n}\n\nexport const TagFilterButton: React.FC<TagFilterButtonProps> = props => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<MenuButton\n\t\t\tdisabled={props.tags.length === 0}\n\t\t\ticon={<IconTag />}\n\t\t\titems={[\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListTagFilter.length === 0,\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.showAllStories'),\n\t\t\t\t\tonClick: () =>\n\t\t\t\t\t\tdispatch({type: 'update', name: 'storyListTagFilter', value: []})\n\t\t\t\t},\n\t\t\t\t{separator: true},\n\t\t\t\t...props.tags.map(tag => ({\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListTagFilter.includes(tag),\n\t\t\t\t\tlabel: tag,\n\t\t\t\t\tonClick: () =>\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'update',\n\t\t\t\t\t\t\tname: 'storyListTagFilter',\n\t\t\t\t\t\t\tvalue: prefs.storyListTagFilter.includes(tag)\n\t\t\t\t\t\t\t\t? prefs.storyListTagFilter.filter(t => t !== tag)\n\t\t\t\t\t\t\t\t: [...prefs.storyListTagFilter, tag]\n\t\t\t\t\t\t})\n\t\t\t\t}))\n\t\t\t]}\n\t\t\tlabel={t('routes.storyList.toolbar.showTags')}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {storyTags, useStoriesContext} from '../../../../store/stories';\nimport {SortByButton} from './sort-by-button';\nimport {TagFilterButton} from './tag-filter-button';\n\nexport const ViewActions: React.FC = () => {\n\tconst {stories} = useStoriesContext();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<SortByButton />\n\t\t\t<TagFilterButton tags={storyTags(stories)} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {StorageQuota} from '../../../components/storage-quota/storage-quota';\nimport {BuildActions, AppActions} from '../../../route-actions';\nimport {Story, useStoriesContext} from '../../../store/stories';\nimport {LibraryActions} from './library/library-actions';\nimport {StoryActions} from './story/story-actions';\nimport {ViewActions} from './view/view-actions';\n\nexport interface StoryListToolbarProps {\n\tselectedStories: Story[];\n}\n\nexport const StoryListToolbar: React.FC<StoryListToolbarProps> = props => {\n\tconst {selectedStories} = props;\n\tconst {stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\tconst selectedStory =\n\t\tselectedStories.length === 1 ? selectedStories[0] : undefined;\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\tpinnedControls={<StorageQuota watch={stories} />}\n\t\t\ttabs={{\n\t\t\t\t[t('common.story')]: <StoryActions selectedStory={selectedStory} />,\n\t\t\t\t[t('routes.storyList.library')]: <LibraryActions />,\n\t\t\t\t[t('common.build')]: <BuildActions story={selectedStory} />,\n\t\t\t\t[t('common.view')]: <ViewActions />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","/**\n * Generates a hue (as in the HSL colorspace) for a string.\n */\nexport function hueString(value: string): number {\n\tlet result = 0;\n\n\tfor (let i = 0; i < value.length; i++) {\n\t\tresult += value.charCodeAt(i);\n\t}\n\n\treturn result % 360;\n}\n","import * as React from 'react';\nimport {Story} from '../../store/stories';\nimport {hueString} from '../../util/hue-string';\nimport './story-preview.css';\n\nexport interface StoryPreviewProps {\n\tstory: Story;\n}\n\nexport const StoryPreview: React.FC<StoryPreviewProps> = React.memo(props => {\n\tconst {story} = props;\n\tconst hues = [hueString(story.name)];\n\n\thues.push((hues[0] + 15) % 360);\n\thues.push((hues[0] - 15) % 360);\n\thues.push((hues[0] + 30) % 360);\n\thues.push((hues[0] - 30) % 360);\n\thues.push((hues[0] + 60) % 360);\n\n\tlet minX = Number.POSITIVE_INFINITY;\n\tlet minY = Number.POSITIVE_INFINITY;\n\tlet maxX = Number.NEGATIVE_INFINITY;\n\tlet maxY = Number.NEGATIVE_INFINITY;\n\n\tconst circles = story.passages.map(passage => ({\n\t\tkey: passage.name,\n\t\tx: passage.left + passage.width / 2,\n\t\ty: passage.top + passage.height / 2,\n\t\tradius: Math.max(passage.width, passage.height)\n\t}));\n\n\tconst svg = circles\n\t\t.reduce<[React.ReactNode[], React.ReactNode[]]>(\n\t\t\t(result, circle, index) => {\n\t\t\t\t// We reduce the circles to an array with two elements so that the\n\t\t\t\t// larger, faded circles appear below the smaller, more solid ones.\n\n\t\t\t\tconst bgRadius = circle.radius + 200;\n\n\t\t\t\t// Kind of gross to do side effects in a reduce(), but it saves an O(n).\n\n\t\t\t\tminX = Math.min(minX, circle.x - bgRadius);\n\t\t\t\tminY = Math.min(minY, circle.y - bgRadius);\n\t\t\t\tmaxX = Math.max(maxX, circle.x + bgRadius);\n\t\t\t\tmaxY = Math.max(maxY, circle.y + bgRadius);\n\n\t\t\t\tresult[0].push(\n\t\t\t\t\t<circle\n\t\t\t\t\t\tcx={circle.x}\n\t\t\t\t\t\tcy={circle.y}\n\t\t\t\t\t\tkey={`${circle.key}-bg`}\n\t\t\t\t\t\tr={bgRadius}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfill: `hsl(${hues[index % hues.length]}, 80%, 80%)`\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t);\n\n\t\t\t\tresult[1].push(\n\t\t\t\t\t<circle\n\t\t\t\t\t\tcx={circle.x}\n\t\t\t\t\t\tcy={circle.y}\n\t\t\t\t\t\tkey={`${circle.key}-fg`}\n\t\t\t\t\t\tr={circle.radius}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfill: `hsl(${hues[index % hues.length]}, 80%, 60%)`\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t);\n\n\t\t\t\treturn result;\n\t\t\t},\n\t\t\t[[], []]\n\t\t)\n\t\t.map((nodes, index) => (\n\t\t\t<g className={`story-preview-${index === 0 ? 'bg' : 'fg'}`} key={index}>\n\t\t\t\t{nodes}\n\t\t\t</g>\n\t\t));\n\n\tconst viewBox = `${minX} ${minY} ${maxX - minX} ${maxY - minY}`;\n\n\treturn (\n\t\t<svg\n\t\t\tclassName=\"story-preview\"\n\t\t\tviewBox={viewBox}\n\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t>\n\t\t\t{svg}\n\t\t</svg>\n\t);\n});\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {Story} from '../../store/stories';\nimport {Color} from '../../util/color';\nimport {Card, CardContent, CardProps} from '../container/card';\nimport {TagButton} from '../tag';\nimport './story-card.css';\nimport {StoryPreview} from './story-preview';\n\nconst dateFormatter = new Intl.DateTimeFormat([]);\n\nexport interface StoryCardProps extends CardProps {\n\tonChangeTagColor: (name: string, color: Color) => void;\n\tonRemoveTag: (name: string) => void;\n\tonEdit: () => void;\n\tonSelect: () => void;\n\tstory: Story;\n\tstoryTagColors: Record<string, Color>;\n}\n\nexport const StoryCard: React.FC<StoryCardProps> = props => {\n\tconst {\n\t\tonChangeTagColor,\n\t\tonEdit,\n\t\tonRemoveTag,\n\t\tonSelect,\n\t\tstory,\n\t\tstoryTagColors,\n\t\t...otherProps\n\t} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"story-card\" onClick={onSelect} onDoubleClick={onEdit}>\n\t\t\t<Card {...otherProps} selected={story.selected}>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<div className=\"story-card-summary\">\n\t\t\t\t\t\t<div className=\"story-card-summary-preview\">\n\t\t\t\t\t\t\t<StoryPreview story={story} />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div className=\"story-card-summary-text\">\n\t\t\t\t\t\t\t<h2>{story.name}</h2>\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t{t('components.storyCard.lastUpdated', {\n\t\t\t\t\t\t\t\t\tdate: dateFormatter.format(story.lastUpdate)\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\t{t('components.storyCard.passageCount', {\n\t\t\t\t\t\t\t\t\tcount: story.passages.length\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t{story.tags && (\n\t\t\t\t\t\t<div className=\"tags\">\n\t\t\t\t\t\t\t{story.tags.map(tag => (\n\t\t\t\t\t\t\t\t<TagButton\n\t\t\t\t\t\t\t\t\tcolor={storyTagColors[tag]}\n\t\t\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\t\t\tonChangeColor={color => onChangeTagColor(tag, color)}\n\t\t\t\t\t\t\t\t\tonRemove={() => onRemoveTag(tag)}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</CardContent>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useHistory} from 'react-router-dom';\nimport {CardGroup} from '../../components/container/card-group';\nimport {StoryCard} from '../../components/story/story-card';\nimport {setPref, usePrefsContext} from '../../store/prefs';\nimport {Story, updateStory} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\n\n/**\n * How wide a story card should render onscreen as.\n */\nconst cardWidth = '360px';\n\nexport interface StoryCardsProps {\n\tonSelectStory: (story: Story) => void;\n\tstories: Story[];\n}\n\nexport const StoryCards: React.FC<StoryCardsProps> = props => {\n\tconst {onSelectStory, stories} = props;\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {dispatch: storiesDispatch} = useUndoableStoriesContext();\n\tconst history = useHistory();\n\n\tfunction handleChangeTagColor(tagName: string, color: Color) {\n\t\tprefsDispatch(\n\t\t\tsetPref('storyTagColors', {\n\t\t\t\t...prefs.storyTagColors,\n\t\t\t\t[tagName]: color\n\t\t\t})\n\t\t);\n\t}\n\n\tfunction handleRemoveTag(story: Story, tagName: string) {\n\t\tstoriesDispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttags: story.tags.filter(tag => tag !== tagName)\n\t\t\t})\n\t\t);\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<CardGroup columnWidth={cardWidth}>\n\t\t\t\t{stories.map(story => (\n\t\t\t\t\t<StoryCard\n\t\t\t\t\t\tkey={story.id}\n\t\t\t\t\t\tonChangeTagColor={handleChangeTagColor}\n\t\t\t\t\t\tonEdit={() => history.push(`/stories/${story.id}`)}\n\t\t\t\t\t\tonRemoveTag={name => handleRemoveTag(story, name)}\n\t\t\t\t\t\tonSelect={() => onSelectStory(story)}\n\t\t\t\t\t\tstory={story}\n\t\t\t\t\t\tstoryTagColors={prefs.storyTagColors}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</CardGroup>\n\t\t</>\n\t);\n};\n","import sortBy from 'lodash/sortBy';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {MainContent} from '../../components/container/main-content';\nimport {SafariWarningCard} from '../../components/safari-warning';\nimport {\n\tAppDonationDialog,\n\tDialogsContextProvider,\n\tuseDialogsContext\n} from '../../dialogs';\nimport {usePrefsContext} from '../../store/prefs';\nimport {useDonationCheck} from '../../store/prefs/use-donation-check';\nimport {\n\tdeselectAllStories,\n\tdeselectStory,\n\tselectStory,\n\tuseStoriesContext\n} from '../../store/stories';\nimport {UndoableStoriesContextProvider} from '../../store/undoable-stories';\nimport {StoryListToolbar} from './toolbar/story-list-toolbar';\nimport {StoryCards} from './story-cards';\nimport {ClickAwayListener} from '../../components/click-away-listener';\n\nexport const InnerStoryListRoute: React.FC = () => {\n\tconst {dispatch: dialogsDispatch} = useDialogsContext();\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst {shouldShowDonationPrompt} = useDonationCheck();\n\tconst {t} = useTranslation();\n\n\tconst selectedStories = React.useMemo(\n\t\t() => stories.filter(story => story.selected),\n\t\t[stories]\n\t);\n\n\tconst visibleStories = React.useMemo(() => {\n\t\tconst filteredStories =\n\t\t\tprefs.storyListTagFilter.length > 0\n\t\t\t\t? stories.filter(story =>\n\t\t\t\t\t\tstory.tags.some(tag => prefs.storyListTagFilter.includes(tag))\n\t\t\t\t  )\n\t\t\t\t: stories;\n\n\t\tswitch (prefs.storyListSort) {\n\t\t\tcase 'date':\n\t\t\t\treturn sortBy(filteredStories, 'lastUpdated');\n\t\t\tcase 'name':\n\t\t\t\treturn sortBy(filteredStories, 'name');\n\t\t}\n\t}, [prefs.storyListSort, prefs.storyListTagFilter, stories]);\n\n\t// Any stories no longer visible should be deselected.\n\n\tReact.useEffect(() => {\n\t\tfor (const story of selectedStories) {\n\t\t\tif (story.selected && !visibleStories.includes(story)) {\n\t\t\t\tstoriesDispatch(deselectStory(story));\n\t\t\t}\n\t\t}\n\t}, [selectedStories, stories, storiesDispatch, visibleStories]);\n\n\tReact.useEffect(() => {\n\t\tif (shouldShowDonationPrompt()) {\n\t\t\tdialogsDispatch({type: 'addDialog', component: AppDonationDialog});\n\t\t}\n\t}, [dialogsDispatch, shouldShowDonationPrompt]);\n\n\treturn (\n\t\t<div className=\"story-list-route\">\n\t\t\t<StoryListToolbar selectedStories={selectedStories} />\n\t\t\t<ClickAwayListener\n\t\t\t\tignoreSelector=\".story-card\"\n\t\t\t\tonClickAway={() => storiesDispatch(deselectAllStories())}\n\t\t\t>\n\t\t\t\t<MainContent\n\t\t\t\t\ttitle={t(\n\t\t\t\t\t\tprefs.storyListTagFilter.length > 0\n\t\t\t\t\t\t\t? 'routes.storyList.taggedTitleCount'\n\t\t\t\t\t\t\t: 'routes.storyList.titleCount',\n\t\t\t\t\t\t{count: visibleStories.length}\n\t\t\t\t\t)}\n\t\t\t\t>\n\t\t\t\t\t<SafariWarningCard />\n\t\t\t\t\t<div className=\"stories\">\n\t\t\t\t\t\t{stories.length === 0 ? (\n\t\t\t\t\t\t\t<p>{t('routes.storyList.noStories')}</p>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<StoryCards\n\t\t\t\t\t\t\t\tonSelectStory={story =>\n\t\t\t\t\t\t\t\t\tstoriesDispatch(selectStory(story, true))\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tstories={visibleStories}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</MainContent>\n\t\t\t</ClickAwayListener>\n\t\t</div>\n\t);\n};\n\nexport const StoryListRoute: React.FC = () => (\n\t<UndoableStoriesContextProvider>\n\t\t<DialogsContextProvider>\n\t\t\t<InnerStoryListRoute />\n\t\t</DialogsContextProvider>\n\t</UndoableStoriesContextProvider>\n);\n","import * as React from 'react';\nimport {usePrefsContext} from '.';\n\n/**\n * How long since the user began using Twine to show a donation prompt. It's set\n * to 14 days.\n */\nexport const donationDelay = 1000 * 60 * 60 * 24 * 14;\n\nexport function useDonationCheck() {\n\tconst {prefs} = usePrefsContext();\n\n\tconst shouldShowDonationPrompt = React.useCallback(() => {\n\t\tif (prefs.donateShown) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn Date.now() > prefs.firstRunTime + donationDelay;\n\t}, [prefs.donateShown, prefs.firstRunTime]);\n\n\treturn {shouldShowDonationPrompt};\n}\n","export function replaceDom(html: string) {\n\t// Blast JS globals.\n\n\tdelete (window as any).CodeMirror;\n\tdelete (window as any).SVG;\n\tdelete (window as any).Store;\n\tdelete (window as any).StoryFormat;\n\tdelete (window as any).amdDefine;\n\tdelete (window as any).app;\n\tdelete (window as any).jQuery;\n\n\t// Rewrite the document.\n\n\tdocument.open();\n\tdocument.write(html);\n\tdocument.close();\n}\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\n\nexport const StoryPlayRoute: React.FC = () => {\n\tconst [inited, setInited] = React.useState(false);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {publishStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\treplaceDom(await publishStory(storyId));\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, publishStory, storyId]);\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\n\nexport const StoryProofRoute: React.FC = () => {\n\tconst [inited, setInited] = React.useState(false);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {proofStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\treplaceDom(await proofStory(storyId));\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, proofStory, storyId]);\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\n\nexport const StoryTestRoute: React.FC = () => {\n\tconst [inited, setInited] = React.useState(false);\n\tconst {passageId, storyId} = useParams<{\n\t\tpassageId: string;\n\t\tstoryId: string;\n\t}>();\n\tconst {publishStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\treplaceDom(\n\t\t\t\tawait publishStory(storyId, {\n\t\t\t\t\tformatOptions: 'debug',\n\t\t\t\t\tstartId: passageId\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, passageId, publishStory, storyId]);\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowRight, IconArrowBarToRight} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {Card, CardContent, CardProps} from '../container/card';\nimport {IconButton} from '../control/icon-button';\nimport './welcome-card.css';\n\nexport interface WelcomeCardProps extends CardProps {\n\timage?: React.ReactNode;\n\tnextLabel: string;\n\tonNext: () => void;\n\tonSkip: () => void;\n\tshowSkip: boolean;\n\ttitle: string;\n}\n\nexport const WelcomeCard: React.FC<WelcomeCardProps> = props => {\n\tconst {\n\t\tchildren,\n\t\timage,\n\t\tnextLabel,\n\t\tonNext,\n\t\tonSkip,\n\t\tshowSkip,\n\t\ttitle,\n\t\t...otherProps\n\t} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"welcome-card\">\n\t\t\t<Card {...otherProps}>\n\t\t\t\t<div className=\"welcome-card-image\">{image}</div>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<h2>{title}</h2>\n\t\t\t\t\t{children}\n\t\t\t\t</CardContent>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconArrowRight />}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\tonClick={onNext}\n\t\t\t\t\t\tlabel={nextLabel}\n\t\t\t\t\t/>\n\t\t\t\t\t{showSkip && (\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconArrowBarToRight />}\n\t\t\t\t\t\t\tlabel={t('common.skip')}\n\t\t\t\t\t\t\tonClick={onSkip}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</ButtonBar>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import {IconDeviceFloppy, IconHelp, IconMoodSmile} from '@tabler/icons';\nimport {IconTwine} from '../../components/image/icon';\nimport {isElectronRenderer} from '../../util/is-electron';\n\nexport const content = () => [\n\t{\n\t\thtml: 'routes.welcome.greeting',\n\t\timage: <IconTwine />,\n\t\tnextLabel: 'routes.welcome.tellMeMore',\n\t\ttitle: 'routes.welcome.greetingTitle'\n\t},\n\t{\n\t\thtml: 'routes.welcome.help',\n\t\timage: <IconHelp />,\n\t\ttitle: 'routes.welcome.helpTitle'\n\t},\n\tisElectronRenderer()\n\t\t? {\n\t\t\t\thtml: 'routes.welcome.autosave',\n\t\t\t\timage: <IconDeviceFloppy />,\n\t\t\t\ttitle: 'routes.welcome.autosaveTitle'\n\t\t  }\n\t\t: {\n\t\t\t\thtml: 'routes.welcome.browserStorage',\n\t\t\t\timage: <IconDeviceFloppy />,\n\t\t\t\ttitle: 'routes.welcome.browserStorageTitle'\n\t\t  },\n\t{\n\t\thtml: 'routes.welcome.done',\n\t\timage: <IconMoodSmile />,\n\t\tnextLabel: 'routes.welcome.gotoStoryList',\n\t\ttitle: 'routes.welcome.doneTitle'\n\t}\n];\n","import * as React from 'react';\nimport {Helmet} from 'react-helmet';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport scroll from 'scroll';\nimport {WelcomeCard} from '../../components/welcome/welcome-card';\nimport {setPref, usePrefsContext} from '../../store/prefs';\nimport {content} from './content';\nimport './welcome-route.css';\n\nexport const WelcomeRoute: React.FC = () => {\n\tconst containerEl = React.useRef<HTMLDivElement>(null);\n\tconst {dispatch} = usePrefsContext();\n\tconst history = useHistory();\n\tconst [shown, setShown] = React.useState(1);\n\tconst allCards = React.useMemo(content, []);\n\tconst visibleCards = React.useMemo(() => allCards.slice(0, shown), [\n\t\tallCards,\n\t\tshown\n\t]);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (containerEl.current) {\n\t\t\tconst lastCard = containerEl.current.querySelector(\n\t\t\t\t'.welcome-card:last-of-type'\n\t\t\t);\n\n\t\t\tif (lastCard) {\n\t\t\t\tscroll.top(\n\t\t\t\t\tdocument.documentElement ?? document.body,\n\t\t\t\t\t(lastCard as HTMLElement).offsetTop,\n\t\t\t\t\t{duration: 400}\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}, [shown]);\n\n\tconst finish = () => {\n\t\tdispatch(setPref('welcomeSeen', true));\n\t\thistory.push('/');\n\t};\n\n\tconst showNext = () => setShown(shown => shown + 1);\n\n\treturn (\n\t\t<div className=\"welcome-route\" ref={containerEl}>\n\t\t\t<Helmet>\n\t\t\t\t<title>{t('routes.welcome.greetingTitle')}</title>\n\t\t\t</Helmet>\n\t\t\t<div className=\"cards\">\n\t\t\t\t<TransitionGroup component={null}>\n\t\t\t\t\t{visibleCards.map((card, index) => (\n\t\t\t\t\t\t<CSSTransition classNames=\"pop\" key={card.title} timeout={200}>\n\t\t\t\t\t\t\t<WelcomeCard\n\t\t\t\t\t\t\t\timage={card.image}\n\t\t\t\t\t\t\t\tnextLabel={\n\t\t\t\t\t\t\t\t\tcard.nextLabel ? t(card.nextLabel) : t('common.next')\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tonNext={index === allCards.length - 1 ? finish : showNext}\n\t\t\t\t\t\t\t\tonSkip={finish}\n\t\t\t\t\t\t\t\tshowSkip={index === 0}\n\t\t\t\t\t\t\t\ttitle={t(card.title)}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div dangerouslySetInnerHTML={{__html: t(card.html)}} />\n\t\t\t\t\t\t\t</WelcomeCard>\n\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t))}\n\t\t\t\t</TransitionGroup>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {HashRouter, Route, Switch} from 'react-router-dom';\nimport {usePrefsContext} from '../store/prefs';\nimport {StoryFormatListRoute} from './story-format-list';\nimport {StoryEditRoute} from './story-edit';\nimport {StoryListRoute} from './story-list';\nimport {StoryPlayRoute} from './story-play';\nimport {StoryProofRoute} from './story-proof';\nimport {StoryTestRoute} from './story-test';\nimport {WelcomeRoute} from './welcome';\n\nexport const Routes: React.FC = () => {\n\tconst {prefs} = usePrefsContext();\n\n\t// A <HashRouter> is used to make our lives easier--to load local story\n\t// formats, we need the document HREF to reflect where the HTML file is.\n\t// Otherwise we'd have to store the actual location somewhere, which will\n\t// differ between web and Electron contexts.\n\n\treturn (\n\t\t<HashRouter>\n\t\t\t{prefs.welcomeSeen ? (\n\t\t\t\t<Switch>\n\t\t\t\t\t<Route exact path=\"/\">\n\t\t\t\t\t\t<StoryListRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/story-formats\">\n\t\t\t\t\t\t<StoryFormatListRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/welcome\">\n\t\t\t\t\t\t<WelcomeRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/play\">\n\t\t\t\t\t\t<StoryPlayRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/proof\">\n\t\t\t\t\t\t<StoryProofRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/test/:passageId\">\n\t\t\t\t\t\t<StoryTestRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/test\">\n\t\t\t\t\t\t<StoryTestRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId\">\n\t\t\t\t\t\t<StoryEditRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route\n\t\t\t\t\t\tpath=\"*\"\n\t\t\t\t\t\trender={path => {\n\t\t\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t\t\t`No route for path \"${path.location.pathname}\", rendering story list`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\treturn <StoryListRoute />;\n\t\t\t\t\t\t}}\n\t\t\t\t\t></Route>\n\t\t\t\t</Switch>\n\t\t\t) : (\n\t\t\t\t<WelcomeRoute />\n\t\t\t)}\n\t\t</HashRouter>\n\t);\n};\n","import * as React from 'react';\nimport {usePrefsContext} from './prefs';\nimport {useStoriesContext} from './stories';\nimport {\n\tformatWithNameAndVersion,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {usePersistence} from './persistence/use-persistence';\nimport {LoadingCurtain} from '../components/loading-curtain';\n\nexport const StateLoader: React.FC = ({children}) => {\n\tconst [inited, setInited] = React.useState(false);\n\tconst [repaired, setRepaired] = React.useState(false);\n\tconst {dispatch: prefsDispatch, prefs: prefsState} = usePrefsContext();\n\tconst {dispatch: storiesDispatch} = useStoriesContext();\n\tconst {\n\t\tdispatch: formatsDispatch,\n\t\tformats: formatsState\n\t} = useStoryFormatsContext();\n\tconst {prefs, stories, storyFormats} = usePersistence();\n\n\t// Done in two steps so that the repair action can see the inited state.\n\n\tReact.useEffect(() => {\n\t\tif (!inited) {\n\t\t\tformatsDispatch({type: 'init', state: storyFormats.load()});\n\t\t\tprefsDispatch({type: 'init', state: prefs.load()});\n\t\t\tstoriesDispatch({type: 'init', state: stories.load()});\n\t\t\tsetInited(true);\n\t\t}\n\t}, [\n\t\tformatsDispatch,\n\t\tinited,\n\t\tprefs,\n\t\tprefsDispatch,\n\t\tstories,\n\t\tstoriesDispatch,\n\t\tstoryFormats\n\t]);\n\n\tReact.useEffect(() => {\n\t\tif (!repaired) {\n\t\t\tprefsDispatch({type: 'repair'});\n\t\t\tformatsDispatch({type: 'repair'});\n\t\t\tstoriesDispatch({\n\t\t\t\ttype: 'repair',\n\t\t\t\tallFormats: formatsState,\n\t\t\t\tdefaultFormat: formatWithNameAndVersion(\n\t\t\t\t\tformatsState,\n\t\t\t\t\tprefsState.storyFormat.name,\n\t\t\t\t\tprefsState.storyFormat.version\n\t\t\t\t)\n\t\t\t});\n\t\t\tsetRepaired(true);\n\t\t}\n\t}, [\n\t\tformatsDispatch,\n\t\tformatsState,\n\t\tprefsDispatch,\n\t\tprefsState.storyFormat.name,\n\t\tprefsState.storyFormat.version,\n\t\trepaired,\n\t\tstories,\n\t\tstoriesDispatch\n\t]);\n\n\treturn inited && repaired ? <>{children}</> : <LoadingCurtain />;\n};\n","import * as React from 'react';\nimport {useComputedTheme} from './prefs/use-computed-theme';\n\nexport function ThemeSetter() {\n\tconst computedTheme = useComputedTheme();\n\n\tReact.useEffect(() => {\n\t\tdocument.body.dataset.appTheme = computedTheme;\n\t}, [computedTheme]);\n\n\treturn null;\n}\n","import * as React from 'react';\nimport {GlobalErrorBoundary} from './components/global-error-boundary';\nimport {LoadingCurtain} from './components/loading-curtain/loading-curtain';\nimport {LocaleSwitcher} from './store/locale-switcher';\nimport {PrefsContextProvider} from './store/prefs';\nimport {Routes} from './routes';\nimport {StoriesContextProvider} from './store/stories';\nimport {StoryFormatsContextProvider} from './store/story-formats';\nimport {StateLoader} from './store/state-loader';\nimport {ThemeSetter} from './store/theme-setter';\nimport 'focus-visible';\nimport './styles/typography.css';\nimport './styles/focus-visible-shim.css';\n\nexport const App: React.FC = () => {\n\treturn (\n\t\t<GlobalErrorBoundary>\n\t\t\t<PrefsContextProvider>\n\t\t\t\t<LocaleSwitcher />\n\t\t\t\t<ThemeSetter />\n\t\t\t\t<StoryFormatsContextProvider>\n\t\t\t\t\t<StoriesContextProvider>\n\t\t\t\t\t\t<StateLoader>\n\t\t\t\t\t\t\t<React.Suspense fallback={<LoadingCurtain />}>\n\t\t\t\t\t\t\t\t<Routes />\n\t\t\t\t\t\t\t</React.Suspense>\n\t\t\t\t\t\t</StateLoader>\n\t\t\t\t\t</StoriesContextProvider>\n\t\t\t\t</StoryFormatsContextProvider>\n\t\t\t</PrefsContextProvider>\n\t\t</GlobalErrorBoundary>\n\t);\n};\n","import * as React from 'react';\nimport * as ReactDOM from 'react-dom';\nimport {App} from './app';\nimport './util/i18n';\n\nReactDOM.render(\n\t<React.StrictMode>\n\t\t<App />\n\t</React.StrictMode>,\n\tdocument.getElementById('root')\n);\n"],"sourceRoot":""}